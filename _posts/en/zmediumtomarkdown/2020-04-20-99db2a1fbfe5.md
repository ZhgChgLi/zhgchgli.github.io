---
title: "Creating a Comfortable WFH Smart Home Environment, Control Appliances at Your Fingertips"
author: "ZhgChgLi"
date: 2020-04-20T14:37:49.536+0000
last_modified_at: 2024-04-13T08:16:28.468+0000
categories: ["ZRealm Life."]
tags: ["homekit","iphone","homebridge","米家","生活"]
description: "Demonstrating the use of Raspberry Pi as a HomeBridge host to connect all Mi Home appliances to HomeKit"
image:
  path: /assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg
render_with_liquid: false
---

### Creating a Comfortable WFH Smart Home Environment, Control Appliances at Your Fingertips

Demonstrating the use of Raspberry Pi as a HomeBridge host to connect all Mi Home appliances to HomeKit



![photo by [picjumbo\.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}](/assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg)

photo by [picjumbo\.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}
### About

Due to the pandemic, the time spent at home has increased; especially when working from home, it is best to have all the electrical appliances in the house controllable via an app, so you don't have to leave to turn on the lights or the rice cooker, which is quite time-consuming.

Previously, I wrote an article titled "[**Smart Home Initial Experience — Apple HomeKit & Xiaomi Mi Home**](../c3150cdc85dd/)**,"** where I initially tried using HomeBridge to connect Xiaomi appliances to HomeKit. It proved theoretically feasible, but there wasn't much discussion on practical applications. Today's article serves as an advanced version that integrates the previous one, including how to set up a Raspberry Pi as the host, with a step-by-step guide from start to finish.

The motivation came from recently upgrading to an iPhone 11 Pro, which supports the NFC automation feature of iOS ≥ 13. This allows the phone to execute corresponding shortcuts when it detects an NFC tag. Although **you can directly use an old EasyCard as an NFC tag**, it takes up too much space, and I don't have that many cards. I asked around in Guanghua and couldn't find any NFC tag stickers for sale, and finally found some on Shopee for $50 each, buying 5 to experiment with. The seller even kindly helped me differentiate them by color.


![](/assets/99db2a1fbfe5/1*6ftbgAxlvmdv-35of98ohA.jpeg)


_\*The NFC automation feature is device-specific; only iPhone XS/XS Max/XR/11/11 Pro/11 Pro Max support this feature. Previously, using an iPhone 8, there was no NFC option at all._

After playing around a bit, I discovered an issue: when executing shortcuts for the Mi Home app, the "Show When Running" option must be enabled (otherwise, it won't actually execute). **When the tag is detected, the iPhone must be unlocked, and the shortcut will open during execution, meaning it cannot be executed directly in the background.** Additionally, I tested that if the shortcut is a native Apple service (e.g., HomeKit appliances), it can be executed directly in the background without unlocking; moreover, the response speed and stability of HomeKit are much better than that of Mi Home.

This makes a significant difference in usability, so I further researched connecting all Mi Home smart home products to HomeKit. For those that support HomeKit, I will directly bind them without further elaboration; for those that do not support it, I will also bind them according to the instructions in this article!
### My Mi Home Smart Home Items
1. Mi Home Smart Camera PTZ Version 1080P
2. Mi Home DC Inverter Fan
3. Mi Home LED Smart Desk Lamp
4. Xiaomi Air Purifier 3
5. Mi Home Desk Lamp Pro (which already supports HomeKit)
6. Mi Home LED Smart Bulb Color Version * 2 (which already supports HomeKit)

### Operating Principle


![](/assets/99db2a1fbfe5/1*7p0ehajJqdqb4-_w9uHt7g.jpeg)


I made a simple reference diagram. If the smart appliance supports HomeKit, it can be directly connected; **for those that do not support it, they can be bridged through setting up a "HomeBridge" service host (which needs to be powered on continuously)**; within the same network environment (e.g., the same WiFi), the iPhone can freely control all appliances in HomeKit; however, if on an external network, such as **4G mobile network, you will need an Apple TV/HomePod or iPad as the home hub, which must remain powered on** to control HomeKit at home from outside. If there is no home hub, opening the Home app outside will display " **No Response**."

> *If it's from the Mi family, the home appliances will be controlled via the Mi server, and there will be **security issues with the data having to go through mainland China**. 

### Required Environment

So there are two devices that need to be kept on standby at all times: one is an Apple TV/HomePod or iPad as the home hub; currently, there is no solution for this part, and it cannot be simulated in any other way. You will need to find a way to obtain these devices; if you don't have them, you can only use HomeKit **at home.**

The other device can be any computer that can stay on standby for 24 hours (like your iMac/MacBook), an idle machine (an old iMac, Mac Mini), or a Raspberry Pi.

> *I haven't tried the Windows series, but it should work too! 

You can also directly use your current computer to play around (can be used in conjunction with the [previous article](../c3150cdc85dd/)).

This article will demonstrate using a Raspberry Pi (Raspberry Pi 3B) and operating under MacBook Pro (MacOS 10.15.4), starting from setting up the Raspberry Pi environment from scratch. If you are not using a Raspberry Pi, you can skip ahead to the HomeBridge integration with HomeKit section (it will be the same here).

![Raspberry Pi 3B (special thanks to [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"})](/assets/99db2a1fbfe5/1*go-wGMdV1VVbJ3c00rh0_w.jpeg)

Raspberry Pi 3B (special thanks to [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"})

**If you are using a Raspberry Pi, you will also need a micro SD card (not too large, I used 8G), a card reader, and an Ethernet cable (for setup, can connect to WiFi later); as well as the software needed for the Raspberry Pi:**
1. [Raspberry Pi Desktop Operating System (for easy entry, using the GUI version)](https://downloads.raspberrypi.org/raspbian_latest){:target="_blank"}
2. [Etcher burning software](https://www.balena.io/etcher/){:target="_blank"}

### Raspberry Pi Environment Setup
#### Burning the Operating System

After downloading the two required software, we first insert the memory card into the card reader and connect it to the computer; open the Etcher program (balenaEtcher).

![Select the downloaded Raspberry Pi operating system "xxxx.img" as the first option, select your memory card device as the second option, and then click "Flash!" to start burning!](/assets/99db2a1fbfe5/1*3YcqdSf9z5RNqD6KJkd4Nw.png)

Select the downloaded Raspberry Pi operating system "xxxx.img" as the first option, select your memory card device as the second option, and then click "Flash!" to start burning!

![At this point, a prompt will ask you to enter your **MacOS password**; enter it and click "Ok" to continue.](/assets/99db2a1fbfe5/1*o9XE1WYrBpeKSE31Ob9gcQ.png)

At this point, a prompt will ask you to enter your **MacOS password**; enter it and click "Ok" to continue.

![Burning… please wait…](/assets/99db2a1fbfe5/1*Z9oOKg9KPMpj3TZfvOvYeA.png)

Burning… please wait…

![Verifying… please wait…](/assets/99db2a1fbfe5/1*2G930lN4q4MVs4LCeE5y1w.png)

Verifying… please wait…

![Burning successful!](/assets/99db2a1fbfe5/1*CEB4bAMTQshY3u7MEC3q5w.png)

Burning successful!

> *If a red Error appears, try formatting the memory card and burning again. 

Reconnect the card reader to the computer, and create an empty "ssh" file in the memory card's root directory ([or click here to download](https://drive.google.com/file/d/1vSiMkRB1-5tO1hD4YnXxUcULTnCJBIFX/view?usp=sharing){:target="_blank"}). The content should be blank, with no file extension; just a file named "ssh"; this will allow us to connect to the Raspberry Pi using **Terminal**.

![ssh](/assets/99db2a1fbfe5/1*aGJHebPl5MMf4iy0Um9bjg.png)

ssh
### Setting Up the Raspberry Pi

Eject the memory card, insert it into the Raspberry Pi, connect the Ethernet cable, and then power it on; ensure that the MacBook and Raspberry Pi are on the same network.
#### **Check the IP Address Assigned to the Raspberry Pi**

![](/assets/99db2a1fbfe5/1*6HZ0Fqp6cgpn1F3_4UwM0Q.png)

得到樹莓派分配到的 IP 位置是： **192\.168\.0\.110 \(Please replace all IPs mentioned in this article with the results you find\)**


> **_It is recommended to set the Raspberry Pi to a static/reserved IP; otherwise, the IP address may change after rebooting, requiring you to check again._** 




#### Using SSH to Connect to the Raspberry Pi

Open Terminal and enter:
```bash
ssh pi@your_raspberry_pi_ip_address
```

If prompted, type `yes`, and enter the default password: `raspberry`


![**Connection Successful!**](/assets/99db2a1fbfe5/1*okEJeW9xZN8XFfRYJyp4Xg.png)

**Connection Successful!**


> \*If you see an error message like WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED, go to /Users/xxxx/\.ssh/known\_hosts and open it with a text editor to clear it. 




#### Basic Tool Installation and Configuration for Raspberry Pi
1. **Enter the following command to install the Vim editor:**

```bash
sudo apt-get install vim
```


![](/assets/99db2a1fbfe5/1*QfhJwWvicEGfk_8PFLy7pA.png)


**2\. Resolve the following locale warning:**
```plaintext
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
    LANGUAGE = (unset),
    LC_ALL = (unset),
    LC_LANG = "zh_TW.UTF-8",
    LANG = "zh_TW.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
```

**Enter**
```bash
vi .bashrc
```

Press "Enter" to enter

Press " `i` " to enter edit mode

Move to the bottom of the file and add a line " `export LC_ALL=C` "

Press "Esc" and enter " `:wq!` " to save and exit.

Then enter " `source .bashrc` " to update.


![](/assets/99db2a1fbfe5/1*Z3E5QTXErDmmNVRd5QYo8g.gif)


**3\. Install nvm to manage nodejs/npm:**
```bash
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
```

**4\. Use nvm to install the latest version of [nodejs](https://nodejs.org/en/){:target="_blank"}:**

`nvm install 12.16.2`


> \*Here, choose to install version "12\.16\.2" 





**5\. Confirm that the environment installation is complete:**

**Enter the following commands**

`npm -v`

**and**

`node -v`

**to confirm**


![No error messages should appear!](/assets/99db2a1fbfe5/1*u3xgdplBB-7DyvSpAJU4dA.png)

No error messages should appear!

**6\. Create a nodejs link**

**Enter the following command**
```bash
which node
```

Get the path information of nodejs

**Then enter**
```bash
sudo ln -fs paste_the_path_you_got_from_which_node_here (without "double quotes") /usr/local/bin/node
```

**Create the link**


![](/assets/99db2a1fbfe5/1*L5C-2SCUV-Cf4yCDwYy8eg.png)


**Setup Complete!**
#### **Enable VNC Remote Desktop Functionality on Raspberry Pi**

Although we are installing the GUI version, you can certainly connect the Raspberry Pi to a keyboard and HDMI to use it like a regular computer. However, for convenience, we will control the Raspberry Pi using remote desktop.

**Enter:**
```bash
sudo raspi-config
```


![](/assets/99db2a1fbfe5/1*_Hwvt6tkKhsNE9TDkOaYAA.png)


**Enter Settings:**


![Select the fifth option " **Interfacing Options** "](/assets/99db2a1fbfe5/1*_EMj-6phsY5PjrPjqeavDg.png)

Select the fifth option " **Interfacing Options** "

![Select the third option " **P3 VNC** "](/assets/99db2a1fbfe5/1*CAHN3qczUpajbGGU9gaD9g.png)

Select the third option " **P3 VNC** "


![Use " **←** " to select " **Yes** " to open](/assets/99db2a1fbfe5/1*wq4S5b33MpAJUiqt9z1EMg.png)

Use " **←** " to select " **Yes** " to open


![**VNC remote desktop feature enabled successfully!**](/assets/99db2a1fbfe5/1*sTZ8x9M-_5FRwdqy4mKvPw.png)

**VNC remote desktop feature enabled successfully!**


![Use " **→** " to go directly to " **Finish** " to exit the settings interface.](/assets/99db2a1fbfe5/1*81Y7wZjbSS8Tf5Z_OHi3Rw.png)

Use " **→** " to go directly to " **Finish** " to exit the settings interface.
#### **Add VNC remote desktop service to startup items**

We want the VNC remote desktop service to be automatically enabled after the Raspberry Pi boots up.

**Input**
```bash
sudo vim /etc/init.d/vncserver
```

Press "Enter" to enter

Press " `i` " to enter edit mode
```bash
#!/bin/sh
### BEGIN INIT INFO
# Provides:          vncserver
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start/stop vncserver
### END INIT INFO

# More details see:
# http://www.penguintutor.com/linux/vnc

### Customize this entry
# Set the USER variable to the name of the user to start vncserver under
export USER='pi'
### End customization required

eval cd ~$USER

case "$1" in
  start)
    su $USER -c '/usr/bin/vncserver -depth 16 -geometry 1024x768 :1'
    echo "Starting VNC server for $USER "
    ;;
  stop)
    su $USER -c '/usr/bin/vncserver -kill :1'
    echo "vncserver stopped"
    ;;
  *)
    echo "Usage: /etc/init.d/vncserver {start|stop}"
    exit 1
    ;;
esac
exit 0
```

Press "Commend" + "C", "Commend" + "V" to copy and paste the above content, then press "Esc" and enter ":wq\!" to save and exit.

**Then input:**
```bash
sudo chmod 755 /etc/init.d/vncserver
```

Modify file permissions.

**Then input:**
```bash
sudo update-rc.d vncserver defaults
```

Add to the startup items.

**Finally input:**
```bash
sudo reboot
```

**Restart the Raspberry Pi.**


> \*After the restart is complete, reconnect via ssh following the previous steps. 




#### **Connect using VNC Client:**

Here we are using the Chrome app " [VNC® Viewer for Google Chrome™](https://chrome.google.com/webstore/detail/vnc%C2%AE-viewer-for-google-ch/iabmpiboiopbgfabjmgeedhcmjenhbla){:target="_blank"} ", after installation and startup, enter **Raspberry Pi IP address:1**, please note to include the **Port:1** at the end!


> \*I was unable to connect using the built-in VNC:// on Mac, not sure why. 






![Click " **Connect** ".](/assets/99db2a1fbfe5/1*83cR8b2ajhPc1IwariNVBw.png)

Click " **Connect** ".

```markdown
![Click " **OK** ".](/assets/99db2a1fbfe5/1*B0esYM-GvrYUVXIwpq4vvQ.png)

Click " **OK** ".


![**Enter login username and password** , same as SSH connection, username `pi` with default password `raspberry`.](/assets/99db2a1fbfe5/1*jJ8cdRrc4bGHDxPvF7xXhw.png)

**Enter login username and password** , same as SSH connection, username `pi` with default password `raspberry`.


![**Successfully connected!**](/assets/99db2a1fbfe5/1*vIUEmBrO-t_-6xy_kPNLNQ.png)

**Successfully connected!**
#### **Complete Raspberry Pi initialization settings:**

From here on, it's all graphical interface! Very easy!


![Set language, region, and time zone.](/assets/99db2a1fbfe5/1*w9qXfybKr4REKN8hrJJUBw.png)

Set language, region, and time zone.


![Change the default password of Raspberry Pi, enter the password you want to set.](/assets/99db2a1fbfe5/1*xeb6Pr5FUwQGYHhzmid-6w.png)

Change the default password of Raspberry Pi, enter the password you want to set.


![Directly proceed to " **Next** ".](/assets/99db2a1fbfe5/1*o-LCjlYXdW7hmxYjIE6Axw.png)

Directly proceed to " **Next** ".


![Set up to use WiFi connection, so you won't need to plug in a cable anymore.](/assets/99db2a1fbfe5/1*NPZqliJZslnmvzzkW-Zj6g.png)

Set up to use WiFi connection, so you won't need to plug in a cable anymore.


> \*But please note that the Raspberry Pi IP address may change, check again in the router.






![Do you want to update the current operating system? If you're not in a hurry, choose " **Next** " to update!](/assets/99db2a1fbfe5/1*lsnk0BDb_z1VKkXYxUi7fg.png)

Do you want to update the current operating system? If you're not in a hurry, choose " **Next** " to update!


> \*The update will take about 20-30 minutes (depending on your internet speed).






![After the update is complete, click " **Restart** " to reboot.](/assets/99db2a1fbfe5/1*Xgm6NMQNoom_Zee3QHWXZg.png)

After the update is complete, click " **Restart** " to reboot.

**Raspberry Pi environment setup is complete!**
### HomeBridge Installation

Now we officially enter the main event, installing and using HomeBridge.

Use Terminal to SSH into the Raspberry Pi or directly use the Terminal in the VNC remote desktop.

**Enter:**
```bash
npm -g install homebridge --unsafe-perm
```

^\( **Do not add sudo** \)

Install **HomeBridge**


![](/assets/99db2a1fbfe5/1*feOCt_Gyy8DEW7qHA2bpQw.png)


**Installation complete!**
#### Create/Modify configuration file (config\.json):

**For easier editing, use VNC remote desktop to connect to the Raspberry Pi** \(you can also use commands directly\) **:**

Click the top left corner to open " **File Manager** " -> Go to " **/home/pi/\.homebridge** "

If you don't see the "config\.json" file, right-click in the blank area and select " **New File** " -> Enter the file name " **config\.json** "

Right-click on " **config\.json** " and open it with " **Text Editor** "


![](/assets/99db2a1fbfe5/1*Zk_cWdHZ4Um5zCX4dr5IdQ.png)


**Paste the following basic configuration content:**
```json
{
   "bridge": {
  "name": "Homebridge",
  "username": "CC:22:3D:E3:CE:30",
  "port": 51826,
  "pin": "123-45-568"
}
```

**No need to change the content, just copy it directly!**


> **_Remember to save the file!_** 






![](/assets/99db2a1fbfe5/1*Jm3Ykku3Yll1aiuKWbR-EQ.png)


**Done!**
#### Bind HomeBridge to HomeKit

**Enter:**
```bash
homebridge start
```

^\( **Do not add sudo** \)

**Activate**


![](/assets/99db2a1fbfe5/1*uMEuC33I-R6KlLxS-L6Grw.png)
```

```markdown
> *If you encounter errors like Error: Service name is already in use on the network / port is occupied, you can try stopping the service, using `homebridge restart` to restart, or rebooting the system.

> *If you see errors like was not registered by any plugin, it means you have not installed the corresponding homebridge plugin.

> **_If there are changes in the configuration file (config.json) during startup, make sure to modify it:_**

> `sudo homebridge restart`

> **_Restart HomeBridge_**

> *Press "Control" + "C" to close and exit the HomeBridge service in Terminal.

Take out your iPhone, open the "Home" app, tap the "+" in the upper right corner of "Home", select "Add Accessory", **scan the QR code that appears**.

![](/assets/99db2a1fbfe5/1*IFt2yQBfKfooraaAgCxGkA.jpeg)

At this point, you should see "**Accessory not found**". Don't worry! This is because we haven't added any accessories to the HomeBridge bridge yet. No problem, let's continue.

**You need at least one accessory to scan and add! ! !** (Using a camera as an example) **:**
**You need at least one accessory to scan and add! ! !** (Using a camera as an example) **:**
**You need at least one accessory to scan and add! ! !** (Using a camera as an example) **:**

![](/assets/99db2a1fbfe5/1*HC1CSkt1RpBXYEZ3aa8Eyw.png)

![](/assets/99db2a1fbfe5/1*Wi1np5MvjBkwJkInD49aRA.png)

The first time you scan to add, a warning window will appear; just press "Force Add"!

> **_After adding once, you won't need to scan newly added accessories again; they will update automatically!_**

#### Add HomeBridge service to Raspberry Pi's startup items

Similar to the VNC remote desktop service, we also want the HomeBridge service to start automatically after the Raspberry Pi boots up; otherwise, we would have to manually connect and enable it again after a reboot.

**Enter:**
```bash
which homebridge
```

**Get the homebridge path information**

![](/assets/99db2a1fbfe5/1*L8-E7jZqv6TjO4zKaayAuA.png)

**Note this path.**

**Then enter:**
```bash
sudo vim /etc/init.d/homebridge
```

Press "Enter" to enter

Press "`i`" to enter edit mode
```bash
#!/bin/sh
### BEGIN INIT INFO
# Provides:
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start daemon at boot time
# Description:       Enable service provided by daemon.
### END INIT INFO


dir="/home/pi"
cmd="DEBUG=* paste the path you found with which homebridge here"
user="pi"


name=`basename $0`
pid_file="/var/run/$name.pid"
stdout_log="/var/log/$name.log"
stderr_log="/var/log/$name.err"


get_pid() {
cat "$pid_file"
}


is_running() {
[ -f "$pid_file" ] && ps -p `get_pid` > /dev/null 2>&1
}


case "$1" in
start)
if is_running; then
echo "Already started"
else
echo "Starting $name"
cd "$dir"
if [ -z "$user" ]; then
sudo $cmd >> "$stdout_log" 2>> "$stderr_log" &
else
sudo -u "$user" $cmd >> "$stdout_log" 2>> "$stderr_log" &
fi
echo $! > "$pid_file"
if ! is_running; then
echo "Unable to start, see $stdout_log and $stderr_log"
exit 1
fi
fi
;;
stop)
if is_running; then
echo -n "Stopping $name.."
kill `get_pid`
for i in 1 2 3 4 5 6 7 8 9 10
# for i in `seq 10`
do
if ! is_running; then
break
fi


echo -n "."
sleep 1
done
echo


if is_running; then
echo "Not stopped; may still be shutting down or shutdown may have failed"
exit 1
else
echo "Stopped"
if [ -f "$pid_file" ]; then
rm "$pid_file"
fi
fi
else
echo "Not running"
fi
;;
restart)
$0 stop
if is_running; then
echo "Unable to stop, will not attempt to start"
exit 1
fi
$0 start
;;
status)
if is_running; then
echo "Running"
else
echo "Stopped"
exit 1
fi
;;
*)
echo "Usage: $0 {start|stop|restart|status}"
exit 1
;;
esac
exit 0
```
```

```markdown
**Replace:**

`cmd="DEBUG=* Paste the path you found for homebridge here"`

**Replace with the path information you found (without "double quotes")**

Press "Command" + "C", "Command" + "V" to copy and paste the above content, then press "Esc" and type ":wq!" to save and exit.

**Then enter:**
```bash
sudo chmod 755 /etc/init.d/homebridge
```

Modify file permissions.

**Finally enter:**
```bash
sudo update-rc.d homebridge defaults
```

Add to the startup items.

**Done!**


> You can directly use `sudo /etc/init.d/homebridge start` to activate the `homebridge` service.
 

> You can also use: `tail -f /var/log/homebridge.err` to check for startup error messages, and `tail -f /var/log/homebridge.log` to view the log. 






![](/assets/99db2a1fbfe5/1*P_3Zg1GDuUVKJyO-kknCLA.png)

### Preparation for Connecting Xiaomi Smart Appliances

Once Homebridge is up and running, we can start adding all Xiaomi appliances to Homebridge to connect to HomeKit!

**First, we need to add all Xiaomi smart appliances to the "[Mi Home APP](https://apps.apple.com/tw/app/%E7%B1%B3%E5%AE%B6-%E6%99%BA%E6%85%A7%E7%94%9F%E6%B4%BB%E6%96%B0%E9%AB%94%E9%A9%97/id957323480){:target="_blank"}"** so that we can obtain the information needed to connect to HomeBridge.

**After adding the smart appliances to the Mi Home APP:**

Connect your iPhone to your Mac computer, open the Finder/iTunes interface, and select the connected phone.

Choose to back up to "**This Computer**", and "**Do not check! Encrypt local backup**", then click "**Back Up Now**".

![](/assets/99db2a1fbfe5/1*nS68ECAURNSVbuJRYdhCvw.png)


After the backup is complete, [download](http://www.imactools.com/iphonebackupviewer/download/mac){:target="_blank"} and install the backup viewer software: [**iBackupViewer**](http://www.imactools.com/iphonebackupviewer/download/mac){:target="_blank"}.

Open "**iBackupViewer**".

> The first time you start it, you will need to go to Mac "System Preferences" - "Security & Privacy" - "Privacy" - "+" - add "iBackupViewer".
 
> **_*If you have privacy concerns, you can disable the internet while using this software and remove it after use._** 






![](/assets/99db2a1fbfe5/0*VMTW7WxQEl_ZFU7E.png)


Once you reopen "**iBackupViewer**" and successfully read the backup file, click on "the recently backed up phone".

![Select the "**App Store**" Icon](/assets/99db2a1fbfe5/1*Qqyp11Gc-dnK1Me08KKwbw.png)

Select the "**App Store**" Icon.


![On the left, find "Mi Home APP (MiHome.app)" -> On the right, find the "**number_mihome.sqlite**" file and "select" -> Top right corner "Export" -> "Selected Files"](/assets/99db2a1fbfe5/1*VlGVYTHKG88GIiH4C745Vg.png)

On the left, find "Mi Home APP (MiHome.app)" -> On the right, find the "**number_mihome.sqlite**" file and "select" -> Top right corner "Export" -> "Selected Files".


> *If there are two "number_mihome.sqlite" files, choose the one with the most recent creation date. 





Drag the exported **number_mihome.sqlite** file **into this website to view its contents:**


[![](https://inloop.github.io/sqlite-viewer/img/icon.png)](https://inloop.github.io/sqlite-viewer/){:target="_blank"}
```

**The query syntax can be changed to:**
```sql
SELECT `ZDID`,`ZNAME`,`ZTOKEN` FROM 'ZDEVICE' LIMIT 0,30
```

Only display the information for the fields we need (if there are specific appliance packages that require other field information, they can also be added for filtering).

![](/assets/99db2a1fbfe5/1*VWdrF905GGB_yXrCD5CpPg.png)

1. ZDID: Device ID
2. ZNAME: Device Name
3. ZTOKEN: Device ZToken

> **_The ZTOKEN cannot be used directly; it must be converted to "Token" before it can be used._**

Here, we take the ZToken of the camera as an example to convert it to Token:

First, we obtain the ZToken field content for the camera from the list above.
```plaintext
7f1a3541f0433b3ccda94beb856c2f5ba2b15f293ce0cc398ea08b549f9c74050143db63ee66b0cdff9f69917680151e
```

However, the TOKEN we obtained here cannot be used yet; we still need to convert it.

**Open [http://aes\.online\-domain\-tools\.com/](http://aes.online-domain-tools.com/){:target="_blank"}:**
1. Paste the ZTOKEN you just copied into "Input Text" and select "Hex."
2. For Key, enter "00000000000000000000000000000000" (32 zeros), and also select "Hex."
3. Then click "Decrypt!" to convert.
4. Select and copy the output content from the bottom two lines, and after removing spaces, you will have the result **Token**.

![「 **6d304e6867384b704b4f714d45314a34** 」 is the Token result we need!](/assets/99db2a1fbfe5/1*aQ7RfRx9ATjflYgMysnn3A.png)

「 **6d304e6867384b704b4f714d45314a34** 」 is the Token result we need!

> \*The method of obtaining the Token has tried using "miio" for sniffing directly, but it seems that the Mijia firmware has been updated, and this method can no longer quickly and conveniently obtain the Token!

Finally, we also need to know the **device's IP address** (here we again take the camera as an example):

![](/assets/99db2a1fbfe5/0*OvqmDU7ARvoG96J0.jpeg)

Open the Mijia APP → Camera → Top right corner "…" → Settings → Network Information, and obtain the **IP address**!

> **_Record the ZDID/Token/IP information for future use._**

### Integrate Mijia Smart Appliances into HomeBridge One by One

Depending on the specific packages and connection information required for each device, install and configure them one by one to add them to HomeBridge.

> **_Next, open Terminal to ssh into the Raspberry Pi or directly use the Terminal in the VNC remote desktop to continue the subsequent operations…_**

#### **1. Mijia Camera PTZ Version:**

In Terminal, run the command to install the [MijiaCamera](https://github.com/josepramon/homebridge-mijia-camera){:target="_blank"} Homebridge package (**do not add sudo**):
```bash
npm install -g homebridge-mijia-camera
```

![](/assets/99db2a1fbfe5/1*V7hZyogacXS9m_XN4qVtFw.png)

Refer to the previous section's instructions for modifying the configuration file (config.json) and add the **accessories** section:
```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"MijiaCamera",
         "name":"Mi Camera",
         "ip":"",
         "token":""
      }
   ]
}
```

In `accessories:`, add the configuration information for the Mijia camera, filling in the camera's IP for ip and the token as instructed in the previous section.

> **_Remember to save the file!_**

Then, according to the instructions in the Homebridge section, start/restart/scan to add to HomeBridge; you will be able to see the camera control items in the "Home" APP.

```markdown
![](/assets/99db2a1fbfe5/0*fHtbNC-8IL9KQUyu.jpeg)

Controllable item: Camera On/Off
#### 2. Mi Home DC Inverter Fan

Install the [homebridge-mi-fan](https://github.com/YinHangCode/homebridge-mi-fan){:target="_blank"} homebridge plugin using the command in Terminal **(without sudo)**:
```bash
npm install -g homebridge-mi-fan
```

![](/assets/99db2a1fbfe5/1*vwe7fapof2mA4me_3_HyfA.png)

Refer to the previous section's tutorial on modifying the configuration file (config.json) and add the **platforms** section to the file (if it already exists, add a new sub-section with a comma within the section) **:**
```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "platforms":[
      {
         "platform":"MiFanPlatform",
         "deviceCfgs":[
            {
               "type":"MiDCVariableFrequencyFan",
               "ip":"",
               "token":"",
               "fanName":"room fan",
               "fanDisable":false,
               "temperatureName":"room temperature",
               "temperatureDisable":true,
               "humidityName":"room humidity",
               "humidityDisable":true,
               "buzzerSwitchName":"fan buzzer switch",
               "buzzerSwitchDisable":true,
               "ledBulbName":"fan led switch",
               "ledBulbDisable":true
            }
         ]
      }
   ]
}
```

Add the Mi Home fan configuration information to `platforms:`, input the camera's IP for ip, use the token provided in the previous tutorial for token, and control whether to display temperature and humidity information. 
**The type must correspond to the model's text**, supporting four different models of fans:
1. ZhiMi DC Inverter Floor Fan: ZhiMiDCVariableFrequencyFan
2. ZhiMi Natural Wind Fan: ZhiMiNaturalWindFan
3. Mi DC Inverter: MiDCVariableFrequencyFan (sold in Taiwan)
4. Mi Fan: DmakerFan

Please input your own fan model.

> **_Remember to save the file!_**

Then, follow the instructions in the Homebridge section to start/restart/scan to add Homebridge; you will be able to see the camera control items in the "Home" app.

![](/assets/99db2a1fbfe5/1*N_N5_WCnHNsepVv7HvAjmQ.jpeg)

Controllable items: Fan On/Off, Wind Speed Adjustment
#### 3. Xiaomi Air Purifier 3

Install the [homebridge-xiaomi-air-purifier3](https://github.com/rgavril/homebridge-xiaomi-air-purifier3){:target="_blank"} homebridge plugin using the command in Terminal **(without sudo)**:
```bash
npm install -g homebridge-xiaomi-air-purifier3
```

![](/assets/99db2a1fbfe5/1*VxEYnHaBwQVLxxXOLb1Jkg.png)

Refer to the previous section's tutorial on modifying the configuration file (config.json) and add the **accessories** section to the file (if it already exists, add a new sub-section with a comma within the section) **:**
```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"XiaomiAirPurifier3",
         "name":"Xiaomi Air Purifier",
         "did":"",
         "ip":"",
         "token":"",
         "pm25_breakpoints":[
            5,
            12,
            35,
            55
         ]
      }
   ]
}
```

```markdown
`accessories:` Add the settings information for the Mi Home fan, with the IP set to the camera's IP, the token set to the token taught in the previous section, and the did set to zdid.

> **_Remember to save!_** 

Then, follow the instructions in the Homebridge section to start/restart/scan to add Homebridge; you will then see the camera control items in the "Home" app.

![](/assets/99db2a1fbfe5/1*R1bxhdiGuY3SyFnrhCO6iw.png)

![](/assets/99db2a1fbfe5/1*05s08YdF6vQUWAG7nmTnfA.png)

Controllable items: air purifier switch, wind speed adjustment  
Viewable items: current temperature and humidity  
#### 4\. Mi Home LED Smart Desk Lamp

In Terminal, run the command to install the [homebridge-yeelight-wifi](https://github.com/vieira/homebridge-yeelight-wifi){:target="_blank"} Homebridge plugin **(without sudo)**:  
```bash
npm install -g homebridge-yeelight-wifi
```

![](/assets/99db2a1fbfe5/1*1fQJ9UTCJRghUk00iT2WcQ.png)

Refer to the previous section's instructions for modifying the configuration file (config.json) and add the **platforms** block to the file (if it already exists, add a sub-block with a comma within the block):  
```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "platforms":[
      {
         "platform":"yeelight",
         "name":"Yeelight"
      }
   ]
}
```

No special parameters need to be added! For more detailed settings, refer to the [official documentation](https://github.com/vieira/homebridge-yeelight-wifi){:target="_blank"} (such as brightness/color temperature, etc.).

> **_Remember to save!_** 

The smart desk lamp also needs to be bound to the "[Yeelight](https://apps.apple.com/tw/app/yeelight/id977125608){:target="_blank"}" app, and then the "LAN Control" must be enabled for Homebridge to control it.

1. Download and install the "[Yeelight](https://apps.apple.com/tw/app/yeelight/id977125608){:target="_blank"}" app on your iPhone.

![Search for "Yeelight" in the App Store to install](/assets/99db2a1fbfe5/1*3m-UOoI7uam4a_N5dxU5VQ.png)

Search for "Yeelight" in the App Store to install.

![](/assets/99db2a1fbfe5/1*G9-12giq1DVIw5zTKOaF4A.png)

![](/assets/99db2a1fbfe5/1*usLJKkehTDKeeFG95KDe4g.png)

![After installation, open the Yeelight app -> "Add Device" -> find "Mi Desk Lamp" -> re-pair and bind](/assets/99db2a1fbfe5/1*cWBMAqa_xkL01SoURNSO8g.png)

After installation, open the Yeelight app -> "Add Device" -> find "Mi Desk Lamp" -> re-pair and bind.

![Remember to enable "LAN Control" in the last step](/assets/99db2a1fbfe5/1*8un0THsUf3ZesFPGSj_p-g.jpeg)

Remember to enable "LAN Control" in the last step.

> *If you accidentally missed enabling it, you can go to the "Devices" page -> select the desk lamp device -> tap the bottom right "△" tab -> tap "LAN Control" to enter settings -> enable LAN Control.

> **_Just a complaint, this is really terrible. The Mi Home app itself does not have this switch function, and it must be bound to the Yeelight app. It cannot be unbound or rebound back to Mi Home... otherwise, it will become ineffective._** 

Then, follow the instructions in the Homebridge section to start/restart/scan to add Homebridge; you will then see the camera control items in the "Home" app.
```

![](/assets/99db2a1fbfe5/1*vyAiFirZgDB6_OSsHIdEPw.jpeg)

Controllable items: light switch, color temperature adjustment, brightness adjustment  
#### Other Mi Home smart homebridge plugins:

**My final config\.json looks like this:**
```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"MijiaCamera",
         "name":"Mi Camera",
         "ip":"192.168.0.105",
         "token":"6d304e6867384b704b4f714d45314a34"
      },
      {
         "accessory":"XiaomiAirPurifier3",
         "name":"Xiaomi Air Purifier",
         "did":"270033668",
         "ip":"192.168.0.108",
         "token":"5c3eeb03065fd8fc6ad10cae1f7cce7c",
         "pm25_breakpoints":[
            5,
            12,
            35,
            55
         ]
      }
   ],
   "platforms":[
      {
         "platform":"MiFanPlatform",
         "deviceCfgs":[
            {
               "type":"MiDCVariableFrequencyFan",
               "ip":"192.168.0.106",
               "token":"dd1b6f582ba6ce34f959bbbc1c1ca59f",
               "fanName":"room fan",
               "fanDisable":false,
               "temperatureName":"room temperature",
               "temperatureDisable":true,
               "humidityName":"room humidity",
               "humidityDisable":true,
               "buzzerSwitchName":"fan buzzer switch",
               "buzzerSwitchDisable":true,
               "ledBulbName":"fan led switch",
               "ledBulbDisable":true
            }
         ]
      },
      {
         "platform":"yeelight",
         "name":"Yeelight"
      }
   ]
}
```

**For everyone's reference!**

The Mi Home appliances I used are taught above; I haven't tried others that I don't have. You can check [**on npm (homebridge\-plugin XXX English name)**](https://www.npmjs.com/search?q=keywords%3Ahomebridge-plugin%20mi%20camera){:target="_blank"} and then install and configure it similarly based on the logic above!

Here are a few homebridge plugins I found but haven't tried (no guarantee they will work):
1. Xiaomi Air Purifier 1st generation: [homebridge\-mi\-air\-purifier](https://github.com/seikan/homebridge-mi-air-purifier){:target="_blank"}
2. Mi Smart Plug series: [homebridge\-mi\-outlet](https://github.com/YinHangCode/homebridge-mi-outlet){:target="_blank"}
3. Xiaomi Robot Vacuum: [homebridge\-mi\-robot\_vacuum](https://github.com/YinHangCode/homebridge-mi-robot_vacuum){:target="_blank"}
4. Mi Smart Gateway: [homebridge\-mi\-aqara](https://github.com/YinHangCode/homebridge-mi-aqara){:target="_blank"}

### Tips
1. It is recommended to set all Xiaomi smart devices to a specified/reserved IP address on the router; otherwise, the IP address may change, requiring a reconfiguration of the config\.json settings.
2. If you find that all steps are correct but still encounter errors or see "No Response" on HomeKit, you can try again; if the issue persists, it may indicate that the plugin has become invalid, and you will need to find another plugin for integration. (You can check the GitHub issue.)
3. If features are not functioning or are slow to respond; there is no solution for this, and you can submit an issue to inform the author for updates. Since this is an open-source project, we cannot demand too much!
4. **After binding each device, you can start Homebridge once and then check on your iPhone to see if it works. If it does, you can then press "Control" + "C" to terminate; once all devices are bound, you can restart the Raspberry Pi to allow it to automatically start the Homebridge service in the background after rebooting; this is what we want.**

### Conclusion


![](/assets/99db2a1fbfe5/1*w7WnAn3XHNW2f5fJbRd_Zw.jpeg)



![](/assets/99db2a1fbfe5/1*ph8BfcF0ivvlZyKNF9mubQ.png)



![Additionally, you can pull the "Home" app up in "Settings" -> "Control Center" -> "Customize" to quickly operate HomeKit from the drop-down control center!](/assets/99db2a1fbfe5/1*e1FAJuyCLOWEkA6MAeENkA.jpeg)

Additionally, you can pull the "Home" app up in "Settings" -> "Control Center" -> "Customize" to quickly operate HomeKit from the drop-down control center!

After connecting everything to HomeKit, the only word that comes to mind is "awesome"! The response time for switches is much faster; the only downside is that I don't have a home hub for remote control. This advanced Homebridge guide ends here; thank you for reading.

Returning to the beginning of the article, once everything is added to HomeKit, we can seamlessly use the automation features of iOS ≥ 13 shortcuts.

If you want to explore how Homebridge plugins are made later, it sounds interesting! So if there are Homebridge plugins that do not meet your operational needs or if a plugin is broken and you can't find a replacement, just wait for me to research it!
#### Home Assistant

There is another smart home platform [Home Assistant](https://www.home-assistant.io/){:target="_blank"} that can be installed on a Raspberry Pi ( **but please note: it requires a 2A power supply to start** ); I also installed [Home Assistant](https://www.home-assistant.io/){:target="_blank"} to play around with, which has a full GUI interface, allowing you to integrate devices with just a few clicks; I will delve deeper into it later. It seems to be equivalent to another Xiaomi platform, and if you have many different manufacturers' IoT components, this would be more suitable.
#### References
1. [https://www\.domoticz\.cn/forum/viewtopic\.php?t=52](https://www.domoticz.cn/forum/viewtopic.php?t=52){:target="_blank"}
2. [https://or2\.in/2017/07/02/Homekit\-and\-MiJia\-with\-pi/\#3\-%E5%8F%B7%E5%A4%96\-%E5%BC%80%E5%90%AF%E5%8F%AF%E8%A7%86%E5%8C%96VNC](https://or2.in/2017/07/02/Homekit-and-MiJia-with-pi/#3-%E5%8F%B7%E5%A4%96-%E5%BC%80%E5%90%AF%E5%8F%AF%E8%A7%86%E5%8C%96VNC){:target="_blank"}

### Further Reading
1. [New Xiaomi Smart Home Purchases (AI Speaker, Temperature and Humidity Sensor, Weight Scale 2, DC Inverter Fan)](../bcff7c157941/)
2. [Using "Shortcuts" Automation Features with Xiaomi Smart Home on iOS ≥ 13.1 (Directly using the built-in Shortcuts app on iOS ≥ 13.1 for automation)](../21119db777dd/)
3. [Xiaomi APP / Xiao Ai Speaker Regional Issues](../94a4020edb82/)
4. [Smart Home First Experience — Apple HomeKit & Xiaomi MiJia (MiJia Smart Camera and MiJia Smart Desk Lamp, HomeKit Setup Guide)](../c3150cdc85dd/)



If you have any questions or suggestions, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.



_[Post](https://medium.com/zrealm-life/%E6%89%93%E9%80%A0%E8%88%92%E9%81%A9%E7%9A%84-wfh-%E6%99%BA%E6%85%A7%E5%B1%85%E5%AE%B6%E7%92%B0%E5%A2%83-%E6%8E%A7%E5%88%B6%E5%AE%B6%E9%9B%BB%E7%9B%A1%E5%9C%A8%E6%8C%87%E5%B0%96-99db2a1fbfe5){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._

It seems there is no Markdown content provided for translation. Please provide the text you would like me to translate.
