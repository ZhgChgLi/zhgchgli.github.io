---
author: ZhgChgLi
categories:
- ZRealm Development
date: 2021-08-07T12:19:49.920+0000
description: Discover how to use Gmail Filters combined with Google Apps Script to
  automatically forward customized email content to your Slack channels, streamlining
  communication and saving time.
image:
  path: /assets/d414bdbdb8c9/1*U6CDgIAMt2l2vDoFqhwv6A.jpeg
last_modified_at: 2024-04-14T01:54:47.696+0000
render_with_liquid: false
tags:
- iOS App Development
- Google Apps Script
- CI/CD
- Slack
- Workflow Automation
title: Google Apps Script｜Automate Gmail Forwarding to Slack Channels with Custom
  Filters
---

### Using Google Apps Script to Forward Gmail Emails to Slack

Using Gmail Filter + Google Apps Script to Automatically Forward Customized Content to a Slack Channel When Receiving Emails

![Photo by [Lukas Blazek](https://unsplash.com/@goumbik?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/d414bdbdb8c9/1*U6CDgIAMt2l2vDoFqhwv6A.jpeg)

Photo by [Lukas Blazek](https://unsplash.com/@goumbik?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}

### Origin

Recently, I have been optimizing the iOS App CI/CD process using Fastlane as the automation tool. After packaging and uploading, if you want to continue with the automatic submission step (`skip_submission=false`), you need to wait for Apple to complete the processing, which takes about 30-40 minutes of CI server time. Since Apple's App Store Connect API is not fully developed, Fastlane can only check once per minute whether the uploaded build has finished processing, which wastes a lot of resources.

![](/assets/d414bdbdb8c9/1*JXuVoKM-gGJwfvF7tXY1nQ.png)

- **Bitrise CI Server:** Limits the number of simultaneous builds and sets a maximum runtime of 90 minutes. While 90 minutes is sufficient, a single build can block others from running.

- **Travis CI Server:** Charged based on Build Time, so you can't afford to wait—money goes down the drain.

#### A Different Approach

No waiting, end immediately after upload! Trigger subsequent actions based on the processed email notification.

![](/assets/d414bdbdb8c9/1*57FOYivs5toW2aipgRVCeg.jpeg)

> ***However, I haven't received this email recently. I'm not sure if it's a settings issue or if Apple has stopped sending such notifications.***

This article will use the Testflight email notification that testing can now begin as an example.

![](/assets/d414bdbdb8c9/1*2fmqWCAMiM2UeuGss7VzzA.jpeg)

![](/assets/d414bdbdb8c9/1*sndRqvnELhCshb6yyPFhqg.jpeg)

> *The complete process is shown in the above image and is feasible in principle; however, this article will focus on receiving emails and using Apps Script to forward them to a Slack channel.*

### How to Forward Received Emails to a Slack Channel

Both paid and free Slack plans can use different methods to forward emails to Slack Channels or DMs.

You can refer to the official documentation for setup: [Send emails to Slack](https://slack.com/intl/zh-tw/help/articles/206819278-%E5%82%B3%E9%80%81%E9%9B%BB%E5%AD%90%E9%83%B5%E4%BB%B6%E8%87%B3-Slack){:target="_blank"}

**The results are the same regardless of the method:**

![](/assets/d414bdbdb8c9/1*qdoLTotLTaeZPsEHaJ8C7Q.jpeg)

> *By default, the email content is collapsed. Click to expand and view the full content.*

**Advantages:**

1. Simple and Fast

2. Zero Technical Barrier

3. Real-time forwarding

**Disadvantages:**

1. Cannot customize content

2. Display style cannot be changed

### Custom Forwarded Content

This is the main focus of this article.

![](/assets/d414bdbdb8c9/1*w4E7wf-Kf8XVFxowmDopIw.png)

Translate the email content data into your desired presentation style, as shown in the example image above.

#### Here is a complete workflow diagram:

![](/assets/d414bdbdb8c9/1*yB5s_5rBr4l6hid21huJMQ.jpeg)

- Using Gmail Filter to Add Identification Labels for Forwarded Emails

- Apps Script to Periodically Fetch Emails Tagged with a Specific Label

- Read email content

- Render the desired display style

- Send messages to Slack via Slack Bot API or directly using Incoming Message

- Remove Email Label (Indicates Forwarded)

- Completed

#### First, create a filter in Gmail

Filters can automate actions when receiving emails that meet certain criteria, such as: automatically marking as read, tagging, moving to spam, categorizing, and more.

![](/assets/d414bdbdb8c9/1*qNXxtTLzEnlArl4UTTWQMw.jpeg)

In Gmail, click the advanced search icon button at the top right, enter the forwarding email rule conditions, such as From: `no_reply@email.apple.com` + Subject contains `is now available to test.`, then click "Search" to check if the filter results are as expected; if correct, click the "Create filter" button next to Search.

![Or directly click "Filter messages like these" at the top of the email to quickly create filter rules](/assets/d414bdbdb8c9/1*i7grToZwE_ixwJTEjI9qtw.jpeg)

Or simply click "Filter messages like these" at the top of the email to quickly create a filter.

![](/assets/d414bdbdb8c9/1*n_nbqgIlE-E1eaW5QfqkWg.jpeg)

> This button design is very user-unfriendly; I couldn't find it the first time.

![](/assets/d414bdbdb8c9/1*6zlooS-cMr5LEVX2TW5I_w.jpeg)

Next, set the action for emails that meet this filter condition. Here, select "Apply the label" and create a new label named "forward-to-slack." Then click "Create filter" to finish.

Emails labeled with this tag will be forwarded to Slack.

### Get Incoming WebHooks App URL

First, we need to add the Incoming WebHooks App to the Slack Channel. We will use this to send messages.

![](/assets/d414bdbdb8c9/1*AgGLiLsyvenK-LRWI9rlKg.png)

1. Slack bottom left corner "Apps" -> "Add apps"

2. Search for "incoming" in the search box on the right.

3. Click "Incoming WebHooks" -> "Add"

![](/assets/d414bdbdb8c9/1*DUcwdLTKt33Fa-jNlW8MkA.png)

![](/assets/d414bdbdb8c9/1*v8Z-5vEM043F82TMiZk2lw.png)

Select the Channel where you want to send the message.

![](/assets/d414bdbdb8c9/1*SRciom_ygU0JDKK9ATY1FQ.png)

Note down the "Webhook URL" at the top.

![](/assets/d414bdbdb8c9/1*kp1QDIEwzQtmfzUwZIDTSg.png)

Scroll down to set the name and avatar displayed when sending messages from the Bot; remember to click "Save Settings" after making changes.

> ***Note***

> *Please note that the official recommendation is to use the new Slack APP Bot API's [chat.postMessage](https://api.slack.com/methods/chat.postMessage){:target="_blank"} to send messages. The simpler Incoming Webhook method will be deprecated in the future. This guide uses the old method for convenience but will need to switch to the new Slack App API in the next chapter, "Import Employee List."*

![](/assets/d414bdbdb8c9/1*QfgJL_Xb9JhgQnPGjU2CXg.png)

### Writing Apps Script Code

- [Click here to go to my Apps Script project](https://script.google.com/home/my){:target="_blank"}

- Click "New Project" at the top left

- After creating, click the project name to rename it, e.g., ForwardEmailsToSlack

Paste the basic code below and modify it to your desired version:

```javascript
function sendMessageToSlack(content) {
    var payload = {
      "text": "*You have received an email*",
      "attachments": [{
          "pretext": "Email content as follows:",
          "text": content,
        }
      ]
    };
    var res = UrlFetchApp.fetch('貼上你的Slack incoming Webhook URL',{
      method             : 'post',
      contentType        : 'application/json',
      payload            : JSON.stringify(payload)
    })
}

function forwardEmailsToSlack() {
    // Reference: https://gist.github.com/andrewmwilson/5cab8367dc63d87d9aa5

    var label = GmailApp.getUserLabelByName('forward-to-slack');
    var messages = [];
    var threads = label.getThreads();
  
    if (threads == null) {
      return;
    }

    for (var i = 0; i < threads.length; i++) {
        messages = messages.concat(threads[i].getMessages())
    }

    for (var i = 0; i < messages.length; i++) {
        var message = messages[i];
        Logger.log(message);

        var output = '*New Email*';
        output += '\n*from:* ' + message.getFrom();
        output += '\n*to:* ' + message.getTo();
        output += '\n*cc:* ' + message.getCc();
        output += '\n*date:* ' + message.getDate();
        output += '\n*subject:* ' + message.getSubject();
        output += '\n*body:* ' + message.getPlainBody();

        sendMessageToSlack(output);
   }

   label.removeFromThreads(threads);
}
```

**Advanced:**

- [Slack message styles can refer to this official structure document](https://api.slack.com/messaging/composing/layouts){:target="_blank"}.

- You can use Javascript's Regex Match Function to extract content from emails.

**EX: Extracting version number information from Testflight approval emails:**

Email Subject: Your app XXX has been approved for beta testing.

Email content:

![](/assets/d414bdbdb8c9/1*aZkQGA3N1cquMLt1wyDGFg.jpeg)

We want to get the values **after Bundle Version Short String and Build Number**.

```
var results = subject.match(/(Bundle Version Short String: ){1}(\S+){1}[\S\s]*(Build Number: ){1}(\S+){1}/);
if (results == null \\|\\| results.length != 5) {
  // not valid
} else {
  var version = results[2];
  var build = results[4];
}
```

- [For Regex usage, refer to here](https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Guide/Regular_Expressions){:target="_blank"}

- You can test if a Regex is correct online using [this website](http://www.rubular.com/){:target="_blank"}

#### Give it a try

- Go back to Gmail and manually add the label "forward-to-slack" to any email.

- In the Apps Script code editor, select "forwardEmailsToSlack" and then click the "Run" button

![](/assets/d414bdbdb8c9/1*JHHTQCWNUI-aNPBB6y4iAA.jpeg)

![](/assets/d414bdbdb8c9/1*ltXGtEVxkdde1qHGxy3wMw.png)

If "Authorization Required" appears, click "Continue" to complete the verification.

![](/assets/d414bdbdb8c9/1*hIgRtqKEFs0tsXDxfNTaOg.png)

During the authentication process, the message "Google hasn’t verified this app" may appear. This is normal because the App Script we wrote has not been verified by Google. However, it’s fine since this is for personal use.

You can click the bottom left corner "Advanced" -> "Go to ForwardEmailsToSlack (unsafe)"

![](/assets/d414bdbdb8c9/1*QUkmTD1WlEzw7cqW97ll6Q.png)

Click "Allow"

![](/assets/d414bdbdb8c9/1*TInHsY7Fwb9jHuKJkMJIsw.jpeg)

Forwarded successfully!!!

### Set Up Trigger (Schedule) for Automatic Checking & Forwarding

![](/assets/d414bdbdb8c9/1*2Ok6gD5E7F1uqyzgVpoJ8A.jpeg)

In the left menu of Apps Script, select "Triggers".

![](/assets/d414bdbdb8c9/1*1xb9xGGkgx6PkhWlWc7HiQ.jpeg)

Bottom left corner "+ Add Trigger Condition".

![](/assets/d414bdbdb8c9/1*ujCxCH3f8HTvSOP5o4xvmA.jpeg)

- Error Notification Settings: You can set how to notify you when the script encounters an error during execution

- Choose the function you want to execute: Select Main Function `sendMessageToSlack`

- Select Activity Source: You can choose from Calendar or Time-Driven (Scheduled or Specified)

- Select time-based trigger type: choose to execute on a specific date or once every minute/hour/day/week/month

- Select interval by minute/hour/day/week/month: e.g., every minute, every 15 minutes…

> *Here, for demonstration, it is set to run every minute. I think checking emails once every hour is sufficient for real-time needs.*

![](/assets/d414bdbdb8c9/1*LBAlTvz46NJCYgVv1DrfYQ.png)

- Go back to Gmail and pick any email, then manually add the label — "forward-to-slack"

- Waiting for schedule trigger

Automatic Check & Forward Successful!

### Completion

With this feature, you can achieve customized email forwarding and processing, or even use it as a trigger—for example, automatically running a script when receiving an email from XXX.

Returning to Chapter 1 Origin, we can use this mechanism to improve the CI/CD process; no need to wait idly for Apple to finish processing, and we can integrate automation workflows!

### Further Reading

- [Crashlytics + Big Query Build a More Real-Time and Convenient Crash Tracking Tool](../e77b80cc6f89/)

- [Crashlytics + Google Analytics Automatic Query for App Crash-Free Users Rate](../793cb8f89b72/)

- [Automate Routine Tasks with Python + Google Cloud Platform + Line Bot](../70a1409b149a/)

- [Slack Builds Fully Automated WFH Employee Health Status Reporting System](../d61062833c1a/)

- [The app uses HTTPS for transmission, but data was still stolen.](../46410aaada00/)

If you have any questions or feedback, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.

*[Post](https://medium.com/zrealm-ios-dev/%E9%81%8B%E7%94%A8-google-apps-script-%E8%BD%89%E7%99%BC-gmail-%E4%BF%A1%E4%BB%B6%E5%88%B0-slack-d414bdbdb8c9){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*