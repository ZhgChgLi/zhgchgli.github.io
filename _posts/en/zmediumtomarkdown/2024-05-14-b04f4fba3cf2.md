---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2024-05-14T16:20:45.012+0000
description: Developers and users facing app discontinuation can use mitmproxy combined
  with Apple Configurator to keep apps permanently accessible in their last available
  state, preventing loss of functionality after removal.
image:
  path: /assets/b04f4fba3cf2/1*8RN-xVJROfLwtovgkvHDwA.jpeg
last_modified_at: 2024-05-14T16:20:45.012+0000
render_with_liquid: false
tags:
- english
- ai-translation
- ios-app-development
- man-in-the-middle-attack
- mitmproxy
- python
- app-development
title: App Lifecycle Managementï½œMitmproxy & Apple Configurator for Preserving Removed
  Apps
---

### What can be done to commemorate when an app product reaches its end?

Using mitmproxy + Apple Configurator to Keep an App Permanently in the Pre-Removal State

### Preface

![Jujutsu Kaisen](/assets/b04f4fba3cf2/1*8RN-xVJROfLwtovgkvHDwA.jpeg)

Jujutsu Kaisen

Having worked for a long time and handled many products, I have started to encounter products I once participated in reaching their end (discontinuation). Developing a product from scratch is like nurturing a new life; the team worked hard for 3â€“4 months to bring it to birth. Although later stages were handed over to other caretakers (engineers) for further development, hearing that it is about to reach the end of its product life cycle still brings some regret.

> ***Life is the same; we never know whether the sun will rise first or an accident will happen tomorrow. The only thing we can do is cherish the present and do things well.***

#### Remembrance

Wherever we go, traces are left behind. We hope to do something before the product reaches its end, giving everyone a chance to reminisce and at least leave proof that it once existed. The following methods all require the app to still be online; if it has been removed, only memories remain.

### Non-technical Method â€” Recording

Besides using the [iPhone's built-in screen recording feature](https://support.apple.com/zh-tw/102653){:target="_blank"}, we can also connect the phone to a Mac and use QuickTime Player to record and export videos on the computer.

1. Open QuickTime Player App on Mac

![](/assets/b04f4fba3cf2/1*UVkfiLbcYU8YuZEPdbJaOg.png)

2. Select "File" -> "New Movie Recording" from the top left toolbar.

![](/assets/b04f4fba3cf2/1*VcRN0FExy-CA7sExHtMT6w.png)

3. After exiting the recording interface, click the "v" next to the ðŸ”´, and select your connected phone for the screen and speaker.

![](/assets/b04f4fba3cf2/1*SN0XL8Zt0UlBizXiIqZiyA.png)

4. The recording interface will then display the phone screen.

![](/assets/b04f4fba3cf2/1*MSuecaACmg3ZNMnGpDkRFQ.png)

Click "ðŸ”´" to start recording, then return to your phone to perform the actions you want to record.

![](/assets/b04f4fba3cf2/1*bxL9Dq1IWgbrlSfKO6skLQ.png)

During recording, the current video size will be displayed. Press the "ðŸ”´" button again to stop recording.

![](/assets/b04f4fba3cf2/1*VxWQNHF_PX5CZAkjJEXPbQ.png)

You can easily trim videos using the QuickTime Player toolbar. Finally, press "Command" + "s" to export and save the video to a specified location, completing the recording.

The advantage of recording videos is that future memories are easier to connect than with pictures. The longer you record, the more detailed the documentation. If you want to turn specific scenes into pictures, you can simply take screenshots, which is very convenient.

### Technical Approach

App technical backup can be divided into two directions: the "bone," where the app itself is just a framework, and the "flesh," which is composed of API response data and forms the core content of the app.

- The app will disappear once it is removed from the App Store.

- Meat will disappear when the API host or server is shut down.

Therefore, we also divided the backup into two technical methods: skeleton and flesh.

#### Disclaimer

> *This article is for technical research sharing only and does not encourage the use of any technology for illegal or infringing activities.*

#### [Core] Backup .ipa App Installation Files

Once an app is removed from the store, it will remain on any device that has already downloaded it, as long as the user does not delete it. If you switch phones using a transfer method, the app will also be transferred.

But if we accidentally delete the app or change phones without transferring it, then it's truly goodbye forever; at this point, having a manual backup of the store's .ipa file can bring it back to life.

A long time ago, the [reverse engineering article](../7498e1ff93ce/) mentioned this, but this time we only need to back up the .ipa file without cracking; everything is done using Appleâ€™s official tools.

**1. Install [Apple Configurator 2](https://apps.apple.com/tw/app/apple-configurator/id1037126344?mt=12){:target="_blank"}**

![](/assets/b04f4fba3cf2/1*_RzuFIVGV9T_-xJ53H8fGA.png)

First, go to the Mac App Store to download and install [Apple Configurator 2](https://apps.apple.com/tw/app/apple-configurator/id1037126344?mt=12){:target="_blank"}

**2. Connect your iPhone to your Mac and tap Trust This Computer**

![](/assets/b04f4fba3cf2/1*EiSQmOkDCW73kYhJWbTipQ.png)

After a successful connection, the iPhone home screen will appear.

**3. Confirm that your phone has the app installed for the .ipa file you want to back up**

![](/assets/b04f4fba3cf2/1*QD9M4uM9eyKSixzu8AdKbw.png)

We need to create a replacement screen in Apple Configurator 2 to obtain the .ipa file downloaded to the cache. Therefore, we must first ensure the target app is installed on the phone.

**4. Back to Apple Configurator 2 on Mac**

Double-tap the iPhone home screen displayed above to enter the information page.

![](/assets/b04f4fba3cf2/1*X_y5uGhRRIq7VQuW4PkYBg.png)

Switch to "App" -> Top right corner "+ Add" -> "App"

After logging into your App Store account, you can access the list of apps you have previously purchased.

![](/assets/b04f4fba3cf2/1*uAyjPD75-MGokHCbDoC_4g.png)

Search for the target app you want to back up, then select it and click "Add".

![](/assets/b04f4fba3cf2/1*T-v1CNrmc7T4MpeyAX0c7A.png)

A waiting window will appear, showing "Adding App on XXX" and "Downloading 'XXX'."

**5. Extract .ipa File**

> ***Wait for the download to complete, then a prompt will appear asking if you want to replace the existing installed app.***

![](/assets/b04f4fba3cf2/1*9f54be4lixn4ezKhwRJrtg.png)

> ***Do not press any button at this time. Do not press any button at this time. Do not press any button at this time.***

Let's open a Finder:

In the top-left toolbar, select "Go" -> "Go to Folder"

![](/assets/b04f4fba3cf2/1*JgXWca5hKROuoOgLThkQnw.png)

Paste the following path:

```bash
~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps
```

You can find the target App .ipa file that has been downloaded and is ready to be installed:

![](/assets/b04f4fba3cf2/1*zV5yWozKqXtwekI33NWwVg.png)

Simply copying it completes the App .ipa file backup.

After completing the file copy, return to Apple Configurator 2 and click Stop to terminate the operation.

#### [Core] Restore .ipa App Installation File

Connect the iPhone with the app to be restored to the Mac and open Apple Configurator 2, then go to the Add Apps interface.

![](/assets/b04f4fba3cf2/1*6miYYw5QL6iqLQqrtHOi2A.png)

To restore, select "Choose from my Macâ€¦" at the bottom left corner.

![](/assets/b04f4fba3cf2/1*7a_25rE2eDpMFZqBC3sP6g.png)

Select the backup App .ipa file and click "Add".

![](/assets/b04f4fba3cf2/1*AcGEAuowmvvGRb-E22wu2g.png)

Wait for the transfer and installation to complete, then return to your phone to reopen the app and successfully revive it!

#### [Meat] Backup the Final API Response Data

Here, we will use the method and the open-source project created previously in the article [**App End-to-End Testing Local Snapshot API Mock Server**](../5a5c4b25a83d/) **(refer to it for detailed principles)**:

[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}

Similar to using recorded API Request & Response for running E2E Testing, we can also use it to capture the final API Request & Response data before an app is taken down or shut off.

**1. Install [mitmproxy](https://mitmproxy.org/){:target="_blank"}**

```typescript
brew install mitmproxy
```

mitmproxy is an open-source man-in-the-middle attack and network request sniffing tool.

If you are not familiar with how man-in-the-middle attacks work in Mitmproxy, you can first refer to my previous article: "[APP uses HTTPS transmission, but data was still stolen.](../46410aaada00/)" or the [Mitmproxy official documentation](https://docs.mitmproxy.org/stable/overview-getting-started/){:target="_blank"}.

If you are using it for pure network request sniffing and are not comfortable with the mitmproxy interface, you can switch to [Proxyman](https://proxyman.io/){:target="_blank"}. Refer to the usage in the previous [article](../70a1409b149a/).

**2. Complete mitmproxy Certificate Setup**

> *For HTTPS encrypted connections, root certificate replacement is required to perform a man-in-the-middle attack. Therefore, the first use requires downloading and enabling the root certificate on the mobile device.*

> **If your App & API Server implement SSL Pinning, you also need to add the pinning certificate to mitmproxy.**

- First, make sure your iPhone and Mac are connected to the same network.

- If there is no WiFi and your computer is on a wired network, you can also [enable Mac's WiFi sharing feature](https://applealmond.com/posts/92291){:target="_blank"} to let your phone connect to the Mac's network.

Start `mitmproxy` or `mitmweb` (Web GUI version) in the Terminal.

```typescript
mitmproxy
```

![](/assets/b04f4fba3cf2/1*xruNW5ZUPNuxVJvKOyPQTA.png)

Seeing this screen means the mitmproxy service has started. There is no traffic currently, so it is empty. Stay on this screen and do not close the Terminal.

- Check the Mac's IP Address in Mac Network Settings

Go back to the phone's WiFi settings and tap the "i" to enter detailed settings. Find the "Configure Proxy" option at the bottom:

![](/assets/b04f4fba3cf2/1*zXVilpUXnXakpWib007BPA.png)

![](/assets/b04f4fba3cf2/1*QV6reSNc0AJg7sQa2qiCjQ.png)

- Enter the Mac computer's IP address on the server

- Enter port 8080

- Save

**Open Safari on your phone and enter: <http://mitm.it/>{:target="_blank"}**

If it appears:

```kotlin
// If you can see this, traffic is not passing through mitmproxy.
```

It means the mobile device's network proxy server is not set up correctly or `mitmproxy` is not running on the Mac.

Normally, the following will appear:

![](/assets/b04f4fba3cf2/1*Ks5IHpi2AoPj4wXu5ZH9VA.png)

> *At this point, only HTTP traffic can be sniffed; HTTPS traffic will cause errors. We will continue with the configuration.*

Indicates a successful connection. We found the iOS section and clicked "Get mimproxy-ca-cert.pem."

![](/assets/b04f4fba3cf2/1*HvIg0jtUQ5ops519YUA52A.png)

![](/assets/b04f4fba3cf2/1*tU3gi3PBvrbUc-tqKjUD9w.png)

- Click "Allow"

After the download is complete, go to your phone's settings and you will see "Profile Downloaded." Tap to enter.

![](/assets/b04f4fba3cf2/1*JzX7U1jCtda915mGz5CPjw.png)

![](/assets/b04f4fba3cf2/1*mWmVPZ-au302NGHXgCxAow.png)

![](/assets/b04f4fba3cf2/1*SMnr82MEIo4YaYOvTpILeQ.png)

- Click to enter, tap "Install" at the top right, and enter your phone password to complete the installation.

Go to Settings -> "General" -> "About" -> scroll to the bottom to "Certificate Trust Settings" -> enable "mitmproxy".

![](/assets/b04f4fba3cf2/1*UOcYlpOolfWithLb517__g.png)

![](/assets/b04f4fba3cf2/1*LAoe10TplFdfWXEHMRAvWw.png)

- "Continue" to complete activation.

At this point, we have completed all the preparatory work for the man-in-the-middle attack.

> *Remember that all your phone's current data traffic will go through the proxy on your Mac. **After finishing, be sure to turn off the proxy server setting in your phone's network settings**, otherwise your phone's WiFi will not connect to the internet.*

Back in the Terminal mitmproxy, you can see all captured API request logs while operating the app on your phone.

![](/assets/b04f4fba3cf2/1*-aRzC2HWRCvGok-L9jbjHA.png)

Each request allows you to view detailed Request & Response content:

![](/assets/b04f4fba3cf2/1*IyO00OEpAadapGKNtOV_Mg.png)

The above covers the basic setup and practical use of mitmproxy.

**3. Sniffing and Understanding API Architecture**

Next, use mitmproxy's `mitmdump` service combined with the [**mitmproxy-rodo**](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} [addons](https://docs.mitmproxy.org/stable/addons-overview/){:target="_blank"} I developed earlier to record and replay requests.

> [*My implementation principle*](../5a5c4b25a83d/) *is to convert the request parameters into a hash value. During replay, the request is hashed again, and if a matching hash value backup response is found locally, it is returned. If multiple requests share the same hash value, they are stored and replayed in sequence.*

We can first sniff the appâ€™s API using the above methods (or use [Proxyman](https://proxyman.io/){:target="_blank"}) to observe which fields might affect Hash Mapping. Record these fields to exclude them in later settings. **For example, some APIs always include the `?ts` parameter, which does not affect the returned content but impacts the Hash calculation, causing local backups to be unrecognized. We need to identify and exclude such parameters in the subsequent settings.**

**4. Set up [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} :**

Use the open-source script I wrote for recording and playback.

> ***For detailed parameter settings, please refer to the documentation of the open-source project.***

```bash
git clone git@github.com:ZhgChgLi/mitmproxy-rodo.git
cd mitmproxy-rodo
```

Fill the parameters selected in step 3 into the config.json configuration file:

```json
{
  "ignored": {
    "*": {
      "*": {
        "*": {
          "iterable": false,
          "enables": [
            "query",
            "formData"
          ],
          "rules": {
            "query": {
              "parameters": [
                "ts",
                "connect_id",
                "device_id",
                "device_name"
              ]
            },
            "formData": {
              "parameters": [
                "aidck",
                "device_id",
                "ver_name"
              ]
            }
          }
        }
      }
    }
  }
}
```

The above parameters are excluded when calculating the hash value, and specific exclusion rules can be set for individual endpoint paths.

**5. Enable recording, then run the following in Terminal:**

```bash
mitmdump -s rodo.py --set dumper_folder=zhgchgli --set config_file=config.json --set record=true "~d zhgchg.li"
```

- The ending `"~d zhgchg.li"` means to exclude traffic only from *.zhgchg.li.

- `dumper_folder` : Output destination directory name

**6. Return to the phone to operate the target app and perform the process path you want to record**

- It is recommended to restart or reinstall the app to begin with the cleanest setup.

- It is recommended to record a video to help remember and reproduce the steps.

![](/assets/b04f4fba3cf2/1*SeivG1XaRcd5uq2uMkyrSA.png)

While operating, you can see the output directory contains many captured API Response Data, stored according to Domain -> API Path -> HTTP Method -> Hash Value -> Header-X / Content-X (if the same Hash is requested twice, they will be saved sequentially).

- Re-recording allows you to directly delete the output directory and let it re-extract.

- **If the returned data contains personal information, please remember to adjust the extracted content to anonymize it.**

#### [Meat] Playback Captured API Response Data

After recording, be sure to replay once to test if the data is correct. If the Hash Hit is very low (almost no matching Response found during replay), you can repeat the sniffing steps to identify the variable that changes each time the App runs and affects the Hash value, then exclude it.

**Execution Replay:**

```bash
mitmdump -s rodo.py --set dumper_folder=zhgchgli --set config_file=config.json
```

- `dumper_folder` : Output destination directory name

- By default, if there is no Hash Mapping for the Response Data locally, a 404 will be returned directly, causing the app to display a blank screen. This way, you can know whether the fetched data is valid.

![](/assets/b04f4fba3cf2/1*0Cjy_5RZRq3tvE1Pc0lQ9A.png)

![](/assets/b04f4fba3cf2/1*JKorlo3EBeSWXhB9Exw4ZA.png)

- Pages visited during recording are correctly displayed again during playback: OK!

- Recording captures pages not visited during the process, playback shows network error: OK!

### Remembrance

At this point, we can recreate the final moments before the app reached its end by restoring the framework and the last bits of content, cherishing the time when everyone worked together in unity to produce it.

This article commemorates the team from my first job and my transition from web backend development to iOS app development through learning on the job. In just 3â€“4 months, I independently built the product from scratch and successfully launched it together with Android developers, designers, PM supervisors, and backend colleagues. Although the product is now nearing the end of its lifecycle, I will always remember the bittersweet experiences and the excitement of seeing it go live and being used for the first time.

> "Thank you"

#### Welcome to Contribute

If you share the same regret, I hope this article can help you. The tool [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} was originally developed as a POC (proof of concept). Contributions, bug reports, or PRs to fix bugs are welcome.

[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main?source=post_page-----5a5c4b25a83d--------------------------------){:target="_blank"}

If you have any questions or feedback, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.

*[Post](https://medium.com/zrealm-ios-dev/app-%E7%94%A2%E5%93%81%E9%80%B2%E5%85%A5%E7%B5%82%E9%BB%9E%E7%AB%99-%E8%83%BD%E5%81%9A%E4%BB%80%E9%BA%BC%E4%BA%8B%E7%B7%AC%E6%87%B7-b04f4fba3cf2){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*