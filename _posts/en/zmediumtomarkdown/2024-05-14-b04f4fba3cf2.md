---
title: "What Can We Remember When an App Reaches Its End of Life?"
author: "ZhgChgLi"
date: 2024-05-14T16:20:45.012+0000
last_modified_at: 2024-05-14T16:20:45.012+0000
categories: ["ZRealm Dev."]
tags: ["ios-app-development","man-in-the-middle-attack","mitmproxy","python","app-development"]
description: "Using mitmproxy + Apple Configurator to keep the App in its pre-removal state forever"
image:
  path: /assets/b04f4fba3cf2/1*8RN-xVJROfLwtovgkvHDwA.jpeg
render_with_liquid: false
---

### What Can We Remember When an App Reaches Its End of Life?

Using mitmproxy + Apple Configurator to keep the App in its pre-removal state forever

### Introduction


![Jujutsu Kaisen](/assets/b04f4fba3cf2/1*8RN-xVJROfLwtovgkvHDwA.jpeg)

Jujutsu Kaisen

After working for a long time and handling many products, I have started to encounter products I once participated in that are about to reach their end of life (removal); developing a product from scratch is like nurturing a new life, and the team worked hard for 3–4 months to bring the child into the world; although it has since been handed over to other caregivers (engineers) for further nurturing, I still feel a bit of regret upon hearing that it is about to enter the end of its product life cycle.


> **_Life is like this; we never know whether the sun will rise first tomorrow or an unexpected event will occur; the only thing we can do is cherish the present and do our best._** 




#### Remembrance

Every journey leaves a trace, and we hope to do something before the product reaches its end of life, allowing everyone a chance to reminisce and at least leave proof of its existence; the following methods require the App to still be online; if it has already been removed, only memories remain.
### Non-Technical Method — Recording

In addition to directly using the [built-in screen recording feature on iPhone](https://support.apple.com/zh-tw/102653){:target="_blank"}, we can also use QuickTime Player to connect the phone to a Mac and record the screen, exporting the video.
1. Open QuickTime Player App on Mac



![](/assets/b04f4fba3cf2/1*UVkfiLbcYU8YuZEPdbJaOg.png)


2. In the top left corner of the toolbar, select "File" -> "New Movie Recording"


![](/assets/b04f4fba3cf2/1*VcRN0FExy-CA7sExHtMT6w.png)


3. After the recording interface pops up, click the "v" next to the red button, and select your connected phone for the screen and audio


![](/assets/b04f4fba3cf2/1*SN0XL8Zt0UlBizXiIqZiyA.png)


4. At this point, the recording interface will display the phone screen


![](/assets/b04f4fba3cf2/1*MSuecaACmg3ZNMnGpDkRFQ.png)


Click the "🔴" to start recording, then return to the phone to operate the content you want to record.


![](/assets/b04f4fba3cf2/1*bxL9Dq1IWgbrlSfKO6skLQ.png)


While recording, the current video size will be displayed; to stop recording, press the "🔴" again.


![](/assets/b04f4fba3cf2/1*VxWQNHF_PX5CZAkjJEXPbQ.png)


You can easily trim the video using the QuickTime Player toolbar, and finally press "Command" + "s" to export and save the video to a specified location, completing the recording for remembrance.

The benefit of video remembrance is that future memories can be more easily connected than images; the deeper the recording, the more detailed the documentation; if you want to convert specific frames into images, you can also take screenshots directly, which is very convenient.
### Technical Method

Technical backups of the App can be divided into two directions; the "skeleton" of the App itself is merely a framework, while the "flesh" is composed of API Response Data, which is the core content of the App.
- The skeleton will disappear when the App is removed from the App Store.
- The flesh will disappear when the API host or server is shut down.


Therefore, we also divide the technical methods into backing up the skeleton and the flesh.
#### Declaration


> _This article is solely for technical research sharing and does not encourage the use of any technology for illegal or infringing activities._ 




#### \[Skeleton\] Backup .ipa App Installation File

Once the App is removed from the store, as long as the downloaded App is not actively deleted from the phone, it will remain on that phone; transferring to a new phone will also carry it over.

However, if we accidentally delete the App or do not transfer it when changing phones, then it will truly be a permanent goodbye; at this point, if there is a manually backed up .ipa file from the store, it can be revived again.


A long time ago, the article on [reverse engineering](../7498e1ff93ce/) mentioned this, but this time we only need to back up the .ipa files without jailbreaking; everything is done using tools provided by Apple.

**1. Install [Apple Configurator 2](https://apps.apple.com/tw/app/apple-configurator/id1037126344?mt=12){:target="_blank"}**

![](/assets/b04f4fba3cf2/1*_RzuFIVGV9T_-xJ53H8fGA.png)

First, go to the Mac App Store to download and install “[Apple Configurator 2](https://apps.apple.com/tw/app/apple-configurator/id1037126344?mt=12){:target="_blank"}”.

**2. Connect your iPhone to the Mac and click to trust the computer**

![](/assets/b04f4fba3cf2/1*EiSQmOkDCW73kYhJWbTipQ.png)

Once connected successfully, the iPhone's home screen will appear.

**3. Ensure your phone has the app for which you want to back up the .ipa file installed**

![](/assets/b04f4fba3cf2/1*QD9M4uM9eyKSixzu8AdKbw.png)

We need to trigger the replacement screen in Apple Configurator 2 to obtain the .ipa file downloaded to the cache, so we must first ensure that the target app is installed on the phone.

**4. Return to Apple Configurator 2 on the Mac**

Double-click the iPhone home screen displayed above to enter the information page.

![](/assets/b04f4fba3cf2/1*X_y5uGhRRIq7VQuW4PkYBg.png)

Switch to “Apps” -> click the “+ Add” in the upper right corner -> “Apps”.

After logging into your App Store account, you can access the list of apps you have previously purchased.

![](/assets/b04f4fba3cf2/1*uAyjPD75-MGokHCbDoC_4g.png)

Search for the target app you want to back up, select it, and click “Add”.

![](/assets/b04f4fba3cf2/1*T-v1CNrmc7T4MpeyAX0c7A.png)

At this point, a waiting window will appear, indicating that the app is being added to XXX and downloading “XXX”.

**5. Extract the .ipa file**

> **_Just wait for the download to complete, and a prompt will appear asking whether to replace the currently installed app._**

![](/assets/b04f4fba3cf2/1*9f54be4lixn4ezKhwRJrtg.png)

> **_At this time, do not press any buttons. Do not press any buttons. Do not press any buttons._**

Open a Finder:

In the upper left corner of the toolbar, select “Go” -> “Go to Folder”.

![](/assets/b04f4fba3cf2/1*JgXWca5hKROuoOgLThkQnw.png)

Paste the following path:
```bash
~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps
```

You will find the target app .ipa file that is being prepared for installation:

![](/assets/b04f4fba3cf2/1*zV5yWozKqXtwekI33NWwVg.png)

Copy it out to complete the backup of the app .ipa file.

After copying the file, return to Apple Configurator 2 and click stop to terminate the operation.

#### \[Bone\] Restore .ipa App Installation File

Similarly, connect the phone from which you want to restore the app to the Mac and open Apple Configurator 2 to enter the app addition interface.

![](/assets/b04f4fba3cf2/1*6miYYw5QL6iqLQqrtHOi2A.png)

For restoration, select “Choose from my Mac…” in the lower left corner.

![](/assets/b04f4fba3cf2/1*7a_25rE2eDpMFZqBC3sP6g.png)

Select the backed-up app .ipa file and click “Add”.

![](/assets/b04f4fba3cf2/1*AcGEAuowmvvGRb-E22wu2g.png)

Wait for the transfer and installation to complete, and you can reopen the app on your phone, successfully reviving it!

#### \[Meat\] Backup the Final API Response Data

Here, we will use the method previously employed in the [**App End-to-End Testing Local Snapshot API Mock Server**](../5a5c4b25a83d/) **article (details and principles can be referenced)** along with the open-source project created at that time:

```markdown
[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}

Similar to the technique of recording API Request & Response for E2E Testing, we can also use it to log the last API Request & Response Data before an app is removed or goes offline.

**1\. Install [mitmproxy](https://mitmproxy.org/){:target="_blank"}**
```typescript
brew install mitmproxy
```

mitmproxy is an open-source man-in-the-middle attack and network request sniffing tool.

If you are not familiar with how Mitmproxy works, you can refer to my previous article: "[APP uses HTTPS for transmission, but data is still stolen.](../46410aaada00/)" or the [Mimproxy official documentation](https://docs.mitmproxy.org/stable/overview-getting-started/){:target="_blank"}.

If you are using it purely for network request sniffing and are not accustomed to the mimproxy interface, you can also switch to "[Proxyman](https://proxyman.io/){:target="_blank"}," and refer to my previous [another article](../70a1409b149a/) for usage.

**2\. Complete mitmproxy certificate setup**

> _For HTTPS encrypted connections, we need to use a root certificate for the man-in-the-middle attack, so the first time you use it, you must complete the download and activation of the root certificate on the mobile device._

> _\*If your App & API Server has implemented SSL Pinning, you also need to add the Pinning certificate to mitmproxy._

- First, ensure that your iPhone and Mac are connected to the same network environment.
- If there is no WiFi, you can connect the computer to a physical network and [enable Mac's WiFi sharing feature](https://applealmond.com/posts/92291){:target="_blank"} to allow the phone to connect to the Mac's network.

Start `mitmproxy` or `mitmweb` (Web GUI version) in the Terminal.
```typescript
mitmproxy
```

![](/assets/b04f4fba3cf2/1*xruNW5ZUPNuxVJvKOyPQTA.png)

Seeing this screen means that the mitmproxy service has started. Currently, there is no traffic coming in, so it is empty. Do not close the Terminal while on this screen.
- Go to Mac's network settings to check the Mac's IP address.

Return to the phone's WiFi settings, tap "i" to enter detailed settings, and find "Configure Proxy" at the bottom:

![](/assets/b04f4fba3cf2/1*zXVilpUXnXakpWib007BPA.png)

![](/assets/b04f4fba3cf2/1*QV6reSNc0AJg7sQa2qiCjQ.png)

- Enter the Mac's IP address in the server field.
- Enter 8080 in the port field.
- Save.

**Open Safari on the phone and enter: [http://mitm\.it/](http://mitm.it/){:target="_blank"}**

If you see:
```kotlin
If you can see this, traffic is not passing through mitmproxy.
```

It means that the mobile network proxy server has not been set up successfully or that `mitmproxy` is not running on the Mac.

Under normal circumstances, you will see:

![](/assets/b04f4fba3cf2/1*Ks5IHpi2AoPj4wXu5ZH9VA.png)

> _At this point, only HTTP traffic can be sniffed; HTTPS traffic will report an error. We will continue with the setup._

This indicates a successful connection. We find the iOS section and click "Get mimproxy-ca-cert.pem."

![](/assets/b04f4fba3cf2/1*HvIg0jtUQ5ops519YUA52A.png)

![](/assets/b04f4fba3cf2/1*tU3gi3PBvrbUc-tqKjUD9w.png)

- Click "Allow."

After the download is complete, go to the phone's settings, and you will see "Profile Downloaded." Click to enter.

![](/assets/b04f4fba3cf2/1*JzX7U1jCtda915mGz5CPjw.png)
```

```markdown
![](/assets/b04f4fba3cf2/1*mWmVPZ-au302NGHXgCxAow.png)

![](/assets/b04f4fba3cf2/1*SMnr82MEIo4YaYOvTpILeQ.png)

- Click to enter, then tap "Install" in the upper right corner, and enter your phone password to complete the installation.

Go back to Settings -> "General" -> "About" -> at the bottom "Certificate Trust Settings" -> enable "mitmproxy".

![](/assets/b04f4fba3cf2/1*UOcYlpOolfWithLb517__g.png)

![](/assets/b04f4fba3cf2/1*LAoe10TplFdfWXEHMRAvWw.png)

- Tap "Continue" to complete the activation.

At this point, we have completed all the preparatory work for the man-in-the-middle attack.

> _Remember that all traffic from your phone will go through the proxy to your Mac computer. **After finishing, remember to go back to the network settings on your phone and turn off the proxy server settings**, otherwise, your phone's WiFi will not connect to the external network._

Go back to Terminal mitmproxy, and while operating the app on your phone, you can see all the captured API request records.

![](/assets/b04f4fba3cf2/1*-aRzC2HWRCvGok-L9jbjHA.png)

Each request can be entered to view detailed Request & Response content:

![](/assets/b04f4fba3cf2/1*IyO00OEpAadapGKNtOV_Mg.png)

The above is the basic setup and actual work of mitmproxy.

**3. Sniffing and Understanding API Structure**

Next, we will use the `mitmdump` service of mitmproxy combined with the [**mitmproxy-rodo**](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} [addons](https://docs.mitmproxy.org/stable/addons-overview/){:target="_blank"} I developed earlier to record and replay requests.

> [_My implementation principle_](../5a5c4b25a83d/) _is to calculate the Hash value of the Request parameters. During replay, the request is calculated again for Hash, and if a backup Response with the same Hash value is found locally, it is returned. If there are multiple requests with the same Hash value, they will be stored and replayed in order._

We can first sniff the App's API using the above method (or use [Proxyman](https://proxyman.io/){:target="_blank"}), observing which fields and which fields may affect Hash Mapping. We can record them for exclusion in subsequent settings. **For example, some APIs always carry the `?ts` parameter, which does not affect the returned content but will affect the Hash value calculation, leading to the inability to find local backups. We need to identify and exclude them in the later settings.**

**4. Setting up [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}:**

Use the open-source script I wrote for recording and replaying.

> **_For detailed parameter settings, please refer to the documentation of the open-source project._**

```bash
git clone git@github.com:ZhgChgLi/mitmproxy-rodo.git
cd mitmproxy-rodo
```

Fill in the parameters identified in step 3 into the config.json configuration file:
```json
{
  "ignored": {
    "*": {
      "*": {
        "*": {
          "iterable": false,
          "enables": [
            "query",
            "formData"
          ],
          "rules": {
            "query": {
              "parameters": [
                "ts",
                "connect_id",
                "device_id",
                "device_name"
              ]
            },
            "formData": {
              "parameters": [
                "aidck",
                "device_id",
                "ver_name"
              ]
            }
          }
        }
      }
    }
  }
}
```


The above parameters will be excluded when calculating the Hash value, and specific exclusion rules can be set for individual Endpoint paths.

**5\. Enable recording, execute the following in Terminal:**
```bash
mitmdump -s rodo.py --set dumper_folder=zhgchgli --set config_file=config.json --set record=true "~d zhgchg.li"
```
- The ending `"~d zhgchg.li"` means to only capture traffic for *\.zhgchg\.li.
- `dumper_folder`: Name of the output directory


**6\. Go back to the mobile device and operate the target App to execute the recording process path**
- It is recommended to restart and reinstall the App to start the operation in the cleanest way.
- It is suggested to use screen recording to help remember the steps for reproduction.



![](/assets/b04f4fba3cf2/1*SeivG1XaRcd5uq2uMkyrSA.png)


While operating, you will see that the output directory will have many captured API Response Data, stored according to Domain -> API path -> HTTP method -> Hash value -> Header-X / Content-X (if the same Hash request is made twice, it will be stored in order).
- To re-record, you can directly delete the output directory to allow it to capture again.
- **If the returned data contains personal information, please remember to adjust the captured content for anonymization.**

#### \[Meat\] Replay the captured API Response Data

After recording, be sure to try replaying once to test whether the data is normal. If the Hash Hit is very low (almost no corresponding Response found during replay), you can repeat the sniffing steps to find the variable that affects the Hash value each time the App is executed and exclude it.

**Execute replay:**
```bash
mitmdump -s rodo.py --set dumper_folder=zhgchgli --set config_file=config.json
```
- `dumper_folder`: Name of the output directory
- By default, if there is no Hash Mapping to the Response Data locally, it will directly return 404, leaving the App blank, which allows you to know whether the captured data is valid.



![](/assets/b04f4fba3cf2/1*0Cjy_5RZRq3tvE1Pc0lQ9A.png)



![](/assets/b04f4fba3cf2/1*JKorlo3EBeSWXhB9Exw4ZA.png)

- Paths that were traversed during recording will display again during replay: OK!
- Paths that were not traversed during recording will show a network error during replay: OK!

### Remembrance

At this point, we can recreate the last moments before the App reached its terminus by restoring the bones and the final meat, in memory of the time when everyone worked together to produce it.

This article is dedicated to the team of my first job and the journey from web backend development to iOS App development, independently creating a product from scratch in a short period of 3–4 months, successfully produced with Android, design, PM supervisors, and backend colleagues. Although it is about to enter the endpoint of its life cycle, I will always remember the bittersweet memories and the emotion of seeing it go live for the first time with users.

> "Thank you" 



#### Contributions Welcome

If you share the same regrets, I hope this article can help you, as [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} was initially developed as a POC concept verification tool. Contributions, bug reports, or PRs to fix bugs are welcome.


[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main?source=post_page-----5a5c4b25a83d--------------------------------){:target="_blank"}



If you have any questions or suggestions, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.



_[Post](https://medium.com/zrealm-ios-dev/app-%E7%94%A2%E5%93%81%E9%80%B2%E5%85%A5%E7%B5%82%E9%BB%9E%E7%AB%99-%E8%83%BD%E5%81%9A%E4%BB%80%E9%BA%BC%E4%BA%8B%E7%B7%AC%E6%87%B7-b04f4fba3cf2){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._

It seems there is no Markdown content provided for translation. Please provide the text you would like me to translate.
