---
title: "Universal Links Updates"
author: "ZhgChgLi"
date: 2021-02-04T03:57:25.914+0000
last_modified_at: 2024-09-13T09:31:54.655+0000
categories: ["ZRealm Dev."]
tags: ["ios","ios-app-development","universal-links","app-store","deeplink"]
description: "iOS 13, iOS 14 Universal Links updates & setting up a local testing environment"
image:
  path: /assets/12c5026da33d/1*HYAd1aal5Et1A-Qzs6VAtQ.jpeg
render_with_liquid: false
---

### Universal Links Updates

iOS 13, iOS 14 Universal Links updates & setting up a local testing environment



![Photo by [NASA](https://unsplash.com/@nasa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/12c5026da33d/1*HYAd1aal5Et1A-Qzs6VAtQ.jpeg)

Photo by [NASA](https://unsplash.com/@nasa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
### Introduction

For a service that has both a website and an app, the functionality of Universal Links is incredibly important for user experience, enabling seamless integration between the web and the app. However, there has always been only a simple setup with not much elaboration; recently, I spent some time researching this topic and recorded some interesting findings.
### Common Considerations

In the services I have handled, the consideration for implementing Universal Links is that the app does not have complete website functionality. Universal Links recognize the domain name, and as long as the domain matches, the app will open. Regarding this issue, it can be noted that URLs without corresponding functionality on the app should not be excluded. If the website service URL is very extreme, it might be better to create a new subdomain for Universal Links.
### When is apple\-app\-site\-association updated?
- For iOS < 14, the app will query the Universal Links website's apple\-app\-site\-association during the first installation or update.
- For iOS ≥ 14, Apple CDN periodically caches and updates the Universal Links website's apple\-app\-site\-association; the app will retrieve it from Apple CDN during the first installation or update. However, there is a potential issue: the apple\-app\-site\-association from Apple CDN may still be outdated.

Regarding the update mechanism of Apple CDN, I checked the documentation, but it did not mention anything; I looked at the [discussion](https://developer.apple.com/forums/thread/651737){:target="_blank"}, and the official response was only that it "will be updated regularly," with details to be published in the documentation... but I still haven't seen anything to date.

> _I personally think it should be updated within 48 hours at the latest... So if there are changes to the apple\-app\-site\-association, it is recommended to update it a few days before the app is released._ 

#### apple\-app\-site\-association Apple CDN Confirmation:
```
Headers: HOST=app-site-association.cdn-apple.com
GET https://app-site-association.cdn-apple.com/a/v1/your-domain
```


![](/assets/12c5026da33d/1*dgDfMgkFPUfeuAuEhl7RFQ.png)


You can see what the current version on Apple CDN looks like. (Remember to add the Request Header `Host=https://app-site-association.cdn-apple.com/` )
#### iOS ≥ 14 Debug

Due to the aforementioned CDN issue, how can we debug during the development phase?

Fortunately, Apple has provided a solution for this; otherwise, it would be really frustrating not to have real-time updates. We just need to add `?mode=developer` to `applinks:domain.com`, and there are also `managed (for internal enterprise apps)` or `developer+managed` modes that can be set.

```markdown
![](/assets/12c5026da33d/1*z4R7wEHHAlLyF1rdAEAmew.png)

After adding mode=developer, the app will directly fetch the latest app-site-association from the website every time it builds and runs in the simulator.

If you want to build and run on a real device, you need to go to "Settings" -> "Developer" -> enable the "Associated Domains Development" option.

![](/assets/12c5026da33d/1*gj4Qm445mFERa25t6PZV1Q.jpeg)

> _⚠️ **There is a pitfall here**, app-site-association can be placed in the root directory of the website or in the `./.well-known` directory; however, in mode=developer, it will only look for `./.well-known/app-site-association`, which made me think it wasn't working._

### Development Testing

If you are using iOS <14 and have modified the app-site-association, remember to delete it and then rebuild and run the app to fetch the latest version. For iOS ≥ 14, please refer to the aforementioned method with mode=developer.

For modifications to the app-site-association content, if you have access, you can modify the file on the server; however, for those of us who sometimes cannot access the server, testing universal links can be very troublesome, as it requires constantly asking backend colleagues for help. This means you need to be very certain about the app-site-association content before going live, as making frequent changes can drive colleagues crazy.

#### Create a Local Simulation Environment

To solve the above problem, we can set up a small service locally.

First, install nginx on your Mac:
```bash
brew install nginx
```

If you haven't installed [brew](https://brew.sh/index_zh-tw){:target="_blank"}, you can install it first:
```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

After installing nginx, go to `/usr/local/etc/nginx/` and open the `nginx.conf` file for editing:
```perl
...略
server {
        listen       8080;
        server_name  localhost;
#charset koi8-r;
#access_log  logs/host.access.log  main;
location / {
            root   /Users/zhgchgli/Documents;
            index  index.html index.htm;
        }
...略
```

Around line 44, change the root in the location / block to the directory you want (using Documents as an example here).

> _Listen on **8080** port; if there are no conflicts, there is no need to modify it._

After saving the changes, start nginx with the following command:
```bash
nginx
```

To stop it, use:
```bash
nginx -s stop
```

If you have changed `nginx.conf`, remember to run:
```bash
nginx -s reload
```

To restart the service.

Create a `./.well-known` directory in the root directory you just set and place the `apple-app-site-association` file inside `./.well-known`.

> _⚠️ If the `.well-known` directory disappears after being created, please ensure that your Mac has the "Show Hidden Files" feature enabled:_

In the terminal, run:
```bash
defaults write com.apple.finder AppleShowAllFiles TRUE
```

Then run killall finder to restart all finders.

![](/assets/12c5026da33d/1*AzM6lK0kzT-M-2OdXoyIXA.png)

> _⚠️_ `apple-app-site-association` _appears to have no file extension, but it actually does have a .json extension:_

Right-click on the file -> "Get Info" -> "Name & Extension" -> check for the file extension & you can also uncheck "Hide extension."
```

![](/assets/12c5026da33d/1*UFwnnjCot8xRqslhdQktKg.png)

After confirming there are no issues, open the browser and test the following link to see if the apple-app-site-association downloads correctly:
```
http://localhost:8080/.well-known/apple-app-site-association
```

If it downloads successfully, it means the local environment simulation was successful!

> _If a 404/403 error occurs, please check if the root directory is correct, if the directory/file has been placed correctly, and ensure that apple-app-site-association does not accidentally have a file extension (e.g., .json)._ 

**Register & Download [Ngrok](http://ngrok.com){:target="_blank"}**

![[ngrok\.com](https://dashboard.ngrok.com/get-started/setup){:target="_blank"}](/assets/12c5026da33d/1*Shk9u59HgRRSiMw0wt899Q.png)

[ngrok\.com](https://dashboard.ngrok.com/get-started/setup){:target="_blank"}

![Extract the ngrok executable](/assets/12c5026da33d/1*ljBqKrOFb9Gq48dO0GeIeA.png)

Extract the ngrok executable

![Go to the [Dashboard page](https://dashboard.ngrok.com/get-started/setup){:target="_blank"} to execute Config settings](/assets/12c5026da33d/1*fnEUyJMtVhUGurU5vX5K6A.png)

Go to the [Dashboard page](https://dashboard.ngrok.com/get-started/setup){:target="_blank"} to execute Config settings
```bash
./ngrok authtoken your_TOKEN
```

After setting it up, run:
```bash
./ngrok http 8080
```

> _Because our nginx is on port 8080._ 

Start the service.

![](/assets/12c5026da33d/1*8i6EP7KKwxihLZ1PG1RUGw.png)

At this point, we will see a service startup status window, from which we can obtain the public URL assigned this time from Forwarding.

> _⚠️ **The URL assigned each time upon startup will change, so it can only be used for development testing.**_ 

> _**Here, we take the assigned URL** `https://ec87f78bec0f.ngrok.io/` as an example._ 

Return to the browser and enter `https://ec87f78bec0f.ngrok.io/.well-known/apple-app-site-association` to see if the apple-app-site-association file can be downloaded correctly. If there are no issues, you can proceed to the next step.

Enter the URL assigned by ngrok into the Associated Domains applinks: settings.

![](/assets/12c5026da33d/1*K5Eio0Yi7nNHQuLSuIsYeA.png)

Remember to include `?mode=developer` for easier testing.

**Rebuild & Run APP:**

![](/assets/12c5026da33d/1*VFIKU-UxCHNQVnf8DOV8Qw.png)

Open the browser and enter the corresponding Universal Links test URL (e.g., `https://ec87f78bec0f.ngrok.io/buy/123`) to see the effect.

> _If the page shows a 404 error, ignore it, as we do not actually have that page; we just want to test if iOS matches the URL as expected. If "Open" appears above, it indicates a successful match. Additionally, you can test the NOT reverse situation._ 

Click "Open" to launch the APP -> test successful!

> _After confirming everything works during the development phase, submit the modified apple-app-site-association file to the backend for upload to the server to ensure everything is foolproof._ 

> _Finally, remember to change the Associated Domains applinks: to the production URL._ 

Additionally, we can also see from the ngrok running status window whether each APP Build & Run has the apple-app-site-association file we need:

![](/assets/12c5026da33d/1*d6yvnEaiOPbqy57PDMe2Mw.png)

### Applinks Configuration Content
#### iOS < 13:

The configuration file is simpler, with only the following content available for configuration:
```json
{
  "applinks": {
      "apps": [],
      "details": [
           {
             "appID" : "TeamID.BundleID",
             "paths": [
               "NOT /help/",
               "*"
             ]
           }
       ]
   }
}
```

Replace `TeamID.BundleId` with your project settings (e.g., TeamID = `ABCD`, BundleID = `li.zhgchg.demoapp` => `ABCD.li.zhgchg.demoapp`).


> _If there are multiple appIDs, you need to add multiple entries._ 





**The paths section contains matching rules and supports the following syntax:**
- `*` : Matches 0 or more characters, e.g., `/home/*` (home/alan…)
- `?` : Matches 1 character, e.g., `201?` (2010~2019)
- `?*` : Matches 1 or more characters, e.g., `/?*` (/test, /home... )
- `NOT` : Excludes, e.g., `NOT /help` (any URL but /help)


You can decide on more combinations based on actual situations. For more information, refer to the [official documentation](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html#//apple_ref/doc/uid/TP40016308-CH12-SW1){:target="_blank"}.


> _\- Please note, it is not Regex and does not support any Regex syntax._ 
 

> _\- The old version does not support Query (?name=123), Anchor (#title)._ 
 

> _\- Chinese URLs must be converted to ASCII before being placed in paths (all URL characters must be ASCII)._ 




#### iOS ≥ 13:

The functionality of the configuration file has been enhanced, adding support for Query/Anchor, character sets, and encoding handling.
```json
"applinks": {
  "details": [
    {
      "appIDs": [ "TeamID.BundleID" ],
      "components": [
        {
          "#": "no_universal_links",
          "exclude": true,
          "comment": "Matches any URL whose fragment equals no_universal_links and instructs the system not to open it as a universal link"
        },
        {
          "/": "/buy/*",
          "comment": "Matches any URL whose path starts with /buy/"
        },
        {
          "/": "/help/website/*",
          "exclude": true,
          "comment": "Matches any URL whose path starts with /help/website/ and instructs the system not to open it as a universal link"
        },
        {
          "/": "/help/*",
          "?": { "articleNumber": "????" },
          "comment": "Matches any URL whose path starts with /help/ and that has a query item with name 'articleNumber' and a value of exactly 4 characters"
        }
      ]
    }
  ]
}
```

Here is the translated text:

---

This is a repost from the official document, and you can see that the format has changed.

`appIDs` is an array that can contain multiple appIDs, so you no longer have to repeat the entire block like before.

> _WWDC mentioned compatibility with the old version; **when iOS ≥ 13 reads the new format, it will ignore the old paths**._

The matching rules are now placed in `components`; supporting three types:
- `/` : URL
- `?` : Query, ex: ?name=123&place=tw
- `#` : Anchor, ex: \#title

They can also be used together. For example, if today you need to jump to the APP only when `/user/?id=100#detail`, you can write it as:
```json
{
  "/": "/user/*",
  "?": { "id": "*" },
  "#": "detail"
}
```

The matching syntax is the same as the original syntax, supporting `*`, `?`, and `?*`.

A new `comment` field has been added for entering comments for easier identification. (But please note that this is public and others can see it.)

Reverse exclusion is changed to specify `exclude: true`.

A new `caseSensitive` feature has been added, allowing you to specify whether the matching rules are case-sensitive, with the `default: true`. If this is needed, you can write significantly fewer rules.

A new `percentEncoded` parameter has been introduced. In the old version, URLs needed to be converted to ASCII and placed in paths (if they were in Chinese, they would become very ugly and unrecognizable); this parameter determines whether to automatically encode for us, with the `default being true`. If it is a Chinese URL, it can be directly placed in \(ex: `/客服中心`\).

For detailed official documentation, you can [refer to this](https://developer.apple.com/documentation/bundleresources/applinks/details/components){:target="_blank"}.

**Default Character Set:**

This is considered one of the important features of this update, adding support for character sets.

The character sets defined by the system are:
- `$(alpha)` : A\-Z and a\-z
- `$(upper)` : A\-Z
- `$(lower)` : a\-z
- `$(alnum)` : A\-Z and a\-z and 0–9
- `$(digit)` : 0–9
- `$(xdigit)` : hexadecimal characters, 0–9 and a,b,c,d,e,f,A,B,C,D,E,F
- `$(region)` : ISO region codes [isoRegionCodes](https://developer.apple.com/documentation/foundation/locale/2293271-isoregioncodes){:target="_blank"}, Ex: TW
- `$(lang)` : ISO language codes [isoLanguageCodes](https://developer.apple.com/documentation/foundation/locale/2293744-isolanguagecodes){:target="_blank"}, Ex: zh

If our URL has multiple languages and I want to support Universal links, I can set it up like this:
```json
"components": [        
     { "/" : "/$(lang)-$(region)/$(food)/home" }      
]
```

This way, both `/zh-TW/home` and `/en-US/home` can be supported, which is very convenient and eliminates the need to write a whole row of rules yourself!

**Custom Character Set:**

In addition to the default character set, we can also create custom character sets to increase configuration reuse and readability.

By adding `substitutionVariables` in `applinks`, you can do this:
```json
{
  "applinks": {
    "substitutionVariables": {
      "food": [ "burrito", "pizza", "sushi", "samosa" ]
    },
    "details": [{
      "appIDs": [ ... ],
      "components": [
        { "/" : "/$(food)/" }
      ]
    }]
  }
}
```

In the example, a custom `food` character set is defined and used in the subsequent `components`.

The above example can match `/burrito`, `/pizza`, `/sushi`, and `/samosa`.

For details, you can refer to the [official document here](https://developer.apple.com/documentation/bundleresources/applinks/substitutionvariables){:target="_blank"}.

#### No inspiration?

If you lack inspiration for the configuration file content, you can secretly refer to the content from other websites. Simply append `/app-site-association` or `/.well-known/app-site-association` to the homepage URL of the service website to access their settings.

For example: [https://www\.netflix\.com/apple\-app\-site\-association](https://www.netflix.com/apple-app-site-association){:target="_blank"}
### Supplement

When using `SceneDelegate`, the entry point for opening universal links is in the SceneDelegate:
```swift
func scene(_ scene: UIScene, continue userActivity: NSUserActivity)
```

**Not in AppDelegate:**
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool
```
### Further Reading
- [iOS Cross-Platform Account Password Integration to Enhance Login Experience](../948ed34efa09/)
- [iOS Deferred Deep Link Implementation (Swift)](../b08ef940c196/)

#### References
- [What’s new in Universal Links](https://www.wwdcnotes.com/notes/wwdc20/10098/){:target="_blank"}
- [Apple Documentation](https://developer.apple.com/documentation/bundleresources/applinks){:target="_blank"}



If you have any questions or suggestions, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.



_[Post](https://medium.com/zrealm-ios-dev/universal-links-%E6%96%B0%E9%AE%AE%E4%BA%8B-12c5026da33d){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
