---
title: "iOS Vision Framework x WWDC 24: Discover Swift Enhancements in the Vision Framework Session"
author: "ZhgChgLi"
date: 2024-08-13T08:10:37.015+0000
last_modified_at: 2024-08-14T12:07:49.774+0000
categories: ["KKday Tech Blog"]
tags: ["ios-app-development", "vision-framework", "apple-intelligence", "ai", "machine-learning"]
description: "A review of the Vision framework features & hands-on with the new Swift API in iOS 18"
image:
  path: /assets/755509180ca8/1*NqN-_MAE4tt11n6MnUQWxQ.jpeg
render_with_liquid: false
---

### iOS Vision Framework x WWDC 24: Discover Swift Enhancements in the Vision Framework Session

A review of the Vision framework features & hands-on with the new Swift API in iOS 18

![Photo by [BoliviaInteligente](https://unsplash.com/@boliviainteligente?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash){:target="_blank"}](/assets/755509180ca8/1*NqN-_MAE4tt11n6MnUQWxQ.jpeg)

Photo by [BoliviaInteligente](https://unsplash.com/@boliviainteligente?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash){:target="_blank"}

#### Topic

![The relationship between Vision Pro and hot dogs is as unrelated as it gets.](/assets/755509180ca8/1*ebqm2jzCK1GSrDDY0XtrUA.png)

The relationship between Vision Pro and hot dogs is as unrelated as it gets.

### Vision Framework

The Vision framework is Apple‚Äôs integrated image recognition framework that leverages machine learning, allowing developers to easily and quickly implement common image recognition functionalities. Launched with iOS 11.0 (2017/iPhone 8), the framework has undergone continuous iterations and optimizations, enhancing its integration with Swift Concurrency to improve execution performance. Starting from iOS 18.0, it introduces a brand new Swift Vision framework API that maximizes the benefits of Swift Concurrency.

**Features of the Vision Framework**
- Built-in methods for various image recognition and dynamic tracking (31 methods available as of iOS 18)
- On-device processing using the phone's chip, ensuring fast and secure recognition without relying on cloud services
- Simple and user-friendly API
- Supported across all Apple platforms: iOS 11.0+, iPadOS 11.0+, Mac Catalyst 13.0+, macOS 10.13+, tvOS 11.0+, visionOS 1.0+
- Released for several years (2017-present) with ongoing updates
- Integrated Swift language features to enhance computational performance

> **_I played around with this 6 years ago: [An Introduction to Vision ‚Äî Automatic Face Cropping for App Profile Pictures (Swift)](../9a9aa892f9a9/)_**

> _This time, I revisited it alongside the [WWDC 24 Discover Swift enhancements in the Vision framework Session](https://developer.apple.com/videos/play/wwdc2024/10163/){:target="_blank"} to explore the new Swift features again._

#### CoreML

Apple also has another framework called [CoreML](https://developer.apple.com/documentation/coreml){:target="_blank"}, which is a machine learning framework based on on-device processing. It allows you to train your own models for recognizing objects and documents, which can then be integrated directly into your app. Interested developers can give it a try (e.g., [Real-time Article Classification](../793bf2cdda0f/), real-time [Spam Detection](https://apps.apple.com/tw/app/%E7%86%8A%E7%8C%AB%E5%90%83%E7%9F%AD%E4%BF%A1-%E5%9E%83%E5%9C%BE%E7%9F%AD%E4%BF%A1%E8%BF%87%E6%BB%A4/id1319191852){:target="_blank"} ‚Ä¶).

#### P.S.

[**Vision**](https://developer.apple.com/documentation/vision/){:target="_blank"} **vs. [VisionKit](https://developer.apple.com/documentation/visionkit){:target="_blank"}:**

> [**_Vision_**](https://developer.apple.com/documentation/vision/){:target="_blank"} _is primarily used for image analysis tasks such as face recognition, barcode detection, and text recognition. It provides powerful APIs for processing and analyzing visual content in static images or videos._

> [**_VisionKit_**](https://developer.apple.com/documentation/visionkit){:target="_blank"} _is specifically designed for tasks related to document scanning. It provides a scanner view controller that can be used to scan documents and generate high-quality PDFs or images._

The Vision framework cannot run on M1 models in the simulator; it can only be tested on physical devices. Running it in a simulator environment will throw a `Could not create Espresso context` error. I checked the [official forum discussion but couldn't find a solution](https://forums.developer.apple.com/forums/thread/675806){:target="_blank"}.

> _Since I don't have a physical iOS 18 device for testing, all execution results in this article are based on older code (pre-iOS 18). **If any errors arise with the new code, please feel free to leave a comment.**_

### WWDC 2024 ‚Äî Discover Swift Enhancements in the Vision Framework

![[Discover Swift enhancements in the Vision framework](https://developer.apple.com/videos/play/wwdc2024/10163/?time=45){:target="_blank"}](/assets/755509180ca8/1*8N5GtY1uqxP-4iAAAticOA.png)

[Discover Swift enhancements in the Vision framework](https://developer.apple.com/videos/play/wwdc2024/10163/?time=45){:target="_blank"}

> _This article shares notes from the WWDC 24 session on [Discover Swift enhancements in the Vision framework](https://developer.apple.com/videos/play/wwdc2024/10163/?time=45){:target="_blank"} along with some personal experimental insights._

### Introduction ‚Äî Vision Framework Features
#### Face Recognition and Contour Detection

![](/assets/755509180ca8/1*RNGfE_EeaQhiKAPdJeFYQw.png)

![](/assets/755509180ca8/1*iMdzeLm2aWjATVV6_Kvrjg.png)

#### Text Recognition in Image Content

As of iOS 18, it supports 18 languages.

![](/assets/755509180ca8/1*kU_OYn5w368h-ahDYU4lDw.png)

```swift
// List of supported languages
if #available(iOS 18.0, *) {
  print(RecognizeTextRequest().supportedRecognitionLanguages.map { "\($0.languageCode!)-\(($0.region?.identifier ?? $0.script?.identifier)!)" })
} else {
  print(try! VNRecognizeTextRequest().supportedRecognitionLanguages())
}

// The actual available recognition languages are as follows:
// The output from iOS 18 shows the following results:
// ["en-US", "fr-FR", "it-IT", "de-DE", "es-ES", "pt-BR", "zh-Hans", "zh-Hant", "yue-Hans", "yue-Hant", "ko-KR", "ja-JP", "ru-RU", "uk-UA", "th-TH", "vi-VT", "ar-SA", "ars-SA"]
// I did not see the Swedish language mentioned at WWDC; it's unclear if it hasn't been released yet or if it's related to device region and language settings.
```

#### Dynamic Motion Capture

![](/assets/755509180ca8/1*6TfyCcszdD1NdId0bdM16Q.gif)

![](/assets/755509180ca8/1*8y_XXdH36uKpfP0p6BCJQA.gif)

- Enables dynamic capture of people and objects
- Gesture recognition allows for air signature functionality

#### What‚Äôs New in Vision? (iOS 18) ‚Äî Image Scoring Feature (Quality, Memorability)
- Can calculate a score for input images, making it easier to filter out high-quality photos
- The scoring method includes multiple dimensions, not just image quality, but also lighting, angle, subject matter, and **whether it evokes a memorable point** ‚Ä¶ etc.

![](/assets/755509180ca8/1*XwjeaHcB6arxJhIR7cFsWg.png)

![](/assets/755509180ca8/1*YdhZlZBlTaIZd4nLxhBtaQ.png)

![](/assets/755509180ca8/1*IhMDFdk6DWwTv1qIG0Gi0Q.png)

During WWDC, the above three images were used for explanation (under the same quality):
- High-scoring image: good composition, lighting, and memorable points
- Low-scoring image: lacks a subject, appears to be a casual or accidental shot
- Utility image: technically well-taken but lacks memorable points, like stock images.

**iOS ‚â• 18 New API: [CalculateImageAestheticsScoresRequest](https://developer.apple.com/documentation/vision/calculateimageaestheticsscoresrequest){:target="_blank"}**
```swift
let request = CalculateImageAestheticsScoresRequest()
let result = try await request.perform(on: URL(string: "https://zhgchg.li/assets/cb65fd5ab770/1*yL3vI1ADzwlovctW5WQgJw.jpeg")!)

// Photo score
print(result.overallScore)

// Whether it is classified as a utility image
print(result.isUtility)
```

#### What‚Äôs New in Vision? (iOS 18) ‚Äî Simultaneous Detection of Body and Gesture Poses

![](/assets/755509180ca8/1*A9320aRV-jdccgiXrmSrJw.png)

Previously, body poses and hand poses could only be detected individually. This update allows developers to detect body poses and hand poses simultaneously, combining them into a single request and result, facilitating the development of more application functionalities.

**iOS ‚â• 18 New API: [DetectHumanBodyPoseRequest](https://developer.apple.com/documentation/vision/detecthumanbodyposerequest){:target="_blank"}**
```swift
var request = DetectHumanBodyPoseRequest()
// Also detect hand poses
request.detectsHands = true

guard let bodyPose = try await request.perform(on: image).first else { return }

// Body Pose Joints
let bodyJoints = bodyPose.allJoints()
// Left Hand Pose Joints
let leftHandJoints = bodyPose.leftHand.allJoints()
// Right Hand Pose Joints
let rightHandJoints = bodyPose.rightHand.allJoints()
```

### New Vision API

In this update, Apple has provided new Swift Vision API wrappers for developers. In addition to supporting the original functionalities, the focus is on enhancing Swift 6 / Swift Concurrency features, offering better performance and a more Swift-like API operation style.

### Get Started with Vision

![](/assets/755509180ca8/1*mv9g5jmqrS6YScxoGYJemQ.png)

![](/assets/755509180ca8/1*iidNN7nKHoskh_tcjfuHKQ.png)

The speaker reintroduced the basic usage of the Vision framework, which Apple has packaged into [31 types](https://developer.apple.com/documentation/vision/visionrequest){:target="_blank"} (as of iOS 18) of common image recognition requests and their corresponding observation objects.
1. **Request:** DetectFaceRectanglesRequest for face area recognition
   **Result:** FaceObservation
   The previous article ‚Äú[An Introduction to Vision ‚Äî Automatic Face Cropping for App Profile Pictures (Swift)](../9a9aa892f9a9/)‚Äù used this pair of requests.
2. **Request:** RecognizeTextRequest for text recognition
   **Result:** RecognizedTextObservation
3. **Request:** GenerateObjectnessBasedSaliencyImageRequest for subject object recognition
   **Result:** SaliencyImageObservation

### All 31 Types of Requests:

[VisionRequest](https://developer.apple.com/documentation/vision/visionrequest){:target="_blank"}.


Here‚Äôs the translated text in naturalistic English while preserving the original markdown image sources:

| Request Purpose                                 | Observation Description                                          |
|-------------------------------------------------|----------------------------------------------------------------|
| CalculateImageAestheticsScoresRequest<br/>Calculate the aesthetics score of an image.                                 | AestheticsObservation<br/>Returns the aesthetics score of the image, considering factors like composition and color.                           |
| ClassifyImageRequest<br/>Classify the content of an image.                                      | ClassificationObservation<br/>Returns classification labels and confidence levels for objects or scenes in the image.                           |
| CoreMLRequest<br/>Analyze the image using a Core ML model.                          | CoreMLFeatureValueObservation<br/>Generates observations based on the output of the Core ML model.                            |
| DetectAnimalBodyPoseRequest<br/>Detect the pose of animals in the image.                               | RecognizedPointsObservation<br/>Returns the skeletal points of the animal and their locations.                                         |
| DetectBarcodesRequest<br/>Detect barcodes in the image.                                   | BarcodeObservation<br/>Returns barcode data and types (e.g., QR code).                                 |
| DetectContoursRequest<br/>Detect contours in the image.                                   | ContoursObservation<br/>Returns the detected contour lines in the image.                                         |
| DetectDocumentSegmentationRequest<br/>Detect and segment documents in the image.                             | RectangleObservation<br/>Returns the rectangular boundary positions of the document.                                         |
| DetectFaceCaptureQualityRequest<br/>Evaluate the quality of face capture.                                   | FaceObservation<br/>Returns a quality assessment score for the face image.                                       |
| DetectFaceLandmarksRequest<br/>Detect facial landmarks.                                     | FaceObservation<br/>Returns detailed positions of facial landmarks (e.g., eyes, nose, etc.).                       |
| DetectFaceRectanglesRequest<br/>Detect faces in the image.                                   | FaceObservation<br/>Returns the boundary box positions of the faces.                                             |
| DetectHorizonRequest<br/>Detect the horizon in the image.                                 | HorizonObservation<br/>Returns the angle and position of the horizon.                                           |
| DetectHumanBodyPose3DRequest<br/>Detect 3D human body poses in the image.                           | RecognizedPointsObservation<br/>Returns 3D skeletal points of the human body and their spatial coordinates.                                    |
| DetectHumanBodyPoseRequest<br/>Detect human body poses in the image.                               | RecognizedPointsObservation<br/>Returns skeletal points of the human body and their coordinates.                                           |
| DetectHumanHandPoseRequest<br/>Detect hand poses in the image.                               | RecognizedPointsObservation<br/>Returns skeletal points of the hand and their locations.                                           |
| DetectHumanRectanglesRequest<br/>Detect humans in the image.                                   | HumanObservation<br/>Returns the boundary box positions of the human figures.                                             |
| DetectRectanglesRequest<br/>Detect rectangles in the image.                                   | RectangleObservation<br/>Returns the coordinates of the four vertices of the rectangle.                                           |
| DetectTextRectanglesRequest<br/>Detect text areas in the image.                               | TextObservation<br/>Returns the positions and boundary boxes of the text areas.                                       |
| DetectTrajectoriesRequest<br/>Detect and analyze the motion trajectories of objects.                             | TrajectoryObservation<br/>Returns the motion trajectory points and their time series.                                       |
| GenerateAttentionBasedSaliencyImageRequest<br/>Generate an attention-based saliency image.                         | SaliencyImageObservation<br/>Returns a saliency map highlighting the most attractive areas in the image.                             |
| GenerateForegroundInstanceMaskRequest<br/>Generate a foreground instance mask image.                               | InstanceMaskObservation<br/>Returns the mask of the foreground object.                                               |
| GenerateImageFeaturePrintRequest<br/>Generate an image feature fingerprint for comparison.                         | FeaturePrintObservation<br/>Returns the feature fingerprint data of the image for similarity comparison.                           |
| GenerateObjectnessBasedSaliencyImageRequest<br/>Generate an objectness-based saliency image.                           | SaliencyImageObservation<br/>Returns a saliency map highlighting the salient areas based on objectness.                                   |
| GeneratePersonInstanceMaskRequest<br/>Generate a person instance mask image.                               | InstanceMaskObservation<br/>Returns the mask of the person instance.                                               |
| GeneratePersonSegmentationRequest<br/>Generate a person segmentation image.                                   | SegmentationObservation<br/>Returns a binary image of the person segmentation.                                             |
| RecognizeAnimalsRequest<br/>Detect and identify animals in the image.                             | RecognizedObjectObservation<br/>Returns the type of animal and its confidence level.                                           |
| RecognizeTextRequest<br/>Detect and recognize text in the image.                             | RecognizedTextObservation<br/>Returns the detected text content and its area location.                                 |
| TrackHomographicImageRegistrationRequest<br/>Track the homographic image registration.                             | ImageAlignmentObservation<br/>Returns the homographic transformation matrix between images for alignment.                           |
| TrackObjectRequest<br/>Track objects in the image.                                   | DetectedObjectObservation<br/>Returns the position and speed information of the object in the image.                                 |
| TrackOpticalFlowRequest<br/>Track optical flow in the image.                                   | OpticalFlowObservation<br/>Returns the optical flow vector field to describe pixel movement.                             |
| TrackRectangleRequest<br/>Track rectangles in the image.                                   | RectangleObservation<br/>Returns the position, size, and rotation angle of the rectangle in the image.                           |
| TrackTranslationalImageRegistrationRequest<br/>Track the translational image registration.                             | ImageAlignmentObservation<br/>Returns the translational transformation matrix between images for alignment.                           |

- Prefixing with VN indicates the old API syntax (for versions prior to iOS 18).

The speaker mentioned several commonly used requests, as follows.

#### ClassifyImageRequest

Recognize the input image and obtain classification labels and confidence levels.

![](/assets/755509180ca8/1*8NSQEjxGejujKLbXcILmxQ.jpeg)

![\[Travelogue\] 2024 Second Visit to Kyushu 9-Day Free Trip, Entering via Busan ‚Üí Hakata Cruise](/assets/755509180ca8/1*f1rNoOIQbE33M9F9NmoTXg.png)

\[Travelogue\] 2024 Second Visit to Kyushu 9-Day Free Trip, Entering via Busan ‚Üí Hakata Cruise
```swift
if #available(iOS 18.0, *) {
    // New API using Swift features
    let request = ClassifyImageRequest()
    Task {
        do {
            let observations = try await request.perform(on: URL(string: "https://zhgchg.li/assets/cb65fd5ab770/1*yL3vI1ADzwlovctW5WQgJw.jpeg")!)
            observations.forEach {
                observation in
                print("\(observation.identifier): \(observation.confidence)")
            }
        }
        catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old syntax
    let completionHandler: VNRequestCompletionHandler = {
        request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNClassificationObservation] else {
            return
        }
        observations.forEach {
            observation in
            print("\(observation.identifier): \(observation.confidence)")
        }
    }

    let request = VNClassifyImageRequest(completionHandler: completionHandler)
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: URL(string: "https://zhgchg.li/assets/cb65fd5ab770/1*3_jdrLurFuUfNdW4BJaRww.jpeg")!, options: [:])
        do {
            try handler.perform([request])
        }
        catch {
            print("Request failed: \(error)")
        }
    }
}
```

**Analysis Results:**
```r
 ‚Ä¢ outdoor: 0.75392926
 ‚Ä¢ sky: 0.75392926
 ‚Ä¢ blue_sky: 0.7519531
 ‚Ä¢ machine: 0.6958008
 ‚Ä¢ cloudy: 0.26538086
 ‚Ä¢ structure: 0.15728651
 ‚Ä¢ sign: 0.14224191
 ‚Ä¢ fence: 0.118652344
 ‚Ä¢ banner: 0.0793457
 ‚Ä¢ material: 0.075975396
 ‚Ä¢ plant: 0.054406323
 ‚Ä¢ foliage: 0.05029297
 ‚Ä¢ light: 0.048126098
 ‚Ä¢ lamppost: 0.048095703
 ‚Ä¢ billboards: 0.040039062
 ‚Ä¢ art: 0.03977703
 ‚Ä¢ branch: 0.03930664
 ‚Ä¢ decoration: 0.036868922
 ‚Ä¢ flag: 0.036865234
.... and more
```

#### RecognizeTextRequest

Recognize the text content in the image (a.k.a. image-to-text).

![[\[Travelogue\] 2023 Tokyo 5-Day Free Trip](../9da2c51fa4f2/)](/assets/755509180ca8/1*XL40lLT774PfO60rCIfnxA.jpeg)

[\[Travelogue\] 2023 Tokyo 5-Day Free Trip](../9da2c51fa4f2/)
```swift
if #available(iOS 18.0, *) {
    // New API using Swift features
    var request = RecognizeTextRequest()
    request.recognitionLevel = .accurate
    request.recognitionLanguages = [.init(identifier: "ja-JP"), .init(identifier: "en-US")] // Specify language code, e.g., Traditional Chinese
    Task {
        do {
            let observations = try await request.perform(on: URL(string: "https://zhgchg.li/assets/9da2c51fa4f2/1*fBbNbDepYioQ-3-0XUkF6Q.jpeg")!)
            observations.forEach {
                observation in
                let topCandidate = observation.topCandidates(1).first
                print(topCandidate?.string ?? "No text recognized")
            }
        }
        catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old syntax
    let completionHandler: VNRequestCompletionHandler = {
        request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNRecognizedTextObservation] else {
            return
        }
        observations.forEach {
            observation in
            let topCandidate = observation.topCandidates(1).first
            print(topCandidate?.string ?? "No text recognized")
        }
    }

    let request = VNRecognizeTextRequest(completionHandler: completionHandler)
    request.recognitionLevel = .accurate
    request.recognitionLanguages = ["ja-JP", "en-US"] // Specify language code, e.g., Traditional Chinese
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: URL(string: "https://zhgchg.li/assets/9da2c51fa4f2/1*fBbNbDepYioQ-3-0XUkF6Q.jpeg")!, options: [:])
        do {
            try handler.perform([request])
        }
        catch {
            print("Request failed: \(error)")
        }
    }
}
```

**Analysis Results:**
```makefile
LE LABO ÈùíÂ±±Â∫ó
TEL:03-6419-7167
ÔºäThank you for your purchase*
No: 21347
Date: 2023/06/10 14:14:57
Person in charge:
1690370
Register: 008A 1
Product Name
Tax-inclusive Price Quantity Total Price
Kaiak 10 EDP FB 15ML
J1P7010000S
16,800
16,800
Another 13 EDP FB 15ML
J1PJ010000S
10,700
10,700
Lip Balm 15ML
JOWC010000S
2,000
1
Total Amount
(Tax included)
CARD
2,000
3 items purchased
29,500
0
29,500
29,500
```

#### DetectBarcodesRequest

Detect barcodes and QR code data in the image.

![](/assets/755509180ca8/1*Z72y9rIwIKQCmnnuwsq0uQ.png)

![Recommended by locals in Thailand: Goose Brand Cooling Balm](/assets/755509180ca8/1*s3V1UQRIqto-iG1e30PK7Q.jpeg)

Recommended by locals in Thailand: Goose Brand Cooling Balm
```swift
let filePath = Bundle.main.path(forResource: "IMG_6777", ofType: "png")! // Local test image
let fileURL = URL(filePath: filePath)
if #available(iOS 18.0, *) {
    // New API using Swift features
    let request = DetectBarcodesRequest()
    Task {
        do {
            let observations = try await request.perform(on: fileURL)
            observations.forEach {
                observation in
                print("Payload: \(observation.payloadString ?? "No payload")")
                print("Symbology: \(observation.symbology)")
            }
        }
        catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old syntax
    let completionHandler: VNRequestCompletionHandler = {
        request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNBarcodeObservation] else {
            return
        }
        observations.forEach {
            observation in
            print("Payload: \(observation.payloadStringValue ?? "No payload")")
            print("Symbology: \(observation.symbology.rawValue)")
        }
    }

    let request = VNDetectBarcodesRequest(completionHandler: completionHandler)
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: fileURL, options: [:])
        do {
            try handler.perform([request])
        }
        catch {
            print("Request failed: \(error)")
        }
    }
}
```

**Analysis Results:**
```makefile
Payload: 8859126000911
Symbology: VNBarcodeSymbologyEAN13
Payload: https://lin.ee/hGynbVM
Symbology: VNBarcodeSymbologyQR
Payload: http://www.hongthaipanich.com/
Symbology: VNBarcodeSymbologyQR
Payload: https://www.facebook.com/qr?id=100063856061714
Symbology: VNBarcodeSymbologyQR
```
#### RecognizeAnimalsRequest

Identify animals in the image along with their confidence levels.

![](/assets/755509180ca8/1*5zF3gA3WB1Q0-_cgt6mTCw.png)

![[meme Source](https://www.redbubble.com/i/canvas-print/Funny-AI-Woman-yelling-at-a-cat-meme-design-Machine-learning-by-omolog/43039298.5Y5V7){:target="_blank"}](/assets/755509180ca8/1*KZ7mdE8fobP-_oj7tJf_Ww.jpeg)

[meme Source](https://www.redbubble.com/i/canvas-print/Funny-AI-Woman-yelling-at-a-cat-meme-design-Machine-learning-by-omolog/43039298.5Y5V7){:target="_blank"}

```swift
let filePath = Bundle.main.path(forResource: "IMG_5026", ofType: "png")! // Local test image
let fileURL = URL(filePath: filePath)
if #available(iOS 18.0, *) {
    // New API using Swift features
    let request = RecognizeAnimalsRequest()
    Task {
        do {
            let observations = try await request.perform(on: fileURL)
            observations.forEach { observation in
                let labels = observation.labels
                labels.forEach { label in
                    print("Detected animal: \(label.identifier) with confidence: \(label.confidence)")
                }
            }
        } catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old method
    let completionHandler: VNRequestCompletionHandler = { request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNRecognizedObjectObservation] else {
            return
        }
        observations.forEach { observation in
            let labels = observation.labels
            labels.forEach { label in
                print("Detected animal: \(label.identifier) with confidence: \(label.confidence)")
            }
        }
    }

    let request = VNRecognizeAnimalsRequest(completionHandler: completionHandler)
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: fileURL, options: [:])
        do {
            try handler.perform([request])
        } catch {
            print("Request failed: \(error)")
        }
    }
}
```

**Analysis Results:**
```csharp
Detected animal: Cat with confidence: 0.77245045
```
#### Others:
- Detect humans in images: DetectHumanRectanglesRequest
- Detect poses of humans and animals (both 3D and 2D): DetectAnimalBodyPoseRequest, DetectHumanBodyPose3DRequest, DetectHumanBodyPoseRequest, DetectHumanHandPoseRequest
- Detect and track the motion trajectories of objects (in videos and animations): DetectTrajectoriesRequest, TrackObjectRequest, TrackRectangleRequest

#### **iOS ‚â• 18 Update Highlights:**
```rust
VN*Request -> *Request (e.g. VNDetectBarcodesRequest -> DetectBarcodesRequest)
VN*Observation -> *Observation (e.g. VNRecognizedObjectObservation -> RecognizedObjectObservation)
VNRequestCompletionHandler -> async/await
VNImageRequestHandler.perform([VN*Request]) -> *Request.perform()
```
### WWDC Example

The official WWDC video uses a supermarket product scanner as an example.
#### Most products have barcodes that can be scanned.

![](/assets/755509180ca8/1*YT_Uf8eEi36Iv7zcOrmP4A.png)

![](/assets/755509180ca8/1*J9uIwRKubLoJoC7i096AdQ.png)

![](/assets/755509180ca8/1*gKg-NfHYqy7uBqe5hxzBSw.png)

We can obtain the location of the barcode from `observation.boundingBox`, but unlike the common UIView coordinate system, the `BoundingBox` relative position starts from the bottom left corner, with values ranging from 0 to 1.
```swift
let filePath = Bundle.main.path(forResource: "IMG_6785", ofType: "png")! // Local test image
let fileURL = URL(filePath: filePath)
if #available(iOS 18.0, *) {
    // New API using Swift features
    var request = DetectBarcodesRequest()
    request.symbologies = [.ean13] // Specify to scan only EAN13 Barcode for better performance
    Task {
        do {
            let observations = try await request.perform(on: fileURL)
            if let observation = observations.first {
                DispatchQueue.main.async {
                    self.infoLabel.text = observation.payloadString
                    // Color layer for marking
                    let colorLayer = CALayer()
                    // iOS >=18 new coordinate conversion API toImageCoordinates
                    // Not tested; actual calculations may require adjustments for ContentMode = AspectFit:
                    colorLayer.frame = observation.boundingBox.toImageCoordinates(self.baseImageView.frame.size, origin: .upperLeft)
                    colorLayer.backgroundColor = UIColor.red.withAlphaComponent(0.5).cgColor
                    self.baseImageView.layer.addSublayer(colorLayer)
                }
                print("BoundingBox: \(observation.boundingBox.cgRect)")
                print("Payload: \(observation.payloadString ?? "No payload")")
                print("Symbology: \(observation.symbology)")
            }
        } catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old method
    let completionHandler: VNRequestCompletionHandler = { request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNBarcodeObservation] else {
            return
        }
        if let observation = observations.first {
            DispatchQueue.main.async {
                self.infoLabel.text = observation.payloadStringValue
                // Color layer for marking
                let colorLayer = CALayer()
                colorLayer.frame = self.convertBoundingBox(observation.boundingBox, to: self.baseImageView)
                colorLayer.backgroundColor = UIColor.red.withAlphaComponent(0.5).cgColor
                self.baseImageView.layer.addSublayer(colorLayer)
            }
            print("BoundingBox: \(observation.boundingBox)")
            print("Payload: \(observation.payloadStringValue ?? "No payload")")
            print("Symbology: \(observation.symbology.rawValue)")
        }
    }

    let request = VNDetectBarcodesRequest(completionHandler: completionHandler)
    request.symbologies = [.ean13] // Specify to scan only EAN13 Barcode for better performance
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: fileURL, options: [:])
        do {
            try handler.perform([request])
        } catch {
            print("Request failed: \(error)")
        }
    }
}
```

**iOS ‚â• 18 Update Highlights:**
```less
// iOS >=18 new coordinate conversion API toImageCoordinates
observation.boundingBox.toImageCoordinates(CGSize, origin: .upperLeft)
// https://developer.apple.com/documentation/vision/normalizedpoint/toimagecoordinates(from:imagesize:origin:)
```

**Helper:**
```swift
// Generated by ChatGPT 4o
// Since the photo in the ImageView is set with ContentMode = AspectFit
// We need to calculate the vertical displacement caused by the fit
func convertBoundingBox(_ boundingBox: CGRect, to view: UIImageView) -> CGRect {
    guard let image = view.image else {
        return .zero
    }

    let imageSize = image.size
    let viewSize = view.bounds.size
    let imageRatio = imageSize.width / imageSize.height
    let viewRatio = viewSize.width / viewSize.height
    var scaleFactor: CGFloat
    var offsetX: CGFloat = 0
    var offsetY: CGFloat = 0
    if imageRatio > viewRatio {
        // Image fits in width
        scaleFactor = viewSize.width / imageSize.width
        offsetY = (viewSize.height - imageSize.height * scaleFactor) / 2
    } else {
        // Image fits in height
        scaleFactor = viewSize.height / imageSize.height
        offsetX = (viewSize.width - imageSize.width * scaleFactor) / 2
    }

    let x = boundingBox.minX * imageSize.width * scaleFactor + offsetX
    let y = (1 - boundingBox.maxY) * imageSize.height * scaleFactor + offsetY
    let width = boundingBox.width * imageSize.width * scaleFactor
    let height = boundingBox.height * imageSize.height * scaleFactor
    return CGRect(x: x, y: y, width: width, height: height)
}
```

**Output Results**
```makefile
BoundingBox: (0.5295758928571429, 0.21408638121589782, 0.0943080357142857, 0.21254415360708087)
Payload: 4710018183805
Symbology: VNBarcodeSymbologyEAN13
```
#### Some products do not have barcodes, such as bulk fruits that only have product labels.

![](/assets/755509180ca8/1*jeZhLtg9j11kgOAvKZmevg.jpeg)

![](/assets/755509180ca8/1*YNokMMUewMA2kzjoGmMJPw.png)

Therefore, our scanner also needs to support scanning plain text labels.
```swift
let filePath = Bundle.main.path(forResource: "apple", ofType: "jpg")! // Local test image
let fileURL = URL(filePath: filePath)
if #available(iOS 18.0, *) {
    // New API using Swift features
    var barcodesRequest = DetectBarcodesRequest()
    barcodesRequest.symbologies = [.ean13] // Specify to scan only EAN13 Barcode for better performance
    var textRequest = RecognizeTextRequest()
    textRequest.recognitionLanguages = [.init(identifier: "zh-Hnat"), .init(identifier: "en-US")]
    Task {
        do {
            let handler = ImageRequestHandler(fileURL)
            // Parameter pack syntax; we must wait for all requests to finish before using their results.
            // let (barcodesObservation, textObservation, ...) = try await handler.perform(barcodesRequest, textRequest, ...)
            let (barcodesObservation, textObservation) = try await handler.perform(barcodesRequest, textRequest)
            if let observation = barcodesObservation.first {
                DispatchQueue.main.async {
                    self.infoLabel.text = observation.payloadString
                    // Color layer for marking
                    let colorLayer = CALayer()
                    // iOS >=18 new coordinate conversion API toImageCoordinates
                    // Not tested; actual calculations may require adjustments for ContentMode = AspectFit:
                    colorLayer.frame = observation.boundingBox.toImageCoordinates(self.baseImageView.frame.size, origin: .upperLeft)
                    colorLayer.backgroundColor = UIColor.red.withAlphaComponent(0.5).cgColor
                    self.baseImageView.layer.addSublayer(colorLayer)
                }
                print("BoundingBox: \(observation.boundingBox.cgRect)")
                print("Payload: \(observation.payloadString ?? "No payload")")
                print("Symbology: \(observation.symbology)")
            }
            textObservation.forEach { observation in
                let topCandidate = observation.topCandidates(1).first
                print(topCandidate?.string ?? "No text recognized")
            }
        } catch {
            print("Request failed: \(error)")
        }
    }
} else {
    // Old method
    let barcodesCompletionHandler: VNRequestCompletionHandler = { request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNBarcodeObservation] else {
            return
        }
        if let observation = observations.first {
            DispatchQueue.main.async {
                self.infoLabel.text = observation.payloadStringValue
                // Color layer for marking
                let colorLayer = CALayer()
                colorLayer.frame = self.convertBoundingBox(observation.boundingBox, to: self.baseImageView)
                colorLayer.backgroundColor = UIColor.red.withAlphaComponent(0.5).cgColor
                self.baseImageView.layer.addSublayer(colorLayer)
            }
            print("BoundingBox: \(observation.boundingBox)")
            print("Payload: \(observation.payloadStringValue ?? "No payload")")
            print("Symbology: \(observation.symbology.rawValue)")
        }
    }

    let textCompletionHandler: VNRequestCompletionHandler = { request, error in
        guard error == nil else {
            print("Request failed: \(String(describing: error))")
            return
        }
        guard let observations = request.results as? [VNRecognizedTextObservation] else {
            return
        }
        observations.forEach { observation in
            let topCandidate = observation.topCandidates(1).first
            print(topCandidate?.string ?? "No text recognized")
        }
    }

    let barcodesRequest = VNDetectBarcodesRequest(completionHandler: barcodesCompletionHandler)
    barcodesRequest.symbologies = [.ean13] // Specify to scan only EAN13 Barcode for better performance
    let textRequest = VNRecognizeTextRequest(completionHandler: textCompletionHandler)
    textRequest.recognitionLevel = .accurate
    textRequest.recognitionLanguages = ["en-US"]
    DispatchQueue.global().async {
        let handler = VNImageRequestHandler(url: fileURL, options: [:])
        do {
            try handler.perform([barcodesRequest, textRequest])
        } catch {
            print("Request failed: \(error)")
        }
    }
}
```

**Output Results:**
```
94128s
ORGANIC
Pink Lady¬Æ
Produce of USh
```

**iOS ‚â• 18 Update Highlights:**
```swift
let handler = ImageRequestHandler(fileURL)
// Parameter pack syntax; we must wait for all requests to finish before using their results.
// let (barcodesObservation, textObservation, ...) = try await handler.perform(barcodesRequest, textRequest, ...)
let (barcodesObservation, textObservation) = try await handler.perform(barcodesRequest, textRequest)
```
#### iOS ‚â• 18 [performAll()](https://developer.apple.com/documentation/vision/imagerequesthandler/performall(_:)?changes=latest_minor){:target="_blank"} Method

![](/assets/755509180ca8/1*z0364eYD4F4On194EgQ1kQ.png)

The previous `perform(barcodesRequest, textRequest)` method requires waiting for both requests to complete before proceeding; starting with iOS 18, a new `performAll()` method is provided, allowing for streaming responses. You can handle results as soon as one of the requests is completed, such as responding immediately upon scanning a barcode.
```swift
if #available(iOS 18.0, *) {
    // New API using Swift features
    var barcodesRequest = DetectBarcodesRequest()
    barcodesRequest.symbologies = [.ean13] // Specify to scan only EAN13 Barcode for better performance
    var textRequest = RecognizeTextRequest()
    textRequest.recognitionLanguages = [.init(identifier: "zh-Hnat"), .init(identifier: "en-US")]
    Task {
        let handler = ImageRequestHandler(fileURL)
        let observation = handler.performAll([barcodesRequest, textRequest] as [any VisionRequest])
        for try await result in observation {
            switch result {
                case .detectBarcodes(_, let barcodesObservation):
                    if let observation = barcodesObservation.first {
                        DispatchQueue.main.async {
                            self.infoLabel.text = observation.payloadString
                            // Color layer for marking
                            let colorLayer = CALayer()
                            // iOS >=18 new coordinate conversion API toImageCoordinates
                            // Not tested; actual calculations may require adjustments for ContentMode = AspectFit:
                            colorLayer.frame = observation.boundingBox.toImageCoordinates(self.baseImageView.frame.size, origin: .upperLeft)
                            colorLayer.backgroundColor = UIColor.red.withAlphaComponent(0.5).cgColor
                            self.baseImageView.layer.addSublayer(colorLayer)
                        }
                        print("BoundingBox: \(observation.boundingBox.cgRect)")
                        print("Payload: \(observation.payloadString ?? "No payload")")
                        print("Symbology: \(observation.symbology)")
                    }
                case .recognizeText(_, let textObservation):
                    textObservation.forEach { observation in
                        let topCandidate = observation.topCandidates(1).first
                        print(topCandidate?.string ?? "No text recognized")
                    }
                default:
                    print("Unrecognized result: \(result)")
            }
        }
    }
}
```
### Optimize with Swift Concurrency

![](/assets/755509180ca8/1*LgxxMOVS6is3n6EqPWqA6Q.png)

![](/assets/755509180ca8/1*80CFJpkb-gjy3bJs4jAC2A.png)

Assuming we have a list of image thumbnails, where each image needs to be automatically cropped to focus on the main subject, we can effectively utilize Swift Concurrency to enhance loading efficiency.

#### **Original Implementation**
```swift
func generateThumbnail(url: URL) async throws -> UIImage {
  let request = GenerateAttentionBasedSaliencyImageRequest()
  let saliencyObservation = try await request.perform(on: url)
  return cropImage(url, to: saliencyObservation.salientObjects)
}
    
func generateAllThumbnails() async throws {
  for image in images {
    image.thumbnail = try await generateThumbnail(url: image.url)
  }
}
```

This approach processes one image at a time, resulting in slow efficiency and performance.

#### **Optimization (1) ‚Äî TaskGroup Concurrency**
```swift
func generateAllThumbnails() async throws {
  try await withThrowingDiscardingTaskGroup { taskGroup in
    for image in images {
      image.thumbnail = try await generateThumbnail(url: image.url)
    }
  }
}
```

Here, each task is added to a TaskGroup for concurrent execution.

> **_Note: Image recognition and cropping operations are very memory-intensive. If too many concurrent tasks are initiated without restraint, it may lead to user lag or out-of-memory (OOM) crashes._**

#### **Optimization (2) ‚Äî TaskGroup Concurrency + Limiting Concurrent Tasks**
```swift
func generateAllThumbnails() async throws {
    try await withThrowingDiscardingTaskGroup { taskGroup in
        // Limit the maximum number of concurrent tasks to 5
        let maxImageTasks = min(5, images.count)
        // Initially fill 5 tasks
        for index in 0..<maxImageTasks {
            taskGroup.addTask {
                images[index].thumbnail = try await generateThumbnail(url: images[index].url)
            }
        }
        var nextIndex = maxImageTasks
        for try await _ in taskGroup {
            // When a task in the taskGroup completes...
            // Check if we've reached the end of the index
            if nextIndex < images.count {
                let image = images[nextIndex]
                // Continue adding tasks (keeping the limit at 5)
                taskGroup.addTask {
                    image.thumbnail = try await generateThumbnail(url: image.url)
                }
                nextIndex += 1
            }
        }
    }
}
```

### Update an Existing Vision App

![](/assets/755509180ca8/1*0OhzcxQ7OpSujeyvt9918Q.png)

![](/assets/755509180ca8/1*MH4Xa0RB2DZQ1Fl9-kItSw.png)

1. Vision will remove CPU and GPU support for certain requests on devices equipped with a Neural Engine. On these devices, the Neural Engine is the optimal choice for performance. You can check this using the `supportedComputeDevices()` API.
2. Remove all VN prefixes: `VNXXRequest`, `VNXXXObservation` ‚Üí `Request`, `Observation`.
3. Use async/await instead of the original VNRequestCompletionHandler.
4. Directly use `*Request.perform()` instead of the original `VNImageRequestHandler.perform([VN*Request])`.

### Wrap-Up
- APIs designed with new Swift language features.
- New functionalities and methods are Swift-only, available for iOS ‚â• 18.
- New image scoring features, body and hand motion tracking.

### Thanks!

![](/assets/755509180ca8/1*BK_5eH1i4-drOUOGnuQRSg.png)

### KKday Recruitment

![](/assets/755509180ca8/1*kjcldhvCP1cM-QqDfRFaYg.png)

üëâüëâüëâ This sharing session originates from the weekly technical sharing activities of the KKday App Team. **The team is currently actively recruiting [Senior iOS Engineers](https://kkday.bamboohr.com/careers/25?source=aWQ9Mjk%3D){:target="_blank"}. Interested candidates are welcome to submit their resumes.** üëàüëàüëà

#### References
#### [Discover Swift enhancements in the Vision framework](https://developer.apple.com/videos/play/wwdc2024/10163/){:target="_blank"}

The Vision Framework API has been redesigned to leverage modern Swift features like concurrency, making it easier and faster to integrate a wide array of Vision algorithms into your app. We‚Äôll tour the updated API and share sample code, along with best practices, to help you get the benefits of this framework with less coding effort. We‚Äôll also demonstrate two new features: image aesthetics and holistic body pose.

### Chapters
- 0:00 ‚Äî [Introduction](https://developer.apple.com/videos/play/wwdc2024/10163/?time=0){:target="_blank"}
- 1:07 ‚Äî [New Vision API](https://developer.apple.com/videos/play/wwdc2024/10163/?time=67){:target="_blank"}
- 1:47 ‚Äî [Get started with Vision](https://developer.apple.com/videos/play/wwdc2024/10163/?time=107){:target="_blank"}
- 8:59 ‚Äî [Optimize with Swift Concurrency](https://developer.apple.com/videos/play/wwdc2024/10163/?time=539){:target="_blank"}
- 11:05 ‚Äî [Update an existing Vision app](https://developer.apple.com/videos/play/wwdc2024/10163/?time=665){:target="_blank"}
- 13:46 ‚Äî [What‚Äôs new in Vision?](https://developer.apple.com/videos/play/wwdc2024/10163/?time=826){:target="_blank"}

#### [Vision framework Apple Developer Documentation](https://developer.apple.com/documentation/vision/){:target="_blank"}

If you have any questions or feedback, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.

_[Post](https://medium.com/kkdaytech/ios-vision-framework-x-wwdc-24-discover-swift-enhancements-in-the-vision-framework-session-755509180ca8){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._