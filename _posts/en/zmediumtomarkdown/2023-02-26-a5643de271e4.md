---
title: "ZMarkupParser HTML String to NSAttributedString Tool"
author: "ZhgChgLi"
date: 2023-02-26T09:03:07.570+0000
last_modified_at: 2023-08-05T16:16:21.987+0000
categories: ["ZRealm Dev."]
tags: ["html-parser","nsattributedstring","ios-app-development","html","markdown"]
description: "Convert HTML String to corresponding Key style settings for NSAttributedString"
image:
  path: /assets/a5643de271e4/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg
render_with_liquid: false
---

### ZMarkupParser HTML String to NSAttributedString Tool

Convert HTML String to corresponding Key style settings for NSAttributedString

#### [ZhgChgLi](https://github.com/ZhgChgLi){:target="_blank"} / [ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target="_blank"}


![[ZhgChgLi](https://github.com/ZhgChgLi){:target="_blank"} / [ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target="_blank"}](/assets/a5643de271e4/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg)

[ZhgChgLi](https://github.com/ZhgChgLi){:target="_blank"} / [ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target="_blank"}


[![](https://repository-images.githubusercontent.com/602927147/57ce75c1-8548-449c-b44a-f4b0451ed5ea)](https://github.com/ZhgChgLi/ZMarkupParser){:target="_blank"}

#### Features
- Developed entirely in Swift, it parses HTML tags using Regex and performs tokenization, analyzing and correcting tag validity (fixing unclosed tags & misaligned tags), then converts to an abstract syntax tree, ultimately using the Visitor Pattern to map HTML tags to abstract styles, resulting in the final NSAttributedString; it does not rely on any parser libraries.
- Supports HTML rendering (to NSAttributedString) / Stripper (removing HTML tags) / Selector functionality.
- Automatically analyzes and corrects tag validity (fixing unclosed tags & misaligned tags).
`<br>` \-&gt; `<br/>` 
`<b>Bold<i>Bold+Italic</b>Italic</i>` \-&gt; `<b>Bold<i>Bold+Italic</i></b><i>Italic</i>` 
`<Congratulation!>` \-&gt; `<Congratulation!>` (treat as String)
- Supports customizable style specifications.
e\.g\. `<b></b>` \-&gt; `weight: .semibold & underline: 1`
- Supports custom HTML tag parsing.
e\.g\. parse `<zhgchgli></zhgchgli>` to desired styles.
- Includes architectural design for easy expansion of HTML tag support.
Currently, it supports basic styles as well as rendering of ul/ol/li lists and hr separators, with plans to quickly support additional HTML tags in the future.
- Supports style parsing from `style` HTML attributes.
HTML can specify text styles through style attributes; similarly, this package can support styles specified in `style`.
e\.g\. `<b style=”font-size: 20px”></b>` \-&gt; `Bold + font size 20 px`
- Supports iOS/macOS.
- Supports HTML Color Name to UIColor/NSColor.
- Test Coverage: 80%+
- Supports `<img>` images, `<ul>` item lists, `<table>` tables, and other HTML tag parsing.
- Higher performance than `NSAttributedString.DocumentType.html`.

#### Performance Analysis


![[Performance Benchmark](https://quickchart.io/chart-maker/view/zm-73887470-e667-4ca3-8df0-fe3563832b0b){:target="_blank"}](/assets/a5643de271e4/1*UPkmp2XsUjlVe_TmOur_3A.png)

[Performance Benchmark](https://quickchart.io/chart-maker/view/zm-73887470-e667-4ca3-8df0-fe3563832b0b){:target="_blank"}
- Test Environment: 2022/M2/24GB Memory/macOS 13\.2/XCode 14\.1
- X Axis: HTML Character Count
- Y Axis: Time Taken for Rendering (seconds)


\*Additionally, `NSAttributedString.DocumentType.html` will crash (EXC\_BAD\_ACCESS) for strings longer than 54,600\+ characters.
#### Try It Out


![](/assets/a5643de271e4/1*PzYcnSkW7qKeJBkaiNTKjQ.gif)


You can directly download the project, open `ZMarkupParser.xcworkspace`, select the `ZMarkupParser-Demo` Target, and Build & Run to test the effects directly.
#### Installation

Supports SPM/Cocoapods, please refer to [Readme](https://github.com/ZhgChgLi/ZMarkupParser#installation){:target="_blank"}.
### Usage
#### Style Declaration

MarkupStyle/MarkupStyleColor/MarkupStyleParagraphStyle, corresponding to NSAttributedString\.Key encapsulations.
```swift
var font:MarkupStyleFont
var paragraphStyle:MarkupStyleParagraphStyle
var foregroundColor:MarkupStyleColor? = nil
var backgroundColor:MarkupStyleColor? = nil
var ligature:NSNumber? = nil
var kern:NSNumber? = nil
var tracking:NSNumber? = nil
var strikethroughStyle:NSUnderlineStyle? = nil
var underlineStyle:NSUnderlineStyle? = nil
var strokeColor:MarkupStyleColor? = nil
var strokeWidth:NSNumber? = nil
var shadow:NSShadow? = nil
var textEffect:String? = nil
var attachment:NSTextAttachment? = nil
var link:URL? = nil
var baselineOffset:NSNumber? = nil
var underlineColor:MarkupStyleColor? = nil
var strikethroughColor:MarkupStyleColor? = nil
var obliqueness:NSNumber? = nil
var expansion:NSNumber? = nil
var writingDirection:NSNumber? = nil
var verticalGlyphForm:NSNumber? = nil
...
```

You can declare styles to apply to HTML Tags as you wish:
```swift
let myStyle = MarkupStyle(font: MarkupStyleFont(size: 13), backgroundColor: MarkupStyleColor(name: .aquamarine))
```
#### HTML Tag

Declare the HTML Tags to be rendered and their corresponding Markup Styles. The currently predefined HTML Tag Names are as follows:
```
A_HTMLTagName(), // <a></a>
B_HTMLTagName(), // <b></b>
BR_HTMLTagName(), // <br></br>
DIV_HTMLTagName(), // <div></div>
HR_HTMLTagName(), // <hr></hr>
I_HTMLTagName(), // <i></i>
LI_HTMLTagName(), // <li></li>
OL_HTMLTagName(), // <ol></ol>
P_HTMLTagName(), // <p></p>
SPAN_HTMLTagName(), // <span></span>
STRONG_HTMLTagName(), // <strong></strong>
U_HTMLTagName(), // <u></u>
UL_HTMLTagName(), // <ul></ul>
DEL_HTMLTagName(), // <del></del>
IMG_HTMLTagName(handler: ZNSTextAttachmentHandler), // <img> and image downloader
TR_HTMLTagName(), // <tr>
TD_HTMLTagName(), // <td>
TH_HTMLTagName(), // <th>
...and more
...
```


This way, when parsing the `<a>` tag, the specified MarkupStyle will be applied.

Extending HTMLTagName:
```swift
let zhgchgli = ExtendTagName("zhgchgli")
```
#### HTML Style Attribute

As mentioned earlier, HTML supports specifying styles from the Style Attribute. Here, we also abstract the supported styles and extensions. The currently predefined HTML Style Attributes are as follows:
```swift
ColorHTMLTagStyleAttribute(), // color
BackgroundColorHTMLTagStyleAttribute(), // background-color
FontSizeHTMLTagStyleAttribute(), // font-size
FontWeightHTMLTagStyleAttribute(), // font-weight
LineHeightHTMLTagStyleAttribute(), // line-height
WordSpacingHTMLTagStyleAttribute(), // word-spacing
...
```

Extending Style Attribute:
```swift
ExtendHTMLTagStyleAttribute(styleName: "text-decoration", render: { value in
  var newStyle = MarkupStyle()
  if value == "underline" {
    newStyle.underline = NSUnderlineStyle.single
  } else {
    // ...  
  }
  return newStyle
})
```
### Usage
```swift
import ZMarkupParser

let parser = ZHTMLParserBuilder.initWithDefault().set(rootStyle: MarkupStyle(font: MarkupStyleFont(size: 13)).build()
```

`initWithDefault` will automatically add the predefined HTML Tag Names, the default corresponding MarkupStyles, and the predefined Style Attributes.

`set(rootStyle:)` can specify the default style for the entire string, or it can be left unspecified.
#### Customization
```swift
let parser = ZHTMLParserBuilder.initWithDefault().add(ExtendTagName("zhgchgli"), withCustomStyle: MarkupStyle(backgroundColor: MarkupStyleColor(name: .aquamarine))).build() // will use the markup style you specify to render the extended HTML tag <zhgchgli></zhgchgli>
let parser = ZHTMLParserBuilder.initWithDefault().add(B_HTMLTagName(), withCustomStyle: MarkupStyle(font: MarkupStyleFont(size: 18, weight: .style(.semibold)))).build() // will use the markup style you specify to render <b></b> instead of the default bold markup style
```
#### HTML Render
```swift
let attributedString = parser.render(htmlString) // NSAttributedString

// work with UITextView
textView.setHtmlString(htmlString)
// work with UILabel
label.setHtmlString(htmlString)
```
#### HTML Stripper
```swift
parser.stripper(htmlString)
```
#### Selector HTML String
```swift
let selector = parser.selector(htmlString) // HTMLSelector e.g. input: <a><b>Test</b>Link</a>
selector.first("a")?.first("b").attributedString // will return Test
selector.filter("a").attributedString // will return Test Link

// render from selector result
let selector = parser.selector(htmlString) // HTMLSelector e.g. input: <a><b>Test</b>Link</a>
parser.render(selector.first("a")?.first("b"))
```
#### Async


Additionally, if you want to render long strings, you can use async methods to prevent UI blocking.
```swift
parser.render(String) { _ in }...
parser.stripper(String) { _ in }...
parser.selector(String) { _ in }...
```
### Know-how
- The hyperlink style in UITextView is determined by linkTextAttributes, which can lead to situations where NSAttributedString.key is set but does not appear to take effect.
- UILabel does not support specifying URL styles, so there can be cases where NSAttributedString.key is set but does not appear to take effect.
- If you need to render complex HTML, you still need to use WKWebView (including JS/tables... rendering).

#### Technical Principles and Development Story: "[The Things About Manually Creating an HTML Parser](../2724f02f6e7/)"
### Contributions and Issues are welcome and will be addressed promptly.


[![](https://repository-images.githubusercontent.com/602927147/57ce75c1-8548-449c-b44a-f4b0451ed5ea)](https://github.com/ZhgChgLi/ZMarkupParser){:target="_blank"}



If you have any questions or suggestions, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.



_[Post](https://medium.com/zrealm-ios-dev/zmarkupparser-html-string-%E8%BD%89%E6%8F%9B-nsattributedstring-%E5%B7%A5%E5%85%B7-a5643de271e4){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
