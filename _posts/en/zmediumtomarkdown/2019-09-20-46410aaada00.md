---
title: "The APP Uses HTTPS for Transmission, Yet Data Still Gets Stolen."
author: "ZhgChgLi"
date: 2019-09-20T10:01:01.345+0000
last_modified_at: 2024-04-13T07:56:08.893+0000
categories: ["ZRealm Dev."]
tags: ["mitmproxy","man-in-the-middle","ios","ios-app-development","hacking"]
description: "Using mitmproxy for man-in-the-middle attacks to sniff API transmission data on iOS and MacOS."
image:
  path: /assets/46410aaada00/1*VTtl6EUMOTV4oRNUjRQHNg.png
render_with_liquid: false
---

### The APP Uses HTTPS for Transmission, Yet Data Still Gets Stolen.

How to use mitmproxy on iOS and MacOS for man-in-the-middle attacks to sniff API transmission data and how to prevent it?

### Introduction

Recently, I just wrapped up an internal [CTF competition](../729d7b6817a4/) at the company. While brainstorming topics, I recalled a project I handled back in college when I was working on the backend (PHP) — a point collection APP. It had a task list, and upon completing the trigger conditions, it would call an API to earn points. The boss believed that calling the API with HTTPS encryption made the data transmission secure — until I demonstrated a man-in-the-middle attack, directly sniffing the transmitted data and forging API calls to earn points...

Moreover, with the rise of big data in recent years, web crawlers are everywhere; the battle between crawlers and defenses has become increasingly intense, with [tricks emerging between crawling and anti-crawling](https://coolcao.com/2018/06/09/tips-of-anti-spider-in-fe/){:target="_blank"}. It can only be said that as the skills improve, so do the countermeasures!

Another target for crawlers is the APP's API. If there are no defenses in place, it is almost like leaving the door wide open; it is not only easy to operate but also has a clean format, making it harder to identify and block. Therefore, if the web side has already exhausted all efforts to block access, yet data is still being crawled, it might be worth checking if there are any vulnerabilities in the APP's API.

Since I wasn't sure how to present this topic in the CTF competition, I decided to write an article as a record; this piece is just a basic introduction — [HTTPS can decrypt transmitted content through certificate replacement](http://www.aqee.net/post/man-in-the-middle-attack.html){:target="_blank"}, and how to enhance security to prevent it. The actual network theory is not my strong suit, and I've already returned it to the teacher. If you already have a grasp of this concept, there's no need to spend time reading this article, or you can scroll down to see how to protect the APP!

### Practical Operation

Environment: MacOS + iOS

> _Android users can directly download [Packet Capture](https://play.google.com/store/apps/details?id=app.greyshirts.sslcapture&hl=en){:target="_blank"} (free), while iOS users can use [Surge 4](https://apps.apple.com/us/app/surge-3/id1442620678){:target="_blank"} ( **paid** ) to unlock man-in-the-middle attack features. MacOS users can also use another paid software, Charles._ 

> _This article mainly explains how to use the **free** mitmproxy on iOS. If you have the above environment, you don't need to go through all this hassle; just open the APP on your phone and mount the VPN to replace the certificate to perform a man-in-the-middle attack! (Again, please scroll down to see how to protect it!)_

**\[2021/02/25 Update\]:** There is a new free graphical interface program for Mac called \( [Proxyman](https://proxyman.io/){:target="_blank"} \) that can be used, along with [this article](../70a1409b149a/) for reference in the first part.

#### Install [mitmproxy](https://mitmproxy.org){:target="_blank"}

**Install directly using brew**:
```bash
brew install mitmproxy
```

**Installation complete!**

_p.s If you encounter brew: command not found, please install the [brew](https://brew.sh/index_zh-tw){:target="_blank"} package management tool first_:
```bash
/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
```
#### Using mitmproxy


After installation, enter the following command in the Terminal to activate:
```bash
mitmproxy
```


![Startup Successful](/assets/46410aaada00/1*VTtl6EUMOTV4oRNUjRQHNg.png)

Startup Successful
#### Ensure the phone and Mac are on the same local network & obtain the Mac's IP address

Method (1) Mac connects to WiFi, and the phone also uses the same WiFi
**Mac's IP address =** "System Preferences" -> "Network" -> "Wi-Fi" -> "IP Address"

Method (2) Mac uses a wired connection, enabling internet sharing; the phone connects to that hotspot:


![“System Preferences” -> “Sharing” -> Select “Ethernet” -> Check “Wi-Fi” -> Enable “Internet Sharing”](/assets/46410aaada00/1*R9fthpHlrWzTh4R3fEwO5Q.gif)

“System Preferences” -> “Sharing” -> Select “Ethernet” -> Check “Wi-Fi” -> Enable “Internet Sharing”

**Mac's IP address = 192.168.2.1** (⚠️ Note: This is not the Ethernet network's IP, but the IP used by the Mac for internet sharing.)
#### Phone Network Settings WiFi — Proxy Server Information


![“Settings” -> “WiFi” -> “HTTP Proxy” -> “Manual” -> “Enter **Mac's IP address**” -> “Enter **8080**” -> “Save”](/assets/46410aaada00/1*ziIFrGQaMr2kYrQHwLYNJg.jpeg)

“Settings” -> “WiFi” -> “HTTP Proxy” -> “Manual” -> “Enter **Mac's IP address**” -> “Enter **8080**” -> “Save”


> _At this point, if the webpage cannot be opened and a certificate error appears, it is normal; let's continue..._ 




#### Install mitmproxy Custom HTTPS Certificate

As mentioned above, the implementation of a man-in-the-middle attack involves using one's own certificate to intercept and decrypt data during communication; therefore, we also need to install this custom certificate on the phone.

**1. Open [http://mitm.it](http://mitm.it){:target="_blank"} using Safari on the phone**


![Left side shows Proxy settings ✅ / Right side indicates Proxy settings are incorrect 🚫](/assets/46410aaada00/1*BuvCYx9WRzG0ECO3H_BS0A.jpeg)

Left side shows Proxy settings ✅ / Right side indicates Proxy settings are incorrect 🚫


![“Apple” -> “Install Profile” -> “Install”](/assets/46410aaada00/1*qKDHxi9HxUP41oDJahBfBA.jpeg)

“Apple” -> “Install Profile” -> “Install”


> _⚠️ We're not done yet; we still need to enable the profile in settings_ 






![“General” -> “About” -> “Certificate Trust Settings” -> Enable “mitmproxy”](/assets/46410aaada00/1*mOijblpQepazFPIwob4r8Q.jpeg)

“General” -> “About” -> “Certificate Trust Settings” -> Enable “mitmproxy”

**Done! Now we can return to the browser and browse the web normally.**
#### Return to Mac to operate mitmproxy


![You can see the data transmission records from the phone on the mitmproxy Terminal](/assets/46410aaada00/1*kiEPaTm5bhnFLBfQngQPgA.png)

You can see the data transmission records from the phone on the mitmproxy Terminal


![Find the record you want to sniff and enter to view Request (what parameters were sent) / Response (what content was returned)](/assets/46410aaada00/1*5I6l9cO3LeXfcwGLpWGKPQ.gif)

Find the record you want to sniff and enter to view Request (what parameters were sent) / Response (what content was returned)
#### Common Operation Key Set:
```plaintext
「 ? 」= View key operation documentation
「 k 」/「⬆」= Up 
「 j 」/「⬇」= Down 
「 h 」/「⬅」= Left 
「 l 」/「➡️」️= Right 
「 space 」= Next page
「 enter 」= Enter to view details
「 q 」= Return to the previous page/exit
「 b 」= Export response body to specified path text file 
「 f 」= Filter record conditions
「 z 」= Clear all records
「 e 」= Edit Request (cookie, headers, params...)
「 r 」= Resend Request
```
#### Not used to CLI? No problem, you can switch to Web GUI!

```markdown
In addition to the way to enable mitmproxy, we can change it to:
```bash
mitmweb
```

This allows us to use the new Web GUI for operations and observations.


![mitmweb](/assets/46410aaada00/1*Stbf8gUk8iXwNkozOKyOjA.png)

mitmweb
#### The main event, sniffing APP data:

Once the above environment is set up and familiar, we can enter our main event; sniffing the data transmission content of the APP API!


> _Here we take a certain housing APP as an example, with no malicious intent, purely for academic exchange!_ 





> _We want to know how the API for the object list is requested and what content is returned!_ 





![First, press "z" to clear all records (to avoid confusion)](/assets/46410aaada00/1*HKppSomeMK5U3Z0kbaRvkQ.png)

First, press "z" to clear all records (to avoid confusion)


![Open the target APP](/assets/46410aaada00/1*mpNLXzUwb7-jiikrHkoTcA.png)

Open the target APP

Open the target APP and try to perform a "pull to refresh" or trigger the "load next page" action.


> **_🛑If your target APP cannot be opened or connected; then sorry, it means the APP has implemented protections that prevent sniffing. Please scroll down to the section on how to protect yourself🛑_** 






![mitmproxy records](/assets/46410aaada00/1*KOkJugn95bcUCPl-dZEaRA.png)

mitmproxy records

Return to mitmproxy to check the records, channel your inner detective to guess which API request record is what we want and enter to view the details!


![Request](/assets/46410aaada00/1*n6mUgej-2_U8PRUbQo_j1g.png)

Request

In the Request section, you can see what parameters were passed in the request.

With "e" to edit and "r" to resend, and by observing the Response, you can guess the purpose of each parameter!


![Response](/assets/46410aaada00/1*zxdLiXMP-KapoEYou_TlZg.png)

Response

The Response can also directly obtain the original returned content.


> **_🛑If the Response content is a bunch of encoded data; then sorry, it means the APP may have its own encryption and decryption, making it impossible to sniff using this method. Please scroll down to the section on how to protect yourself🛑_** 





Hard to read? Chinese garbled text? No worries, you can use "b" to export it as a text file to your desktop, then copy the content to [Json Editor Online](https://jsoneditoronline.org/){:target="_blank"} for parsing!


![](/assets/46410aaada00/1*7qOTLAIQHH6V782OnvFVFQ.png)



> **_\*Or directly use mitmweb to browse and operate through the web GUI_** 






![mitmweb](/assets/46410aaada00/1*ujOlDBdjp8tECeAwRzWRPw.png)

mitmweb

After sniffing, observing, filtering, and testing, you will understand how the APP API operates, allowing you to utilize it for data scraping.


> _\*After collecting the necessary information, remember to close mitmproxy and revert the mobile network Proxy settings back to automatic to use the internet normally._ 




### How should the APP protect itself?

If you find that the APP cannot be used or the returned content is encoded after attaching mitmproxy, it means the APP has implemented protections.

**Method (1):**

Generally, it involves placing a copy of the certificate information in the APP. If the current HTTPS certificate used does not match the information in the APP, access will be denied. For details, you can [see this](https://www.anquanke.com/post/id/147090){:target="_blank"} or look for resources related to [SSL Pinning](https://medium.com/@dzungnguyen.hcm/ios-ssl-pinning-bffd2ee9efc){:target="_blank"}. The downside may be the need to pay attention to the certificate's validity period!


![[https://medium\.com/@dzungnguyen\.hcm/ios\-ssl\-pinning\-bffd2ee9efc](https://medium.com/@dzungnguyen.hcm/ios-ssl-pinning-bffd2ee9efc){:target="_blank"}](/assets/46410aaada00/1*31rODDIlYPidTP3L8W_C7A.jpeg)

[https://medium\.com/@dzungnguyen\.hcm/ios\-ssl\-pinning\-bffd2ee9efc](https://medium.com/@dzungnguyen.hcm/ios-ssl-pinning-bffd2ee9efc){:target="_blank"}
```

```markdown
**Method (2):**

The app side performs encoding and encryption before transmitting data, and the API backend decrypts it to obtain the original request content; the API response content is also encoded and encrypted first, and the app side decrypts it to obtain the returned content. This process is cumbersome and resource-intensive, but it is indeed a method; as far as I know, a certain digital bank seems to use this trick for protection!

#### However...

Method 1 still has a way to be cracked: [How to Bypass SSL Pinning on iOS 12](https://www.anquanke.com/post/id/179514){:target="_blank"}

Method 2 can also obtain the keys used for encoding and encryption through reverse engineering.

**⚠️ There is no 100% security ⚠️**

`Or simply dig a hole for it to crawl in, collecting various evidence along the way, and then resolve it legally (？`
#### Still the same saying:

> "NEVER TRUST THE CLIENT"

### More Ways to Use mitmproxy:

**1. Using mitmdump**

In addition to `mitmproxy` and `mitmweb`, `mitmdump` can directly export all records to a text file.
```bash
mitmdump -w /log.txt
```

And it can use **Method (2)** python program to set and filter traffic:
```bash
mitmdump -ns examples/filter.py -r /log.txt -w /result.txt
```

**2. Combine with Python program for request parameter settings, access control, and redirection:**
```python
from mitmproxy import http

def request(flow: http.HTTPFlow) -> None:
    # pretty_host takes the "Host" header of the request into account,
    # which is useful in transparent mode where we usually only have the IP
    # otherwise.
    
    # Request parameter setting Example:
    flow.request.headers['User-Agent'] = 'MitmProxy'
    
    if flow.request.pretty_host == "123.com.tw":
        flow.request.host = "456.com.tw"
    # Redirect all visits from 123.com.tw to 456.com.tw
```

Redirection example

Add parameters when enabling mitmproxy:
```
mitmproxy -s /redirect.py
or
mitmweb -s /redirect.py
or
mitmdump -s /redirect.py
```
### Fill a Pit

When using mitmproxy to observe requests for resources using HTTP 1.1 and Accept-Ranges: bytes, Content-Range long connection segments, it will wait until the entire response comes back before displaying, rather than showing segments and continuing to download using persistent connections!

[Check the pit here](../ee47f8f1e2d2/).
### Further Reading
- [Using a Check-in Reward APP as an Example to Create a Daily Automatic Check-in Script](../70a1409b149a/)
- [How to Create an Interesting Engineering CTF Competition](../729d7b6817a4/)
- [Revealing a Clever Website Vulnerability Discovered a Few Years Ago](../142244e5f07a/)
- [iOS 15 / MacOS Monterey Safari Will Be Able to Hide Real IP](https://medium.com/zrealm-ios-dev/ios-15-macos-monterey-safari-%E5%B0%87%E8%83%BD%E9%9A%B1%E8%97%8F%E7%9C%9F%E5%AF%A6-ip-755a8b6acc35){:target="_blank"}

### Postscript

Since I do not have domain permissions to obtain SSL certificate information, I cannot implement it; looking at the code does not seem difficult. Although there is no 100% secure method, having an additional layer of protection can at least make it a bit safer. Continuing to attack would require a lot of time to study, which should deter 90% of crawlers!

This article may have a bit too low of a gold content; Medium has been neglected for a while (went to play with a single-lens reflex camera). It mainly serves as a warm-up for the [iPlayground 2019](https://iplayground.io/2019/){:target="_blank"} event this weekend (2019/09/21–2019/09/22); looking forward to this year's agenda 🤩, and hope to produce more quality articles after returning!

> **_\[2019/02/22 Updated Article\] [What Was the Experience of iPlayground 2019?](../4079036c85c2/)_**
```

If you have any questions or suggestions, feel free to [contact me](https://www.zhgchg.li/contact){:target="_blank"}.

_[Post](https://medium.com/zrealm-ios-dev/app%E6%9C%89%E7%94%A8https%E5%82%B3%E8%BC%B8-%E4%BD%86%E8%B3%87%E6%96%99%E9%82%84%E6%98%AF%E8%A2%AB%E5%81%B7%E4%BA%86-46410aaada00){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
