---
title: å¾ iOS 9 åˆ° iOS 12 æ¨æ’­é€šçŸ¥æ¬Šé™ç‹€æ…‹è™•ç†(Swift)
author: ZhgChgLi
date: 2018-11-02T15:23:44.057+0000
last_modified_at: 2021-02-24T01:29:00.923+0000
categories: ZRealm Dev.
tags: [ios,push-notification,observables,ios-app-development,swift]
description: é©é… iOS 9 ~ iOS 12 è™•ç†é€šçŸ¥æ¬Šé™ç‹€æ…‹åŠè¦æ±‚æ¬Šé™çš„è§£æ±ºæ–¹æ¡ˆ
image:
  path: assets/fd7f92d52baa/1*fm_hG0GuT-BhSNTEB3Ht1g.jpeg
render_with_liquid: false
---

### å¾ iOS 9 åˆ° iOS 12 æ¨æ’­é€šçŸ¥æ¬Šé™ç‹€æ…‹è™•ç†\(Swift\)

é©é… iOS 9 ~ iOS 12 è™•ç†é€šçŸ¥æ¬Šé™ç‹€æ…‹åŠè¦æ±‚æ¬Šé™çš„è§£æ±ºæ–¹æ¡ˆ
### åšä»€éº¼ï¼Ÿ

æ¥çºŒå‰ä¸€ç¯‡ã€Œ [ä»€éº¼ï¼ŸiOS 12 ä¸éœ€ä½¿ç”¨è€…æˆæ¬Šå°±èƒ½å‚³é€æ¨æ’­é€šçŸ¥\(Swift\)](https://medium.com/@zhgchgli/%E4%BB%80%E9%BA%BC-ios-12-%E4%B8%8D%E9%9C%80%E4%BD%BF%E7%94%A8%E8%80%85%E6%8E%88%E6%AC%8A%E5%B0%B1%E8%83%BD%E6%94%B6%E5%88%B0%E6%8E%A8%E6%92%AD%E9%80%9A%E7%9F%A5-swift-ade9e745a4bf?fbclid=IwAR1AKi3io4Jt-rFFgrLWEFsmA0lKYVFUD7Dw9n9LpMa2zAzJCHeGGGgn9Vs){:target="_blank"} ã€æåˆ°çš„æ¨æ’­æ¬Šé™å–å¾—æµç¨‹å„ªåŒ–ï¼Œç¶“éä¸Šä¸€ç¯‡Murmuréƒ¨åˆ†å¯«çš„å„ªåŒ–ä¹‹å¾Œåˆé‡åˆ°äº†æ–°çš„éœ€æ±‚ï¼š


![](/assets/fd7f92d52baa/1*fm_hG0GuT-BhSNTEB3Ht1g.jpeg)

1. ä½¿ç”¨è€…è‹¥é—œé–‰é€šçŸ¥åŠŸèƒ½ï¼Œæˆ‘å€‘èƒ½åœ¨ç‰¹å®šåŠŸèƒ½é é¢æç¤ºä»–å»è¨­å®šé–‹å•Ÿ
2. è·³è½‰è‡³è¨­å®šé å¾Œï¼Œè‹¥æœ‰æ‰“é–‹/é—œé–‰é€šçŸ¥çš„æ“ä½œï¼Œå›åˆ°APPè¦èƒ½è·Ÿè‘—æ›´æ”¹ç‹€æ…‹
3. æ²’è©¢å•éæ¨æ’­æ¬Šé™æ™‚è©¢å•æ¬Šé™ï¼Œæœ‰è©¢å•éä½†æ˜¯ä¸å…è¨±å‰‡è·³æç¤ºï¼Œæœ‰è©¢å•éåˆæ˜¯å…è¨±å‰‡èƒ½ç¹¼çºŒæ“ä½œ
4. iOS 9 ~ iOS 12 éƒ½è¦æ”¯æ´


1~3 éƒ½é‚„å¥½ï¼Œä½¿ç”¨ iOS 10 ä¹‹å¾Œçš„Framework UserNotifications å·®ä¸å¤šéƒ½èƒ½å¦¥å–„çš„è§£æ±ºï¼Œéº»ç…©çš„æ˜¯ç¬¬4é … è¦èƒ½æ”¯æ´ iOS 9ï¼ŒiOS 9è¦ä½¿ç”¨ registerUserNotificationSettings èˆŠçš„æ–¹å¼è™•ç†èµ·ä¾†ä¸¦ä¸å®¹æ˜“ï¼›å°±è®“æˆ‘å€‘ä¸€æ­¥ä¸€æ­¥åšèµ·å§ï¼
### æ€è·¯åŠæ¶æ§‹ï¼š

é¦–å…ˆå®£å‘Šä¸€å€‹å…¨åŸŸçš„ notificationStatusç‰©ä»¶ å„²å­˜é€šçŸ¥æ¬Šé™ç‹€æ…‹ ä¸¦åœ¨éœ€è¦è™•ç†çš„é é¢åŠ ä¸Šå±¬æ€§ç›£è½ï¼ˆé€™é‚Šæˆ‘ä½¿ç”¨ [Observable](https://github.com/slazyk/Observable-Swift){:target="_blank"} åšå±¬æ€§è®ŠåŒ–çš„è¨‚é–±ã€å¯è‡ªè¡Œæ‰¾é©åˆçš„KVOæˆ–ç”¨Rxã€ReactiveCocoaï¼‰

ä¸¦åœ¨ appDelegate ä¸­ didFinishLaunchingWithOptions \(APPåˆå§‹æ‰“é–‹æ™‚\)ã€applicationDidBecomeActive \(å¾èƒŒæ™¯ç‹€æ…‹å›å¾©æ™‚\)ã€didRegisterUserNotificationSettings \(â‰¤iOS 9 çš„æ¨æ’­è©¢å•è™•ç†\) 
é€™äº›æ–¹æ³•ä¸­è™•ç†æª¢æŸ¥æ¨æ’­é€šçŸ¥æ¬Šé™ç‹€æ…‹ä¸¦æ›´æ”¹ notificationStatus çš„å€¼
éœ€è¦åšè™•ç†çš„é é¢å°±æœƒè§¸ç™¼ä¸¦ä½œç›¸å°æ‡‰çš„è™•ç†ï¼ˆEX: è·³å‡ºé€šçŸ¥è¢«é—œé–‰æç¤ºï¼‰
#### 1\. é¦–å…ˆå®£å‘Šå…¨åŸŸ notificationStatus ç‰©ä»¶
```swift
enum NotificationStatusType {
     case authorized
     case denied
     case notDetermined
}
var notificationStatus: Observable<NotificationStatusType?> = Observable(nil)
```

notificationStatus/NotificationStatusType çš„å››ç¨®ç‹€æ…‹åˆ†åˆ¥å°æ‡‰ï¼š
- nil = ç‰©ä»¶åˆå§‹åŒ–â€¦æª¢æ¸¬ä¸­â€¦
- notDetermined = æœªè©¢å•éä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥
- authorized = å·²è©¢å•éä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥ä¸”æŒ‰ã€Œå…è¨±ã€
- denied = å·²è©¢å•éä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥ä¸”æŒ‰ã€Œä¸å…è¨±ã€

#### 2\. æ§‹å»ºæª¢æ¸¬é€šçŸ¥æ¬Šé™ç‹€æ…‹çš„æ–¹æ³•ï¼š
```swift
func checkNotificationPermissionStatus() {
    if #available(iOS 10.0, *) {
        UNUserNotificationCenter.current().getNotificationSettings { (settings) in
            DispatchQueue.main.async {
                //æ³¨æ„ï¼è¦åˆ‡å›ä¸»åŸ·è¡Œç·’
                if settings.authorizationStatus == .authorized {
                    //å…è¨±
                    notificationStatus.value = NotificationStatusType.authorized
                } else if settings.authorizationStatus == .denied {
                    //ä¸å…è¨±
                    notificationStatus.value = NotificationStatusType.denied
                } else {
                    //æ²’å•é
                    notificationStatus.value = NotificationStatusType.notDetermined
                }
            }
        }
    } else {
        if UIApplication.shared.currentUserNotificationSettings?.types == []  {
            if let iOS9NotificationIsDetermined = UserDefaults.standard.object(forKey: "iOS9NotificationIsDetermined") as? Bool,iOS9NotificationIsDetermined == true {
                //æ²’å•é
                notificationStatus.value = NotificationStatusType.notDetermined
            } else {
                //ä¸å…è¨±
                notificationStatus.value = NotificationStatusType.denied
            }
        } else {
            //å…è¨±
            notificationStatus.value = NotificationStatusType.authorized
        }
    }
}
```

**ä»¥ä¸Šé‚„æ²’çµæŸï¼** 
çœ¼å°–çš„æœ‹å‹æ‡‰è©²åœ¨â‰¤ iOS 9çš„åˆ¤æ–·ä¹‹ä¸­ç™¼ç¾â€iOS9NotificationIsDeterminedâ€é€™å€‹è‡ªè¨‚çš„UserDefaultsï¼Œé‚£å®ƒæ˜¯ç”¨ä¾†å¹¹å˜›çš„å‘¢ï¼Ÿ

ä¸»å› æ˜¯â‰¤iOS 9çš„æª¢æ¸¬æ¨æ’­æ¬Šé™æ–¹æ³•åªèƒ½ç”¨ç²å–ç›®å‰çš„æ¬Šé™æœ‰å“ªäº›ä½œç‚ºåˆ¤æ–·ï¼Œè‹¥ç‚ºç©ºå‰‡ä»£è¡¨ç„¡æ¬Šé™ï¼Œä½†åœ¨æ²’è©¢å•éæ¬Šé™çš„æƒ…æ³ä¸‹ä¹Ÿæ˜¯æœƒæ˜¯ç©ºç™½ï¼›é€™æ™‚å€™éº»ç…©å°±ä¾†äº†ï¼Œä½¿ç”¨è€…ç©¶ç«Ÿæ˜¯æ²’å•éé‚„æ˜¯å•éæŒ‰ä¸å…è¨±ï¼Ÿ

é€™é‚Šæˆ‘ä½¿ç”¨äº†ä¸€å€‹è‡ªè¨‚çš„UserDefaults iOS9NotificationIsDeterminedä½œç‚ºåˆ¤æ–·é–‹é—œï¼Œä¸¦åœ¨appDelegateçš„didRegisterUserNotificationSettingsä¸­åŠ å…¥ï¼š
```swift
//appdelegate.swift:
func application(_ application: UIApplication, didRegister notificationSettings: UIUserNotificationSettings) {
    //iOS 9(å«)ä»¥ä¸‹ï¼Œè·³å‡ºè©¢å•è¦ä¸è¦å…è¨±é€šçŸ¥çš„è¦–çª—å¾Œï¼ŒæŒ‰ä¸‹å…è¨±æˆ–ä¸å…è¨±éƒ½æœƒè§¸ç™¼é€™å€‹æ–¹æ³•
    UserDefaults.standard.set("iOS9NotificationIsDetermined", true)
    checkNotificationPermissionStatus()
}
```

**é€šçŸ¥æ¬Šé™ç‹€æ…‹çš„ç‰©ä»¶ã€æª¢æ¸¬çš„æ–¹æ³•éƒ½æ§‹å»ºå¥½å¾Œï¼ŒappDelegateè£¡æˆ‘å€‘é‚„è¦å†åŠ ä¸Šâ€¦**
```swift
//appdelegate.swift
func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -> Bool {  
  checkNotificationPermissionStatus()
  return true
}
func applicationDidBecomeActive(_ application: UIApplication) {
  checkNotificationPermissionStatus()
}
```

APPåˆå§‹è·Ÿå¾èƒŒæ™¯è¿”å›éƒ½è¦å†æª¢æ¸¬ä¸€æ¬¡æ¨æ’­ç‹€æ…‹å¦‚ä½•

ä»¥ä¸Šå°±æ˜¯æª¢æ¸¬çš„éƒ¨åˆ†ï¼Œå†ä¾†æˆ‘å€‘ä¾†çœ‹å¦‚æœæ˜¯æœªè©¢å•è©²æ€éº¼è™•ç†è¦æ±‚é€šçŸ¥æ¬Šé™
#### 3\. è¦æ±‚é€šçŸ¥æ¬Šé™ï¼š
```swift
func requestNotificationPermission() {
    if #available(iOS 10.0, *) {
        let permissiones:UNAuthorizationOptions = [.badge, .alert, .sound]
        UNUserNotificationCenter.current().requestAuthorization(options: permissiones) { (granted, error) in
            DispatchQueue.main.async {
                checkNotificationPermissionStatus()
            }
        }
    } else {
        application.registerUserNotificationSettings(UIUserNotificationSettings(types: [.alert, .badge, .sound], categories: nil))
        //å‰é¢appdelegate.swiftçš„didRegisterUserNotificationSettingsæœƒè™•ç†å¾ŒçºŒcallback
    }
}
```

æª¢æ¸¬è·Ÿè¦æ±‚éƒ½è™•ç†å®Œå›‰ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹å¦‚ä½•æ‡‰ç”¨
#### 4\. æ‡‰ç”¨\(éœæ…‹\)
```swift
if notificationStatus.value == NotificationStatusType.authorized {
    //OK!
} else if notificationStatus.value == NotificationStatusType.denied {
    //ä¸å…è¨±
    //é€™é‚Šç¯„ä¾‹æ˜¯è·³å‡ºUIAlertControlleræç¤ºä¸¦é»æ“Šå¾Œå¯è·³è½‰è‡³è¨­å®šé é¢
    let alertController = UIAlertController(
        title: "è¦ªæ„›çš„ï¼Œæ‚¨ç›®å‰ç„¡æ³•æ¥æ”¶é€šçŸ¥",
        message: "è«‹é–‹å•Ÿçµå©šå§é€šçŸ¥æ¬Šé™ã€‚",
        preferredStyle: .alert)
    let settingAction = UIAlertAction(
        title: "å‰å¾€è¨­å®š",
        style: .destructive,
        handler: {
            (action: UIAlertAction!) -> Void in
            if let bundleID = Bundle.main.bundleIdentifier,let url = URL(string:UIApplicationOpenSettingsURLString + bundleID) {
                UIApplication.shared.openURL(url)
            }
    })
    let okAction = UIAlertAction(
        title: "å–æ¶ˆ",
        style: .default,
        handler: {
            (action: UIAlertAction!) -> Void in
            //well....
    })
    alertController.addAction(okAction)
    alertController.addAction(settingAction)
    self.present(alertController, animated: true) {
        
    }
} else if notificationStatus.value == NotificationStatusType.notDetermined {
    //æœªè©¢å•
    requestNotificationPermission()
}
```


> **è«‹æ³¨æ„ï¼ï¼è·³åˆ°APPçš„ã€Œè¨­å®šã€é æ™‚è«‹å‹¿ä½¿ç”¨** 
 

> UIApplication\.shared\.openURL\(URL\(string:â€App\-Prefs:root=\\ \(bundleID\)â€\) \)
 

> æ–¹å¼è·³è½‰ï¼Œ **æœƒè¢«é€€å¯©\! æœƒè¢«é€€å¯©\! æœƒè¢«é€€å¯©\! ï¼ˆè¦ªèº«ç¶“æ­·ï¼‰** 
 

> é€™æ˜¯Private API 




#### 5\. æ‡‰ç”¨\(å‹•æ…‹\)

å‹•æ…‹è®Šæ›´ç‹€æ…‹çš„éƒ¨åˆ†ï¼Œå› ç‚ºnotificationStatusç‰©ä»¶æˆ‘å€‘ä½¿ç”¨æ˜¯Observableï¼Œæˆ‘å€‘å¯ä»¥åœ¨è¦æ™‚æ™‚ç›£æ¸¬ç‹€æ…‹çš„viewDidLoadä¸­åŠ å…¥ç›£è½è™•ç†ï¼š
```swift
override func viewDidLoad() {
   super.viewDidLoad()
   notificationStatus.afterChange += { oldStatus,newStatus in
      if newStatus == NotificationStatusType.authorized {
       //print("â¤ï¸è¬è¬ä½ æ‰“é–‹é€šçŸ¥") 
      } else if newStatus == NotificationStatusType.denied {
       //print("ğŸ˜­å—šå—š")
      }
   }
}
```


> ä»¥ä¸Šåªæ˜¯ç¯„ä¾‹Codeï¼Œå¯¦éš›æ‡‰ç”¨ã€è§¸ç™¼å¯å†è‡ªè¡Œèª¿æ ¡
 

> **\*notificationStatus ä½¿ç”¨ Observable è«‹æ³¨æ„è¨˜æ†¶é«”æ§åˆ¶ï¼Œè©²é‡‹æ”¾æ™‚è¦èƒ½é‡‹æ”¾ï¼ˆé˜²æ­¢è¨˜æ†¶é«”æ´©æ¼ï¼‰ã€ä¸è©²é‡‹æ”¾æ™‚éœ€æŒæœ‰ï¼ˆé¿å…ç›£è½å¤±æ•ˆï¼‰** 




### æœ€å¾Œé™„ä¸Šå®Œæ•´Demoæˆå“ï¼š


![[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/fd7f92d52baa/1*_iVzlJLNQ7f0hO7IWxg1Zg.gif)

[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}

_\*ç”±æ–¼æˆ‘å€‘çš„å°ˆæ¡ˆæ”¯æ´ç¯„åœæ˜¯iOS 9 ~ iOS12ï¼ŒiOS 8æœªé€²è¡Œä»»ä½•æ¸¬è©¦ä¸ç¢ºå®šæ”¯æ´ç¨‹åº¦_


[![Like Z Realm's work](https://button.like.co/images/og/likebutton.png "Like Z Realm's work")](https://button.like.co/in/like/zhgchgli){:target="_blank"}


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_[Post](https://medium.com/zrealm-ios-dev/%E5%BE%9E-ios-9-%E5%88%B0-ios-12-%E6%8E%A8%E6%92%AD%E9%80%9A%E7%9F%A5%E6%AC%8A%E9%99%90%E7%8B%80%E6%85%8B%E8%99%95%E7%90%86-swift-fd7f92d52baa){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
