---
title: iOS Deferred Deep Link å»¶é²æ·±åº¦é€£çµå¯¦ä½œ(Swift)
author: ZhgChgLi
date: 2019-11-11T14:34:57.966+0000
last_modified_at: 2021-02-24T01:37:07.217+0000
categories: ZRealm Dev.
tags: [deeplink,ios-app-development,swift,universal-links,app-store]
description: å‹•æ‰‹æ‰“é€ é©æ‡‰æ‰€æœ‰å ´æ™¯ã€ä¸ä¸­æ–·çš„Appè½‰è·³æµç¨‹
image:
  path: assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg
render_with_liquid: false
---

### iOS Deferred Deep Link å»¶é²æ·±åº¦é€£çµå¯¦ä½œ\(Swift\)

å‹•æ‰‹æ‰“é€ é©æ‡‰æ‰€æœ‰å ´æ™¯ã€ä¸ä¸­æ–·çš„Appè½‰è·³æµç¨‹
### [2020/07/02\] æ›´æ–°
- [å› æ‡‰ iOS 14 æ›´æ–°ï¼Œè®€å–å‰ªè²¼ç°¿æ™‚æœƒæç¤ºä½¿ç”¨è€…ï¼Œå¦‚è¦å¯¦ä½œè«‹ä¸€ä½µåƒè€ƒæ­¤ç¯‡æ–‡ç« ã€‚](https://medium.com/@zhgchgli/ios-14-%E5%89%AA%E8%B2%BC%E7%B0%BF%E7%AB%8A%E8%B3%87%E6%81%90%E6%85%8C-%E9%9A%B1%E7%A7%81%E8%88%87%E4%BE%BF%E5%88%A9%E7%9A%84%E5%85%A9%E9%9B%A3-8a04443024e2){:target="_blank"}

#### ç„¡é—œ

ç•¢æ¥­ç•¶å®Œå…µåˆ°ç¾åœ¨åº¸åº¸ç¢Œç¢Œå·¥ä½œäº†å¿«ä¸‰å¹´ï¼Œæˆé•·å·²è¶¨æ–¼å¹³ç·©ï¼Œé–‹å§‹é€²å…¥èˆ’é©åœˆï¼Œæ‰€å¹¸å¿ƒä¸€æ©«æäº†é›¢è·ï¼Œæ²ˆæ¾±é‡æ–°å‡ºç™¼ã€‚

åœ¨é–±è®€ [åšè‡ªå·±çš„ç”Ÿå‘½è¨­è¨ˆå¸«](https://www.books.com.tw/products/0010733134){:target="_blank"} é‡æ–°æ¢³ç†è‡ªå·±çš„äººç”Ÿè¦åŠƒæ™‚ï¼Œå›é¡§äº†ä¸€ä¸‹å·¥ä½œè·Ÿäººç”Ÿï¼Œé›–ç„¶æœ¬èº«æŠ€è¡“èƒ½åŠ›æ²’æœ‰å¾ˆå¥½ï¼Œä½†åœ¨å¯« Medium èˆ‡å¤§å®¶åˆ†äº«èƒ½è®“æˆ‘é€²å…¥ã€Œå¿ƒæµã€è·Ÿç²å¾—å¤§é‡çš„ç²¾åŠ›ï¼›å‰›å¥½å‰é™£å­æœ‰æœ‹å‹åœ¨å• Deep Link å•é¡Œï¼Œè—‰æ­¤æ•´ç†äº†æˆ‘ç ”ç©¶çš„åšæ³•ï¼Œä¹Ÿé †ä¾¿è£œå……ä¸‹è‡ªå·±çš„ç²¾åŠ›ï¼
### å ´æ™¯

é¦–å…ˆè¦å…ˆèªªæ˜å¯¦éš›æ‡‰ç”¨å ´æ™¯ã€‚

1\.ç•¶ä½¿ç”¨è€…æœ‰è£ APP æ™‚é»æ“Šç¶²å€é€£çµ\(Googleæœå°‹ä¾†æºã€FBè²¼æ–‡ã€Lineé€£çµâ€¦\) å‰‡ç›´æ¥é–‹ APP å‘ˆç¾ç›®æ¨™ç•«é¢ï¼Œè‹¥ç„¡å‰‡è·³è½‰åˆ° APP Store å®‰è£ APPï¼› **å®‰è£å®Œå¾Œæ‰“é–‹APPï¼Œè¦èƒ½é‡ç¾ä¹‹å‰æ¬²å‰å¾€çš„ç•«é¢** ã€‚


[![iOS Deferred Deep Link Demo](/assets/b08ef940c196/249b_hqdefault.jpg "iOS Deferred Deep Link Demo")](https://www.youtube.com/watch?v=sY6-Q7BFUOM){:target="_blank"}


2\.APP ä¸‹è¼‰å’Œé–‹å•Ÿæ•¸æ“šè¿½è¹¤ï¼Œæˆ‘å€‘æƒ³çŸ¥é“ APP æ¨å»£é€£çµæœ‰å¤šå°‘äººç¢ºå¯¦å¾é€™å€‹å…¥å£ä¸‹è¼‰å’Œé–‹å•Ÿ APP çš„ã€‚

3\.ç‰¹æ®Šæ´»å‹•å…¥å£ï¼Œä¾‹å¦‚é€éç‰¹å®šç¶²å€ä¸‹è¼‰å¾Œé–‹å•Ÿèƒ½ç²å¾—çå‹µã€‚
#### æ”¯æ´åº¦ï¼š

iOS â‰¥ 9
### ä½•è¬‚ Deferred Deep Link èˆ‡ Deep Link çš„å·®åˆ¥ï¼Ÿ
#### ç´” Deep Link æœ¬èº«ï¼š


![](/assets/b08ef940c196/1*15arO4L94ZoEyOLtFARtsA.jpeg)


å¯ä»¥çœ‹åˆ° iOS Deep Link æœ¬èº«é‹ä½œæ©Ÿåˆ¶åªæœ‰åˆ¤æ–· APP æœ‰ç„¡å®‰è£ï¼Œæœ‰å‰‡é–‹ APPï¼Œç„¡å‰‡ä¸è™•ç†ï¼
#### é¦–å…ˆæˆ‘å€‘è¦å…ˆåŠ ä¸Šã€Œç„¡å‰‡è·³è½‰åˆ° APP Storeã€æç¤ºä½¿ç”¨è€…å®‰è£ APPï¼š

**URL Scheme** çš„éƒ¨åˆ†æ˜¯ç”±ç³»çµ±æ§åˆ¶ï¼Œä¸€èˆ¬ç”¨æ–¼ APP å…§å‘¼å«é®®å°‘å…¬é–‹å‡ºä¾†ï¼›å› ç‚ºå¦‚æœè§¸ç™¼é»åœ¨è‡ªå·±ç„¡æ³•æ§åˆ¶çš„å€åŸŸ\(å¦‚ï¼šLineé€£çµ\)ï¼Œå‰‡ç„¡æ³•è™•ç†ã€‚

è‹¥è§¸ç™¼é»åœ¨è‡ªèº«ç¶²é ä¸Šå¯ä»¥ä½¿ç”¨äº›å°æŠ€å·§è™•ç†ï¼Œè«‹åƒè€ƒ [**é€™è£¡**](https://stackoverflow.com/questions/627916/check-if-url-scheme-is-supported-in-javascript){:target="_blank"} ï¼š
```html
<html>
<head>
  <title>Redirect...</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script>
    var appurl = 'marry://open';
    var appstore = 'https://apps.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E6%9C%80%E5%A4%A7%E5%A9%9A%E7%A6%AE%E7%B1%8C%E5%82%99app/id1356057329';

    var timeout;
    function start() {
      window.location = appurl;
      timeout = setTimeout(function(){
        if(confirm('é¦¬ä¸Šå®‰è£çµå©šå§APP?')){
          document.location = appstore;
        }
      }, 1000);
    }

    window.onload = function() {
      start()
    }
  </script>
</head>
<body>

</body>
</html>
```

å¤§ç•¥é‚è¼¯æ˜¯ **ä¸€æ¨£å‘¼å« URL Schemeï¼Œç„¶å¾Œè¨­å€‹ Timeoutï¼Œæ™‚é–“åˆ°è‹¥é‚„åœ¨æœ¬é æ²’è·³è½‰å°±ç•¶æ²’å®‰è£ Call ä¸åˆ° Schemeï¼Œè½‰è€Œå° APP Store é é¢** \(ä½†é«”é©—é‚„æ˜¯ä¸å¥½é‚„æ˜¯æœƒè·³ç¶²å€éŒ¯èª¤æç¤ºï¼Œåªæ˜¯å¤šäº†è‡ªå‹•è½‰å€\)ã€‚

**Universal Link** æœ¬èº«å°±æ˜¯å€‹è‡ªå·±çš„ç¶²é ï¼Œè‹¥ç„¡è·³è½‰ï¼Œé è¨­å°±æ˜¯ä½¿ç”¨ç¶²é ç€è¦½å™¨å‘ˆç¾ï¼Œé€™é‚Šæœ‰ç¶²é æœå‹™çš„å¯ä»¥é¸æ“‡ç›´æ¥è·³ç¶²é ç€è¦½ã€æ²’æœ‰çš„å°±ç›´æ¥å° APP Store é é¢ã€‚

æœ‰ç¶²é æœå‹™çš„ç¶²ç«™å¯ä»¥åœ¨ `&lt;head></head&gt;` ä¸­åŠ å…¥ï¼š

[`&lt;meta name=â€apple-itunes-appâ€ content=â€app-id=APPID, app-argument=é é¢åƒæ•¸â€&gt;`](https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/PromotingAppswithAppBanners/PromotingAppswithAppBanners.html){:target="_blank"}


![](/assets/b08ef940c196/1*nC1JytAwIwKU04EMBBvf0A.jpeg)


ä½¿ç”¨ iPhone Safari ç€è¦½ç¶²é ç‰ˆä¸Šæ–¹å°±æœƒå‡ºç¾ APP å®‰è£æç¤ºã€ä½¿ç”¨ APP é–‹å•Ÿæœ¬é çš„æŒ‰éˆ•ï¼› åƒæ•¸ `app-argument` å°±æ˜¯ç”¨ä¾†å¸¶å…¥é é¢å€¼ï¼Œä¸¦å‚³éåˆ° APP ç”¨çš„ã€‚


![åŠ ä¸Šã€Œç„¡å‰‡è·³è½‰åˆ° APP Storeã€çš„æµç¨‹åœ–](/assets/b08ef940c196/1*B-_5tIDWQpNO8NxpXQsEcA.jpeg)

åŠ ä¸Šã€Œç„¡å‰‡è·³è½‰åˆ° APP Storeã€çš„æµç¨‹åœ–
#### å®Œå–„ Deep Link APP ç«¯è™•ç†ï¼š

æˆ‘å€‘è¦çš„ç•¶ç„¶ä¸åªæ˜¯ã€Œç•¶ä½¿ç”¨è€…æœ‰å®‰è£ APP å‰‡é–‹å•Ÿ APPã€ï¼Œæˆ‘å€‘é‚„è¦å°‡ä¾†æºè³‡è¨Šèˆ‡ APP ä¸²èµ·ï¼Œè®“ APP é–‹å•Ÿå¾Œè‡ªå‹•å‘ˆç¾ç›®æ¨™é é¢çš„ APP ç•«é¢ã€‚

**URL Scheme** æ–¹å¼å¯åœ¨ AppDelegate ä¸­çš„ **`func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool` é€²è¡Œè™•ç†ï¼š**
```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool {
    if url.scheme == "marry",let params = url.queryParameters {
      if params["type"] == "topic" {
        let VC = TopicViewController(topicID:params["id"])
        UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
      }    
    }
    return true
}
```

**Universal Link** å‰‡æ˜¯åœ¨ AppDelegate ä¸­çš„ **`func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([Any]?) -> Void) -> Bool` é€²è¡Œè™•ç†ï¼š**
```swift
extension URL {
    /// test=1&a=b&c=d => ["test":"1","a":"b","c":"d"]
    /// è§£æç¶²å€queryè½‰æ›æˆ[String: String]æ•¸çµ„è³‡æ–™
    public var queryParameters: [String: String]? {
        guard let components = URLComponents(url: self, resolvingAgainstBaseURL: true), let queryItems = components.queryItems else {
            return nil
        }
        
        var parameters = [String: String]()
        for item in queryItems {
            parameters[item.name] = item.value
        }
        
        return parameters
    }
    
}
```

å…ˆé™„ä¸Šä¸€å€‹ URL çš„æ“´å……æ–¹æ³• queryParametersï¼Œç”¨æ–¼æ–¹ä¾¿å°‡ URL Query è½‰æ›æˆ Swift Dictionaryã€‚
```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
        
  if userActivity.activityType == NSUserActivityTypeBrowsingWeb, webpageURL = userActivity.webpageURL {
    /// å¦‚æœæ˜¯universal link urlä¾†æº...
    let params = webpageURL.queryParameters
    
    if params["type"] == "topic" {
      let VC = TopicViewController(topicID:params["id"])
      UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
    }
  }
  
  return true  
}
```


![](/assets/b08ef940c196/1*zhtWK56EqWpE91yTVu64Lg.jpeg)


å®Œæˆï¼
#### é‚£é‚„ç¼ºä»€éº¼ï¼Ÿ

ç›®å‰çœ‹ä¾†å·²ç¶“å¾ˆå®Œç¾äº†ï¼Œæˆ‘å€‘è™•ç†äº†æ‰€æœ‰æœƒé‡åˆ°çš„ç‹€æ³ï¼Œé‚£é‚„ç¼ºä»€éº¼ï¼Ÿ


![](/assets/b08ef940c196/1*ulrLKyvTKoChPScWD9wHyA.jpeg)


å¦‚åœ–æ‰€ç¤ºï¼Œå¦‚æœæ˜¯ æœªå®‰è£ \-&gt; APP Store å®‰è£ \-&gt; APP Store æ‰“é–‹ï¼Œä¾†æºæ‰€å¸¶çš„è³‡æ–™å°±æœƒä¸­æ–·ï¼ŒAPP ä¸çŸ¥é“ä¾†æºæ‰€ä»¥å°±åªæœƒé¡¯ç¤ºé¦–é ï¼›ä½¿ç”¨è€…è¦å†å›åˆ°ä¸Šä¸€æ­¥ç¶²é å†é»ä¸€æ¬¡é–‹å•Ÿï¼ŒAPP æ‰æœƒé©…å‹•è·³é ã€‚


![](/assets/b08ef940c196/1*dFdvCRRdM3vrN3lnyG8Diw.jpeg)

> _é›–ç„¶é€™æ¨£ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†è€ƒæ…®åˆ°è·³å‡ºæµå¤±ç‡ï¼Œå¤šä¸€å€‹æ­¥é©Ÿå°±æ˜¯å¤šä¸€å±¤æµå¤±ï¼Œé‚„æœ‰ä½¿ç”¨è€…é«”é©—èµ·ä¾†ä¸é †æš¢ï¼›æ›´ä½•æ³ä½¿ç”¨è€…æœªå¿…é€™éº¼è°æ˜ã€‚_ 


#### é€²å…¥æœ¬æ–‡é‡é»

ä½•è¬‚ Deferred Deep Linkï¼Ÿï¼Œå»¶é²æ·±åº¦é€£çµï¼›å°±æ˜¯è®“æˆ‘å€‘çš„ Deep Link å¯ä»¥å»¶ä¼¸åˆ° APP Store å®‰è£å®Œå¾Œä¾ç„¶ä¿æœ‰ä¾†æºè³‡æ–™ã€‚

æ“š Android å·¥ç¨‹å¸«è¡¨ç¤º Android æœ¬èº«å°±æœ‰æ­¤åŠŸèƒ½ï¼Œä½†åœ¨ iOS ä¸Šä¸¦ä¸æ”¯æ´æ­¤è¨­å®šã€è¦é”åˆ°æ­¤åŠŸèƒ½çš„åšæ³•ä¹Ÿä¸å‹å–„ï¼Œè«‹ç¹¼çºŒçœ‹ä¸‹å»ã€‚
### Deferred Deep Link
> _å¦‚æœä¸æƒ³èŠ±æ™‚é–“è‡ªå·±åšçš„è©±å¯ä»¥ç›´æ¥ä½¿ç”¨ [branch\.io](http://branch.io){:target="_blank"} æˆ– [Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links){:target="_blank"} æœ¬æ–‡ä»‹ç´¹çš„æ–¹æ³•å°±æ˜¯ Firebase ä½¿ç”¨çš„æ–¹å¼ã€‚_ 



**è¦é”æˆ Deferred Deep Link çš„æ•ˆæœç¶²è·¯ä¸Šæœ‰å…©ç¨®åšæ³•ï¼š**

ä¸€ç¨®æ˜¯é€éä½¿ç”¨è€…è£ç½®ã€IPã€ç’°å¢ƒâ€¦ç­‰ç­‰åƒæ•¸è¨ˆç®—å‡ºä¸€å€‹é›œæ¹Šå€¼ï¼Œåœ¨ç¶²é ç«¯å­˜å…¥è³‡æ–™åˆ°ä¼ºæœå™¨ï¼›ç•¶ APP å®‰è£å¾Œæ‰“é–‹ç”¨åŒæ¨£æ–¹å¼è¨ˆç®—ï¼Œå¦‚æœå€¼ç›¸åŒå‰‡å–å‡ºè³‡æ–™æ¢å¾©ï¼ˆbranch\.io çš„åšæ³•ï¼‰ã€‚

å¦ä¸€ç¨®æ˜¯æœ¬æ–‡è¦ä»‹ç´¹çš„æ–¹æ³•ï¼ŒåŒ Firebase ä½œæ³•ï¼›ä½¿ç”¨ iPhone å‰ªè²¼ç°¿å’Œ Safari èˆ‡ APP Cookie å…±äº«æ©Ÿåˆ¶çš„æ–¹æ³•ï¼Œç­‰æ–¼æ˜¯æŠŠè³‡æ–™å­˜åœ¨å‰ªè²¼ç°¿æˆ–Cookieï¼ŒAPPå®‰è£å®Œæˆå¾Œå†å»è®€å‡ºä¾†ä½¿ç”¨ã€‚


![](/assets/b08ef940c196/1*VVahSlHV2N2jcIw4afzr2g.jpeg)

```
é»æ“Šã€ŒOpenã€å¾Œä½ çš„å‰ªè²¼ç°¿å°±æœƒè¢« JavaScript è‡ªå‹•è¦†è“‹è¤‡è£½ä¸Šè·³è½‰ç›¸é—œè³‡è¨Šï¼šhttps://XXX.app.goo.gl/?link=https://XXX.net/topicID=1&type=topic
```

ç›¸ä¿¡æœ‰å¥—é Firebase Dynamic Links çš„äººä¸€å®šä¸é™Œç”Ÿé€™å€‹é–‹å•Ÿè·³è½‰é ï¼Œäº†è§£åˆ°åŸç†ä¹‹å¾Œå°±çŸ¥é“é€™é åœ¨æµç¨‹ä¸­æ˜¯ç„¡æ³•ç§»é™¤çš„ï¼

å¦å¤– Firebase ä¹Ÿä¸æä¾›é€²è¡Œæ¨£å¼ä¿®æ”¹ã€‚
#### æ”¯æ´åº¦

é¦–å…ˆè¬›å€‹å‘ï¼Œæ”¯æ´åº¦å•é¡Œï¼›å¦‚å‰æ‰€èªªçš„ã€Œä¸å‹å–„ã€ï¼


![](/assets/b08ef940c196/1*LR3MSAcwjaoSQhwvtD2sUQ.png)


å¦‚æœ APP åªè€ƒæ…® iOS â‰¥ 10 ä»¥ä¸Šçš„è©±å®¹æ˜“è¨±å¤šï¼ŒAPP å¯¦ä½œå‰ªè²¼ç°¿å­˜å–ã€Web ä½¿ç”¨ JavaScript å°‡è³‡è¨Šè¦†è“‹åˆ°å‰ªè²¼ç°¿ï¼Œç„¶å¾Œå†è·³è½‰åˆ° APP Store å°ä¸‹è¼‰å°±å¥½ã€‚

iOS = 9 ä¸æ”¯æ´JavaScriptè‡ªå‹•å‰ªè²¼ç°¿ä½†æ”¯æ´ **Safari èˆ‡ APP SFSafariViewControllerã€ŒCookie äº’é€šå¤§æ³•ã€**

å¦å¤–åœ¨ APP éœ€è¦å·å·åœ¨èƒŒæ™¯åŠ å…¥ SFSafariViewController è¼‰å…¥ Webï¼Œå†å¾ Web å–å¾—å‰›æ‰é»é€£çµæ™‚å­˜çš„Cookieè³‡è¨Šã€‚
> _æ­¥é©Ÿç¹ç‘£ï¼†é€£çµé»æ“Šåƒ…é™ Safariç€è¦½å™¨ã€‚_ 




![[SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller){:target="_blank"}](/assets/b08ef940c196/1*tPXHlrQE3MdrjMzFbnS_4w.png)

[SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller){:target="_blank"}
> _æ ¹æ“šå®˜æ–¹æ–‡ä»¶ï¼ŒiOS 11 å·²ç„¡æ³•å–å¾—ä½¿ç”¨è€…çš„ Safari Cookieï¼Œè‹¥æœ‰é€™æ–¹é¢éœ€æ±‚å¯ä½¿ç”¨ SFAuthenticationSessionï¼Œä½†æ­¤æ–¹æ³•ç„¡æ³•åœ¨èƒŒæ™¯å·åŸ·è¡Œï¼Œæ¯æ¬¡è¼‰å…¥å‰éƒ½æœƒè·³å‡ºä»¥ä¸‹è©¢å•è¦–çª—ï¼š_ 




![_SFAuthenticationSession è©¢å•è¦–çª—_](/assets/b08ef940c196/1*eisreftWPWn9PTCbuLQqdw.jpeg)

_SFAuthenticationSession è©¢å•è¦–çª—_
> _é‚„æœ‰å°±æ˜¯ APPå¯©æŸ¥æ˜¯ä¸å…è¨±å°‡SFSafariViewControlleræ”¾åœ¨ä½¿ç”¨è€…çœ‹ä¸åˆ°çš„åœ°æ–¹çš„ã€‚\(ç”¨ç¨‹å¼è§¸ç™¼å† addSubview ä¸å¤ªå®¹æ˜“è¢«ç™¼ç¾\)_ 


### å‹•æ‰‹åš

å…ˆè¬›ç°¡å–®çš„ï¼Œåªè€ƒæ…® iOS â‰¥ 10 ä»¥ä¸Šçš„ç”¨æˆ¶ï¼Œå–®ç´”ä½¿ç”¨ iPhone å‰ªè²¼ç°¿è½‰å‚³è³‡è¨Šã€‚
#### Web ç«¯ï¼š


![](/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg)


æˆ‘å€‘ä»¿é€  Firebase Dynamic Links å®¢è£½åŒ–åˆ»äº†è‡ªå·±çš„é é¢ï¼Œä½¿ç”¨ [`clipboard.js`](https://clipboardjs.com/){:target="_blank"} é€™å€‹å¥—ä»¶è®“ä½¿ç”¨è€…é»æ“Šã€Œç«‹å³å‰å¾€ã€æ™‚å…ˆå°‡æˆ‘å€‘è¦å¸¶çµ¦ APP çš„è³‡è¨Šè¤‡è£½åˆ°å‰ªè²¼ç°¿ `ï¼ˆmarry://topicID=1&type=topicï¼‰` ï¼Œç„¶å¾Œå†ä½¿ç”¨ `location.href` è·³è½‰åˆ° APP Store å•†åŸé ã€‚
#### APP ç«¯ï¼š

åœ¨ AppDelegate æˆ– ä¸»é  UIViewController ä¸­è®€å–å‰ªè²¼ç°¿çš„å€¼ï¼š

**`let pasteData = UIPasteboard.general.string`**

é€™é‚Šå»ºè­°é‚„æ˜¯å°‡è³‡è¨Šä½¿ç”¨ URL Scheme æ–¹å¼åŒ…è£ï¼Œæ–¹ä¾¿é€²è¡Œè¾¨è­˜ã€è³‡æ–™åè§£ï¼š
```swift
if let pasteData = UIPasteboard.general.string,let url = URL(string: pasteData),url.scheme == "marry",let params = url.queryParameters {
    if params["type"] == "topic" {
      let VC = TopicViewController(topicID:params["id"])
      UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
    }
}
```

æœ€å¾Œåœ¨è™•ç†å®Œå‹•ä½œå¾Œä½¿ç”¨ `UIPasteboard.general.string = â€œâ€` å°‡å‰ªè²¼ç°¿ä¸­çš„è³‡è¨Šæ¸…é™¤ã€‚
### å‹•æ‰‹åš â€” æ”¯æ´ iOS 9 ç‰ˆæœ¬

éº»ç…©çš„ä¾†äº†ï¼Œæ”¯æ´ iOS 9 ç‰ˆï¼Œå‰æ–‡æœ‰èªªç”±æ–¼ä¸æ”¯æ´å‰ªè²¼ç°¿ï¼Œè¦ä½¿ç”¨ **Cookie äº’é€šå¤§æ³•** ã€‚
#### Web ç«¯ï¼š

web ç«¯ä¹Ÿç®—å¥½è™•ç†ï¼Œå°±æ˜¯æ”¹æˆä½¿ç”¨è€…é»æ“Šã€Œç«‹å³å‰å¾€ã€æ™‚å°‡æˆ‘å€‘è¦å¸¶çµ¦ APP çš„è³‡è¨Šå­˜åˆ° Cookie `ï¼ˆmarry://topicID=1&type=topicï¼‰` ï¼Œç„¶å¾Œå†ä½¿ç”¨ `location.href` è·³è½‰åˆ° APP Store å•†åŸé ã€‚

é€™è£¡æä¾›å…©å€‹å°è£å¥½çš„ JavaScript è™•ç† Cookie çš„æ–¹æ³•ï¼ŒåŠ é€Ÿé–‹ç™¼ï¼š
```javascript
/// name: Cookie åç¨±
/// val: Cookie å€¼
/// day: Cookie æœ‰æ•ˆæœŸé™ï¼Œé è¨­ï¼‘å¤©
/// EX1: setcookie("iosDeepLinkData","marry://topicID=1&type=topic")
/// EX2: setcookie("hey","hi",365) = ä¸€å¹´æœ‰æ•ˆ
function setcookie(name, val, day) {
    var exdate = new Date();
    day = day || 1;
    exdate.setDate(exdate.getDate() + day);
    document.cookie = "" + name + "=" + val + ";expires=" + exdate.toGMTString();
}

/// getCookie("iosDeepLinkData") => marry://topicID=1&type=topic
function getCookie(name) {
    var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
    if (arr != null) return decodeURI(arr[2]);
    return null;
}
```
#### APP ç«¯ï¼š

æœ¬æ–‡æœ€éº»ç…©çš„åœ°æ–¹ä¾†äº†ã€‚

å‰æ–‡æœ‰æåˆ°åŸç†ï¼Œæˆ‘å€‘è¦åœ¨ä¸»é çš„UIViewControllerç”¨ç¨‹å¼å·å·åŠ è¼‰ä¸€å€‹SFSafariViewController åœ¨èƒŒæ™¯ä¸è®“ä½¿ç”¨è€…å¯Ÿè¦ºã€‚

**å†èªªå€‹å‘ï¼š** å·å·åŠ è¼‰é€™ä»¶äº‹ï¼ŒiOS â‰¥ 10 SFSafariViewController çš„ Viewå¦‚æœå¤§å°è¨­å®šå°æ–¼1ã€é€æ˜åº¦å°æ–¼0\.05ã€è¨­æˆ isHiddenï¼ŒSFSafariViewController å°± **ä¸æœƒè¼‰å…¥** ã€‚
> p\.s iOS = 10 åŒæ™‚æ”¯æ´ Cookie åŠ å‰ªè²¼ç°¿ã€‚ 




![[https://stackoverflow\.com/questions/39019352/ios10\-sfsafariviewcontroller\-not\-working\-when\-alpha\-is\-set\-to\-0/39216788](https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788){:target="_blank"}](/assets/b08ef940c196/1*ab-6ppwHU72AsKKLYBitbw.png)

[https://stackoverflow\.com/questions/39019352/ios10\-sfsafariviewcontroller\-not\-working\-when\-alpha\-is\-set\-to\-0/39216788](https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788){:target="_blank"}

æˆ‘é€™é‚Šçš„åšæ³•æ˜¯åœ¨ ä¸»é çš„UIViewController ä¸Šæ–¹æ”¾ä¸€å€‹ UIView éš¨ä¾¿çµ¦å€‹é«˜åº¦ï¼Œä½†åº•éƒ¨å°é½Š ä¸»é é¢ UIView ä¸Šæ–¹ï¼Œç„¶å¾Œæ‹‰ IBOutlet `ï¼ˆsharedCookieViewï¼‰` åˆ° Classï¼›åœ¨ viewDidLoad\(\) æ™‚ init SFSafariViewController ä¸¦å°‡å…¶ View åŠ å…¥åˆ° `sharedCookieView` ä¸Šï¼Œæ‰€ä»¥ä»–å¯¦éš›æœ‰é¡¯ç¤ºæœ‰è¼‰å…¥ï¼Œåªæ˜¯è·‘å‡ºç•«é¢äº†ï¼Œä½¿ç”¨è€…çœ‹ä¸åˆ°ğŸŒã€‚

**SFSafariViewController çš„ URL è©²æŒ‡å‘ï¼Ÿ**

åŒ Web ç«¯åˆ†äº«é é¢ï¼Œæˆ‘å€‘è¦å†åˆ»ä¸€å€‹ For è®€å– Cookie çš„é é¢ï¼Œä¸¦å°‡å…©å€‹é é¢æ”¾åœ¨åŒå€‹ç¶²åŸŸä¹‹ä¸‹é¿å…è·¨ç¶²åŸŸCookieå•é¡Œï¼Œé é¢å…§å®¹ç¨å¾Œé™„ä¸Šã€‚
```swift
@IBOutlet weak var SharedCookieView: UIView!

override func viewDidLoad() {
    super.viewDidLoad()
    
    let url = URL(string:"http://app.marry.com.tw/loadCookie.html")
    let sharedCookieViewController = SFSafariViewController(url: url)
    VC.view.frame = CGRect(x: 0, y: 0, width: 200, height: 200)
    sharedCookieViewController.delegate = self
    
    self.addChildViewController(sharedCookieViewController)
    self.SharedCookieView.addSubview(sharedCookieViewController.view)
    
    sharedCookieViewController.beginAppearanceTransition(true, animated: false)
    sharedCookieViewController.didMove(toParentViewController: self)
    sharedCookieViewController.endAppearanceTransition()
}
```

`sharedCookieViewController.delegate = self`

**`class HomeViewController: UIViewController, SFSafariViewControllerDelegate`**

éœ€è¦åŠ ä¸Šé€™å€‹ Delegate æ‰èƒ½æ•ç²è¼‰å…¥å®Œæˆå¾Œçš„ CallBack è™•ç†ã€‚

æˆ‘å€‘å¯ä»¥åœ¨ï¼š

**`func safariViewController(_ controller: SFSafariViewController, didCompleteInitialLoad didLoadSuccessfully: Bool) \{`**

æ–¹æ³•ä¸­æ•ç²è¼‰å…¥å®Œæˆäº‹ä»¶ã€‚

åˆ°é€™æ­¥ï¼Œä½ å¯èƒ½æœƒæƒ³å†ä¾†å°±æ˜¯åœ¨ `didCompleteInitialLoad` ä¸­è®€å– ç¶²é å…§çš„ Cookie å°±å®Œæˆäº†ï¼

åœ¨é€™è£¡æˆ‘æ²’æ‰¾åˆ°è®€å– SFSafariViewController Cookie çš„æ–¹æ³•ï¼Œä½¿ç”¨ç¶²è·¯çš„æ–¹æ³•è®€å‡ºä¾†éƒ½æ˜¯ç©ºçš„ã€‚
> _æˆ–å¯èƒ½è¦ä½¿ç”¨ JavaScript èˆ‡é é¢å…§å®¹é€²è¡Œäº¤äº’ï¼Œå« JavaScript è®€ Cookie å›å‚³çµ¦ UIViewControllerã€‚_ 


#### Tricky çš„ URL Scheme æ³•

æ—¢ç„¶ iOS ä¸çŸ¥åˆ°å¦‚ä½•å–å¾—å…±äº«çš„ Cookieï¼Œé‚£æˆ‘å€‘å°±ç›´æ¥äº¤ç”±ã€Œè®€å– Cookie çš„é é¢ã€å»å¹«æˆ‘å€‘ã€Œè®€å– Cookieã€ã€‚

å‰æ–‡é™„ä¸Šçš„ JavaScript è™•ç† Cookie çš„æ–¹æ³•ä¸­çš„ getCookie\(\) å°±æ˜¯ç”¨åœ¨é€™ï¼Œæˆ‘å€‘çš„ã€Œè®€å– Cookie çš„é é¢ã€å…§å®¹æ˜¯å€‹ç©ºç™½é \(åæ­£ä½¿ç”¨è€…çœ‹ä¸åˆ°\)ï¼Œä½†æ˜¯åœ¨ JavaScript éƒ¨åˆ†è¦åœ¨ body onload ä¹‹å¾Œå»è®€å– Cookieï¼š
```html
<html>
<head>
  <title>Load iOS Deep Link Saved Cookie...</title>
  <script>
  function checkCookie() {
    var iOSDeepLinkData = getCookie("iOSDeepLinkData");
    if (iOSDeepLinkData && iOSDeepLinkData != '') {
        setcookie("iOSDeepLinkData", "", -1);
        window.location.href = iOSDeepLinkData; /// marry://topicID=1&type=topic
    }
  }
  </script>
</head>

<body onload="checkCookie();">

</body>

</html>
```

å¯¦éš›çš„åŸç†ç¸½çµå°±æ˜¯ï¼šåœ¨ `HomeViewController viewDidLoad` æ™‚åŠ å…¥ `SFSafariViewController` å·åŠ è¼‰ `loadCookie.html` é é¢ï¼Œ `loadCookie.html` é é¢è®€å–æª¢æŸ¥å…ˆå‰å­˜çš„ Cookieï¼Œè‹¥æœ‰å‰‡è®€å‡ºæ¸…é™¤ï¼Œç„¶å¾Œä½¿ç”¨ `window.location.href` å‘¼å«ï¼Œè§¸ç™¼ `URL Scheme` æ©Ÿåˆ¶ã€‚

æ‰€ä»¥ä¹‹å¾Œå°æ‡‰çš„ CallBack è™•ç†å°±æœƒå›åˆ° `AppDelegate` ä¸­çš„ **`func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool` é€²è¡Œè™•ç†ã€‚**
### å®Œå·¥ï¼ç¸½çµï¼š


![](/assets/b08ef940c196/1*kp26TdlJBW5sVxw4zYa9Rg.jpeg)


å¦‚æœè¦ºå¾—ç…©ç‘£ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [branch\.io](http://branch.io){:target="_blank"} æˆ– [Firebase Dynamic](https://firebase.google.com/docs/dynamic-links){:target="_blank"} æ²’å¿…è¦é‡é€ è¼ªå­ï¼Œé€™é‚Šæ˜¯å› ç‚ºä»‹é¢å®¢è£½åŒ–åŠä¸€äº›è¤‡é›œéœ€æ±‚ï¼Œåªå¥½è‡ªå·±æ‰“é€ ã€‚

iOS=9 çš„ç”¨æˆ¶å·²ç¶“éå¸¸ç¨€å°‘ï¼Œä¸æ˜¯å¾ˆå¿…è¦çš„è©±å¯ä»¥ç›´æ¥å¿½ç•¥ï¼›ä½¿ç”¨å‰ªè²¼ç°¿çš„æ–¹æ³•å¿«åˆæœ‰æ•ˆç‡ï¼Œè€Œä¸”ç”¨å‰ªè²¼ç°¿å°±ä¸ç”¨å±€é™é€£çµä¸€å®šè¦ç”¨ Safari é–‹å•Ÿï¼


[![Like Z Realm's work](https://button.like.co/images/og/likebutton.png "Like Z Realm's work")](https://button.like.co/zhgchgli){:target="_blank"}


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_Converted [Medium Post](https://medium.com/zrealm-ios-dev/ios-deferred-deep-link-%E5%BB%B6%E9%81%B2%E6%B7%B1%E5%BA%A6%E9%80%A3%E7%B5%90%E5%AF%A6%E4%BD%9C-swift-b08ef940c196) by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown)._
