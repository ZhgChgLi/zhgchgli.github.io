---
title: Vision åˆæ¢â€Šâ€”â€ŠAPP é ­åƒä¸Šå‚³ è‡ªå‹•è­˜åˆ¥äººè‡‰è£åœ– (Swift)
author: ZhgChgLi
date: 2018-10-16T16:01:24.511Z
categories: ZRealm Dev.
tags: [swift,machine-learning,facedetection,ios,ios-app-development]
---

### Vision åˆæ¢ â€” APP é ­åƒä¸Šå‚³ è‡ªå‹•è­˜åˆ¥äººè‡‰è£åœ– (Swift)

Vision å¯¦æˆ°æ‡‰ç”¨
#### ä¸€æ¨£ä¸å¤šèªªï¼Œå…ˆä¸Šä¸€å¼µæˆå“åœ–ï¼š


![å„ªåŒ–å‰ V\.S å„ªåŒ–å¾Œ â€” çµå©šå§APP](/assets/9a9aa892f9a9/1*c-ioRH_Z2nMYRxSbuBD71A.png "å„ªåŒ–å‰ V\.S å„ªåŒ–å¾Œ â€” çµå©šå§APP")

å„ªåŒ–å‰ V.S å„ªåŒ–å¾Œ â€” [çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8)

å‰é™£å­iOS 12ç™¼ä½ˆæ›´æ–°ï¼Œæ³¨æ„åˆ°æ–°é–‹æ”¾çš„CoreML æ©Ÿå™¨å­¸ç¿’æ¡†æ¶ï¼›è¦ºå¾—æŒºæœ‰è¶£çš„ï¼Œå°±é–‹å§‹æ§‹æƒ³å¦‚æœæƒ³ç”¨åœ¨ç•¶å‰çš„ç”¢å“ä¸Šèƒ½æ”¾åœ¨å“ªè£¡ï¼Ÿ
> **CoreMLåšé®®æ–‡ç« ç¾å·²ç™¼ä½ˆï¼š [ä½¿ç”¨æ©Ÿå™¨å­¸ç¿’è‡ªå‹•é æ¸¬æ–‡ç« åˆ†é¡ï¼Œé€£æ¨¡å‹ä¹Ÿè‡ªå·±è¨“ç·´](../793bf2cdda0f)**


CoreMLæä¾›æ–‡å­—ã€åœ–åƒçš„æ©Ÿå™¨å­¸ç¿’æ¨¡å‹è¨“ç·´åŠå¼•ç”¨åˆ°APPè£¡çš„æ¥å£ï¼Œæˆ‘åŸå…ˆçš„æƒ³æ³•æ˜¯ï¼Œä½¿ç”¨CoreMLä¾†åšåˆ°äººè‡‰è­˜åˆ¥ï¼Œè§£æ±ºAPPä¸­æœ‰è£åœ–çš„é …ç›®é ­æˆ–è‡‰è¢«å¡æ‰çš„å•é¡Œï¼Œå¦‚ä¸Šåœ–å·¦æ‰€ç¤ºï¼Œè‹¥äººè‡‰å‡ºç¾åœ¨å‘¨åœå‰‡å¾ˆå®¹æ˜“å› ç‚ºç¸®æ”¾ï¼‹è£åœ–é€ æˆè‡‰ä¸å®Œæ•´ï¼

ç¶“éç¶²è·¯æœå°‹ä¸€ç•ªå¾Œæ‰ç™¼ç¾æˆ‘å­¸è­˜çŸ­æ·ºï¼Œé€™å€‹åŠŸèƒ½åœ¨iOS 11å°±å·²ç™¼ä½ˆï¼šã€ŒVisionã€æ¡†æ¶ï¼Œæ”¯æ´æ–‡å­—åµæ¸¬ã€äººè‡‰åµæ¸¬ã€åœ–åƒæ¯”å°ã€QRCODEåµæ¸¬ã€ç‰©ä»¶è¿½è¹¤â€¦åŠŸèƒ½

é€™é‚Šä½¿ç”¨çš„å°±æ˜¯å…¶ä¸­çš„äººè‡‰åµæ¸¬é …ç›®ï¼Œç¶“å„ªåŒ–å¾Œå¦‚å³åœ–æ‰€ç¤ºï¼›æ‰¾åˆ°äººè‡‰ä¸¦ä»¥æ­¤ç‚ºä¸­å¿ƒè£åœ–ï¼
### å¯¦æˆ°é–‹å§‹ï¼š
#### é¦–å…ˆæˆ‘å€‘å…ˆåšèƒ½æ¨™è¨˜äººè‡‰ä½ç½®çš„åŠŸèƒ½ï¼Œåˆæ­¥èªè­˜ä¸€ä¸‹Visionæ€éº¼ç”¨


![Demo APP](/assets/9a9aa892f9a9/1*cpGgpXsBhuiJoZI03WAGUw.png "Demo APP")

Demo APP

å®Œæˆåœ–å¦‚ä¸Šæ‰€ç¤ºï¼Œèƒ½æ¨™è¨˜å‡ºç…§ç‰‡ä¸­äººè‡‰çš„ä½ç½®

p.s åƒ…èƒ½æ¨™è¨˜ã€Œäººè‡‰ã€ï¼Œæ•´å€‹é ­åŒ…å«é ­é«®ä¸¦ä¸è¡ŒğŸ˜…

é€™å¡Šç¨‹å¼ä¸»è¦åˆ†ç‚ºå…©éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†è¦è§£æ±º åœ–ç‰‡åŸå°ºå¯¸ç¸®æ”¾æ”¾å…¥ ImageViewæ™‚æœƒç•™ç™½çš„ç‹€æ³ï¼›ç°¡å–®ä¾†èªªæˆ‘å€‘è¦çš„æ˜¯Imageçš„Sizeå¤šå¤§ï¼ŒImageViewçš„Sizeå°±æœ‰å¤šå¤§ï¼Œè‹¥ç›´æ¥æ”¾å…¥åœ–ç‰‡æœƒé€ æˆå¦‚ä¸‹èµ°ä½æƒ…å½¢


![](/assets/9a9aa892f9a9/1*Mb70Ed6pALO-8sllCpb7Qg.png)


ä½ å¯èƒ½æœƒæƒ³èªªç›´æ¥æ”¹ContentModeè®Šæˆfillã€fitã€redrawï¼Œä½†å°±æœƒè®Šå½¢æˆ–åœ–ç‰‡è¢«å¡æ‰
```swift
let ratio = UIScreen.main.bounds.size.width
//é€™é‚Šæ˜¯å› ç‚ºæˆ‘UIIMAGEVIEW é‚£é‚Šè¨­å®šå·¦å³å°é½Š0ï¼Œå¯¬é«˜æ¯”1:1

let sourceImage = UIImage(named: "Demo2")?.kf.resize(to: CGSize(width: ratio, height: CGFloat.leastNonzeroMagnitude), for: .aspectFill)
//ä½¿ç”¨KingFisherçš„åœ–ç‰‡è®Šå½¢åŠŸèƒ½ï¼Œå·²å¯¬ç‚ºåŸºæº–ï¼Œé«˜åº¦è‡ªç”±

imageView.contentMode = .redraw
//contentModeä½¿ç”¨redrawå¡«æ»¿

imageView.image = sourceImage
//è³¦äºˆåœ–ç‰‡

imageViewConstraints.constant = (ratio - (sourceImage?.size.height ?? 0))
imageView.layoutIfNeeded()
imageView.sizeToFit()
//é€™ä¸€å¡Šæ˜¯æˆ‘å»æ”¹è®Š imageViewçš„Constraintsï¼Œè©³æƒ…å¯çœ‹æ–‡æœ«å®Œæ•´ç¯„ä¾‹
```

ä»¥ä¸Šå°±æ˜¯é‡å°åœ–ç‰‡åšçš„è™•ç†

_è£åœ–éƒ¨åˆ†ä½¿ç”¨Kingfisherå¹«åŠ©æˆ‘å€‘ï¼Œä¹Ÿå¯æ›¿æ›æˆå…¶ä»–å¥—ä»¶æˆ–è‡ªåˆ»æ–¹æ³•_

ç¬¬äºŒéƒ¨åˆ†ï¼Œé€²å…¥é‡é»ç›´æ¥çœ‹Code
```swift
if #available(iOS 11.0, *) {
    //iOS 11ä¹‹å¾Œæ‰æ”¯æ´
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if let faceObservations = request.results as? [VNFaceObservation] {
            //è¾¨è­˜åˆ°çš„è‡‰è‡‰å€‘
            
            DispatchQueue.main.async {
                //æ“ä½œUIVIEWï¼Œåˆ‡å›ä¸»åŸ·è¡Œç·’
                let size = self.imageView.frame.size
                
                faceObservations.forEach({ (faceObservation) in
                    //åæ¨™ç³»è½‰æ›
                    let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
                    let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
                    let transRect =  faceObservation.boundingBox.applying(translate).applying(transform)
                    
                    let markerView = UIView(frame: transRect)
                    markerView.backgroundColor = UIColor.init(red: 0/255, green: 255/255, blue: 0/255, alpha: 0.3)
                    self.imageView.addSubview(markerView)
                })
            }
        } else {
            print("æœªåµæ¸¬åˆ°ä»»ä½•è‡‰")
        }
    }
    
    //è¾¨è­˜è«‹æ±‚
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        //è¾¨è­˜éœ€è¦æ™‚é–“ï¼Œæ‰€ä»¥æ”¾å…¥èƒŒæ™¯å­åŸ·è¡Œç·’åŸ·è¡Œï¼Œé¿å…ç•¶å‰ç•«é¢å¡ä½
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("Throwsï¼š\(error)")
        }
    }
  
} else {
    //
    print("ä¸æ”¯æ´")
}

```

ä¸»è¦è¦æ³¨æ„çš„æ˜¯ï¼Œåæ¨™ç³»è½‰æ›éƒ¨åˆ†ï¼›è¾¨è­˜å‡ºä¾†çš„çµæœæ˜¯Imageçš„åŸå§‹åº§æ¨™ï¼›æˆ‘å€‘é ˆå°‡å®ƒè½‰æ›æˆåŒ…åœ¨å¤–é¢çš„ImageViewçš„å¯¦éš›åº§æ¨™æ‰èƒ½æ­£ç¢ºåœ°ä½¿ç”¨å®ƒï¼
#### å†ä¾†æˆ‘å€‘ä¾†åšä»Šå¤©çš„é‡é ­æˆ² â€” ä¾ç…§äººè‡‰çš„ä½ç½®è£åˆ‡å‡ºå¤§é ­è²¼çš„æ­£ç¢ºä½ç½®
```swift
let ratio = UIScreen.main.bounds.size.width
//é€™é‚Šæ˜¯å› ç‚ºæˆ‘UIIMAGEVIEW é‚£é‚Šè¨­å®šå·¦å³å°é½Š0ï¼Œå¯¬é«˜æ¯”1:1ï¼Œè©³æƒ…å¯çœ‹æ–‡æœ«å®Œæ•´ç¯„ä¾‹

let sourceImage = UIImage(named: "Demo")

imageView.contentMode = .scaleAspectFill
//ä½¿ç”¨scaleAspectFillæ¨¡å¼å¡«æ»¿

imageView.image = sourceImage
//ç›´æ¥è³¦äºˆåŸåœ–ç‰‡ï¼Œæˆ‘å€‘ä¹‹å¾Œå†æ“ä½œ

if let image = sourceImage,#available(iOS 11.0, *),let ciImage = CIImage(image: image) {
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if request.results?.count == 1,let faceObservation = request.results?.first as? VNFaceObservation {
            //ã„§å¼µè‡‰
            let size = CGSize(width: ratio, height: ratio)
            
            let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
            let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
            let finalRect =  faceObservation.boundingBox.applying(translate).applying(transform)
            
            let center = CGPoint(x: (finalRect.origin.x + finalRect.width/2 - size.width/2), y: (finalRect.origin.y + finalRect.height/2 - size.height/2))
            //é€™è£¡æ˜¯è¨ˆç®—è‡‰çš„ç¯„åœä¸­é–“é»ä½ç½®
            
            let newImage = image.kf.resize(to: size, for: .aspectFill).kf.crop(to: size, anchorOn: center)
            //å°‡åœ–ç‰‡ä¾ç…§ä¸­é–“é»è£åˆ‡
            
            DispatchQueue.main.async {
                //æ“ä½œUIVIEWï¼Œåˆ‡å›ä¸»åŸ·è¡Œç·’
                self.imageView.image = newImage
            }
        } else {
            print("åµæ¸¬åˆ°å¤šå¼µè‡‰æˆ–æ²’æœ‰åµæ¸¬åˆ°è‡‰")
        }
    }
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("Throwsï¼š\(error)")
        }
    }
} else {
    print("ä¸æ”¯æ´")
}
```

é“ç†è·Ÿæ¨™è¨˜äººè‡‰ä½ç½®å·®ä¸å¤šï¼Œå·®åˆ¥åœ¨å¤§é ­è²¼çš„éƒ¨åˆ†æ˜¯å›ºå®šå°ºå¯¸(å¦‚:300x300)ï¼Œæ‰€ä»¥æˆ‘å€‘ç•¥éå‰é¢éœ€è¦è®“Imageé©æ‡‰ImageViewçš„ç¬¬ä¸€éƒ¨åˆ†

å¦ä¸€å€‹å·®åˆ¥æ˜¯æˆ‘å€‘è¦å¤šè¨ˆç®—äººè‡‰ç¯„åœçš„ä¸­å¿ƒé»ï¼Œä¸¦ä»¥é€™å€‹ä¸­å¿ƒé»ç‚ºæº–åšè£åˆ‡åœ–ç‰‡


![ç´…é»ç‚ºè‡‰çš„ç¯„åœä¸­å¿ƒé»](/assets/9a9aa892f9a9/1*civytcKOguHfVFHYPVWecA.png "ç´…é»ç‚ºè‡‰çš„ç¯„åœä¸­å¿ƒé»")

ç´…é»ç‚ºè‡‰çš„ç¯„åœä¸­å¿ƒé»
#### å®Œæˆæ•ˆæœåœ–ï¼š


![é “ä¸¹å‰çš„é‚£ä¸€ç§’æ˜¯åŸå§‹åœ–ä½ç½®](/assets/9a9aa892f9a9/1*WocYjt0xLkqtGVilxfT2LA.gif "é “ä¸¹å‰çš„é‚£ä¸€ç§’æ˜¯åŸå§‹åœ–ä½ç½®")

é “ä¸¹å‰çš„é‚£ä¸€ç§’æ˜¯åŸå§‹åœ–ä½ç½®
### å®Œæ•´APPç¯„ä¾‹:


![](/assets/9a9aa892f9a9/1*J8oByw8gBCamIac2TkT1SA.gif)


ç¨‹å¼ç¢¼å·²ä¸Šå‚³è‡³Githubï¼š [è«‹é»æ­¤](https://github.com/zhgchgli0718/VisionDemo)


[![Like Z Realm's work](https://button.like.co/images/og/likebutton.png "Like Z Realm's work")](https://button.like.co/zhgchgli)


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact) ã€‚



+-----------------------------------------------------------------------------------+

| **[View original post on Medium](https://medium.com/zrealm-ios-dev/vision-%E5%88%9D%E6%8E%A2-app-%E9%A0%AD%E5%83%8F%E4%B8%8A%E5%82%B3-%E8%87%AA%E5%8B%95%E8%AD%98%E5%88%A5%E4%BA%BA%E8%87%89%E8%A3%81%E5%9C%96-swift-9a9aa892f9a9) - Converted by [ZhgChgLi](https://zhgchg.li)/[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown)** |

+-----------------------------------------------------------------------------------+
