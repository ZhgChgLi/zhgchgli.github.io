---
title: iOS â‰¥ 10 Notification Service Extension æ‡‰ç”¨ (Swift)
author: ZhgChgLi
date: 2018-10-15T15:44:01.193+0000
last_modified_at: 2021-02-24T01:26:53.094+0000
categories: ZRealm Dev.
tags: [swift,push-notification,notificationservice,ios,ios-app-development]
description: åœ–ç‰‡æ¨æ’­ã€æ¨æ’­é¡¯ç¤ºçµ±è¨ˆã€æ¨æ’­é¡¯ç¤ºå‰è™•ç†
image:
  path: assets/cb6eba52a342/1*8juoKO7BZiT3PQjqufWcrA.jpeg
render_with_liquid: false
---

### iOS â‰¥ 10 Notification Service Extension æ‡‰ç”¨ \(Swift\)

åœ–ç‰‡æ¨æ’­ã€æ¨æ’­é¡¯ç¤ºçµ±è¨ˆã€æ¨æ’­é¡¯ç¤ºå‰è™•ç†

é—œæ–¼åŸºç¤çš„æ¨æ’­å»ºç½®ã€æ¨æ’­åŸç†ï¼›ç¶²è·¯è³‡æ–™å¾ˆå¤šï¼Œé€™é‚Šå°±ä¸å†è«–è¿°ï¼Œæœ¬ç¯‡ä¸»è¦é‡é»åœ¨å¦‚ä½•è®“APPæ”¯æ´åœ–ç‰‡æ¨æ’­åŠé‹ç”¨æ–°ç‰¹æ€§é”æˆæ›´ç²¾æº–çš„æ¨æ’­é¡¯ç¤ºçµ±è¨ˆï¼


![](/assets/cb6eba52a342/1*8juoKO7BZiT3PQjqufWcrA.jpeg)


å¦‚ä¸Šåœ–æ‰€ç¤ºï¼ŒNotification Service Extensionè®“ä½ åœ¨APPæ”¶åˆ°æ¨æ’­å¾Œèƒ½é‡å°æ¨æ’­åšé è™•ç†ï¼Œç„¶å¾Œæ‰é¡¯ç¤ºæ¨æ’­å…§å®¹

å®˜æ–¹æ–‡ä»¶å¯«åˆ°ï¼Œæˆ‘å€‘é‡å°æ¨æ’­é€²ä¾†çš„å…§å®¹åšè™•ç†æ™‚ï¼Œè™•ç†æ™‚é™å¤§ç´„30ç§’é˜ï¼Œå¦‚æœè¶…é30ç§’é‚„æ²’CallBackï¼Œæ¨æ’­å°±æœƒç¹¼çºŒåŸ·è¡Œï¼Œå‡ºç¾åœ¨ä½¿ç”¨è€…çš„æ‰‹æ©Ÿï¼
#### æ”¯æ´åº¦

iOS â‰¥ 10\.0
#### 30ç§’å¯ä»¥å¹¹å˜›ï¼Ÿ
- \(ç›®æ¨™1\) å¾æ¨æ’­å…§å®¹çš„åœ–ç‰‡é€£çµæ¬„ä½ä¸‹è¼‰åœ–ç‰‡å›ä¾†ï¼Œä¸¦é™„åŠ åˆ°æ¨æ’­å…§å®¹ä¸ŠğŸ†



![](/assets/cb6eba52a342/1*dd2kRizi6v-AIXcMWourow.png)

- \(ç›®æ¨™2\) çµ±è¨ˆæ¨æ’­æœ‰ç„¡é¡¯ç¤ºğŸ†
- æ¨æ’­å…§å®¹ä¿®æ”¹ã€é‡çµ„å…§å®¹
- æ¨æ’­å…§å®¹åŠ è§£å¯†\(è§£å¯†\)é¡¯ç¤º
- _æ±ºå®šæ¨æ’­è¦ä¸è¦é¡¯ç¤ºï¼Ÿ_ =>> **ç­”æ¡ˆï¼šä¸è¡Œ**

#### é¦–å…ˆï¼Œå¾Œç«¯æ¨æ’­ç¨‹å¼çš„ Payload éƒ¨åˆ†

å¾Œç«¯åœ¨æ¨æ’­æ™‚çš„çµæ§‹è¦å¤šåŠ ä¸Šä¸€è¡Œ `â€œmutable-content":1` ç³»çµ±æ”¶åˆ°æ¨æ’­æ‰æœƒåŸ·è¡ŒNotification Service Extension
```
{
    "aps": {
        "alert": {
            "title": "æ–°æ–‡ç« æ¨è–¦çµ¦æ‚¨",
            "body": "ç«‹å³æŸ¥çœ‹"
        },
        "mutable-content":1,
        "sound": "default",
        "badge": 0
    }
}
```
#### Andâ€¦ ç¬¬ä¸€æ­¥ï¼Œç‚ºå°ˆæ¡ˆæ–°å»ºä¸€å€‹Target


![**Step 1\.** Xcode \-> File \-> New \-> Target](/assets/cb6eba52a342/1*ZjPVTxLR6ywAdk70Y7_J7A.png)

**Step 1\.** Xcode \-> File \-> New \-> Target


![**Step 2\.** iOS \-> Notification Service Extension \-> Next](/assets/cb6eba52a342/1*2KRusR8MJUim7UH1CmS7pw.png)

**Step 2\.** iOS \-> Notification Service Extension \-> Next


![**Step 3\.** è¼¸å…¥Product Name \-> Finish](/assets/cb6eba52a342/1*sAuzxJPpohTGp-KV13yupg.png)

**Step 3\.** è¼¸å…¥Product Name \-> Finish


![**Step 4\.** é»é¸ Activate](/assets/cb6eba52a342/1*3DF_fMQLSrGxTbmLY6CJAg.png)

**Step 4\.** é»é¸ Activate

**ç¬¬äºŒæ­¥ï¼Œæ’°å¯«æ¨æ’­å…§å®¹è™•ç†ç¨‹å¼**


![æ‰¾åˆ°Product Name/NotificationService\.swiftæª”](/assets/cb6eba52a342/1*UsCd2btDPK6GWKrYEA9LbQ.png)

æ‰¾åˆ°Product Name/NotificationService\.swiftæª”
```swift
import UserNotifications

class NotificationService: UNNotificationServiceExtension {

    var contentHandler: ((UNNotificationContent) -> Void)?
    var bestAttemptContent: UNMutableNotificationContent?

    override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
        self.contentHandler = contentHandler
        bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
        
        if let bestAttemptContent = bestAttemptContent {
            // Modify the notification content here...
            // æ¨æ’­å…§å®¹åœ¨é€™è™•ç†ï¼ŒLoad åœ–ç‰‡å›ä¾†
            bestAttemptContent.title = "\(bestAttemptContent.title) [modified]"
            
            contentHandler(bestAttemptContent)
        }
    }
    
    override func serviceExtensionTimeWillExpire() {
        // Called just before the extension will be terminated by the system.
        // Use this as an opportunity to deliver your "best attempt" at modified content, otherwise the original push payload will be used.
        // è¦é€¾æ™‚äº†ï¼Œä¸ç®¡åœ–ç‰‡ åªæ”¹æ¨™é¡Œå…§å®¹å°±å¥½
        if let contentHandler = contentHandler, let bestAttemptContent =  bestAttemptContent {
            contentHandler(bestAttemptContent)
        }
    }

}
```

å¦‚ä¸Šç¨‹å¼ç¢¼ï¼ŒNotificationServiceæœ‰å…©å€‹æ¥å£ï¼›ç¬¬ä¸€å€‹æ˜¯ `didReceive` ç•¶æœ‰æ¨æ’­é€²ä¾†æ™‚æœƒè§¸ç™¼é€™å€‹functionï¼Œå…¶ä¸­ç•¶è™•ç†å®Œç•¢å¾Œéœ€è¦å‘¼å« `contentHandler(bestAttemptContent)` é€™å€‹CallBack Methodå‘ŠçŸ¥ç³»çµ±

å¦‚æœæ™‚é–“éä¹…éƒ½æ²’å‘¼å«CallBack Methodï¼Œå°±æœƒè§¸ç™¼ç¬¬äºŒå€‹ function `serviceExtensionTimeWillExpire()` å·²é€¾æ™‚ï¼ŒåŸºæœ¬ä¸Šå·²å›å¤©ä¹è¡“ï¼Œåªèƒ½åšä¸€äº›æ”¶å°¾çš„å‹•ä½œ\(ä¾‹å¦‚ï¼šå–®ç´”æ”¹æ”¹æ¨™é¡Œã€å…§å®¹ï¼Œä¸Loadç¶²è·¯è³‡æ–™äº†\)
#### å¯¦æˆ°ç¯„ä¾‹

é€™è£¡å‡è¨­æˆ‘å€‘çš„ Payload å¦‚ä¸‹
```
{
    "aps": {
        "alert": {
            "push_id":"2018001",
            "title": "æ–°æ–‡ç« æ¨è–¦çµ¦æ‚¨",
            "body": "ç«‹å³æŸ¥çœ‹",
            "image": "https://d2uju15hmm6f78.cloudfront.net/image/2016/12/04/3113/2018/09/28/trim_153813426461775700_450x300.jpg"
        },
        "mutable-content":1,
        "sound": "default",
        "badge": 0
    }
}
```

ã€Œpush\_idã€è·Ÿã€Œimageã€éƒ½æ˜¯æˆ‘è‡ªè¨‚çš„æ¬„ä½ï¼Œpush\_idç”¨æ–¼è¾¨è­˜æ¨æ’­æ–¹ä¾¿æˆ‘å€‘å‚³å›ä¼ºæœå™¨åšçµ±è¨ˆï¼›image å‰‡æ˜¯æ¨æ’­è¦é™„åŠ çš„åœ–ç‰‡å…§å®¹ä¹‹åœ–ç‰‡ç¶²å€
```swift
override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
    self.contentHandler = contentHandler
    bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
    
    if let bestAttemptContent = bestAttemptContent {
        
        guard let info = request.content.userInfo["aps"] as? NSDictionary,let alert = info["alert"] as? Dictionary<String,String> else {
            contentHandler(bestAttemptContent)
            return
            //æ¨æ’­å…§å®¹æ ¼å¼ä¸å¦‚é æœŸï¼Œä¸è™•ç†
        }
        
        //ç›®æ¨™2:
        //å›å‚³Serverï¼Œå‘ŠçŸ¥æ¨æ’­æœ‰é¡¯ç¤º
        if let push_id = alert["push_id"],let url = URL(string: "é¡¯ç¤ºçµ±è¨ˆAPIç¶²å€") {
            var request = URLRequest(url: url, cachePolicy: .reloadIgnoringLocalCacheData, timeoutInterval: 30)
            request.httpMethod = "POST"
            request.addValue(UserAgent, forHTTPHeaderField: "User-Agent")
            
            var httpBody = "push_id=\(push_id)"
            request.addValue("application/x-www-form-urlencoded", forHTTPHeaderField: "Content-Type")
            request.httpBody = httpBody.data(using: .utf8)
            
            let task = URLSession.shared.dataTask(with: request) { (data, response, error) in
                
            }
            DispatchQueue.global().async {
                task.resume()
                //ç•°æ­¥è™•ç†ï¼Œä¸ç®¡ä»–
            }
        }
        
        //ç›®æ¨™1:
        guard let imageURLString = alert["image"],let imageURL = URL(string: imageURLString) else {
            contentHandler(bestAttemptContent)
            return
            //è‹¥ç„¡é™„åœ–ç‰‡ï¼Œå‰‡ä¸ç”¨ç‰¹åˆ¥è™•ç†
        }
        
        
        let dataTask = URLSession.shared.dataTask(with: imageURL) { (data, response, error) in
            guard let fileURL = NSURL(fileURLWithPath: NSTemporaryDirectory()).appendingPathComponent(imageURL.lastPathComponent) else {
                contentHandler(bestAttemptContent)
                return
            }
            guard (try? data?.write(to: fileURL)) != nil else {
                contentHandler(bestAttemptContent)
                return
            }
            
            guard let attachment = try? UNNotificationAttachment(identifier: "image", url: fileURL, options: nil) else {
                contentHandler(bestAttemptContent)
                return
            }
            //ä»¥ä¸Šç‚ºè®€å–åœ–ç‰‡é€£çµä¸¦ä¸‹è¼‰åˆ°æ‰‹æ©Ÿä¸¦æ”¾å…¥å»ºç«‹UNNotificationAttachment
            
            bestAttemptContent.categoryIdentifier = "image"
            bestAttemptContent.attachments = [attachment]
            //ç‚ºæ¨æ’­æ·»åŠ é™„ä»¶åœ–ç‰‡
            
            bestAttemptContent.body = (bestAttemptContent.body == "") ? ("ç«‹å³æŸ¥çœ‹") : (bestAttemptContent.body)
            //å¦‚æœbodyç‚ºç©ºï¼Œå‰‡ç”¨é è¨­å…§å®¹"ç«‹å³æŸ¥çœ‹"
            
            contentHandler(bestAttemptContent)
        }
        dataTask.resume()
    }
}
```

`serviceExtensionTimeWillExpire` çš„éƒ¨åˆ†æˆ‘æ²’ç‰¹åˆ¥è™•ç†ä»€éº¼ï¼Œå°±ä¸è²¼äº†ï¼›é—œéµé‚„æ˜¯ä¸Šè¿° `didReceive` çš„ç¨‹å¼ç¢¼

å¯ä»¥çœ‹åˆ°ç•¶æ¥å—åˆ°æœ‰æ¨æ’­é€šçŸ¥æ™‚ï¼Œæˆ‘å€‘å…ˆCall Apiå‘Šè¨´å¾Œç«¯æœ‰æ”¶åˆ°ä¸¦å°‡é¡¯ç¤ºæ¨æ’­äº†ï¼Œæ–¹ä¾¿æˆ‘å€‘å¾Œå°åšæ¨æ’­çµ±è¨ˆï¼›ç„¶å¾Œè‹¥æœ‰é™„åŠ åœ–ç‰‡å†å°åœ–ç‰‡é€²è¡Œè™•ç†ï¼
#### In\-Appç‹€æ…‹æ™‚ï¼š

ã„§æ¨£æœƒè§¸ç™¼Notification Service Extension didReceive å†è§¸ç™¼AppDelegateçš„ **func** application\( **\_** application: UIApplication, didReceiveRemoteNotification userInfo: \[AnyHashable : **Any** \], fetchCompletionHandler completionHandler: **@escaping** \(UIBackgroundFetchResult\) \-> Void\) æ–¹æ³•
#### é™„è¨»ï¼šé—œæ–¼åœ–ç‰‡æ¨æ’­çš„éƒ¨åˆ†ä½ é‚„å¯ä»¥â€¦\.

ä½¿ç”¨ Notification Content Extension è‡ªè¨‚æ¨æ’­æŒ‰å£“æ™‚è¦é¡¯ç¤ºçš„UIView\(å¯ä»¥è‡ªå·±åˆ»\)ï¼Œé‚„æœ‰æŒ‰å£“çš„å‹•ä½œ

å¯åƒè€ƒé€™ç¯‡ï¼š [iOS10æ¨é€é€šçŸ¥è¿›é˜¶\(Notification Extensionï¼‰](https://www.jianshu.com/p/78ef7bc04655#UNNotificationContentExtension-%E9%80%9A%E7%9F%A5%E5%86%85%E5%AE%B9%E6%89%A9%E5%B1%95){:target="_blank"}

iOS 12ä¹‹å¾Œæ”¯æ´æ›´å¤šå‹•ä½œè™•ç†ï¼š [iOS 12 æ–°é€šçŸ¥åŠŸèƒ½ï¼šæ·»åŠ äº’å‹•æ€§ åœ¨é€šçŸ¥ä¸­å¯¦ä½œè¤‡é›œåŠŸèƒ½](https://www.appcoda.com.tw/user-notifications-ios12/){:target="_blank"}

Notification Content Extensionçš„éƒ¨åˆ†ï¼Œæˆ‘åªæ‹‰äº†ä¸€å€‹èƒ½å±•ç¤ºåœ–ç‰‡æ¨æ’­çš„UIView ä¸¦æ²’æœ‰åšå¤ªå¤šç¢ç£¨ï¼š


![[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/cb6eba52a342/1*SepeUiS7CN7xmGFxariPjA.png)

[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}


[![Like Z Realm's work](https://button.like.co/images/og/likebutton.png "Like Z Realm's work")](https://button.like.co/zhgchgli){:target="_blank"}


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_Converted [Medium Post](https://medium.com/zrealm-ios-dev/ios-10-notification-service-extension-%E6%87%89%E7%94%A8-swift-cb6eba52a342){:target="_blank"} by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
