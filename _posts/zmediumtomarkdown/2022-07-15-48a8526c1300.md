---
title: iOS ç‚ºå¤šèªç³»å­—ä¸²è²·ä»½ä¿éšªå§ï¼
author: ZhgChgLi
date: 2022-07-15T10:10:04.867Z
last_modified_at: 2022-07-15T14:54:56.594Z
categories: ZRealm Dev.
tags: [ios-app-development,localization,unit-testing,xcode,swift]
description: ç¢ºä¿ Localizable.strings æ–‡å­—æª”ä¸è¢«æ„å¤–æ”¹å£
image:
  path: assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg
render_with_liquid: false
---

### iOS ç‚ºå¤šèªç³»å­—ä¸²è²·ä»½ä¿éšªå§ï¼

ä½¿ç”¨ SwifGen & UnitTest ç¢ºä¿å¤šèªç³»æ“ä½œçš„å®‰å…¨


![Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}{:target="_blank"}](/assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg)

Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)
### å•é¡Œ
#### ç´”æ–‡å­—æª”æ¡ˆ


![](/assets/48a8526c1300/1*9hxfi00_HcXy0wUMIyU8gA.png)


iOS çš„å¤šèªç³»è™•ç†æ–¹å¼æ˜¯ Localizable\.strings ç´”æ–‡å­—æª”æ¡ˆï¼Œä¸åƒ Android æ˜¯é€é XML æ ¼å¼ä¾†ç®¡ç†ï¼›æ‰€ä»¥åœ¨æ—¥å¸¸é–‹ç™¼ä¸Šå°±æœƒæœ‰ä¸å°å¿ƒæŠŠèªç³»æª”æ”¹å£æˆ–æ˜¯æ¼åŠ çš„é¢¨éšªå†åŠ ä¸Šå¤šèªç³»ä¸æœƒåœ¨ Build Time æª¢æŸ¥å‡ºéŒ¯èª¤ï¼Œå¾€å¾€éƒ½æ˜¯ä¸Šç·šå¾Œï¼ŒæŸå€‹åœ°å€çš„ä½¿ç”¨è€…å›å ±æ‰ç™¼ç¾å•é¡Œï¼Œæœƒå¤§å¤§é™ä½ä½¿ç”¨è€…ä¿¡å¿ƒç¨‹åº¦ã€‚

ä¹‹å‰è¡€æ·‹æ·‹çš„æ¡ˆä¾‹ï¼Œå¤§å®¶ Swift å¯«çš„å¤ªç¿’æ…£å¿˜è¨˜ Localizable\.strings è¦åŠ  `;` ï¼Œå°è‡´æŸå€‹èªç³»ä¸Šç·šå¾Œå¾æ¼æ‰ `;` çš„èªå¥å¾€å¾Œå…¨å£æ‰ï¼›æœ€å¾Œç·Šæ€¥ Hotfix æ‰åŒ–éšªç‚ºå¤·ã€‚
#### **å¤šèªç³»æœ‰å•é¡Œå°±æœƒç›´æ¥æŠŠ Key é¡¯ç¤ºçµ¦ä½¿ç”¨è€…**


![](/assets/48a8526c1300/1*BwaK_5ac2gxAmrzt4w-oBA.png)


å¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œå‡è¨­ `DESCRIPTION` Key æ¼åŠ ï¼Œ Appå°±æœƒç›´æ¥é¡¯ç¤º `DESCRIPTION` çµ¦ä½¿ç”¨è€…ã€‚
### æª¢æŸ¥éœ€æ±‚
- Localizable\.strings æ ¼å¼æ­£ç¢ºæª¢æŸ¥ \(æ›è¡Œçµå°¾éœ€åŠ ä¸Š `;` ã€åˆæ³• Key Value å°æ‡‰\)
- ç¨‹å¼ç¢¼ä¸­æœ‰å–ç”¨çš„å¤šèªç³» Key è¦åœ¨ Localizable\.strings æª”æœ‰å°æ‡‰å®šç¾©
- Localizable\.strings æª”å„å€‹èªç³»éƒ½è¦æœ‰ç›¸æ‡‰çš„ Key Value ç´€éŒ„
- Localizable\.strings æª”ä¸èƒ½æœ‰é‡è¤‡çš„ Key \(å¦å‰‡ Value æœƒè¢«æ„å¤–è¦†è“‹\)

### è§£æ±ºæ–¹æ¡ˆ
#### ä½¿ç”¨ Swift æ’°å¯«å®Œæ•´æª¢æŸ¥å·¥å…·

ä¹‹å‰çš„åšæ³•æ˜¯ã€Œ [Xcode ç›´æ¥ä½¿ç”¨ Swift æ’°å¯« Shell Scriptï¼](../41c49a75a743) ã€åƒè€ƒ [Localize ğŸ](https://github.com/freshOS/Localize){:target="_blank"} å·¥å…·ä½¿ç”¨ Swift é–‹ç™¼ Command Line Tool å¾å¤–éƒ¨åšå¤šèªç³»æª”æ¡ˆæª¢æŸ¥ï¼Œå†æŠŠè…³æœ¬æ”¾åˆ° Build Phases Run Script ä¸­ï¼Œåœ¨ Build Time åŸ·è¡Œæª¢æŸ¥ã€‚

**å„ªé»ï¼š** 
æª¢æŸ¥ç¨‹å¼æ˜¯ç”±å¤–éƒ¨æ³¨å…¥ï¼Œä¸ä¾è³´åœ¨å°ˆæ¡ˆä¸Šï¼Œå¯ä»¥ä¸é€é XCodeã€ä¸éœ€ Build å°ˆæ¡ˆä¹Ÿèƒ½åŸ·è¡Œæª¢æŸ¥ã€æª¢æŸ¥åŠŸèƒ½èƒ½ç²¾ç¢ºåˆ°å“ªå€‹æª”æ¡ˆçš„ç¬¬å¹¾è¡Œï¼›å¦å¤–é‚„èƒ½åš Format åŠŸèƒ½ \(æ’åºå¤šèªç³» Key A\->Z\)ã€‚

**ç¼ºé»ï¼š** 
å¢åŠ  Build Time \(\+ ~= 3 mins\)ã€æµç¨‹ç™¼æ•£ï¼Œè…³æœ¬æœ‰å•é¡Œæˆ–éœ€å› æ‡‰å°ˆæ¡ˆæ¶æ§‹èª¿æ•´æ™‚é›£ä»¥äº¤æ¥ç¶­è­·ï¼Œå› é€™å¡Šä¸åœ¨å°ˆæ¡ˆå…§ï¼Œé™¤äº†åŠ å…¥é€™æ®µæª¢æŸ¥é€²ä¾†çš„äººçŸ¥é“æ•´å€‹é‚è¼¯ï¼Œå…¶ä»–å”ä½œè€…å¾ˆé›£ç¢°è§¸åˆ°é€™å¡Šã€‚
> æœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥åƒè€ƒä¹‹å‰çš„é‚£ç¯‡æ–‡ç« ï¼Œæœ¬ç¯‡ä¸»è¦ä»‹ç´¹çš„æ–¹å¼æ˜¯é€é XCode 13\+SwiftGen\+UnitTest ä¾†é”æˆæª¢æŸ¥ Localizable\.strings çš„æ‰€æœ‰åŠŸèƒ½ã€‚

#### XCode 13 å…§å»º Build Time æª¢æŸ¥ Localizable\.strings æª”æ¡ˆæ ¼å¼æ­£ç¢ºæ€§


![](/assets/48a8526c1300/1*p28LgNGZYh6S8T2s2UH8lg.png)


å‡ç´š XCode 13 ä¹‹å¾Œå°±å…§å»ºäº† Build Time æª¢æŸ¥ Localizable\.strings æª”æ¡ˆæ ¼å¼çš„åŠŸèƒ½ï¼Œç¶“æ¸¬è©¦æª¢æŸ¥çš„è¦æ ¼ç›¸ç•¶å®Œæ•´ï¼Œé™¤äº†æ¼æ‰ `;` å¤–å¦‚æœ‰å¤šé¤˜ç„¡æ„ç¾©çš„å­—ä¸²ä¹Ÿæœƒè¢«æ“‹ä¸‹ä¾†ã€‚
#### ä½¿ç”¨ SwiftGen å–ä»£åŸå§‹ NSLocalizedString String Base å­˜å–æ–¹å¼

[SwiftGen](https://github.com/SwiftGen/SwiftGen){:target="_blank"} èƒ½å¹«åŠ©æˆ‘å€‘å°‡åŸæœ¬çš„ NSLocalizedString String å­˜å–æ–¹å¼æ”¹æˆ Object å­˜å–ï¼Œé˜²æ­¢ä¸å°å¿ƒæ‰“éŒ¯å­—ã€å¿˜è¨˜åœ¨ Key å®£å‘Šçš„æƒ…æ³å‡ºç¾ã€‚


[![[**GitHub \- SwiftGen/SwiftGen: The Swift code generator for your assets, storyboardsâ€¦**](https://github.com/SwiftGen/SwiftGen){:target="_blank"}{:target="_blank"}{:target="_blank"}{:target="_blank"} 
[_SwiftGen is a tool to automatically generate Swift code for resources of your projects \(like images, localised stringsâ€¦_ github\.com](https://github.com/SwiftGen/SwiftGen)](https://repository-images.githubusercontent.com/39166950/1826ed00-d6cf-11ea-9736-34829910d1e6 "[**GitHub \- SwiftGen/SwiftGen: The Swift code generator for your assets, storyboardsâ€¦**](https://github.com/SwiftGen/SwiftGen) 
[_SwiftGen is a tool to automatically generate Swift code for resources of your projects \(like images, localised stringsâ€¦_ github\.com](https://github.com/SwiftGen/SwiftGen)")](https://github.com/SwiftGen/SwiftGen)


SwiftGen æ ¸å¿ƒä¹Ÿæ˜¯ Command Line Toolï¼›ä½†æ˜¯é€™å·¥å…·åœ¨æ¥­ç•Œè »æµè¡Œçš„è€Œä¸”æœ‰å®Œæ•´çš„æ–‡ä»¶åŠç¤¾ç¾¤è³‡æºåœ¨ç¶­è­·ï¼Œä¸å¿…å®³æ€•å°å…¥é€™å€‹å·¥å…·å¾ŒçºŒé›£ç¶­è­·çš„å•é¡Œã€‚

[**Installation**](https://github.com/SwiftGen/SwiftGen#installation){:target="_blank"}

å¯ä¾ç…§æ‚¨çš„ç’°å¢ƒæˆ– CI/CD æœå‹™è¨­å®šå»é¸æ“‡å®‰è£æ–¹å¼ï¼Œé€™é‚Š Demo ç›´æ¥ç”¨æœ€ç›´æ¥çš„ CocoaPods é€²è¡Œå®‰è£ã€‚
> è«‹æ³¨æ„ SwiftGen ä¸¦ä¸æ˜¯çœŸçš„ CocoaPodsï¼Œä»–ä¸æœƒè·Ÿå°ˆæ¡ˆä¸­çš„ç¨‹å¼ç¢¼æœ‰ä»»ä½•ä¾è³´ï¼›ä½¿ç”¨ CocoaPods å®‰è£ SwiftGen å–®ç´”åªæ˜¯é€éå®ƒä¸‹è¼‰é€™å€‹ Command Line Tool åŸ·è¡Œæª”å›ä¾†ã€‚


åœ¨ `podfile` ä¸­åŠ å…¥ swiftgen podï¼š
```
pod 'SwiftGen', '~> 6.0'
```

**Init**

`pod install` ä¹‹å¾Œæ‰“é–‹ Terminal `cd` åˆ°å°ˆæ¡ˆä¸‹
```
/L10NTests/Pods/SwiftGen/bin/swiftGen config init
```

init `swiftgen\.yml` è¨­å®šæª”ï¼Œä¸¦æ‰“é–‹å®ƒ
```yaml
strings:
  - inputs:
      - "L10NTests/Supporting Files/zh-Hant.lproj/Localizable.strings"
    outputs:
      templateName: structured-swift5
      output: "L10NTests/Supporting Files/SwiftGen-L10n.swift"
      params:
        enumName: "L10n"
```

è²¼ä¸Šä¸¦ä¿®æ”¹æˆç¬¦åˆæ‚¨å°ˆæ¡ˆçš„æ ¼å¼ï¼š

**inputs:** å°ˆæ¡ˆèªç³»æª”æ¡ˆä½ç½® \(å»ºè­°æŒ‡å®š DevelopmentLocalization èªç³»çš„èªç³»æª”\)

**outputs:** 
**output:** è½‰æ›çµæœçš„ swift æª”æ¡ˆä½ç½®
**params: enumName:** ç‰©ä»¶åç¨±
**templateName:** è½‰æ›æ¨¡æ¿

å¯ä»¥ä¸‹ `swiftGen template list` å–å¾—å…§å»ºçš„æ¨¡æ¿åˆ—è¡¨


![flat v\.s\. structured](/assets/48a8526c1300/1*J5ZOMW6BC-fDqSlh-My2Pg.jpeg)

flat v\.s\. structured

å·®åˆ¥åœ¨å¦‚æœ Key é¢¨æ ¼æ˜¯ `XXX\.YYY\.ZZZ` flat æ¨¡æ¿æœƒè½‰æ›æˆå°é§å³°ï¼›structured æ¨¡æ¿æœƒç…§åŸå§‹é¢¨æ ¼è½‰æ›æˆ `XXX\.YYY\.ZZZ` ç‰©ä»¶ã€‚

ç´” Swift å°ˆæ¡ˆå¯ç›´æ¥ä½¿ç”¨å…§å»ºæ¨¡æ¿ï¼Œä½†è‹¥æ˜¯ Swift æ·· OC çš„å°ˆæ¡ˆå°±éœ€è¦è‡ªè¡Œå®¢è£½åŒ–æ¨¡æ¿ï¼š
```
// swiftlint:disable all
// Generated using SwiftGen â€” https://github.com/SwiftGen/SwiftGen

{% if tables.count > 0 %}
{% set accessModifier %}{% if param.publicAccess %}public{% else %}internal{% endif %}{% endset %}
import Foundation

// swiftlint:disable superfluous_disable_command file_length implicit_return

// MARK: - Strings

{% macro parametersBlock types %}{% filter removeNewlines:"leading" %}
  {% for type in types %}
    {% if type == "String" %}
    _ p{{forloop.counter}}: Any
    {% else %}
    _ p{{forloop.counter}}: {{type}}
    {% endif %}
    {{ ", " if not forloop.last }}
  {% endfor %}
{% endfilter %}{% endmacro %}
{% macro argumentsBlock types %}{% filter removeNewlines:"leading" %}
  {% for type in types %}
    {% if type == "String" %}
    String(describing: p{{forloop.counter}})
    {% elif type == "UnsafeRawPointer" %}
    Int(bitPattern: p{{forloop.counter}})
    {% else %}
    p{{forloop.counter}}
    {% endif %}
    {{ ", " if not forloop.last }}
  {% endfor %}
{% endfilter %}{% endmacro %}
{% macro recursiveBlock table item %}
  {% for string in item.strings %}
  {% if not param.noComments %}
  {% for line in string.translation|split:"\n" %}
  /// {{line}}
  {% endfor %}
  {% endif %}
  {% if string.types %}
  {{accessModifier}} static func {{string.key|swiftIdentifier:"pretty"|lowerFirstWord|escapeReservedKeywords}}({% call parametersBlock string.types %}) -> String {
    return {{enumName}}.tr("{{table}}", "{{string.key}}", {% call argumentsBlock string.types %})
  }
  {% elif param.lookupFunction %}
  {# custom localization function is mostly used for in-app lang selection, so we want the loc to be recomputed at each call for those (hence the computed var) #}
  {{accessModifier}} static var {{string.key|swiftIdentifier:"pretty"|lowerFirstWord|escapeReservedKeywords}}: String { return {{enumName}}.tr("{{table}}", "{{string.key}}") }
  {% else %}
  {{accessModifier}} static let {{string.key|swiftIdentifier:"pretty"|lowerFirstWord|escapeReservedKeywords}} = {{enumName}}.tr("{{table}}", "{{string.key}}")
  {% endif %}
  {% endfor %}
  {% for child in item.children %}
  {% call recursiveBlock table child %}
  {% endfor %}
{% endmacro %}
// swiftlint:disable function_parameter_count identifier_name line_length type_body_length
{% set enumName %}{{param.enumName|default:"L10n"}}{% endset %}
@objcMembers {{accessModifier}} class {{enumName}}: NSObject {
  {% if tables.count > 1 or param.forceFileNameEnum %}
  {% for table in tables %}
  {{accessModifier}} enum {{table.name|swiftIdentifier:"pretty"|escapeReservedKeywords}} {
    {% filter indent:2 %}{% call recursiveBlock table.name table.levels %}{% endfilter %}
  }
  {% endfor %}
  {% else %}
  {% call recursiveBlock tables.first.name tables.first.levels %}
  {% endif %}
}
// swiftlint:enable function_parameter_count identifier_name line_length type_body_length

// MARK: - Implementation Details

extension {{enumName}} {
  private static func tr(_ table: String, _ key: String, _ args: CVarArg...) -> String {
    {% if param.lookupFunction %}
    let format = {{ param.lookupFunction }}(key, table)
    {% else %}
    let format = {{param.bundle|default:"BundleToken.bundle"}}.localizedString(forKey: key, value: nil, table: table)
    {% endif %}
    return String(format: format, locale: Locale.current, arguments: args)
  }
}
{% if not param.bundle and not param.lookupFunction %}

// swiftlint:disable convenience_type
private final class BundleToken {
  static let bundle: Bundle = {
    #if SWIFT_PACKAGE
    return Bundle.module
    #else
    return Bundle(for: BundleToken.self)
    #endif
  }()
}
// swiftlint:enable convenience_type
{% endif %}
{% else %}
// No string found
{% endif %}
```

ä»¥ä¸Šæä¾›ä¸€å€‹ç¶²è·¯æœé›†ä¾†&å®¢è£½åŒ–éå…¼å®¹ Swift å’Œ OC çš„æ¨¡æ¿ï¼Œå¯è‡ªè¡Œå»ºç«‹ `flat\-swift5\-objc\.stencil` File ç„¶å¾Œè²¼ä¸Šå…§å®¹æˆ– [é»æ­¤ç›´æ¥ä¸‹è¼‰ \.zip](https://gist.github.com/zhgchgli0718/34cc6af6366add93f16632efd5575691/archive/bcccc0fb7367c8f9e58b8453446f0a52631aa8d1.zip){:target="_blank"} ã€‚

ä½¿ç”¨å®¢è£½åŒ–æ¨¡æ¿çš„è©±å°±ä¸æ˜¯ç”¨ templateName äº†ï¼Œè€Œè¦æ”¹å®£å‘Š templatePathï¼š
```yaml
strings:
  - inputs:
      - "L10NTests/Supporting Files/zh-Hant.lproj/Localizable.strings"
    outputs:
      templatePath: "path/to/flat-swift5-objc.stencil"
      output: "L10NTests/Supporting Files/SwiftGen-L10n.swift"
      params:
        enumName: "L10n"
```

å°‡ templatePath è·¯å¾‘æŒ‡å®šåˆ° \.stencil æ¨¡æ¿åœ¨å°ˆæ¡ˆä¸­çš„ä½ç½®å³å¯ã€‚

**Generator**

è¨­å®šå¥½ä¹‹å¾Œå¯ä»¥å›åˆ° Termnial æ‰‹å‹•ä¸‹ï¼š
```
/L10NTests/Pods/SwiftGen/bin/swiftGen
```

åŸ·è¡Œè½‰æ›ï¼Œç¬¬ä¸€æ¬¡è½‰æ›å¾Œè«‹æ‰‹å‹•å¾ Finder å°‡è½‰æ›çµæœæª”æ¡ˆ \(SwiftGen\-L10n\.swift\) æ‹‰åˆ°å°ˆæ¡ˆä¸­ï¼Œç¨‹å¼æ‰èƒ½ä½¿ç”¨ã€‚

**Run Script**


![](/assets/48a8526c1300/1*jbpXqjsF9kROgIqRQG9JcA.png)


åœ¨å°ˆæ¡ˆè¨­å®šä¸­ \-> Build Phases \-> \+ \-> New Run Script Phases \-> è²¼ä¸Šï¼š
```shell
if [[ -f "${PODS_ROOT}/SwiftGen/bin/swiftgen" ]]; then
  echo "${PODS_ROOT}/SwiftGen/bin/swiftgen"
  "${PODS_ROOT}/SwiftGen/bin/swiftgen"
else
  echo "warning: SwiftGen is not installed. Run 'pod install --repo-update' to install it."
fi
```

é€™æ¨£åœ¨æ¯æ¬¡ Build å°ˆæ¡ˆæ™‚éƒ½æœƒè·‘ Generator ç”¢å‡ºæœ€æ–°çš„è½‰æ›çµæœã€‚

**CodeBase ä¸­å¦‚ä½•ä½¿ç”¨?**


![](/assets/48a8526c1300/1*8AiJIfqe5C1r9ESbfF-Y7w.png)

```
L10n.homeTitle
L10n.homeDescription("ZhgChgLi") // with arg
```
> æœ‰äº† Object Access å¾Œå°±ä¸å¯èƒ½å‡ºç¾æ‰“éŒ¯å­—åŠ Code è£¡é¢æœ‰åœ¨ç”¨çš„ Key ä½† Localizable\.strings æª”å¿˜è¨˜å®£å‘Šçš„æƒ…æ³ã€‚
> ä½† SwiftGen åªèƒ½æŒ‡å®šå¾æŸå€‹èªç³»ç”¢ç”Ÿï¼Œæ‰€ä»¥ç„¡æ³•é˜»æ“‹ç”¢ç”Ÿçš„èªç³»æœ‰é€™å€‹ Key ä½†åœ¨å…¶ä»–èªç³»å¿˜è¨˜å®šç¾©çš„ç‹€æ³ï¼›æ­¤ç‹€æ³è¦ç”¨ä¸‹é¢çš„ UnitTest æ‰èƒ½ä¿è­·ã€‚


**è½‰æ›**

è½‰æ›æ‰æ˜¯é€™å€‹å•é¡Œæœ€å›°é›£çš„åœ°æ–¹ï¼Œå› ç‚ºå·²é–‹ç™¼å®Œæˆçš„å°ˆæ¡ˆä¸­å¤§é‡ä½¿ç”¨ NSLocalizedString è¦å°‡å…¶è½‰æ›æˆæ–°çš„ `L10n\.XXX` æ ¼å¼ã€å¦‚æœæ˜¯æœ‰å¸¶åƒæ•¸çš„èªå¥åˆæ›´è¤‡é›œ `String\(format: NSLocalizedString` ï¼Œå¦å¤–å¦‚æœæœ‰æ·· OC é‚„è¦è€ƒæ…® OC çš„èªæ³•èˆ‡ Swift ä¸åŒã€‚

æ²’æœ‰ä»€éº¼ç‰¹åˆ¥çš„è§£æ³•ï¼Œåªèƒ½è‡ªå·±å¯«ä¸€å€‹ Command Line Toolsï¼Œå¯åƒè€ƒ [ä¸Šä¸€ç¯‡æ–‡ç« ](../41c49a75a743) ä¸­ä½¿ç”¨ Swift æƒæå°ˆæ¡ˆç›®éŒ„ã€Parse å‡º NSLocalizedString çš„ Regex æ’°å¯«ä¸€å€‹å°å·¥å…·å»è½‰æ›ã€‚

å»ºè­°ä¸€æ¬¡è½‰æ›ä¸€å€‹æƒ…å¢ƒï¼Œèƒ½ Build éå†è½‰æ›ä¸‹ä¸€å€‹ã€‚
- Swift \-> NSLocalizedString ç„¡åƒæ•¸
- Swift \-> NSLocalizedString æœ‰åƒæ•¸æƒ…æ³
- OC \-> NSLocalizedString ç„¡åƒæ•¸
- OC \-> NSLocalizedString æœ‰åƒæ•¸æƒ…æ³

#### é€é UnitTest æª¢æŸ¥å„èªç³»æª”èˆ‡ä¸»è¦èªç³»æª”æ¡ˆæœ‰æ²’æœ‰ç¼ºæ¼åŠ Key æœ‰ç„¡é‡è¤‡

æˆ‘å€‘å¯ä»¥é€éæ’°å¯« UniTest å¾ Bundle è®€å–å‡º \ `.`  `strings` File å…§å®¹ï¼Œä¸¦åŠ ä»¥æ¸¬è©¦ã€‚

**å¾ Bundle è®€å–å‡º \ `.`  `strings` ä¸¦è½‰æˆç‰©ä»¶ï¼š**
```swift
class L10NTestsTests: XCTestCase {
    
    private var localizations: [Bundle: [Localization]] = [:]
    
    override func setUp() {
        super.setUp()
        
        let bundles = [Bundle(for: type(of: self))]
        
        //
        bundles.forEach { bundle in
            var localizations: [Localization] = []
            
            bundle.localizations.forEach { lang in
                var localization = Localization(lang: lang)
                
                if let lprojPath = bundle.path(forResource: lang, ofType: "lproj"),
                   let lprojBundle = Bundle(path: lprojPath) {
                    
                    let filesInLPROJ = (try? FileManager.default.contentsOfDirectory(atPath: lprojBundle.bundlePath)) ?? []
                    localization.localizableStringFiles = filesInLPROJ.compactMap { fileFullName -> L10NTestsTests.Localization.LocalizableStringFile? in
                        let fileName = URL(fileURLWithPath: fileFullName).deletingPathExtension().lastPathComponent
                        let fileExtension = URL(fileURLWithPath: fileFullName).pathExtension
                        guard fileExtension == "strings" else { return nil }
                        guard let path = lprojBundle.path(forResource: fileName, ofType: fileExtension) else { return nil }
                        
                        return L10NTestsTests.Localization.LocalizableStringFile(name: fileFullName, path: path)
                    }
                    
                    localization.localizableStringFiles.enumerated().forEach { (index, localizableStringFile) in
                        if let fileContent = try? String(contentsOfFile: localizableStringFile.path, encoding: .utf8) {
                            let lines = fileContent.components(separatedBy: .newlines)
                            let pattern = "\"(.*)\"(\\s*)(=){1}(\\s*)\"(.+)\";"
                            let regex = try? NSRegularExpression(pattern: pattern, options: [])
                            let values = lines.compactMap { line -> Localization.LocalizableStringFile.Value? in
                                let range = NSRange(location: 0, length: (line as NSString).length)
                                guard let matches = regex?.firstMatch(in: line, options: [], range: range) else { return nil }
                                let key = (line as NSString).substring(with: matches.range(at: 1))
                                let value = (line as NSString).substring(with: matches.range(at: 5))
                                return Localization.LocalizableStringFile.Value(key: key, value: value)
                            }
                            localization.localizableStringFiles[index].values = values
                        }
                    }
                    
                    localizations.append(localization)
                }
            }
            
            self.localizations[bundle] = localizations
        }
    }
}

private extension L10NTestsTests {
    struct Localization: Equatable {
        struct LocalizableStringFile {
            struct Value {
                let key: String
                let value: String
            }
            
            let name: String
            let path: String
            var values: [Value] = []
        }
        
        let lang: String
        var localizableStringFiles: [LocalizableStringFile] = []
        
        static func == (lhs: Self, rhs: Self) -> Bool {
            return lhs.lang == rhs.lang
        }
    }
}
```

æˆ‘å€‘å®šç¾©æˆ‘å€‘å®šç¾©äº†ä¸€å€‹ `Localization` ä¾†å­˜æ”¾é —æå‡ºä¾†çš„è³‡æ–™ï¼Œå¾ `Bundle` ä¸­å»æ‰¾ `lproj` å†å¾å…¶ä¸­æ‰¾å‡º \ `.`  `strings` ç„¶å¾Œå†ä½¿ç”¨æ­£å‰‡è¡¨ç¤ºæ³•å°‡å¤šèªç³»èªå¥è½‰æ›æˆç‰©ä»¶æ”¾å›åˆ° `Localization` ï¼Œä»¥åˆ©å¾ŒçºŒæ¸¬è©¦ä½¿ç”¨ã€‚

**é€™é‚Šæœ‰å¹¾å€‹éœ€è¦æ³¨æ„çš„ï¼š**
- ä½¿ç”¨ `Bundle\(for: type\(of: self\)\)` å¾ Test Target å–å¾—è³‡æº
- è¨˜å¾—å°‡ Test Target çš„ [STRINGS\_FILE\_OUTPUT\_ENCODING](https://developer.apple.com/forums/thread/71779){:target="_blank"} 
è¨­ç‚º `UTF\-8` ï¼Œå¦å‰‡ä½¿ç”¨ String è®€å–æª”æ¡ˆå…§å®¹æ™‚æœƒå¤±æ•— \(é è¨­æœƒæ˜¯ Biniary\)
- ä½¿ç”¨ String è®€å–è€Œä¸ç”¨ NSDictionary çš„åŸå› æ˜¯ï¼Œæˆ‘å€‘éœ€è¦æ¸¬è©¦é‡è¤‡çš„ Keyï¼Œä½¿ç”¨ NSDictionary æœƒåœ¨è®€å–çš„æ™‚å€™å°±è“‹æ‰é‡è¤‡çš„ Key äº†
- è¨˜å¾— \ `.`  `strings` File è¦å¢åŠ  Test Target



![](/assets/48a8526c1300/1*ERr-ef6R7dFHo1ucU6cPOQ.png)


**TestCase 1\. æ¸¬è©¦åŒä¸€å€‹ \.strings æª”æ¡ˆå…§æœ‰ç„¡é‡è¤‡å®šç¾©çš„ Keyï¼š**
```swift
func testNoDuplicateKeysInSameFile() throws {
    localizations.forEach { (_, localizations) in
        localizations.forEach { localization in
            localization.localizableStringFiles.forEach { localizableStringFile in
                let keys = localizableStringFile.values.map { $0.key }
                let uniqueKeys = Set(keys)
                XCTAssertTrue(keys.count == uniqueKeys.count, "Localized Strings File: \(localizableStringFile.path) has duplicated keys.")
            }
        }
    }
}
```

Input:


![](/assets/48a8526c1300/1*cB5nXv1wWPzbjAOrKQ835w.png)


Result:


![](/assets/48a8526c1300/1*6qIgcx0EkK7j_R17d6ljuw.png)


**TestCase 2\. èˆ‡ DevelopmentLocalization èªè¨€ç›¸æ¯”ï¼Œæœ‰ç„¡ç¼ºå°‘/å¤šé¤˜çš„ Keyï¼š**
```swift
func testCompareWithDevLangHasMissingKey() throws {
    localizations.forEach { (bundle, localizations) in
        let developmentLang = bundle.developmentLocalization ?? "en"
        if let developmentLocalization = localizations.first(where: { $0.lang == developmentLang }) {
            let othersLocalization = localizations.filter { $0.lang != developmentLang }
            
            developmentLocalization.localizableStringFiles.forEach { developmentLocalizableStringFile in
                let developmentLocalizableKeys = Set(developmentLocalizableStringFile.values.map { $0.key })
                othersLocalization.forEach { otherLocalization in
                    if let otherLocalizableStringFile = otherLocalization.localizableStringFiles.first(where: { $0.name == developmentLocalizableStringFile.name }) {
                        let otherLocalizableKeys = Set(otherLocalizableStringFile.values.map { $0.key })
                        if developmentLocalizableKeys.count < otherLocalizableKeys.count {
                            XCTFail("Localized Strings File: \(otherLocalizableStringFile.path) has redundant keys.")
                        } else if developmentLocalizableKeys.count > otherLocalizableKeys.count {
                            XCTFail("Localized Strings File: \(otherLocalizableStringFile.path) has missing keys.")
                        }
                    } else {
                        XCTFail("Localized Strings File not found in Lang: \(otherLocalization.lang)")
                    }
                }
            }
        } else {
            XCTFail("developmentLocalization not found in Bundle: \(bundle)")
        }
    }
}
```

Input: \(ç›¸è¼ƒ DevelopmentLocalization å…¶ä»–èªç³»ç¼ºå°‘å®£å‘Š Key\)


![](/assets/48a8526c1300/1*RwO-ploDVoExJmhHRpBXiA.png)


Output:


![](/assets/48a8526c1300/1*Mdt01WLvX2KBtwUhThxOSQ.png)


Input: \(DevelopmentLocalization æ²’æœ‰é€™å€‹ Keyï¼Œä½†åœ¨å…¶ä»–èªç³»å‡ºç¾\)


![](/assets/48a8526c1300/1*RwO-ploDVoExJmhHRpBXiA.png)


Output:


![](/assets/48a8526c1300/1*Fr-w-PXEx2N_ftYjfXTa9w.png)

### ç¸½çµ

ç¶œåˆä»¥ä¸Šæ–¹å¼ï¼Œæˆ‘å€‘ä½¿ç”¨ï¼š
- æ–°ç‰ˆ XCode å¹«æˆ‘å€‘ç¢ºä¿ \.strings æª”æ¡ˆæ ¼å¼æ­£ç¢ºæ€§ âœ…
- SwiftGen ç¢ºä¿ CodeBase å¼•ç”¨å¤šèªç³»æ™‚ä¸æœƒæ‰“éŒ¯æˆ–æ²’å®£å‘Šå°±å¼•ç”¨ âœ…
- UnitTest ç¢ºä¿å¤šèªç³»å…§å®¹æ­£ç¢ºæ€§ âœ…



[![[**GitHub \- zhgchgli0718/L10NTests**](https://github.com/zhgchgli0718/L10NTests){:target="_blank"}{:target="_blank"}{:target="_blank"}{:target="_blank"} 
[_You can't perform that action at this time\. You signed in with another tab or window\. You signed out in another tab orâ€¦_ github\.com](https://github.com/zhgchgli0718/L10NTests)](https://opengraph.githubassets.com/5e3a8099a333f9bf5a74339f82426afdd235c5a6ca6b9910196a4b961eb2b31a/zhgchgli0718/L10NTests "[**GitHub \- zhgchgli0718/L10NTests**](https://github.com/zhgchgli0718/L10NTests) 
[_You can't perform that action at this time\. You signed in with another tab or window\. You signed out in another tab orâ€¦_ github\.com](https://github.com/zhgchgli0718/L10NTests)")](https://github.com/zhgchgli0718/L10NTests)

#### å„ªé»ï¼š
- åŸ·è¡Œé€Ÿåº¦å¿«ï¼Œä¸æ‹–ç´¯ Build Time
- åªè¦æ˜¯ iOS é–‹ç™¼è€…éƒ½æœƒç¶­è­·

### é€²éš
#### Localized File Format

é€™å€‹è§£æ±ºæ–¹æ¡ˆç„¡æ³•é”æˆï¼Œé‚„æ˜¯éœ€ä½¿ç”¨åŸæœ¬ [ç”¨ Swift å¯«çš„ Command Line Tool ä¾†é”æˆ](../41c49a75a743) ï¼Œä¸é Format éƒ¨åˆ†å¯ä»¥åœ¨ git pre\-commit åšå°±å¥½ï¼›æ²’æœ‰ diff èª¿æ•´å°±ä¸åšï¼Œé¿å…æ¯æ¬¡ build éƒ½è¦è·‘ä¸€æ¬¡ï¼š
```shell
#!/bin/sh

diffStaged=${1:-\-\-staged} # use $1 if exist, default --staged.

git diff --diff-filter=d --name-only $diffStaged | grep -e 'Localizable.*\.\(strings\|stringsdict\)$' | \
  while read line; do
    // do format for ${line}
done
```
#### .stringdict

åŒæ¨£çš„åŸç†ä¹Ÿå¯ç”¨åœ¨ \ `.`  `stringdict` ä¸Š
#### CI/CD

swiftgen å¯ä»¥ä¸ç”¨æ”¾åœ¨ build phaseï¼Œå› ç‚ºæ¯æ¬¡ build éƒ½æœƒè·‘ä¸€æ¬¡ï¼Œè€Œä¸” Build å®Œç¨‹å¼ç¢¼æ‰æœƒå‡ºç¾ï¼Œå¯ä»¥æ”¹æˆæœ‰èª¿æ•´å†ä¸‹æŒ‡ä»¤ç”¢ç”Ÿå°±å¥½ã€‚
#### æ˜ç¢ºå¾—åˆ°éŒ¯åœ¨å“ªå€‹ Key

å¯å„ªåŒ– UnitTest çš„ç¨‹å¼ï¼Œä½¿ä¹‹èƒ½è¼¸å‡ºæ˜ç¢ºæ˜¯å“ªå€‹ Key Missing/Reductant/Duplicateã€‚
#### ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·è®“å·¥ç¨‹å¸«å®Œå…¨è§£æ”¾å¤šèªç³»å·¥ä½œ

å¦‚åŒä¹‹å‰ã€Œ [2021 Pinkoi Tech Career Talk â€” é«˜æ•ˆç‡å·¥ç¨‹åœ˜éšŠå¤§è§£å¯†](../11f6c8568154) ã€çš„æ¼”è¬›å…§å®¹ï¼Œåœ¨å¤§åœ˜éšŠä¸­å¤šèªç³»å·¥ä½œå¯ä»¥é€éç¬¬ä¸‰æ–¹æœå‹™æ‹†é–‹ï¼Œå¤šèªç³»å·¥ä½œçš„ä¾è³´é—œä¿‚ã€‚


![](/assets/48a8526c1300/1*YQi4ti2_MfUapUSRKnF5dg.png)


å·¥ç¨‹å¸«åªéœ€å®šç¾©å¥½ Keyï¼Œå¤šèªç³»æœƒåœ¨ CI/CD éšæ®µå¾å¹³å°è‡ªå‹•åŒ¯å…¥ï¼Œå°‘äº†äººå·¥ç¶­è­·çš„éšæ®µï¼›ä¹Ÿæ¯”è¼ƒä¸å®¹æ˜“å‡ºéŒ¯ã€‚
### Special Thanks


![[Wei Cao](https://www.linkedin.com/in/wei-cao-67b5b315a/){:target="_blank"}{:target="_blank"} , iOS Developer @ Pinkoi](/assets/48a8526c1300/1*CCGSKp2-BvATpDAuRiRuRQ.jpeg)

[Wei Cao](https://www.linkedin.com/in/wei-cao-67b5b315a/) , iOS Developer @ Pinkoi


[![Like Z Realm's work](https://button.like.co/images/og/likebutton.png "Like Z Realm's work")](https://button.like.co/zhgchgli)


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_Converted [Medium Post](https://medium.com/zrealm-ios-dev/ios-%E7%82%BA%E5%A4%9A%E8%AA%9E%E7%B3%BB%E5%AD%97%E4%B8%B2%E8%B2%B7%E4%BB%BD%E4%BF%9D%E9%9A%AA%E5%90%A7-48a8526c1300) by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown)._
