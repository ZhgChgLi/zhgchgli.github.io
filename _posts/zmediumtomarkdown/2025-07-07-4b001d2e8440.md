---
title: "CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆä¸‰ï¼‰ï¼šä½¿ç”¨ GitHub Actions å¯¦ä½œ App iOS CI èˆ‡ CD å·¥ä½œæµç¨‹"
author: "ZhgChgLi"
date: 2025-07-07T15:02:24.147+0000
last_modified_at: 2025-07-07T15:07:20.643+0000
categories: ["ZRealm Dev."]
tags: ["ios-app-development","cicd","github-actions","firebase","cicd-pipeline"]
description: "iOS App è‡ªå‹•åŒ–å»ºç½®ã€æ¸¬è©¦ã€éƒ¨ç½²çš„ GitHub Actions å¯¦ä½œæ­¥é©Ÿå®Œæ•´æ•™å­¸"
image:
  path: /assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.jpeg
render_with_liquid: false
---

### CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆä¸‰ï¼‰ï¼šä½¿ç”¨ GitHub Actions å¯¦ä½œ App iOS CI èˆ‡ CD å·¥ä½œæµç¨‹

iOS App è‡ªå‹•åŒ–å»ºç½®ã€æ¸¬è©¦ã€éƒ¨ç½²çš„ GitHub Actions å¯¦ä½œæ­¥é©Ÿå®Œæ•´æ•™å­¸



![Photo by [Robs](https://unsplash.com/@robinne?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash){:target="_blank"}](/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.jpeg)

Photo by [Robs](https://unsplash.com/@robinne?utm_content=creditCopyText&utm_medium=referral&utm_source=unsplash){:target="_blank"}
#### å‰è¨€

å‰ç¯‡ã€Œ [**CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆäºŒï¼‰ï¼šGitHub Actions èˆ‡ Self\-hosted Runner ä½¿ç”¨èˆ‡å»ºç½®å¤§å…¨**](../404bd5c70040/) ã€æˆ‘å€‘ä»‹ç´¹äº† GitHub Actions çš„åŸºç¤çŸ¥è­˜èˆ‡é‹ä½œæµç¨‹é‚„æœ‰å¦‚ä½•ä½¿ç”¨è‡ªå·±çš„æ©Ÿå™¨ç•¶æˆ Runnerã€å¸¶å¤§å®¶å¯¦ç¾äº†ä¸‰å€‹ç°¡å–®çš„è‡ªå‹•åŒ– Actionsï¼› **æœ¬ç¯‡å°‡æ·±å…¥è‘—é‡åœ¨ç¾å¯¦ä½¿ç”¨ GitHub Actions å»ºç½® App \(iOS\) CI/CD å·¥ä½œæµç¨‹ä¸Š** ï¼Œä¸€æ¨£æ‰‹æŠŠæ‰‹å¸¶å¤§å®¶ä¸€æ­¥ä¸€æ­¥å®Œæˆä¸¦ä¸€é‚Šè£œè¶³ GitHub Actions ç›¸é—œçŸ¥è­˜ã€‚
### App CI/CD æµç¨‹é—œä¿‚åœ–


![](/assets/4b001d2e8440/1*VRygfRAkBRNEDAC4RyGzRA.png)


æœ¬ç¯‡å°‡é—œæ³¨åœ¨ GitHub Actions å»ºç½® CI/CD çš„å€å¡Šï¼Œä¸‹ä¸€ç¯‡ã€Œ **CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆå››ï¼‰ï¼šä½¿ç”¨ Google Apps Script Web App \(AI Vibe Coding\) çµåˆ GitHub Actions æ‰“é€ å…è²»æ˜“ç”¨çš„è·¨åœ˜éšŠæ‰“åŒ…å¹³å°å·¥å…·** ã€æ‰æœƒä»‹ç´¹å³åŠéƒ¨åˆ†çš„ä½¿ç”¨ Google Apps Script Web App å»ºç½®è·¨åœ˜éšŠå”ä½œæ‰“åŒ…å¹³å°ã€‚
#### é‹ä½œæµç¨‹ï¼š
1. GitHub Actions é–‹ Pull Request è§¸ç™¼ or è¡¨å–®è§¸ç™¼ or å®šæ™‚è§¸ç™¼
2. åŸ·è¡Œå°æ‡‰ Workflow Jobs/Steps
3. Step åŸ·è¡Œå°æ‡‰ Fastlane \(iOS\) or \(Android Gradle\) è…³æœ¬
4. Fastlane åŸ·è¡Œå°æ‡‰ xcodebuild \(iOS\) æŒ‡ä»¤
5. å–å¾—åŸ·è¡Œçµæœ
6. å¾ŒçºŒ Workflow Jobs/Steps è™•ç†çµæœ
7. å®Œæˆ

#### GitHub Actions æˆæœåœ–

å…ˆä¸Šæœ€çµ‚æˆæœçµ¦å¤§å®¶ä¸€é»å¯¦ä½œå‹•åŠ›ï¼


![[CI Testing](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target="_blank"}](/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.png)

[CI Testing](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target="_blank"}


![](/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.png)



![[CI Nightly Build, CD Deploy](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target="_blank"}](/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.jpeg)

[CI Nightly Build, CD Deploy](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target="_blank"}


> **_å¯¦ä½œé–‹å§‹ï¼_** 




### iOS Demo å°ˆæ¡ˆçš„ Infra æ¶æ§‹


[![](https://opengraph.githubassets.com/ea587894478088c4865981c6a8978f7581ddf9f033ea581b8673bc5e9549f3f5/ZhgChgLi/github-actions-ci-cd-demo)](https://github.com/ZhgChgLi/github-actions-ci-cd-demo){:target="_blank"}


**æœ¬æ–‡ç”¨åˆ°çš„ iOS å°ˆæ¡ˆå…§å®¹åŒ…å«æ¸¬è©¦é …ç›®éƒ½æ˜¯ç”¨ AI ç”¢ç”Ÿçš„** ï¼Œä¸éœ€åœ¨æ„ iOS çš„ç¨‹å¼ç´°ç¯€ï¼Œåªé‡å° Infra & CI/CD éƒ¨åˆ†åšè¨è«–ã€‚
#### Mint


[![](https://opengraph.githubassets.com/a864ceb172474f3e0c4cf78dbaf5a6baf3fe8ed5e8bf7eaa78b1821d678e7f00/yonaskolb/Mint)](https://github.com/yonaskolb/Mint){:target="_blank"}


Mint å·¥å…·å¯ä»¥å¹«æˆ‘å€‘çµ±ä¸€ç®¡ç†ä¾è³´å·¥å…·çš„ç‰ˆæœ¬\(Gemfile åªèƒ½ç®¡ç† Ruby Gems\)ï¼Œä¾‹å¦‚ XCodeGenã€XCodeGenã€SwiftFormatã€SwiftLintã€Periphery

â€¦etc

**Mintfile:**
```graphql
yonaskolb/Mint@0.17.5
yonaskolb/XcodeGen@2.35.0
nicklockwood/SwiftFormat@0.51.13
```

é€™é‚Šæˆ‘å€‘åªç”¨åˆ°ä¸‰å€‹ã€‚


> **_è¦ºå¾—å¤ªè¤‡é›œä¸ä½¿ç”¨ä¹Ÿå¯ä»¥ï¼Œç›´æ¥åœ¨ Action Workflow Step ä¸­ç”¨ brew install å®‰è£éœ€è¦çš„å·¥å…·å³å¯ã€‚_** 




#### Bundle

**Gemfile:**
```bash
source 'https://rubygems.org'
gem 'cocoapods', '~>1.16.0'
gem 'fastlane', '~>2.228.0'

plugins_path = File.join(File.dirname(__FILE__), 'Product', 'fastlane', 'Pluginfile')
eval_gemfile(plugins_path) if File.exist?(plugins_path)
```

ç®¡ç† Ruby \(Gems\) ç›¸é—œä¾è³´ï¼Œä¸€èˆ¬ iOS å°ˆæ¡ˆæœ€å¸¸ç”¨çš„å°±æ˜¯é€™å…©å€‹ `cocoapods` è·Ÿ `fastlane` ã€‚
#### Cocoapods

**Product/podfile:**
```ruby
platform :ios, '13.0'
use_frameworks!

target 'app-ci-cd-github-actions-demo' do
  pod 'SnapKit'
end 
```

é›–ç„¶å·²å®£å‘Š [å³å°‡åœæ­¢ç¶­è­·](https://blog.cocoapods.org/CocoaPods-Specs-Repo/){:target="_blank"} ï¼Œä½† Cocoapods åœ¨æœ‰å¹´ä»£çš„ iOS å°ˆæ¡ˆä¸­ä»å¾ˆå¸¸è¦‹ï¼Œé€™é‚Šç°¡å–®åŠ ä¸€å€‹ Snapkit ç•¶ Demoã€‚
#### XCodeGen

é¿å…å¤šäººé–‹ç™¼ä¸­ `.xcodeproj` / `.xcworkspace` ç•°å‹•é€ æˆçš„è¡çªï¼Œçµ±ä¸€ä½¿ç”¨ Project\.yaml å®šç¾© XCode Project å…§å®¹ï¼Œç„¶å¾Œåœ¨æœ¬åœ°è‡ªå·± Gen Project æª”æ¡ˆ\(ä¸ä¸Š Git\)ã€‚

**Product/project\.yaml:**
```yaml
name: app-ci-cd-github-actions-demo
options:
  bundleIdPrefix: com.example
  deploymentTarget:
    iOS: '13.0'
  usesTabs: false
  indentWidth: 2
  tabWidth: 2

configs:
  Debug: debug
  Release: release

targets:
  app-ci-cd-github-actions-demo:
    type: application
    platform: iOS
    sources:
      - app-ci-cd-github-actions-demo
    resources:
      - app-ci-cd-github-actions-demo/Assets.xcassets
      - app-ci-cd-github-actions-demo/Base.lproj
    info:
      path: app-ci-cd-github-actions-demo/Info.plist
      properties:
        CFBundleIdentifier: $(PRODUCT_BUNDLE_IDENTIFIER)
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.test.appcicdgithubactionsdemo
    cocoapods: true

  app-ci-cd-github-actions-demoTests:
    type: bundle.unit-test
    platform: iOS
    sources:
      - app-ci-cd-github-actions-demoTests
    dependencies:
      - target: app-ci-cd-github-actions-demo
    info:
      path: app-ci-cd-github-actions-demoTests/Info.plist
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.test.appcicdgithubactionsdemo.tests

  app-ci-cd-github-actions-demoUITests:
    type: bundle.ui-testing
    platform: iOS
    sources:
      - app-ci-cd-github-actions-demoUITests
    dependencies:
      - target: app-ci-cd-github-actions-demo
    info:
      path: app-ci-cd-github-actions-demoUITests/Info.plist
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: com.test.appcicdgithubactionsdemo.uitests

  app-ci-cd-github-actions-demoSnapshotTests:
    type: bundle.unit-test
    platform: iOS
    sources:
      - path: app-ci-cd-github-actions-demoSnapshotTests
        excludes:
          - "**/__Snapshots__/**"
    dependencies:
      - target: app-ci-cd-github-actions-demo
      - product: SnapshotTesting
        package: SnapshotTesting
    info:
      path: app-ci-cd-github-actions-demoSnapshotTests/Info.plist
      settings:
        base:
          PRODUCT_BUNDLE_IDENTIFIER: com.test.appcicdgithubactionsdemo.snapshottests

packages:
  SnapshotTesting:
    url: https://github.com/pointfreeco/swift-snapshot-testing
    from: 1.18.4
```

SnapshotTesting: ä½¿ç”¨ Swift Package Manager ç®¡ç†ã€‚
#### Fastlane

å°è£ xcodebuild æŒ‡ä»¤ã€å°è£ä¸²æ¥ App Store Connect APIã€Firebase API\. \.ç­‰æœå‹™çš„è¤‡é›œæ­¥é©Ÿã€‚

**Product/fastlane/Fastfile:**
```php

default_platform(:ios)

platform :ios do
  desc "Run all tests (Unit Tests + UI Tests)"
  lane :run_all_tests do |options|
    device = options[:device]
    scan(
      scheme: "app-ci-cd-github-actions-demo",
      device: device,
      clean: true,
      output_directory: "fastlane/test_output",
      output_types: "junit"
    )
  end

  desc "Run only Unit Tests"
  lane :run_unit_tests do |options|
    device = options[:device]
    scan(
      scheme: "app-ci-cd-github-actions-demo",
      device: device,
      clean: true,
      only_testing: [
        "app-ci-cd-github-actions-demoTests"
      ],
      output_directory: "fastlane/test_output",
      output_types: "junit"
    )
  end

  desc "Build and upload to Firebase App Distribution"
  lane :beta do |options|
    
    if options[:version_number] && options[:version_number].to_s.strip != ""
      increment_version_number(version_number: options[:version_number])
    end

    if options[:build_number] && options[:build_number].to_s.strip != ""
      increment_build_number(build_number: options[:build_number])
    end

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "app-ci-cd-github-actions-demo.xcodeproj",
      team_id: ENV['TEAM_ID'],
      code_sign_identity: "iPhone Developer",
      sdk: "iphoneos*",
      profile_name: "cicd"
    )

    gym(
      scheme: "app-ci-cd-github-actions-demo",
      clean: true,
      export_method: "development",
      output_directory: "fastlane/build",
      output_name: "app-ci-cd-github-actions-demo.ipa",
      export_options: {
          provisioningProfiles: {
            "com.test.appcicdgithubactionsdemo" => "cicd",
          },
      }
    )

    firebase_app_distribution(
      app: "1:127683058219:ios:98896929fa131c7a80686e",
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
      release_notes: options[:release_notes] || "New beta build"
    )
  end
end
```

è¨»: provisioningProfilesã€profile\_name å°æ‡‰çš„æ˜¯ [App Developer ä¸­çš„ Profiles æ†‘è­‰åç¨±](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} ã€‚\(å¦‚æœæœ‰ç”¨ match å‰‡ä¹Ÿä¸éœ€è¦é€™äº›æŒ‡å®šã€‚\)


![](/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.png)


**Fastlane æ˜¯ iOS CI/CD ç•¶ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†** ï¼Œç›´æ¥ä½¿ç”¨å®ƒå°è£å¥½çš„æ–¹æ³•å°±èƒ½å¿«é€Ÿé–‹ç™¼ CI/CD å¯¦éš›åŸ·è¡Œçš„æ­¥é©Ÿï¼›æˆ‘å€‘åªéœ€é—œæ³¨åœ¨æ•´é«”çš„è…³æœ¬è¨­è¨ˆï¼Œè€Œä¸éœ€å»è™•ç†è¤‡é›œçš„ API ä¸²æ¥æˆ–æŒ‡ä»¤æ’°å¯«ã€‚

ä¾‹å¦‚ï¼šFastlane åªéœ€è¦å¯«ã€Œscan\(xxx\)ã€å°±èƒ½åŸ·è¡Œæ¸¬è©¦ï¼Œå¦‚æœè¦å¯«æˆ xcodebuild å‰‡éœ€è¦ã€Œ `xcodebuild -workspace ./xxx.xcworkspace -scheme xxx -derivedDataPath xxx â€˜platform=iOS Simulator,id=xxxâ€™ clean build test` ã€ï¼Œæ‰“åŒ…éƒ¨ç½²è¦è‡ªå·±åšæ›´æ˜¯éº»ç…©ï¼Œè¦è‡ªè¡Œä¸²æ¥ App Store Connect/Firebase APIï¼Œå…‰é‡‘é‘°é©—è­‰éƒ½è¦å¯«è¶…é 10 è¡Œç¨‹å¼äº†ã€‚

**Demo å°ˆæ¡ˆæˆ‘å€‘åªæœ‰ä¸‰å€‹ Lane:**
- run\_all\_tests: è·‘æ‰€æœ‰é¡å‹çš„æ¸¬è©¦ \(Snapshot\+Unit\)
- run\_unit\_tests: åªè·‘å–®å…ƒæ¸¬è©¦ \(Unit\)
- beta: æ‰“åŒ…éƒ¨ç½²åˆ° Firebase App Distribution

#### Fastlane â€” Matchfile

å›  Demo å°ˆæ¡ˆé™åˆ¶ï¼Œé€™é‚Šæ²’ç”¨åˆ° Match ç®¡ç†åœ˜éšŠé–‹ç™¼ã€éƒ¨ç½²æ†‘è­‰ï¼Œä½†é€™é‚Šé‚„æ˜¯è¦æä¸€ä¸‹ï¼Œå»ºè­°ä½¿ç”¨ Match å»ç®¡ç†åœ˜éšŠçš„æ‰€æœ‰é–‹ç™¼ã€éƒ¨ç½²æ†‘è­‰ï¼Œæ–¹ä¾¿æ§ç®¡è·Ÿçµ±ä¸€æ›´æ–°ã€‚


> _æœ‰ç”¨ Match å°±èƒ½åœ¨å°ˆæ¡ˆ Setup æ­¥é©Ÿç›´æ¥ä½¿ç”¨ `match all` ä¹‹é¡çš„æŒ‡ä»¤ä¸€éµå®‰è£å¥½æ‰€æœ‰é–‹ç™¼éœ€è¦çš„æ†‘è­‰ã€‚_ 





â€” â€” â€”
#### Makefile


![Makefile](/assets/4b001d2e8440/1*jYACUYFP3MkeHCgeUY7j3w.png)

Makefile

è®“é–‹ç™¼ç«¯èˆ‡ CI/CD çµ±ä¸€éƒ½ä½¿ç”¨ Makefile åŸ·è¡ŒæŒ‡ä»¤ï¼Œæ–¹ä¾¿æˆ‘å€‘å°è£åŒæ¨£çš„ç’°å¢ƒã€è·¯å¾‘èˆ‡æ“ä½œè¡Œçˆ²ã€‚


> _ç¶“å…¸çš„æ¡ˆä¾‹æ˜¯æœ‰çš„äººä½¿ç”¨çš„æ˜¯æœ¬æ©Ÿå®‰è£çš„ `pod install` æœ‰çš„äººå‰‡ä½¿ç”¨çš„æ˜¯ Bundel ç®¡ç†çš„ `bundle exec pod install` å¦‚æœç‰ˆæœ¬ä¸åŒå°±å¯èƒ½ç”¢ç”Ÿå·®ç•°ã€‚_ 





> **_è¦ºå¾—å¤ªè¤‡é›œä¸ä½¿ç”¨ä¹Ÿå¯ä»¥ï¼Œé‚£å°±æ˜¯åœ¨ Action Workflow Step ä¸­ç›´æ¥å¯«è¦åŸ·è¡Œçš„æŒ‡ä»¤å³å¯ã€‚_** 





**Makefile:**
```makefile
#!make
PRODUCT_FOLDER = ./Product/
SHELL         := /bin/zsh
.DEFAULT_GOAL := install
MINT_DIRECTORY := ./mint/

export MINT_PATH=$(MINT_DIRECTORY)

## ğŸ‘‡ Help function
.PHONY: help
help:
 @echo ""
 @echo "ğŸ“– å¯ç”¨æŒ‡ä»¤:"
 @grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
  awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
 @echo ""

## Setup
.PHONY: setup
setup: check-mint ## å®‰è£ Ruby å’Œ Mint ä¾è³´
 @echo "ğŸ”¨ Installing Ruby dependencies..."
 bundle config set path 'vendor/bundle'
 bundle install
 @echo "ğŸ”¨ Installing Mint dependencies..."
 mint bootstrap

## Install
.PHONY: install
install: XcodeGen PodInstall ## åŸ·è¡Œ XcodeGen å’Œ CocoaPods å®‰è£

.PHONY: XcodeGen
XcodeGen: check-mint ## ç”¨ XcodeGen ç”¢ç”Ÿ .xcodeproj
 @echo "ğŸ”¨ Execute XcodeGen"
 cd $(PRODUCT_FOLDER) && \
 mint run yonaskolb/XcodeGen --quiet

.PHONY: PodInstall
PodInstall: ## å®‰è£ CocoaPods ä¾è³´
 @echo "ğŸ“¦ Installing CocoaPods dependencies..."
 cd $(PRODUCT_FOLDER) && \
 bundle exec pod install

### Mint
check-mint: check-brew ## æª¢æŸ¥ Mint æ˜¯å¦å®‰è£ï¼Œæ²’æœ‰å°±è‡ªå‹•å®‰è£
 @if ! command -v mint &> /dev/null; then \
  echo "ğŸ”¨ Installing mint..."; \
  brew install mint; \
 fi

### Brew
check-brew: ## æª¢æŸ¥ Homebrew æ˜¯å¦å®‰è£ï¼Œæ²’æœ‰å°±è‡ªå‹•å®‰è£
 @if ! command -v brew &> /dev/null; then \
  echo "ğŸ”¨ Installing Homebrew..."; \
  /bin/bash -c "$$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; \
 fi

## Format only git swift files
.PHONY: format
format: check-mint ## æ ¼å¼åŒ– Product/ ä¸‹æ‰€æœ‰ Swift æª”
 mint run swiftformat $(PRODUCT_FOLDER)
```

ç‚ºäº†é¿å…æ±¡æŸ“æ•´å€‹ç³»çµ±æˆ–å…¶ä»–å°ˆæ¡ˆï¼Œæˆ‘å€‘ç›¡å¯èƒ½æŠŠ Dependency å¥—ä»¶\(e\.g\. mint, bundleâ€¦etc\)çš„è·¯å¾‘éƒ½æ”¹æŒ‡å®šåœ¨å°ˆæ¡ˆç›®éŒ„ä¹‹ä¸‹ \(å†æ­é… `.gitignore` æ’é™¤\)ã€‚
```scss
â”œâ”€â”€ mint (Mint ä¾è³´)
â”‚   â””â”€â”€ packages
â”œâ”€â”€ Product
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demo
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demo.xcodeproj
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demo.xcworkspace
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demoSnapshotTests
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demoTests
â”‚   â”œâ”€â”€ app-ci-cd-github-actions-demoUITests
â”‚   â”œâ”€â”€ fastlane
â”‚   â””â”€â”€ Pods (Cocoapods ä¾è³´)
â””â”€â”€ vendor (Bundle ä¾è³´)
    â””â”€â”€ bundle
```


![make help](/assets/4b001d2e8440/1*F1KFntT8bCZzyYm9JahiuA.png)

make help

**ä½¿ç”¨ Makefine çš„çµ±ä¸€å°ˆæ¡ˆ Setup æ­¥é©Ÿï¼š**
1. `git clone repo`
2. `cd ./repo`
3. `make setup` 
å®‰è£å¿…è¦çš„å·¥å…·ä¾è³´ \( **brew** , **mint** , **bundle** , xcodegen, swiftformat,â€¦\)
4. `make install` 
ç”¢ç”Ÿå°ˆæ¡ˆ \(åŸ·è¡Œ pod install, xcodegen\)
5. å®Œæˆ
6. æ‰“é–‹ã€åŸ·è¡Œå°ˆæ¡ˆ



> **_ä¸ç®¡æ˜¯ CI/CD æˆ–æ–°äºº onboard éƒ½æ˜¯ç…§ä»¥ä¸Šæ­¥é©ŸæŠŠå°ˆæ¡ˆå»ºç½®èµ·ä¾†ã€‚_** 




### æœ¬ç¯‡ GitHub Actions CI/CD æ¡ˆä¾‹

æœ¬ç¯‡æœƒä»‹ç´¹ä¸‰å€‹ GitHub Actions CI/CD å·¥ä½œæµç¨‹å»ºç½®æ¡ˆä¾‹ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥åƒè€ƒå…¶ä¸­çš„æ­¥é©Ÿå»ºç½®ç¬¦åˆè‡ªå·±åœ˜éšŠå·¥ä½œæµç¨‹çš„ CI/CDã€‚
1. CI â€” ç™¼ Pull Request åŸ·è¡Œå–®å…ƒæ¸¬è©¦
2. CD â€” æ‰“åŒ…\+éƒ¨ç½²åˆ° Firebase App Distribution
3. CI \+CDâ€” Nightly Build åŸ·è¡Œå¿«ç…§\+å–®å…ƒæ¸¬è©¦\+æ‰“åŒ…\+éƒ¨ç½²åˆ° Firebase App Distribution



> _å›  Demo é™åˆ¶ï¼Œæœ¬æ–‡åªæœƒä¸²æ¥ æ‰“åŒ…éƒ¨ç½²åˆ° Firebase App Distributionï¼Œæ‰“åŒ…åˆ° Testflight æˆ–æ˜¯ App Store ä¹Ÿæ˜¯åŒæ¨£æ­¥é©Ÿåªå·®åˆ¥åœ¨ Fastlane è£¡çš„è…³æœ¬ä¸åŒï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œç™¼æ®ã€‚_ 




### CI â€” ç™¼ Pull Request åŸ·è¡Œå–®å…ƒæ¸¬è©¦
#### æµç¨‹

Develop åˆ†æ”¯ **ç„¡æ³•ç›´æ¥æ¨é€** ï¼Œå¿…é ˆç™¼ Pull Request æ‰èƒ½æ›´æ–°ï¼›æ‰€æœ‰ Pull Request **å‡éœ€ Review é€šéåŠ ä¸Šå–®å…ƒæ¸¬è©¦é€šéæ‰èƒ½ Merge** ã€æœ‰æ–° Commit Push æœƒé‡æ–°æ¸¬è©¦ã€‚
#### CI\-Testing\.yml

Repo â†’ Actions â†’ New workflow â†’ set up a workflow yourselfã€‚
```yaml
# Workflow(Action) åç¨±
name: CI-Testing

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "[CI-Testing] ${{ github.event.pull_request.title || github.ref }}"

# åŒå€‹ Concurrency Group å¦‚æœæœ‰æ–°çš„ Job æœƒå–æ¶ˆæ­£åœ¨è·‘çš„
# ä¾‹å¦‚ Push Commit è§¸ç™¼çš„ä»»å‹™é‚„æ²’åŸ·è¡Œå°±åˆ Push Commit æ™‚ï¼Œæœƒå–æ¶ˆå‰ä¸€å€‹ä»»å‹™
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# è§¸ç™¼äº‹ä»¶
on:
  # PR äº‹ä»¶
  pull_request:
    # PR - é–‹å•Ÿã€é‡é–‹ã€æœ‰æ–° Push Commit æ™‚
    types: [opened, synchronize, reopened]
  # æ‰‹å‹•è¡¨å–®è§¸ç™¼
  workflow_dispatch:
    # è¡¨å–® Inputs æ¬„ä½
    inputs:
      # åŸ·è¡Œçš„ Test Fastlane Lane
      TEST_LANE:
        description: 'Test Lane'
        default: 'run_unit_tests'
        type: choice
        options:
          - run_unit_tests
          - run_all_tests
  # å…¶ä»– Workflow å‘¼å«æ­¤ Workflow è§¸ç™¼
  # Nightly Build æœƒå‘¼å«ä½¿ç”¨
  workflow_call:
    # è¡¨å–® Inputs æ¬„ä½
    inputs:
      # åŸ·è¡Œçš„ Test Fastlane Lane
      TEST_LANE:
        description: 'Test Lane'
        default: 'run_unit_tests'
        # workflow_call inputs ä¸æ”¯æ´ choice
        type: string
      BRANCH:
        description: 'Branch'
        type: string
  
# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # Job ID
  testing:
    # Job åç¨± (å¯çœç•¥ï¼Œæœ‰è¨­å®šåœ¨ Log é¡¯ç¤ºæ¯”è¼ƒå¥½è®€)
    name: Testing
    
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner macos-15 ä¾†åŸ·è¡Œå·¥ä½œ
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # å¦‚æœæ˜¯ Private Repo éœ€è¦æŒ‰è¨ˆé‡æ”¶è²»ï¼ŒmacOS æ©Ÿå™¨æ˜¯æœ€è²´çš„(10å€)ï¼Œå¯èƒ½è·‘ 10 æ¬¡å°±é”åˆ° 2,000 åˆ†é˜å…è²»ä¸Šé™
    # å»ºè­°ä½¿ç”¨ self-hosted Runner
    runs-on: macos-15

    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 30

    # use zsh
    # å¯çœç•¥ï¼Œåªæ˜¯æˆ‘ç¿’æ…£ç”¨ zshï¼Œé è¨­æ˜¯ bash
    defaults:
      run:
        shell: zsh {0}
          
    # å·¥ä½œæ­¥é©Ÿ
    # å·¥ä½œæ­¥é©Ÿæœƒç…§é †åºåŸ·è¡Œ  
    steps:
      # git clone ç•¶å‰å°ˆæ¡ˆ & checkout åˆ°åŸ·è¡Œçš„åˆ†æ”¯
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Git Large File Storageï¼Œæˆ‘å€‘çš„æ¸¬è©¦ç’°å¢ƒç”¨ä¸åˆ°
          # default: false
          lfs: false
          
          # å¦‚æœæœ‰æŒ‡å®šå‰‡ Checkout æŒ‡å®šåˆ†æ”¯ï¼Œæ²’æœ‰å‰‡ä½¿ç”¨é è¨­(ç•¶å‰åˆ†æ”¯)
          # å›  on: schedule äº‹ä»¶åªèƒ½åœ¨ main ä¸»åˆ†æ”¯åŸ·è¡Œï¼Œå› æ­¤æƒ³åš Nightly Build ä¹‹é¡çš„å·¥ä½œå°±éœ€è¦æŒ‡å®šåˆ†æ”¯
          # e.g. on: schedule -> main åˆ†æ”¯ï¼ŒNightly Build master åˆ†æ”¯
          ref: ${{ github.event.inputs.BRANCH || '' }}

      # ========== Env Setup Steps ==========
      
      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ XCode ç‰ˆæœ¬
      # åœ¨å¾ŒçºŒä¹‹ä¸­ï¼Œæˆ‘å€‘è‡ªå·±æ‰‹å‹•æŒ‡å®šä½¿ç”¨çš„ XCode_x.x.x.app
      # è€Œä¸ä½¿ç”¨ xcversionï¼Œå› ç‚º xcversion å·²ç¶“ sunset ä¸ç©©å®šã€‚ 
      - name: Read .xcode-version
        id: read_xcode_version
        run: |
          XCODE_VERSION=$(cat .xcode-version)
          echo "XCODE_VERSION: ${XCODE_VERSION}"
          echo "xcode_version=${XCODE_VERSION}" >> $GITHUB_OUTPUT

          # ä¹Ÿå¯ä»¥ç›´æ¥åœ¨é€™æŒ‡å®šå…¨åŸŸ XCode ç‰ˆæœ¬ï¼Œé€™æ¨£å°±ä¸ç”¨åœ¨å¾ŒçºŒæ­¥é©ŸæŒ‡å®š DEVELOPER_DIR
          # ä½†æ­¤æŒ‡ä»¤éœ€è¦ sudoer æ¬Šé™ï¼Œå¦‚æœæ˜¯ self-hosted runner å°±è¦ç¢ºå®š runner åŸ·è¡Œç’°å¢ƒæœ‰ sudo æ¬Šé™
          # sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"

      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ Ruby ç‰ˆæœ¬
      - name: Read .ruby-version
        id: read_ruby_version
        run: |
          RUBY_VERSION=$(cat .ruby-version)
          echo "RUBY_VERSION: ${RUBY_VERSION}"
          echo "ruby_version=${RUBY_VERSION}" >> $GITHUB_OUTPUT

      # å®‰è£æˆ–è¨­å®š Runner Ruby ç‰ˆæœ¬æˆå°ˆæ¡ˆæŒ‡å®šç‰ˆæœ¬
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "${{ steps.read_ruby_version.outputs.ruby_version }}"

      # å¯è¨­å¯ä¸è¨­ï¼ŒåŸå› æ˜¯ä¹‹å‰åœ¨ self-hosted èµ·å¤šå€‹ runner è·‘ CI/CD å› ç‚º cocoapods repos æ˜¯å…±ç”¨ç›®éŒ„
      # è§£æ±ºçš„å•é¡Œæ˜¯ï¼šæœ‰å¾ˆå°çš„æ©Ÿç‡æœƒå‡ºç¾åœ¨åŒæ™‚ pod install æ™‚æ‹‰ cocoapods repos å‡ºç¾è¡çª(å› ç‚ºé è¨­éƒ½æ˜¯ç”¨) $HOME/.cocoapods/
      # GitHub Hosted Runner å‰‡ä¸éœ€æ­¤è¨­å®š
      # - name: Change Cocoapods Repos Folder
      #   if: contains(runner.labels, 'self-hosted')
      #   run: |
      #     # æ¯å€‹ Runner ç”¨è‡ªå·±çš„ .cocoapods è³‡æ–™å¤¾ï¼Œé˜²æ­¢è³‡æºè¡çª
      #     mkdir -p "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/"
      #     export CP_HOME_DIR="$HOME/.cocoapods-${{ env.RUNNER_NAME }}"
      #     rm -f "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/repos/cocoapods/.git/index.lock"

      # ========== Cache Setting Steps ==========
      # è«‹æ³¨æ„ï¼Œå°±ç®—æ˜¯ self-hostedï¼ŒCache ç›®å‰ä¹Ÿæ˜¯ Cloud Cache æœƒè¨ˆç®—ç”¨é‡
      # è¦å‰‡ï¼š7 å¤©æœª hit è‡ªå‹•åˆªé™¤ã€å–®å€‹ Cache ä¸Šé™ 10 GBã€Action æˆåŠŸæ‰æœƒ Cache
      # Public Repo: å…è²»ç„¡é™åˆ¶
      # Private Repo: 5 GB èµ·
      # Self-hosted å¯ä»¥è‡ªå·±ç”¨ shell script æ’°å¯« Cache & Restore ç­–ç•¥æˆ–ä½¿ç”¨å…¶ä»–å·¥å…·å”åŠ©
      
      # Bundle Cache (Gemfile)
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šäº† Bundle  å®‰è£è·¯å¾‘ ./vendor ä¸‹
      - name: Cache Bundle
        uses: actions/cache@v3
        with:
          path: |
            ./vendor
          key: ${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-bundle-

      # CocoaPods Cache (Podfile)
      # é»˜èªå°±æ˜¯ å°ˆæ¡ˆ/Pods ä¸‹
      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ./Product/Pods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      # Mint cache
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šçš„ Mint å®‰è£è·¯å¾‘ ./mint ä¸‹
      - name: Cache Mint
        uses: actions/cache@v3
        with:
          path: ./mint
          key: ${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      # ====================

      # å°ˆæ¡ˆ Setup & ä¾è³´å®‰è£
      - name: Setup & Install Dependency
        run: |
          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Setup æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # brew install mint
          # bundle config set path 'vendor/bundle'
          # bundle install
          # mint bootstrap
          # ...
          # ç­‰ç­‰ setup æŒ‡ä»¤
          make setup

          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Install æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # mint run yonaskolb/XcodeGen --quiet
          # bundle exec pod install
          # ...
          # ç­‰ç­‰ install æŒ‡ä»¤
          make install

      # åŸ·è¡Œ Fastlane Unit æ¸¬è©¦ Lane
      - name: Run Tests
        id: testing
        # æŒ‡å®šå·¥ä½œç›®éŒ„ï¼Œé€™æ¨£å¾ŒçºŒæŒ‡ä»¤å°±ä¸ç”¨åœ¨ç‰¹åˆ¥ cd ./Product/
        working-directory: ./Product/
        env:
          # æ¸¬è©¦è¨ˆåŠƒï¼Œå…¨è·‘é‚„æ˜¯åªè·‘å–®å…ƒæ¸¬è©¦
          # å¦‚ç‚ºé–‹ PR è§¸ç™¼å‰‡ä½¿ç”¨ run_unit_testsï¼Œå¦å‰‡çœ‹ inputs.TEST_LANE çš„å€¼ï¼Œé è¨­å€¼ run_all_tests
          TEST_LANE: ${{ github.event_name == 'pull_request' && 'run_unit_tests' || github.event.inputs.TEST_LANE || 'run_all_tests' }}
          
          # æŒ‡å®šé€™å€‹ Job è¦ä½¿ç”¨ XCode_x.x.x æŒ‡å®šçš„ç‰ˆæœ¬åŸ·è¡Œ
          DEVELOPER_DIR: "/Applications/Xcode_${{ steps.read_xcode_version.outputs.xcode_version }}.app/Contents/Developer"
          
          # Repo -> Settings -> Actions secrets and variables -> variables
          # ä½¿ç”¨çš„æ¨¡æ“¬å™¨åç¨±
          SIMULATOR_NAME: ${{ vars.SIMULATOR_NAME }}
          # æ¨¡æ“¬å™¨çš„ iOS ç‰ˆæœ¬
          SIMULATOR_IOS_VERSION: ${{ vars.SIMULATOR_IOS_VERSION }}

          # ç•¶å‰ Runner åç¨±
          RUNNER_NAME: ${{ runner.name }}
          
          # æå‡ XCodebuild æŒ‡ä»¤ timeout æ™‚é–“, retry æ¬¡æ•¸
          # å› ç‚ºæ©Ÿå™¨ Loading æ¯”è¼ƒå¤§çš„æ™‚å€™å¯èƒ½ 3 æ¬¡å°±å¤±æ•—äº†
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10
        run: |

          # å¦‚æœæ˜¯ self-hosted åœ¨åŒä¸€å°æ©Ÿå™¨èµ·å¤šå€‹ Runner æœƒå‡ºç¾æ¶æ¨¡æ“¬å™¨çš„å•é¡Œ (æ–‡ç« å¾Œæœƒè¬›)
          # è¦é¿å…é€™å•é¡Œå»ºè­°å°‡æ¨¡æ“¬åç¨±å‘½åæˆ Runner åç¨±ï¼Œæ¯å€‹ Runner éƒ½è¨­ä¸€å€‹æ¨¡æ“¬å™¨ï¼Œé€™æ¨£å°±ä¸æœƒäº’æ¶å°è‡´æ¸¬è©¦å¤±æ•—
          # e.g. bundle exec fastlane run_unit_tests device:"${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})"
          # é€™é‚Šæ˜¯ç”¨ GitHub Hosted Runner æ²’é€™å•é¡Œï¼Œæ‰€ä»¥ç›´æ¥ç”¨ device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})"

          # ç™¼ç”ŸéŒ¯èª¤ä¸ç›´æ¥é€€å‡ºä¸¦å°‡æ‰€æœ‰è¼¸å‡ºéƒ½å¯«å…¥ temp/testing_output.txt æª”æ¡ˆ
          # å¾ŒçºŒæˆ‘å€‘æœƒåˆ†ææª”æ¡ˆå…§å®¹å€åˆ†å‡ºæ˜¯ Build Failed é‚„æ˜¯ Test Failedï¼ŒComment ä¸åŒè¨Šæ¯åˆ° PR
          set +e
          
          # EXIT_CODE å„²å­˜åŸ·è¡Œçµæœçš„ exit code.
          # 0 = OK
          # 1 = exit
          EXIT_CODE=0
          
          # æ‰€æœ‰è¼¸å‡ºéƒ½å¯«å…¥æª”æ¡ˆ
          bundle exec fastlane ${TEST_LANE} device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})" | tee "$RUNNER_TEMP/testing_output.txt"
          # å¦‚æœç›®å‰ EXIT_CODE æ˜¯ 0ï¼Œå‰‡å°‡ ${pipestatus[1]} è³¦å€¼çµ¦ EXIT_CODE
          [[ $EXIT_CODE -eq 0 ]] && EXIT_CODE=${pipestatus[1]}

          # æ¢å¾©å‡ºéŒ¯å°±é€€å‡º
          set -e

          # æª¢æŸ¥ Testing Output
          # å¦‚æœ Testing Output åŒ…å« "Error building"ï¼Œå‰‡è¨­ is_build_error=true çµ¦ Actions ç’°å¢ƒè®Šæ•¸ï¼Œç‚º Build å°±å¤±æ•—
          # å¦‚æœ Testing Output åŒ…å« "Tests have failed"ï¼Œå‰‡è¨­ is_test_error=true çµ¦ Actions ç’°å¢ƒè®Šæ•¸ï¼Œç‚ºæ¸¬è©¦å¤±æ•—
          
          if grep -q "Error building" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_build_error=true" >> $GITHUB_OUTPUT
            echo "âŒ Detected Build Error"
          elif grep -q "Tests have failed" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_test_error=true" >> $GITHUB_OUTPUT
            echo "âŒ Detected Test Error"
          fi

          # æ¢å¾© Exit Code Output
          exit $EXIT_CODE
          
      # ========== Handle Result Steps ==========
      
      # è§£æ *.junit æ¸¬è©¦å ±å‘Šï¼Œä¸¦æ¨™è¨˜çµæœã€Comment(å¦‚æœæ˜¯ PR çš„è©±)
      - name: Publish Test Report
        # ç›´æ¥å¾©ç”¨åˆ¥äººå¯«å¥½çš„ .junit Paser Actions: https://github.com/mikepenz/action-junit-report
        uses: mikepenz/action-junit-report@v5
        # if:
        # ä¸Šä¸€æ­¥(Testing) success or
        # ä¸Šä¸€æ­¥(Testing) failed and is_test_error (build failed ä¸åŸ·è¡Œé€™å€‹ step)
        if: ${{ (failure() && steps.testing.outputs.is_test_error == 'true') || success() }}
        with:
          check_name: "Testing Report"
          comment: true
          updateComment: false
          require_tests: true
          detailed_summary: true
          report_paths: "./Product/fastlane/test_output/*.junit"

      # æ¸¬è©¦å»ºç½®å¤±æ•— Comment
      - name: Build Failure Comment
        # if:
        # ä¸Šä¸€æ­¥(Testing) failed and is_build_error and æœ‰ PR Number
        # 
        if: ${{ failure() && steps.testing.outputs.is_build_error == 'true' && github.event.pull_request.number }}
        uses: actions/github-script@v6
        env:
          action_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}"
        with:
            script: |
              const action_url = process.env.action_url
              const pullRequest = context.payload.pull_request || {}
              const commitSha = pullRequest.head?.sha || context.sha
              const creator = pullRequest.user?.login || context.actor
        
              const commentBody = [
                `# å°ˆæ¡ˆæˆ–æ¸¬è©¦å»ºç½®å¤±æ•— âŒ`,
                `è«‹ç¢ºèªæ‚¨çš„ Pull Request æ˜¯å¦å¯ä»¥æ­£ç¢ºç·¨è­¯èˆ‡åŸ·è¡Œæ¸¬è©¦ã€‚`,
                ``,
                `ğŸ”— **Action**: [View Workflow Run](${action_url})`,
                `ğŸ“ **Commit**: ${commitSha}`,
                `ğŸ‘¤ **Author**: @${creator}`
              ].join('\n')
        
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              })
```

**æŠ€è¡“é‡é»èªªæ˜ï¼š**
- runs\-on: å»ºè­°æ”¹ç”¨ self\-hosted Runnerï¼Œ [GitHub Hosted Runner macOS å¾ˆè²´çš„](https://docs.github.com/en/billing/managing-billing-for-your-products/about-billing-for-github-actions#per-minute-rates){:target="_blank"} ã€‚
- æ‰‹å‹•è®€å– `.xcode-version` æª”æ¡ˆå–å¾—æŒ‡å®šçš„ XCode ç‰ˆæœ¬ä¸¦åœ¨éœ€è¦æŒ‡å®š XCode çš„ Step è¨­å®š `DEVELOPER_DIR` env å¯ä»¥è¼•é¬†å… Sudo åˆ‡æ› XCode
- Cache: å¯ä»¥åŠ é€Ÿä¾è³´å®‰è£é€Ÿåº¦ï¼Œä½†éœ€æ³¨æ„å°±ç®—æ˜¯ self\-hosted Runner ä¾ç„¶æœƒä½¿ç”¨ GitHub Cloud Cacheï¼Œå—åˆ°æ”¶è²»é™åˆ¶
- ä½¿ç”¨ `set +e` ä½¿æŒ‡ä»¤åŸ·è¡Œå¤±æ•—ä¸æœƒé¦¬ä¸Šé€€å‡º\+å°‡ output éƒ½è¼¸å‡ºåˆ°æª”æ¡ˆ\+è®€å–æª”æ¡ˆåˆ¤æ–·æ˜¯ Build Failed or Test Failedï¼›å¦‚æœä¸é€™æ¨£åšè¨Šæ¯çµ±ä¸€éƒ½æœƒæ˜¯ Test Failedã€‚
ä¹Ÿå¯ä»¥å»¶ä¼¸å»åˆ¤æ–·å…¶ä»–éŒ¯èª¤ï¼Œä¾‹å¦‚ï¼š `Underlying Error: Unable to boot the Simulator.` æ¨¡æ“¬å™¨å•Ÿå‹•å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚
- Checkout Code å¯æ¥å—æŒ‡å®šåˆ†æ”¯ï¼šå› ç‚º `on: schedule` äº‹ä»¶åªèƒ½åœ¨ main \(Default Branch\) è§¸ç™¼ï¼Œå¦‚æœæˆ‘å€‘å¸Œæœ›æ’ç¨‹å°æŸå€‹å…¶ä»–åˆ†æ”¯æ“ä½œï¼Œå°±éœ€è¦æŒ‡å®šåˆ†æ”¯ã€‚
- æŒ‡å®š \.cocoapods Repo è·¯å¾‘å¯åšå¯ä¸åšï¼Œä¹‹å‰æ˜¯é‡é self\-hosted åŒä¸€å°æ©Ÿå™¨å…©å€‹ Runner åŒæ™‚å¡åœ¨ pod install å°±æ˜¯å› ç‚ºå‰›å¥½éƒ½åœ¨é‡å° \.cocoapods Repo æ“ä½œé€ æˆ git lockã€‚
\(ä½†æ©Ÿç‡å¾ˆä½å°±æ˜¯äº†\)
- **å¦‚æœä½ æœ‰ Private Pods Repo éœ€è¦ Clone éœ€è¦ [åƒè€ƒæ­¤å›ç­”](https://stackoverflow.com/questions/57612428/cloning-private-github-repository-within-organisation-in-actions){:target="_blank"} è¨­å®š SSH Agent æ‰æœ‰æ¬Šé™ Cloneã€‚**
- è¨˜å¾—åˆ° Repo \-&gt; Settings \-&gt; Actions secrets and variables \-&gt; variables æ–°å¢ï¼š
`SIMULATOR_IOS_VERSION` æ¨¡æ“¬å™¨ iOS ç‰ˆæœ¬
`SIMULATOR_NAME` æ¨¡æ“¬å™¨åç¨±



![](/assets/4b001d2e8440/1*Vj37P9vZ6KL5wWNvU3Cq3Q.png)


**Commit æª”æ¡ˆåˆ° Repo ä¸»åˆ†æ”¯ï¼Œæ‰‹å‹•è§¸ç™¼ä¸€æ¬¡é©—è­‰æ­£ä¸æ­£ç¢ºï¼š**


![](/assets/4b001d2e8440/1*tA2nKehTJ7aURSGgU7MM0g.png)



![](/assets/4b001d2e8440/1*Qap3KmhIJrLov2O7GneV3w.png)


æ­£ç¢ºå¾Œç¹¼çºŒè¨­å®šã€‚
#### GitHub æµç¨‹è¨­å®š

Repo â†’ Settins â†’ Rules â†’ Rulesetsã€‚


![](/assets/4b001d2e8440/1*cf_M6NnakdcbzvC2VHSfpw.png)

- Ruleset Name: è¦å‰‡åç¨±
- Enforcement status: å•Ÿç”¨/åœç”¨ æ­¤è¦å‰‡é™åˆ¶
- Target branches: ç›®æ¨™çš„ Base åˆ†æ”¯ï¼Œè¨­ Default Branch å°±æ˜¯æ‰€æœ‰æƒ³åˆé€²åˆ° main or develop çš„åˆ†æ”¯éƒ½å—åˆ°æ­¤è¦å‰‡é™åˆ¶
- Bypass list: å¯æŒ‡å®šç‰¹æ®Šèº«ä»½ã€Team å¯ä»¥ä¸å—æ­¤é™
- Branch rules:



![](/assets/4b001d2e8440/1*Hzd9CCTsu18kyDR1goRWag.png)

- Restrict deletions: ç¦æ­¢åˆªé™¤åˆ†æ”¯
- Require a pull request before mergin: åªèƒ½é€é PR Merge
Required approvals: é™åˆ¶éœ€è¦å¹¾äºº Approve
- Require status checks to pass: é™åˆ¶å“ªäº› Checks è¦ Passed æ‰èƒ½ Merge
é» \+ Add checks è¼¸å…¥ `Testing` é¸æ“‡æœ‰ GitHub Actions æ¨™èªŒçš„ã€‚
**é€™é‚Šæœ‰å€‹å°å•é¡Œï¼Œå¦‚æœæ‰¾ä¸åˆ° `Testing` é‚£éœ€è¦å…ˆå›åˆ° Actions å¤šè§¸ç™¼\(é–‹ PR è©¦è©¦\)åŸ·è¡Œå¹¾æ¬¡ï¼Œé€™è£¡æ‰æœƒå‡ºç¾ã€‚**
- Block force pushes: ç¦æ­¢ Force push


å„²å­˜ã€ç¢ºå®š Enforcement status æ˜¯ Active å¾Œï¼Œè¦å‰‡å°±æœƒç”Ÿæ•ˆäº†ã€‚

**éƒ½è¨­å®šå¥½ä¹‹å¾Œï¼Œé–‹ PR æ¸¬è©¦çœ‹çœ‹ï¼š**


![](/assets/4b001d2e8440/1*iPETBWx6Boq12rY1fHXmuQ.png)

- Checks æœ‰å‡ºç¾ CI\-Testing \( **Requried** \)ã€Merging is blockedã€At least X approving review is required by reviewers with write access\. ä»£è¡¨è¨­ç½®æˆåŠŸäº†ã€‚


**å¦‚æœå°ˆæ¡ˆå»ºç½®å¤±æ•— \(Build Failed\) æœƒ Commentï¼š**


![](/assets/4b001d2e8440/1*4E35VRPo--pI8uqrR4UZNA.png)


**å¦‚æœå°ˆæ¡ˆå»ºç½®æˆåŠŸä½†æ¸¬è©¦æ¡ˆä¾‹å¤±æ•— \(Test Failed\) æœƒ Commentï¼š**


![](/assets/4b001d2e8440/1*wYFzsn5a_yvi8CbZxi-QdQ.png)


**å¦‚æœå°ˆæ¡ˆå»ºç½®æˆåŠŸæ¸¬è©¦ä¹ŸæˆåŠŸ\(Test Success\) æœƒ Commentï¼š**


![](/assets/4b001d2e8440/1*WqPK1629jYdYTEWCWBHWqg.png)


**å®Œæˆ Review Approve \+ Check æ¸¬è©¦é€šéå¾Œï¼š**


![[Demo PR](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target="_blank"}](/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.png)

[Demo PR](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target="_blank"}

å°±èƒ½ Merge PRã€‚
- å¦‚æœæœ‰ Push New Commit æœƒè‡ªå‹•é‡è·‘ Checks æ¸¬è©¦ã€‚


**å®Œæ•´ç¨‹å¼ç¢¼ï¼š [CI\-Testing\.yml](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/blob/main/.github/workflows/CI-Testing.yml){:target="_blank"}**
### CD â€” æ‰“åŒ…\+éƒ¨ç½²åˆ° Firebase App Distribution
#### æµç¨‹

ä½¿ç”¨ GitHub Actions è¡¨å–®è§¸ç™¼æ‰“åŒ…å·¥ä½œï¼Œå¯æŒ‡å®šç‰ˆæœ¬è™Ÿã€Release Notesï¼Œæ‰“åŒ…å®Œæœƒè‡ªå‹•ä¸Šå‚³åˆ° Firebase App Distribution ä¾›åœ˜éšŠä¸‹è¼‰æ¸¬è©¦ä½¿ç”¨ã€‚
#### CD\-Deploy\.yml

Repo â†’ Actions â†’ New workflow â†’ set up a workflow yourselfã€‚
```yaml
# Workflow(Action) åç¨±
name: CD-Deploy

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "[CD-Deploy] ${{ github.ref }}"

# åŒå€‹ Concurrency Group å¦‚æœæœ‰æ–°çš„ Job æœƒå–æ¶ˆæ­£åœ¨è·‘çš„
# ä¾‹å¦‚ é‡è¤‡è§¸ç™¼ç›¸åŒåˆ†æ”¯çš„æ‰“åŒ…ä»»å‹™ï¼Œæœƒå–æ¶ˆå‰ä¸€å€‹ä»»å‹™
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

# è§¸ç™¼äº‹ä»¶
on:
  # æ‰‹å‹•è¡¨å–®è§¸ç™¼
  workflow_dispatch:
    # è¡¨å–® Inputs æ¬„ä½
    inputs:
      # App ç‰ˆæœ¬è™Ÿ
      VERSION_NUMBER:
        description: 'Version Number of the app (e.g., 1.0.0). Auto-detect from the Xcode project if left blank.'
        required: false
        type: string
      # App Build Number
      BUILD_NUMBER:
        description: 'Build number of the app (e.g., 1). Will use a timestamp if left blank.'
        required: false
        type: string
      # App Release Note
      RELEASE_NOTE:
        description: 'Release notes of the deployment.'
        required: false
        type: string
  # å…¶ä»– Workflow å‘¼å«æ­¤ Workflow è§¸ç™¼
  # Nightly Build æœƒå‘¼å«ä½¿ç”¨
  workflow_call:
    inputs:
      # App ç‰ˆæœ¬è™Ÿ
      VERSION_NUMBER:
        description: 'Version Number of the app (e.g., 1.0.0). Auto-detect from the Xcode project if left blank.'
        required: false
        type: string
      # App Build Number
      BUILD_NUMBER:
        description: 'Build number of the app (e.g., 1). Will use a timestamp if left blank.'
        required: false
        type: string
      # App Release Note
      RELEASE_NOTE:
        description: 'Release notes of the deployment.'
        required: false
        type: string
      BRANCH:
        description: 'Branch'
        type: string


# å®šç¾©å…¨åŸŸéœæ…‹è®Šæ•¸
env:
  APP_STORE_CONNECT_API_KEY_FILE_NAME: "app_store_connect_api_key.json"

# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # Job ID
  deploy:
    # Job åç¨± (å¯çœç•¥ï¼Œæœ‰è¨­å®šåœ¨ Log é¡¯ç¤ºæ¯”è¼ƒå¥½è®€)
    name: Deploy - Firebase App Distribution
    
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner macos-15 ä¾†åŸ·è¡Œå·¥ä½œ
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # å¦‚æœæ˜¯ Private Repo éœ€è¦æŒ‰è¨ˆé‡æ”¶è²»ï¼ŒmacOS æ©Ÿå™¨æ˜¯æœ€è²´çš„(10å€)ï¼Œå¯èƒ½è·‘ 10 æ¬¡å°±é”åˆ° 2,000 åˆ†é˜å…è²»ä¸Šé™
    # å»ºè­°ä½¿ç”¨ self-hosted Runner
    runs-on: macos-15

    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 30

    # use zsh
    # å¯çœç•¥ï¼Œåªæ˜¯æˆ‘ç¿’æ…£ç”¨ zshï¼Œé è¨­æ˜¯ bash
    defaults:
      run:
        shell: zsh {0}

    # å·¥ä½œæ­¥é©Ÿ
    # å·¥ä½œæ­¥é©Ÿæœƒç…§é †åºåŸ·è¡Œ  
    steps:
      # git clone ç•¶å‰å°ˆæ¡ˆ & checkout åˆ°åŸ·è¡Œçš„åˆ†æ”¯
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Git Large File Storageï¼Œæˆ‘å€‘çš„æ¸¬è©¦ç’°å¢ƒç”¨ä¸åˆ°
          # default: false
          lfs: false
          
          # å¦‚æœæœ‰æŒ‡å®šå‰‡ Checkout æŒ‡å®šåˆ†æ”¯ï¼Œæ²’æœ‰å‰‡ä½¿ç”¨é è¨­(ç•¶å‰åˆ†æ”¯)
          # å›  on: schedule äº‹ä»¶åªèƒ½åœ¨ main ä¸»åˆ†æ”¯åŸ·è¡Œï¼Œå› æ­¤æƒ³åš Nightly Build ä¹‹é¡çš„å·¥ä½œå°±éœ€è¦æŒ‡å®šåˆ†æ”¯
          # e.g. on: schedule -> main åˆ†æ”¯ï¼ŒNightly Build master åˆ†æ”¯
          ref: ${{ github.event.inputs.BRANCH || '' }}

      # ========== Certificates Steps ==========
      
      # å»ºè­°æ˜¯ä½¿ç”¨ Fastlnae - Match ç®¡ç†é–‹ç™¼æ†‘è­‰ä¸¦åœ¨ Lane ä¸­ç›´æ¥åŸ·è¡Œ match å®‰è£è¨­å®šå¥½
      # Match æœƒç”¨å¦ä¸€å€‹ Private Repo ç®¡ç†æ†‘è­‰ï¼Œä½†è¦è¨­å®šå¥½ SSH Agent æ‰æœ‰æ¬Šé™ git clone private repo
      # ref: https://stackoverflow.com/questions/57612428/cloning-private-github-repository-within-organisation-in-actions
      #
      #
      # --- ä»¥ä¸‹æ˜¯æ²’æœ‰ä½¿ç”¨ Fastlane - Match çš„æƒ…æ³ä¸‹ç›´æ¥ä¸‹è¼‰ & Import æ†‘è­‰çµ¦ Runner çš„åšæ³• ---
      # ref: https://docs.github.com/en/actions/how-tos/use-cases-and-examples/deploying/installing-an-apple-certificate-on-macos-runners-for-xcode-development
      #
      # GitHub Actions Secret ç„¡æ³•å„²å­˜æª”æ¡ˆï¼Œå› æ­¤æ‰€æœ‰æ†‘è­‰æª”æ¡ˆéƒ½è¦å…ˆè½‰æˆ Base64 Encoded æ–‡å­—æ ¼å¼å­˜åœ¨ Secret
      # åœ¨ GitHub Actions Step ä¸­å†å‹•æ…‹è®€å‡ºä¾†å¯«å…¥ TEMP æª”æ¡ˆä¸¦ç§»å‹•åˆ°æ­£ç¢ºä½ç½®çµ¦ç³»çµ±è®€å–ä½¿ç”¨
      # å…¶ä»–è¨­å®šç´°ç¯€è«‹åƒè€ƒæ–‡ç« 
      #
      - name: Install the Apple certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.BUILD_CERTIFICATE_P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          # GitHub Hosted Runner ç‚ºè‡ªå®šç¾©å­—ä¸²
          # Self-hosted Runner ç‚ºæ©Ÿå™¨ç™»å…¥å¯†ç¢¼
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate and provisioning profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      # App Store Connect API Fastlane JSON Key
      # å¦ä¸€å€‹åœ¨æ‰“åŒ…ç’°å¢ƒå¹¾ä¹æ˜¯å¿…é ˆçš„ App Store Connect API Fastlane JSON Key (.json)
      # format: .json å…§å®¹æ ¼å¼ï¼šhttps://docs.fastlane.tools/app-store-connect-api/
      # è£¡é¢åŒ…å« App Store Connect API .p8 Key
      # æœƒåœ¨å¾ŒçºŒå¸¶çµ¦ Fastlaneï¼Œç”¨æ–¼ä¸Šå‚³åˆ° Testflightã€App Store API ä½¿ç”¨
      #
      # GitHub Actions Secret ç„¡æ³•å„²å­˜æª”æ¡ˆï¼Œå› æ­¤æ‰€æœ‰æ†‘è­‰æª”æ¡ˆéƒ½è¦å…ˆè½‰æˆ Base64 Encoded æ–‡å­—æ ¼å¼å­˜åœ¨ Secret
      # åœ¨ GitHub Actions Step ä¸­å†å‹•æ…‹è®€å‡ºä¾†å¯«å…¥ TEMP æª”æ¡ˆä¾›å…¶ä»–æ­¥é©Ÿå¼•ç”¨ä½¿ç”¨
      # å…¶ä»–è¨­å®šç´°ç¯€è«‹åƒè€ƒæ–‡ç« 
      - name: Read and Write Apple Store Connect API Key to Temp
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          APP_STORE_CONNECT_API_KEY_PATH: "${{ runner.temp }}/${{ env.APP_STORE_CONNECT_API_KEY_FILE_NAME }}"
        run: |
          # import certificate and provisioning profile from secrets
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode -o $APP_STORE_CONNECT_API_KEY_PATH

      # ========== Env Setup Steps ==========
      
      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ XCode ç‰ˆæœ¬
      # åœ¨å¾ŒçºŒä¹‹ä¸­ï¼Œæˆ‘å€‘è‡ªå·±æ‰‹å‹•æŒ‡å®šä½¿ç”¨çš„ XCode_x.x.x.app
      # è€Œä¸ä½¿ç”¨ xcversionï¼Œå› ç‚º xcversion å·²ç¶“ sunset ä¸ç©©å®šã€‚ 
      - name: Read .xcode-version
        id: read_xcode_version
        run: |
          XCODE_VERSION=$(cat .xcode-version)
          echo "XCODE_VERSION: ${XCODE_VERSION}"
          echo "xcode_version=${XCODE_VERSION}" >> $GITHUB_OUTPUT

          # ä¹Ÿå¯ä»¥ç›´æ¥åœ¨é€™æŒ‡å®šå…¨åŸŸ XCode ç‰ˆæœ¬ï¼Œé€™æ¨£å°±ä¸ç”¨åœ¨å¾ŒçºŒæ­¥é©ŸæŒ‡å®š DEVELOPER_DIR
          # ä½†æ­¤æŒ‡ä»¤éœ€è¦ sudoer æ¬Šé™ï¼Œå¦‚æœæ˜¯ self-hosted runner å°±è¦ç¢ºå®š runner åŸ·è¡Œç’°å¢ƒæœ‰ sudo æ¬Šé™
          # sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"

      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ Ruby ç‰ˆæœ¬
      - name: Read .ruby-version
        id: read_ruby_version
        run: |
          RUBY_VERSION=$(cat .ruby-version)
          echo "RUBY_VERSION: ${RUBY_VERSION}"
          echo "ruby_version=${RUBY_VERSION}" >> $GITHUB_OUTPUT

      # å®‰è£æˆ–è¨­å®š Runner Ruby ç‰ˆæœ¬æˆå°ˆæ¡ˆæŒ‡å®šç‰ˆæœ¬
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "${{ steps.read_ruby_version.outputs.ruby_version }}"

      # å¯è¨­å¯ä¸è¨­ï¼ŒåŸå› æ˜¯ä¹‹å‰åœ¨ self-hosted èµ·å¤šå€‹ runner è·‘ CI/CD å› ç‚º cocoapods repos æ˜¯å…±ç”¨ç›®éŒ„
      # è§£æ±ºçš„å•é¡Œæ˜¯ï¼šæœ‰å¾ˆå°çš„æ©Ÿç‡æœƒå‡ºç¾åœ¨åŒæ™‚ pod install æ™‚æ‹‰ cocoapods repos å‡ºç¾è¡çª(å› ç‚ºé è¨­éƒ½æ˜¯ç”¨) $HOME/.cocoapods/
      # GitHub Hosted Runner å‰‡ä¸éœ€æ­¤è¨­å®š
      # - name: Change Cocoapods Repos Folder
      #   if: contains(runner.labels, 'self-hosted')
      #   run: |
      #     # æ¯å€‹ Runner ç”¨è‡ªå·±çš„ .cocoapods è³‡æ–™å¤¾ï¼Œé˜²æ­¢è³‡æºè¡çª
      #     mkdir -p "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/"
      #     export CP_HOME_DIR="$HOME/.cocoapods-${{ env.RUNNER_NAME }}"
      #     rm -f "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/repos/cocoapods/.git/index.lock"

      # ========== Cache Setting Steps ==========
      # è«‹æ³¨æ„ï¼Œå°±ç®—æ˜¯ self-hostedï¼ŒCache ç›®å‰ä¹Ÿæ˜¯ Cloud Cache æœƒè¨ˆç®—ç”¨é‡
      # è¦å‰‡ï¼š7 å¤©æœª hit è‡ªå‹•åˆªé™¤ã€å–®å€‹ Cache ä¸Šé™ 10 GBã€Action æˆåŠŸæ‰æœƒ Cache
      # Public Repo: å…è²»ç„¡é™åˆ¶
      # Private Repo: 5 GB èµ·
      # Self-hosted å¯ä»¥è‡ªå·±ç”¨ shell script æ’°å¯« Cache & Restore ç­–ç•¥æˆ–ä½¿ç”¨å…¶ä»–å·¥å…·å”åŠ©
      
      # Bundle Cache (Gemfile)
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šäº† Bundle  å®‰è£è·¯å¾‘ ./vendor ä¸‹
      - name: Cache Bundle
        uses: actions/cache@v3
        with:
          path: |
            ./vendor
          key: ${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-bundle-

      # CocoaPods Cache (Podfile)
      # é»˜èªå°±æ˜¯ å°ˆæ¡ˆ/Pods ä¸‹
      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ./Product/Pods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      # Mint cache
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šçš„ Mint å®‰è£è·¯å¾‘ ./mint ä¸‹
      - name: Cache Mint
        uses: actions/cache@v3
        with:
          path: ./mint
          key: ${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      # ====================

      # å°ˆæ¡ˆ Setup & ä¾è³´å®‰è£
      - name: Setup & Install Dependency
        run: |
          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Setup æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # brew install mint
          # bundle config set path 'vendor/bundle'
          # bundle install
          # mint bootstrap
          # ...
          # ç­‰ç­‰ setup æŒ‡ä»¤
          make setup

          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Install æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # mint run yonaskolb/XcodeGen --quiet
          # bundle exec pod install
          # ...
          # ç­‰ç­‰ install æŒ‡ä»¤
          make install

      - name: Deploy Beta
        id: deploy
        # æŒ‡å®šå·¥ä½œç›®éŒ„ï¼Œé€™æ¨£å¾ŒçºŒæŒ‡ä»¤å°±ä¸ç”¨åœ¨ç‰¹åˆ¥ cd ./Product/
        working-directory: ./Product/
        env:
          # æ‰“åŒ… Input åƒæ•¸
          VERSION_NUMBER: ${{ inputs.VERSION_NUMBER || '' }}
          BUILD_NUMBER: ${{ inputs.BUILD_NUMBER || '' }}
          RELEASE_NOTE: ${{ inputs.RELEASE_NOTE || '' }}
          AUTHOR: ${{ github.actor }}

          # Repo -> Settings -> Actions secrets and variables -> secrets
          # Firebase CLI Token å¯†é‘° (å–å¾—æ–¹å¼è«‹åƒè€ƒæ–‡ç« )
          FIREBASE_CLI_TOKEN: ${{ secrets.FIREBASE_CLI_TOKEN }}
          # Apple Developer Program Team ID
          TEAM_ID: ${{ secrets.TEAM_ID }}
                    
          # æŒ‡å®šé€™å€‹ Job è¦ä½¿ç”¨ XCode_x.x.x æŒ‡å®šçš„ç‰ˆæœ¬åŸ·è¡Œ
          DEVELOPER_DIR: "/Applications/Xcode_${{ steps.read_xcode_version.outputs.xcode_version }}.app/Contents/Developer"
        run: |
          # å–å¾—ç•¶å‰ Timestamp
          BUILD_TIMESTAMP=$(date +'%Y%m%d%H%M%S')

          # å¦‚æœ BUILD_NUMBER æ²’æœ‰å€¼ï¼Œç”¨ Timestamp ç•¶ App Build Number
          BUILD_NUMBER="${BUILD_NUMBER:-$BUILD_TIMESTAMP}"
  
          ID="${{ github.run_id }}"
          COMMIT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"
          AUTHOR="${{ env.AUTHOR }}"

          # çµ„åˆ Release Note
          RELEASE_NOTE="${{ env.RELEASE_NOTE }}
          ID: ${ID}
          Commit SHA: ${COMMIT_SHA}
          Branch: ${BRANCH_NAME}
          Author: ${AUTHOR}
          "

          # åŸ·è¡Œ Fastlane æ‰“åŒ…ï¼†éƒ¨ç½² Lane
          bundle exec fastlane beta release_notes:"${RELEASE_NOTE}" version_number:"${VERSION_NUMBER}" build_number:"${BUILD_NUMBER}"

      # GitHub Actions å»ºè­°çš„ self-hosted å®‰å…¨æ€§è¨­å®šï¼š
      # ref: https://docs.github.com/en/actions/how-tos/use-cases-and-examples/deploying/installing-an-apple-certificate-on-macos-runners-for-xcode-development#required-clean-up-on-self-hosted-runners
      # å°æ‡‰ Step: Install the Apple certificate and provisioning profile
      # ç”¨é€”æ˜¯åˆªé™¤æ©Ÿå™¨ä¸Šä¸‹è¼‰ä¸‹ä¾†çš„é‡‘é‘°æ†‘è­‰
      # å¦‚æœä½ æ˜¯ç”¨ Match å‰‡éœ€è¦æ”¹å¯«æˆ Match çš„ Clean
      - name: Clean up keychain and provisioning profile
        if: ${{ always() && contains(runner.labels, 'self-hosted') }}
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
          rm ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision
```
- è¨˜å¾—åˆ° Repo \-&gt; Settings \-&gt; Actions secrets and variables \-&gt; secrets æ–°å¢ä¸€å€‹ `TEAM_ID` è®Šæ•¸ï¼Œå…§å®¹æ˜¯ Apple Developer Team ID å­—ä¸²ã€‚



![](/assets/4b001d2e8440/1*dxdmT_N_w_VUd56f6GRLSQ.png)


**Commit æª”æ¡ˆåˆ° Repo ä¸»åˆ†æ”¯ï¼Œæ¸¬è©¦çœ‹çœ‹æ‰“åŒ…åŠŸèƒ½ï¼š**


![](/assets/4b001d2e8440/1*Z_UAfWAsJSIoWxeTRMvtDQ.png)



> _è«‹æ³¨æ„è‹¥å…¶ä»–åˆ†æ”¯è¦ä½¿ç”¨æ­¤ Action éœ€è¦å…ˆ Merge ä¸»åˆ†æ”¯çš„ CD\-Deploy\.yml æª”æ¡ˆã€‚_ 





**ç­‰å¾…ä»»å‹™è·‘å®Œï¼š**


![](/assets/4b001d2e8440/1*Q-c2IUlJpssooiqcqcm_Bg.png)



![[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16114046420){:target="_blank"}](/assets/4b001d2e8440/1*W8PBkatfsITMDFSlp7xpjg.png)

[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16114046420){:target="_blank"}


> **_æ‰“åŒ…ï¼‹éƒ¨ç½²æˆåŠŸ âœ…_** 





**å®Œæ•´ç¨‹å¼ç¢¼ï¼š [CD\-Deploy\.yml](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/blob/main/.github/workflows/CD-Deploy.yml){:target="_blank"}**
#### æŠ€è¡“ç´°ç¯€ â€” Firebase CLI Token å–å¾—ï¼†è¨­å®š

æŒ‰ç…§ [Firebase å®˜æ–¹æ–‡ä»¶æ­¥é©Ÿ](https://firebase.google.com/docs/cli?hl=zh-tw#install-cli-mac-linux){:target="_blank"} ï¼š

å…ˆå®‰è£å¥½ Firebase CLI å·¥å…·ï¼š
```bash
curl -sL https://firebase.tools | bash
```

åŸ·è¡Œï¼š
```bash
firebase login:ci
```

å®Œæˆç™»å…¥ã€æˆæ¬Šï¼š


![](/assets/4b001d2e8440/1*Jex5aYzRSs7Trfx6z_e1Aw.png)



![](/assets/4b001d2e8440/1*S-1ckn9WC6j0DIqZGSdUUg.png)


å›åˆ° Terminal è¤‡è£½ Firebase CLI Token:


![](/assets/4b001d2e8440/1*sa_h8L08JbeC2nA0kACQtQ.png)


åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `FIREBASE_CLI_TOKEN` ä¸¦è²¼ä¸Š Firebase CLI Tokenã€‚


![](/assets/4b001d2e8440/1*Lc6yGPu7L_0z6u1HH2PB5A.png)

#### æŠ€è¡“ç´°ç¯€ â€” Install the Apple certificate and provisioning profile

è£œå……é–‹ç™¼æ†‘è­‰åŒ¯å…¥ Runner çš„æ­¥é©Ÿç´°ç¯€ã€‚

å›  GitHub Actions Secret ç„¡æ³•å„²å­˜æª”æ¡ˆï¼Œå› æ­¤æ‰€æœ‰æ†‘è­‰æª”æ¡ˆéƒ½è¦å…ˆè½‰æˆ Base64 Encoded æ–‡å­—æ ¼å¼å­˜åœ¨ Secretsï¼ŒGitHub Actions Step ä¸­å†å‹•æ…‹è®€å‡ºä¾†å¯«å…¥ TEMP æª”æ¡ˆä¸¦ç§»å‹•åˆ°æ­£ç¢ºä½ç½®çµ¦ç³»çµ±è®€å–ä½¿ç”¨ã€‚

**æ‰“åŒ… Development éœ€è¦å…©æŠŠé‡‘é‘°æ†‘è­‰ï¼š**
- [Provision Profile \( \.mobileprovision\)](https://developer.apple.com/account/resources/certificates/list){:target="_blank"}
- [Development Certifcate \( \.p12\)](https://developer.apple.com/account/resources/certificates/list){:target="_blank"}



![cicd\.mobileprovision](/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.png)

cicd\.mobileprovision


![development\.cer](/assets/4b001d2e8440/1*RkeZ1PkXeY9Nt1kSRJKEQw.png)

development\.cer

å¾ [Apple Developer](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} ä¸­ä¸‹è¼‰çš„ Certificate æ˜¯ \.cer æ ¼å¼ï¼Œè€Œæˆ‘å€‘éœ€è¦çš„æ˜¯ \.p12 æ ¼å¼ï¼Œå¯ä»¥å…ˆæŠŠä¸‹è¼‰ä¸‹ä¾†çš„ \.cer é»å…©ä¸‹å®‰è£åˆ° Keychainï¼Œç„¶å¾Œæ‰“é–‹ Keychain é¸æ“‡è©²æ†‘è­‰å³éµ Export åŒ¯å‡ºã€‚


![](/assets/4b001d2e8440/1*HJMxwM3IDjxT-UGqnoUtWw.png)


æª”æ¡ˆåç¨±ï¼šcicd\.p12ã€æ ¼å¼ \.p12

P12 é‡‘é‘°å¯†ç¢¼ï¼šè¼¸å…¥ä¸€çµ„å®‰å…¨çš„è‡ªè¨‚ç¾©å­—ä¸² \(ç¯„ä¾‹æ˜¯ä¸å¥½çš„ç¤ºç¯„ï¼Œç”¨ `123456` \)


![](/assets/4b001d2e8440/1*tyH0XqDVPGPWFJPL4dxksw.png)



![](/assets/4b001d2e8440/1*qKeZWel3w_5wW7meMtHmLA.png)


**ç¾åœ¨å…©å€‹æª”æ¡ˆï¼š** cicd\.p12ã€cicd\.mobileprovision éƒ½æº–å‚™å¥½äº†

**è½‰æ›æˆ BASE64 æ ¼å¼å­—ä¸²ä¸¦å­˜åˆ° Repo Secretsï¼š**
```bash
base64 -i cicd.mobileprovision | pbcopy
```

åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `BUILD_PROVISION_PROFILE_BASE64` ä¸¦è²¼ä¸Šä»¥ä¸Šå…§å®¹ã€‚

\-
```bash
base64 -i cicd.p12 | pbcopy
```

åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `BUILD_CERTIFICATE_BASE64` ä¸¦è²¼ä¸Šä»¥ä¸Šå…§å®¹ã€‚

\-

åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `P12_PASSWORD` å…§å®¹æ˜¯å‰›åŒ¯å‡º P12 é‡‘é‘°è¨­å®šçš„å¯†ç¢¼ã€‚

\-
åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `KEYCHAIN_PASSWORD` ï¼š
å¦‚æœæ˜¯ GitHub Hosted Runner å‰‡éš¨ä¾¿è¼¸å…¥ä¸€å€‹ä»»æ„å­—ä¸²ï¼Œ **å¦‚æœæ˜¯ Self\-hosted Runner å‰‡ç‚º macOS Runner ä½¿ç”¨è€…çš„ç™»å…¥å¯†ç¢¼** ã€‚


![](/assets/4b001d2e8440/1*JZCkFUJCQsggqYtW8acjTw.png)

#### æŠ€è¡“ç´°ç¯€ â€”App Store Connect API Key

Fastlane æ‰“åŒ…éƒ¨ç½²åˆ° App Store, Testflight [å¿…é ˆæä¾›çš„ \.json é‡‘é‘°](https://docs.fastlane.tools/app-store-connect-api/){:target="_blank"} ï¼ŒåŒæ¨£å—é™ GitHub Actions Secrets åªèƒ½å­˜å­—ä¸²ä¸èƒ½å­˜æª”æ¡ˆï¼Œæ‰€ä»¥æˆ‘å€‘ä¹Ÿè¦æŠŠé‡‘é‘°å…§å®¹è½‰æˆ Base64 å­—ä¸²ï¼ŒGitHub Actions Step ä¸­å†å‹•æ…‹è®€å‡ºä¾†å¯«å…¥ TEMP æª”æ¡ˆä¸¦æŠŠæª”æ¡ˆè·¯å¾‘çµ¦ Fastlane å¼•ç”¨ä½¿ç”¨ã€‚

**é¦–å…ˆåˆ° [App Store Connect å»ºç«‹&ä¸‹è¼‰å¥½ App Store Connect API Key](../f1365e51902c/) \( \.p8\) ï¼š**
```vbnet
-----BEGIN PRIVATE KEY-----
sss
axzzvcxz
zxzvzcxv
vzxcvzxvczxcvz
-----END PRIVATE KEY-----
```

æ–°å¢ä¸€å€‹ `app_store_connect_api.json` æª”æ¡ˆ\( [å…§å®¹åƒè€ƒ](https://docs.fastlane.tools/app-store-connect-api/){:target="_blank"} \)ï¼š
```bash
{
  "key_id": "App Store Connect ä¸Šå¯«çš„ Key ID",
  "issuer_id": "App Store Connect ä¸Šå¯«çš„ Issuer ID",
  "key": "-----BEGIN PRIVATE KEY-----è¨˜å¾—æŠŠæ›è¡Œæ”¹æˆ\n-----END PRIVATE KEY-----",
  "duration": 1200, # optional (maximum 1200)
  "in_house": false # optional but may be required if using match/sigh
}
```

å„²å­˜æª”æ¡ˆå¾ŒåŸ·è¡Œï¼š
```bash
base64 -i app_store_connect_api.json | pbcopy
```

å°‡å­—ä¸²å…§å®¹è²¼åˆ° Repo â†’ Settings â†’ Secrets and variables â†’ Actions â†’ æ–°å¢ä¸€å€‹ Secret: `APP_STORE_CONNECT_API_KEY_BASE64` ä¸¦è²¼ä¸Šä»¥ä¸Šå…§å®¹ã€‚


![](/assets/4b001d2e8440/1*QxRuxEPEfWbJ383hhnxGkA.png)


`Read and Write Apple Store Connect API Key to Temp` Step å®Œæˆä¹‹å¾Œåœ¨å¾ŒçºŒçš„ Step åªè¦å‚³å…¥ env `APP_STORE_CONNECT_API_KEY_PATH` :
```yaml
- name: Deploy
  env:
    APP_STORE_CONNECT_API_KEY_PATH: "${{ runner.temp }}/${{ env.APP_STORE_CONNECT_API_KEY_FILE_NAME }}"
  run: |
    ....
```

Fastlane å°±èƒ½è‡ªå‹•å–å¾—ä½¿ç”¨ã€‚
#### æŠ€è¡“å»¶ä¼¸ â€” Reuse Action Workflow æ‹†åˆ†æ‰“åŒ…å’Œéƒ¨ç½²å‹•ä½œ

åœ¨é€™å€‹æ¡ˆä¾‹ä¸­æˆ‘å€‘ç›´æ¥ä½¿ç”¨ Fastlane `beta` Lane åŸ·è¡Œæ‰“åŒ…ï¼‹éƒ¨ç½²å…©å€‹å‹•ä½œã€‚

åœ¨å¯¦éš›æ¡ˆä¾‹ä¸­æˆ‘å€‘å¯èƒ½éœ€è¦å°‡åŒä¸€åŒ…æ‰“åŒ…çµæœåˆ†åˆ¥éƒ¨ç½²åˆ°ä¸åŒå¹³å°ä¸Š\(Firebase, Testflightâ€¦etc\) å› æ­¤æ¯”è¼ƒå¥½çš„åšæ³•æ˜¯æ‰“åŒ…æ˜¯ä¸€å€‹ Actionã€éƒ¨ç½²æ˜¯ä¸€å€‹ Actionï¼Œä¸ç„¶æœƒé‡å¾©è·‘å…©æ¬¡æ‰“åŒ…ï¼›è€Œä¸”ä¹Ÿæ›´ç¬¦åˆ CI/CD çš„æ¬Šè²¬åŠƒåˆ†ã€‚


> **_ä»¥ä¸‹çˆ²ç¯„ä¾‹ä»‹ç´¹ï¼š_** 





**CI\-Build\.yml:**
```yaml
name: Build

on:
  push:
    branches:
      - main
  workflow_call:
     inputs:
        RELEASE_NOTE:
          description: 'Release notes of the deployment.'
          required: false
          type: string

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          make steup
          make instal

      - name: Build Project
        run: bundle exec fastlane build

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ./fastlane/build/
```

**CD\-Deploy\-Firebase\.yml:**
```yaml
name: Deploy Firebase

on:
  # ç•¶ Build Action å®Œæˆæ™‚è‡ªå‹•è§¸ç™¼åŸ·è¡Œ
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # å®Œæˆï¼‹åŸ·è¡ŒæˆåŠŸæ‰åŸ·è¡Œéƒ¨ç½²
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          make steup

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./fastlane/build/

      - name: Deploy to Production
        run: |
          bundle exec fastlane deploy-firebase
```

**CD\-Deploy\-Testflight\.yml:**
```yaml
name: Deploy Testflight

on:
  # ç•¶ Build Action å®Œæˆæ™‚è‡ªå‹•è§¸ç™¼åŸ·è¡Œ
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # å®Œæˆï¼‹åŸ·è¡ŒæˆåŠŸæ‰åŸ·è¡Œéƒ¨ç½²
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          make steup

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./fastlane/build/

      - name: Deploy to Production
        run: |
          bundle exec fastlane deploy-testflight
```

**å¦å¤–ä¹Ÿå¯ä»¥ç”¨ [Reusing Workflow](https://docs.github.com/en/actions/how-tos/sharing-automations/reusing-workflows){:target="_blank"} :**

**CD\-Deploy\-Firebase\.yml:**
```yaml
name: Deploy Firebase

on:
  # ä»»æ„çš„è§¸ç™¼æ¢ä»¶ï¼Œé€™è£¡ä»¥æ‰‹å‹•è¡¨å–®è§¸ç™¼ç‚ºä¾‹
  workflow_dispatch:
    inputs:
      RELEASE_NOTE:
        description: 'Release notes of the deployment.'
        required: false
        type: string
jobs:
  build:
    needs: Build
    uses: ./.github/workflows/CD-Build.yml
    secrets: inherit
    with:
      RELEASE_NOTE: ${{ inputs.RELEASE_NOTE }}

  deploy:
    runs-on: ubuntu-latest
    # Job é è¨­æ˜¯ä¸¦ç™¼åŸ·è¡Œï¼Œç”¨ needs é™åˆ¶éœ€ç­‰å¾… build å®Œæˆæ‰åŸ·è¡Œ
    needs: [build]
    # åŸ·è¡ŒæˆåŠŸï¼Œæ‰éƒ¨ç½²
    if: ${{ always() && needs.deploy.result == 'success' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          make steup

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./fastlane/build/

      - name: Deploy to Production
        run: |
          bundle exec fastlane deploy-firebase
```
#### GitHub Actions â€” Artifact

åŒ Cacheï¼Œç›®å‰ **å°±ç®—æ˜¯ Self\-hosted Runner Artifcact åŠŸèƒ½ä¾ç„¶æœƒèµ° GitHub Cloud** å—åˆ°ä½¿ç”¨é‡é™åˆ¶ \( [å…è²»å¸³è™Ÿ 500MB èµ·](https://docs.github.com/en/billing/managing-billing-for-your-products/about-billing-for-github-actions#included-storage-and-minutes){:target="_blank"} \)ã€‚


> _Self\-hosted Runner è¦é”åˆ°é¡ä¼¼çš„æ•ˆæœå¯ä»¥è‡ªè¡Œå»ºç«‹å…±äº«ä¸»æ©Ÿç›®éŒ„æˆ–æ‰¾å…¶ä»–å·¥å…·æ›¿ä»£ã€‚_ 





å› æ­¤ç›®å‰ Artifact å¯¦éš›æˆ‘åªç”¨ä¾†å­˜æ”¾å°è³‡æ–™ï¼Œä¾‹å¦‚ Snapshot Tests çš„éŒ¯èª¤çµæœã€æ¸¬è©¦å ±å‘Šâ€¦ç­‰ç­‰
### CIâ€” Nightly Build åŸ·è¡Œå¿«ç…§\+å–®å…ƒæ¸¬è©¦\+æ‰“åŒ…\+CD éƒ¨ç½²åˆ° Firebase App Distribution
#### æµç¨‹

æ¯å¤©å‡Œæ™¨ 3 é»è‡ªå‹•é‡å° main\(develop or master\) åˆ†æ”¯è·‘å…¨éƒ¨æ¸¬è©¦\(unit\+snapshot tests\)ï¼Œå¦‚æœå¤±æ•—å‰‡å‚³é€å¤±æ•—é€šçŸ¥åˆ° Slack å·¥ä½œç¾¤çµ„ï¼›å¦‚æœæˆåŠŸå‰‡æ‰“åŒ…\+éƒ¨ç½²ä¸€å€‹ç‰ˆæœ¬åˆ° Firebase App Disturbutionï¼Œæ‰“åŒ…æˆåŠŸ/å¤±æ•—éƒ½æœƒå‚³é€ Slack é€šçŸ¥ã€‚
#### CI\-Nightly\-Build\-And\-Deploy\.yml

Repo â†’ Actions â†’ New workflow â†’ set up a workflow yourselfã€‚
```yaml
# Workflow(Action) åç¨±
name: CI-Nightly Build And Deploy

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "[CI-Nightly Build And Deploy] ${{ github.ref }}"

# è§¸ç™¼äº‹ä»¶
on:
  # æ’ç¨‹å®šæ™‚è‡ªå‹•åŸ·è¡Œ
  # https://crontab.guru/
  # UTC æ™‚é–“
  schedule:
    # UTC çš„ 19:00 = æ¯å¤© UTC+8 çš„ 03:00
    - cron: '0 19 * * *'
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # æ¸¬è©¦å·¥ä½œ
  testing:
    # Reuse Workflow (workflow_call)
    uses: ./.github/workflows/CI-Testing.yml
    # å‚³éæ‰€æœ‰ Secrets çµ¦ CD-Testing.yml
    secrets: inherit
    with:
      # åŸ·è¡Œå…¨éƒ¨æ¸¬è©¦
      TEST_LANE: "run_all_tests"
      # ç›®æ¨™åˆ†æ”¯ï¼šmain, develop or master...etc
      BRANCH: "main"

  deploy-env:
    runs-on: ubuntu-latest
    outputs:
      DATE_STRING: ${{ steps.get_date.outputs.DATE_STRING }}
    steps:
      - name: Get Date String
        id: get_date
        run: |
          VERSION_DATE=$(date -u '+%Y%m%d')
          echo "${VERSION_DATE}"
          echo "DATE_STRING=${VERSION_DATE}" >> $GITHUB_ENV
          echo "DATE_STRING=${VERSION_DATE}" >> $GITHUB_OUTPUT
    
  deploy:
    # Job é è¨­æ˜¯ä¸¦ç™¼åŸ·è¡Œï¼Œç”¨ needs é™åˆ¶éœ€ç­‰å¾… testing å’Œ deploy-env å®Œæˆæ‰åŸ·è¡Œ
    needs: [testing, deploy-env]
    # å¦‚æœæ¸¬è©¦æˆåŠŸæ‰åŸ·è¡Œ
    if: ${{ needs.testing.result == 'success' }}
    # Reuse Workflow (workflow_call)
    uses: ./.github/workflows/CD-Deploy.yml
    # å‚³éæ‰€æœ‰ Secrets çµ¦ CD-Deploy.yml
    secrets: inherit
    with:
      VERSION_NUMBER: NightlyBuild-${{ needs.deploy-env.outputs.DATE_STRING }}
      RELEASE_NOTE: NightlyBuild-${{ needs.deploy-env.outputs.DATE_STRING }}
      # ç›®æ¨™åˆ†æ”¯ï¼šmain, develop or master...etc
      BRANCH: "main"

# ----- Slack Notify -----
  testing-failed-slack-notify:
    needs: [testing]
    runs-on: ubuntu-latest
    if: ${{ needs.testing.result == 'failure' }}
    steps:
      - name: Post text to a Slack channel
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_TEAM_CHANNEL_ID }}
            text: ":x: Nightly Build - Testing å¤±æ•—\nWorkflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"

  deploy-failed-slack-notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: ${{ needs.deploy.result == 'failure' }}
    steps:
      - name: Post text to a Slack channel
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_TEAM_CHANNEL_ID }}
            text: ":x: Nightly Build Deploy å¤±æ•—\nWorkflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"

  deploy-success-slack-notify:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: ${{ needs.deploy.result == 'success' }}
    steps:
      - name: Post text to a Slack channel
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_TEAM_CHANNEL_ID }}
            text: ":white_check_mark: Nightly Build Deploy æˆåŠŸ\nWorkflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
```

**Commit æª”æ¡ˆåˆ° Repo ä¸»åˆ†æ”¯ï¼Œæ‰‹å‹•è§¸ç™¼æ¸¬è©¦ã€æ‰“åŒ…åŠŸèƒ½çœ‹çœ‹çµæœï¼š**


![](/assets/4b001d2e8440/1*l71fL8oLoeAv-JX_FgkqzQ.png)



> _æ—¥å¾Œæœƒæ¯æ—¥è‡ªå‹•è§¸ç™¼ã€‚_ 






![[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target="_blank"}](/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.png)

[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target="_blank"}


![](/assets/4b001d2e8440/1*6DQL_v4eahSqSuVJZRPrEA.png)


ç­‰å¾…æ¸¬è©¦ä»»å‹™ã€æ‰“åŒ…éƒ¨ç½²ä»»å‹™ã€é€šçŸ¥ä»»å‹™éƒ½å®Œæˆå¾Œï¼ŒæŸ¥çœ‹çµæœã€‚


![](/assets/4b001d2e8440/1*4UVgyCQljqZQgzxHpXPB4g.png)



![](/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.jpeg)


æˆ‘å€‘å°±èƒ½ç›´æ¥åœ¨æ‰‹æ©Ÿä¸Šå®‰è£ Nightly Build ç‰ˆæœ¬ä¾†é€²è¡Œæ¶å…ˆé«”é©—æ¸¬è©¦ã€‚
#### æŠ€è¡“ç´°ç¯€

é€™å€‹ Action æˆ‘å€‘ç›´æ¥å¾©ç”¨å‰é¢è¨­è¨ˆçš„ CI\-Testing å’Œ CD\-Deployï¼Œçµ„åˆæˆæˆ‘å€‘çš„ Nightly Buildï¼Œéå¸¸å½ˆæ€§å¥½ç”¨ï¼

**å®Œæ•´ç¨‹å¼ç¢¼ï¼š [CI\-Nightly\-Build\-And\-Deploy\.yml](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/workflows/CI-Nightly-Build-And-Deploy.yml){:target="_blank"}**
### Self\-hosted Runner æ³¨æ„äº‹é …

æœ¬æ–‡æ˜¯ Public Repo å› æ­¤ç›´æ¥ä½¿ç”¨ GitHub Hosted çš„ macOS Runnerï¼Œä½†åœ¨å¯¦éš›å·¥ä½œä¸Šæˆ‘å€‘çš„ Repo ä¸€å®šæ˜¯ Privateï¼Œç›´æ¥ä½¿ç”¨ GitHub Hosted Runner è¶…è²´ä¸åˆ’ç®—\(ç´„ä¸€å€‹æœˆå°±èƒ½è²·ä¸€å° Mac Mini æ”¾åœ¨å…¬å¸åƒåˆ°é£½çˆ½çˆ½è·‘\)ï¼Œæ¯ä¸€å°ä¾ç…§æ•ˆèƒ½å¯ä»¥èµ·å¤šå€‹ Runner åŒæ™‚ä¸¦ç™¼æ¥ä»»å‹™ä¾†åšã€‚


> **_ç´°ç¯€å¯åƒè€ƒ [ä¸Šä¸€ç¯‡](../404bd5c70040/) ã€Œ [Self\-hosted Runner å»ºç½®èˆ‡æ”¹ç”¨](../404bd5c70040/) ã€éƒ¨åˆ†_** _ï¼Œåœ¨æœ¬åœ°é›»è…¦å®‰è£å¥½ XCode è·ŸåŸºæœ¬ç’°å¢ƒå¾Œè¨»å†Šã€å•Ÿç”¨ Runnerã€Action Worflow YAML ä¸­æŠŠ `runs-on` æ”¹æˆ `[self-hosted]` å³å¯ã€‚_ 





å¤šå€‹ Runner åœ¨åŒä¸€å°é›»è…¦çš„å•é¡Œï¼Œæˆ‘å€‘å¤šåŠå·²åœ¨ä¸Šé¢çš„ Actions è£¡è§£æ±ºäº†ï¼Œä¾‹å¦‚æŠŠæ‰€æœ‰ä¾è³´çš„å…±ç”¨ç›®éŒ„éƒ½æ”¹æˆæœ¬åœ°ç›®éŒ„ï¼Œé‚„æœ‰ä¸€å€‹æ¸¬è©¦æœƒé‡åˆ°çš„å•é¡Œè¦è§£æ±ºï¼Œå°±æ˜¯æ¶æ¨¡æ“¬å™¨å•é¡Œï¼šã€Œ **ç•¶å…©å€‹æ¸¬è©¦ Job è¢«å…©å€‹ Runner åœ¨åŒä¸€å°æ©Ÿå™¨ä¸ŠåŒæ™‚æª¢ä¾†åšï¼Œå¦‚æœæŒ‡å®šåŒå€‹æ¨¡æ“¬å™¨å°±æœƒäº’ç›¸å¹²æ“¾å°è‡´æ¸¬è©¦å¤±æ•—ã€‚ã€**

è§£æ±ºæ–¹æ³•ä¹Ÿå¾ˆå®¹æ˜“ï¼Œå°±æ˜¯ç‚ºå€‹åˆ¥ Runner éƒ½è¨­å®šä¸€å°æ¨¡æ“¬å™¨ã€‚
#### å¤šå€‹ Runner åœ¨åŒå°æ©Ÿå™¨çš„æ¨¡æ“¬å™¨è¨­å®š

å‡è¨­æˆ‘ **åŒä¸€å°é›»è…¦ä¸Šæœ‰å…©å€‹ Runner** åœ¨ä¸¦è¡Œæ¥æ”¶ä»»å‹™ï¼š
- `ZhgChgLideMacBook-Pro-Runner-A`
- `ZhgChgLideMacBook-Pro-Runner-B`



![](/assets/4b001d2e8440/1*3ptg9Tl5fBbEIYB4kgh0kw.png)


åœ¨ XCode æ¨¡æ“¬å™¨è¨­å®šæˆ‘å€‘å°±éœ€è¦æ–°å¢å…©å€‹æ¨¡æ“¬å™¨ï¼š


![](/assets/4b001d2e8440/1*k9bR2C12Wk11HAKKiYJ2zg.png)



![](/assets/4b001d2e8440/1*iigArewZEW0063Q6xwZn7g.png)

- å‹è™Ÿã€iOS ç‰ˆæœ¬åŒæ¸¬è©¦ç’°å¢ƒ


**CI\-Testing\.yml ä¸­æ¸¬è©¦æ­¥é©Ÿæ”¹æˆï¼š**
```bash
# åŸ·è¡Œ Fastlane Unit æ¸¬è©¦ Lane
      - name: Run Tests
        id: testing
        # æŒ‡å®šå·¥ä½œç›®éŒ„ï¼Œé€™æ¨£å¾ŒçºŒæŒ‡ä»¤å°±ä¸ç”¨åœ¨ç‰¹åˆ¥ cd ./Product/
        working-directory: ./Product/
        env:
          # ...
          # Repo -> Settings -> Actions secrets and variables -> variables
          # æ¨¡æ“¬å™¨çš„ iOS ç‰ˆæœ¬
          SIMULATOR_IOS_VERSION: ${{ vars.SIMULATOR_IOS_VERSION }}

          # ç•¶å‰ Runner åç¨±
          RUNNER_NAME: ${{ runner.name }}
          
          # ...
        run: |

          # ...
          bundle exec fastlane ${TEST_LANE} device:"${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})" | tee "$RUNNER_TEMP/testing_output.txt"
          # ...
```
- `device` **æ”¹æˆ** `${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})`
- `SIMULATOR_IOS_VERSION` é‚„æ˜¯çµ±ä¸€çœ‹ Repo variables è®Šæ•¸


**çµ„åˆçµæœå°±æœƒæ˜¯\(ä»¥ 18\.4 ç‚ºä¾‹\)ï¼š**
- Runner: `ZhgChgLideMacBook-Pro-Runner-A` 
æ¨¡æ“¬å™¨: **ZhgChgLideMacBook\-Pro\-Runner\-A\(18\.4\)**
- Runner: `ZhgChgLideMacBook-Pro-Runner-B` 
æ¨¡æ“¬å™¨: **ZhgChgLideMacBook\-Pro\-Runner\-B\(18\.4\)**


é€™æ¨£å…©å€‹ Runner åŒæ™‚åœ¨åŸ·è¡Œæ¸¬è©¦æ™‚å°±æœƒèµ·å…©å€‹æ¨¡æ“¬å™¨è‡ªå·±è·‘è‡ªå·±çš„äº†ã€‚
#### å®Œæ•´å°ˆæ¡ˆ Repo


[![](https://opengraph.githubassets.com/ea587894478088c4865981c6a8978f7581ddf9f033ea581b8673bc5e9549f3f5/ZhgChgLi/github-actions-ci-cd-demo)](https://github.com/ZhgChgLi/github-actions-ci-cd-demo){:target="_blank"}

### ç¸½çµ

é€™ç¯‡æ–‡ç« è©³ç´°ç´€éŒ„äº†ä½¿ç”¨ GitHub Actions é–‹ç™¼å®Œæ•´çš„ iOS CI/CD æµç¨‹ï¼Œä¸‹ä¸€ç¯‡å°‡å„ªåŒ–ä½¿ç”¨è€…ç«¯\(å·¥ç¨‹å¸«/PM/è¨­è¨ˆå¸«\)é«”é©—ï¼Œ **å®Œå–„ Slack é€šçŸ¥åŠä½¿ç”¨ Google Apps Script Web App ä¸²æ¥ GitHub Actions æ‰“é€ å…è²»æ˜“ç”¨çš„è·¨åœ˜éšŠæ‰“åŒ…å¹³å°å·¥å…·ã€‚**
### ä¸‹ä¸€ç¯‡ï¼š

**\[æ’°å¯«ä¸­ï¼Œæ•¬è«‹æœŸå¾…\] CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆå››ï¼‰ï¼šä½¿ç”¨ Google Apps Script Web App \(AI Vibe Coding\) çµåˆ GitHub Actions æ‰“é€ å…è²»æ˜“ç”¨çš„è·¨åœ˜éšŠæ‰“åŒ…å¹³å°å·¥å…·**


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_[Post](https://dev.zhgchg.li/ci-cd-%E5%AF%A6%E6%88%B0%E6%8C%87%E5%8D%97-%E4%B8%89-%E4%BD%BF%E7%94%A8-github-actions-%E5%AF%A6%E4%BD%9C-app-ios-ci-%E8%88%87-cd-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B-4b001d2e8440){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
