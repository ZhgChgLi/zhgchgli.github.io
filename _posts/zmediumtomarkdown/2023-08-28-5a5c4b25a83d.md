---
title: "POC App End-to-End Testing Local Snapshot API Mock Server"
author: "ZhgChgLi"
date: 2023-08-28T14:53:27.813+0000
last_modified_at: 2023-09-04T14:32:47.020+0000
categories: ["ZRealm Dev."]
tags: ["ios-app-development","end-to-end-testing","ui-testing","automation-testing","ios"]
description: "ç‚ºç¾æˆ App åŠç¾æœ‰ API æ¶æ§‹å¯¦ç¾ E2E Testing çš„å¯èƒ½æ€§é©—è­‰"
image:
  path: /assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg
render_with_liquid: false
---

### \[POC\] App End\-to\-End Testing Local Snapshot API Mock Server

ç‚ºç¾æˆ App åŠç¾æœ‰ API æ¶æ§‹å¯¦ç¾ E2E Testing çš„å¯èƒ½æ€§é©—è­‰



![Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg)

Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
### å‰è¨€

ä½œç‚ºä¸€å€‹å·²åœ¨ç·šä¸Šé‹ä½œå¤šå¹´çš„å°ˆæ¡ˆï¼Œå¦‚ä½•æŒçºŒæå‡ç©©å®šæ€§æ˜¯ä¸€ä»¶æ¥µå…·æŒ‘æˆ°çš„å•é¡Œã€‚
#### Unit Testing


![](/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.png)


App å› é–‹ç™¼èªè¨€ Swift/Kotlin éœæ…‹\+ç·¨è­¯\+å¼·å‹åˆ¥ æˆ– Objective\-C to Swift å‹•æ…‹è½‰éœæ…‹ï¼Œåœ¨é–‹ç™¼æ™‚æ²’è€ƒæ…®åˆ°å¯æ¸¬è©¦æ€§æŠŠä»‹é¢ä¾è³´åˆ‡ä¹¾æ·¨ï¼Œå¾Œé¢è¦è£œ Unit Testing å¹¾ä¹ä¸å¯èƒ½ï¼›ä½†åœ¨é‡æ§‹çš„éç¨‹ä¹Ÿæœƒå¸¶ä¾†ä¸ç©©å®šå› ç´ ï¼Œæœƒé™·å…¥ä¸€å€‹é›ç”Ÿè›‹è›‹ç”Ÿé›å•é¡Œã€‚
#### UI Testing

å° UI äº¤äº’ã€æŒ‰éˆ•æ¸¬è©¦ï¼›æ–°é–‹ç™¼æˆ–èˆŠæœ‰çš„ç•«é¢ç¨å¾®è§£è€¦è³‡æ–™ä¾è³´å°±å¯ä»¥å¯¦ç¾ã€‚
#### SnapShot Testing

é©—è­‰èª¿æ•´å‰å¾Œçš„ UI é¡¯ç¤ºå…§å®¹ã€æ¨£å¼æ˜¯å¦ä¸€è‡´ï¼›åŒ UI Testingï¼Œæ–°é–‹ç™¼æˆ–èˆŠæœ‰çš„ç•«é¢ç¨å¾®è§£è€¦è³‡æ–™ä¾è³´å°±å¯ä»¥å¯¦ç¾ã€‚

ç”¨åœ¨ Storyboard/XIB è½‰ Code Layout or UIView from OC to Swift å¾ˆå¯¦ç”¨ï¼›å¯ä»¥ç›´æ¥å°å…¥ [pointfreeco](https://github.com/pointfreeco){:target="_blank"} / [swift\-snapshot\-testing](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"} å¿«é€Ÿå¯¦ç¾ã€‚


[![](https://opengraph.githubassets.com/d1ae6f023e83875d588130f86613b0fbd2811dd5a6950ae07d0b73c51939b017/pointfreeco/swift-snapshot-testing)](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"}


é›–ç„¶æˆ‘å€‘å¯ä»¥å¾ŒæœŸè£œä¸Š UI Testingã€SnapShot Testingï¼Œä½†èƒ½æ¶µè“‹çš„æ¸¬è©¦ç¯„åœå¾ˆæœ‰é™ï¼›å› ç‚ºå¤šåŠçš„éŒ¯èª¤ä¸æœƒæ˜¯ UI æ¨£å¼ï¼Œè€Œæ˜¯æµç¨‹æˆ–æ˜¯é‚è¼¯å•é¡Œï¼Œå°è‡´ä½¿ç”¨è€…ä¸­æ–·æ“ä½œï¼Œ **å¦‚æœå‡ºç¾åœ¨çµå¸³æµç¨‹ï¼Œç‰½æ¶‰åˆ°ç‡Ÿæ”¶ï¼Œå•é¡Œå±¤ç´šå°±å¾ˆåš´é‡** ã€‚
### End\-to\-End Testing

å¦‚å‰è¿°ï¼Œç„¡æ³•åœ¨ç¾è¡Œå°ˆæ¡ˆç°¡æ˜“çš„è£œä¸Šå–®å…ƒæ¸¬è©¦ä¹Ÿç„¡æ³•èšæ”å–®å…ƒåšæ•´åˆæ¸¬è©¦ï¼Œå°æ–¼é‚è¼¯ã€æµç¨‹çš„é˜²è­·ï¼Œé‚„å‰©ä¸‹å¾å¤–éƒ¨åš End\-to\-End é»‘ç®±æ¸¬è©¦çš„æ–¹æ³•ï¼Œç›´æ¥ä»¥ä½¿ç”¨è€…è§’åº¦å‡ºç™¼ï¼Œæ“ä½œæµç¨‹æª¢æŸ¥é‡è¦çš„æµç¨‹\(è¨»å†Š/çµå¸³â€¦\)æ˜¯å¦æ­£å¸¸ã€‚


> å°é‡å¤§åŠŸèƒ½çš„é‡æ§‹ä¹Ÿèƒ½å…ˆå»ºç«‹é‡æ§‹å‰çš„æµç¨‹æ¸¬è©¦ï¼Œé‡æ§‹å¾Œé‡æ–°é©—è­‰ï¼Œç¢ºä¿é‡æ§‹å¾ŒåŠŸèƒ½å¦‚é æœŸã€‚ 





> é‡æ§‹ä¸­ä¸€ä½µè£œä¸Š Unit Testingã€Integration Testing å¢åŠ ç©©å®šæ€§ï¼Œæ‰“ç ´é›ç”Ÿè›‹è›‹ç”Ÿé›çš„å•é¡Œã€‚ 



#### QA Team

End\-to\-End Testing æœ€ç›´æ¥æš´åŠ›çš„æ–¹å¼å°±æ˜¯è«‹ä¸€çµ„ QA Team ä¾ç…§ Test Plan é€²è¡Œæ‰‹å‹•æ¸¬è©¦ï¼Œç„¶å¾Œå†æŒçºŒå„ªåŒ–æˆ–å¼•å…¥è‡ªå‹•åŒ–æ“ä½œï¼›è¨ˆç®—äº†ä¸€ä¸‹æˆæœ¬è‡³å°‘éœ€è¦ 2 ä½å·¥ç¨‹å¸« \+ 1 ä½ Leader èŠ±è²»è‡³å°‘åŠå¹´ä¸€å¹´æ™‚é–“æ‰èƒ½çœ‹åˆ°æˆæœã€‚

è©•ä¼°æ™‚é–“èˆ‡æˆæœ¬ï¼Œæœ‰æ²’æœ‰ä»€éº¼æ˜¯ç¾æ³æˆ‘å€‘èƒ½åšçš„æˆ–æ˜¯èƒ½ç‚ºæœªä¾† QA Team åšå¥½æº–å‚™ï¼Œç•¶æœ‰ QA Team æ™‚èƒ½ç›´æ¥è·³åˆ°å„ªåŒ–èˆ‡è‡ªå‹•åŒ–æ“ä½œç”šè‡³å°å…¥ AI\(?\)ã€‚
#### Automation

ç¾éšæ®µä»¥å°å…¥è‡ªå‹•åŒ– End\-to\-End Testing ç‚ºç›®æ¨™ï¼Œæ”¾åœ¨ CI/CD ç’°ç¯€è‡ªå‹•æª¢æŸ¥ï¼Œæ¸¬è©¦å…§å®¹å¯ä»¥ä¸ç”¨å¤ªå®Œæ•´ã€åªè¦èƒ½é˜²æ­¢é‡å¤§æµç¨‹å•é¡Œå°±å·²ç¶“å¾ˆæœ‰åƒ¹å€¼äº†ï¼›å¾Œé¢å†æ…¢æ…¢è¿­ä»£ Test Plan é€æ­¥è£œé½Šå®ˆå‚™ç¯„åœã€‚
### End\-to\-End Testing â€”æŠ€è¡“é›£é»
#### UI æ“ä½œå•é¡Œ

App çš„åŸç†æ¯”è¼ƒåƒæ˜¯é€éå¦ä¸€å€‹æ¸¬è©¦ App å»æ“ä½œæˆ‘å€‘çš„è¢«æ¸¬è©¦ Appï¼Œç„¶å¾Œå¾ View Hierarchy å»æ‰¾å°‹ç›®æ¨™ç‰©ä»¶ï¼›ä¸¦ä¸”åœ¨æ¸¬è©¦æ™‚ç„¡æ³•å–å¾—è¢«æ¸¬è©¦ App çš„ Log æˆ– Outputï¼Œå› ç‚ºæœ¬è³ªä¸Šå°±æ˜¯å…©å€‹ä¸åŒ Appã€‚

iOS éœ€è¦å®Œå–„ View Accessibility Identifier å¢åŠ æ•ˆç‡èˆ‡æº–ç¢ºæ€§é‚„æœ‰è¦è™•ç† Alert \(e\.g\. æ¨æ’­è«‹æ±‚\)ã€‚

Android åœ¨ä¹‹å‰çš„å¯¦ä½œä¸Šæœ‰é‡åˆ°æ··ç”¨ Compose èˆ‡ Fragment æ™‚æœƒæ‰¾ä¸åˆ°ç›®æ¨™ç‰©ä»¶çš„å•é¡Œï¼Œä½†æ“š Teammate è¡¨ç¤ºï¼Œæ–°ç‰ˆçš„ Compose å·²ç¶“è§£æ±ºã€‚

é™¤ä»¥ä¸Šå‚³çµ±å¸¸è¦‹å•é¡Œå¤–ï¼Œæ›´å¤§çš„å•é¡Œæ˜¯é›™å¹³å°é›£ä»¥æ•´åˆ\(å¯«ä¸€å€‹æ¸¬è©¦è·‘å…©å€‹å¹³å°\)ï¼›ç›®å‰æˆ‘å€‘åœ¨å˜—è©¦ä½¿ç”¨æ–°çš„æ¸¬è©¦å·¥å…· [mobile\-dev\-inc](https://github.com/mobile-dev-inc){:target="_blank"} / [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} ï¼š


[![](https://opengraph.githubassets.com/eeeb195c0374eca9087be1ec0b41ae24ab776e453adcf718cffa4bc3322e8927/mobile-dev-inc/Maestro)](https://github.com/mobile-dev-inc/maestro){:target="_blank"}


å¯ä»¥ç”¨ YAML å¯« Test Plan ç„¶å¾Œåœ¨é›™å¹³å°åŸ·è¡Œæ¸¬è©¦ï¼Œç´°ç¯€ä½¿ç”¨æ–¹å¼ã€è©¦ç”¨å¿ƒå¾—ï¼Œéœå¾…å¦ä¸€ä½ Teammate çš„æ–‡ç« åˆ†äº« ccâ€™ed [Alejandra Ts\.](https://medium.com/u/1139df7a27f3){:target="_blank"} ğŸ˜ã€‚
#### API è³‡æ–™å•é¡Œ

å°æ–¼ App E2E Testing æœ€å¤§çš„æ¸¬è©¦è®Šé‡å°±æ˜¯ API è³‡æ–™ï¼Œå¦‚æœç„¡æ³•æä¾›ä¿è­‰ç¢ºå®šçš„è³‡æ–™ï¼Œæœƒå¢åŠ æ¸¬è©¦çš„ä¸ç©©å®šæ€§ï¼Œå°è‡´èª¤å ±ï¼Œæœ€å¾Œå¤§å®¶å° Test Plan ä¹Ÿä¸å†æœ‰ä¿¡å¿ƒäº†ã€‚

ä¾‹å¦‚æ¸¬è©¦çµå¸³æµç¨‹ï¼Œå¦‚æœå•†å“æœ‰å¯èƒ½è¢«ä¸‹æ¶æˆ–æ¶ˆå¤±ï¼Œä¸”é€™äº›ç‹€æ…‹æ”¹è®Šä¸æ˜¯ App å¯æ§çš„å°±å¾ˆæœ‰å¯èƒ½å‡ºç¾ä»¥ä¸Šç‹€æ³ã€‚

è§£æ±ºè³‡æ–™å•é¡Œçš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œå¯ä»¥å»ºç«‹ä¹¾æ·¨çš„ Staging æˆ– Testing ç’°å¢ƒï¼›æˆ–æ˜¯åŸºæ–¼ Open API çš„ Auto\-Gen Mock API Serverï¼›ä½†éƒ½éœ€è¦ä¾è³´å¾Œç«¯ã€ä¾è³´ API çš„å¤–éƒ¨å› ç´ ï¼ŒåŠ ä¸Šå¾Œç«¯ API åŒ App ä¸€æ¨£æ˜¯åœ¨ç·šä¸Šé‹ä½œå¤šå¹´çš„å°ˆæ¡ˆï¼Œéƒ¨ä»½è¦æ ¼ä¹Ÿé‚„åœ¨é‡æ§‹ Migrate æš«æ™‚ç„¡æ³•æœ‰ Mock Serverã€‚

åŸºæ–¼ä»¥ä¸Šå› ç´ ï¼Œå¦‚æœå°±å¡åœ¨é€™ï¼Œé‚£å•é¡Œä¸€æ¨£ä¸æœƒæ”¹è®Šã€é›ç”Ÿè›‹è›‹ç”Ÿé›å•é¡Œä¹Ÿç„¡æ³•çªç ´ï¼ŒçœŸçš„å°±åªèƒ½ã€ŒæŒºè€Œèµ°éšªã€çš„ç›´æ¥å…ˆæ”¹ã€å‡ºå•é¡Œå†èªªäº†ã€‚
#### Snapshot API Local Mock Server


> ã€Œåªè¦æ€æƒ³ä¸æ»‘å¡ï¼Œæ–¹æ³•ç¸½æ¯”å›°é›£å¤šã€ 




æˆ‘å€‘å¯ä»¥æ›ä¸€å€‹æƒ³æ³•ï¼Œå¦‚æœ UI å¯ä»¥ç”¨ Snapshot å¿«ç…§æˆåœ–ç‰‡ä¸‹ä¾† Replay é€²è¡Œé©—è­‰æ¸¬è©¦ï¼Œé‚£ API æ˜¯å¦ä¹Ÿå¯ä»¥ï¼Ÿ æˆ‘å€‘æ˜¯å¦å¯ä»¥æŠŠ API Request & Response å­˜ä¸‹ä¾†ï¼Œåœ¨å¾ŒçºŒ Replay é€²è¡Œé©—è­‰æ¸¬è©¦ï¼Ÿ

**è—‰æ­¤å¼•å…¥æœ¬ç¯‡æ–‡ç« çš„é‡é»ï¼šå»ºç«‹ã€ŒSnapshot API Local Mock Serverã€Record API Request & Replay Response å‰é›¢èˆ‡ API è³‡æ–™çš„ä¾è³´ã€‚**


> æœ¬æ–‡åªåšäº† POC æ¦‚å¿µé©—è­‰ï¼Œé‚„æ²’æœ‰çœŸæ­£å…¨é¢å¯¦ç¾é«˜è¦†è“‹ç‡çš„ End To End Testingï¼Œå› æ­¤åšæ³•åƒ…ä¾›åƒè€ƒï¼Œ **å¸Œæœ›å°å¤§å®¶åœ¨ç¾æœ‰ç’°å¢ƒä¸‹æœ‰æ–°çš„å•Ÿç™¼** ã€‚ 




### Snapshot API Local Mock Server
#### æ ¸å¿ƒæ¦‚å¿µ â€” Record & Replay API Data

**\[Record\]** â€” End\-to\-End Testing Test Case é–‹ç™¼å®Œæˆå¾Œï¼Œæ‰“é–‹éŒ„è£½åƒæ•¸ï¼ŒåŸ·è¡Œä¸€æ¬¡æ¸¬è©¦ï¼Œéç¨‹ä¸­æ‰€æœ‰ API Request & Response æœƒå­˜ä¸‹ä¾†æ”¾åœ¨å„å€‹ Test Case ç›®éŒ„å…§ã€‚

**\[Replay\]** â€” å¾Œé¢åœ¨è·‘ Test Case æ™‚ï¼Œä¾ç…§è«‹æ±‚å¾ Test Case ç›®éŒ„ä¸­æ‰¾åˆ°å°æ‡‰éŒ„è£½ä¸‹ä¾†çš„ Response Dataï¼Œå®Œæˆæ¸¬è©¦æµç¨‹ã€‚
#### ç¤ºæ„åœ–

å‡è¨­æˆ‘å€‘è¦æ¸¬è©¦åŠ å…¥è³¼è²·æµç¨‹ï¼Œä½¿ç”¨è€…æ‰“é–‹ App å¾Œåœ¨é¦–é é»æ“Šå•†å“å¡é€²å…¥å•†å“è©³ç´°é ï¼ŒæŒ‰åº•éƒ¨è³¼è²·ï¼Œè·³å‡ºç™»å…¥åŒ¡å®Œæˆç™»å…¥ï¼Œå®Œæˆè³¼è²·ï¼Œè·³å‡ºè³¼è²·æˆåŠŸæç¤ºï¼š


![](/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.png)


UI Testing å¦‚ä½•æ§åˆ¶æŒ‰éˆ•é»æ“Šã€è¼¸å…¥åŒ¡è¼¸å…¥â€¦ç­‰ç­‰ï¼Œä¸æ˜¯æœ¬æ–‡ä¸»è¦ç ”ç©¶é‡é»ï¼›å¯åƒè€ƒç¾æœ‰çš„æ¸¬è©¦æ¡†æ¶ç›´æ¥ä½¿ç”¨ã€‚
#### Regular Proxy or Reverse Proxy

è¦é”æˆ Record & Replay API éœ€è¦åœ¨ App èˆ‡ API ä¹‹é–“åŠ ä¸Š Proxy åšä¸­é–“äººæ”»æ“Šï¼Œå¯åƒè€ƒæˆ‘æ—©æœŸçš„æ–‡ç« ã€Œ [APPæœ‰ç”¨HTTPSå‚³è¼¸ï¼Œä½†è³‡æ–™é‚„æ˜¯è¢«å·äº†ã€‚](../46410aaada00/) ã€

ç°¡å–®ä¾†èªªå°±æ˜¯åœ¨ App èˆ‡ API ä¹‹é–“å¤šäº†ä¸€å€‹ä»£ç†çš„å‚³éè€…ï¼Œå¦‚åŒå‚³ç´™æ¢ä¸€æ¨£ï¼Œé›™æ–¹å‚³éçš„è«‹æ±‚èˆ‡å›æ‡‰éƒ½æœƒç¶“éä»–ï¼Œä»–å¯ä»¥æ‰“é–‹ä¾†ç´™æ¢çš„å…§å®¹ï¼Œä¹Ÿå¯ä»¥å½é€ ç´™æ¢å…§å®¹çµ¦å½¼æ­¤ï¼Œé›™æ–¹ä¸æœƒå¯Ÿè¦ºä½ å¾ä¸­åšæ¢—ã€‚

**æ­£å‘ä»£ç† Regular Proxyï¼š**

æ­£å‘ä»£ç†æ˜¯å®¢æˆ¶ç«¯å‘ä»£ç†ä¼ºæœå™¨ç™¼é€è«‹æ±‚ï¼Œä»£ç†ä¼ºæœå™¨å†å°‡è«‹æ±‚è½‰ç™¼çµ¦ç›®æ¨™ä¼ºæœå™¨ï¼Œä¸¦å°‡ç›®æ¨™ä¼ºæœå™¨çš„å›æ‡‰è¿”å›çµ¦å®¢æˆ¶ç«¯ã€‚åœ¨æ­£å‘ä»£ç†æ¨¡å¼ä¸‹ï¼Œä»£ç†ä¼ºæœå™¨ä»£è¡¨å®¢æˆ¶ç«¯ç™¼èµ·è«‹æ±‚ã€‚å®¢æˆ¶ç«¯éœ€è¦æ˜ç¢ºæŒ‡å®šä»£ç†ä¼ºæœå™¨çš„ä½å€å’ŒåŸ è™Ÿï¼Œä¸¦å°‡è«‹æ±‚ç™¼é€çµ¦ä»£ç†ä¼ºæœå™¨ã€‚

**åå‘ä»£ç† Reverse Proxyï¼š**

åå‘ä»£ç†èˆ‡æ­£å‘ä»£ç†ç›¸åï¼Œå®ƒä½æ–¼ç›®æ¨™ä¼ºæœå™¨å’Œå®¢æˆ¶ç«¯ä¹‹é–“ã€‚å®¢æˆ¶ç«¯å‘åå‘ä»£ç†ä¼ºæœå™¨ç™¼é€è«‹æ±‚ï¼Œåå‘ä»£ç†ä¼ºæœå™¨æ ¹æ“šä¸€å®šçš„è¦å‰‡å°‡è«‹æ±‚è½‰ç™¼çµ¦å¾Œç«¯çš„ç›®æ¨™ä¼ºæœå™¨ï¼Œä¸¦å°‡ç›®æ¨™ä¼ºæœå™¨çš„å›æ‡‰è¿”å›çµ¦å®¢æˆ¶ç«¯ã€‚å°æ–¼å®¢æˆ¶ç«¯ä¾†èªªï¼Œç›®æ¨™ä¼ºæœå™¨çœ‹èµ·ä¾†å°±åƒæ˜¯åå‘ä»£ç†ä¼ºæœå™¨ï¼Œå®¢æˆ¶ç«¯ä¸éœ€è¦çŸ¥é“ç›®æ¨™ä¼ºæœå™¨çš„çœŸå¯¦ä½å€ã€‚

å°æˆ‘å€‘çš„éœ€æ±‚ä¾†èªªæ­£å‘æˆ–åå‘éƒ½å¯ä»¥é”æˆç›®çš„ï¼Œå”¯ä¸€è¦è€ƒæ…®çš„äº‹æ˜¯ä»£ç†è¨­ç½®çš„æ–¹å¼ï¼š

**æ­£å‘ä»£ç†éœ€è¦åœ¨é›»è…¦ä¸Šæˆ–æ‰‹æ©Ÿã€æ¨¡æ“¬èµ·çš„ç¶²è·¯è¨­ç½®ä¸­æ›ä¸Š Proxy ä»£ç†ï¼š**
- Android èƒ½åœ¨æ¨¡æ“¬å™¨ä¸­å€‹åˆ¥ç›´æ¥è¨­ç½® Proxy ä»£ç†
- iOS Simulator åŒé›»è…¦çš„ç¶²è·¯ç’°å¢ƒï¼Œç„¡æ³•å€‹è¨­ç½® Proxyï¼Œè®Šæˆè¦å»æ”¹é›»è…¦çš„è¨­ç½®æ‰èƒ½æ›ä¸Š Proxyï¼Œé›»è…¦çš„æ‰€æœ‰æµé‡ä¹Ÿéƒ½æœƒç¶“éé€™å€‹ Proxy ä¸¦ä¸”å¦‚æœåŒæ™‚é–‹å•Ÿ Proxyman æˆ– Charles ç­‰ç­‰å…¶ä»–ç¶²è·¯å·¥å…·ï¼Œæœ‰æ©Ÿæœƒæœƒå¼·åˆ¶æ›´æ”¹ Proxy è¨­ç½®æˆè©²è»Ÿé«”çš„ï¼Œå°è‡´å¤±æ•ˆã€‚


**åå‘ä»£ç†éœ€è¦æ”¹ Codebase ä¸­çš„ API Host ä¸¦ä¸”è¦å®£å‘Šè¦ä»£ç†çš„æ‰€æœ‰ API Domainsï¼š**
- Codebase ä¸­çš„ API Host è¦åœ¨æ¸¬è©¦æ™‚æ›¿æ›æˆ Proxy Server IP
- åœ¨å•Ÿç”¨ Reverse Proxy æ™‚è¦å®£å‘Šå“ªäº› Domain è¦æ›ä¸Š Proxy
- åªæœ‰å®£å‘Šçš„ Domain æ‰æœƒèµ° Proxyï¼Œæ²’å®£å‘Šçš„æœƒç›´é€šå‡ºå»



> é…åˆ iOS Appï¼Œä»¥ä¸‹ä»¥ iOS & ä½¿ç”¨ Reverse Proxy åå‘ä»£ç†ç‚ºä¾‹åš POCï¼ŒAndroid ä¸€æ¨£å¯ä»¥ä½¿ç”¨ã€‚ 




#### è®“ iOS App çŸ¥é“ç¾åœ¨æ­£åœ¨è·‘ End\-to\-End Testing

æˆ‘å€‘éœ€è¦è®“ App çŸ¥é“ç¾åœ¨æ­£åœ¨è·‘ End\-to\-End Testing æ‰èƒ½åœ¨ App ç¨‹å¼è£¡åŠ ä¸Š API Host æ›¿æ›é‚è¼¯ï¼š
```
// UI Testing Target:
let app = XCUIApplication()
app.launchArguments = ["duringE2ETesting"]
app.launch()
```

æˆ‘å€‘åœ¨ Network å±¤åšåˆ¤æ–·æŠ½æ›ã€‚


> é€™æ˜¯ä¸å¾—å·²çš„èª¿æ•´ï¼Œç›¡é‡é‚„æ˜¯ä¸è¦ç‚ºäº†æ¸¬è©¦è€Œå»æ”¹ App çš„ Codeã€‚ 




### ä½¿ç”¨ MITMProxy å¯¦ç¾ Reverse Proxy Server


> äº¦å¯ä½¿ç”¨ Swift è‡ªè¡Œé–‹ç™¼ Swift Server é”æˆï¼Œæœ¬æ–‡åªæ˜¯ POC å› æ­¤ç›´æ¥ä½¿ç”¨ MITMProxy å·¥å…·ã€‚ 




#### \[2023â€“09â€“04 Update\] Mitmproxy\-rodo å·²é–‹æº

ä»¥ä¸‹å¯¦ä½œå…§å®¹å·²ç¶“é–‹æºåˆ° [mitmproxy\-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} å°ˆæ¡ˆï¼Œæ­¡è¿ç›´æ¥å‰å¾€å°ç…§ä½¿ç”¨ã€‚


[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}


éƒ¨ä»½çµæ§‹èˆ‡æœ¬æ–‡ç« å…§å®¹æœ‰æ‰€èª¿æ•´ï¼Œé–‹æºæ™‚å¾ŒçºŒèª¿æ•´äº†ï¼š
- å„²å­˜ç›®éŒ„çš„çµæ§‹ï¼Œæ”¹ç‚º `host / requestPath / method / hash`
- ä¿®æ­£ Header è³‡è¨Šå„²å­˜ï¼Œæ‡‰è©²ç‚º Bytes Data è€Œéç´” JSON String
- ä¿®æ­£éƒ¨ä»½éŒ¯èª¤
- å¢åŠ è‡ªå‹•å»¶é•· Set\-Cookie æ™‚æ•ˆåŠŸèƒ½



> **âš ï¸ ä»¥ä¸‹è…³æœ¬åƒ…å…± Demo åƒè€ƒï¼Œå¾ŒçºŒè…³æœ¬èª¿æ•´å°‡ç§»è‡³é–‹æºå°ˆæ¡ˆç¶­è­·ã€‚** 
 

> **âš ï¸ ä»¥ä¸‹è…³æœ¬åƒ…å…± Demo åƒè€ƒï¼Œå¾ŒçºŒè…³æœ¬èª¿æ•´å°‡ç§»è‡³é–‹æºå°ˆæ¡ˆç¶­è­·ã€‚** 
 

> **âš ï¸ ä»¥ä¸‹è…³æœ¬åƒ…å…± Demo åƒè€ƒï¼Œå¾ŒçºŒè…³æœ¬èª¿æ•´å°‡ç§»è‡³é–‹æºå°ˆæ¡ˆç¶­è­·ã€‚** 
 

> **âš ï¸ ä»¥ä¸‹è…³æœ¬åƒ…å…± Demo åƒè€ƒï¼Œå¾ŒçºŒè…³æœ¬èª¿æ•´å°‡ç§»è‡³é–‹æºå°ˆæ¡ˆç¶­è­·ã€‚** 
 

> **âš ï¸ ä»¥ä¸‹è…³æœ¬åƒ…å…± Demo åƒè€ƒï¼Œå¾ŒçºŒè…³æœ¬èª¿æ•´å°‡ç§»è‡³é–‹æºå°ˆæ¡ˆç¶­è­·ã€‚** 




#### [MITMProxy](https://mitmproxy.org){:target="_blank"}

ç…§è‘— [MITMProxy å®˜ç¶²](https://mitmproxy.org){:target="_blank"} å®Œæˆå®‰è£ï¼š
```bash
brew install mitmproxy
```

MITMProxy ç´°ç¯€ç”¨æ³•å¯åƒè€ƒæˆ‘æ—©æœŸçš„æ–‡ç« ã€Œ [APPæœ‰ç”¨HTTPSå‚³è¼¸ï¼Œä½†è³‡æ–™é‚„æ˜¯è¢«å·äº†ã€‚](../46410aaada00/) ã€
- `mitmproxy` æä¾›ä¸€å€‹äº’å‹•å¼çš„å‘½ä»¤è¡Œç•Œé¢ã€‚
- `mitmweb` æä¾›åŸºæ–¼ç€è¦½å™¨çš„åœ–å½¢ç”¨æˆ¶ç•Œé¢ã€‚
- `mitmdump` æä¾›éäº’å‹•çš„çµ‚ç«¯è¼¸å‡ºã€‚

#### å¯¦ç¾ Record & Replay

å›  MITMProxy Reverse Proxy åŸç”Ÿæ²’æœ‰ Record \(or dump\) request & Mapping Request Replay çš„åŠŸèƒ½ï¼Œå› æ­¤æˆ‘å€‘éœ€è¦è‡ªè¡Œæ’°å¯«è…³æœ¬å¯¦ç¾æ­¤åŠŸèƒ½ã€‚

`mock.py` :
```python
"""
Example:
    Record: mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
    Replay: mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
"""

import re
import logging
import mimetypes
import os
import json
import hashlib

from pathlib import Path
from mitmproxy import ctx
from mitmproxy import http

class MockServerHandler:

    def load(self, loader):
        self.readHistory = {}
        self.configuration = {}

        loader.add_option(
            name="dumper_folder",
            typespec=str,
            default="dump",
            help="Response Dump ç›®éŒ„ï¼Œå¯ä»¥ by Test Case Name å»ºç«‹",
        )

        loader.add_option(
            name="network_restricted",
            typespec=bool,
            default=True,
            help="æœ¬åœ°æ²’æœ‰ Mapping è³‡æ–™...è¨­ç½® true æœƒ return 404ã€false æœƒå»æ‰“çœŸå¯¦è«‹æ±‚æ‹¿è³‡æ–™ã€‚",
        )

        loader.add_option(
            name="record",
            typespec=bool,
            default=False,
            help="è¨­ç½® true éŒ„è£½ Request's Response",
        )

        loader.add_option(
            name="config_file",
            typespec=str,
            default="",
            help="è¨­ç½®æª”æ¡ˆè·¯å¾‘ï¼Œç¯„ä¾‹æª”æ¡ˆåœ¨ä¸‹é¢",
        )
    
    def configure(self, updated):
        self.loadConfig()

    def loadConfig(self):
        configFile = Path(ctx.options.config_file)
        if ctx.options.config_file == "" or not configFile.exists():
            return

        self.configuration = json.loads(open(configFile, "r").read())

    def hash(self, request):
        query = request.query
        requestPath = "-".join(request.path_components)

        ignoredQueryParameterByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("queryParamters", [])
        ignoredQueryParameterGlobal = self.configuration.get("ignored", {}).get("global", {}).get("queryParamters", [])

        filteredQuery = []
        if query:
            filteredQuery = [(key, value) for key, value in query.items() if key not in ignoredQueryParameterByPaths + ignoredQueryParameterGlobal]
        
        formData = []
        if request.get_content() != None and request.get_content() != b'':
            formData = json.loads(request.get_content())
        
        # or just formData = request.urlencoded_form
        # or just formData = request.multipart_form
        # depends on your api design

        ignoredFormDataParametersByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("formDataParameters", [])
        ignoredFormDataParametersGlobal = self.configuration.get("ignored", {}).get("global", {}).get("formDataParameters", [])

        filteredFormData = []
        if formData:
            filteredFormData = [(key, value) for key, value in formData.items() if key not in ignoredFormDataParametersByPaths + ignoredFormDataParametersGlobal]
        
        # Serialize the dictionary to a JSON string
        hashData = {"query":sorted(filteredQuery), "form": sorted(filteredFormData)}
        json_str = json.dumps(hashData, sort_keys=True)

        # Apply SHA-256 hash function
        hash_object = hashlib.sha256(json_str.encode())
        hash_string = hash_object.hexdigest()
        
        return hash_string

    def readFromFile(self, request):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        if not folder.exists():
            return None

        content_type = request.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"


        count = self.readHistory.get(host, {}).get(method, {}).get(requestPath, {}) or 0

        filepath = folder / f"Content-{str(count)}{ext}"

        while not filepath.exists() and count > 0:
            count = count - 1
            filepath = folder / f"Content-{str(count)}{ext}"

        if self.readHistory.get(host) is None:
            self.readHistory[host] = {}
        if self.readHistory.get(host).get(method) is None:
            self.readHistory[host][method] = {}
        if self.readHistory.get(host).get(method).get(requestPath) is None:
            self.readHistory[host][method][requestPath] = {}

        if filepath.exists():
            headerFilePath = folder / f"Header-{str(count)}.json"
            if not headerFilePath.exists():
                headerFilePath = None
            
            count += 1
            self.readHistory[host][method][requestPath] = count

            return {"content": filepath, "header": headerFilePath}
        else:
            return None


    def saveToFile(self, request, response):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        iterable = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("iterable", False)
        
        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        # create dir if not exists
        if not folder.exists():
            os.makedirs(folder)

        content_type = response.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"

        repeatNumber = 0
        filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        while filepath.exists() and iterable == False:
            repeatNumber += 1
            filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        
        # dump to file
        with open(filepath, "wb") as f:
            f.write(response.content or b'')
            
        
        headerFilepath = folder / f"Header-{str(repeatNumber)}.json"
        with open(headerFilepath, "wb") as f:
            responseDict = dict(response.headers.items())
            responseDict['_status_code'] = response.status_code
            f.write(json.dumps(responseDict).encode('utf-8'))

        return {"content": filepath, "header": headerFilepath}

    def request(self, flow):
        if ctx.options.record != True:
            host = flow.request.host
            path = flow.request.path

            result = self.readFromFile(flow.request)
            if result is not None:
                content = b''
                headers = {}
                statusCode = 200

                if result.get('content') is not None:
                    content = open(result['content'], "r").read()

                if result.get('header') is not None:
                    headers = json.loads(open(result['header'], "r").read())
                    statusCode = headers['_status_code']
                    del headers['_status_code']

                
                headers['_responseFromMitmproxy'] = '1'
                flow.response = http.Response.make(statusCode, content, headers)
                logging.info("Fullfill response from local with "+str(result['content']))
                return

            if ctx.options.network_restricted == True:
                flow.response = http.Response.make(404, b'', {'_responseFromMitmproxy': '1'})
        
    def response(self, flow):
        if ctx.options.record == True and flow.response.headers.get('_responseFromMitmproxy') != '1':
            result = self.saveToFile(flow.request, flow.response)
            logging.info("Save response to local with "+str(result['content']))

addons = [MockServerHandler()]
```

å¯ä»¥è‡ªè¡Œåƒè€ƒ [å®˜æ–¹æ–‡ä»¶](https://docs.mitmproxy.org/stable/api/events.html){:target="_blank"} ï¼Œä¾ç…§éœ€æ±‚èª¿æ•´è…³æœ¬å…§å®¹ã€‚

**æ­¤è…³æœ¬è¨­è¨ˆé‚è¼¯å¦‚ä¸‹ï¼š**
- æª”æ¡ˆè·¯å¾‘é‚è¼¯ï¼š `dumper_folder(a.k.a Test Case Name)` / `Reverse's api host` / `HTTP Method` / `Path join with -` \(e\.g\. `app/launch` \-&gt; `app-launch` \) / `Hash(Get Query & Post Content)` /
- æª”æ¡ˆé‚è¼¯ï¼šå›æ‡‰çš„å…§å®¹ï¼š `Content-0.xxx` ã€ `Content-1.xxx` \(åŒå€‹è«‹æ±‚æ‰“ç¬¬äºŒæ¬¡\)â€¦ä»¥æ­¤é¡æ¨ï¼›å›æ‡‰çš„ Header è³‡è¨Šï¼š `Header-0.json` \(åŒ `Content-x` é‚è¼¯\)



![](/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.png)

- å„²å­˜æ™‚æœƒä¾ç…§è·¯å¾‘ã€æª”æ¡ˆé‚è¼¯ä¾åºå„²å­˜ï¼›åœ¨ Replay æ™‚åŒæ¨£ä¾åºå–å‡º
- å¦‚æœæ¬¡æ•¸ä¸åŒ¹é…ï¼Œä¾‹å¦‚ Replay æ™‚åŒå€‹è·¯å¾‘æ‰“äº† 3 æ¬¡ï¼Œä½† Record å„²å­˜çš„è³‡æ–™åªå­˜åˆ°ç¬¬ 2 æ¬¡ï¼›å‰‡é‚„æ˜¯æœƒæŒçºŒå›æ‡‰ç¬¬ 2 æ¬¡ï¼Œä¹Ÿå°±æ˜¯æœ€å¾Œä¸€æ¬¡çš„çµæœ
- `record` ç‚º `True` æ™‚ï¼Œæœƒå»æ‰“ç›®æ¨™ Server å–å¾—å›æ‡‰ä¸¦ä¾ç…§ä¸Šè¿°é‚è¼¯å„²å­˜ä¸‹ä¾†ï¼› `False` æ™‚å‰‡åªæœƒå¾æœ¬åœ°è®€è³‡æ–™ \(ç­‰æ–¼ Replay Mode\)
- `network_restricted` ç‚º `False` æ™‚ï¼Œæœ¬åœ°æ²’ Mapping è³‡æ–™æœƒç›´æ¥å›æ‡‰ `404` ï¼›ç‚º `True` æ™‚æœƒå»æ‰“ç›®æ¨™ Server æ‹¿è³‡æ–™ã€‚
- `_responseFromMitmproxy` ç”¨æ–¼å‘ŠçŸ¥ Response Method ç•¶å‰å›æ‡‰ä¾†è‡ª Localï¼Œå¯ä»¥å¿½ç•¥ä¸ç®¡ã€ `_status_code` å€Ÿç”¨ Header\.json æ¬„ä½å„²å­˜ HTTP Response ç‹€æ…‹ç¢¼ã€‚


`config_file.json` **è¨­ç½®æª”æ¡ˆé‚è¼¯è¨­è¨ˆå¦‚ä¸‹ï¼š**
```json
{
  "ignored": {
    "paths": {
      "yourapihost.com": {
        "add-to-cart": {
          "POST": {
            "queryParamters": [
              "created_timestamp"
            ],
            "formDataParameters": []
          }
        },
        "api-status-checker": {
          "GET": {
            "iterable": true
          }
        }
      }
    },
    "global": {
      "queryParamters": [
        "timestamp"
      ],
      "formDataParameters": []
    }
  }
}
```

`queryParamters` **& `formDataParameters` :**

å› éƒ¨åˆ† API åƒæ•¸å¯èƒ½æœƒéš¨å‘¼å«æ”¹è®Šï¼Œä¾‹å¦‚æœ‰çš„ Endpoint æœƒå¸¶ä¸Šæ™‚é–“åƒæ•¸ï¼Œæ­¤æ™‚ä¾ç…§ Server çš„è¨­è¨ˆï¼Œ `Hash(Query Parameter & Body Content)` çš„å€¼å°±æœƒåœ¨ Replay Request æ™‚ä¸ä¸€æ¨£ï¼Œå°è‡´ Mapping ä¸åˆ° Local Responseï¼Œå› æ­¤å¤šé–‹äº†ä¸€å€‹ `config.json` è™•ç†é€™å€‹æƒ…æ³ï¼Œå¯ä»¥ by Endpoint Path or Global è¨­å®šæŸå€‹åƒæ•¸æ‡‰è©²åœ¨æ’é™¤ Hash æ™‚æ’é™¤ï¼Œå°±èƒ½å–å¾—åŒæ¨£çš„ Mapping çµæœã€‚

`iterable` **:**

å› éƒ¨åˆ†è¼ªè©¢æª¢æŸ¥çš„ API å¯èƒ½æœƒé‡è¤‡å®šæ™‚ä¸æ–·å‘¼å«ï¼Œç…§ Server çš„è¨­è¨ˆæœƒç”¢å‡ºå¾ˆå¤š `Content-x.xxx` & `Header-x.json` æª”æ¡ˆï¼›ä½†å‡è¨­æˆ‘å€‘ä¸åœ¨æ„å‰‡å¯è¨­å®šç‚º `True` ï¼ŒResponse æœƒæŒçºŒå„²å­˜è¦†è“‹åˆ° `Content-0.xxx` & `Header-0.json` ç¬¬ä¸€å€‹æª”æ¡ˆå…§ã€‚

**å•Ÿç”¨ Reverse Proxy Record Modeï¼š**
```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
```

**å•Ÿç”¨ Reverse Proxy Replay Modeï¼š**
```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
```
### çµ„è£ & Proof Of Concept
#### 0\. å®Œæˆ Codebase ä¸­ Host çš„æŠ½æ›

ä¸¦ç¢ºèªåœ¨è·‘æ¸¬è©¦æ™‚ï¼ŒAPI å·²æ”¹ç”¨ `http://127.0.0.1:8080`
#### 1\. å•Ÿå‹• Snapshot API Local Mock Server \(a\.k\.a Reverse Proxy Server\) Record Mode
```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=addCart --set config_file=config.json
```
#### 2\. åŸ·è¡Œ E2E Testing UI æ“ä½œ

ä»¥ [Pinkoi iOS App](https://apps.apple.com/tw/app/pinkoi-%E4%BA%9E%E6%B4%B2%E9%A0%98%E5%85%88%E8%B7%A8%E5%A2%83%E8%A8%AD%E8%A8%88%E8%B3%BC%E7%89%A9%E7%B6%B2%E7%AB%99/id557252416){:target="_blank"} ç‚ºä¾‹ï¼Œæ¸¬è©¦ä»¥ä¸‹æµç¨‹ï¼š


> Launch App \-&gt; Home \-&gt; Scroll Down \-&gt; Similar to Wish List Items Section \-&gt; First Product \-&gt; Click First Product \-&gt; Enter Product Page \-&gt; Click Add to Cart \-&gt; UI Response Added to Cart \-&gt; Test Successful âœ… 






![](/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.png)


UI è‡ªå‹•åŒ–æ“ä½œæ–¹å¼å‰é¢æœ‰æåˆ°ï¼Œé€™é‚Šå…ˆæ‰‹å‹•æ¸¬è©¦ç›¸åŒçš„æµç¨‹é©—è­‰çµæœã€‚
#### 3\. å–å¾— Record çµæœ

æ“ä½œå®Œæˆå¾Œå¯ä»¥ä¸‹ `^ + C` çµ‚æ­¢ Snapshot API Mock Serverï¼Œåˆ°æª”æ¡ˆç›®éŒ„æŸ¥çœ‹éŒ„è£½çµæœï¼š


![](/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.png)

#### 4\. Replay é©—è­‰åŒå€‹æµç¨‹ï¼Œå•Ÿå‹• Server & Using Replay Mode
```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=addCart --set config_file=config.json
```
#### 5\. å†æ¬¡åŸ·è¡Œå‰›å‰›çš„ UI æ“ä½œé©—è­‰çµæœ


![](/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.png)

- å·¦ï¼šTest Successful âœ…
- å³ï¼šæ¸¬è©¦é»æ“ŠéŒ„è£½ä»¥å¤–çš„å•†å“ï¼Œæ­¤æ™‚æœƒå‡ºç¾ Error \(å› æœ¬åœ°æ²’è³‡æ–™ \+ `network_restricted` é è¨­æ˜¯ `False` æœ¬åœ°æ²’è³‡æ–™ç›´æ¥å‚³ 404ï¼Œä¸æœƒå¾ç¶²è·¯æ‹¿è³‡æ–™\)

#### 6\. Proof Of Concept âœ…

æ¦‚å¿µé©—è­‰é€šéï¼Œæˆ‘å€‘ç¢ºå¯¦èƒ½é€éå¯¦ç¾ Reverse Proxy Server ä¾†è‡ªè¡Œå„²å­˜ API Request & Response ä¸¦ä½œç‚º Mock API Server åœ¨æ¸¬è©¦æ™‚å›æ‡‰è³‡æ–™çµ¦ App ğŸ‰ğŸ‰ğŸ‰ã€‚
### \[2023â€“09â€“04\] mitmproxy\-rodo å·²é–‹æº


[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}

### å¾ŒçºŒå’Œé›œè¨˜

æœ¬æ–‡åªæ¢è¨äº†æ¦‚å¿µé©—è­‰ï¼Œå¾ŒçºŒé‚„æœ‰è¨±å¤šåœ°æ–¹è¦è£œé½Šä¹Ÿé‚„æœ‰æ›´å¤šåŠŸèƒ½å¯ä»¥å¯¦ç¾ã€‚
1. èˆ‡ [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} UI Testinga å·¥å…·æ•´åˆ
2. CI/CD æµç¨‹æ•´åˆè¨­è¨ˆ \(æ€éº¼è‡ªå‹•èµ· Reverse Proxy? èµ·åœ¨å“ªè£¡? \)
3. æ€éº¼æŠŠ MITMProxy å°è£åœ¨é–‹ç™¼å·¥å…·å…§?
4. é©—è­‰æ›´è¤‡é›œçš„æ¸¬è©¦å ´æ™¯
5. **é‡å°ç™¼é€çš„ Tracking Request åšé©—è­‰ï¼Œéœ€å¤šå¯¦ç¾å­˜ Request Bodyï¼Œç„¶å¾Œå¾ä¸­å–å¾—æ‰“äº†å“ªäº› Tracking Event Dataã€æ˜¯å¦ç¬¦åˆæµç¨‹è©²é€çš„äº‹ä»¶**

#### Cookie å•é¡Œ
```python
#...
    def response(self, flow):
        setCookies = flow.response.headers.get_all("set-cookie")
        # setCookies = ['ad=0; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/', 'sessionid=xxxx; Secure; HttpOnly; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/']
        
        # OR Replace Cookie Domain From .xxx.com To 127.0.0.1
        setCookies = [re.sub(r"\s*\.xxx\.com\s*", "127.0.0.1", s) for s in setCookies]

        # AND ç§»é™¤å®‰å…¨æ€§ç›¸é—œé™åˆ¶
        setCookies = [re.sub(r";\s*Secure\s*", "", s) for s in setCookies]
        setCookies = [re.sub(r";\s*HttpOnly;\s*", "", s) for s in setCookies]

        flow.response.headers.set_all("Set-Cookie", setCookies)

        #...
```

å¦‚æœæœ‰é‡åˆ° Cookie æ–¹é¢çš„å•é¡Œï¼Œä¾‹å¦‚ API æœ‰å›æ‡‰ Cookie ä½† App æ²’æ¥åˆ°ï¼Œå¯åƒè€ƒä»¥ä¸Šçš„èª¿æ•´ã€‚
#### åœ¨ Pinkoi çš„æœ€å¾Œä¸€ç¯‡æ–‡ç« 

åœ¨ Pinkoi 900 å¤šå¤©çš„æ—¥å­è£¡ï¼Œå¯¦ç¾äº†è¨±å¤šæˆ‘è·æ¶¯ä¸Šé‚„æœ‰ iOS / App é–‹ç™¼ã€æµç¨‹çš„æƒ³åƒï¼Œæ„Ÿè¬æ‰€æœ‰éšŠå‹ï¼Œä¸€èµ·èµ°éç–«æƒ…ã€ç¶“æ­·é¢¨é›¨ï¼›å‘Šåˆ¥çš„å‹‡æ°£å¦‚åŒç•¶åˆè¿½å°‹å¤¢æƒ³å…¥è·çš„å‹‡æ°£ã€‚


> [**æ­£åœ¨å•Ÿèˆªæ‰¾å°‹æ–°çš„äººç”ŸæŒ‘æˆ°\(åŒ…æ‹¬ä½†ä¸é™æ–¼å·¥ç¨‹\)ï¼Œå¦‚æœæ‚¨æœ‰åˆé©çš„æ©Ÿæœƒï¼ˆiOS or å·¥ç¨‹ç®¡ç† or æ–°å‰µç”¢å“ï¼‰æ­¡è¿èˆ‡æˆ‘è¯çµ¡ã€‚**](http://resume.zhgchg.li/){:target="_blank"} ğŸ™ğŸ™ğŸ™ 






æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



_[Post](https://medium.com/zrealm-ios-dev/poc-app-end-to-end-testing-local-snapshot-api-mock-server-5a5c4b25a83d){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._
