---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2018-11-02T15:23:44.057+0000
description: é€‚é… iOS 9 ~ iOS 12 å¤„ç†é€šçŸ¥æƒé™çŠ¶æ€åŠè¦æ±‚æƒé™çš„è§£å†³æ–¹æ¡ˆ
image:
  path: /assets/fd7f92d52baa/1*fm_hG0GuT-BhSNTEB3Ht1g.jpeg
last_modified_at: 2024-04-13T07:25:31.183+0000
render_with_liquid: false
tags:
- simplified-chinese
- ios
- push-notification
- observables
- ios-app-development
- swift
title: ä» iOS 9 åˆ° iOS 12 æ¨æ’­é€šçŸ¥æƒé™çŠ¶æ€å¤„ç†(Swift)
---

### ä» iOS 9 åˆ° iOS 12 æ¨æ’­é€šçŸ¥æƒé™çŠ¶æ€å¤„ç†(Swift)



é€‚é… iOS 9 ~ iOS 12 å¤„ç†é€šçŸ¥æƒé™çŠ¶æ€åŠè¦æ±‚æƒé™çš„è§£å†³æ–¹æ¡ˆ



### åšä»€ä¹ˆï¼Ÿ



æ¥ç»­å‰ä¸€ç¯‡ã€Œ [ä»€ä¹ˆï¼ŸiOS 12 ä¸éœ€ä½¿ç”¨è€…æˆæƒå°±èƒ½ä¼ é€æ¨æ’­é€šçŸ¥(Swift)](https://medium.com/@zhgchgli/%E4%BB%80%E9%BA%BC-ios-12-%E4%B8%8D%E9%9C%80%E4%BD%BF%E7%94%A8%E8%80%85%E6%8E%88%E6%AC%8A%E5%B0%B1%E8%83%BD%E6%94%B6%E5%88%B0%E6%8E%A8%E6%92%AD%E9%80%9A%E7%9F%A5-swift-ade9e745a4bf?fbclid=IwAR1AKi3io4Jt-rFFgrLWEFsmA0lKYVFUD7Dw9n9LpMa2zAzJCHeGGGgn9Vs){:target="_blank"} ã€æåˆ°çš„æ¨æ’­æƒé™å–å¾—æµç¨‹ä¼˜åŒ–ï¼Œç»è¿‡ä¸Šä¸€ç¯‡Murmuréƒ¨åˆ†å†™çš„ä¼˜åŒ–ä¹‹ååˆé‡åˆ°äº†æ–°çš„éœ€æ±‚ï¼š



![](/assets/fd7f92d52baa/1*fm_hG0GuT-BhSNTEB3Ht1g.jpeg)



1. ä½¿ç”¨è€…è‹¥å…³é—­é€šçŸ¥åŠŸèƒ½ï¼Œæˆ‘ä»¬èƒ½åœ¨ç‰¹å®šåŠŸèƒ½é¡µé¢æç¤ºä»–å»è®¾å®šå¼€å¯


2. è·³è½¬è‡³è®¾å®šé¡µåï¼Œè‹¥æœ‰æ‰“å¼€/å…³é—­é€šçŸ¥çš„æ“ä½œï¼Œå›åˆ°APPè¦èƒ½è·Ÿè‘—æ›´æ”¹çŠ¶æ€


3. æ²¡è¯¢é—®è¿‡æ¨æ’­æƒé™æ—¶è¯¢é—®æƒé™ï¼Œæœ‰è¯¢é—®è¿‡ä½†æ˜¯ä¸å…è®¸åˆ™è·³æç¤ºï¼Œæœ‰è¯¢é—®è¿‡åˆæ˜¯å…è®¸åˆ™èƒ½ç»§ç»­æ“ä½œ


4. iOS 9 ~ iOS 12 éƒ½è¦æ”¯æ´



1~3 éƒ½è¿˜å¥½ï¼Œä½¿ç”¨ iOS 10 ä¹‹åçš„Framework UserNotifications å·®ä¸å¤šéƒ½èƒ½å¦¥å–„çš„è§£å†³ï¼Œéº»çƒ¦çš„æ˜¯ç¬¬4é¡¹ è¦èƒ½æ”¯æ´ iOS 9ï¼ŒiOS 9è¦ä½¿ç”¨ registerUserNotificationSettings æ—§çš„æ–¹å¼å¤„ç†èµ·æ¥å¹¶ä¸å®¹æ˜“ï¼›å°±è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åšèµ·å§ï¼



### æ€è·¯åŠæ¶æ„ï¼š



é¦–å…ˆå®£å‘Šä¸€ä¸ªå…¨åŸŸçš„ notificationStatusç‰©ä»¶ å‚¨å­˜é€šçŸ¥æƒé™çŠ¶æ€ å¹¶åœ¨éœ€è¦å¤„ç†çš„é¡µé¢åŠ ä¸Šå±æ€§ç›‘å¬ï¼ˆè¿™è¾¹æˆ‘ä½¿ç”¨ [Observable](https://github.com/slazyk/Observable-Swift){:target="_blank"} åšå±æ€§å˜åŒ–çš„è®¢é˜…ã€å¯è‡ªè¡Œæ‰¾é€‚åˆçš„KVOæˆ–ç”¨Rxã€ReactiveCocoaï¼‰



å¹¶åœ¨ appDelegate ä¸­ didFinishLaunchingWithOptions (APPåˆå§‹æ‰“å¼€æ—¶)ã€applicationDidBecomeActive (ä»èƒŒæ™¯çŠ¶æ€å›å¤æ—¶)ã€didRegisterUserNotificationSettings (â‰¤iOS 9 çš„æ¨æ’­è¯¢é—®å¤„ç†)
è¿™äº›æ–¹æ³•ä¸­å¤„ç†æ£€æŸ¥æ¨æ’­é€šçŸ¥æƒé™çŠ¶æ€å¹¶æ›´æ”¹ notificationStatus çš„å€¼
éœ€è¦åšå¤„ç†çš„é¡µé¢å°±ä¼šè§¦å‘å¹¶ä½œç›¸å¯¹åº”çš„å¤„ç†ï¼ˆEX: è·³å‡ºé€šçŸ¥è¢«å…³é—­æç¤ºï¼‰



#### 1. é¦–å…ˆå®£å‘Šå…¨åŸŸ notificationStatus ç‰©ä»¶



```swift
enum NotificationStatusType {
     case authorized
     case denied
     case notDetermined
}
var notificationStatus: Observable<NotificationStatusType?> = Observable(nil)
```



notificationStatus/NotificationStatusType çš„å››ç§çŠ¶æ€åˆ†åˆ«å¯¹åº”ï¼š



- nil = ç‰©ä»¶åˆå§‹åŒ–â€¦æ£€æµ‹ä¸­â€¦


- notDetermined = æœªè¯¢é—®è¿‡ä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥


- authorized = å·²è¯¢é—®è¿‡ä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥ä¸”æŒ‰ã€Œå…è®¸ã€


- denied = å·²è¯¢é—®è¿‡ä½¿ç”¨è€…è¦ä¸è¦æ¥æ”¶é€šçŸ¥ä¸”æŒ‰ã€Œä¸å…è®¸ã€



#### 2. æ„å»ºæ£€æµ‹é€šçŸ¥æƒé™çŠ¶æ€çš„æ–¹æ³•ï¼š



```swift
func checkNotificationPermissionStatus() {
    if #available(iOS 10.0, *) {
        UNUserNotificationCenter.current().getNotificationSettings { (settings) in
            DispatchQueue.main.async {
                //æ³¨æ„ï¼è¦åˆ‡å›ä¸»æ‰§è¡Œç»ª
                if settings.authorizationStatus == .authorized {
                    //å…è®¸
                    notificationStatus.value = NotificationStatusType.authorized
                } else if settings.authorizationStatus == .denied {
                    //ä¸å…è®¸
                    notificationStatus.value = NotificationStatusType.denied
                } else {
                    //æ²¡é—®è¿‡
                    notificationStatus.value = NotificationStatusType.notDetermined
                }
            }
        }
    } else {
        if UIApplication.shared.currentUserNotificationSettings?.types == []  {
            if let iOS9NotificationIsDetermined = UserDefaults.standard.object(forKey: "iOS9NotificationIsDetermined") as? Bool,iOS9NotificationIsDetermined == true {
                //æ²¡é—®è¿‡
                notificationStatus.value = NotificationStatusType.notDetermined
            } else {
                //ä¸å…è®¸
                notificationStatus.value = NotificationStatusType.denied
            }
        } else {
            //å…è®¸
            notificationStatus.value = NotificationStatusType.authorized
        }
    }
}
```



**ä»¥ä¸Šè¿˜æ²¡ç»“æŸï¼**
çœ¼å°–çš„æœ‹å‹åº”è¯¥åœ¨â‰¤ iOS 9çš„åˆ¤æ–­ä¹‹ä¸­å‘ç°â€iOS9NotificationIsDeterminedâ€è¿™ä¸ªè‡ªè®¢çš„UserDefaultsï¼Œé‚£å®ƒæ˜¯ç”¨æ¥å¹²å˜›çš„å‘¢ï¼Ÿ



ä¸»å› æ˜¯â‰¤iOS 9çš„æ£€æµ‹æ¨æ’­æƒé™æ–¹æ³•åªèƒ½ç”¨è·å–ç›®å‰çš„æƒé™æœ‰å“ªäº›ä½œä¸ºåˆ¤æ–­ï¼Œè‹¥ä¸ºç©ºåˆ™ä»£è¡¨æ— æƒé™ï¼Œä½†åœ¨æ²¡è¯¢é—®è¿‡æƒé™çš„æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¼šæ˜¯ç©ºç™½ï¼›è¿™æ—¶å€™éº»çƒ¦å°±æ¥äº†ï¼Œä½¿ç”¨è€…ç©¶ç«Ÿæ˜¯æ²¡é—®è¿‡è¿˜æ˜¯é—®è¿‡æŒ‰ä¸å…è®¸ï¼Ÿ



è¿™è¾¹æˆ‘ä½¿ç”¨äº†ä¸€ä¸ªè‡ªè®¢çš„UserDefaults iOS9NotificationIsDeterminedä½œä¸ºåˆ¤æ–­å¼€å…³ï¼Œå¹¶åœ¨appDelegateçš„didRegisterUserNotificationSettingsä¸­åŠ å…¥ï¼š



```swift
//appdelegate.swift:
func application(_ application: UIApplication, didRegister notificationSettings: UIUserNotificationSettings) {
    //iOS 9(å«)ä»¥ä¸‹ï¼Œè·³å‡ºè¯¢é—®è¦ä¸è¦å…è®¸é€šçŸ¥çš„è§†çª—åï¼ŒæŒ‰ä¸‹å…è®¸æˆ–ä¸å…è®¸éƒ½ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•
    UserDefaults.standard.set("iOS9NotificationIsDetermined", true)
    checkNotificationPermissionStatus()
}
```



**é€šçŸ¥æƒé™çŠ¶æ€çš„ç‰©ä»¶ã€æ£€æµ‹çš„æ–¹æ³•éƒ½æ„å»ºå¥½åï¼ŒappDelegateé‡Œæˆ‘ä»¬è¿˜è¦å†åŠ ä¸Šâ€¦**



```swift
//appdelegate.swift
func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -> Bool {  
  checkNotificationPermissionStatus()
  return true
}
func applicationDidBecomeActive(_ application: UIApplication) {
  checkNotificationPermissionStatus()
}
```



APPåˆå§‹è·Ÿä»èƒŒæ™¯è¿”å›éƒ½è¦å†æ£€æµ‹ä¸€æ¬¡æ¨æ’­çŠ¶æ€å¦‚ä½•



ä»¥ä¸Šå°±æ˜¯æ£€æµ‹çš„éƒ¨åˆ†ï¼Œå†æ¥æˆ‘ä»¬æ¥çœ‹å¦‚æœæ˜¯æœªè¯¢é—®è¯¥æ€ä¹ˆå¤„ç†è¦æ±‚é€šçŸ¥æƒé™



#### 3. è¦æ±‚é€šçŸ¥æƒé™ï¼š



```swift
func requestNotificationPermission() {
    if #available(iOS 10.0, *) {
        let permissiones:UNAuthorizationOptions = [.badge, .alert, .sound]
        UNUserNotificationCenter.current().requestAuthorization(options: permissiones) { (granted, error) in
            DispatchQueue.main.async {
                checkNotificationPermissionStatus()
            }
        }
    } else {
        application.registerUserNotificationSettings(UIUserNotificationSettings(types: [.alert, .badge, .sound], categories: nil))
        //å‰é¢appdelegate.swiftçš„didRegisterUserNotificationSettingsä¼šå¤„ç†åç»­callback
    }
}
```



æ£€æµ‹è·Ÿè¦æ±‚éƒ½å¤„ç†å®Œå•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åº”ç”¨



#### 4. åº”ç”¨(é™æ€)



```php
if notificationStatus.value == NotificationStatusType.authorized {
    //OK!
} else if notificationStatus.value == NotificationStatusType.denied {
    //ä¸å…è®¸
    //è¿™è¾¹èŒƒä¾‹æ˜¯è·³å‡ºUIAlertControlleræç¤ºå¹¶ç‚¹å‡»åå¯è·³è½¬è‡³è®¾å®šé¡µé¢
    let alertController = UIAlertController(
        title: "äº²çˆ±çš„ï¼Œæ‚¨ç›®å‰æ— æ³•æ¥æ”¶é€šçŸ¥",
        message: "è¯·å¼€å¯ç»“å©šå§é€šçŸ¥æƒé™ã€‚",
        preferredStyle: .alert)
    let settingAction = UIAlertAction(
        title: "å‰å¾€è®¾å®š",
        style: .destructive,
        handler: {
            (action: UIAlertAction!) -> Void in
            if let bundleID = Bundle.main.bundleIdentifier,let url = URL(string:UIApplicationOpenSettingsURLString + bundleID) {
                UIApplication.shared.openURL(url)
            }
    })
    let okAction = UIAlertAction(
        title: "å–æ¶ˆ",
        style: .default,
        handler: {
            (action: UIAlertAction!) -> Void in
            //well....
    })
    alertController.addAction(okAction)
    alertController.addAction(settingAction)
    self.present(alertController, animated: true) {
        
    }
} else if notificationStatus.value == NotificationStatusType.notDetermined {
    //æœªè¯¢é—®
    requestNotificationPermission()
}
```



> **è¯·æ³¨æ„ï¼ï¼è·³åˆ°APPçš„ã€Œè®¾å®šã€é¡µæ—¶è¯·å‹¿ä½¿ç”¨**



> UIApplication.shared.openURL(URL(string:â€App-Prefs:root=\ (bundleID)â€) )



> æ–¹å¼è·³è½¬ï¼Œ **ä¼šè¢«é€€å®¡! ä¼šè¢«é€€å®¡! ä¼šè¢«é€€å®¡! ï¼ˆäº²èº«ç»å†ï¼‰**



> è¿™æ˜¯Private API



#### 5. åº”ç”¨(åŠ¨æ€)



åŠ¨æ€å˜æ›´çŠ¶æ€çš„éƒ¨åˆ†ï¼Œå› ä¸ºnotificationStatusç‰©ä»¶æˆ‘ä»¬ä½¿ç”¨æ˜¯Observableï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¦æ—¶æ—¶ç›‘æµ‹çŠ¶æ€çš„viewDidLoadä¸­åŠ å…¥ç›‘å¬å¤„ç†ï¼š



```swift
override func viewDidLoad() {
   super.viewDidLoad()
   notificationStatus.afterChange += { oldStatus,newStatus in
      if newStatus == NotificationStatusType.authorized {
       //print("â¤ï¸è°¢è°¢ä½ æ‰“å¼€é€šçŸ¥") 
      } else if newStatus == NotificationStatusType.denied {
       //print("ğŸ˜­å‘œå‘œ")
      }
   }
}
```



> ä»¥ä¸Šåªæ˜¯èŒƒä¾‹Codeï¼Œå®é™…åº”ç”¨ã€è§¦å‘å¯å†è‡ªè¡Œè°ƒæ ¡



> ***notificationStatus ä½¿ç”¨ Observable è¯·æ³¨æ„è®°å¿†ä½“æ§åˆ¶ï¼Œè¯¥é‡Šæ”¾æ—¶è¦èƒ½é‡Šæ”¾ï¼ˆé˜²æ­¢è®°å¿†ä½“æ³„æ¼ï¼‰ã€ä¸è¯¥é‡Šæ”¾æ—¶éœ€æŒæœ‰ï¼ˆé¿å…ç›‘å¬å¤±æ•ˆï¼‰**



### æœ€åé™„ä¸Šå®Œæ•´Demoæˆå“ï¼š



![[ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/fd7f92d52baa/1*_iVzlJLNQ7f0hO7IWxg1Zg.gif)



[ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}



**ç”±äºæˆ‘ä»¬çš„ä¸“æ¡ˆæ”¯æ´èŒƒå›´æ˜¯iOS 9 ~ iOS12ï¼ŒiOS 8æœªè¿›è¡Œä»»ä½•æµ‹è¯•ä¸ç¡®å®šæ”¯æ´ç¨‹åº¦*



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/%E5%BE%9E-ios-9-%E5%88%B0-ios-12-%E6%8E%A8%E6%92%AD%E9%80%9A%E7%9F%A5%E6%AC%8A%E9%99%90%E7%8B%80%E6%85%8B%E8%99%95%E7%90%86-swift-fd7f92d52baa){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*