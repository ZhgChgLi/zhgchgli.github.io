---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2018-10-16T16:01:24.511+0000
description: Vision å®æˆ˜åº”ç”¨
image:
  path: /assets/9a9aa892f9a9/1*c-ioRH_Z2nMYRxSbuBD71A.png
last_modified_at: 2024-08-13T08:17:24.185+0000
render_with_liquid: false
tags:
- simplified-chinese
- swift
- machine-learning
- facedetection
- ios
- ios-app-development
title: Vision åˆæ¢â€Šâ€”â€ŠAPP å¤´åƒä¸Šä¼  è‡ªåŠ¨è¯†åˆ«äººè„¸è£å›¾ (Swift)
---

### Vision åˆæ¢ â€” APP å¤´åƒä¸Šä¼  è‡ªåŠ¨è¯†åˆ«äººè„¸è£å›¾ (Swift)



Vision å®æˆ˜åº”ç”¨



### [2024/08/13 Update]



- è¯·å‚è€ƒæ–°æ–‡ç« ã€æ–°çš„ APIï¼šã€Œ [iOS Vision framework x WWDC 24 Discover Swift enhancements in the Vision framework Session](../755509180ca8/) ã€



#### ä¸€æ ·ä¸å¤šè¯´ï¼Œå…ˆä¸Šä¸€å¼ æˆå“å›¾ï¼š



![ä¼˜åŒ–å‰ V.S ä¼˜åŒ–å â€” [ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/9a9aa892f9a9/1*c-ioRH_Z2nMYRxSbuBD71A.png)



ä¼˜åŒ–å‰ V.S ä¼˜åŒ–å â€” [ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}



å‰é˜µå­iOS 12å‘å¸ƒæ›´æ–°ï¼Œæ³¨æ„åˆ°æ–°å¼€æ”¾çš„CoreML æœºå™¨å­¦ä¹ æ¡†æ¶ï¼›è§‰å¾—æŒºæœ‰è¶£çš„ï¼Œå°±å¼€å§‹æ„æƒ³å¦‚æœæƒ³ç”¨åœ¨å½“å‰çš„äº§å“ä¸Šèƒ½æ”¾åœ¨å“ªé‡Œï¼Ÿ



> **CoreMLå°é²œæ–‡ç« ç°å·²å‘å¸ƒï¼š [ä½¿ç”¨æœºå™¨å­¦ä¹ è‡ªåŠ¨é¢„æµ‹æ–‡ç« åˆ†ç±»ï¼Œè¿æ¨¡å‹ä¹Ÿè‡ªå·±è®­ç»ƒ](../793bf2cdda0f/)**



CoreMLæä¾›æ–‡å­—ã€å›¾åƒçš„æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒåŠå¼•ç”¨åˆ°APPé‡Œçš„æ¥å£ï¼Œæˆ‘åŸå…ˆçš„æƒ³æ³•æ˜¯ï¼Œä½¿ç”¨CoreMLæ¥åšåˆ°äººè„¸è¯†åˆ«ï¼Œè§£å†³APPä¸­æœ‰è£å›¾çš„é¡¹ç›®å¤´æˆ–è„¸è¢«å¡æ‰çš„é—®é¢˜ï¼Œå¦‚ä¸Šå›¾å·¦æ‰€ç¤ºï¼Œè‹¥äººè„¸å‡ºç°åœ¨å‘¨å›´åˆ™å¾ˆå®¹æ˜“å› ä¸ºç¼©æ”¾ï¼‹è£å›¾é€ æˆè„¸ä¸å®Œæ•´ï¼



ç»è¿‡ç½‘è·¯æœå¯»ä¸€ç•ªåæ‰å‘ç°æˆ‘å­¦è¯†çŸ­æµ…ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨iOS 11å°±å·²å‘å¸ƒï¼šã€ŒVisionã€æ¡†æ¶ï¼Œæ”¯æ´æ–‡å­—ä¾¦æµ‹ã€äººè„¸ä¾¦æµ‹ã€å›¾åƒæ¯”å¯¹ã€QRCODEä¾¦æµ‹ã€ç‰©ä»¶è¿½è¸ªâ€¦åŠŸèƒ½



è¿™è¾¹ä½¿ç”¨çš„å°±æ˜¯å…¶ä¸­çš„äººè„¸ä¾¦æµ‹é¡¹ç›®ï¼Œç»ä¼˜åŒ–åå¦‚å³å›¾æ‰€ç¤ºï¼›æ‰¾åˆ°äººè„¸å¹¶ä»¥æ­¤ä¸ºä¸­å¿ƒè£å›¾ï¼



### å®æˆ˜å¼€å§‹ï¼š



#### é¦–å…ˆæˆ‘ä»¬å…ˆåšèƒ½æ ‡è®°äººè„¸ä½ç½®çš„åŠŸèƒ½ï¼Œåˆæ­¥è®¤è¯†ä¸€ä¸‹Visionæ€ä¹ˆç”¨



![Demo APP](/assets/9a9aa892f9a9/1*cpGgpXsBhuiJoZI03WAGUw.png)



Demo APP



å®Œæˆå›¾å¦‚ä¸Šæ‰€ç¤ºï¼Œèƒ½æ ‡è®°å‡ºç…§ç‰‡ä¸­äººè„¸çš„ä½ç½®



p.s ä»…èƒ½æ ‡è®°ã€Œäººè„¸ã€ï¼Œæ•´ä¸ªå¤´åŒ…å«å¤´å‘å¹¶ä¸è¡ŒğŸ˜…



è¿™å—ç¨‹å¼ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†è¦è§£å†³ å›¾ç‰‡åŸå°ºå¯¸ç¼©æ”¾æ”¾å…¥ ImageViewæ—¶ä¼šç•™ç™½çš„çŠ¶å†µï¼›ç®€å•æ¥è¯´æˆ‘ä»¬è¦çš„æ˜¯Imageçš„Sizeå¤šå¤§ï¼ŒImageViewçš„Sizeå°±æœ‰å¤šå¤§ï¼Œè‹¥ç›´æ¥æ”¾å…¥å›¾ç‰‡ä¼šé€ æˆå¦‚ä¸‹èµ°ä½æƒ…å½¢



![](/assets/9a9aa892f9a9/1*Mb70Ed6pALO-8sllCpb7Qg.png)



ä½ å¯èƒ½ä¼šæƒ³è¯´ç›´æ¥æ”¹ContentModeå˜æˆfillã€fitã€redrawï¼Œä½†å°±ä¼šå˜å½¢æˆ–å›¾ç‰‡è¢«å¡æ‰



```swift
let ratio = UIScreen.main.bounds.size.width
//è¿™è¾¹æ˜¯å› ä¸ºæˆ‘UIIMAGEVIEW é‚£è¾¹è®¾å®šå·¦å³å¯¹é½0ï¼Œå®½é«˜æ¯”1:1

let sourceImage = UIImage(named: "Demo2")?.kf.resize(to: CGSize(width: ratio, height: CGFloat.leastNonzeroMagnitude), for: .aspectFill)
//ä½¿ç”¨KingFisherçš„å›¾ç‰‡å˜å½¢åŠŸèƒ½ï¼Œå·²å®½ä¸ºåŸºå‡†ï¼Œé«˜åº¦è‡ªç”±

imageView.contentMode = .redraw
//contentModeä½¿ç”¨redrawå¡«æ»¡

imageView.image = sourceImage
//èµ‹äºˆå›¾ç‰‡

imageViewConstraints.constant = (ratio - (sourceImage?.size.height ?? 0))
imageView.layoutIfNeeded()
imageView.sizeToFit()
//è¿™ä¸€å—æ˜¯æˆ‘å»æ”¹å˜ imageViewçš„Constraintsï¼Œè¯¦æƒ…å¯çœ‹æ–‡æœ«å®Œæ•´èŒƒä¾‹
```



ä»¥ä¸Šå°±æ˜¯é’ˆå¯¹å›¾ç‰‡åšçš„å¤„ç†



*è£å›¾éƒ¨åˆ†ä½¿ç”¨Kingfisherå¸®åŠ©æˆ‘ä»¬ï¼Œä¹Ÿå¯æ›¿æ¢æˆå…¶ä»–å¥—ä»¶æˆ–è‡ªåˆ»æ–¹æ³•*



ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿›å…¥é‡ç‚¹ç›´æ¥çœ‹Code



```swift
if #available(iOS 11.0, *) {
    //iOS 11ä¹‹åæ‰æ”¯æ´
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if let faceObservations = request.results as? [VNFaceObservation] {
            //è¾¨è¯†åˆ°çš„è„¸è„¸ä»¬
            
            DispatchQueue.main.async {
                //æ“ä½œUIVIEWï¼Œåˆ‡å›ä¸»æ‰§è¡Œç»ª
                let size = self.imageView.frame.size
                
                faceObservations.forEach({ (faceObservation) in
                    //åæ ‡ç³»è½¬æ¢
                    let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
                    let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
                    let transRect =  faceObservation.boundingBox.applying(translate).applying(transform)
                    
                    let markerView = UIView(frame: transRect)
                    markerView.backgroundColor = UIColor.init(red: 0/255, green: 255/255, blue: 0/255, alpha: 0.3)
                    self.imageView.addSubview(markerView)
                })
            }
        } else {
            print("æœªä¾¦æµ‹åˆ°ä»»ä½•è„¸")
        }
    }
    
    //è¾¨è¯†è¯·æ±‚
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        //è¾¨è¯†éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥æ”¾å…¥èƒŒæ™¯å­æ‰§è¡Œç»ªæ‰§è¡Œï¼Œé¿å…å½“å‰ç”»é¢å¡ä½
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("Throwsï¼š\(error)")
        }
    }
  
} else {
    //
    print("ä¸æ”¯æ´")
}
```



ä¸»è¦è¦æ³¨æ„çš„æ˜¯ï¼Œåæ ‡ç³»è½¬æ¢éƒ¨åˆ†ï¼›è¾¨è¯†å‡ºæ¥çš„ç»“æœæ˜¯Imageçš„åŸå§‹åº§æ ‡ï¼›æˆ‘ä»¬é¡»å°†å®ƒè½¬æ¢æˆåŒ…åœ¨å¤–é¢çš„ImageViewçš„å®é™…åº§æ ‡æ‰èƒ½æ­£ç¡®åœ°ä½¿ç”¨å®ƒï¼



#### å†æ¥æˆ‘ä»¬æ¥åšä»Šå¤©çš„é‡å¤´æˆ â€” ä¾ç…§äººè„¸çš„ä½ç½®è£åˆ‡å‡ºå¤§å¤´è´´çš„æ­£ç¡®ä½ç½®



```php
let ratio = UIScreen.main.bounds.size.width
//è¿™è¾¹æ˜¯å› ä¸ºæˆ‘UIIMAGEVIEW é‚£è¾¹è®¾å®šå·¦å³å¯¹é½0ï¼Œå®½é«˜æ¯”1:1ï¼Œè¯¦æƒ…å¯çœ‹æ–‡æœ«å®Œæ•´èŒƒä¾‹

let sourceImage = UIImage(named: "Demo")

imageView.contentMode = .scaleAspectFill
//ä½¿ç”¨scaleAspectFillæ¨¡å¼å¡«æ»¡

imageView.image = sourceImage
//ç›´æ¥èµ‹äºˆåŸå›¾ç‰‡ï¼Œæˆ‘ä»¬ä¹‹åå†æ“ä½œ

if let image = sourceImage,#available(iOS 11.0, *),let ciImage = CIImage(image: image) {
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if request.results?.count == 1,let faceObservation = request.results?.first as? VNFaceObservation {
            //ã„§å¼ è„¸
            let size = CGSize(width: ratio, height: ratio)
            
            let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
            let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
            let finalRect =  faceObservation.boundingBox.applying(translate).applying(transform)
            
            let center = CGPoint(x: (finalRect.origin.x + finalRect.width/2 - size.width/2), y: (finalRect.origin.y + finalRect.height/2 - size.height/2))
            //è¿™é‡Œæ˜¯è®¡ç®—è„¸çš„èŒƒå›´ä¸­é—´ç‚¹ä½ç½®
            
            let newImage = image.kf.resize(to: size, for: .aspectFill).kf.crop(to: size, anchorOn: center)
            //å°†å›¾ç‰‡ä¾ç…§ä¸­é—´ç‚¹è£åˆ‡
            
            DispatchQueue.main.async {
                //æ“ä½œUIVIEWï¼Œåˆ‡å›ä¸»æ‰§è¡Œç»ª
                self.imageView.image = newImage
            }
        } else {
            print("ä¾¦æµ‹åˆ°å¤šå¼ è„¸æˆ–æ²¡æœ‰ä¾¦æµ‹åˆ°è„¸")
        }
    }
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("Throwsï¼š\(error)")
        }
    }
} else {
    print("ä¸æ”¯æ´")
}
```



é“ç†è·Ÿæ ‡è®°äººè„¸ä½ç½®å·®ä¸å¤šï¼Œå·®åˆ«åœ¨å¤§å¤´è´´çš„éƒ¨åˆ†æ˜¯å›ºå®šå°ºå¯¸(å¦‚:300x300)ï¼Œæ‰€ä»¥æˆ‘ä»¬ç•¥è¿‡å‰é¢éœ€è¦è®©Imageé€‚åº”ImageViewçš„ç¬¬ä¸€éƒ¨åˆ†



å¦ä¸€ä¸ªå·®åˆ«æ˜¯æˆ‘ä»¬è¦å¤šè®¡ç®—äººè„¸èŒƒå›´çš„ä¸­å¿ƒç‚¹ï¼Œå¹¶ä»¥è¿™ä¸ªä¸­å¿ƒç‚¹ä¸ºå‡†åšè£åˆ‡å›¾ç‰‡



![çº¢ç‚¹ä¸ºè„¸çš„èŒƒå›´ä¸­å¿ƒç‚¹](/assets/9a9aa892f9a9/1*civytcKOguHfVFHYPVWecA.png)



çº¢ç‚¹ä¸ºè„¸çš„èŒƒå›´ä¸­å¿ƒç‚¹



#### å®Œæˆæ•ˆæœå›¾ï¼š



![é¡¿ä¸¹å‰çš„é‚£ä¸€ç§’æ˜¯åŸå§‹å›¾ä½ç½®](/assets/9a9aa892f9a9/1*WocYjt0xLkqtGVilxfT2LA.gif)



é¡¿ä¸¹å‰çš„é‚£ä¸€ç§’æ˜¯åŸå§‹å›¾ä½ç½®



### å®Œæ•´APPèŒƒä¾‹:



![](/assets/9a9aa892f9a9/1*J8oByw8gBCamIac2TkT1SA.gif)



ç¨‹å¼ç å·²ä¸Šä¼ è‡³Githubï¼š [è¯·ç‚¹æ­¤](https://github.com/zhgchgli0718/VisionDemo){:target="_blank"}



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/vision-%E5%88%9D%E6%8E%A2-app-%E9%A0%AD%E5%83%8F%E4%B8%8A%E5%82%B3-%E8%87%AA%E5%8B%95%E8%AD%98%E5%88%A5%E4%BA%BA%E8%87%89%E8%A3%81%E5%9C%96-swift-9a9aa892f9a9){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*