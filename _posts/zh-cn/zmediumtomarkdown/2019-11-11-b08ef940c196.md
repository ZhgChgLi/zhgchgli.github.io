---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2019-11-11T14:34:57.966+0000
description: åŠ¨æ‰‹æ‰“é€ é€‚åº”æ‰€æœ‰åœºæ™¯ã€ä¸ä¸­æ–­çš„Appè½¬è·³æµç¨‹
image:
  path: /assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg
last_modified_at: 2024-09-13T09:32:09.117+0000
render_with_liquid: false
tags:
- simplified-chinese
- deeplink
- ios-app-development
- swift
- universal-links
- app-store
title: iOS Deferred Deep Link å»¶è¿Ÿæ·±åº¦è¿ç»“å®ä½œ(Swift)
---

### iOS Deferred Deep Link å»¶è¿Ÿæ·±åº¦è¿ç»“å®ä½œ(Swift)



åŠ¨æ‰‹æ‰“é€ é€‚åº”æ‰€æœ‰åœºæ™¯ã€ä¸ä¸­æ–­çš„Appè½¬è·³æµç¨‹



### [2022/07/22] æ›´æ–° iOS 16 Upcoming Changes



iOS â‰¥ 16 å¼€å§‹éä½¿ç”¨è€…ä¸»åŠ¨æ“ä½œè´´ä¸ŠåŠ¨ä½œï¼ŒApp ä¸»åŠ¨è¯»å–å‰ªè´´ç°¿çš„è¡Œä¸ºä¼šè·³å‡ºè¯¢é—®è§†çª—ï¼Œä½¿ç”¨è€…éœ€è¦æŒ‰å…è®¸ï¼ŒApp æ‰èƒ½è¯»å–åˆ°å‰ªè´´ç°¿èµ„è®¯ã€‚



![[UIPasteBoardâ€™s privacy change in iOS 16](https://sarunw.com/posts/uipasteboard-privacy-change-ios16/){:target="_blank"}](/assets/b08ef940c196/0*E8h6Fy0H9_5jxhjV.png)



[UIPasteBoardâ€™s privacy change in iOS 16](https://sarunw.com/posts/uipasteboard-privacy-change-ios16/){:target="_blank"}



### [2020/07/02] æ›´æ–°



- [å› åº” iOS 14 æ›´æ–°ï¼Œè¯»å–å‰ªè´´ç°¿æ—¶ä¼šæç¤ºä½¿ç”¨è€…ï¼Œå¦‚è¦å®ä½œè¯·ä¸€å¹¶å‚è€ƒæ­¤ç¯‡æ–‡ç« ã€‚](../8a04443024e2/)



#### æ— å…³



æ¯•ä¸šå½“å®Œå…µåˆ°ç°åœ¨åº¸åº¸ç¢Œç¢Œå·¥ä½œäº†å¿«ä¸‰å¹´ï¼Œæˆé•¿å·²è¶‹äºå¹³ç¼“ï¼Œå¼€å§‹è¿›å…¥èˆ’é€‚åœˆï¼Œæ‰€å¹¸å¿ƒä¸€æ¨ªæäº†ç¦»èŒï¼Œæ²ˆæ·€é‡æ–°å‡ºå‘ã€‚



åœ¨é˜…è¯» [åšè‡ªå·±çš„ç”Ÿå‘½è®¾è®¡å¸ˆ](https://www.books.com.tw/products/0010733134){:target="_blank"} é‡æ–°æ¢³ç†è‡ªå·±çš„äººç”Ÿè§„åˆ’æ—¶ï¼Œå›é¡¾äº†ä¸€ä¸‹å·¥ä½œè·Ÿäººç”Ÿï¼Œè™½ç„¶æœ¬èº«æŠ€æœ¯èƒ½åŠ›æ²¡æœ‰å¾ˆå¥½ï¼Œä½†åœ¨å†™ Medium ä¸å¤§å®¶åˆ†äº«èƒ½è®©æˆ‘è¿›å…¥ã€Œå¿ƒæµã€è·Ÿè·å¾—å¤§é‡çš„ç²¾åŠ›ï¼›åˆšå¥½å‰é˜µå­æœ‰æœ‹å‹åœ¨é—® Deep Link é—®é¢˜ï¼Œå€Ÿæ­¤æ•´ç†äº†æˆ‘ç ”ç©¶çš„åšæ³•ï¼Œä¹Ÿé¡ºä¾¿è¡¥å……ä¸‹è‡ªå·±çš„ç²¾åŠ›ï¼



### åœºæ™¯



é¦–å…ˆè¦å…ˆè¯´æ˜å®é™…åº”ç”¨åœºæ™¯ã€‚



1.å½“ä½¿ç”¨è€…æœ‰è£… APP æ—¶ç‚¹å‡»ç½‘å€è¿ç»“(Googleæœå¯»æ¥æºã€FBè´´æ–‡ã€Lineè¿ç»“â€¦) åˆ™ç›´æ¥å¼€ APP å‘ˆç°ç›®æ ‡ç”»é¢ï¼Œè‹¥æ— åˆ™è·³è½¬åˆ° APP Store å®‰è£… APPï¼› **å®‰è£…å®Œåæ‰“å¼€APPï¼Œè¦èƒ½é‡ç°ä¹‹å‰æ¬²å‰å¾€çš„ç”»é¢** ã€‚



[![iOS Deferred Deep Link Demo](/assets/b08ef940c196/249b_hqdefault.jpg "iOS Deferred Deep Link Demo")](https://www.youtube.com/watch?v=sY6-Q7BFUOM){:target="_blank"}



2.APP ä¸‹è½½å’Œå¼€å¯æ•°æ®è¿½è¸ªï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ APP æ¨å¹¿è¿ç»“æœ‰å¤šå°‘äººç¡®å®ä»è¿™ä¸ªå…¥å£ä¸‹è½½å’Œå¼€å¯ APP çš„ã€‚



3.ç‰¹æ®Šæ´»åŠ¨å…¥å£ï¼Œä¾‹å¦‚é€è¿‡ç‰¹å®šç½‘å€ä¸‹è½½åå¼€å¯èƒ½è·å¾—å¥–åŠ±ã€‚



#### æ”¯æ´åº¦ï¼š



iOS â‰¥ 9



### ä½•è°“ Deferred Deep Link ä¸ Deep Link çš„å·®åˆ«ï¼Ÿ



#### çº¯ Deep Link æœ¬èº«ï¼š



![](/assets/b08ef940c196/1*15arO4L94ZoEyOLtFARtsA.jpeg)



å¯ä»¥çœ‹åˆ° iOS Deep Link æœ¬èº«è¿ä½œæœºåˆ¶åªæœ‰åˆ¤æ–­ APP æœ‰æ— å®‰è£…ï¼Œæœ‰åˆ™å¼€ APPï¼Œæ— åˆ™ä¸å¤„ç†ï¼



#### é¦–å…ˆæˆ‘ä»¬è¦å…ˆåŠ ä¸Šã€Œæ— åˆ™è·³è½¬åˆ° APP Storeã€æç¤ºä½¿ç”¨è€…å®‰è£… APPï¼š



**URL Scheme** çš„éƒ¨åˆ†æ˜¯ç”±ç³»ç»Ÿæ§åˆ¶ï¼Œä¸€èˆ¬ç”¨äº APP å†…å‘¼å«é²œå°‘å…¬å¼€å‡ºæ¥ï¼›å› ä¸ºå¦‚æœè§¦å‘ç‚¹åœ¨è‡ªå·±æ— æ³•æ§åˆ¶çš„åŒºåŸŸ(å¦‚ï¼šLineè¿ç»“)ï¼Œåˆ™æ— æ³•å¤„ç†ã€‚



è‹¥è§¦å‘ç‚¹åœ¨è‡ªèº«ç½‘é¡µä¸Šå¯ä»¥ä½¿ç”¨äº›å°æŠ€å·§å¤„ç†ï¼Œè¯·å‚è€ƒ [**è¿™é‡Œ**](https://stackoverflow.com/questions/627916/check-if-url-scheme-is-supported-in-javascript){:target="_blank"} ï¼š



```xml
<html>
<head>
  <title>Redirect...</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <script>
    var appurl = 'marry://open';
    var appstore = 'https://apps.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E6%9C%80%E5%A4%A7%E5%A9%9A%E7%A6%AE%E7%B1%8C%E5%82%99app/id1356057329';

    var timeout;
    function start() {
      window.location = appurl;
      timeout = setTimeout(function(){
        if(confirm('é©¬ä¸Šå®‰è£…ç»“å©šå§APP?')){
          document.location = appstore;
        }
      }, 1000);
    }

    window.onload = function() {
      start()
    }
  </script>
</head>
<body>

</body>
</html>
```



å¤§ç•¥é€»è¾‘æ˜¯ **ä¸€æ ·å‘¼å« URL Schemeï¼Œç„¶åè®¾ä¸ª Timeoutï¼Œæ—¶é—´åˆ°è‹¥è¿˜åœ¨æœ¬é¡µæ²¡è·³è½¬å°±å½“æ²¡å®‰è£… Call ä¸åˆ° Schemeï¼Œè½¬è€Œå¯¼ APP Store é¡µé¢** (ä½†ä½“éªŒè¿˜æ˜¯ä¸å¥½è¿˜æ˜¯ä¼šè·³ç½‘å€é”™è¯¯æç¤ºï¼Œåªæ˜¯å¤šäº†è‡ªåŠ¨è½¬å€)ã€‚



**Universal Link** æœ¬èº«å°±æ˜¯ä¸ªè‡ªå·±çš„ç½‘é¡µï¼Œè‹¥æ— è·³è½¬ï¼Œé¢„è®¾å°±æ˜¯ä½¿ç”¨ç½‘é¡µæµè§ˆå™¨å‘ˆç°ï¼Œè¿™è¾¹æœ‰ç½‘é¡µæœåŠ¡çš„å¯ä»¥é€‰æ‹©ç›´æ¥è·³ç½‘é¡µæµè§ˆã€æ²¡æœ‰çš„å°±ç›´æ¥å¯¼ APP Store é¡µé¢ã€‚



æœ‰ç½‘é¡µæœåŠ¡çš„ç½‘ç«™å¯ä»¥åœ¨ `<head></head>` ä¸­åŠ å…¥ï¼š



```xml
<meta name="apple-itunes-app" content="app-id=APPID, app-argument=é¡µé¢å‚æ•°">
```



![](/assets/b08ef940c196/1*nC1JytAwIwKU04EMBBvf0A.jpeg)



ä½¿ç”¨ iPhone Safari æµè§ˆç½‘é¡µç‰ˆä¸Šæ–¹å°±ä¼šå‡ºç° APP å®‰è£…æç¤ºã€ä½¿ç”¨ APP å¼€å¯æœ¬é¡µçš„æŒ‰é’®ï¼› å‚æ•° `app-argument` å°±æ˜¯ç”¨æ¥å¸¦å…¥é¡µé¢å€¼ï¼Œå¹¶ä¼ é€’åˆ° APP ç”¨çš„ã€‚



![åŠ ä¸Šã€Œæ— åˆ™è·³è½¬åˆ° APP Storeã€çš„æµç¨‹å›¾](/assets/b08ef940c196/1*B-_5tIDWQpNO8NxpXQsEcA.jpeg)



åŠ ä¸Šã€Œæ— åˆ™è·³è½¬åˆ° APP Storeã€çš„æµç¨‹å›¾



#### å®Œå–„ Deep Link APP ç«¯å¤„ç†ï¼š



æˆ‘ä»¬è¦çš„å½“ç„¶ä¸åªæ˜¯ã€Œå½“ä½¿ç”¨è€…æœ‰å®‰è£… APP åˆ™å¼€å¯ APPã€ï¼Œæˆ‘ä»¬è¿˜è¦å°†æ¥æºèµ„è®¯ä¸ APP ä¸²èµ·ï¼Œè®© APP å¼€å¯åè‡ªåŠ¨å‘ˆç°ç›®æ ‡é¡µé¢çš„ APP ç”»é¢ã€‚



**URL Scheme** æ–¹å¼å¯åœ¨ AppDelegate ä¸­çš„ `func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool` è¿›è¡Œå¤„ç†ï¼š



```swift
func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool {
    if url.scheme == "marry",let params = url.queryParameters {
      if params["type"] == "topic" {
        let VC = TopicViewController(topicID:params["id"])
        UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
      }    
    }
    return true
}
```



**Universal Link** åˆ™æ˜¯åœ¨ AppDelegate ä¸­çš„ `func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([Any]?) -> Void) -> Bool` è¿›è¡Œå¤„ç†ï¼š



```swift
extension URL {
    /// test=1&a=b&c=d => ["test":"1","a":"b","c":"d"]
    /// è§£æç½‘å€queryè½¬æ¢æˆ[String: String]æ•°ç»„èµ„æ–™
    public var queryParameters: [String: String]? {
        guard let components = URLComponents(url: self, resolvingAgainstBaseURL: true), let queryItems = components.queryItems else {
            return nil
        }
        
        var parameters = [String: String]()
        for item in queryItems {
            parameters[item.name] = item.value
        }
        
        return parameters
    }
    
}
```



å…ˆé™„ä¸Šä¸€ä¸ª URL çš„æ‰©å……æ–¹æ³• queryParametersï¼Œç”¨äºæ–¹ä¾¿å°† URL Query è½¬æ¢æˆ Swift Dictionaryã€‚



```swift
func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([Any]?) -> Void) -> Bool {
        
  if userActivity.activityType == NSUserActivityTypeBrowsingWeb, webpageURL = userActivity.webpageURL {
    /// å¦‚æœæ˜¯universal link urlæ¥æº...
    let params = webpageURL.queryParameters
    
    if params["type"] == "topic" {
      let VC = TopicViewController(topicID:params["id"])
      UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
    }
  }
  
  return true  
}
```



![](/assets/b08ef940c196/1*zhtWK56EqWpE91yTVu64Lg.jpeg)



å®Œæˆï¼



#### é‚£è¿˜ç¼ºä»€ä¹ˆï¼Ÿ



ç›®å‰çœ‹æ¥å·²ç»å¾ˆå®Œç¾äº†ï¼Œæˆ‘ä»¬å¤„ç†äº†æ‰€æœ‰ä¼šé‡åˆ°çš„çŠ¶å†µï¼Œé‚£è¿˜ç¼ºä»€ä¹ˆï¼Ÿ



![](/assets/b08ef940c196/1*ulrLKyvTKoChPScWD9wHyA.jpeg)



å¦‚å›¾æ‰€ç¤ºï¼Œå¦‚æœæ˜¯ æœªå®‰è£… -&gt; APP Store å®‰è£… -&gt; APP Store æ‰“å¼€ï¼Œæ¥æºæ‰€å¸¦çš„èµ„æ–™å°±ä¼šä¸­æ–­ï¼ŒAPP ä¸çŸ¥é“æ¥æºæ‰€ä»¥å°±åªä¼šæ˜¾ç¤ºé¦–é¡µï¼›ä½¿ç”¨è€…è¦å†å›åˆ°ä¸Šä¸€æ­¥ç½‘é¡µå†ç‚¹ä¸€æ¬¡å¼€å¯ï¼ŒAPP æ‰ä¼šé©±åŠ¨è·³é¡µã€‚



![](/assets/b08ef940c196/1*dFdvCRRdM3vrN3lnyG8Diw.jpeg)



> *è™½ç„¶è¿™æ ·ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†è€ƒè™‘åˆ°è·³å‡ºæµå¤±ç‡ï¼Œå¤šä¸€ä¸ªæ­¥éª¤å°±æ˜¯å¤šä¸€å±‚æµå¤±ï¼Œè¿˜æœ‰ä½¿ç”¨è€…ä½“éªŒèµ·æ¥ä¸é¡ºç•…ï¼›æ›´ä½•å†µä½¿ç”¨è€…æœªå¿…è¿™ä¹ˆèªæ˜ã€‚*



#### è¿›å…¥æœ¬æ–‡é‡ç‚¹



ä½•è°“ Deferred Deep Linkï¼Ÿï¼Œå»¶è¿Ÿæ·±åº¦è¿ç»“ï¼›å°±æ˜¯è®©æˆ‘ä»¬çš„ Deep Link å¯ä»¥å»¶ä¼¸åˆ° APP Store å®‰è£…å®Œåä¾ç„¶ä¿æœ‰æ¥æºèµ„æ–™ã€‚



æ® Android å·¥ç¨‹å¸ˆè¡¨ç¤º Android æœ¬èº«å°±æœ‰æ­¤åŠŸèƒ½ï¼Œä½†åœ¨ iOS ä¸Šå¹¶ä¸æ”¯æ´æ­¤è®¾å®šã€è¦è¾¾åˆ°æ­¤åŠŸèƒ½çš„åšæ³•ä¹Ÿä¸å‹å–„ï¼Œè¯·ç»§ç»­çœ‹ä¸‹å»ã€‚



### Deferred Deep Link



> *å¦‚æœä¸æƒ³èŠ±æ—¶é—´è‡ªå·±åšçš„è¯å¯ä»¥ç›´æ¥ä½¿ç”¨ [branch.io](http://branch.io){:target="_blank"} æˆ– [Firebase Dynamic Links](https://firebase.google.com/docs/dynamic-links){:target="_blank"} æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•å°±æ˜¯ Firebase ä½¿ç”¨çš„æ–¹å¼ã€‚*



**è¦è¾¾æˆ Deferred Deep Link çš„æ•ˆæœç½‘è·¯ä¸Šæœ‰ä¸¤ç§åšæ³•ï¼š**



ä¸€ç§æ˜¯é€è¿‡ä½¿ç”¨è€…è£…ç½®ã€IPã€ç¯å¢ƒâ€¦ç­‰ç­‰å‚æ•°è®¡ç®—å‡ºä¸€ä¸ªæ‚å‡‘å€¼ï¼Œåœ¨ç½‘é¡µç«¯å­˜å…¥èµ„æ–™åˆ°ä¼ºæœå™¨ï¼›å½“ APP å®‰è£…åæ‰“å¼€ç”¨åŒæ ·æ–¹å¼è®¡ç®—ï¼Œå¦‚æœå€¼ç›¸åŒåˆ™å–å‡ºèµ„æ–™æ¢å¤ï¼ˆbranch.io çš„åšæ³•ï¼‰ã€‚



å¦ä¸€ç§æ˜¯æœ¬æ–‡è¦ä»‹ç»çš„æ–¹æ³•ï¼ŒåŒ Firebase ä½œæ³•ï¼›ä½¿ç”¨ iPhone å‰ªè´´ç°¿å’Œ Safari ä¸ APP Cookie å…±äº«æœºåˆ¶çš„æ–¹æ³•ï¼Œç­‰äºæ˜¯æŠŠèµ„æ–™å­˜åœ¨å‰ªè´´ç°¿æˆ–Cookieï¼ŒAPPå®‰è£…å®Œæˆåå†å»è¯»å‡ºæ¥ä½¿ç”¨ã€‚



![](/assets/b08ef940c196/1*VVahSlHV2N2jcIw4afzr2g.jpeg)



```

ç‚¹å‡»ã€ŒOpenã€åä½ çš„å‰ªè´´ç°¿å°±ä¼šè¢« JavaScript è‡ªåŠ¨è¦†ç›–å¤åˆ¶ä¸Šè·³è½¬ç›¸å…³èµ„è®¯ï¼šhttps://XXX.app.goo.gl/?link=https://XXX.net/topicID=1&type=topic
```



ç›¸ä¿¡æœ‰å¥—è¿‡ Firebase Dynamic Links çš„äººä¸€å®šä¸é™Œç”Ÿè¿™ä¸ªå¼€å¯è·³è½¬é¡µï¼Œäº†è§£åˆ°åŸç†ä¹‹åå°±çŸ¥é“è¿™é¡µåœ¨æµç¨‹ä¸­æ˜¯æ— æ³•ç§»é™¤çš„ï¼



å¦å¤– Firebase ä¹Ÿä¸æä¾›è¿›è¡Œæ ·å¼ä¿®æ”¹ã€‚



#### æ”¯æ´åº¦



é¦–å…ˆè®²ä¸ªå‘ï¼Œæ”¯æ´åº¦é—®é¢˜ï¼›å¦‚å‰æ‰€è¯´çš„ã€Œä¸å‹å–„ã€ï¼



![](/assets/b08ef940c196/1*LR3MSAcwjaoSQhwvtD2sUQ.png)



å¦‚æœ APP åªè€ƒè™‘ iOS â‰¥ 10 ä»¥ä¸Šçš„è¯å®¹æ˜“è®¸å¤šï¼ŒAPP å®ä½œå‰ªè´´ç°¿å­˜å–ã€Web ä½¿ç”¨ JavaScript å°†èµ„è®¯è¦†ç›–åˆ°å‰ªè´´ç°¿ï¼Œç„¶åå†è·³è½¬åˆ° APP Store å¯¼ä¸‹è½½å°±å¥½ã€‚



iOS = 9 ä¸æ”¯æ´JavaScriptè‡ªåŠ¨å‰ªè´´ç°¿ä½†æ”¯æ´ **Safari ä¸ APP SFSafariViewControllerã€ŒCookie äº’é€šå¤§æ³•ã€**



å¦å¤–åœ¨ APP éœ€è¦å·å·åœ¨èƒŒæ™¯åŠ å…¥ SFSafariViewController è½½å…¥ Webï¼Œå†ä» Web å–å¾—åˆšæ‰ç‚¹è¿ç»“æ—¶å­˜çš„Cookieèµ„è®¯ã€‚



> *æ­¥éª¤ç¹çï¼†è¿ç»“ç‚¹å‡»ä»…é™ Safariæµè§ˆå™¨ã€‚*



![[SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller){:target="_blank"}](/assets/b08ef940c196/1*tPXHlrQE3MdrjMzFbnS_4w.png)



[SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller){:target="_blank"}



> *æ ¹æ®å®˜æ–¹æ–‡ä»¶ï¼ŒiOS 11 å·²æ— æ³•å–å¾—ä½¿ç”¨è€…çš„ Safari Cookieï¼Œè‹¥æœ‰è¿™æ–¹é¢éœ€æ±‚å¯ä½¿ç”¨ SFAuthenticationSessionï¼Œä½†æ­¤æ–¹æ³•æ— æ³•åœ¨èƒŒæ™¯å·æ‰§è¡Œï¼Œæ¯æ¬¡è½½å…¥å‰éƒ½ä¼šè·³å‡ºä»¥ä¸‹è¯¢é—®è§†çª—ï¼š*



![*SFAuthenticationSession è¯¢é—®è§†çª—*](/assets/b08ef940c196/1*eisreftWPWn9PTCbuLQqdw.jpeg)



*SFAuthenticationSession è¯¢é—®è§†çª—*



> *è¿˜æœ‰å°±æ˜¯ APPå®¡æŸ¥æ˜¯ä¸å…è®¸å°†SFSafariViewControlleræ”¾åœ¨ä½¿ç”¨è€…çœ‹ä¸åˆ°çš„åœ°æ–¹çš„ã€‚(ç”¨ç¨‹å¼è§¦å‘å† addSubview ä¸å¤ªå®¹æ˜“è¢«å‘ç°)*



### åŠ¨æ‰‹åš



å…ˆè®²ç®€å•çš„ï¼Œåªè€ƒè™‘ iOS â‰¥ 10 ä»¥ä¸Šçš„ç”¨æˆ·ï¼Œå•çº¯ä½¿ç”¨ iPhone å‰ªè´´ç°¿è½¬ä¼ èµ„è®¯ã€‚



#### Web ç«¯ï¼š



![](/assets/b08ef940c196/1*P2saSHeIX7TZyCQY0StN1Q.jpeg)



æˆ‘ä»¬ä»¿é€  Firebase Dynamic Links å®¢åˆ¶åŒ–åˆ»äº†è‡ªå·±çš„é¡µé¢ï¼Œä½¿ç”¨ `clipboard.js` è¿™ä¸ªå¥—ä»¶è®©ä½¿ç”¨è€…ç‚¹å‡»ã€Œç«‹å³å‰å¾€ã€æ—¶å…ˆå°†æˆ‘ä»¬è¦å¸¦ç»™ APP çš„èµ„è®¯å¤åˆ¶åˆ°å‰ªè´´ç°¿ `ï¼ˆmarry://topicID=1&type=topicï¼‰` ï¼Œç„¶åå†ä½¿ç”¨ `location.href` è·³è½¬åˆ° APP Store å•†åŸé¡µã€‚



#### APP ç«¯ï¼š



åœ¨ AppDelegate æˆ– ä¸»é¡µ UIViewController ä¸­è¯»å–å‰ªè´´ç°¿çš„å€¼ï¼š



`let pasteData = UIPasteboard.general.string`



è¿™è¾¹å»ºè®®è¿˜æ˜¯å°†èµ„è®¯ä½¿ç”¨ URL Scheme æ–¹å¼åŒ…è£…ï¼Œæ–¹ä¾¿è¿›è¡Œè¾¨è¯†ã€èµ„æ–™åè§£ï¼š



```swift
if let pasteData = UIPasteboard.general.string,let url = URL(string: pasteData),url.scheme == "marry",let params = url.queryParameters {
    if params["type"] == "topic" {
      let VC = TopicViewController(topicID:params["id"])
      UIApplication.shared.keyWindow?.rootViewController?.present(VC,animated: true)
    }
}
```



æœ€ååœ¨å¤„ç†å®ŒåŠ¨ä½œåä½¿ç”¨ `UIPasteboard.general.string = â€œâ€` å°†å‰ªè´´ç°¿ä¸­çš„èµ„è®¯æ¸…é™¤ã€‚



### åŠ¨æ‰‹åš â€” æ”¯æ´ iOS 9 ç‰ˆæœ¬



éº»çƒ¦çš„æ¥äº†ï¼Œæ”¯æ´ iOS 9 ç‰ˆï¼Œå‰æ–‡æœ‰è¯´ç”±äºä¸æ”¯æ´å‰ªè´´ç°¿ï¼Œè¦ä½¿ç”¨ **Cookie äº’é€šå¤§æ³•** ã€‚



#### Web ç«¯ï¼š



web ç«¯ä¹Ÿç®—å¥½å¤„ç†ï¼Œå°±æ˜¯æ”¹æˆä½¿ç”¨è€…ç‚¹å‡»ã€Œç«‹å³å‰å¾€ã€æ—¶å°†æˆ‘ä»¬è¦å¸¦ç»™ APP çš„èµ„è®¯å­˜åˆ° Cookie `ï¼ˆmarry://topicID=1&type=topicï¼‰` ï¼Œç„¶åå†ä½¿ç”¨ `location.href` è·³è½¬åˆ° APP Store å•†åŸé¡µã€‚



è¿™é‡Œæä¾›ä¸¤ä¸ªå°è£…å¥½çš„ JavaScript å¤„ç† Cookie çš„æ–¹æ³•ï¼ŒåŠ é€Ÿå¼€å‘ï¼š



```javascript
/// name: Cookie åç§°
/// val: Cookie å€¼
/// day: Cookie æœ‰æ•ˆæœŸé™ï¼Œé¢„è®¾ï¼‘å¤©
/// EX1: setcookie("iosDeepLinkData","marry://topicID=1&type=topic")
/// EX2: setcookie("hey","hi",365) = ä¸€å¹´æœ‰æ•ˆ
function setcookie(name, val, day) {
    var exdate = new Date();
    day = day \\|\\| 1;
    exdate.setDate(exdate.getDate() + day);
    document.cookie = "" + name + "=" + val + ";expires=" + exdate.toGMTString();
}

/// getCookie("iosDeepLinkData") => marry://topicID=1&type=topic
function getCookie(name) {
    var arr = document.cookie.match(new RegExp("(^\\| )" + name + "=([^;]*)(;\\|$)"));
    if (arr != null) return decodeURI(arr[2]);
    return null;
}
```



#### APP ç«¯ï¼š



æœ¬æ–‡æœ€éº»çƒ¦çš„åœ°æ–¹æ¥äº†ã€‚



å‰æ–‡æœ‰æåˆ°åŸç†ï¼Œæˆ‘ä»¬è¦åœ¨ä¸»é¡µçš„UIViewControllerç”¨ç¨‹å¼å·å·åŠ è½½ä¸€ä¸ªSFSafariViewController åœ¨èƒŒæ™¯ä¸è®©ä½¿ç”¨è€…å¯Ÿè§‰ã€‚



**å†è¯´ä¸ªå‘ï¼š** å·å·åŠ è½½è¿™ä»¶äº‹ï¼ŒiOS â‰¥ 10 SFSafariViewController çš„ Viewå¦‚æœå¤§å°è®¾å®šå°äº1ã€é€æ˜åº¦å°äº0.05ã€è®¾æˆ isHiddenï¼ŒSFSafariViewController å°± **ä¸ä¼šè½½å…¥** ã€‚



> p.s iOS = 10 åŒæ—¶æ”¯æ´ Cookie åŠ å‰ªè´´ç°¿ã€‚



![<https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788>{:target="_blank"}](/assets/b08ef940c196/1*ab-6ppwHU72AsKKLYBitbw.png)



<https://stackoverflow.com/questions/39019352/ios10-sfsafariviewcontroller-not-working-when-alpha-is-set-to-0/39216788>{:target="_blank"}



æˆ‘è¿™è¾¹çš„åšæ³•æ˜¯åœ¨ ä¸»é¡µçš„UIViewController ä¸Šæ–¹æ”¾ä¸€ä¸ª UIView éšä¾¿ç»™ä¸ªé«˜åº¦ï¼Œä½†åº•éƒ¨å¯¹é½ ä¸»é¡µé¢ UIView ä¸Šæ–¹ï¼Œç„¶åæ‹‰ IBOutlet `ï¼ˆsharedCookieViewï¼‰` åˆ° Classï¼›åœ¨ viewDidLoad( ) æ—¶ init SFSafariViewController å¹¶å°†å…¶ View åŠ å…¥åˆ° `sharedCookieView` ä¸Šï¼Œæ‰€ä»¥ä»–å®é™…æœ‰æ˜¾ç¤ºæœ‰è½½å…¥ï¼Œåªæ˜¯è·‘å‡ºç”»é¢äº†ï¼Œä½¿ç”¨è€…çœ‹ä¸åˆ°ğŸŒã€‚



**SFSafariViewController çš„ URL è¯¥æŒ‡å‘ï¼Ÿ**



åŒ Web ç«¯åˆ†äº«é¡µé¢ï¼Œæˆ‘ä»¬è¦å†åˆ»ä¸€ä¸ª For è¯»å– Cookie çš„é¡µé¢ï¼Œå¹¶å°†ä¸¤ä¸ªé¡µé¢æ”¾åœ¨åŒä¸ªç½‘åŸŸä¹‹ä¸‹é¿å…è·¨ç½‘åŸŸCookieé—®é¢˜ï¼Œé¡µé¢å†…å®¹ç¨åé™„ä¸Šã€‚



```swift
@IBOutlet weak var SharedCookieView: UIView!

override func viewDidLoad() {
    super.viewDidLoad()
    
    let url = URL(string:"http://app.marry.com.tw/loadCookie.html")
    let sharedCookieViewController = SFSafariViewController(url: url)
    VC.view.frame = CGRect(x: 0, y: 0, width: 200, height: 200)
    sharedCookieViewController.delegate = self
    
    self.addChildViewController(sharedCookieViewController)
    self.SharedCookieView.addSubview(sharedCookieViewController.view)
    
    sharedCookieViewController.beginAppearanceTransition(true, animated: false)
    sharedCookieViewController.didMove(toParentViewController: self)
    sharedCookieViewController.endAppearanceTransition()
}
```



`sharedCookieViewController.delegate = self`



`class HomeViewController: UIViewController, SFSafariViewControllerDelegate`



éœ€è¦åŠ ä¸Šè¿™ä¸ª Delegate æ‰èƒ½æ•è·è½½å…¥å®Œæˆåçš„ CallBack å¤„ç†ã€‚



æˆ‘ä»¬å¯ä»¥åœ¨ï¼š



`func safariViewController(_ controller: SFSafariViewController, didCompleteInitialLoad didLoadSuccessfully: Bool) {`



æ–¹æ³•ä¸­æ•è·è½½å…¥å®Œæˆäº‹ä»¶ã€‚



åˆ°è¿™æ­¥ï¼Œä½ å¯èƒ½ä¼šæƒ³å†æ¥å°±æ˜¯åœ¨ `didCompleteInitialLoad` ä¸­è¯»å– ç½‘é¡µå†…çš„ Cookie å°±å®Œæˆäº†ï¼



åœ¨è¿™é‡Œæˆ‘æ²¡æ‰¾åˆ°è¯»å– SFSafariViewController Cookie çš„æ–¹æ³•ï¼Œä½¿ç”¨ç½‘è·¯çš„æ–¹æ³•è¯»å‡ºæ¥éƒ½æ˜¯ç©ºçš„ã€‚



> *æˆ–å¯èƒ½è¦ä½¿ç”¨ JavaScript ä¸é¡µé¢å†…å®¹è¿›è¡Œäº¤äº’ï¼Œå« JavaScript è¯» Cookie å›ä¼ ç»™ UIViewControllerã€‚*



#### Tricky çš„ URL Scheme æ³•



æ—¢ç„¶ iOS ä¸çŸ¥åˆ°å¦‚ä½•å–å¾—å…±äº«çš„ Cookieï¼Œé‚£æˆ‘ä»¬å°±ç›´æ¥äº¤ç”±ã€Œè¯»å– Cookie çš„é¡µé¢ã€å»å¸®æˆ‘ä»¬ã€Œè¯»å– Cookieã€ã€‚



å‰æ–‡é™„ä¸Šçš„ JavaScript å¤„ç† Cookie çš„æ–¹æ³•ä¸­çš„ getCookie( ) å°±æ˜¯ç”¨åœ¨è¿™ï¼Œæˆ‘ä»¬çš„ã€Œè¯»å– Cookie çš„é¡µé¢ã€å†…å®¹æ˜¯ä¸ªç©ºç™½é¡µ(åæ­£ä½¿ç”¨è€…çœ‹ä¸åˆ°)ï¼Œä½†æ˜¯åœ¨ JavaScript éƒ¨åˆ†è¦åœ¨ body onload ä¹‹åå»è¯»å– Cookieï¼š



```xml
<html>
<head>
  <title>Load iOS Deep Link Saved Cookie...</title>
  <script>
  function checkCookie() {
    var iOSDeepLinkData = getCookie("iOSDeepLinkData");
    if (iOSDeepLinkData && iOSDeepLinkData != '') {
        setcookie("iOSDeepLinkData", "", -1);
        window.location.href = iOSDeepLinkData; /// marry://topicID=1&type=topic
    }
  }
  </script>
</head>

<body onload="checkCookie();">

</body>

</html>
```



å®é™…çš„åŸç†æ€»ç»“å°±æ˜¯ï¼šåœ¨ `HomeViewController viewDidLoad` æ—¶åŠ å…¥ `SFSafariViewController` å·åŠ è½½ `loadCookie.html` é¡µé¢ï¼Œ `loadCookie.html` é¡µé¢è¯»å–æ£€æŸ¥å…ˆå‰å­˜çš„ Cookieï¼Œè‹¥æœ‰åˆ™è¯»å‡ºæ¸…é™¤ï¼Œç„¶åä½¿ç”¨ `window.location.href` å‘¼å«ï¼Œè§¦å‘ `URL Scheme` æœºåˆ¶ã€‚



æ‰€ä»¥ä¹‹åå¯¹åº”çš„ CallBack å¤„ç†å°±ä¼šå›åˆ° `AppDelegate` ä¸­çš„ `func application(_ application: UIApplication, open url: URL, sourceApplication: String?, annotation: Any) -> Bool` è¿›è¡Œå¤„ç†ã€‚



### å®Œå·¥ï¼æ€»ç»“ï¼š



![](/assets/b08ef940c196/1*kp26TdlJBW5sVxw4zYa9Rg.jpeg)



å¦‚æœè§‰å¾—çƒ¦çï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ [branch.io](http://branch.io){:target="_blank"} æˆ– [Firebase Dynamic](https://firebase.google.com/docs/dynamic-links){:target="_blank"} æ²¡å¿…è¦é‡é€ è½®å­ï¼Œè¿™è¾¹æ˜¯å› ä¸ºä»‹é¢å®¢åˆ¶åŒ–åŠä¸€äº›å¤æ‚éœ€æ±‚ï¼Œåªå¥½è‡ªå·±æ‰“é€ ã€‚



iOS=9 çš„ç”¨æˆ·å·²ç»éå¸¸ç¨€å°‘ï¼Œä¸æ˜¯å¾ˆå¿…è¦çš„è¯å¯ä»¥ç›´æ¥å¿½ç•¥ï¼›ä½¿ç”¨å‰ªè´´ç°¿çš„æ–¹æ³•å¿«åˆæœ‰æ•ˆç‡ï¼Œè€Œä¸”ç”¨å‰ªè´´ç°¿å°±ä¸ç”¨å±€é™è¿ç»“ä¸€å®šè¦ç”¨ Safari å¼€å¯ï¼



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/ios-deferred-deep-link-%E5%BB%B6%E9%81%B2%E6%B7%B1%E5%BA%A6%E9%80%A3%E7%B5%90%E5%AF%A6%E4%BD%9C-swift-b08ef940c196){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*