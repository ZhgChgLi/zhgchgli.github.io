---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2018-10-15T15:44:01.193+0000
description: å›¾ç‰‡æ¨æ’­ã€æ¨æ’­æ˜¾ç¤ºç»Ÿè®¡ã€æ¨æ’­æ˜¾ç¤ºå‰å¤„ç†
image:
  path: /assets/cb6eba52a342/1*8juoKO7BZiT3PQjqufWcrA.jpeg
last_modified_at: 2024-04-13T07:13:08.836+0000
render_with_liquid: false
tags:
- swift
- push-notification
- notificationservice
- ios
- ios-app-development
title: iOS â‰¥ 10 Notification Service Extension åº”ç”¨ (Swift)
---

### iOS â‰¥ 10 Notification Service Extension åº”ç”¨ (Swift)



å›¾ç‰‡æ¨æ’­ã€æ¨æ’­æ˜¾ç¤ºç»Ÿè®¡ã€æ¨æ’­æ˜¾ç¤ºå‰å¤„ç†



å…³äºåŸºç¡€çš„æ¨æ’­å»ºç½®ã€æ¨æ’­åŸç†ï¼›ç½‘è·¯èµ„æ–™å¾ˆå¤šï¼Œè¿™è¾¹å°±ä¸å†è®ºè¿°ï¼Œæœ¬ç¯‡ä¸»è¦é‡ç‚¹åœ¨å¦‚ä½•è®©APPæ”¯æ´å›¾ç‰‡æ¨æ’­åŠè¿ç”¨æ–°ç‰¹æ€§è¾¾æˆæ›´ç²¾å‡†çš„æ¨æ’­æ˜¾ç¤ºç»Ÿè®¡ï¼



![](/assets/cb6eba52a342/1*8juoKO7BZiT3PQjqufWcrA.jpeg)



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒNotification Service Extensionè®©ä½ åœ¨APPæ”¶åˆ°æ¨æ’­åèƒ½é’ˆå¯¹æ¨æ’­åšé¢„å¤„ç†ï¼Œç„¶åæ‰æ˜¾ç¤ºæ¨æ’­å†…å®¹



å®˜æ–¹æ–‡ä»¶å†™åˆ°ï¼Œæˆ‘ä»¬é’ˆå¯¹æ¨æ’­è¿›æ¥çš„å†…å®¹åšå¤„ç†æ—¶ï¼Œå¤„ç†æ—¶é™å¤§çº¦30ç§’é’Ÿï¼Œå¦‚æœè¶…è¿‡30ç§’è¿˜æ²¡CallBackï¼Œæ¨æ’­å°±ä¼šç»§ç»­æ‰§è¡Œï¼Œå‡ºç°åœ¨ä½¿ç”¨è€…çš„æ‰‹æœºï¼



#### æ”¯æ´åº¦



iOS â‰¥ 10.0



#### 30ç§’å¯ä»¥å¹²å˜›ï¼Ÿ



- (ç›®æ ‡1) ä»æ¨æ’­å†…å®¹çš„å›¾ç‰‡è¿ç»“æ ä½ä¸‹è½½å›¾ç‰‡å›æ¥ï¼Œå¹¶é™„åŠ åˆ°æ¨æ’­å†…å®¹ä¸ŠğŸ†



![](/assets/cb6eba52a342/1*dd2kRizi6v-AIXcMWourow.png)



- (ç›®æ ‡2) ç»Ÿè®¡æ¨æ’­æœ‰æ— æ˜¾ç¤ºğŸ†


- æ¨æ’­å†…å®¹ä¿®æ”¹ã€é‡ç»„å†…å®¹


- æ¨æ’­å†…å®¹åŠ è§£å¯†(è§£å¯†)æ˜¾ç¤º


- *å†³å®šæ¨æ’­è¦ä¸è¦æ˜¾ç¤ºï¼Ÿ* =&gt;&gt; **ç­”æ¡ˆï¼šä¸è¡Œ**



#### é¦–å…ˆï¼Œåç«¯æ¨æ’­ç¨‹å¼çš„ Payload éƒ¨åˆ†



åç«¯åœ¨æ¨æ’­æ—¶çš„ç»“æ„è¦å¤šåŠ ä¸Šä¸€è¡Œ `â€œmutable-content":1` ç³»ç»Ÿæ”¶åˆ°æ¨æ’­æ‰ä¼šæ‰§è¡ŒNotification Service Extension



```json
{
    "aps": {
        "alert": {
            "title": "æ–°æ–‡ç« æ¨èç»™æ‚¨",
            "body": "ç«‹å³æŸ¥çœ‹"
        },
        "mutable-content":1,
        "sound": "default",
        "badge": 0
    }
}
```



#### Andâ€¦ ç¬¬ä¸€æ­¥ï¼Œä¸ºä¸“æ¡ˆæ–°å»ºä¸€ä¸ªTarget



![**Step 1.** Xcode -&gt; File -&gt; New -&gt; Target](/assets/cb6eba52a342/1*ZjPVTxLR6ywAdk70Y7_J7A.png)



**Step 1.** Xcode -&gt; File -&gt; New -&gt; Target



![**Step 2.** iOS -&gt; Notification Service Extension -&gt; Next](/assets/cb6eba52a342/1*2KRusR8MJUim7UH1CmS7pw.png)



**Step 2.** iOS -&gt; Notification Service Extension -&gt; Next



![**Step 3.** è¾“å…¥Product Name -&gt; Finish](/assets/cb6eba52a342/1*sAuzxJPpohTGp-KV13yupg.png)



**Step 3.** è¾“å…¥Product Name -&gt; Finish



![**Step 4.** ç‚¹é€‰ Activate](/assets/cb6eba52a342/1*3DF_fMQLSrGxTbmLY6CJAg.png)



**Step 4.** ç‚¹é€‰ Activate



**ç¬¬äºŒæ­¥ï¼Œæ’°å†™æ¨æ’­å†…å®¹å¤„ç†ç¨‹å¼**



![æ‰¾åˆ°Product Name/NotificationService.swiftæ¡£](/assets/cb6eba52a342/1*UsCd2btDPK6GWKrYEA9LbQ.png)



æ‰¾åˆ°Product Name/NotificationService.swiftæ¡£



```swift
import UserNotifications

class NotificationService: UNNotificationServiceExtension {

    var contentHandler: ((UNNotificationContent) -> Void)?
    var bestAttemptContent: UNMutableNotificationContent?

    override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
        self.contentHandler = contentHandler
        bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
        
        if let bestAttemptContent = bestAttemptContent {
            // Modify the notification content here...
            // æ¨æ’­å†…å®¹åœ¨è¿™å¤„ç†ï¼ŒLoad å›¾ç‰‡å›æ¥
            bestAttemptContent.title = "\(bestAttemptContent.title) [modified]"
            
            contentHandler(bestAttemptContent)
        }
    }
    
    override func serviceExtensionTimeWillExpire() {
        // Called just before the extension will be terminated by the system.
        // Use this as an opportunity to deliver your "best attempt" at modified content, otherwise the original push payload will be used.
        // è¦é€¾æ—¶äº†ï¼Œä¸ç®¡å›¾ç‰‡ åªæ”¹æ ‡é¢˜å†…å®¹å°±å¥½
        if let contentHandler = contentHandler, let bestAttemptContent =  bestAttemptContent {
            contentHandler(bestAttemptContent)
        }
    }

}
```



å¦‚ä¸Šç¨‹å¼ç ï¼ŒNotificationServiceæœ‰ä¸¤ä¸ªæ¥å£ï¼›ç¬¬ä¸€ä¸ªæ˜¯ `didReceive` å½“æœ‰æ¨æ’­è¿›æ¥æ—¶ä¼šè§¦å‘è¿™ä¸ªfunctionï¼Œå…¶ä¸­å½“å¤„ç†å®Œæ¯•åéœ€è¦å‘¼å« `contentHandler(bestAttemptContent)` è¿™ä¸ªCallBack Methodå‘ŠçŸ¥ç³»ç»Ÿ



å¦‚æœæ—¶é—´è¿‡ä¹…éƒ½æ²¡å‘¼å«CallBack Methodï¼Œå°±ä¼šè§¦å‘ç¬¬äºŒä¸ª function `serviceExtensionTimeWillExpire()` å·²é€¾æ—¶ï¼ŒåŸºæœ¬ä¸Šå·²å›å¤©ä¹æœ¯ï¼Œåªèƒ½åšä¸€äº›æ”¶å°¾çš„åŠ¨ä½œ(ä¾‹å¦‚ï¼šå•çº¯æ”¹æ”¹æ ‡é¢˜ã€å†…å®¹ï¼Œä¸Loadç½‘è·¯èµ„æ–™äº†)



#### å®æˆ˜èŒƒä¾‹



è¿™é‡Œå‡è®¾æˆ‘ä»¬çš„ Payload å¦‚ä¸‹



```json
{
    "aps": {
        "alert": {
            "push_id":"2018001",
            "title": "æ–°æ–‡ç« æ¨èç»™æ‚¨",
            "body": "ç«‹å³æŸ¥çœ‹",
            "image": "https://d2uju15hmm6f78.cloudfront.net/image/2016/12/04/3113/2018/09/28/trim_153813426461775700_450x300.jpg"
        },
        "mutable-content":1,
        "sound": "default",
        "badge": 0
    }
}
```



ã€Œpush_idã€è·Ÿã€Œimageã€éƒ½æ˜¯æˆ‘è‡ªè®¢çš„æ ä½ï¼Œpush_idç”¨äºè¾¨è¯†æ¨æ’­æ–¹ä¾¿æˆ‘ä»¬ä¼ å›ä¼ºæœå™¨åšç»Ÿè®¡ï¼›image åˆ™æ˜¯æ¨æ’­è¦é™„åŠ çš„å›¾ç‰‡å†…å®¹ä¹‹å›¾ç‰‡ç½‘å€



```swift
override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
    self.contentHandler = contentHandler
    bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
    
    if let bestAttemptContent = bestAttemptContent {
        
        guard let info = request.content.userInfo["aps"] as? NSDictionary,let alert = info["alert"] as? Dictionary<String,String> else {
            contentHandler(bestAttemptContent)
            return
            //æ¨æ’­å†…å®¹æ ¼å¼ä¸å¦‚é¢„æœŸï¼Œä¸å¤„ç†
        }
        
        //ç›®æ ‡2:
        //å›ä¼ Serverï¼Œå‘ŠçŸ¥æ¨æ’­æœ‰æ˜¾ç¤º
        if let push_id = alert["push_id"],let url = URL(string: "æ˜¾ç¤ºç»Ÿè®¡APIç½‘å€") {
            var request = URLRequest(url: url, cachePolicy: .reloadIgnoringLocalCacheData, timeoutInterval: 30)
            request.httpMethod = "POST"
            request.addValue(UserAgent, forHTTPHeaderField: "User-Agent")
            
            var httpBody = "push_id=\(push_id)"
            request.addValue("application/x-www-form-urlencoded", forHTTPHeaderField: "Content-Type")
            request.httpBody = httpBody.data(using: .utf8)
            
            let task = URLSession.shared.dataTask(with: request) { (data, response, error) in
                
            }
            DispatchQueue.global().async {
                task.resume()
                //å¼‚æ­¥å¤„ç†ï¼Œä¸ç®¡ä»–
            }
        }
        
        //ç›®æ ‡1:
        guard let imageURLString = alert["image"],let imageURL = URL(string: imageURLString) else {
            contentHandler(bestAttemptContent)
            return
            //è‹¥æ— é™„å›¾ç‰‡ï¼Œåˆ™ä¸ç”¨ç‰¹åˆ«å¤„ç†
        }
        
        
        let dataTask = URLSession.shared.dataTask(with: imageURL) { (data, response, error) in
            guard let fileURL = NSURL(fileURLWithPath: NSTemporaryDirectory()).appendingPathComponent(imageURL.lastPathComponent) else {
                contentHandler(bestAttemptContent)
                return
            }
            guard (try? data?.write(to: fileURL)) != nil else {
                contentHandler(bestAttemptContent)
                return
            }
            
            guard let attachment = try? UNNotificationAttachment(identifier: "image", url: fileURL, options: nil) else {
                contentHandler(bestAttemptContent)
                return
            }
            //ä»¥ä¸Šä¸ºè¯»å–å›¾ç‰‡è¿ç»“å¹¶ä¸‹è½½åˆ°æ‰‹æœºå¹¶æ”¾å…¥å»ºç«‹UNNotificationAttachment
            
            bestAttemptContent.categoryIdentifier = "image"
            bestAttemptContent.attachments = [attachment]
            //ä¸ºæ¨æ’­æ·»åŠ é™„ä»¶å›¾ç‰‡
            
            bestAttemptContent.body = (bestAttemptContent.body == "") ? ("ç«‹å³æŸ¥çœ‹") : (bestAttemptContent.body)
            //å¦‚æœbodyä¸ºç©ºï¼Œåˆ™ç”¨é¢„è®¾å†…å®¹"ç«‹å³æŸ¥çœ‹"
            
            contentHandler(bestAttemptContent)
        }
        dataTask.resume()
    }
}
```



`serviceExtensionTimeWillExpire` çš„éƒ¨åˆ†æˆ‘æ²¡ç‰¹åˆ«å¤„ç†ä»€ä¹ˆï¼Œå°±ä¸è´´äº†ï¼›å…³é”®è¿˜æ˜¯ä¸Šè¿° `didReceive` çš„ç¨‹å¼ç 



å¯ä»¥çœ‹åˆ°å½“æ¥å—åˆ°æœ‰æ¨æ’­é€šçŸ¥æ—¶ï¼Œæˆ‘ä»¬å…ˆCall Apiå‘Šè¯‰åç«¯æœ‰æ”¶åˆ°å¹¶å°†æ˜¾ç¤ºæ¨æ’­äº†ï¼Œæ–¹ä¾¿æˆ‘ä»¬åå°åšæ¨æ’­ç»Ÿè®¡ï¼›ç„¶åè‹¥æœ‰é™„åŠ å›¾ç‰‡å†å¯¹å›¾ç‰‡è¿›è¡Œå¤„ç†ï¼



#### In-AppçŠ¶æ€æ—¶ï¼š



ã„§æ ·ä¼šè§¦å‘Notification Service Extension didReceive å†è§¦å‘AppDelegateçš„ **func** application( **_** application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable : **Any** ], fetchCompletionHandler completionHandler: **@escaping** (UIBackgroundFetchResult) -&gt; Void) æ–¹æ³•



#### é™„æ³¨ï¼šå…³äºå›¾ç‰‡æ¨æ’­çš„éƒ¨åˆ†ä½ è¿˜å¯ä»¥â€¦.



ä½¿ç”¨ Notification Content Extension è‡ªè®¢æ¨æ’­æŒ‰å‹æ—¶è¦æ˜¾ç¤ºçš„UIView(å¯ä»¥è‡ªå·±åˆ»)ï¼Œè¿˜æœ‰æŒ‰å‹çš„åŠ¨ä½œ



å¯å‚è€ƒè¿™ç¯‡ï¼š [iOS10æ¨é€é€šçŸ¥è¿›é˜¶(Notification Extensionï¼‰](https://www.jianshu.com/p/78ef7bc04655#UNNotificationContentExtension-%E9%80%9A%E7%9F%A5%E5%86%85%E5%AE%B9%E6%89%A9%E5%B1%95){:target="_blank"}



iOS 12ä¹‹åæ”¯æ´æ›´å¤šåŠ¨ä½œå¤„ç†ï¼š [iOS 12 æ–°é€šçŸ¥åŠŸèƒ½ï¼šæ·»åŠ äº’åŠ¨æ€§ åœ¨é€šçŸ¥ä¸­å®ä½œå¤æ‚åŠŸèƒ½](https://www.appcoda.com.tw/user-notifications-ios12/){:target="_blank"}



Notification Content Extensionçš„éƒ¨åˆ†ï¼Œæˆ‘åªæ‹‰äº†ä¸€ä¸ªèƒ½å±•ç¤ºå›¾ç‰‡æ¨æ’­çš„UIView å¹¶æ²¡æœ‰åšå¤ªå¤šç¢ç£¨ï¼š



![[ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/cb6eba52a342/1*SepeUiS7CN7xmGFxariPjA.png)



[ç»“å©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/ios-10-notification-service-extension-%E6%87%89%E7%94%A8-swift-cb6eba52a342){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*