---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2021-08-07T12:19:49.920+0000
description: 使用 Gmail Filter + Google Apps Script 在收到信件时自动将客制化内容转寄至 Slack Channel
image:
  path: /assets/d414bdbdb8c9/1*U6CDgIAMt2l2vDoFqhwv6A.jpeg
last_modified_at: 2024-04-14T01:54:47.696+0000
render_with_liquid: false
tags:
- ios-app-development
- google-apps-script
- cicd
- slack
- workflow-automation
title: 运用 Google Apps Script 转发 Gmail 信件到 Slack
---

### 运用 Google Apps Script 转发 Gmail 信件到 Slack



使用 Gmail Filter + Google Apps Script 在收到信件时自动将客制化内容转寄至 Slack Channel



![Photo by [Lukas Blazek](https://unsplash.com/@goumbik?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/d414bdbdb8c9/1*U6CDgIAMt2l2vDoFqhwv6A.jpeg)



Photo by [Lukas Blazek](https://unsplash.com/@goumbik?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}



### 起源



最近在优化 iOS App CI/CD 的流程，使用 Fastlane 作为自动化工具；打包上传后如果要继续完成自动送审步骤 ( `skip_submission=false` )，就需要等苹果完成 Process 大概需要浪费 30~40 mins 的 CI Server 时间，因为苹果 App Store Connect API 并不完善，Fastlane 也只能每分钟去检查一次上传的 Build 是否处理完成，非常浪费资源。



![](/assets/d414bdbdb8c9/1*JXuVoKM-gGJwfvF7tXY1nQ.png)



- **Bitrise CI Server：** 限制同时 Builds 数量及最大执行时间 90 mins，90 mins 是够，但会卡著一条 Build 阻碍其他人执行。


- **Travis CI Server：** 依照 Build Time 收费，这样更不能等了，钱直接打水漂。



#### 换个思路



不等了，上传完直接结束！靠处理完成的信件通知触发后续动作。



![](/assets/d414bdbdb8c9/1*57FOYivs5toW2aipgRVCeg.jpeg)



> ***不过最近我都没收到这封信了，不知道是设定问题还是苹果不再发此类通知。***



本文将以 Testflight 已经可以开始测试的信件通知为例。



![](/assets/d414bdbdb8c9/1*2fmqWCAMiM2UeuGss7VzzA.jpeg)



![](/assets/d414bdbdb8c9/1*sndRqvnELhCshb6yyPFhqg.jpeg)



> *完整流程如上图所示，原理上可行；但不是本文要讨论的重点，本文将著重在收到信件、使用 Apps Script 转发至 Slack Channel 部分。*



### 如何转发收到的 Email 到 Slack Channel



不管是付费或是免费的 Slack 专案都能使用不同方法达成 Email 转发到 Slack Channel or DM 功能。



可参考官方文件进行设置： [传送电子邮件至 Slack](https://slack.com/intl/zh-tw/help/articles/206819278-%E5%82%B3%E9%80%81%E9%9B%BB%E5%AD%90%E9%83%B5%E4%BB%B6%E8%87%B3-Slack){:target="_blank"}



**不管哪种方法效果都如下：**



![](/assets/d414bdbdb8c9/1*qdoLTotLTaeZPsEHaJ8C7Q.jpeg)



> *预设折叠信件内容，点击后可以展开查看全部内容。*



**优点：**



1. 简单快速


2. 零技术门槛


3. 即时转送



**缺点：**



1. 无法对内容进行客制


2. 显示样式无法更改



### 客制转发内容



就是本篇要介绍的重点。



![](/assets/d414bdbdb8c9/1*w4E7wf-Kf8XVFxowmDopIw.png)



将信件内容资料转译成自己想呈现的样式，如上图范例。



#### 先上一张完整运作流程图：



![](/assets/d414bdbdb8c9/1*yB5s_5rBr4l6hid21huJMQ.jpeg)



- 使用 Gmail Filter 对要转发信件加上辨识 Label


- Apps Script 定时获取被标记成该 Label 的信件


- 读取信件内容


- 渲然成想要的显示样式


- 透过 Slack Bot API 或直接用 Incoming Message 发送讯息到 Slack


- 移除信件 Label (代表已转发)


- 完成



#### 首先，要在 Gmail 中建立筛选器



筛选器可以在收到符合条件信件时自动化做一些事，例如：自动标记已读、自动标记 Tag、自动移入垃圾邮件、自动归入分类…等等操作



![](/assets/d414bdbdb8c9/1*qNXxtTLzEnlArl4UTTWQMw.jpeg)



在 Gmail 点击右上进阶搜寻图标按钮，输入要转发的信件规则条件，例如来自： `no_reply@email.apple.com` + 主题是 `is now available to test.` ，点击「Search」查看筛选结果是否如预期；如果正确可以点击 Search 旁的「Create filter」按钮。



![或直接在信件里上方点 Filter message like these 就能快速建立筛选条件](/assets/d414bdbdb8c9/1*i7grToZwE_ixwJTEjI9qtw.jpeg)



或直接在信件里上方点 Filter message like these 就能快速建立筛选条件



![](/assets/d414bdbdb8c9/1*n_nbqgIlE-E1eaW5QfqkWg.jpeg)



> 这按钮设计很反人类，第一次找一直没看到。



![](/assets/d414bdbdb8c9/1*6zlooS-cMr5LEVX2TW5I_w.jpeg)



下一步设定符合此筛选条件是的动作，这边我们选「Apply the label」建立一个独立新辨识用 Label 「forward-to-slack」，点击「Create filter」完成。



尔后被标上这个 Label 的信都会被转发到 Slack。



### 取得 Incoming WebHooks App URL



首先我们要加入 Incoming WebHooks App 到 Slack Channel，我们会透过此媒介来传送讯息。



![](/assets/d414bdbdb8c9/1*AgGLiLsyvenK-LRWI9rlKg.png)



1. Slack 左下角「Apps」-&gt;「Add apps」


2. 右边搜寻匡搜寻「incoming」


3. 点击「Incoming WebHooks」-&gt;「Add」



![](/assets/d414bdbdb8c9/1*DUcwdLTKt33Fa-jNlW8MkA.png)



![](/assets/d414bdbdb8c9/1*v8Z-5vEM043F82TMiZk2lw.png)



选择讯息想要传到的 Channel。



![](/assets/d414bdbdb8c9/1*SRciom_ygU0JDKK9ATY1FQ.png)



记下最上方的「Webhook URL」



![](/assets/d414bdbdb8c9/1*kp1QDIEwzQtmfzUwZIDTSg.png)



往下滑可设定传送讯息时，传送 Bot 显示的名称及大头贴；改完记得按「Save Settings」。



> ***备注***



> *请注意官方建议使用新的 Slack APP Bot API 的 [chat.postMessage](https://api.slack.com/methods/chat.postMessage){:target="_blank"} 来传送讯息，Incoming Webhook 简便的这个方式之后会弃用，这边偷懒没有使用，可搭配下一章「汇入员工名单」会需要 Slack App API 一起调整成新方法。*



![](/assets/d414bdbdb8c9/1*QfgJL_Xb9JhgQnPGjU2CXg.png)



### 撰写 Apps Script 程式



- [点此前往我的 Apps Script 专案](https://script.google.com/home/my){:target="_blank"}


- 点选左上「新专案」


- 建立后，可点击专案名称重新命名 EX: ForwardEmailsToSlack



贴上以下基本程式并修改成你想要的版本：



```javascript
function sendMessageToSlack(content) {
    var payload = {
      "text": "*您收到一封信件*",
      "attachments": [{
          "pretext": "信件内容如下:",
          "text": content,
        }
      ]
    };
    var res = UrlFetchApp.fetch('贴上你的Slack incoming Webhook URL',{
      method             : 'post',
      contentType        : 'application/json',
      payload            : JSON.stringify(payload)
    })
}

function forwardEmailsToSlack() {
    // 参考自：https://gist.github.com/andrewmwilson/5cab8367dc63d87d9aa5

    var label = GmailApp.getUserLabelByName('forward-to-slack');
    var messages = [];
    var threads = label.getThreads();
  
    if (threads == null) {
      return;
    }

    for (var i = 0; i < threads.length; i++) {
        messages = messages.concat(threads[i].getMessages())
    }

    for (var i = 0; i < messages.length; i++) {
        var message = messages[i];
        Logger.log(message);

        var output = '*New Email*';
        output += '\n*from:* ' + message.getFrom();
        output += '\n*to:* ' + message.getTo();
        output += '\n*cc:* ' + message.getCc();
        output += '\n*date:* ' + message.getDate();
        output += '\n*subject:* ' + message.getSubject();
        output += '\n*body:* ' + message.getPlainBody();

        sendMessageToSlack(output);
   }

   label.removeFromThreads(threads);
}
```



**进阶：**



- [Slack 讯息样式可参考这份官方结构文件](https://api.slack.com/messaging/composing/layouts){:target="_blank"} 。


- 你可以使用 Javascript 的 Regex Match Function，对信件内容进行匹配爬取。



**EX：爬取 Testflight 审核成功信件内的版本号资讯：**



信件标题：Your app XXX has been approved for beta testing.



信件内容：



![](/assets/d414bdbdb8c9/1*aZkQGA3N1cquMLt1wyDGFg.jpeg)



我们想得到 **Bundle Version Short String 还有 Build Number 后面的值** 。



```
var results = subject.match(/(Bundle Version Short String: ){1}(\S+){1}[\S\s]*(Build Number: ){1}(\S+){1}/);
if (results == null \\|\\| results.length != 5) {
  // not vaild
} else {
  var version = results[2];
  var build = results[4];
}
```



- [Regex 使用方法可参考这里](https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Guide/Regular_Expressions){:target="_blank"}


- 线上测试 Regex 是否正确可使用 [此网站](http://www.rubular.com/){:target="_blank"}



#### 执行看看



- 回到 Gmail 随便找一封信，手动帮他加上 Label — 「forward-to-slack」


- 在 Apps Script 程式码编辑器上选择「forwardEmailsToSlack」然后点击「执行」按钮



![](/assets/d414bdbdb8c9/1*JHHTQCWNUI-aNPBB6y4iAA.jpeg)



![](/assets/d414bdbdb8c9/1*ltXGtEVxkdde1qHGxy3wMw.png)



若出现 「Authorization Required」则点选「Continue」完成验证



![](/assets/d414bdbdb8c9/1*hIgRtqKEFs0tsXDxfNTaOg.png)



在身份验证的过程中会出现「Google hasn’t verified this app」这是正常的，因为我们写的 App Script 没有经过 Google 验证，不过没关系这是写给自己用的。



可点选左下角「Advanced」-&gt;「Go to ForwardEmailsToSlack (unsafe)」



![](/assets/d414bdbdb8c9/1*QUkmTD1WlEzw7cqW97ll6Q.png)



点击「Allow」



![](/assets/d414bdbdb8c9/1*TInHsY7Fwb9jHuKJkMJIsw.jpeg)



转发成功！！！



### 设置触发器(排程)自动检查＆转发



![](/assets/d414bdbdb8c9/1*2Ok6gD5E7F1uqyzgVpoJ8A.jpeg)



在 Apps Script 左方选单列，选择「触发条件」。



![](/assets/d414bdbdb8c9/1*1xb9xGGkgx6PkhWlWc7HiQ.jpeg)



左下角「+ 新增触发条件」。



![](/assets/d414bdbdb8c9/1*ujCxCH3f8HTvSOP5o4xvmA.jpeg)



- 错误通知设定：可设定当脚本执行遇到错误时，该如何通知你


- 选择您要执行的功能：选择 Main Function `sendMessageToSlack`


- 选取活动来源：可选择来自日历或是时间驱动(定时或指定)


- 选取时间型触发条件类型：可选特定日期执行或每分/时/日/周/月执行一次


- 选取分/时/日/周/月间隔：EX: 每分钟、每 15 分钟…



> *这边为了示范设定成每分钟执行一次，我觉得信件的即时程度可以设每小时检查一次就好。*



![](/assets/d414bdbdb8c9/1*LBAlTvz46NJCYgVv1DrfYQ.png)



- 再次回到 Gmail 随便找一封信，手动帮他加上 Label — 「forward-to-slack」


- 等待排程触发



自动检查＆转发成功！



### 完工



借由此功能便能达成客制化信件转发处理，甚至是再当成触发器使用，例如：收到 XXX 信时自动执行某脚本。



回到第一章起源，我们便可以使用此机制，完善 CI/CD 流程；不需要呆呆等待苹果完成处理，又能串上自动化流程！



### 延伸阅读



- [Crashlytics + Big Query 打造更即时便利的 Crash 追踪工具](../e77b80cc6f89/)


- [Crashlytics + Google Analytics 自动查询 App Crash-Free Users Rate](../793cb8f89b72/)


- [使用 Python+Google Cloud Platform+Line Bot 自动执行例行琐事](../70a1409b149a/)


- [Slack 打造全自动 WFH 员工健康状况回报系统](../d61062833c1a/)


- [APP有用HTTPS传输，但资料还是被偷了。](../46410aaada00/)



有任何问题及指教欢迎 [与我联络](https://www.zhgchg.li/contact){:target="_blank"} 。



*[Post](https://medium.com/zrealm-ios-dev/%E9%81%8B%E7%94%A8-google-apps-script-%E8%BD%89%E7%99%BC-gmail-%E4%BF%A1%E4%BB%B6%E5%88%B0-slack-d414bdbdb8c9){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*