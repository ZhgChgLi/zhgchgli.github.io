---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2022-07-15T10:10:04.867+0000
description: ç¡®ä¿ Localizable.strings æ–‡å­—æ¡£ä¸è¢«æ„å¤–æ”¹å
image:
  path: /assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg
last_modified_at: 2024-04-14T02:14:31.859+0000
render_with_liquid: false
tags:
- ios-app-development
- localization
- unit-testing
- xcode
- swift
title: iOS ä¸ºå¤šè¯­ç³»å­—ä¸²ä¹°ä»½ä¿é™©å§ï¼
---

### iOS ä¸ºå¤šè¯­ç³»å­—ä¸²ä¹°ä»½ä¿é™©å§ï¼



ä½¿ç”¨ SwifGen & UnitTest ç¡®ä¿å¤šè¯­ç³»æ“ä½œçš„å®‰å…¨



![Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg)



Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}



### é—®é¢˜



#### çº¯æ–‡å­—æ¡£æ¡ˆ



![](/assets/48a8526c1300/1*9hxfi00_HcXy0wUMIyU8gA.png)



iOS çš„å¤šè¯­ç³»å¤„ç†æ–¹å¼æ˜¯ Localizable.strings çº¯æ–‡å­—æ¡£æ¡ˆï¼Œä¸åƒ Android æ˜¯é€è¿‡ XML æ ¼å¼æ¥ç®¡ç†ï¼›æ‰€ä»¥åœ¨æ—¥å¸¸å¼€å‘ä¸Šå°±ä¼šæœ‰ä¸å°å¿ƒæŠŠè¯­ç³»æ¡£æ”¹åæˆ–æ˜¯æ¼åŠ çš„é£é™©å†åŠ ä¸Šå¤šè¯­ç³»ä¸ä¼šåœ¨ Build Time æ£€æŸ¥å‡ºé”™è¯¯ï¼Œå¾€å¾€éƒ½æ˜¯ä¸Šçº¿åï¼ŒæŸä¸ªåœ°åŒºçš„ä½¿ç”¨è€…å›æŠ¥æ‰å‘ç°é—®é¢˜ï¼Œä¼šå¤§å¤§é™ä½ä½¿ç”¨è€…ä¿¡å¿ƒç¨‹åº¦ã€‚



ä¹‹å‰è¡€æ·‹æ·‹çš„æ¡ˆä¾‹ï¼Œå¤§å®¶ Swift å†™çš„å¤ªä¹ æƒ¯å¿˜è®° Localizable.strings è¦åŠ  `;` ï¼Œå¯¼è‡´æŸä¸ªè¯­ç³»ä¸Šçº¿åä»æ¼æ‰ `;` çš„è¯­å¥å¾€åå…¨åæ‰ï¼›æœ€åç´§æ€¥ Hotfix æ‰åŒ–é™©ä¸ºå¤·ã€‚



#### **å¤šè¯­ç³»æœ‰é—®é¢˜å°±ä¼šç›´æ¥æŠŠ Key æ˜¾ç¤ºç»™ä½¿ç”¨è€…**



![](/assets/48a8526c1300/1*BwaK_5ac2gxAmrzt4w-oBA.png)



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‡è®¾ `DESCRIPTION` Key æ¼åŠ ï¼Œ Appå°±ä¼šç›´æ¥æ˜¾ç¤º `DESCRIPTION` ç»™ä½¿ç”¨è€…ã€‚



### æ£€æŸ¥éœ€æ±‚



- Localizable.strings æ ¼å¼æ­£ç¡®æ£€æŸ¥ (æ¢è¡Œç»“å°¾éœ€åŠ ä¸Š `;` ã€åˆæ³• Key Value å¯¹åº”)


- ç¨‹å¼ç ä¸­æœ‰å–ç”¨çš„å¤šè¯­ç³» Key è¦åœ¨ Localizable.strings æ¡£æœ‰å¯¹åº”å®šä¹‰


- Localizable.strings æ¡£å„ä¸ªè¯­ç³»éƒ½è¦æœ‰ç›¸åº”çš„ Key Value çºªå½•


- Localizable.strings æ¡£ä¸èƒ½æœ‰é‡å¤çš„ Key (å¦åˆ™ Value ä¼šè¢«æ„å¤–è¦†ç›–)



### è§£å†³æ–¹æ¡ˆ



#### ä½¿ç”¨ Swift æ’°å†™å®Œæ•´æ£€æŸ¥å·¥å…·



ä¹‹å‰çš„åšæ³•æ˜¯ã€Œ [Xcode ç›´æ¥ä½¿ç”¨ Swift æ’°å†™ Shell Scriptï¼](../41c49a75a743/) ã€å‚è€ƒ [Localize ğŸ](https://github.com/freshOS/Localize){:target="_blank"} å·¥å…·ä½¿ç”¨ Swift å¼€å‘ Command Line Tool ä»å¤–éƒ¨åšå¤šè¯­ç³»æ¡£æ¡ˆæ£€æŸ¥ï¼Œå†æŠŠè„šæœ¬æ”¾åˆ° Build Phases Run Script ä¸­ï¼Œåœ¨ Build Time æ‰§è¡Œæ£€æŸ¥ã€‚



**ä¼˜ç‚¹ï¼š**
æ£€æŸ¥ç¨‹å¼æ˜¯ç”±å¤–éƒ¨æ³¨å…¥ï¼Œä¸ä¾èµ–åœ¨ä¸“æ¡ˆä¸Šï¼Œå¯ä»¥ä¸é€è¿‡ XCodeã€ä¸éœ€ Build ä¸“æ¡ˆä¹Ÿèƒ½æ‰§è¡Œæ£€æŸ¥ã€æ£€æŸ¥åŠŸèƒ½èƒ½ç²¾ç¡®åˆ°å“ªä¸ªæ¡£æ¡ˆçš„ç¬¬å‡ è¡Œï¼›å¦å¤–è¿˜èƒ½åš Format åŠŸèƒ½ (æ’åºå¤šè¯­ç³» Key A-&gt;Z)ã€‚



**ç¼ºç‚¹ï¼š**
å¢åŠ  Build Time ( + ~= 3 mins)ã€æµç¨‹å‘æ•£ï¼Œè„šæœ¬æœ‰é—®é¢˜æˆ–éœ€å› åº”ä¸“æ¡ˆæ¶æ„è°ƒæ•´æ—¶éš¾ä»¥äº¤æ¥ç»´æŠ¤ï¼Œå› è¿™å—ä¸åœ¨ä¸“æ¡ˆå†…ï¼Œé™¤äº†åŠ å…¥è¿™æ®µæ£€æŸ¥è¿›æ¥çš„äººçŸ¥é“æ•´ä¸ªé€»è¾‘ï¼Œå…¶ä»–åä½œè€…å¾ˆéš¾ç¢°è§¦åˆ°è¿™å—ã€‚



> æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒä¹‹å‰çš„é‚£ç¯‡æ–‡ç« ï¼Œæœ¬ç¯‡ä¸»è¦ä»‹ç»çš„æ–¹å¼æ˜¯é€è¿‡ XCode 13+SwiftGen+UnitTest æ¥è¾¾æˆæ£€æŸ¥ Localizable.strings çš„æ‰€æœ‰åŠŸèƒ½ã€‚



#### XCode 13 å†…å»º Build Time æ£€æŸ¥ Localizable.strings æ¡£æ¡ˆæ ¼å¼æ­£ç¡®æ€§



![](/assets/48a8526c1300/1*p28LgNGZYh6S8T2s2UH8lg.png)



å‡çº§ XCode 13 ä¹‹åå°±å†…å»ºäº† Build Time æ£€æŸ¥ Localizable.strings æ¡£æ¡ˆæ ¼å¼çš„åŠŸèƒ½ï¼Œç»æµ‹è¯•æ£€æŸ¥çš„è§„æ ¼ç›¸å½“å®Œæ•´ï¼Œé™¤äº†æ¼æ‰ `;` å¤–å¦‚æœ‰å¤šä½™æ— æ„ä¹‰çš„å­—ä¸²ä¹Ÿä¼šè¢«æŒ¡ä¸‹æ¥ã€‚



#### ä½¿ç”¨ SwiftGen å–ä»£åŸå§‹ NSLocalizedString String Base å­˜å–æ–¹å¼



[SwiftGen](https://github.com/SwiftGen/SwiftGen){:target="_blank"} èƒ½å¸®åŠ©æˆ‘ä»¬å°†åŸæœ¬çš„ NSLocalizedString String å­˜å–æ–¹å¼æ”¹æˆ Object å­˜å–ï¼Œé˜²æ­¢ä¸å°å¿ƒæ‰“é”™å­—ã€å¿˜è®°åœ¨ Key å®£å‘Šçš„æƒ…å†µå‡ºç°ã€‚



[![](https://repository-images.githubusercontent.com/39166950/1826ed00-d6cf-11ea-9736-34829910d1e6)](https://github.com/SwiftGen/SwiftGen){:target="_blank"}



SwiftGen æ ¸å¿ƒä¹Ÿæ˜¯ Command Line Toolï¼›ä½†æ˜¯è¿™å·¥å…·åœ¨ä¸šç•Œè›®æµè¡Œçš„è€Œä¸”æœ‰å®Œæ•´çš„æ–‡ä»¶åŠç¤¾ç¾¤èµ„æºåœ¨ç»´æŠ¤ï¼Œä¸å¿…å®³æ€•å¯¼å…¥è¿™ä¸ªå·¥å…·åç»­éš¾ç»´æŠ¤çš„é—®é¢˜ã€‚



[**Installation**](https://github.com/SwiftGen/SwiftGen#installation){:target="_blank"}



å¯ä¾ç…§æ‚¨çš„ç¯å¢ƒæˆ– CI/CD æœåŠ¡è®¾å®šå»é€‰æ‹©å®‰è£…æ–¹å¼ï¼Œè¿™è¾¹ Demo ç›´æ¥ç”¨æœ€ç›´æ¥çš„ CocoaPods è¿›è¡Œå®‰è£…ã€‚



> è¯·æ³¨æ„ SwiftGen å¹¶ä¸æ˜¯çœŸçš„ CocoaPodsï¼Œä»–ä¸ä¼šè·Ÿä¸“æ¡ˆä¸­çš„ç¨‹å¼ç æœ‰ä»»ä½•ä¾èµ–ï¼›ä½¿ç”¨ CocoaPods å®‰è£… SwiftGen å•çº¯åªæ˜¯é€è¿‡å®ƒä¸‹è½½è¿™ä¸ª Command Line Tool æ‰§è¡Œæ¡£å›æ¥ã€‚



åœ¨ `podfile` ä¸­åŠ å…¥ swiftgen podï¼š



```plaintext
pod 'SwiftGen', '~> 6.0'
```



**Init**



`pod install` ä¹‹åæ‰“å¼€ Terminal `cd` åˆ°ä¸“æ¡ˆä¸‹



```bash
/L10NTests/Pods/SwiftGen/bin/swiftGen config init
```



init `swiftgen.yml` è®¾å®šæ¡£ï¼Œå¹¶æ‰“å¼€å®ƒ



```yaml
strings:
  - inputs:
      - "L10NTests/Supporting Files/zh-Hant.lproj/Localizable.strings"
    outputs:
      templateName: structured-swift5
      output: "L10NTests/Supporting Files/SwiftGen-L10n.swift"
      params:
        enumName: "L10n"
```



è´´ä¸Šå¹¶ä¿®æ”¹æˆç¬¦åˆæ‚¨ä¸“æ¡ˆçš„æ ¼å¼ï¼š



**inputs:** ä¸“æ¡ˆè¯­ç³»æ¡£æ¡ˆä½ç½® (å»ºè®®æŒ‡å®š DevelopmentLocalization è¯­ç³»çš„è¯­ç³»æ¡£)



**outputs:**
**output:** è½¬æ¢ç»“æœçš„ swift æ¡£æ¡ˆä½ç½®
**params: enumName:** ç‰©ä»¶åç§°
**templateName:** è½¬æ¢æ¨¡æ¿



å¯ä»¥ä¸‹ `swiftGen template list` å–å¾—å†…å»ºçš„æ¨¡æ¿åˆ—è¡¨



![flat v.s. structured](/assets/48a8526c1300/1*J5ZOMW6BC-fDqSlh-My2Pg.jpeg)



flat v.s. structured



å·®åˆ«åœ¨å¦‚æœ Key é£æ ¼æ˜¯ `XXX.YYY.ZZZ` flat æ¨¡æ¿ä¼šè½¬æ¢æˆå°é©¼å³°ï¼›structured æ¨¡æ¿ä¼šç…§åŸå§‹é£æ ¼è½¬æ¢æˆ `XXX.YYY.ZZZ` ç‰©ä»¶ã€‚



çº¯ Swift ä¸“æ¡ˆå¯ç›´æ¥ä½¿ç”¨å†…å»ºæ¨¡æ¿ï¼Œä½†è‹¥æ˜¯ Swift æ·· OC çš„ä¸“æ¡ˆå°±éœ€è¦è‡ªè¡Œå®¢åˆ¶åŒ–æ¨¡æ¿ï¼š



`flat-swift5-objc.stencil` :



```php
// swiftlint:disable all
// Generated using SwiftGen â€” https://github.com/SwiftGen/SwiftGen

{% if tables.count > 0 %}
{% set accessModifier %}{% if param.publicAccess %}public{% else %}internal{% endif %}{% endset %}
import Foundation

// swiftlint:disable superfluous_disable_command file_length implicit_return

// MARK: - Strings

{% macro parametersBlock types %}{% filter removeNewlines:"leading" %}
  {% for type in types %}
    {% if type == "String" %}
    _ p{{forloop.counter}}: Any
    {% else %}
    _ p{{forloop.counter}}: {{type}}
    {% endif %}
    {{ ", " if not forloop.last }}
  {% endfor %}
{% endfilter %}{% endmacro %}
{% macro argumentsBlock types %}{% filter removeNewlines:"leading" %}
  {% for type in types %}
    {% if type == "String" %}
    String(describing: p{{forloop.counter}})
    {% elif type == "UnsafeRawPointer" %}
    Int(bitPattern: p{{forloop.counter}})
    {% else %}
    p{{forloop.counter}}
    {% endif %}
    {{ ", " if not forloop.last }}
  {% endfor %}
{% endfilter %}{% endmacro %}
{% macro recursiveBlock table item %}
  {% for string in item.strings %}
  {% if not param.noComments %}
  {% for line in string.translation\\|split:"\n" %}
  /// {{line}}
  {% endfor %}
  {% endif %}
  {% if string.types %}
  {{accessModifier}} static func {{string.key\\|swiftIdentifier:"pretty"\\|lowerFirstWord\\|escapeReservedKeywords}}({% call parametersBlock string.types %}) -> String {
    return {{enumName}}.tr("{{table}}", "{{string.key}}", {% call argumentsBlock string.types %})
  }
  {% elif param.lookupFunction %}
  {# custom localization function is mostly used for in-app lang selection, so we want the loc to be recomputed at each call for those (hence the computed var) #}
  {{accessModifier}} static var {{string.key\\|swiftIdentifier:"pretty"\\|lowerFirstWord\\|escapeReservedKeywords}}: String { return {{enumName}}.tr("{{table}}", "{{string.key}}") }
  {% else %}
  {{accessModifier}} static let {{string.key\\|swiftIdentifier:"pretty"\\|lowerFirstWord\\|escapeReservedKeywords}} = {{enumName}}.tr("{{table}}", "{{string.key}}")
  {% endif %}
  {% endfor %}
  {% for child in item.children %}
  {% call recursiveBlock table child %}
  {% endfor %}
{% endmacro %}
// swiftlint:disable function_parameter_count identifier_name line_length type_body_length
{% set enumName %}{{param.enumName\\|default:"L10n"}}{% endset %}
@objcMembers {{accessModifier}} class {{enumName}}: NSObject {
  {% if tables.count > 1 or param.forceFileNameEnum %}
  {% for table in tables %}
  {{accessModifier}} enum {{table.name\\|swiftIdentifier:"pretty"\\|escapeReservedKeywords}} {
    {% filter indent:2 %}{% call recursiveBlock table.name table.levels %}{% endfilter %}
  }
  {% endfor %}
  {% else %}
  {% call recursiveBlock tables.first.name tables.first.levels %}
  {% endif %}
}
// swiftlint:enable function_parameter_count identifier_name line_length type_body_length

// MARK: - Implementation Details

extension {{enumName}} {
  private static func tr(_ table: String, _ key: String, _ args: CVarArg...) -> String {
    {% if param.lookupFunction %}
    let format = {{ param.lookupFunction }}(key, table)
    {% else %}
    let format = {{param.bundle\\|default:"BundleToken.bundle"}}.localizedString(forKey: key, value: nil, table: table)
    {% endif %}
    return String(format: format, locale: Locale.current, arguments: args)
  }
}
{% if not param.bundle and not param.lookupFunction %}

// swiftlint:disable convenience_type
private final class BundleToken {
  static let bundle: Bundle = {
    #if SWIFT_PACKAGE
    return Bundle.module
    #else
    return Bundle(for: BundleToken.self)
    #endif
  }()
}
// swiftlint:enable convenience_type
{% endif %}
{% else %}
// No string found
{% endif %}
```



ä»¥ä¸Šæä¾›ä¸€ä¸ªç½‘è·¯æœé›†æ¥&å®¢åˆ¶åŒ–è¿‡å…¼å®¹ Swift å’Œ OC çš„æ¨¡æ¿ï¼Œå¯è‡ªè¡Œå»ºç«‹ `flat-swift5-objc.stencil` File ç„¶åè´´ä¸Šå†…å®¹æˆ– [ç‚¹æ­¤ç›´æ¥ä¸‹è½½ .zip](https://gist.github.com/zhgchgli0718/34cc6af6366add93f16632efd5575691/archive/bcccc0fb7367c8f9e58b8453446f0a52631aa8d1.zip){:target="_blank"} ã€‚



ä½¿ç”¨å®¢åˆ¶åŒ–æ¨¡æ¿çš„è¯å°±ä¸æ˜¯ç”¨ templateName äº†ï¼Œè€Œè¦æ”¹å®£å‘Š templatePathï¼š



`swiftgen.yml` :



```yaml
strings:
  - inputs:
      - "L10NTests/Supporting Files/zh-Hant.lproj/Localizable.strings"
    outputs:
      templatePath: "path/to/flat-swift5-objc.stencil"
      output: "L10NTests/Supporting Files/SwiftGen-L10n.swift"
      params:
        enumName: "L10n"
```



å°† templatePath è·¯å¾„æŒ‡å®šåˆ° .stencil æ¨¡æ¿åœ¨ä¸“æ¡ˆä¸­çš„ä½ç½®å³å¯ã€‚



**Generator**



è®¾å®šå¥½ä¹‹åå¯ä»¥å›åˆ° Termnial æ‰‹åŠ¨ä¸‹ï¼š



```bash
/L10NTests/Pods/SwiftGen/bin/swiftGen
```



æ‰§è¡Œè½¬æ¢ï¼Œç¬¬ä¸€æ¬¡è½¬æ¢åè¯·æ‰‹åŠ¨ä» Finder å°†è½¬æ¢ç»“æœæ¡£æ¡ˆ (SwiftGen-L10n.swift) æ‹‰åˆ°ä¸“æ¡ˆä¸­ï¼Œç¨‹å¼æ‰èƒ½ä½¿ç”¨ã€‚



**Run Script**



![](/assets/48a8526c1300/1*jbpXqjsF9kROgIqRQG9JcA.png)



åœ¨ä¸“æ¡ˆè®¾å®šä¸­ -&gt; Build Phases -&gt; + -&gt; New Run Script Phases -&gt; è´´ä¸Šï¼š



```bash
if [[ -f "${PODS_ROOT}/SwiftGen/bin/swiftgen" ]]; then
  echo "${PODS_ROOT}/SwiftGen/bin/swiftgen"
  "${PODS_ROOT}/SwiftGen/bin/swiftgen"
else
  echo "warning: SwiftGen is not installed. Run 'pod install --repo-update' to install it."
fi
```



è¿™æ ·åœ¨æ¯æ¬¡ Build ä¸“æ¡ˆæ—¶éƒ½ä¼šè·‘ Generator äº§å‡ºæœ€æ–°çš„è½¬æ¢ç»“æœã€‚



**CodeBase ä¸­å¦‚ä½•ä½¿ç”¨?**



![](/assets/48a8526c1300/1*8AiJIfqe5C1r9ESbfF-Y7w.png)



```swift
L10n.homeTitle
L10n.homeDescription("ZhgChgLi") // with arg
```



> æœ‰äº† Object Access åå°±ä¸å¯èƒ½å‡ºç°æ‰“é”™å­—åŠ Code é‡Œé¢æœ‰åœ¨ç”¨çš„ Key ä½† Localizable.strings æ¡£å¿˜è®°å®£å‘Šçš„æƒ…å†µã€‚



> ä½† SwiftGen åªèƒ½æŒ‡å®šä»æŸä¸ªè¯­ç³»äº§ç”Ÿï¼Œæ‰€ä»¥æ— æ³•é˜»æŒ¡äº§ç”Ÿçš„è¯­ç³»æœ‰è¿™ä¸ª Key ä½†åœ¨å…¶ä»–è¯­ç³»å¿˜è®°å®šä¹‰çš„çŠ¶å†µï¼›æ­¤çŠ¶å†µè¦ç”¨ä¸‹é¢çš„ UnitTest æ‰èƒ½ä¿æŠ¤ã€‚



**è½¬æ¢**



è½¬æ¢æ‰æ˜¯è¿™ä¸ªé—®é¢˜æœ€å›°éš¾çš„åœ°æ–¹ï¼Œå› ä¸ºå·²å¼€å‘å®Œæˆçš„ä¸“æ¡ˆä¸­å¤§é‡ä½¿ç”¨ NSLocalizedString è¦å°†å…¶è½¬æ¢æˆæ–°çš„ `L10n.XXX` æ ¼å¼ã€å¦‚æœæ˜¯æœ‰å¸¦å‚æ•°çš„è¯­å¥åˆæ›´å¤æ‚ `String(format: NSLocalizedString` ï¼Œå¦å¤–å¦‚æœæœ‰æ·· OC è¿˜è¦è€ƒè™‘ OC çš„è¯­æ³•ä¸ Swift ä¸åŒã€‚



æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„è§£æ³•ï¼Œåªèƒ½è‡ªå·±å†™ä¸€ä¸ª Command Line Toolsï¼Œå¯å‚è€ƒ [ä¸Šä¸€ç¯‡æ–‡ç« ](../41c49a75a743/) ä¸­ä½¿ç”¨ Swift æ‰«æä¸“æ¡ˆç›®å½•ã€Parse å‡º NSLocalizedString çš„ Regex æ’°å†™ä¸€ä¸ªå°å·¥å…·å»è½¬æ¢ã€‚



å»ºè®®ä¸€æ¬¡è½¬æ¢ä¸€ä¸ªæƒ…å¢ƒï¼Œèƒ½ Build è¿‡å†è½¬æ¢ä¸‹ä¸€ä¸ªã€‚



- Swift -&gt; NSLocalizedString æ— å‚æ•°


- Swift -&gt; NSLocalizedString æœ‰å‚æ•°æƒ…å†µ


- OC -&gt; NSLocalizedString æ— å‚æ•°


- OC -&gt; NSLocalizedString æœ‰å‚æ•°æƒ…å†µ



#### é€è¿‡ UnitTest æ£€æŸ¥å„è¯­ç³»æ¡£ä¸ä¸»è¦è¯­ç³»æ¡£æ¡ˆæœ‰æ²¡æœ‰ç¼ºæ¼åŠ Key æœ‰æ— é‡å¤



æˆ‘ä»¬å¯ä»¥é€è¿‡æ’°å†™ UniTest ä» Bundle è¯»å–å‡º `.strings` File å†…å®¹ï¼Œå¹¶åŠ ä»¥æµ‹è¯•ã€‚



**ä» Bundle è¯»å–å‡º `.strings` å¹¶è½¬æˆç‰©ä»¶ï¼š**



```swift
class L10NTestsTests: XCTestCase {
    
    private var localizations: [Bundle: [Localization]] = [:]
    
    override func setUp() {
        super.setUp()
        
        let bundles = [Bundle(for: type(of: self))]
        
        //
        bundles.forEach { bundle in
            var localizations: [Localization] = []
            
            bundle.localizations.forEach { lang in
                var localization = Localization(lang: lang)
                
                if let lprojPath = bundle.path(forResource: lang, ofType: "lproj"),
                   let lprojBundle = Bundle(path: lprojPath) {
                    
                    let filesInLPROJ = (try? FileManager.default.contentsOfDirectory(atPath: lprojBundle.bundlePath)) ?? []
                    localization.localizableStringFiles = filesInLPROJ.compactMap { fileFullName -> L10NTestsTests.Localization.LocalizableStringFile? in
                        let fileName = URL(fileURLWithPath: fileFullName).deletingPathExtension().lastPathComponent
                        let fileExtension = URL(fileURLWithPath: fileFullName).pathExtension
                        guard fileExtension == "strings" else { return nil }
                        guard let path = lprojBundle.path(forResource: fileName, ofType: fileExtension) else { return nil }
                        
                        return L10NTestsTests.Localization.LocalizableStringFile(name: fileFullName, path: path)
                    }
                    
                    localization.localizableStringFiles.enumerated().forEach { (index, localizableStringFile) in
                        if let fileContent = try? String(contentsOfFile: localizableStringFile.path, encoding: .utf8) {
                            let lines = fileContent.components(separatedBy: .newlines)
                            let pattern = "\"(.*)\"(\\s*)(=){1}(\\s*)\"(.+)\";"
                            let regex = try? NSRegularExpression(pattern: pattern, options: [])
                            let values = lines.compactMap { line -> Localization.LocalizableStringFile.Value? in
                                let range = NSRange(location: 0, length: (line as NSString).length)
                                guard let matches = regex?.firstMatch(in: line, options: [], range: range) else { return nil }
                                let key = (line as NSString).substring(with: matches.range(at: 1))
                                let value = (line as NSString).substring(with: matches.range(at: 5))
                                return Localization.LocalizableStringFile.Value(key: key, value: value)
                            }
                            localization.localizableStringFiles[index].values = values
                        }
                    }
                    
                    localizations.append(localization)
                }
            }
            
            self.localizations[bundle] = localizations
        }
    }
}

private extension L10NTestsTests {
    struct Localization: Equatable {
        struct LocalizableStringFile {
            struct Value {
                let key: String
                let value: String
            }
            
            let name: String
            let path: String
            var values: [Value] = []
        }
        
        let lang: String
        var localizableStringFiles: [LocalizableStringFile] = []
        
        static func == (lhs: Self, rhs: Self) -> Bool {
            return lhs.lang == rhs.lang
        }
    }
}
```



æˆ‘ä»¬å®šä¹‰æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `Localization` æ¥å­˜æ”¾é¢‡æå‡ºæ¥çš„èµ„æ–™ï¼Œä» `Bundle` ä¸­å»æ‰¾ `lproj` å†ä»å…¶ä¸­æ‰¾å‡º `.strings` ç„¶åå†ä½¿ç”¨æ­£åˆ™è¡¨ç¤ºæ³•å°†å¤šè¯­ç³»è¯­å¥è½¬æ¢æˆç‰©ä»¶æ”¾å›åˆ° `Localization` ï¼Œä»¥åˆ©åç»­æµ‹è¯•ä½¿ç”¨ã€‚



**è¿™è¾¹æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ï¼š**



- ä½¿ç”¨ `Bundle(for: type(of: self))` ä» Test Target å–å¾—èµ„æº


- è®°å¾—å°† Test Target çš„ [STRINGS_FILE_OUTPUT_ENCODING](https://developer.apple.com/forums/thread/71779){:target="_blank"}
  è®¾ä¸º `UTF-8` ï¼Œå¦åˆ™ä½¿ç”¨ String è¯»å–æ¡£æ¡ˆå†…å®¹æ—¶ä¼šå¤±è´¥ (é¢„è®¾ä¼šæ˜¯ Biniary)


- ä½¿ç”¨ String è¯»å–è€Œä¸ç”¨ NSDictionary çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•é‡å¤çš„ Keyï¼Œä½¿ç”¨ NSDictionary ä¼šåœ¨è¯»å–çš„æ—¶å€™å°±ç›–æ‰é‡å¤çš„ Key äº†


- è®°å¾— `.strings` File è¦å¢åŠ  Test Target



![](/assets/48a8526c1300/1*ERr-ef6R7dFHo1ucU6cPOQ.png)



**TestCase 1. æµ‹è¯•åŒä¸€ä¸ª .strings æ¡£æ¡ˆå†…æœ‰æ— é‡å¤å®šä¹‰çš„ Keyï¼š**



```swift
func testNoDuplicateKeysInSameFile() throws {
    localizations.forEach { (_, localizations) in
        localizations.forEach { localization in
            localization.localizableStringFiles.forEach { localizableStringFile in
                let keys = localizableStringFile.values.map { $0.key }
                let uniqueKeys = Set(keys)
                XCTAssertTrue(keys.count == uniqueKeys.count, "Localized Strings File: \(localizableStringFile.path) has duplicated keys.")
            }
        }
    }
}
```



Input:



![](/assets/48a8526c1300/1*cB5nXv1wWPzbjAOrKQ835w.png)



Result:



![](/assets/48a8526c1300/1*6qIgcx0EkK7j_R17d6ljuw.png)



**TestCase 2. ä¸ DevelopmentLocalization è¯­è¨€ç›¸æ¯”ï¼Œæœ‰æ— ç¼ºå°‘/å¤šä½™çš„ Keyï¼š**



```swift
func testCompareWithDevLangHasMissingKey() throws {
    localizations.forEach { (bundle, localizations) in
        let developmentLang = bundle.developmentLocalization ?? "en"
        if let developmentLocalization = localizations.first(where: { $0.lang == developmentLang }) {
            let othersLocalization = localizations.filter { $0.lang != developmentLang }
            
            developmentLocalization.localizableStringFiles.forEach { developmentLocalizableStringFile in
                let developmentLocalizableKeys = Set(developmentLocalizableStringFile.values.map { $0.key })
                othersLocalization.forEach { otherLocalization in
                    if let otherLocalizableStringFile = otherLocalization.localizableStringFiles.first(where: { $0.name == developmentLocalizableStringFile.name }) {
                        let otherLocalizableKeys = Set(otherLocalizableStringFile.values.map { $0.key })
                        if developmentLocalizableKeys.count < otherLocalizableKeys.count {
                            XCTFail("Localized Strings File: \(otherLocalizableStringFile.path) has redundant keys.")
                        } else if developmentLocalizableKeys.count > otherLocalizableKeys.count {
                            XCTFail("Localized Strings File: \(otherLocalizableStringFile.path) has missing keys.")
                        }
                    } else {
                        XCTFail("Localized Strings File not found in Lang: \(otherLocalization.lang)")
                    }
                }
            }
        } else {
            XCTFail("developmentLocalization not found in Bundle: \(bundle)")
        }
    }
}
```



Input: (ç›¸è¾ƒ DevelopmentLocalization å…¶ä»–è¯­ç³»ç¼ºå°‘å®£å‘Š Key)



![](/assets/48a8526c1300/1*RwO-ploDVoExJmhHRpBXiA.png)



Output:



![](/assets/48a8526c1300/1*Mdt01WLvX2KBtwUhThxOSQ.png)



Input: (DevelopmentLocalization æ²¡æœ‰è¿™ä¸ª Keyï¼Œä½†åœ¨å…¶ä»–è¯­ç³»å‡ºç°)



![](/assets/48a8526c1300/1*RwO-ploDVoExJmhHRpBXiA.png)



Output:



![](/assets/48a8526c1300/1*Fr-w-PXEx2N_ftYjfXTa9w.png)



### æ€»ç»“



ç»¼åˆä»¥ä¸Šæ–¹å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ï¼š



- æ–°ç‰ˆ XCode å¸®æˆ‘ä»¬ç¡®ä¿ .strings æ¡£æ¡ˆæ ¼å¼æ­£ç¡®æ€§ âœ…


- SwiftGen ç¡®ä¿ CodeBase å¼•ç”¨å¤šè¯­ç³»æ—¶ä¸ä¼šæ‰“é”™æˆ–æ²¡å®£å‘Šå°±å¼•ç”¨ âœ…


- UnitTest ç¡®ä¿å¤šè¯­ç³»å†…å®¹æ­£ç¡®æ€§ âœ…



[![](https://opengraph.githubassets.com/5e3a8099a333f9bf5a74339f82426afdd235c5a6ca6b9910196a4b961eb2b31a/zhgchgli0718/L10NTests)](https://github.com/zhgchgli0718/L10NTests){:target="_blank"}



#### ä¼˜ç‚¹ï¼š



- æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œä¸æ‹–ç´¯ Build Time


- åªè¦æ˜¯ iOS å¼€å‘è€…éƒ½ä¼šç»´æŠ¤



### è¿›é˜¶



#### Localized File Format



è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ— æ³•è¾¾æˆï¼Œè¿˜æ˜¯éœ€ä½¿ç”¨åŸæœ¬ [ç”¨ Swift å†™çš„ Command Line Tool æ¥è¾¾æˆ](../41c49a75a743/) ï¼Œä¸è¿‡ Format éƒ¨åˆ†å¯ä»¥åœ¨ git pre-commit åšå°±å¥½ï¼›æ²¡æœ‰ diff è°ƒæ•´å°±ä¸åšï¼Œé¿å…æ¯æ¬¡ build éƒ½è¦è·‘ä¸€æ¬¡ï¼š



```bash
#!/bin/sh

diffStaged=${1:-\-\-staged} # use $1 if exist, default --staged.

git diff --diff-filter=d --name-only $diffStaged \\| grep -e 'Localizable.*\.\(strings\\\|stringsdict\)$' \\| \
  while read line; do
    // do format for ${line}
done
```



#### .stringdict



åŒæ ·çš„åŸç†ä¹Ÿå¯ç”¨åœ¨ `.stringdict` ä¸Š



#### CI/CD



swiftgen å¯ä»¥ä¸ç”¨æ”¾åœ¨ build phaseï¼Œå› ä¸ºæ¯æ¬¡ build éƒ½ä¼šè·‘ä¸€æ¬¡ï¼Œè€Œä¸” Build å®Œç¨‹å¼ç æ‰ä¼šå‡ºç°ï¼Œå¯ä»¥æ”¹æˆæœ‰è°ƒæ•´å†ä¸‹æŒ‡ä»¤äº§ç”Ÿå°±å¥½ã€‚



#### æ˜ç¡®å¾—åˆ°é”™åœ¨å“ªä¸ª Key



å¯ä¼˜åŒ– UnitTest çš„ç¨‹å¼ï¼Œä½¿ä¹‹èƒ½è¾“å‡ºæ˜ç¡®æ˜¯å“ªä¸ª Key Missing/Reductant/Duplicateã€‚



#### ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·è®©å·¥ç¨‹å¸ˆå®Œå…¨è§£æ”¾å¤šè¯­ç³»å·¥ä½œ



å¦‚åŒä¹‹å‰ã€Œ [2021 Pinkoi Tech Career Talk â€” é«˜æ•ˆç‡å·¥ç¨‹å›¢é˜Ÿå¤§è§£å¯†](../11f6c8568154/) ã€çš„æ¼”è®²å†…å®¹ï¼Œåœ¨å¤§å›¢é˜Ÿä¸­å¤šè¯­ç³»å·¥ä½œå¯ä»¥é€è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡æ‹†å¼€ï¼Œå¤šè¯­ç³»å·¥ä½œçš„ä¾èµ–å…³ç³»ã€‚



![](/assets/48a8526c1300/1*YQi4ti2_MfUapUSRKnF5dg.png)



å·¥ç¨‹å¸ˆåªéœ€å®šä¹‰å¥½ Keyï¼Œå¤šè¯­ç³»ä¼šåœ¨ CI/CD é˜¶æ®µä»å¹³å°è‡ªåŠ¨æ±‡å…¥ï¼Œå°‘äº†äººå·¥ç»´æŠ¤çš„é˜¶æ®µï¼›ä¹Ÿæ¯”è¾ƒä¸å®¹æ˜“å‡ºé”™ã€‚



### Special Thanks



![[Wei Cao](https://www.linkedin.com/in/wei-cao-67b5b315a/){:target="_blank"} , iOS Developer @ Pinkoi](/assets/48a8526c1300/1*CCGSKp2-BvATpDAuRiRuRQ.jpeg)



[Wei Cao](https://www.linkedin.com/in/wei-cao-67b5b315a/){:target="_blank"} , iOS Developer @ Pinkoi



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/ios-%E7%82%BA%E5%A4%9A%E8%AA%9E%E7%B3%BB%E5%AD%97%E4%B8%B2%E8%B2%B7%E4%BB%BD%E4%BF%9D%E9%9A%AA%E5%90%A7-48a8526c1300){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*