---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2022-07-20T14:50:44.659+0000
description: App Store Connect API 2.0+ 全面更新，支援 In-app purchases、Subscriptions、Customer
  Reviews 管理
image:
  path: /assets/f1365e51902c/1*hHJ66r9BgJQsGnRYqbB_8g.png
last_modified_at: 2024-04-14T02:18:42.807+0000
render_with_liquid: false
tags:
- ios-app-development
- app-store-connect
- api
- app-review
- integration
title: App Store Connect API 现已支援 读取和管理 Customer Reviews
---

### App Store Connect API 现已支援 读取和管理 Customer Reviews



App Store Connect API 2.0+ 全面更新，支援 In-app purchases、Subscriptions、Customer Reviews 管理



### 2022/07/19 News



![[Upcoming transition from the XML feed to the App Store Connect API](https://developer.apple.com/news/?id=yqf4kgwb){:target="_blank"}](/assets/f1365e51902c/1*hHJ66r9BgJQsGnRYqbB_8g.png)



[Upcoming transition from the XML feed to the App Store Connect API](https://developer.apple.com/news/?id=yqf4kgwb){:target="_blank"}



今早收到 [Apple 开发者最新消息](https://developer.apple.com/news/rss/news.rss){:target="_blank"} ，App Store Connect API 新增支援 In-app purchases、Subscriptions、Customer Reviews 管理三项功能；让开发者可以更弹性的将 Apple 开发流程与 CI/CD 或是商业后台做更密切、有效率的整合！



In-app purchases、Subscriptions 我没碰，Customer Reviews 让我兴奋不已，之前发表过一篇「 [**AppStore APP’s Reviews Slack Bot 那些事**](../cb0c68c33994/) 」探讨 App 评价与工作流程整合的方式。



![Slack 评价机器人 — [ZReviewsBot](https://github.com/ZhgChgLi/ZReviewsBot){:target="_blank"}](/assets/f1365e51902c/1*igukM7FTLxaX2hpVtFPMjQ.png)



Slack 评价机器人 — [ZReviewsBot](https://github.com/ZhgChgLi/ZReviewsBot){:target="_blank"}



在 App Store Connect API 还没支援之前，只有两种方法能获取 iOS App 评价：



**一 是** 透过订阅 [Public RSS](https://rss.itunes.apple.com/zh-tw){:target="_blank"} 取得，但是此 RSS 无法让人弹性筛选、给的资讯也少、有数量上限、还有我们偶尔会遇到资料错乱问题，很不稳定



**二 是** 透过 [**Fastlane**](https://fastlane.tools/){:target="_blank"} **— [SpaceShip](https://github.com/fastlane/fastlane/tree/master/spaceship){:target="_blank"}** 帮我们封装复杂的网页操作、Session 管理，去 App Store Connection 网站后台捞取评价资料 (等于是起一个网页模拟器爬虫去后台爬资料)。



- 好处是资料齐全、稳定，我们串接了一年没有遇到任何资料问题。


- 坏处是 Session 每个月都会过期，要手动重新登入，而且 Apple ID 目前全面都要绑定 2FA 验证，所以这段也要手动完成，这样才能产出有效的 Session；另外 Session 如果产的跟用的 IP 不一样会马上过期 (因此很难将机器人放上不固定 IP 的网路服务)。



![[important-note-about-session-duration](https://docs.fastlane.tools/best-practices/continuous-integration/#important-note-about-session-duration){:target="_blank"} by Fastlane](/assets/f1365e51902c/0*iMQRza9LN3ljy2k1.png)



[important-note-about-session-duration](https://docs.fastlane.tools/best-practices/continuous-integration/#important-note-about-session-duration){:target="_blank"} by Fastlane



- 每个月不定时过期，要不定时去更新，时间久了真的很烦；而且这个 「 **Know How** 」其实不好交接给其他同事。



> 但因为没有其他方法，所以也只能这样，直到今天早上收到消息….



> **⚠️ 注意：官方预计在 2022/11 取消原本的 XML (RSS) 存取方式。**



### 2022/08/10 Update



我已基于新的 App Store Connect API 开发了新的 「 [ZReviewTender — 免费开源的 App Reviews 监控机器人](../e36e48bb9265/) 」



### App Store Connect API 2.0+ Customer Reviews 试玩



#### 建立 App Store Connect API Key



首先我们要登入 App Store Connect 后台，前往「Users and Access」-&gt;「Keys」-&gt;「 [**App Store Connect API**](https://appstoreconnect.apple.com/access/api){:target="_blank"} 」：



![](/assets/f1365e51902c/1*0NimMOcIqQ95nzjBBKYe8A.png)



点击「+」，输入名称和权限；权限细则可参考官网说明，为了减少测试问题，这边先选择「App Manager」把权限开到最大。



![](/assets/f1365e51902c/1*Bt8ddt7GrZs1ERaFamftVw.png)



点击右方「Download API Key」下载保存你的「AuthKey_XXX.p8」Key。



> ⚠️ 注意：这个 Key 只能下载一次请 **妥善保存** ，若遗失只能 Revoke 现有的 & 重新建立。⚠️



> **⚠️ 切勿外泄 .p8 Key File⚠️**



#### App Store Connect API 存取方式



```bash
curl -v -H 'Authorization: Bearer [signed token]' "https://api.appstoreconnect.apple.com/v1/apps"
```



#### Signed Token (JWT, JSON Web Token) 产生方式



参考 [官方文件](https://developer.apple.com/documentation/appstoreconnectapi/generating_tokens_for_api_requests){:target="_blank"} 。



![](/assets/f1365e51902c/1*KDv2ra17oSp5UXKy-VZA1g.png)



- JWT Header：



```json
{kid:"YOUR_KEY_ID", typ:"JWT", alg:"ES256"}
```



`YOUR_KEY_ID` ：参考上图。



- JWT Payload：



```json
{
  iss: 'YOUR_ISSUE_ID',
  iat: TOKEN 建立时间 (UNIX TIMESTAMP e.g 1658326020),
  exp: TOKEN 失效时间 (UNIX TIMESTAMP e.g 1658327220),
  aud: 'appstoreconnect-v1'
}
```



`YOUR_ISSUE_ID` ：参考上图。



`exp TOKEN 失效时间` ：会因为不同存取功能或设定有不同的时间限制，有的可以永久、有的超过 20 分钟即失效，需要重新产生，详细可参考 [官方说明](https://developer.apple.com/documentation/appstoreconnectapi/generating_tokens_for_api_requests#3878467){:target="_blank"} 。



#### 使用 [JWT.IO](https://jwt.io/){:target="_blank"} 或是以下附的 Ruby 范例产生 JWT



jwt.rb:



```ruby
require 'jwt'
require 'time'

keyFile = File.read('./AuthKey_XXXX.p8') # YOUR .p8 private key file path
privateKey = OpenSSL::PKey::EC.new(keyFile)

payload = {
            iss: 'YOUR_ISSUE_ID',
            iat: Time.now.to_i,
            exp: Time.now.to_i + 60*20,
            aud: 'appstoreconnect-v1'
          }

token = JWT.encode payload, privateKey, 'ES256', header_fields={kid:"YOUR_KEY_ID", typ:"JWT"}
puts token


decoded_token = JWT.decode token, privateKey, true, { algorithm: 'ES256' }
puts decoded_token
```



- Ruyb JWT 工具在此： <https://github.com/jwt/ruby-jwt>{:target="_blank"}



**最终会得到类似以下的 JWT 结果：**



```
4oxjoi8j69rHQ58KqPtrFABBWHX2QH7iGFyjkc5q6AJZrKA3AcZcCFoFMTMHpM.pojTEWQufMTvfZUW1nKz66p3emsy2v5QseJX5UJmfRjpxfjgELUGJraEVtX7tVg6aicmJT96q0snP034MhfgoZAB46MGdtC6kv2Vj6VeL2geuXG87Ys6ADijhT7mfHUcbmLPJPNZNuMttcc.fuFAJZNijRHnCA2BRqq7RZEJBB7TLsm1n4WM1cW0yo67KZp-Bnwx9y45cmH82QPAgKcG-y1UhRUrxybi5b9iNN
```



#### 打看看？



有了 Token 我们就能来打看看 App Store Connect API！



```bash
curl -H 'Authorization: Bearer JWT' "https://api.appstoreconnect.apple.com/v1/apps/APPID/customerReviews"
```



- `APPID` 可从 App Store Connect 后台取得：



![](/assets/f1365e51902c/1*yU4J85S6Q_e8c9NPYE8bNw.png)



或是 App 商城页面：



- <https://apps.apple.com/tw/app/pinkoi/id557252416>{:target="_blank"}


- APPID = `557252416`



![](/assets/f1365e51902c/1*wWIpy8Y5G2F0A2FvQzp0hQ.png)



- 成功！🚀 我们现在可以使用这个方式捞取 App 评价，资料完整且可以完全交给机器执行，不需人工例行维护 (JWT 虽会过期，但是 Private Key 不会，我们每次请求都可借由 Private Key 签名产生 JWT 去存取即可)。


- 其他筛选参数、操作方法请参考 [官方文件](https://developer.apple.com/documentation/appstoreconnectapi/list_all_customer_reviews_for_an_app){:target="_blank"} 。



> **⚠️ 您只能存取您有权限的 App 评价资料⚠️**



#### 完整 Ruby 测试专案



用一个 Ruby 档案做了以上流程，可直接 Clone 下来填入资料即可测试使用。



[![](https://opengraph.githubassets.com/dc0eb76d891ed80d9f1cb1979225b4cf2ad813fe3c1344bac51a14384c8aeb00/zhgchgli0718/appstoreconnectapitester)](https://github.com/zhgchgli0718/appstoreconnectapitester){:target="_blank"}



**首次打开：**



```bash
bundle install
```



**开始使用：**



```bash
bundle exec ruby jwt.rb
```



### Next



同理我们可以透过 API 去存取管理 ( [API Overview](https://developer.apple.com/app-store-connect/api/){:target="_blank"} )：



- **[New]** [Customer reviews](https://developer.apple.com/documentation/appstoreconnectapi/app_store/customer_reviews){:target="_blank"}


- **[New]** [Subscriptions](https://developer.apple.com/app-store/subscriptions/){:target="_blank"}


- **[New]** [In-App Purchases](https://developer.apple.com/in-app-purchase/){:target="_blank"}


- **[New]** [Xcode Cloud Workflows And Builds](https://developer.apple.com/documentation/appstoreconnectapi/xcode_cloud_workflows_and_builds){:target="_blank"}


- **[Updated]** [Improving your App’s Performance](https://developer.apple.com/documentation/metrickit/improving_your_app_s_performance){:target="_blank"}


- [TestFlight](https://developer.apple.com/testflight/){:target="_blank"}


- [Users And Roles](https://developer.apple.com/support/roles/){:target="_blank"}


- [App Clips](https://developer.apple.com/app-clips/){:target="_blank"}


- [App Management](https://help.apple.com/app-store-connect/#/dev2cd126805){:target="_blank"}


- [App Metadata](https://developer.apple.com/app-store/product-page/){:target="_blank"}


- [Pricing And Availability](https://help.apple.com/app-store-connect/#/dev9fc06e23d){:target="_blank"}


- [Provisioning](https://help.apple.com/developer-account/){:target="_blank"}


- [Sales and Trends](https://help.apple.com/app-store-connect/#/dev061699fdb){:target="_blank"}



有任何问题及指教欢迎 [与我联络](https://www.zhgchg.li/contact){:target="_blank"} 。



*[Post](https://medium.com/zrealm-ios-dev/app-store-connect-api-%E7%8F%BE%E5%B7%B2%E6%94%AF%E6%8F%B4-%E8%AE%80%E5%8F%96%E5%92%8C%E7%AE%A1%E7%90%86-customer-reviews-f1365e51902c){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*