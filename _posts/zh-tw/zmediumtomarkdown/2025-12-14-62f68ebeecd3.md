---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2025-12-14T08:17:06.562+0000
description: ä½¿ç”¨æœ‰é™ç‹€æ…‹æ©Ÿèˆ‡ Design Patterns å°è£ DispatchSourceTimerï¼Œä½¿å…¶æ›´å®‰å…¨æ˜“ç”¨ã€‚
image:
  path: /assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.jpeg
last_modified_at: 2025-12-14T16:24:36.634+0000
render_with_liquid: false
tags:
- ios-app-development
- design-patterns
- timer
- swift
- finite-state-machine
title: iOS Timer èˆ‡ DispatchSourceTimer å¦‚ä½•é¸æ“‡èˆ‡å®‰å…¨çš„ä½¿ç”¨?
---

### \[iOS\] Timer èˆ‡ DispatchSourceTimer å¦‚ä½•é¸æ“‡èˆ‡å®‰å…¨çš„ä½¿ç”¨?

ä½¿ç”¨æœ‰é™ç‹€æ…‹æ©Ÿèˆ‡ Design Patterns å°è£ DispatchSourceTimerï¼Œä½¿å…¶æ›´å®‰å…¨æ˜“ç”¨ã€‚



![Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.jpeg)

Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
#### é—œæ–¼ Timer

åœ¨ iOS é–‹ç™¼ä¸­ä¸€å®šæœƒé‡åˆ°çš„éœ€æ±‚å ´æ™¯ã€ŒTimer å®šæ™‚è§¸ç™¼å™¨ã€ï¼›å¾ UI å±¤é¢ä¸Šé¡¯ç¤ºå€’æ•¸è¨ˆæ™‚ã€Banner è¼ªæ’­åˆ°è³‡æ–™é‚è¼¯å±¤é¢ä¸Šçš„å®šæ™‚ç™¼é€ Eventsã€å®šæ™‚æ¸…é™¤é‡‹æ”¾è³‡æ–™ï¼›æˆ‘å€‘éƒ½éœ€è¦ Timer ä¾†å¹«åŠ©æˆ‘å€‘é”æˆç›®æ¨™ã€‚
### [Foundation â€” Timer \(NSTimer\)](https://developer.apple.com/documentation/foundation/timer){:target="_blank"}

Timer æ‡‰è©²æ˜¯å¤§å®¶æœ€ç›´è¦ºæœƒå…ˆæƒ³åˆ°çš„ APIï¼Œä½†æ˜¯åœ¨é¸æ“‡åŠä½¿ç”¨ Timer ä¸Šæˆ‘å€‘éœ€è¦æ³¨æ„ä»¥ä¸‹å¹¾å€‹é»ã€‚
#### å„ªç¼ºé»

**Timer çš„å„ªé»ï¼š**
- é»˜èªèˆ‡ UI å·¥ä½œæ•´åˆï¼Œä¸éœ€è¦ç‰¹åˆ¥åˆ‡ Main Thread åŸ·è¡Œ
- è‡ªå‹•èª¿æ•´è§¸ç™¼æ™‚æ©Ÿå„ªåŒ–ä½¿ç”¨é›»é‡
- ä½¿ç”¨è¤‡é›œåº¦è¼ƒä½ï¼Œæœ€å¤šåªæœƒç™¼ç”Ÿ Retain Cycle æˆ–å¿˜è¨˜åœæ­¢ Timerï¼Œä½†ä¸æœƒç›´æ¥é€ æˆ Crash


**Timer çš„ç¼ºé»ï¼š**
- ç²¾ç¢ºåº¦å— RunLoop ç‹€æ…‹å½±éŸ¿ï¼Œåœ¨ UI é«˜äº’å‹•æˆ– Mode åˆ‡æ›æ™‚å¯èƒ½å»¶å¾Œè§¸ç™¼
- ä¸æ”¯æ´ `suspend` , `resume` , `activate` â€¦ç­‰é€²éšæ“ä½œ

#### é©åˆå ´æ™¯

UI å±¤é¢éœ€æ±‚ï¼Œä¾‹å¦‚è¼ªæ’­ Banners \(Auto Scroll ScrollView\)æˆ–æ˜¯å„ªæƒ åˆ¸é ˜å–å€’æ•¸è¨ˆæ™‚ï¼›é€™äº›åªè¦æ±‚ä½¿ç”¨è€…åœ¨å‰æ™¯ç•¶å‰ç•«é¢èƒ½éŸ¿æ‡‰å…§å®¹çš„å ´æ™¯ï¼Œæˆ‘æœƒé¸æ“‡ç›´æ¥ç”¨ Timerï¼Œæ–¹ä¾¿ã€å¿«é€Ÿã€å®‰å…¨çš„é”æˆç›®çš„ã€‚
#### ç”Ÿå‘½é€±æœŸ


![](/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.png)


åœ¨ UI Main Thread ä¸Šå»ºç«‹ Timerï¼ŒTimer æœƒè¢« Main Thread çš„ RunLoop å¼·æŒæœ‰ã€ä¸¦é€é RunLoop è¼ªè©¢æ©Ÿåˆ¶å®šæœŸè§¸ç™¼ï¼Œç›´åˆ° Timer invalidate\( \) æ‰æœƒè¢«é‡‹æ”¾ï¼›å› æ­¤æˆ‘å€‘éœ€è¦åœ¨ ViewController ä¸Šå¼·æŒæœ‰ Timer ä¸¦åœ¨ deinit æ™‚å‘¼å« Timer invalidate\( \)ï¼Œæ‰èƒ½åœ¨ç•«é¢é€€å‡ºå¾Œæ­£ç¢ºçµ‚æ­¢é‡‹æ”¾ Timerã€‚
- â­ï¸ï¸ï¸View Controller å¼·æŒæœ‰ Timerï¼Œ **Timer çš„ Execution Block \(handler / closure\)å‹™å¿…ç‚º Weak Selfï¼›å¦å‰‡æœƒ Retain Cycleã€‚**
- â­ï¸ï¸ï¸å‹™å¿…åœ¨ View Controller ç”Ÿå‘½é€±æœŸçµæŸæ™‚å‘¼å« Timer invalidate\( \)ï¼Œå¦å‰‡ RunLoop ä»æœƒæŒæœ‰ Timer ç¹¼çºŒåŸ·è¡Œã€‚



> _RunLoop æ˜¯ Thread å…§çš„äº‹ä»¶è™•ç†è¿´åœˆï¼Œæœƒè¼ªè©¢æ¥æ”¶è™•ç†äº‹ä»¶ï¼› **Main Thread ç³»çµ±æœƒè‡ªå‹•å»ºç«‹ RunLoop \(RunLoop\.main\)** ï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»– Thread ä¸ä¸€å®šæœƒæœ‰ RunLoopã€‚_ 




#### ä½¿ç”¨

æˆ‘å€‘å¯ä»¥ç›´æ¥ä½¿ç”¨ `Timer.scheduledTimer` å®£å‘Šä¸€å€‹ Timer \(æœƒè‡ªå‹•åŠ å…¥ RunLoop\.main & **Mode: \.default** \):
```swift
final class HomeViewController: UIViewController {
    
    private var timer: Timer?
    
    deinit {
        self.timer?.invalidate()
        self.timer = nil
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        startCarousel()
    }
    
    private func startCarousel() {
        self.timer = Timer.scheduledTimer(withTimeInterval: 1, repeats: true, block: { [weak self] _ in
            self?.doSomething()
        })
    }

    private func doSomething() {
        print("Hello World!")
    }
}
```

ä¹Ÿå¯ä»¥è‡ªè¡Œå®£å‘Š Timer ç‰©ä»¶åŠ å…¥åˆ° RunLoop:
```swift
let timer= Timer(timeInterval: 1.0, repeats: true) { [weak self] _ in
  // do something..
}
self.timer = timer
// åŠ å…¥ RunLoop å¾Œæ‰æœƒé–‹å§‹åŸ·è¡Œ
RunLoop.main.add(timer, forMode: .default)
```
#### Timer çš„æ“ä½œæ–¹æ³•
- `invalidate()` çµ‚æ­¢ Timer
- `fire()` ç«‹å³è§¸ç™¼ä¸€æ¬¡

#### RunLoop **Mode çš„å½±éŸ¿**
- `.default` ï¼šé è¨­åŠ å…¥çš„ Modeï¼Œä¸»è¦æ˜¯è™•ç† UI é¡¯ç¤ºã€‚
**æœƒåœ¨åˆ‡æ›åˆ° `.tracking` Mode æ™‚å…ˆæš«åœ**
- `.tracking` ï¼šè™•ç† ScrollView æ»¾å‹•ã€Gesture æ‰‹å‹¢ã€‚
- `.common` ï¼š `.default` \+ `.tracking` éƒ½æœƒè™•ç†ã€‚



> _â­ï¸ï¸ï¸â­ï¸ï¸ï¸â­ï¸ï¸ï¸å› æ­¤åœ¨é»˜èªæƒ…æ³ä¸‹ï¼Œæˆ‘å€‘çš„ Timer æ˜¯åŠ åˆ° `.default` Modeï¼Œ **æœƒåœ¨ä½¿ç”¨è€…æ»¾å‹• ScrollView æˆ–æ˜¯æ‰‹å‹¢æ“ä½œæ™‚è‡ªå‹•æš«åœ** ï¼Œç­‰åˆ°æ“ä½œçµæŸå¾Œæ‰æœƒç¹¼çºŒï¼Œå¯èƒ½é€ æˆ Timer å»¶å¾Œè§¸ç™¼æˆ–æ˜¯æ¬¡æ•¸ä½æ–¼é æœŸã€‚_ 





**å°æ­¤ï¼Œæˆ‘å€‘å¯ä»¥æŠŠ Timer æ”¹åŠ å…¥åˆ° \.common Mode å°±èƒ½è§£æ±ºä»¥ä¸Šå•é¡Œ:**
```swift
RunLoop.main.add(timer, forMode: .common)
```
### [Grand Central Dispatch â€” DispatchSourceTimer](https://developer.apple.com/documentation/dispatch/dispatchsourcetimer){:target="_blank"}

é™¤äº† Timer ä¹‹å¤–ï¼ŒGCD ä¹Ÿæä¾›äº†å¦ä¸€å€‹ DispatchSourceTimer æ–¹æ³•å¯ä¾›é¸æ“‡ã€‚
#### å„ªç¼ºé»

**DispatchSourceTimer çš„å„ªé»ï¼š**
- æ“ä½œå½ˆæ€§\(æ”¯æ´ `suspend` , `resume` \) è¼ƒå¥½
- ç²¾ç¢ºåº¦èˆ‡å¯é ç¨‹åº¦è¼ƒé«˜ï¼šä¾è³´ GCD Queue
- å¯è‡ªè¡Œè¨­å®š leeway æ§åˆ¶è€—é›»é‡
- å¯ç©©å®šå¸¸é§ä»»å‹™ \(GCD Queue\)


**DispatchSourceTimer çš„ç¼ºé»ï¼š**
- UI æ“ä½œéœ€è‡ªè¡Œåˆ‡æ›å› Main Thread
- API ä½¿ç”¨è¤‡é›œä¸”æœ‰é †åºï¼Œ **ç”¨éŒ¯æœƒ Crash**
- éœ€è¦å°è£æ‰èƒ½å®‰å…¨ä½¿ç”¨

#### é©åˆå ´æ™¯

ç›¸è¼ƒ Timer é©åˆ UI å±¤é¢çš„å ´æ™¯ï¼ŒDispatchSourceTimer æ¯”è¼ƒé©åˆåšé‚£äº›è·Ÿ UI æˆ–ä½¿ç”¨è€…ç•¶å‰ç•«é¢ç„¡é—œçš„ä»»å‹™å ´æ™¯ï¼›æœ€å¸¸è¦‹çš„å°±æ˜¯ç™¼é€ Tracking äº‹ä»¶ï¼Œæˆ‘å€‘æœƒå®šæ™‚æŠŠä½¿ç”¨è€…æ“ä½œç”¢ç”Ÿçš„äº‹ä»¶ç™¼é€åˆ°ä¼ºæœå™¨ï¼Œæˆ–æ˜¯å®šæ™‚æ¸…ç†ç„¡ç”¨çš„ CoreData è³‡æ–™ï¼›é€™äº›å°±å¾ˆé©åˆä½¿ç”¨ DispatchSourceTimerã€‚
#### ç”Ÿå‘½é€±æœŸ


![](/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.png)


DispatchSourceTimer çš„ç”Ÿå‘½é€±æœŸå–æ±ºæ–¼æ˜¯å¦ä»è¢«å¤–éƒ¨ç‰©ä»¶æŒæœ‰ï¼›GCD queue æœ¬èº«ä¸æœƒå¼·æŒæœ‰ timer çš„ ownerï¼Œåªè² è²¬èª¿åº¦èˆ‡åŸ·è¡Œäº‹ä»¶ã€‚
#### é–ƒé€€å•é¡Œ

DispatchSourceTimer é›–ç„¶æä¾›æ›´å¤šå¯æ“ä½œæ–¹æ³•ï¼š `activate` , `suspend` , `resume` , `cancel` ï¼›ä½†æ˜¯å®ƒæ¥µå…¶æ•æ„Ÿï¼Œåªè¦å‘¼å«çš„é †åºä¸å°å°±æœƒç›´é–ƒé€€ \(EXC\_BREAKPOINT/DispatchSourceTimer\) éå¸¸å±éšªã€‚


![](/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.png)


**ä»¥ä¸‹æƒ…æ³å‡æœƒç›´æ¥é–ƒé€€ï¼š**
- âŒ suspend\( \) èˆ‡ resume\( \) æ²’æœ‰æˆå°ä½¿ç”¨
suspend\( \) å¾Œåˆå‘¼å«ä¸€æ¬¡ suspend\( \)
resume\( \) å¾Œåˆå‘¼å«ä¸€æ¬¡ resume\( \)
- âŒ suspend\( \) å¾Œå‘¼å« cancel\( \)
éœ€è¦å…ˆ resume\( \) æ‰èƒ½ cancel\( \)
- âŒ suspend\( \) ç‹€æ…‹ä¸‹ Timer è¢«é‡‹æ”¾ \(nil\)
- âŒ cancel\( \) å¾Œå†å‘¼å«å…¶ä»–æ“ä½œ

#### ä½¿ç”¨ Finite\-State Machine æœ‰é™ç‹€æ…‹æ©Ÿå°è£æ“ä½œ

é€²å…¥æœ¬ç¯‡æ–‡ç« çš„å¦ä¸€å€‹é‡é»ï¼Œè©²å¦‚ä½•å®‰å…¨çš„ä½¿ç”¨ DispatchSourceTimer?


![](/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.png)


å¦‚ä¸Šåœ–æ‰€ç¤ºï¼Œæˆ‘å€‘ä½¿ç”¨æœ‰é™ç‹€æ…‹æ©Ÿå°è£ DispatchSourceTimer çš„æ“ä½œï¼Œä½¿å…¶å¯ä»¥æ›´å®‰å…¨ã€æ›´å®¹æ˜“çš„ä½¿ç”¨:
```swift
final class DispatchSourceTimerMachine {
    // æœ‰é™ç‹€æ…‹æ©Ÿæœ‰å“ªäº›ç‹€æ…‹
    private enum TimerState {
        // åˆå§‹ç‹€æ…‹
        case idle
        // åŸ·è¡Œä¸­
        case running
        // æš«åœä¸­
        case suspended
        // çµ‚æ­¢ä¸­
        case cancelled
    }

    private var timer: DispatchSourceTimer?
    private lazy var timerQueue: DispatchQueue = {
        DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine", qos: .background)
    }()

    private var _state: TimerState = .idle
    
    deinit {
        // Owner ç‰©ä»¶æ¶ˆå¤±æ™‚ï¼ŒåŒæ­¥ cancel timer
        // é›–ä¸åšä¹Ÿä¸å½±éŸ¿(handler æ˜¯ weak)ï¼Œä½†æ˜¯å¯ä»¥ç¢ºä¿æµç¨‹ç¬¦åˆé æœŸ
        if _state == .suspended {
            timer?.resume()
            _state = .running
        }
        if _state == .running {
            timer?.cancel()
            timer = nil
            _state = .cancelled
        }
    }

    // å•Ÿå‹• Timer
    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        // åªæœ‰ idle, cancelled ç‹€æ…‹å¯ä»¥å•Ÿç”¨ Timer
        guard [.idle, .cancelled].contains(_state) else { return }
        
        // å»ºç«‹ Timer and activate()
        let timer = makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
        self.timer = timer
        timer.activate()
        
        // åˆ‡æ›åˆ° running ç‹€æ…‹
        _state = .running
    }

    // æš«åœ Timer
    func suspend() {
        // åªæœ‰åœ¨ running ç‹€æ…‹å¯ä»¥æš«åœ Timer
        guard [.running].contains(_state) else { return }
        
        // æš«åœ Timer
        timer?.suspend()
        
        // åˆ‡æ›åˆ° suspended ç‹€æ…‹
        _state = .suspended
    }

    // æ¢å¾© Timer
    func resume() {
        // åªæœ‰åœ¨ suspended ç‹€æ…‹å¯ä»¥æ¢å¾© Timer
        guard [.suspended].contains(_state) else { return }
        
        // æ¢å¾© Timer
        timer?.resume()
        
        // åˆ‡æ›åˆ° running ç‹€æ…‹
        _state = .running
    }

    // çµ‚æ­¢ Timer
    func cancel() {
        // åªæœ‰åœ¨ suspended, running ç‹€æ…‹å¯ä»¥çµ‚æ­¢ Timer
        guard [.suspended, .running].contains(_state) else { return }
        
        // å¦‚æœç•¶å‰æ˜¯ suspended ç‹€æ…‹ï¼Œå…ˆ resume() å†çµ‚æ­¢
        // æ­¤ç‚º DispatchSourceTimer çš„é™åˆ¶ï¼Œåªèƒ½åœ¨ running æ‰èƒ½ cancel()
        if _state == .suspended {
            self.resume()
        }

        // çµ‚æ­¢ Timer
        timer?.cancel()
        timer = nil
        
        // åˆ‡æ›åˆ° cancelled ç‹€æ…‹
        _state = .cancelled
    }
    
    private func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> DispatchSourceTimer {
        let timer = DispatchSource.makeTimerSource(queue: timerQueue)
        timer.schedule(deadline: .now(), repeating: repeatTimeInterval)
        timer.setEventHandler(qos: .background, handler: handler)
        return timer
    }
}
```

æˆ‘å€‘ç°¡å–®ä½¿ç”¨æœ‰é™ç‹€æ…‹æ©Ÿã€Œå°è£äº†ç‹€æ…‹å¯ä»¥è½‰æ›æˆä»€éº¼ç‹€æ…‹ã€èˆ‡ã€Œç‹€æ…‹éœ€è¦åšä»€éº¼ã€çš„é‚è¼¯ï¼Œå¦‚æœåœ¨éŒ¯èª¤çš„ç‹€æ…‹ä¸‹å‘¼å«æœƒè¢«å¿½ç•¥\(ä¸æœƒé–ƒé€€\)ï¼Œæˆ‘å€‘é‚„å¤šåšäº†ä¸€äº›å„ªåŒ–ï¼Œä¾‹å¦‚ suspended ç‹€æ…‹ä¹Ÿèƒ½ cancelã€cancelled ç‹€æ…‹èƒ½é‡æ–° activateã€‚


> **_å»¶ä¼¸é–±è®€ï¼š_** 
 

> _ä¹‹å‰å¯«éå¦ä¸€ç¯‡æ–‡ç« ã€Œ [Design Patterns å¯¦æˆ°æ‡‰ç”¨ï½œå°è£ Socket\.IO å³æ™‚é€šè¨Šæ¶æ§‹](https://zhgchg.li/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/#%E9%9C%80%E6%B1%82%E5%A0%B4%E6%99%AF-3){:target="_blank"} ã€ä¸­ä¹Ÿæœ‰ä½¿ç”¨åˆ°æœ‰é™ç‹€æ…‹æ©Ÿï¼Œå¦å¤–é‚„å¤šä½¿ç”¨äº† State Patternã€‚_ 





> _Finite\-State Machine æœ‰é™ç‹€æ…‹æ©Ÿ: é—œæ³¨çš„æ˜¯ç‹€æ…‹ä¹‹é–“çš„è½‰æ›æ§åˆ¶èˆ‡è©²åšä»€éº¼ã€‚_ 
 

> _State Pattern: é—œæ³¨çš„æ˜¯æ¯å€‹ç‹€æ…‹å…§çš„è¡Œç‚ºé‚è¼¯ã€‚_ 




#### ä½¿ç”¨ Serial Queue æ“ä½œæœ‰é™ç‹€æ…‹æ©Ÿç‹€æ…‹è½‰æ›

æœ‰äº†ç‹€æ…‹æ©Ÿç¢ºä¿ DispatchSourceTimer èƒ½å®‰å…¨ä½¿ç”¨ä¹‹å¾Œé‚„æ²’çµæŸï¼Œæˆ‘å€‘ç„¡æ³•ä¿è­‰åœ¨å¤–éƒ¨å‘¼å«ä½¿ç”¨ DispatchSourceTimerMachine çš„åœ°æ–¹æ˜¯åœ¨åŒå€‹ Threadï¼Œå¦‚æœä¸åŒ Thread éƒ½æ“ä½œäº†é€™å€‹ç‰©ä»¶å°±æœƒé€ æˆ Race Condition ä¸€æ¨£æœƒå¼•ç™¼é–ƒé€€ã€‚
```swift
final class DispatchSourceTimerMachine {
    // æœ‰é™ç‹€æ…‹æ©Ÿæœ‰å“ªäº›ç‹€æ…‹
    private enum TimerState {
        // åˆå§‹ç‹€æ…‹
        case idle
        // åŸ·è¡Œä¸­
        case running
        // æš«åœä¸­
        case suspended
        // çµ‚æ­¢ä¸­
        case cancelled
    }

    private var timer: DispatchSourceTimer?
    private lazy var timerQueue: DispatchQueue = {
        DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine", qos: .background)
    }()

    private var _state: TimerState = .idle

    private static let operationQueueSpecificKey = DispatchSpecificKey<ObjectIdentifier>()
    private lazy var operationQueueSpecificValue: ObjectIdentifier = ObjectIdentifier(self)
    private lazy var operationQueue: DispatchQueue = {
        let queue = DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine.operationQueue")
        queue.setSpecific(key: Self.operationQueueSpecificKey, value: operationQueueSpecificValue)
        return queue
    }()
    private func operation(async: Bool = true, _ work: @escaping () -> Void) {
        if DispatchQueue.getSpecific(key: Self.operationQueueSpecificKey) == operationQueueSpecificValue {
            work()
        } else {
            if async {
                operationQueue.async(execute: work)
            } else {
                operationQueue.sync(execute: work)
            }
        }
    }
    
    deinit {
        // Owner ç‰©ä»¶æ¶ˆå¤±æ™‚ï¼ŒåŒæ­¥ cancel timer
        // é›–ä¸åšä¹Ÿä¸å½±éŸ¿(handler æ˜¯ weak)ï¼Œä½†æ˜¯å¯ä»¥ç¢ºä¿æµç¨‹ç¬¦åˆé æœŸ
        // ç¢ºä¿ sync åŸ·è¡Œå®Œç•¢
        operation(async: false) { [self] in
            if _state == .suspended {
                timer?.resume()
                _state = .running
            }
            if _state == .running {
                timer?.cancel()
                timer = nil
                _state = .cancelled
            }
        }
    }

    // å•Ÿå‹• Timer
    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        operation { [weak self] in
            guard let self = self else { return }
            // åªæœ‰ idle, cancelled ç‹€æ…‹å¯ä»¥å•Ÿç”¨ Timer
            guard [.idle, .cancelled].contains(_state) else { return }
            
            // å»ºç«‹ Timer and activate()
            let timer = makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
            self.timer = timer
            timer.activate()
            
            // åˆ‡æ›åˆ° running ç‹€æ…‹
            _state = .running
        }
    }

    // æš«åœ Timer
    func suspend() {
        operation { [weak self] in
            guard let self = self else { return }
            // åªæœ‰åœ¨ running ç‹€æ…‹å¯ä»¥æš«åœ Timer
            guard [.running].contains(_state) else { return }
            
            // æš«åœ Timer
            timer?.suspend()
            
            // åˆ‡æ›åˆ° suspended ç‹€æ…‹
            _state = .suspended
        }
    }

    // æ¢å¾© Timer
    func resume() {
        operation { [weak self] in
            guard let self = self else { return }
            // åªæœ‰åœ¨ suspended ç‹€æ…‹å¯ä»¥æ¢å¾© Timer
            guard [.suspended].contains(_state) else { return }
            
            // æ¢å¾© Timer
            timer?.resume()
            
            // åˆ‡æ›åˆ° running ç‹€æ…‹
            _state = .running
        }
    }

    // çµ‚æ­¢ Timer
    func cancel() {
        operation { [weak self] in
            guard let self = self else { return }
            // åªæœ‰åœ¨ suspended, running ç‹€æ…‹å¯ä»¥çµ‚æ­¢ Timer
            guard [.suspended, .running].contains(_state) else { return }
            
            // å¦‚æœç•¶å‰æ˜¯ suspended ç‹€æ…‹ï¼Œå…ˆ resume() å†çµ‚æ­¢
            // æ­¤ç‚º DispatchSourceTimer çš„é™åˆ¶ï¼Œåªèƒ½åœ¨ running æ‰èƒ½ cancel()
            if _state == .suspended {
                self.resume()
            }
            
            // çµ‚æ­¢ Timer
            timer?.cancel()
            timer = nil
            
            // åˆ‡æ›åˆ° cancelled ç‹€æ…‹
            _state = .cancelled
        }
    }
    
    private func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> DispatchSourceTimer {
        let timer = DispatchSource.makeTimerSource(queue: timerQueue)
        timer.schedule(deadline: .now(), repeating: repeatTimeInterval)
        timer.setEventHandler(qos: .background, handler: handler)
        return timer
    }
}
```

ç¾åœ¨ï¼Œæˆ‘å€‘å¯ä»¥å®‰å…¨ç„¡æ†‚çš„ä½¿ç”¨ `DispatchSourceTimerMachine` ç‰©ä»¶ä½œç‚º Timer äº†:
```typescript
final class TrackingEventSender {

    private let timerMachine = DispatchSourceTimerMachine()
    public var events: [String: String] = []

    // å•Ÿå‹•å®šæœŸ tracking
    func startTracking() {
        timerMachine.activate(repeatTimeInterval: .seconds(30)) { [weak self] in
            self?.sendTrackingEvent()
        }
    }

    // æš«åœ trackingï¼ˆä¾‹å¦‚ App é€²èƒŒæ™¯ï¼‰
    func pauseTracking() {
        timerMachine.suspend()
    }

    // æ¢å¾© trackingï¼ˆä¾‹å¦‚ App å›å‰æ™¯ï¼‰
    func resumeTracking() {
        timerMachine.resume()
    }

    // åœæ­¢ trackingï¼ˆä¾‹å¦‚é é¢é›¢é–‹ï¼‰
    func stopTracking() {
        timerMachine.cancel()
    }

    private func sendTrackingEvent() {
        // send events to server...
    }
}
```

åˆ°æ­¤å¦‚ä½•å®‰å…¨çš„ä½¿ç”¨ DispatchSourceTimer ç’°ç¯€å·²çµæŸï¼Œå†ä¾†å»¶ä¼¸å¹¾å€‹ Design Patterns çš„ä½¿ç”¨ï¼Œæ–¹ä¾¿æˆ‘å€‘æŠ½è±¡ç‰©ä»¶é€²è¡Œæ¸¬è©¦è·Ÿ DispatchSourceHandler åŸ·è¡Œé‚è¼¯æŠ½è±¡ã€‚
#### å»¶ä¼¸ â€” ä½¿ç”¨ Adapter Pattern \+ Factory Pattern ç”¢ç”Ÿ DispatchSourceTimer \(åˆ©æ–¼æŠ½è±¡æ¸¬è©¦\)

DispatchSourceTimer æ˜¯ GCD çš„ Objective\-C ç‰©ä»¶ï¼Œåœ¨æ¸¬è©¦ç’°ç¯€æˆ‘å€‘å¾ˆé›£å°å…¶ Mock \(ç„¡ Protocol\)ï¼›å› æ­¤æˆ‘å€‘éœ€è¦è‡ªå·±å®šç¾©ä¸€å±¤ Protocol \+ Factory Pattern ç”¢ç”Ÿï¼Œè®“ TimerStateMachine æ˜¯èƒ½å¯«æ¸¬è©¦çš„ã€‚

**Adapter Patternâ€” å°è£ DispatchSourceTimer æ“ä½œ:**
```swift
public protocol TimerAdapter {
    func schedule(repeating: DispatchTimeInterval)
    func setEventHandler(handler: DispatchSourceProtocol.DispatchSourceHandler?)
    func activate()
    func suspend()
    func resume()
    func cancel()
}

// DispatchSourceTimer çš„ Adapter å¯¦ç¾
final class DispatchSourceTimerAdapter: TimerAdapter {
    // åŸå§‹çš„ DispatchSourceTimer
    private let timer: DispatchSourceTimer

    init(label: String = "li.zhgchg.DispatchSourceTimerAdapter") {
        let queue = DispatchQueue(label: label, qos: .background)
        let timer = DispatchSource.makeTimerSource(queue: queue)
        self.timer = timer
    }

    func schedule(repeating: DispatchTimeInterval) {
        timer.schedule(deadline: .now(), repeating: repeating)
    }

    func setEventHandler(handler: DispatchSourceProtocol.DispatchSourceHandler?) {
        timer.setEventHandler(qos: .background, handler: handler)
    }

    func activate() {
        timer.activate()
    }

    func suspend() {
        timer.suspend()
    }

    func resume() {
        timer.resume()
    }

    func cancel() {
        timer.cancel()
    }
}
```

**Factory Pattern â€” æŠ½è±¡ç”¢ç”Ÿ TimerAdapter çš„æ–¹æ³•:**
```swift
protocol DispatchSourceTimerAdapterFactorySpec {
    func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> TimerAdapter
}

// å°è£ DispatchSourceTimerAdapter ç”¢ç”Ÿæ­¥é©Ÿ
final class DispatchSourceTimerAdapterFactory: DispatchSourceTimerAdapterFactorySpec {
    public func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> TimerAdapter {
        let timer = DispatchSourceTimerAdapter()
        timer.schedule(repeating: repeatTimeInterval)
        timer.setEventHandler(handler: handler)
        return timer
    }
}
```

**çµ„åˆä½¿ç”¨:**
```swift
var stateMachine = DispatchSourceTimerMachine(timerFactory: DispatchSourceTimerAdapterFactory())

//
final class DispatchSourceTimerMachine {
    // ç•¥..
    private var timer: TimerAdapter?
    private let timerFactory: DispatchSourceTimerAdapterFactorySpec
    public init(timerFactory: DispatchSourceTimerAdapterFactorySpec) {
        self.timerFactory = timerFactory
    }
    // ç•¥..

    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        onQueue { [weak self] in
            guard let self else { return }
            guard [.idle, .cancelled].contains(_state) else { return }
            // ä½¿ç”¨ Factory MakeTimer
            let timer = timerFactory.makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
            self.timer = timer

            timer.activate()
            _state = .running
        }
    }

    // ç•¥..
}
```

é€™æ¨£æˆ‘å€‘å°±èƒ½å° `TimerAdapter` / `DispatchSourceTimerAdapterFactorySpec` åœ¨æ¸¬è©¦ç’°ç¯€æ’°å¯« Mock Object è·‘å–®å…ƒæ¸¬è©¦ã€‚
#### å»¶ä¼¸ â€” ä½¿ç”¨ **_Strategy_** Pattern å°è£ DispatchSourceHandler å·¥ä½œ

å‡è¨­æˆ‘å€‘çš„ DispatchSourceHandler å¸Œæœ›åŸ·è¡Œçš„äº‹èƒ½å‹•æ…‹æ”¹è®Šï¼Œå¯ä»¥ä½¿ç”¨ Strategy Pattern ä¾†å°è£å·¥ä½œå…§å®¹ã€‚

**TrackingHandlerStrategy:**
```swift
protocol TrackingHandlerStrategy {
    static var target: String { get }
    func execute()
}

// Home Event
final class HomeTrackingHandlerStrategy: TrackingHandlerStrategy {
    static var target: String = "home"
    func execute() {
       // fetch home event logs..and send
    }
}

// Product Event
final class ProductTrackingHandlerStrategy: TrackingHandlerStrategy {
    static var target: String = "product"
    func execute() {
       // fetch product event logs..and send
    }
}
```

**çµ„åˆä½¿ç”¨ï¼š**
```swift
var sender = TrackingEventSender()
sender.register(event: HomeTrackingHandlerStrategy())
sender.register(event: ProductTrackingHandlerStrategy())
sender.startTracking()

// ...

//

final class TrackingEventSender {

    private let timerMachine = DispatchSourceTimerMachine()
    private var events: [String: TrackingHandlerStrategy] = [:]

    // è¨»å†Šéœ€è¦çš„ Event ç­–ç•¥
    func register(event: TrackingHandlerStrategy) {
        events[type(of: event).target] = event
    }

    func retrive<T: TrackingHandlerStrategy>(event: T.Type) -> T? {
        return events[event.target] as? T
    }

    // å•Ÿå‹•å®šæœŸ tracking
    func startTracking() {
        timerMachine.activate(repeatTimeInterval: .seconds(30)) { [weak self] in
            self?.events.values.forEach { event in
                event.execute()
            }
        }
    }

    // æš«åœ trackingï¼ˆä¾‹å¦‚ App é€²èƒŒæ™¯ï¼‰
    func pauseTracking() {
        timerMachine.suspend()
    }

    // æ¢å¾© trackingï¼ˆä¾‹å¦‚ App å›å‰æ™¯ï¼‰
    func resumeTracking() {
        timerMachine.resume()
    }

    // åœæ­¢ trackingï¼ˆä¾‹å¦‚é é¢é›¢é–‹ï¼‰
    func stopTracking() {
        timerMachine.cancel()
    }
}
```
#### é³´è¬

æ„Ÿè¬ [Ethan Huang](https://medium.com/u/e13f6afcf9b9){:target="_blank"} å¤§å¤§ Donate çš„ **5 Beers** :


[![](https://c7.patreon.com/https%3A%2F%2Fwww.patreon.com%2F%2Fcard-teaser-image%2Fcreator%2F6512681%3Fc=4366071272298850039/selector/%23creator-teaser%2C.png)](https://www.patreon.com/cw/ethanhuang13/home?vanity=ethanhuang13){:target="_blank"}



> _çš„ç¢ºå¿«åŠå¹´æ²’å¯«ä»€éº¼äº†ï¼Œæ–°å·¥ä½œå‰›åˆ°è·ï¼ŒæŒçºŒæ‰¾å°‹éˆæ„Ÿä¸­ï¼ğŸ’ª_ 
 

> ä¸‹ä¸€ç¯‡å¯èƒ½åˆ†äº« Fastlane Match æ†‘è­‰ç®¡ç†è·Ÿ Self\-hosted Runner çš„å»ºç½®éç¨‹\. \.æˆ–æ˜¯ Bitbucket Pipeline\. \.æˆ–æ˜¯ AppStoreConnect APIâ€¦ 




### å»¶ä¼¸é–±è®€
- [**Design Patterns çš„å¯¦æˆ°æ‡‰ç”¨ç´€éŒ„ \(å°è£ Sockiet\.io\)**](../78507a8de6a5/)
- [Design Patterns çš„å¯¦æˆ°æ‡‰ç”¨ç´€éŒ„ \(å°è£ WKWebView\)](../f4b02ee342a4/)
- [Visitor Pattern in Swift](../ba5773a7bfea/)
- [Visitor Pattern in TableView](../60473cb47550/)


æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ [èˆ‡æˆ‘è¯çµ¡](https://www.zhgchg.li/contact){:target="_blank"} ã€‚




_[Post](https://dev.zhgchg.li/ios-timer-%E8%88%87-dispatchsourcetimer-%E5%A6%82%E4%BD%95%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E7%9A%84%E4%BD%BF%E7%94%A8-62f68ebeecd3){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}._