---
author: ZhgChgLi
categories:
- ZRealmã®é–‹ç™º
date: 2018-10-16T16:01:24.511+0000
description: Swiftã‚’ä½¿ã£ãŸVisionã®é¡”èªè­˜æ©Ÿèƒ½ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’è‡ªå‹•ã§ãƒˆãƒªãƒŸãƒ³ã‚°ã€‚æ‰‹é–“ã‚’çœãã€æ­£ç¢ºãªé¡”æ¤œå‡ºã§ã‚¢ãƒ—ãƒªã®ä½¿ã„ã‚„ã™ã•ã‚’å¤§å¹…æ”¹å–„ã—ã¾ã™ã€‚
image:
  path: /assets/9a9aa892f9a9/1*c-ioRH_Z2nMYRxSbuBD71A.png
last_modified_at: 2024-08-13T08:17:24.185+0000
render_with_liquid: false
tags:
- swift
- æ©Ÿæ¢°å­¦ç¿’
- é¡”èªè­˜
- ios
- iosã‚¢ãƒ—ãƒªé–‹ç™º
- japanese
- ai-translation
title: Visionã§å®Ÿç¾ï½œSwiftã‚¢ãƒ—ãƒªã®é¡”èªè­˜è‡ªå‹•ãƒˆãƒªãƒŸãƒ³ã‚°ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š
---

### Vision åˆæ¢ â€” APPã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§é¡”ã‚’è‡ªå‹•èªè­˜ã—ã¦ãƒˆãƒªãƒŸãƒ³ã‚° (Swift)

Vision å®Ÿè·µå¿œç”¨

### [2024/08/13 æ›´æ–°]

- æ–°ã—ã„è¨˜äº‹ã€æ–°ã—ã„APIã‚’ã”å‚ç…§ãã ã•ã„ï¼šã€Œ [iOS Vision framework x WWDC 24 Discover Swift enhancements in the Vision framework Session](../755509180ca8/) ã€

#### åŒã˜ãå¤šãã¯èªã‚‰ãšã€ã¾ãšã¯å®Œæˆå›³ã‚’ãŠè¦‹ã›ã—ã¾ã™ï¼š

![æœ€é©åŒ–å‰ V.S æœ€é©åŒ–å¾Œ â€” [çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/9a9aa892f9a9/1*c-ioRH_Z2nMYRxSbuBD71A.png)

æœ€é©åŒ–å‰ V.S æœ€é©åŒ–å¾Œ â€” [çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}

å…ˆæ—¥iOS 12ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€æ–°ãŸã«å…¬é–‹ã•ã‚ŒãŸCoreMLæ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«æ³¨ç›®ã—ã¾ã—ãŸã€‚ã¨ã¦ã‚‚é¢ç™½ãã†ã ã¨æ€ã„ã€ç¾åœ¨ã®è£½å“ã§ã©ã“ã«æ´»ç”¨ã§ãã‚‹ã‹ã‚’è€ƒãˆå§‹ã‚ã¾ã—ãŸã€‚

> **CoreMLã®åˆä½“é¨“è¨˜äº‹ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼š [æ©Ÿæ¢°å­¦ç¿’ã‚’ä½¿ã£ã¦è¨˜äº‹ã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•äºˆæ¸¬ã€ãƒ¢ãƒ‡ãƒ«ã‚‚è‡ªåˆ†ã§è¨“ç·´](../793bf2cdda0f/)**

CoreMLã¯æ–‡å­—ã‚„ç”»åƒã®æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®è¨“ç·´ãŠã‚ˆã³APPã¸ã®çµ„ã¿è¾¼ã¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ç§ã®å½“åˆã®è€ƒãˆã¯ã€CoreMLã‚’ä½¿ã£ã¦é¡”èªè­˜ã‚’è¡Œã„ã€APPå†…ã§ãƒˆãƒªãƒŸãƒ³ã‚°æ™‚ã«é ­ã‚„é¡”ãŒåˆ‡ã‚Œã¦ã—ã¾ã†å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ã§ã—ãŸã€‚ä¸Šå›³å·¦ã®ã‚ˆã†ã«ã€é¡”ãŒç«¯ã«ã‚ã‚‹ã¨æ‹¡å¤§ï¼‹ãƒˆãƒªãƒŸãƒ³ã‚°ã§é¡”ãŒä¸å®Œå…¨ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚

ãƒãƒƒãƒˆæ¤œç´¢ã‚’ã—ã¦åˆã‚ã¦ã€è‡ªåˆ†ã®çŸ¥è­˜ä¸è¶³ã«æ°—ã¥ãã¾ã—ãŸã€‚ã“ã®æ©Ÿèƒ½ã¯iOS 11ã§æ—¢ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã‚‹ã€ŒVisionã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€æ–‡å­—æ¤œå‡ºã€é¡”æ¤œå‡ºã€ç”»åƒæ¯”è¼ƒã€QRã‚³ãƒ¼ãƒ‰æ¤œå‡ºã€ç‰©ä½“è¿½è·¡ãªã©ã®æ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã¯é¡”æ¤œå‡ºã®é …ç›®ã§ã‚ã‚Šã€æœ€é©åŒ–å¾Œã¯å³ã®ç”»åƒã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚é¡”ã‚’æ¤œå‡ºã—ã€ãã‚Œã‚’ä¸­å¿ƒã«ã—ã¦ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã¾ã™ã€‚

### å®Ÿè·µé–‹å§‹ï¼š

#### ã¾ãšã¯é¡”ã®ä½ç½®ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹æ©Ÿèƒ½ã‚’ä½œã‚Šã€Visionã®ä½¿ã„æ–¹ã‚’ç°¡å˜ã«ç†è§£ã—ã¾ã—ã‚‡ã†

![Demo APP](/assets/9a9aa892f9a9/1*cpGgpXsBhuiJoZI03WAGUw.png)

Demoã‚¢ãƒ—ãƒª

å®Œæˆå›³ã¯ä¸Šè¨˜ã®é€šã‚Šã§ã€å†™çœŸã®ä¸­ã®é¡”ã®ä½ç½®ã‚’ãƒãƒ¼ã‚¯ã§ãã¾ã™ã€‚

p.s ã€Œé¡”ã€ã®ã¿ã‚’ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„ã€‚é«ªã®æ¯›ã‚’å«ã‚€é ­å…¨ä½“ã¯ä¸å¯ã§ã™ğŸ˜…

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸»ã«äºŒã¤ã®éƒ¨åˆ†ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚ç¬¬ä¸€éƒ¨åˆ†ã¯ã€ç”»åƒã®å…ƒã®ã‚µã‚¤ã‚ºã‚’ImageViewã«ç¸®å°ãƒ»æ‹¡å¤§ã—ã¦å…¥ã‚ŒãŸã¨ãã«ä½™ç™½ãŒã§ãã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ã§ã™ã€‚ç°¡å˜ã«è¨€ã†ã¨ã€ç”»åƒã®ã‚µã‚¤ã‚ºãŒã„ãã¤ã§ã‚ã‚Œã°ã€ImageViewã®ã‚µã‚¤ã‚ºã‚‚åŒã˜ã«ã—ãŸã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚ç›´æ¥ç”»åƒã‚’å…¥ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚ºãƒ¬ãŒç™ºç”Ÿã—ã¾ã™ã€‚

![](/assets/9a9aa892f9a9/1*Mb70Ed6pALO-8sllCpb7Qg.png)

ContentModeã‚’ç›´æ¥fillã€fitã€redrawã«å¤‰æ›´ã™ã‚‹ã¨ã€ç”»åƒãŒå¤‰å½¢ã—ãŸã‚Šåˆ‡ã‚Œã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```swift
let ratio = UIScreen.main.bounds.size.width
// ã“ã“ã§ã¯UIImageViewã®å·¦å³ã‚’0ã«æƒãˆã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’1:1ã«è¨­å®šã—ã¦ã„ã‚‹ãŸã‚

let sourceImage = UIImage(named: "Demo2")?.kf.resize(to: CGSize(width: ratio, height: CGFloat.leastNonzeroMagnitude), for: .aspectFill)
// KingFisherã®ç”»åƒãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’ä½¿ã„ã€å¹…ã‚’åŸºæº–ã«é«˜ã•ã¯è‡ªç”±ã«è¨­å®š

imageView.contentMode = .redraw
// contentModeã‚’redrawã«ã—ã¦ç”»åƒã‚’åŸ‹ã‚ã‚‹

imageView.image = sourceImage
// ç”»åƒã‚’ã‚»ãƒƒãƒˆ

imageViewConstraints.constant = (ratio - (sourceImage?.size.height ?? 0))
imageView.layoutIfNeeded()
imageView.sizeToFit()
// ã“ã“ã§imageViewã®Constraintsã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã€‚è©³ç´°ã¯è¨˜äº‹æœ«ã®å®Œå…¨ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚ç…§
```

ä»¥ä¸Šã¯ç”»åƒå‡¦ç†ã«é–¢ã™ã‚‹èª¬æ˜ã§ã™ã€‚

*ãƒˆãƒªãƒŸãƒ³ã‚°éƒ¨åˆ†ã¯Kingfisherã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„è‡ªä½œã®æ–¹æ³•ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™*

ç¬¬äºŒéƒ¨åˆ†ã€æ ¸å¿ƒã«å…¥ã‚Šã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥è¦‹ã‚‹

```swift
if #available(iOS 11.0, *) {
    // iOS 11ä»¥é™ã§ã‚µãƒãƒ¼ãƒˆ
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if let faceObservations = request.results as? [VNFaceObservation] {
            // æ¤œå‡ºã•ã‚ŒãŸé¡”
            
            DispatchQueue.main.async {
                // UIViewã®æ“ä½œã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã†
                let size = self.imageView.frame.size
                
                faceObservations.forEach({ (faceObservation) in
                    // åº§æ¨™ç³»ã®å¤‰æ›
                    let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
                    let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
                    let transRect =  faceObservation.boundingBox.applying(translate).applying(transform)
                    
                    let markerView = UIView(frame: transRect)
                    markerView.backgroundColor = UIColor.init(red: 0/255, green: 255/255, blue: 0/255, alpha: 0.3)
                    self.imageView.addSubview(markerView)
                })
            }
        } else {
            print("é¡”ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
        }
    }
    
    // æ¤œå‡ºãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        // æ¤œå‡ºã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€èƒŒæ™¯ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã—ç”»é¢ã®ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("ã‚¨ãƒ©ãƒ¼ï¼š\(error)")
        }
    }
  
} else {
    //
    print("ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“")
}
```

ä¸»ã«æ³¨æ„ã™ã¹ãã¯åº§æ¨™ç³»ã®å¤‰æ›éƒ¨åˆ†ã§ã™ã€‚èªè­˜ã•ã‚ŒãŸçµæœã¯ç”»åƒã®å…ƒã®åº§æ¨™ã§ã‚ã‚Šã€ãã‚Œã‚’å¤–å´ã®ImageViewã®å®Ÿéš›ã®åº§æ¨™ã«å¤‰æ›ã—ã¦åˆã‚ã¦æ­£ã—ãä½¿ç”¨ã§ãã¾ã™ã€‚

#### æ¬¡ã«ã€æœ¬æ—¥ã®ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ â€” é¡”ã®ä½ç½®ã«åŸºã¥ã„ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®æ­£ã—ã„ä½ç½®ã‚’åˆ‡ã‚ŠæŠœãæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™

```php
let ratio = UIScreen.main.bounds.size.width
// ã“ã“ã§ã¯UIImageViewã®å·¦å³ã‚’0ã«æƒãˆã€ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’1:1ã«è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚è©³ç´°ã¯è¨˜äº‹æœ«ã®å®Œå…¨ã‚µãƒ³ãƒ—ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

let sourceImage = UIImage(named: "Demo")

imageView.contentMode = .scaleAspectFill
// scaleAspectFillãƒ¢ãƒ¼ãƒ‰ã§ç”»åƒã‚’åŸ‹ã‚ã‚‹

imageView.image = sourceImage
// å…ƒã®ç”»åƒã‚’ç›´æ¥ã‚»ãƒƒãƒˆã—ã€å¾Œã§æ“ä½œã—ã¾ã™

if let image = sourceImage,#available(iOS 11.0, *),let ciImage = CIImage(image: image) {
    let completionHandle: VNRequestCompletionHandler = { request, error in
        if request.results?.count == 1,let faceObservation = request.results?.first as? VNFaceObservation {
            // é¡”ãŒ1ã¤æ¤œå‡ºã•ã‚ŒãŸå ´åˆ
            let size = CGSize(width: ratio, height: ratio)
            
            let translate = CGAffineTransform.identity.scaledBy(x: size.width, y: size.height)
            let transform = CGAffineTransform(scaleX: 1, y: -1).translatedBy(x: 0, y: -size.height)
            let finalRect =  faceObservation.boundingBox.applying(translate).applying(transform)
            
            let center = CGPoint(x: (finalRect.origin.x + finalRect.width/2 - size.width/2), y: (finalRect.origin.y + finalRect.height/2 - size.height/2))
            // é¡”ã®ç¯„å›²ã®ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—
            
            let newImage = image.kf.resize(to: size, for: .aspectFill).kf.crop(to: size, anchorOn: center)
            // ä¸­å¿ƒç‚¹ã‚’åŸºæº–ã«ç”»åƒã‚’ã‚¯ãƒ­ãƒƒãƒ—
            
            DispatchQueue.main.async {
                // UIViewã®æ“ä½œã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§è¡Œã†
                self.imageView.image = newImage
            }
        } else {
            print("é¡”ãŒè¤‡æ•°æ¤œå‡ºã•ã‚ŒãŸã‹ã€æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ")
        }
    }
    let baseRequest = VNDetectFaceRectanglesRequest(completionHandler: completionHandle)
    let faceHandle = VNImageRequestHandler(ciImage: ciImage, options: [:])
    DispatchQueue.global().async {
        do{
            try faceHandle.perform([baseRequest])
        }catch{
            print("ã‚¨ãƒ©ãƒ¼ï¼š\(error)")
        }
    }
} else {
    print("éå¯¾å¿œã§ã™")
}
```

é“ç†ã¯é¡”ã®ä½ç½®ã‚’ãƒãƒ¼ã‚¯ã™ã‚‹å ´åˆã¨ã»ã¼åŒã˜ã§ã™ãŒã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®éƒ¨åˆ†ã¯å›ºå®šã‚µã‚¤ã‚ºï¼ˆä¾‹ï¼š300x300ï¼‰ãªã®ã§ã€æœ€åˆã®Imageã‚’ImageViewã«é©å¿œã•ã›ã‚‹éƒ¨åˆ†ã¯çœç•¥ã—ã¾ã™ã€‚

ã‚‚ã†ä¸€ã¤ã®é•ã„ã¯ã€é¡”ã®ç¯„å›²ã®ä¸­å¿ƒç‚¹ã‚’è¨ˆç®—ã—ã€ãã®ä¸­å¿ƒç‚¹ã‚’åŸºæº–ã«ç”»åƒã‚’ãƒˆãƒªãƒŸãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã™ã€‚

![é¡”ã®ç¯„å›²ã®ä¸­å¿ƒç‚¹ã‚’ç¤ºã™èµ¤ã„ç‚¹](/assets/9a9aa892f9a9/1*civytcKOguHfVFHYPVWecA.png)

èµ¤ã„ç‚¹ã¯é¡”ã®ç¯„å›²ã®ä¸­å¿ƒç‚¹ã§ã™

#### å®ŒæˆåŠ¹æœå›³ï¼š

![é “ä¸¹å‰ã®ãã®ä¸€ç¬ã¯å…ƒç”»åƒã®ä½ç½®](/assets/9a9aa892f9a9/1*WocYjt0xLkqtGVilxfT2LA.gif)

é “ä¸¹å‰ã®ãã®ä¸€ç§’ã¯å…ƒã®ç”»åƒã®ä½ç½®ã§ã™

### å®Œå…¨ãªAPPã‚µãƒ³ãƒ—ãƒ«:

![](/assets/9a9aa892f9a9/1*J8oByw8gBCamIac2TkT1SA.gif)

ã‚³ãƒ¼ãƒ‰ã¯Githubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ï¼š[ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯](https://github.com/zhgchgli0718/VisionDemo){:target="_blank"}

ã”è³ªå•ã‚„ã”æ„è¦‹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€[ãŠå•ã„åˆã‚ã›](https://www.zhgchg.li/contact){:target="_blank"} ãã ã•ã„ã€‚

*[Post](https://medium.com/zrealm-ios-dev/vision-%E5%88%9D%E6%8E%A2-app-%E9%A0%AD%E5%83%8F%E4%B8%8A%E5%82%B3-%E8%87%AA%E5%8B%95%E8%AD%98%E5%88%A5%E4%BA%BA%E8%87%89%E8%A3%81%E5%9C%96-swift-9a9aa892f9a9){:target="_blank"} ã¯ Medium ã‹ã‚‰ [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"} ã«ã‚ˆã£ã¦å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚*