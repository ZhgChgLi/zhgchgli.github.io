---
author: ZhgChgLi
categories:
- ZRealmの開発
date: 2018-10-17T15:20:35.448+0000
description: iOS開発者向けにCoreML 2.0を使ったモデル変換と自作トレーニングの方法を紹介。機械学習で記事分類を自動化し、実用的なアプリ開発を実現します。
image:
  path: /assets/793bf2cdda0f/1*pOYPHRwPNLVtikVKzfIqsw.png
last_modified_at: 2024-04-13T07:17:02.794+0000
render_with_liquid: false
tags:
- swift
- ios
- 機械学習
- 自然言語処理
- iosアプリ開発
- japanese
- ai-translation
title: CoreMLで記事分類を自動予測｜iOS 12でモデル自作＆活用法を徹底解説
---

### iOS 12 CoreMLを試す — 機械学習で記事分類を自動予測、モデルも自分で訓練！

CoreML 2.0を探る：モデルの変換や訓練、そして実際の製品への応用方法

接続 [前回の記事](../9a9aa892f9a9/) に続き、iOSでの機械学習の研究について、本稿では正式にCoreMLの使用に入ります。

まず歴史を簡単に説明すると、Appleは2017年にCoreML（前回の記事で紹介したVisionを含む）機械学習フレームワークを発表しました。2018年にはCoreML 2.0をリリースし、[性能向上](https://www.appcoda.com.tw/core-ml-2/){:target="_blank"}に加え、**カスタムCoreMLモデルの作成**もサポートしました。

#### はじめに

もし「機械学習」という言葉を聞いたことはあるが意味がよくわからない場合、ここで一言で簡単に説明します：

> **「過去の経験に基づいて未来の同じ事象の結果を予測する」**

> 例えば：私は卵クレープにケチャップをかけます。何度か買いに行くと、朝食店の店主の女性は覚えていて、「イケメン、ケチャップつける？」と聞いてきます。私が「はい」と答えると、店主の女性の予測は正しいです。もし「いいえ、なぜなら大根餅＋卵クレープだから」と答えると、店主の女性はそれを覚えて、次回同じ状況で予測を修正します。

> 入力データ：蛋餅、チーズ蛋餅、蛋餅+大根餅、大根餅、卵

> 出力データ：ケチャップをかける／かけない

> モデル：女将の記憶と判断

実は私も機械学習については、概念や理論を単に知っているだけで、実際に深く理解したことはありません。もし間違いがあれば、どうぞご指導ください。

ここでぜひアップルの神様に感謝🙏を捧げたいです。機械学習を製品化し、基本的な概念さえわかれば操作できるようにして、膨大な知識がなくても始められる敷居を下げてくれました。私自身もこのサンプルを実装して初めて、機械学習に触れた実感が湧き、この分野に強い興味を持つようになりました。

#### 開始

最初のステップで最も重要なのは、前述した「モデル」です。モデルはどこから来るのでしょうか？

三つの方法があります：

- ネットで他人が訓練したモデルを探し、CoreML形式に変換する

[Awesome-CoreML-Models](https://github.com/likedan/Awesome-CoreML-Models){:target="_blank"} このGitHubプロジェクトは、多くの他人が訓練したモデルを集めています。

モデル変換については、[公式サイト](https://developer.apple.com/machine-learning/build-run-models/){:target="_blank"} やネットの情報を参照してください。

- 蘋果 [Machine Learning公式サイト](https://developer.apple.com/machine-learning/build-run-models/){:target="_blank"} の最下部にある Download Core ML Models から、アップルが訓練したモデルをダウンロードできます（主に学習やテスト用です）

- **ツールを使って自分でモデルを訓練🏆**

#### だから、何ができるのか？

- 画像認識 **🏆**

- **テキスト内容分類🏆**

- 文字の分割

- 文字言語の判定

- 固有表現抽出

分かち書きについては [iOSアプリでの自然言語処理入門：NSLinguisticTaggerの使い方](https://www.appcoda.com.tw/nslinguistictagger/){:target="_blank"} を参照してください。

### 今日の主なポイント — 文字内容認識分類＋ **自分でモデルを訓練**

つまり、機械に「文章の内容」と「分類」を与えて、将来のデータを分類できるように訓練します。例えば：「最新のキャンペーンを見るにはクリック！」、「1000ドルのショッピングクーポンを今すぐゲット」=>「広告」；「Alanがメッセージを送信しました」、「あなたのアカウントがまもなく期限切れになります」=>「重要事項」

実際の応用：スパムメール判別、ラベル生成、分類予測

*p.s 画像認識については、何を学習させるかまだ考えていないので、調べていません。興味のある方は[こちら](https://www.jianshu.com/p/28ed4eff68d1){:target="_blank"}を参照してください。公式の画像用GUI学習ツールがあり、とても便利です！！*

**必要なツール：** MacOS Mojave以上 + Xcode 10

**訓練ツール：** [BlankSpace007/TextClassiferPlayground](https://github.com/BlankSpace007/TextClassiferPlayground){:target="_blank"} （公式は**画像用のGUI訓練ツール**のみ提供しており、文字用は自作が必要です；これはネットの有志が提供するサードパーティ製ツールです）

#### トレーニングデータの準備：

![資料構造は上記の図の通りで、.json、.csvファイルをサポートしています](/assets/793bf2cdda0f/1*bqKGHErvqhd6gIKCnvve4Q.png)

データ構造は上図の通りで、.json と .csv ファイルに対応しています。

訓練用のデータを準備します。ここではPhpmyadmin（Mysql）を使って訓練データをエクスポートします。

```sql
SELECT `title` AS `text`,`type` AS `label` FROM `posts` WHERE `status` = '1'
```

![エクスポート形式をJSONに変更](/assets/793bf2cdda0f/1*fc10j10OzmI2TGemaqlDmw.png)

エクスポート形式をJSONフォーマットに変更する

```json
[
  {"type":"header","version":"4.7.5","comment":"PHPMyAdmin用のJSONエクスポートプラグイン"},
  {"type":"database","name":"db"},
  {"type":"table","name":"posts","database":"db","data":
    //以上削除
    [
      {
         "label":"",
         "text":""
      }
    ]
    //以下削除
  }
]
```

ダウンロードしたJSONファイルを開き、中央のDATA構造の内容だけを残す

#### 訓練ツールの使用：

トレーニングツールをダウンロードしたら、TextClassifer.playground をクリックしてPlaygroundを開きます。

![赤枠をクリックして実行 -> 緑枠をクリックしてView表示を切り替え](/assets/793bf2cdda0f/1*ct9AHpetBuEKHDGfRwvMlg.png)

赤枠をクリックして実行 -> 緑枠をクリックしてビュー表示を切り替え

![JSONファイルをGUIツールにドラッグする](/assets/793bf2cdda0f/1*kV_Dh2pP94gUakcmYcI6bQ.png)

JSONファイルをGUIツールにドラッグ＆ドロップする

![下のコンソールを開いてトレーニングの進捗を確認し、「テスト正解率」という行が表示されたらモデルのトレーニングが完了したことを意味します](/assets/793bf2cdda0f/1*NIyGqbNaArovIDEPK6Ynhg.png)

下のコンソールを開いて訓練の進行状況を確認し、「テスト正答率」という行が表示されたらモデルの訓練が完了しています。

データが多すぎると、あなたのコンピュータの処理能力が試されます。

![基本情報を入力後、「保存」を押す](/assets/793bf2cdda0f/1*-jN91i4v0ijo6_qkCH1qwg.png)

基本情報を入力した後、「保存」を押してください

訓練済みのモデルファイルを保存する

![](/assets/793bf2cdda0f/1*ML0yNr3NzRwGfBjIBzCfpg.png)

![CoreML モデルファイル](/assets/793bf2cdda0f/1*WWg3yfrgNastu0U20iiCUQ.png)

CoreML モデルファイル

これでモデルの訓練は完了です！とても簡単ですよね。

**具体的なトレーニング方法：**

1. まず入力された文章を形態素解析します（例：「我想知道婚禮需要準備什麼」→「我想」「知道」「婚禮」「需要」「準備」「什麼」）。その後、分類を確認し、一連の機械学習計算を行います。

2. 訓練データをグループ分けします。例えば、80%を訓練用、残りの20%をテスト・検証用に使います。

ここまででほとんどの作業が完了しました。あとはモデルファイルをiOSプロジェクトに追加して、数行のコードを書くだけです。

![モデルファイル(*.mlmodel)をプロジェクトにドラッグ＆ドロップ/追加する](/assets/793bf2cdda0f/1*4Uc1elBmhEnQ-J8z_RIQHQ.png)

モデルファイル（*.mlmodel）をドラッグ＆ドロップ／プロジェクトに追加する

#### プログラム部分：

```swift
import CoreML

//
if #available(iOS 12.0, *),let prediction = try? textClassifier().prediction(text: "予測したいテキスト内容") {
    let type = prediction.label
    print("私はこれだと思います...\(type)")
}
```

**完成！**

#### 探索すべき課題：

1. 再学習をサポートしていますか？

2. mlmodelモデルファイルを他のプラットフォームに変換できますか？

3. iOS上でモデルを訓練できますか？

以上の三点について、現在調べたところ、すべて不可能です。

#### 結論：

現在、実務アプリで記事投稿時の分類予測に応用しています。

![[結婚吧APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/793bf2cdda0f/1*pOYPHRwPNLVtikVKzfIqsw.png)

[結婚吧APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}

訓練に使用したデータは約100件で、現在の予測精度は約35%です。主に実験目的です。

— — — — —

これだけで簡単に、人生で最初の機械学習プロジェクトを完成させました。背景でどのように動作しているかはまだ学ぶべきことがたくさんありますが、このプロジェクトが皆さんの参考になれば幸いです！

参考資料： [WWDC2018のCreate ML(二)](https://www.jianshu.com/p/205ee896663f){:target="_blank"}

ご質問やご意見がありましたら、[こちらからご連絡ください](https://www.zhgchg.li/contact){:target="_blank"} 。

*[Post](https://medium.com/zrealm-ios-dev/%E5%9A%90%E9%AE%AE-ios-12-coreml-%E4%BD%BF%E7%94%A8%E6%A9%9F%E5%99%A8%E5%AD%B8%E7%BF%92%E8%87%AA%E5%8B%95%E9%A0%90%E6%B8%AC%E6%96%87%E7%AB%A0%E5%88%86%E9%A1%9E-%E9%80%A3%E6%A8%A1%E5%9E%8B%E4%B9%9F%E8%87%AA%E5%B7%B1%E8%A8%93%E7%B7%B4-793bf2cdda0f){:target="_blank"} Mediumから[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}によって変換されました。