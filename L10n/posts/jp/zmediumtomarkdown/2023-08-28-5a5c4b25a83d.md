---
author: ZhgChgLi
categories:
- ZRealmã®é–‹ç™º
date: 2023-08-28T14:53:27.813+0000
description: ç¾å­˜ã‚¢ãƒ—ãƒªã¨APIæ§‹é€ ã®E2Eãƒ†ã‚¹ãƒˆèª²é¡Œã‚’è§£æ±ºã€‚Local Snapshot API Mock Serverã‚’æ´»ç”¨ã—ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ã¨å‹•ä½œæ¤œè¨¼ã‚’è¿…é€ŸåŒ–ã€å“è³ªå‘ä¸Šã‚’å®Ÿç¾ã—ã¾ã™ã€‚
image:
  path: /assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg
last_modified_at: 2023-09-04T14:32:47.020+0000
render_with_liquid: false
tags:
- iosã‚¢ãƒ—ãƒªé–‹ç™º
- ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
- uiãƒ†ã‚¹ãƒˆ
- è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ
- ios
- japanese
- ai-translation
title: POC Appã®E2Eãƒ†ã‚¹ãƒˆï½œLocal Snapshot API Mock Serverã§æ—¢å­˜APIã‚’åŠ¹ç‡æ¤œè¨¼
---

### [POC] ã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆAPIãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼

æ—¢å­˜ã®AppãŠã‚ˆã³æ—¢å­˜ã®APIã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆå®Ÿç¾ã®å¯èƒ½æ€§æ¤œè¨¼

![Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg)

Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}

### ã¯ã˜ã‚ã«

é•·å¹´ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ç¨¼åƒã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã€å®‰å®šæ€§ã‚’ç¶™ç¶šçš„ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ã¯éå¸¸ã«é›£ã—ã„èª²é¡Œã§ã™ã€‚

#### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

![](/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.png)

Appã¯é–‹ç™ºè¨€èªãŒSwift/Kotlinã®é™çš„ï¼‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼‹å¼·å‹ä»˜ã‘ã€ã¾ãŸã¯Objective-Cã‹ã‚‰Swiftã¸ã®å‹•çš„ã‹ã‚‰é™çš„ã¸ã®ç§»è¡Œã§ã€é–‹ç™ºæ™‚ã«ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ä¾å­˜ã‚’åˆ‡ã‚Šé›¢ã—ã¦ã„ãªã„ãŸã‚ã€å¾Œã‹ã‚‰Unit Testingã‚’è¿½åŠ ã™ã‚‹ã®ã¯ã»ã¼ä¸å¯èƒ½ã§ã™ã€‚ã—ã‹ã—ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®éç¨‹ã§ä¸å®‰å®šè¦ç´ ã‚‚ç”Ÿã¾ã‚Œã€é¶ãŒå…ˆã‹åµãŒå…ˆã‹ã®å•é¡Œã«é™¥ã‚Šã¾ã™ã€‚

#### UIãƒ†ã‚¹ãƒˆ

UIã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚„ãƒœã‚¿ãƒ³ã®ãƒ†ã‚¹ãƒˆã¯ã€æ–°è¦é–‹ç™ºã¾ãŸã¯æ—¢å­˜ç”»é¢ã®ãƒ‡ãƒ¼ã‚¿ä¾å­˜ã‚’å°‘ã—åˆ‡ã‚Šé›¢ã™ã ã‘ã§å®Ÿç¾ã§ãã¾ã™ã€‚

#### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

èª¿æ•´å‰å¾Œã®UIè¡¨ç¤ºå†…å®¹ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚UIãƒ†ã‚¹ãƒˆã¨åŒæ§˜ã«ã€æ–°è¦é–‹ç™ºã‚„æ—¢å­˜ç”»é¢ã§ãƒ‡ãƒ¼ã‚¿ä¾å­˜ã‚’å°‘ã—åˆ†é›¢ã™ã‚Œã°å®Ÿç¾å¯èƒ½ã§ã™ã€‚

Storyboard/XIBã‹ã‚‰Code Layoutã‚„UIViewã¸ã®å¤‰æ›ã€Objective-Cã‹ã‚‰Swiftã¸ã®ç§»è¡Œã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚ç›´æ¥ [pointfreeco](https://github.com/pointfreeco){:target="_blank"} / [swift-snapshot-testing](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"} ã‚’å°å…¥ã—ã¦ç´ æ—©ãå®Ÿè£…ã§ãã¾ã™ã€‚

[![](https://opengraph.githubassets.com/b3cc52a5b949767e4cb0af82145ed6474334d3235bd785ee1f7891c6b65fd69a/pointfreeco/swift-snapshot-testing)](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"}

å¾Œã‹ã‚‰UIãƒ†ã‚¹ãƒˆã‚„ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€ã‚«ãƒãƒ¼ã§ãã‚‹ãƒ†ã‚¹ãƒˆç¯„å›²ã¯éå¸¸ã«é™ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å¤šãã®ã‚¨ãƒ©ãƒ¼ã¯UIã®ã‚¹ã‚¿ã‚¤ãƒ«ã§ã¯ãªãã€ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œã§ã‚ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œä¸­æ–­ã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚**ç‰¹ã«æ±ºæ¸ˆãƒ—ãƒ­ã‚»ã‚¹ã§ç™ºç”Ÿã™ã‚‹ã¨ã€åç›Šã«é–¢ã‚ã‚‹ãŸã‚å•é¡Œã®é‡å¤§åº¦ãŒéå¸¸ã«é«˜ããªã‚Šã¾ã™ã€‚**

### ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

å‰è¿°ã®é€šã‚Šã€ç¾è¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«è¿½åŠ ã§ããšã€å˜ä½“ãƒ†ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã¦çµ±åˆãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã‚‚ã§ããªã„ãŸã‚ã€ãƒ­ã‚¸ãƒƒã‚¯ã‚„ãƒ•ãƒ­ãƒ¼ã®ä¿è­·ã«ã¯ã€å¤–éƒ¨ã‹ã‚‰ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼ˆE2Eï¼‰ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆã—ã‹æ®‹ã£ã¦ã„ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦–ç‚¹ã§æ“ä½œãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèªã—ã€é‡è¦ãªãƒ—ãƒ­ã‚»ã‚¹ï¼ˆç™»éŒ²ï¼æ±ºæ¸ˆãªã©ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚

> é‡è¦ãªæ©Ÿèƒ½ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«å¯¾ã—ã¦ã‚‚ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆã‚’å…ˆã«ä½œæˆã—ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã«å†æ¤œè¨¼ã—ã¦ã€æ©Ÿèƒ½ãŒæœŸå¾…é€šã‚Šã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

> ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¨åŒæ™‚ã«Unit Testingã¨Integration Testingã‚’è¿½åŠ ã—ã¦å®‰å®šæ€§ã‚’å‘ä¸Šã•ã›ã€é¶ãŒå…ˆã‹åµãŒå…ˆã‹ã®å•é¡Œã‚’è§£æ¶ˆã—ã¾ã™ã€‚

#### QAãƒãƒ¼ãƒ 

End-to-End Testing ã®æœ€ã‚‚ç›´æ¥çš„ã§æ‰‹ã£å–ã‚Šæ—©ã„æ–¹æ³•ã¯ã€QAãƒãƒ¼ãƒ ã«ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã«å¾“ã£ã¦æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã‚‚ã‚‰ã„ã€ãã®å¾Œç¶™ç¶šçš„ã«æ”¹å–„ã‚„è‡ªå‹•åŒ–ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã™ã€‚ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—ã™ã‚‹ã¨ã€æœ€ä½ã§ã‚‚2åã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨1åã®ãƒªãƒ¼ãƒ€ãƒ¼ãŒåŠå¹´ã‹ã‚‰1å¹´ã‹ã‘ã¦æˆæœã‚’å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æ™‚é–“ã¨ã‚³ã‚¹ãƒˆã‚’è©•ä¾¡ã™ã‚‹ã¨ã€ç¾çŠ¶ã§ã§ãã‚‹ã“ã¨ã‚„å°†æ¥QAãƒãƒ¼ãƒ ã®ãŸã‚ã«æº–å‚™ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼ŸQAãƒãƒ¼ãƒ ãŒã§ããŸéš›ã«ã¯ã€ã™ãã«æœ€é©åŒ–ã‚„è‡ªå‹•åŒ–ã€ã•ã‚‰ã«ã¯AIã®å°å…¥ã«é€²ã‚ã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚

#### è‡ªå‹•åŒ–

ç¾æ®µéšã§ã¯è‡ªå‹•åŒ–End-to-Endãƒ†ã‚¹ãƒˆã®å°å…¥ã‚’ç›®æ¨™ã¨ã—ã€CI/CDã®å·¥ç¨‹ã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆå†…å®¹ã¯å®Œç’§ã§ã‚ã‚‹å¿…è¦ã¯ãªãã€é‡å¤§ãªãƒ—ãƒ­ã‚»ã‚¹ã®å•é¡Œã‚’é˜²ã’ã‚Œã°ååˆ†ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚å¾Œã‹ã‚‰å¾ã€…ã«ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã‚’æ”¹å–„ã—ã€ã‚«ãƒãƒ¼ç¯„å›²ã‚’æ‹¡å……ã—ã¦ã„ãã¾ã™ã€‚

### End-to-End Testing â€”æŠ€è¡“çš„ãªèª²é¡Œ

#### UI æ“ä½œã®å•é¡Œ

Appã®ä»•çµ„ã¿ã¯ã€åˆ¥ã®ãƒ†ã‚¹ãƒˆç”¨Appã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®Appã‚’æ“ä½œã—ã€View Hierarchyã‹ã‚‰å¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™å½¢ã«è¿‘ã„ã§ã™ã€‚ã¾ãŸã€ãƒ†ã‚¹ãƒˆä¸­ã«ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®Appã®ãƒ­ã‚°ã‚„å‡ºåŠ›ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãªãœãªã‚‰ã€æœ¬è³ªçš„ã«ç•°ãªã‚‹2ã¤ã®Appã ã‹ã‚‰ã§ã™ã€‚

iOSã§ã¯ã€åŠ¹ç‡ã¨æ­£ç¢ºæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«Viewã®Accessibility Identifierã‚’å……å®Ÿã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã¾ãŸAlertï¼ˆä¾‹ï¼šãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è¨±å¯è¦æ±‚ï¼‰ã«ã‚‚å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Androidã§ã¯ä»¥å‰ã®å®Ÿè£…ã§Composeã¨Fragmentã‚’æ··ç”¨ã™ã‚‹ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸãŒã€Teammateã«ã‚ˆã‚‹ã¨ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Composeã§ã¯ã™ã§ã«è§£æ±ºã•ã‚Œã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã®å¾“æ¥ã®ã‚ˆãã‚ã‚‹å•é¡Œã«åŠ ãˆã€ã•ã‚‰ã«å¤§ããªå•é¡Œã¯äºŒã¤ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®çµ±åˆãŒé›£ã—ã„ã“ã¨ï¼ˆ1ã¤ã®ãƒ†ã‚¹ãƒˆã§ä¸¡æ–¹ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ï¼‰ã§ã™ã€‚ç¾åœ¨ã€ç§ãŸã¡ã¯æ–°ã—ã„ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ« [mobile-dev-inc](https://github.com/mobile-dev-inc){:target="_blank"} / [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} ã‚’è©¦ã—ã¦ã„ã¾ã™ï¼š

[![](https://opengraph.githubassets.com/d9e6bc8b1cb6b3db5f52dd9bfa04fe2661ed172d7be82155b8f3e4b6c874f821/mobile-dev-inc/maestro)](https://github.com/mobile-dev-inc/maestro){:target="_blank"}

YAMLã§ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã‚’æ›¸ãã€ä¸¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚è©³ç´°ãªä½¿ã„æ–¹ã‚„ä½¿ç”¨æ„Ÿã«ã¤ã„ã¦ã¯ã€åˆ¥ã®ãƒãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã®è¨˜äº‹å…±æœ‰ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚ccâ€™ed [Alejandra Ts.](https://medium.com/u/1139df7a27f3){:target="_blank"} ğŸ˜ã€‚

#### API ãƒ‡ãƒ¼ã‚¿ã®å•é¡Œ

Appã®E2Eãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹æœ€å¤§ã®å¤‰æ•°ã¯APIãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã§ããªã„ã¨ã€ãƒ†ã‚¹ãƒˆã®ä¸å®‰å®šã•ãŒå¢—ã—ã€èª¤æ¤œçŸ¥ãŒç™ºç”Ÿã—ã€æœ€çµ‚çš„ã«ã¯ãƒ†ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã¸ã®ä¿¡é ¼ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã€å•†å“ãŒè²©å£²åœæ­¢ã‚„æ¶ˆå¤±ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ã“ã‚Œã‚‰ã®çŠ¶æ…‹å¤‰åŒ–ãŒã‚¢ãƒ—ãƒªã§åˆ¶å¾¡ã§ããªã„å ´åˆã€ä¸Šè¨˜ã®ã‚ˆã†ãªçŠ¶æ³ãŒç™ºç”Ÿã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ãªã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚„ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã‚„ã€Open APIã‚’åŸºã«ã—ãŸè‡ªå‹•ç”Ÿæˆãƒ¢ãƒƒã‚¯APIã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹æ–¹æ³•ã§ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚„APIã®å¤–éƒ¨è¦å› ã«ä¾å­˜ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚‚ã‚¢ãƒ—ãƒªã¨åŒæ§˜ã«é•·å¹´ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ç¨¼åƒã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Šã€ä¸€éƒ¨ã®ä»•æ§˜ã¯ã¾ã ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ãŸã‚ã€ç¾æ™‚ç‚¹ã§ã¯ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨æ„ã§ãã¾ã›ã‚“ã€‚

ä»¥ä¸Šã®è¦å› ã«åŸºã¥ãã€ã“ã“ã§ç«‹ã¡æ­¢ã¾ã£ã¦ã‚‚å•é¡Œã¯å¤‰ã‚ã‚‰ãšã€é¶ãŒå…ˆã‹åµãŒå…ˆã‹ã®å•é¡Œã‚‚çªç ´ã§ãã¾ã›ã‚“ã€‚çµå±€ã¯ã€Œæ€ã„åˆ‡ã£ã¦å…ˆã«å¤‰æ›´ã—ã€å•é¡ŒãŒèµ·ããŸã‚‰å¯¾å‡¦ã™ã‚‹ã€ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

#### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆAPIãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼

> ã€Œè€ƒãˆãŒã¶ã‚Œãªã‘ã‚Œã°ã€æ–¹æ³•ã¯å›°é›£ã‚ˆã‚Šã‚‚å¿…ãšå¤šã„ã€

UIã®Snapshotã§ç”»åƒã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦Replayã§æ¤œè¨¼ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ãªã‚‰ã€APIã§ã‚‚åŒæ§˜ã«ã§ãã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ  
APIã®Requestã¨Responseã‚’ä¿å­˜ã—ã¦ã€å¾Œã§Replayã—ã¦æ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ã¯å¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**æœ¬è¨˜äº‹ã®ãƒã‚¤ãƒ³ãƒˆï¼šSnapshot API Local Mock Serverã®æ§‹ç¯‰ã«ã‚ˆã‚‹APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è¨˜éŒ²ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†ç”Ÿã€APIãƒ‡ãƒ¼ã‚¿ã¸ã®ä¾å­˜ã‹ã‚‰ã®åˆ‡ã‚Šé›¢ã—ã€‚**

> æœ¬æ–‡ã¯POCã®æ¦‚å¿µæ¤œè¨¼ã®ã¿ã‚’è¡Œã£ã¦ãŠã‚Šã€ã¾ã é«˜ã„ã‚«ãƒãƒ¬ãƒƒã‚¸ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Œå…¨ã«å®Ÿè£…ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€æœ¬æ‰‹æ³•ã¯å‚è€ƒä¾‹ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚**ç¾çŠ¶ã®ç’°å¢ƒã§æ–°ãŸãªæ°—ã¥ãã¨ãªã‚Œã°å¹¸ã„ã§ã™**ã€‚

### ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆAPIãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼

#### ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ â€” APIãƒ‡ãƒ¼ã‚¿ã®éŒ²ç”»ã¨å†ç”Ÿ

**[Record]** â€” End-to-Endãƒ†ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹é–‹ç™ºå®Œäº†å¾Œã€éŒ²ç”»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚ªãƒ³ã«ã—ã¦ãƒ†ã‚¹ãƒˆã‚’ä¸€åº¦å®Ÿè¡Œã™ã‚‹ã¨ã€ã™ã¹ã¦ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

**[Replay]** â€” ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®Ÿè¡Œæ™‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å¯¾å¿œã™ã‚‹éŒ²ç”»æ¸ˆã¿ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ†ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã—ã¾ã™ã€‚

#### å›³ç¤º

è³¼å…¥ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã¨ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã‚’é–‹ãã€ãƒ›ãƒ¼ãƒ ç”»é¢ã§å•†å“ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ã«å…¥ã‚Šã€ä¸‹éƒ¨ã®è³¼å…¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Œäº†ã—ã€è³¼å…¥ã‚’å®Œäº†ã™ã‚‹ã¨ã€è³¼å…¥æˆåŠŸã®é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

![](/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.png)

UIãƒ†ã‚¹ãƒˆã§ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ã®å…¥åŠ›ãªã©ã‚’åˆ¶å¾¡ã™ã‚‹æ–¹æ³•ã¯ã€æœ¬è¨˜äº‹ã®ä¸»ãªç ”ç©¶å¯¾è±¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ç›´æ¥å‚ç…§ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚

#### ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã¾ãŸã¯ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·

Record & Replay APIã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€Appã¨APIã®é–“ã«Proxyã‚’æŒŸã‚“ã§ä¸­é–“è€…æ”»æ’ƒã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯ç§ã®ä»¥å‰ã®è¨˜äº‹ã€Œ[APPã¯HTTPSé€šä¿¡ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã«ã€ãƒ‡ãƒ¼ã‚¿ãŒç›—ã¾ã‚ŒãŸã€‚](../46410aaada00/)ã€ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

ç°¡å˜ã«è¨€ã†ã¨ã€Appã¨APIã®é–“ã«ä»£ç†ã®ä¼é”è€…ãŒä¸€äººå¢—ãˆãŸã‚ˆã†ãªã‚‚ã®ã§ã€ã¾ã‚‹ã§ãƒ¡ãƒ¢ã‚’æ¸¡ã™ã‚ˆã†ã«ã€åŒæ–¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã™ã¹ã¦å½¼ã‚’çµŒç”±ã—ã¾ã™ã€‚å½¼ã¯ãƒ¡ãƒ¢ã®å†…å®¹ã‚’é–‹ã„ã¦ç¢ºèªã§ãã‚‹ã—ã€ãƒ¡ãƒ¢ã®å†…å®¹ã‚’å½é€ ã—ã¦åŒæ–¹ã«æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€åŒæ–¹ã¯ã‚ãªãŸãŒä»‹å…¥ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã›ã‚“ã€‚

**æ­£å‘ãƒ—ãƒ­ã‚­ã‚· Regular Proxyï¼š**

æ­£ã®ãƒ—ãƒ­ã‚­ã‚·ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã®å¿œç­”ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™ä»•çµ„ã¿ã§ã™ã€‚æ­£ã®ãƒ—ãƒ­ã‚­ã‚·ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä»£è¡¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· Reverse Proxyï¼š**

ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¯ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ã¨ã¯é€†ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é–“ã«ä½ç½®ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã€ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¯ä¸€å®šã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ã—ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰è¦‹ã‚‹ã¨ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã¯ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ã‚ˆã†ã«è¦‹ãˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã®å®Ÿéš›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

ç§ãŸã¡ã®ãƒ‹ãƒ¼ã‚ºã«å¯¾ã—ã¦ã¯ã€ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ã‚‚ãƒªãƒãƒ¼ã‚¹ã§ã‚‚ç›®çš„ã‚’é”æˆã§ãã¾ã™ã€‚å”¯ä¸€è€ƒæ…®ã™ã¹ãç‚¹ã¯ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šæ–¹æ³•ã§ã™ï¼š

**æ­£æ–¹å‘ãƒ—ãƒ­ã‚­ã‚·ã¯ã€ãƒ‘ã‚½ã‚³ãƒ³ã‚„ã‚¹ãƒãƒ›ã€ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã§ãƒ—ãƒ­ã‚­ã‚·ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š**

- Androidã¯ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼å†…ã§å€‹åˆ¥ã«ãƒ—ãƒ­ã‚­ã‚·ã‚’ç›´æ¥è¨­å®šã§ãã¾ã™

- iOS Simulatorã¯ãƒ‘ã‚½ã‚³ãƒ³ã¨åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®ãŸã‚ã€å€‹åˆ¥ã«Proxyã‚’è¨­å®šã§ãã¾ã›ã‚“ã€‚ãƒ‘ã‚½ã‚³ãƒ³ã®è¨­å®šã‚’å¤‰æ›´ã—ã¦Proxyã‚’é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ‘ã‚½ã‚³ãƒ³ã®ã™ã¹ã¦ã®é€šä¿¡ãŒã“ã®Proxyã‚’çµŒç”±ã—ã¾ã™ã€‚ã¾ãŸã€åŒæ™‚ã«Proxymanã‚„Charlesãªã©ä»–ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰ã®ã‚½ãƒ•ãƒˆãŒProxyè¨­å®šã‚’å¼·åˆ¶çš„ã«å¤‰æ›´ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€å‹•ä½œã—ãªããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

**ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¯ã€Codebaseå†…ã®APIãƒ›ã‚¹ãƒˆã‚’å¤‰æ›´ã—ã€ä»£ç†ã™ã‚‹ã™ã¹ã¦ã®APIãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å®£è¨€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š**

- Codebaseå†…ã®APIãƒ›ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®IPã«ç½®ãæ›ãˆã‚‹

- ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’æœ‰åŠ¹ã«ã™ã‚‹éš›ã«ã€ã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒ—ãƒ­ã‚­ã‚·ã«ã‹ã‘ã‚‹ã‹å®£è¨€ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- å®£è¨€ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿ãŒãƒ—ãƒ­ã‚­ã‚·ã‚’é€šã‚Šã€å®£è¨€ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã¯ç›´æ¥æ¥ç¶šã•ã‚Œã¾ã™ã€‚

> iOSã‚¢ãƒ—ãƒªã«åˆã‚ã›ã¦ã€ä»¥ä¸‹ã¯iOSã¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã£ãŸPOCã®ä¾‹ã§ã™ã€‚Androidã§ã‚‚åŒæ§˜ã«ä½¿ç”¨å¯èƒ½ã§ã™ã€‚

#### iOSã‚¢ãƒ—ãƒªã«ç¾åœ¨End-to-Endãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜ã•ã›ã‚‹æ–¹æ³•

Appã«ç¾åœ¨End-to-Endãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œä¸­ã§ã‚ã‚‹ã“ã¨ã‚’èªè­˜ã•ã›ã€Appå†…ã§APIãƒ›ã‚¹ãƒˆã®ç½®æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```
// UIãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ:
let app = XCUIApplication()
app.launchArguments = ["duringE2ETesting"]
app.launch()
```

ç§ãŸã¡ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ã§åˆ¤å®šã¨å·®ã—æ›¿ãˆã‚’è¡Œã„ã¾ã™ã€‚

> ã“ã‚Œã¯ã‚„ã‚€ã‚’å¾—ãªã„èª¿æ•´ã§ã™ãŒã€ã§ãã‚‹ã ã‘ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«Appã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

### MITMProxyã‚’ä½¿ã£ãŸãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…

> Swiftã§ç‹¬è‡ªã«Swiftã‚µãƒ¼ãƒãƒ¼ã‚’é–‹ç™ºã—ã¦å®Ÿç¾ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€æœ¬è¨˜äº‹ã¯POCã®ãŸã‚ã€ç›´æ¥MITMProxyãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

#### [2023â€“09â€“04 æ›´æ–°] Mitmproxy-rodo ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã•ã‚Œã¾ã—ãŸ

ä»¥ä¸‹ã®å®Ÿè£…å†…å®¹ã¯ã™ã§ã« [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ãœã²ç›´æ¥å‚ç…§ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚

[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}

ä¸€éƒ¨ã®æ§‹æˆã¨æœ¬è¨˜äº‹ã®å†…å®¹ãŒèª¿æ•´ã•ã‚Œã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–æ™‚ã«å¾Œç¶šã®èª¿æ•´ãŒè¡Œã‚ã‚Œã¾ã—ãŸï¼š

- ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ã‚’ `host / requestPath / method / hash` ã«å¤‰æ›´ã™ã‚‹

- Headeræƒ…å ±ã®ä¿å­˜ã‚’ä¿®æ­£ã—ã€ç´”ç²‹ãªJSONæ–‡å­—åˆ—ã§ã¯ãªããƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹

- ä¸€éƒ¨ã®èª¤ã‚Šã‚’ä¿®æ­£ã™ã‚‹

- Set-Cookie ã®æœ‰åŠ¹æœŸé™è‡ªå‹•å»¶é•·æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹

> **âš ï¸ ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ‡ãƒ¢å‚è€ƒç”¨ã®ã¿ã§ã‚ã‚Šã€ä»Šå¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª¿æ•´ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚**

> **âš ï¸ ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ‡ãƒ¢å‚è€ƒç”¨ã®ã¿ã§ã‚ã‚Šã€ä»Šå¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª¿æ•´ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚**

> **âš ï¸ ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ‡ãƒ¢å‚è€ƒç”¨ã®ã¿ã§ã‚ã‚Šã€ä»Šå¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª¿æ•´ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚**

> **âš ï¸ ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚ãã¾ã§ãƒ‡ãƒ¢ç”¨ã®å‚è€ƒã§ã™ã€‚ä»Šå¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª¿æ•´ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã—ã¾ã™ã€‚**

> **âš ï¸ ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ‡ãƒ¢å‚è€ƒç”¨ã®ã¿ã§ã‚ã‚Šã€ä»Šå¾Œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª¿æ•´ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ã•ã‚Œã¾ã™ã€‚**

#### [MITMProxy](https://mitmproxy.org){:target="_blank"}

[MITMProxy å®˜ç¶²](https://mitmproxy.org){:target="_blank"} ã«å¾“ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Œäº†ã—ã¦ãã ã•ã„ï¼š

```bash
brew install mitmproxy
```

MITMProxy ã®è©³ç´°ãªä½¿ã„æ–¹ã¯ã€ä»¥å‰ã®è¨˜äº‹ã€Œ[APPã¯HTTPSã§é€šä¿¡ã—ã¦ã„ã‚‹ãŒã€ãã‚Œã§ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒç›—ã¾ã‚ŒãŸã€‚](../46410aaada00/)ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- `mitmproxy` ã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

- `mitmweb` ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã®ã‚°ãƒ©ãƒ•ã‚£ã‚«ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

- `mitmdump` ã¯éå¯¾è©±å‹ã®ç«¯æœ«å‡ºåŠ›ã‚’æä¾›ã—ã¾ã™ã€‚

#### Record & Replay ã®å®Ÿç¾

MITMProxyã®ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è¨˜éŒ²ï¼ˆRecordã¾ãŸã¯dumpï¼‰ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†ç”Ÿï¼ˆMapping Request Replayï¼‰æ©Ÿèƒ½ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã«æŒã£ã¦ã„ãªã„ãŸã‚ã€ã“ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«è‡ªä½œã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿…è¦ã§ã™ã€‚

`mock.py` :

```python
"""
ä¾‹:
    éŒ²ç”»: mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
    å†ç”Ÿ: mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
"""

import re
import logging
import mimetypes
import os
import json
import hashlib

from pathlib import Path
from mitmproxy import ctx
from mitmproxy import http

class MockServerHandler:

    def load(self, loader):
        self.readHistory = {}
        self.configuration = {}

        loader.add_option(
            name="dumper_folder",
            typespec=str,
            default="dump",
            help="ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ€ãƒ³ãƒ—ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€‚ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åã”ã¨ã«ä½œæˆå¯èƒ½",
        )

        loader.add_option(
            name="network_restricted",
            typespec=bool,
            default=True,
            help="ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ... trueãªã‚‰404ã‚’è¿”ã—ã€falseãªã‚‰å®Ÿéš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚",
        )

        loader.add_option(
            name="record",
            typespec=bool,
            default=False,
            help="trueã«è¨­å®šã™ã‚‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’éŒ²ç”»ã—ã¾ã™",
        )

        loader.add_option(
            name="config_file",
            typespec=str,
            default="",
            help="è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜å‚ç…§",
        )
    
    def configure(self, updated):
        self.loadConfig()

    def loadConfig(self):
        configFile = Path(ctx.options.config_file)
        if ctx.options.config_file == "" or not configFile.exists():
            return

        self.configuration = json.loads(open(configFile, "r").read())

    def hash(self, request):
        query = request.query
        requestPath = "-".join(request.path_components)

        ignoredQueryParameterByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("queryParamters", [])
        ignoredQueryParameterGlobal = self.configuration.get("ignored", {}).get("global", {}).get("queryParamters", [])

        filteredQuery = []
        if query:
            filteredQuery = [(key, value) for key, value in query.items() if key not in ignoredQueryParameterByPaths + ignoredQueryParameterGlobal]
        
        formData = []
        if request.get_content() != None and request.get_content() != b'':
            formData = json.loads(request.get_content())
        
        # ã¾ãŸã¯ formData = request.urlencoded_form
        # ã¾ãŸã¯ formData = request.multipart_form
        # APIè¨­è¨ˆã«ã‚ˆã‚‹

        ignoredFormDataParametersByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("formDataParameters", [])
        ignoredFormDataParametersGlobal = self.configuration.get("ignored", {}).get("global", {}).get("formDataParameters", [])

        filteredFormData = []
        if formData:
            filteredFormData = [(key, value) for key, value in formData.items() if key not in ignoredFormDataParametersByPaths + ignoredFormDataParametersGlobal]
        
        # è¾æ›¸ã‚’JSONæ–‡å­—åˆ—ã«ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
        hashData = {"query":sorted(filteredQuery), "form": sorted(filteredFormData)}
        json_str = json.dumps(hashData, sort_keys=True)

        # SHA-256ãƒãƒƒã‚·ãƒ¥é–¢æ•°ã‚’é©ç”¨
        hash_object = hashlib.sha256(json_str.encode())
        hash_string = hash_object.hexdigest()
        
        return hash_string

    def readFromFile(self, request):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        if not folder.exists():
            return None

        content_type = request.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"


        count = self.readHistory.get(host, {}).get(method, {}).get(requestPath, {}) or 0

        filepath = folder / f"Content-{str(count)}{ext}"

        while not filepath.exists() and count > 0:
            count = count - 1
            filepath = folder / f"Content-{str(count)}{ext}"

        if self.readHistory.get(host) is None:
            self.readHistory[host] = {}
        if self.readHistory.get(host).get(method) is None:
            self.readHistory[host][method] = {}
        if self.readHistory.get(host).get(method).get(requestPath) is None:
            self.readHistory[host][method][requestPath] = {}

        if filepath.exists():
            headerFilePath = folder / f"Header-{str(count)}.json"
            if not headerFilePath.exists():
                headerFilePath = None
            
            count += 1
            self.readHistory[host][method][requestPath] = count

            return {"content": filepath, "header": headerFilePath}
        else:
            return None


    def saveToFile(self, request, response):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        iterable = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("iterable", False)
        
        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œæˆ
        if not folder.exists():
            os.makedirs(folder)

        content_type = response.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"

        repeatNumber = 0
        filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        while filepath.exists() and iterable == False:
            repeatNumber += 1
            filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
        with open(filepath, "wb") as f:
            f.write(response.content or b'')
            
        
        headerFilepath = folder / f"Header-{str(repeatNumber)}.json"
        with open(headerFilepath, "wb") as f:
            responseDict = dict(response.headers.items())
            responseDict['_status_code'] = response.status_code
            f.write(json.dumps(responseDict).encode('utf-8'))

        return {"content": filepath, "header": headerFilepath}

    def request(self, flow):
        if ctx.options.record != True:
            host = flow.request.host
            path = flow.request.path

            result = self.readFromFile(flow.request)
            if result is not None:
                content = b''
                headers = {}
                statusCode = 200

                if result.get('content') is not None:
                    content = open(result['content'], "r").read()

                if result.get('header') is not None:
                    headers = json.loads(open(result['header'], "r").read())
                    statusCode = headers['_status_code']
                    del headers['_status_code']

                
                headers['_responseFromMitmproxy'] = '1'
                flow.response = http.Response.make(statusCode, content, headers)
                logging.info("ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã—ãŸ: "+str(result['content']))
                return

            if ctx.options.network_restricted == True:
                flow.response = http.Response.make(404, b'', {'_responseFromMitmproxy': '1'})
        
    def response(self, flow):
        if ctx.options.record == True and flow.response.headers.get('_responseFromMitmproxy') != '1':
            result = self.saveToFile(flow.request, flow.response)
            logging.info("ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸ: "+str(result['content']))

addons = [MockServerHandler()]
```

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.mitmproxy.org/stable/api/events.html){:target="_blank"}ã‚’å‚ç…§ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

**ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­è¨ˆãƒ­ã‚¸ãƒƒã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š**

- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼š `dumper_folderï¼ˆåˆ¥åãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹åï¼‰` / `ãƒªãƒãƒ¼ã‚¹ã®APIãƒ›ã‚¹ãƒˆ` / `HTTPãƒ¡ã‚½ãƒƒãƒ‰` / `ãƒ‘ã‚¹ã‚’-ã§çµåˆ`ï¼ˆä¾‹ï¼š`app/launch` -> `app-launch`ï¼‰ / `ãƒãƒƒã‚·ãƒ¥ï¼ˆã‚¯ã‚¨ãƒªã¨POSTå†…å®¹ã‚’å–å¾—ï¼‰` /

- ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ï¼š`Content-0.xxx`ã€`Content-1.xxx`ï¼ˆåŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’2å›ç›®ã«é€ä¿¡ï¼‰â€¦ä»¥ä¸‹åŒæ§˜ï¼›ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ï¼š`Header-0.json`ï¼ˆ`Content-x`ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰

![](/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.png)

- ä¿å­˜æ™‚ã¯ãƒ‘ã‚¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®è«–ç†ã«å¾“ã£ã¦é †ç•ªã«ä¿å­˜ã•ã‚Œã¾ã™ï¼›Replayæ™‚ã‚‚åŒæ§˜ã«é †ç•ªã«å–ã‚Šå‡ºã•ã‚Œã¾ã™

- å›æ•°ãŒä¸€è‡´ã—ãªã„å ´åˆã€ä¾‹ãˆã°Replayæ™‚ã«åŒã˜ãƒ‘ã‚¹ãŒ3å›å‘¼ã°ã‚ŒãŸãŒã€Recordã§ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒ2å›ç›®ã¾ã§ã—ã‹ãªã„å ´åˆã¯ã€2å›ç›®ã€ã¤ã¾ã‚Šæœ€å¾Œã®çµæœã‚’è¿”ã—ç¶šã‘ã¾ã™ã€‚

- `record` ãŒ `True` ã®å ´åˆã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã—ã€ä¸Šè¨˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã«å¾“ã£ã¦ä¿å­˜ã—ã¾ã™ã€‚`False` ã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ã ã‘ã§ã™ï¼ˆReplayãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰ã€‚

- `network_restricted` ãŒ `False` ã®å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ç›´æ¥ `404` ã‚’è¿”ã—ã¾ã™ï¼›`True` ã®å ´åˆã¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚

- `_responseFromMitmproxy` ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾ã—ã¦ç¾åœ¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰æ¥ã¦ã„ã‚‹ã“ã¨ã‚’é€šçŸ¥ã—ã€ç„¡è¦–ã—ã¦ã‚ˆã„ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚`_status_code` ã¯ Header.json ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚

`config_file.json` **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š**

```json
{
  "ignored": {
    "paths": {
      "yourapihost.com": {
        "add-to-cart": {
          "POST": {
            "queryParamters": [
              "created_timestamp"
            ],
            "formDataParameters": []
          }
        },
        "api-status-checker": {
          "GET": {
            "iterable": true
          }
        }
      }
    },
    "global": {
      "queryParamters": [
        "timestamp"
      ],
      "formDataParameters": []
    }
  }
}
```

`queryParamters` **ï¼† `formDataParameters` ï¼š**

ä¸€éƒ¨ã®APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å‘¼ã³å‡ºã—ã”ã¨ã«å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ™‚é–“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã®è¨­è¨ˆã«ã‚ˆã‚Šã€`Hash(Query Parameter & Body Content)` ã®å€¤ãŒReplayãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ç•°ãªã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã§ããªããªã‚Šã¾ã™ã€‚ãã“ã§ã€ã“ã®çŠ¶æ³ã«å¯¾å¿œã™ã‚‹ãŸã‚ã« `config.json` ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚Endpointãƒ‘ã‚¹ã”ã¨ã‚„ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã€ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã‹ã‚‰é™¤å¤–ã™ã‚‹è¨­å®šãŒã§ãã€åŒã˜ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚

`iterable` **ï¼š**

ä¸€éƒ¨ã®ãƒãƒ¼ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯APIã¯å®šæœŸçš„ã«ç¹°ã‚Šè¿”ã—å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã®è¨­è¨ˆä¸Šã€å¤šãã® `Content-x.xxx` ã¨ `Header-x.json` ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã—ã‹ã—ã€æ°—ã«ã—ãªã„å ´åˆã¯ `True` ã«è¨­å®šã™ã‚‹ã¨ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯å¸¸ã« `Content-0.xxx` ã¨ `Header-0.json` ã®æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¸Šæ›¸ãä¿å­˜ã•ã‚Œã¾ã™ã€‚

**ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·éŒ²ç”»ãƒ¢ãƒ¼ãƒ‰ã®æœ‰åŠ¹åŒ–ï¼š**

```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
```

**ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ãƒªãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã®æœ‰åŠ¹åŒ–ï¼š**

```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
```

### çµ„ã¿ç«‹ã¦ & Proof Of Concept

#### 0. Codebaseå†…ã®Hostã®å·®ã—æ›¿ãˆå®Œäº†

ãã—ã¦ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«APIãŒ `http://127.0.0.1:8080` ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

#### 1. Snapshot API ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ï¼ˆåˆ¥åãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ï¼‰éŒ²ç”»ãƒ¢ãƒ¼ãƒ‰ã®èµ·å‹•

```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=addCart --set config_file=config.json
```

#### 2. E2Eãƒ†ã‚¹ãƒˆã®UIæ“ä½œã®å®Ÿè¡Œ

[Pinkoi iOS App](https://apps.apple.com/tw/app/pinkoi-%E4%BA%9E%E6%B4%B2%E9%A0%98%E5%85%88%E8%B7%A8%E5%A2%83%E8%A8%AD%E8%A8%88%E8%B3%BC%E7%89%A9%E7%B6%B2%E7%AB%99/id557252416){:target="_blank"} ã‚’ä¾‹ã«ã€ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼š

> ã‚¢ãƒ—ãƒªèµ·å‹• -> ãƒ›ãƒ¼ãƒ  -> ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ -> ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆã«ä¼¼ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -> æœ€åˆã®è£½å“ -> æœ€åˆã®è£½å“ã‚’ã‚¯ãƒªãƒƒã‚¯ -> è£½å“ãƒšãƒ¼ã‚¸ã«å…¥ã‚‹ -> ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã‚’ã‚¯ãƒªãƒƒã‚¯ -> UIã§ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã®åå¿œ -> ãƒ†ã‚¹ãƒˆæˆåŠŸ âœ…

![](/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.png)

UIã®è‡ªå‹•æ“ä½œæ–¹æ³•ã¯å‰è¿°ã—ã¾ã—ãŸãŒã€ã“ã“ã§ã¯ã¾ãšæ‰‹å‹•ã§åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦çµæœã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

#### 3. Recordçµæœã®å–å¾—

æ“ä½œå®Œäº†ã‚‰ `^ + C` ã§ Snapshot API Mock Server ã‚’çµ‚äº†ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§éŒ²ç”»çµæœã‚’ç¢ºèªã§ãã¾ã™ï¼š

![](/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.png)

#### 4. Replayã§åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¤œè¨¼ã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã¨Replayãƒ¢ãƒ¼ãƒ‰ã®ä½¿ç”¨

```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=addCart --set config_file=config.json
```

#### 5. å…ˆã»ã©ã®UIæ“ä½œã‚’å†åº¦å®Ÿè¡Œã—ã¦çµæœã‚’æ¤œè¨¼ã™ã‚‹

![](/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.png)

- å·¦ï¼šãƒ†ã‚¹ãƒˆæˆåŠŸ âœ…

- å³ï¼šéŒ²ç”»ã—ã¦ã„ãªã„å•†å“ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒãªãã€`network_restricted` ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒ `False` ã®ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç›´æ¥404ã‚’è¿”ã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã›ã‚“ï¼‰ã€‚

#### 6. Proof Of Concept âœ…

æ¦‚å¿µå®Ÿè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è‡ªåˆ†ã§ä¿å­˜ã—ã¦ã€ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯APIã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦Appã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ãŒç¢ºã‹ã«å¯èƒ½ã§ã™ ğŸ‰ğŸ‰ğŸ‰ã€‚

### [2023â€“09â€“04] mitmproxy-rodo ãŒã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã•ã‚Œã¾ã—ãŸ

[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}

### ä»Šå¾Œã®äºˆå®šã¨é›‘è¨˜

æœ¬æ–‡ã¯æ¦‚å¿µå®Ÿè¨¼ã®ã¿ã‚’æ‰±ã£ã¦ãŠã‚Šã€ä»Šå¾Œè£œå®Œã™ã¹ãç‚¹ã‚„å®Ÿè£…å¯èƒ½ãªæ©Ÿèƒ½ãŒã¾ã å¤šãã‚ã‚Šã¾ã™ã€‚

1. [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} UIãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¨ã®çµ±åˆ

2. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆè¨­è¨ˆï¼ˆãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’è‡ªå‹•èµ·å‹•ã™ã‚‹æ–¹æ³•ã¨è¨­ç½®å ´æ‰€ï¼‰

3. MITMProxyã‚’é–‹ç™ºãƒ„ãƒ¼ãƒ«ã«çµ„ã¿è¾¼ã‚€æ–¹æ³•ã¯ï¼Ÿ

4. ã‚ˆã‚Šè¤‡é›‘ãªãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®æ¤œè¨¼

5. **é€ä¿¡ã•ã‚ŒãŸTracking Requestã®æ¤œè¨¼ã«ã¯ã€Request Bodyã‚’ä¿å­˜ã—ã€ã©ã®Tracking Event DataãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã€ã¾ãŸãƒ—ãƒ­ã‚»ã‚¹ã«æ²¿ã£ãŸé©åˆ‡ãªã‚¤ãƒ™ãƒ³ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**

#### Cookie ã®å•é¡Œ

```python
#...
    def response(self, flow):
        setCookies = flow.response.headers.get_all("set-cookie")
        # setCookies = ['ad=0; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/', 'sessionid=xxxx; Secure; HttpOnly; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/']
        
        # ã¾ãŸã¯ Cookie ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ .xxx.com ã‹ã‚‰ 127.0.0.1 ã«ç½®æ›
        setCookies = [re.sub(r"\s*\.xxx\.com\s*", "127.0.0.1", s) for s in setCookies]

        # ãã—ã¦ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®åˆ¶é™ã‚’å‰Šé™¤
        setCookies = [re.sub(r";\s*Secure\s*", "", s) for s in setCookies]
        setCookies = [re.sub(r";\s*HttpOnly;\s*", "", s) for s in setCookies]

        flow.response.headers.set_all("Set-Cookie", setCookies)

        #...
```

Cookieã«é–¢ã™ã‚‹å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã€ä¾‹ãˆã°APIãŒCookieã‚’è¿”ã—ã¦ã„ã‚‹ã®ã«AppãŒå—ã‘å–ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ä¸Šè¨˜ã®èª¿æ•´ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

#### Pinkoiã®æœ€å¾Œã®è¨˜äº‹ã§

Pinkoiã§ã®900æ—¥ä»¥ä¸Šã®æ™‚é–“ã®ä¸­ã§ã€ç§ã®ã‚­ãƒ£ãƒªã‚¢ã‚„iOS / Appé–‹ç™ºã€ãƒ—ãƒ­ã‚»ã‚¹ã«é–¢ã™ã‚‹å¤šãã®æƒ³åƒã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚ã™ã¹ã¦ã®ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«æ„Ÿè¬ã—ã¾ã™ã€‚å…±ã«ãƒ‘ãƒ³ãƒ‡ãƒŸãƒƒã‚¯ã‚’ä¹—ã‚Šè¶Šãˆã€å›°é›£ã‚’çµŒé¨“ã—ã¾ã—ãŸã€‚åˆ¥ã‚Œã®å‹‡æ°—ã¯ã€å¤¢ã‚’è¿½ã„ã‹ã‘ã¦å…¥ç¤¾ã—ãŸã‚ã®æ™‚ã®å‹‡æ°—ã¨åŒã˜ã§ã™ã€‚

> [**æ–°ã—ã„äººç”Ÿã®æŒ‘æˆ¦ï¼ˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã«é™ã‚‰ãšï¼‰ã‚’æ±‚ã‚ã¦èˆªæµ·ä¸­ã§ã™ã€‚iOSã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã€æ–°è¦ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãªã©é©ã—ãŸæ©Ÿä¼šãŒã‚ã‚Œã°ã”é€£çµ¡ãã ã•ã„ã€‚**](http://resume.zhgchg.li/){:target="_blank"} ğŸ™ğŸ™ğŸ™

ã”è³ªå•ã‚„ã”æ„è¦‹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€[ã“ã¡ã‚‰ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„](https://www.zhgchg.li/contact){:target="_blank"} ã€‚

*[Post](https://medium.com/zrealm-ios-dev/poc-app-end-to-end-testing-local-snapshot-api-mock-server-5a5c4b25a83d){:target="_blank"} ã¯ Medium ã‹ã‚‰ [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"} ã«ã‚ˆã£ã¦å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚*