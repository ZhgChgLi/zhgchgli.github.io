---
author: ZhgChgLi
categories:
- ZRealmの生活
date: 2020-04-20T14:37:49.536+0000
description: 在宅勤務の生産性向上に、樹莓派を使ったHomeBridgeで米家家電をHomeKitに統合。スマホ一つで家電操作が可能になり、快適なスマートホーム環境を構築します。
image:
  path: /assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg
last_modified_at: 2024-04-13T08:16:28.468+0000
render_with_liquid: false
tags:
- homekit
- iphone
- homebridge
- 米家
- 生活
- japanese
- ai-translation
title: WFHに最適｜HomeBridgeで米家家電をHomeKitに一括連携し快適スマートホーム実現
---

### 快適な在宅勤務（WFH）スマートホーム環境の構築、家電の操作は指先ひとつで

樹莓派を HomeBridge ホストとして使用し、すべてのMi Home家電をHomeKitに接続する方法のデモ

![photo by [picjumbo.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}](/assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg)

photo by [picjumbo.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}

### について

コロナ禍の影響で、自宅で過ごす時間が長くなりました。特に在宅勤務の場合、家の電化製品をすべてアプリでスマートに操作できれば、いちいち離れて照明をつけたり炊飯器を操作したりする必要がなく、時間の無駄を減らせます。

以前に「[**スマートホーム初体験 — Apple HomeKit & Xiaomi Mi Home**](../c3150cdc85dd/)**」を書きました。HomeBridgeを使ってXiaomiの家電をHomeKitに接続する試みで、理論上は可能でしたが、実際の応用例はあまり多くありませんでした。今回の記事は前回の内容を総合した応用版で、ラズベリーパイをメイン機として選ぶ場合の設定方法を最初から最後まで手取り足取り解説します。

起因は最近 iPhone 11 Pro に買い替えたことで、iOS 13 以上のショートカットのNFC自動化機能が使えるようになったからです。つまり、スマホがNFCタグを感知すると対応するショートカットを実行できます。**古い悠遊カードをNFCタグとして使うこともできます**が、場所を取るしカードもそんなに多くありません。光華商場で探しましたがNFCタグのシールは売っておらず、最終的に蝦皮で1枚50元で5枚購入しました。販売者は色分けしてくれてとても親切でした。

![](/assets/99db2a1fbfe5/1*6ftbgAxlvmdv-35of98ohA.jpeg)

**NFC自動化機能は機種に紐づいており、iPhone XS/XS Max/XR/11/11 Pro/11 Pro Maxのみが対応しています。以前のiPhone 8ではNFCのオプションがまったくありませんでした。**

少し触ってみて気づいた問題があります。米家アプリのショートカットを実行する際、「実行時に表示」オプションを必ずオンにしないと（そうしないと実際に実行されません）、タグを感知して実行するときにiPhoneのロック解除が必要で、実行時もショートカットが開くため、バックグラウンドで直接感知して実行することができません。一方、ショートカットが純正Appleサービス（例：HomeKitの家電）の場合は、バックグラウンドかつロック解除不要で直接実行できます。また、HomeKitの反応速度と安定性は米家よりもずっと優れています。

これは使い勝手に大きな差があるため、さらに深く調査して米家スマートホームシリーズの製品をすべてHomeKitに接続しました。HomeKit対応のものは直接連携し、本記事では詳述しません。非対応のものは本記事の手順に従って連携しています！

### 私のMi Homeスマートホームプロジェクト

1. 米家スマートカメラ PTZ版 1080P

2. 米家DCインバーターファン

3. 米家 LED スマートデスクライト

4. 小米空気清浄機 3

5. 米家デスクライト Pro（元々 HomeKit 対応）

6. 米家 LED スマート電球 カラー版 * 2 （HomeKit 対応済み）

### 動作原理

![](/assets/99db2a1fbfe5/1*7p0ehajJqdqb4-_w9uHt7g.jpeg)

簡単な参考図を作成しました。もしスマート家電がHomeKitに対応していれば、直接接続できます。**対応していないスマート家電は「HomeBridge」サービスホスト（常時起動が必要）を構築することで接続可能です**。同じネットワーク環境（例：同じWiFi）内では、iPhoneからHomeKit内のすべての家電を自由に操作できます。しかし、外部ネットワーク（例：4Gモバイルネットワーク）では、**Apple TV/HomePodまたはiPadを家庭のハブとして自宅に置き（こちらも常時起動が必要）、**外出先からHomeKitを操作する必要があります。家庭のハブがない場合、外出先でホームアプリを開くと「**応答なし**」と表示されます。

> *もし米家の場合は、米家サーバーを経由して自宅の家電を制御するため、**セキュリティ上の問題があり、データはすべて中国本土を通過します**。

### 必要な環境

なので、常に待機状態にしておくデバイスは2台あります。1台は Apple TV/HomePod または iPad のホームハブです。この部分は現時点で解決策がなく、他の方法で代用できません。これらのデバイスを用意するしかなく、なければ自宅でのみ HomeKit を使用することになります。**。**

もう一台、24時間待機可能なパソコン（例えば、お使いのiMacやMacBook）、使っていないサーバー（古いiMacやMac Mini）、またはラズベリーパイでも構いません。

> *windowsシリーズは試していませんが、おそらく問題なく動作すると思います！

あるいは試してみたい場合は、現在のパソコンで直接使うこともできます（[前の記事](../c3150cdc85dd/)と併せてご利用ください）。

本文では、Raspberry Pi 3B と Macbook Pro (MacOS 10.15.4) を使用して、Raspberry Pi の環境設定を最初から説明します。Raspberry Pi を使わない方は、HomeBridge と HomeKit の連携部分まで直接スキップしても問題ありません（こちらは同じです）。

![Raspberry Pi 3B（特別な感謝 [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"} ）](/assets/99db2a1fbfe5/1*go-wGMdV1VVbJ3c00rh0_w.jpeg)

Raspberry Pi 3B（特別な感謝 [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"}）

**もしラズベリーパイを使う場合は、micro SDカード（大容量でなくてよく、私は8Gを使用）、カードリーダー、ネットワークケーブル（設定時に使用し、その後はWiFi接続可能）が必要です。また、ラズベリーパイに必要なソフトウェアも用意してください：**

1. [ラズベリーパイデスクトップ版OS（初心者向け、GUI版）](https://downloads.raspberrypi.org/raspbian_latest){:target="_blank"}

2. [Etcher 書き込みソフト](https://www.balena.io/etcher/){:target="_blank"}

### ラズベリーパイ環境設定

#### OSの書き込み作業

必要な2つのソフトをダウンロードした後、まずメモリーカードをカードリーダーに挿入し、パソコンに接続します。Etcher（balenaEtcher）を起動してください。

![最初にダウンロードしたラズベリーパイOS「xxxx.img」を選択し、次にメモリーカードデバイスを選び、「Flash!」をクリックして書き込みを開始します！](/assets/99db2a1fbfe5/1*3YcqdSf9z5RNqD6KJkd4Nw.png)

最初の項目でダウンロードしたRaspberry PiのOS「xxxx.img」を選択し、次にメモリーカードのデバイスを選択してから、「Flash!」をクリックして書き込みを開始します！

![この時に **MacOS のパスワード** を入力する画面が表示されます。入力後、「Ok」を押して続行してください。](/assets/99db2a1fbfe5/1*o9XE1WYrBpeKSE31Ob9gcQ.png)

この時に **MacOS のパスワード** を入力するよう求められます。入力後、「Ok」を押して続行してください。

![書き込み中…しばらくお待ちください….](/assets/99db2a1fbfe5/1*Z9oOKg9KPMpj3TZfvOvYeA.png)

書き込み中…しばらくお待ちください….

![検証中…しばらくお待ちください…](/assets/99db2a1fbfe5/1*2G930lN4q4MVs4LCeE5y1w.png)

検証中…しばらくお待ちください….

![書き込み成功！](/assets/99db2a1fbfe5/1*CEB4bAMTQshY3u7MEC3q5w.png)

書き込み成功！

> *赤いエラーが表示された場合は、メモリーカードをフォーマットしてから再度書き込みを試みてください。

カードリーダーを再度パソコンに接続し、メモリーカードのルートディレクトリに空の「ssh」ファイルを作成します（[またはこちらからダウンロード](https://drive.google.com/file/d/1vSiMkRB1-5tO1hD4YnXxUcULTnCJBIFX/view?usp=sharing){:target="_blank"}）。内容は空で拡張子は不要、単なる「ssh」ファイルです。これにより、**Terminal** を使ってラズベリーパイに接続できます。

![ssh](/assets/99db2a1fbfe5/1*aGJHebPl5MMf4iy0Um9bjg.png)

ssh

### ラズベリーパイの設定

記憶カードを取り出し、ラズベリーパイに挿入してネットワークケーブルを接続し、電源を入れます。そして、MacBookとラズベリーパイが同じネットワーク環境にあることを確認してください。

#### **ラズベリーパイに割り当てられたIPアドレスの確認**

![](/assets/99db2a1fbfe5/1*6HZ0Fqp6cgpn1F3_4UwM0Q.png)

取得した Raspberry Pi に割り当てられた IP アドレスは：**192.168.0.110（本文中のすべての IP は、ご自身で調べた結果に置き換えてください）**

> ***ラズベリーパイのIPアドレスは固定または予約設定を推奨します。そうしないと再起動後にIPアドレスが変わり、再度確認が必要になります。***

#### SSHでラズベリーパイに接続して操作する

Terminal を開き、以下を入力してください：

```bash
ssh pi@あなたのラズベリーパイのIPアドレス
```

質問があれば `yes` と入力し、パスワードはデフォルトの `raspberry` を入力してください。

![**接続成功！**](/assets/99db2a1fbfe5/1*okEJeW9xZN8XFfRYJyp4Xg.png)

**接続成功！**

> *もし「WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED」のようなエラーが表示された場合は、まず /Users/xxxx/.ssh/known_hosts をテキストエディタで開き、内容を削除してください。

#### ラズベリーパイ基本ツールのインストールと設定

1. **以下のコマンドを入力して Vim エディタをインストールします：**

```bash
sudo apt-get install vim
```

![](/assets/99db2a1fbfe5/1*QfhJwWvicEGfk_8PFLy7pA.png)

**2.以下の言語警告を解決する：**

```plaintext
perl: 警告: ロケールの設定に失敗しました。
perl: 警告: ロケール設定を確認してください:
    LANGUAGE = (未設定),
    LC_ALL = (未設定),
    LC_LANG = "zh_TW.UTF-8",
    LANG = "zh_TW.UTF-8"
    システムでサポートおよびインストールされていることを確認してください。
perl: 警告: 標準ロケール ("C") にフォールバックします。
```

**入力**

```bash
vi .bashrc
```

「Enter」を押して進む

「`i`」を押して編集モードに入る

ファイルの一番下に移動し、「 `export LC_ALL=C` 」を1行追加してください。

「Esc」を押して「`:wq!`」と入力し、保存して終了します。

次に「 `source .bashrc` 」を実行して更新してください。

![](/assets/99db2a1fbfe5/1*Z3E5QTXErDmmNVRd5QYo8g.gif)

**3.nvm を使って nodejs/npm を管理する方法：**

```bash
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh \\| bash
```

**4. nvmを使って最新版の[nodejs](https://nodejs.org/en/){:target="_blank"}をインストール：**

`nvm install 12.16.2`

> *ここでは「12.16.2」バージョンをインストールします

**5.環境のインストール完了を確認：**

**以下のコマンドを入力してください**

`npm -v`

**と**

`node -v`

**確認**

![エラーメッセージがなければOK！](/assets/99db2a1fbfe5/1*u3xgdplBB-7DyvSpAJU4dA.png)

エラーメッセージがなければ問題ありません！

**6. nodejs 接続の設定**

**以下のコマンドを入力してください**

```bash
which node
```

nodejs のパス情報を取得する

**再入力**

```bash
sudo ln -fs ここに which node で確認したパスを貼り付ける（"ダブルクォーテーション不要） /usr/local/bin/node
```

**リンクを作成する**

![](/assets/99db2a1fbfe5/1*L5C-2SCUV-Cf4yCDwYy8eg.png)

**設定完了！**

#### **Raspberry PiのVNCリモートデスクトップ機能を有効化する**

ここではGUI版をインストールしますが、もちろんラズベリーパイにキーボードとHDMIを接続して通常のパソコンのように使うこともできます。しかし、便利さのためにリモートデスクトップでラズベリーパイを操作します。

**入力：**

```bash
sudo raspi-config
```

![](/assets/99db2a1fbfe5/1*_Hwvt6tkKhsNE9TDkOaYAA.png)

**設定に入る：**

![選択肢の5番「 **Interfacing Options** 」](/assets/99db2a1fbfe5/1*_EMj-6phsY5PjrPjqeavDg.png)

5番目の「 **Interfacing Options** 」を選択してください。

![三番目の「 **P3 VNC** 」を選択](/assets/99db2a1fbfe5/1*CAHN3qczUpajbGGU9gaD9g.png)

三番目の「**P3 VNC**」を選択してください。

![「 **←** 」を使って「 **Yes** 」を選択して開く](/assets/99db2a1fbfe5/1*wq4S5b33MpAJUiqt9z1EMg.png)

「 **←** 」を使って「 **Yes** 」を選択して開く

![**VNC リモートデスクトップ機能の有効化に成功！**](/assets/99db2a1fbfe5/1*sTZ8x9M-_5FRwdqy4mKvPw.png)

**VNC リモートデスクトップ機能が有効になりました！**

![「 **→** 」を使って直接「 **Finish** 」に進み、設定画面を終了します。](/assets/99db2a1fbfe5/1*81Y7wZjbSS8Tf5Z_OHi3Rw.png)

「 **→** 」を使って直接「 **Finish** 」に進み、設定画面を終了します。

#### **VNCリモートデスクトップサービスを起動時自動起動に追加する**

私たちは、VNCリモートデスクトップサービスがラズベリーパイの起動時に自動的に有効になることを望んでいます。

**入力**

```bash
sudo vim /etc/init.d/vncserver
```

「Enter」を押して進む

「`i`」を押して編集モードに入る

```bash
#!/bin/sh
### BEGIN INIT INFO
# Provides:          vncserver
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: vncserverの起動/停止
### END INIT INFO

# 詳細は以下を参照してください:
# http://www.penguintutor.com/linux/vnc

### この項目をカスタマイズしてください
# USER変数をvncserverを起動するユーザー名に設定
export USER='pi'
### カスタマイズ終了

eval cd ~$USER

case "$1" in
  start)
    su $USER -c '/usr/bin/vncserver -depth 16 -geometry 1024x768 :1'
    echo "$USER のVNCサーバーを起動中"
    ;;
  stop)
    su $USER -c '/usr/bin/vncserver -kill :1'
    echo "vncserverを停止しました"
    ;;
  *)
    echo "使い方: /etc/init.d/vncserver {start\\|stop}"
    exit 1
    ;;
esac
exit 0
```

「Command」＋「C」、「Command」＋「V」で上記の内容をコピー＆ペーストし、「Esc」キーを押して「:wq!」と入力して保存して終了します。

**再入力：**

```bash
sudo chmod 755 /etc/init.d/vncserver
```

ファイルの権限を変更する。

**再入力：**

```bash
sudo update-rc.d vncserver defaults
```

起動時に自動で開始する項目に追加する。

**最終入力：**

```bash
sudo reboot
```

**ラズベリーパイを再起動します。**

> *再起動が完了したら、先ほどの手順に従って再度 ssh 接続を行ってください。

#### **VNCクライアントを使った接続：**

ここでは Chrome のアプリ「 [VNC® Viewer for Google Chrome™](https://chrome.google.com/webstore/detail/vnc%C2%AE-viewer-for-google-ch/iabmpiboiopbgfabjmgeedhcmjenhbla){:target="_blank"} 」を使用します。インストールして起動後、**ラズベリーパイの IP アドレス:1** を入力してください。後ろの **Port:1** を忘れずに追加してください！

> *私はMacに標準搭載されているVNC://で接続できません。原因は不明です。

![「**Connect**」をクリックしてください。](/assets/99db2a1fbfe5/1*83cR8b2ajhPc1IwariNVBw.png)

「 **Connect** 」をクリックしてください。

![「 **ＯＫ** 」をクリックしてください。](/assets/99db2a1fbfe5/1*B0esYM-GvrYUVXIwpq4vvQ.png)

「 **ＯＫ** 」をクリックしてください。

![**ログインアカウントとパスワードを入力**し、SSH接続します。アカウントは `pi`、初期パスワードは `raspberry` です。](/assets/99db2a1fbfe5/1*jJ8cdRrc4bGHDxPvF7xXhw.png)

**ログインアカウントとパスワードを入力**し、SSH接続します。アカウントは `pi`、デフォルトパスワードは `raspberry` です。

![**接続成功！**](/assets/99db2a1fbfe5/1*vIUEmBrO-t_-6xy_kPNLNQ.png)

**接続成功！**

#### **ラズベリーパイの初期設定を完了する：**

次はすべてグラフィカルインターフェースです！とても簡単です！

![言語、地域、タイムゾーンの設定。](/assets/99db2a1fbfe5/1*w9qXfybKr4REKN8hrJJUBw.png)

言語、地域、タイムゾーンの設定。

![Raspberry Piのデフォルトパスワードを変更し、設定したいパスワードを入力してください。](/assets/99db2a1fbfe5/1*xeb6Pr5FUwQGYHhzmid-6w.png)

ラズベリーパイのデフォルトパスワードを変更し、設定したいパスワードを入力してください。

![直接「 **Next** 」をクリックしてください。](/assets/99db2a1fbfe5/1*o-LCjlYXdW7hmxYjIE6Axw.png)

直接次のステップ「 **Next** 」を選択してください。

![WiFi接続を設定すれば、以降はケーブルを差す必要がありません。](/assets/99db2a1fbfe5/1*NPZqliJZslnmvzzkW-Zj6g.png)

WiFi接続を設定すれば、その後はケーブルを差す必要がありません。

> *ただし、ラズベリーパイのIPアドレスは変わる可能性があるため、ルーターで再確認してください。

![現在のOSを更新しますか？急ぎでなければ「 **Next** 」を選んで更新しましょう！](/assets/99db2a1fbfe5/1*lsnk0BDb_z1VKkXYxUi7fg.png)

現在のOSを更新しますか？急がなければ「 **Next** 」を選んで更新してください！

> *更新には約20〜30分かかります（ネット速度によります）

![更新完了ら、「 **Restart** 」をクリックして再起動します。](/assets/99db2a1fbfe5/1*Xgm6NMQNoom_Zee3QHWXZg.png)

更新が完了したら、「 **Restart** 」をクリックして再起動してください。

**ラズベリーパイ環境設定完了！**

### HomeBridge インストール

いよいよ本題、HomeBridgeのインストールと使用。

Terminalでsshを使ってラズベリーパイに接続するか、VNCリモートデスクトップ内のTerminalを直接使用します。

**入力：**

```bash
npm -g install homebridge --unsafe-perm
```

^( **sudo を使わない** )

**HomeBridge** のインストール

![](/assets/99db2a1fbfe5/1*feOCt_Gyy8DEW7qHA2bpQw.png)

**インストール完了！**

#### 設定ファイル(config.json)の作成/編集：

**編集を便利にするため、VNCリモートデスクトップでRaspberry Piに接続します**（コマンドでも直接操作可能）：

左上の角をクリックして「**ファイルマネージャー**」を開き -> 「**/home/pi/.homebridge**」に入る

「config.json」ファイルが見当たらない場合は、空白部分で右クリックし「**New File**」を選択して、ファイル名に「**config.json**」と入力してください。

「 **config.json** 」を右クリックして「 **テキストエディタ** 」で開く

![](/assets/99db2a1fbfe5/1*Zk_cWdHZ4Um5zCX4dr5IdQ.png)

**以下の基本設定内容を貼り付けてください：**

```json
{
   "bridge": {
  "name": "Homebridge",
  "username": "CC:22:3D:E3:CE:30",
  "port": 51826,
  "pin": "123-45-568"
}
```

**内容は特に変更せず、そのままコピーしてください！**

> ***必ず保存してください！***

![](/assets/99db2a1fbfe5/1*Jm3Ykku3Yll1aiuKWbR-EQ.png)

**完了！**

#### HomeBridge を HomeKit に連携する

**入力：**

```bash
homebridge start
```

^( **sudoを付けない** )

**有効化**

![](/assets/99db2a1fbfe5/1*uMEuC33I-R6KlLxS-L6Grw.png)

> *エラー「Service name is already in use on the network」やポートが使用中の場合は、サービスを削除するか、`homebridge restart` コマンドで再起動するか、またはシステムの再起動を試してください。

> *「was not registered by any plugin」のようなエラーが表示された場合は、対応するhomebridgeプラグインがまだインストールされていないことを意味します。

> ***起動中に設定ファイル(config.json)の内容を変更した場合は、以下を修正してください：***

> `sudo homebridge restart`

> ***HomeBridge を再起動する***

> *「Control」+「C」を押すと、TerminalでHomeBridgeサービスを停止できます。

iPhoneを取り出して「ホーム」アプリを開き、「ホーム」の右上にある「＋」をタップし、「アクセサリを追加」を選択して、**表示されたQRコードをスキャン**してください。

![](/assets/99db2a1fbfe5/1*IFt2yQBfKfooraaAgCxGkA.jpeg)

この時、「**アクセサリが見つかりません**」と表示されるはずですが、ご安心ください！まだHomeBridgeブリッジにアクセサリを追加していないだけです。問題ありませんので、続けて進みましょう。

**最低でも1つのアクセサリーが必要です！**（ここではカメラを例としています）**：**  
**最低でも1つのアクセサリーが必要です！**（ここではカメラを例としています）**：**  
**最低でも1つのアクセサリーが必要です！**（ここではカメラを例としています）**：**

![](/assets/99db2a1fbfe5/1*HC1CSkt1RpBXYEZ3aa8Eyw.png)

![](/assets/99db2a1fbfe5/1*Wi1np5MvjBkwJkInD49aRA.png)

初回スキャン時に警告ウィンドウが表示されますが、「強制参加」を押せば問題ありません！

> ***一度追加すれば、その後に新しく追加したアクセサリは再スキャン不要で、自動的に更新されます！***

#### HomeBridgeサービスをラズベリーパイの起動自動実行に追加する

VNC リモートデスクトップサービスと同様に、HomeBridge サービスもラズベリーパイの起動時に自動で開始されるようにしたいです。そうしないと再起動のたびに手動で接続して起動する必要があります。

**入力：**

```bash
which homebridge
```

**homebridge のパス情報を取得する**

![](/assets/99db2a1fbfe5/1*L8-E7jZqv6TjO4zKaayAuA.png)

**このパスをメモしてください。**

**再入力：**

```bash
sudo vim /etc/init.d/homebridge
```

「Enter」を押して進む

「 `i` 」を押して編集モードに入る

```bash
#!/bin/sh
### BEGIN INIT INFO
# Provides:
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: ブート時にデーモンを起動
# Description:       デーモンによって提供されるサービスを有効化します。
### END INIT INFO


dir="/home/pi"
cmd="DEBUG=* ここに which homebridge で見つけたパスを貼り付けてください"
user="pi"


name=`basename $0`
pid_file="/var/run/$name.pid"
stdout_log="/var/log/$name.log"
stderr_log="/var/log/$name.err"


get_pid() {
cat "$pid_file"
}


is_running() {
[ -f "$pid_file" ] && ps -p `get_pid` > /dev/null 2>&1
}


case "$1" in
start)
if is_running; then
echo "既に起動しています"
else
echo "$name を起動します"
cd "$dir"
if [ -z "$user" ]; then
sudo $cmd >> "$stdout_log" 2>> "$stderr_log" &
else
sudo -u "$user" $cmd >> "$stdout_log" 2>> "$stderr_log" &
fi
echo $! > "$pid_file"
if ! is_running; then
echo "起動できませんでした。$stdout_log と $stderr_log を確認してください"
exit 1
fi
fi
;;
stop)
if is_running; then
echo -n "$name を停止中.."
kill `get_pid`
for i in 1 2 3 4 5 6 7 8 9 10
# for i in `seq 10`
do
if ! is_running; then
break
fi


echo -n "."
sleep 1
done
echo


if is_running; then
echo "停止できませんでした。まだシャットダウン中か失敗した可能性があります"
exit 1
else
echo "停止しました"
if [ -f "$pid_file" ]; then
rm "$pid_file"
fi
fi
else
echo "起動していません"
fi
;;
restart)
$0 stop
if is_running; then
echo "停止できなかったため、起動を試みません"
exit 1
fi
$0 start
;;
status)
if is_running; then
echo "起動中"
else
echo "停止中"
exit 1
fi
;;
*)
echo "使い方: $0 {start\\|stop\\|restart\\|status}"
exit 1
;;
esac
exit 0
```

**変換：**

`cmd=”DEBUG=* ここに which homebridge で確認したパスを貼り付けてください”`

**あなたが見つけたパス情報に置き換えてください（“”は不要です）**

「Commend」＋「C」、「Commend」＋「V」で上記の内容をコピー＆ペーストし、「Esc」を押して「:wq!」と入力し保存して終了してください。

**再入力：**

```bash
sudo chmod 755 /etc/init.d/homebridge
```

ファイルの権限を変更する。

**最後の入力：**

```bash
sudo update-rc.d homebridge defaults
```

起動時に自動実行項目に追加する。

**完了！**

> `sudo /etc/init.d/homebridge start` を使って直接 `homebridge` サービスを起動できます。

> また、`tail -f /var/log/homebridge.err` で起動エラーメッセージを確認し、`tail -f /var/log/homebridge.log` でログを確認できます。

![](/assets/99db2a1fbfe5/1*P_3Zg1GDuUVKJyO-kknCLA.png)

### 米家スマート家電連携の準備

Homebridge が起動したら、すべての米家家電を一つずつ Homebridge に追加して HomeKit と接続できます！

**まず最初に、すべてのMi Homeスマート家電を「 [米家APP](https://apps.apple.com/tw/app/%E7%B1%B3%E5%AE%B6-%E6%99%BA%E6%85%A7%E7%94%9F%E6%B4%BB%E6%96%B0%E9%AB%94%E9%A9%97/id957323480){:target="_blank"} 」に追加します**。ここからHomeBridgeと連携するための情報を取得します。

**スマート家電をすべてMi Homeアプリに追加した後：**

iPhone を Mac に接続し、Finder または iTunes の画面を開いて、接続したデバイスを選択します。

「 **このコンピュータ** 」を選択し、「 **このコンピュータのバックアップを暗号化しない** 」のチェックを外し、「 **今すぐバックアップ** 」をクリックしてください。

![](/assets/99db2a1fbfe5/1*nS68ECAURNSVbuJRYdhCvw.png)

バックアップが完了したら、[ダウンロード](http://www.imactools.com/iphonebackupviewer/download/mac){:target="_blank"}してバックアップ閲覧ソフトウェアをインストールします： [**iBackupViewer**](http://www.imactools.com/iphonebackupviewer/download/mac){:target="_blank"}

「 **iBackupViewer** 」を開く

> 初回起動時に、Macの「システム環境設定」-「セキュリティとプライバシー」-「プライバシー」-「+」から「iBackupViewer」を追加するよう求められます。

> ****プライバシーの懸念がある場合は、ネットワークをオフにしてこのソフトを使用し、使用後に削除してください***

![](/assets/99db2a1fbfe5/0*VMTW7WxQEl_ZFU7E.png)

再度「**iBackupViewer**」を開き、バックアップファイルの読み込みに成功したら、「直前にバックアップしたスマホ」をクリックしてください。

![「 **App Stroe** 」アイコンを選択](/assets/99db2a1fbfe5/1*Qqyp11Gc-dnK1Me08KKwbw.png)

「 **App Store** 」アイコンを選択してください

![左側で「米家 APP (MiHome.app)」を見つけ、→ 右側で「 **数字_mihome.sqlite」** ファイルを見つけて「 **選択** 」→ 右上の「 **Export** 」→ 「 **Selected Files** 」](/assets/99db2a1fbfe5/1*VlGVYTHKG88GIiH4C745Vg.png)

左側で「米家 APP (MiHome.app)」を見つけ、→ 右側で「 **数字_mihome.sqlite** 」というファイルを「 **選択** 」し、→ 右上の「 **Export** 」→ 「 **Selected Files** 」をクリックします。

> *もし「数字_mihome.sqlite」ファイルが2つある場合は、Created（作成日時）が最新のものを使用してください。

エクスポートした **数字_mihome.sqlite** ファイルを **このサイトにドラッグして内容を確認してください：**

[![](https://inloop.github.io/sqlite-viewer/img/icon.png)](https://inloop.github.io/sqlite-viewer/){:target="_blank"}

**クエリ文を次のように変更できます：**

```sql
SELECT `ZDID`,`ZNAME`,`ZTOKEN` FROM 'ZDEVICE' LIMIT 0,30
```

必要なフィールド情報のみ表示する（特定の家電プラグインで追加のフィールドが必要な場合は、それらもフィルタリングに含めることができます）

![](/assets/99db2a1fbfe5/1*VWdrF905GGB_yXrCD5CpPg.png)

1. ZDID: デバイスID

2. ZNAME: デバイス名

3. ZTOKEN: デバイスのZToken

> ***ZTOKENは直接使用できません。「Token」に変換してから使用する必要があります。***

ここではカメラの ZToken を Token に変換する例を示します：

まず、上記リストからカメラの ZToken 欄の内容を取得します

```plaintext
7f1a3541f0433b3ccda94beb856c2f5ba2b15f293ce0cc398ea08b549f9c74050143db63ee66b0cdff9f69917680151e
```

しかし、ここで取得した TOKEN はまだ使用できません。さらに変換が必要です。

**<http://aes.online-domain-tools.com/>{:target="_blank"} このサイトを開く：**

1. コピーした ZTOKEN を「Input Text」に貼り付け、「Hex」を選択してください。

2. Keyに「00000000000000000000000000000000」32個の0を入力し、同様に「Hex」を選択してください。

3. そして「Decrypt!」を押して変換します。

4. 右下隅の2行の出力内容をすべて選択してコピーし、空白を削除すると、必要な結果である **Token** になります。

![「 **6d304e6867384b704b4f714d45314a34** 」が私たちの求めるTokenの結果です！](/assets/99db2a1fbfe5/1*aQ7RfRx9ATjflYgMysnn3A.png)

「 **6d304e6867384b704b4f714d45314a34** 」が私たちが求めているTokenの結果です！

> *Tokenの取得方法については「miio」を使って直接スニッフィングする方法を試しましたが、どうやら米家のファームウェアが更新されており、この方法では簡単にTokenを取得できなくなっています。

最後に、**デバイスのIPアドレス**も知っておく必要があります（ここではカメラを例にします）：

![](/assets/99db2a1fbfe5/0*OvqmDU7ARvoG96J0.jpeg)

米家APPを開く → カメラ → 右上の「…」→ 設定 → ネットワーク情報で **IPアドレス** を取得！

> ***ZDID/Token/IPなどの情報を記録し、後で使用できるようにします。***

### 米家スマート家電を一つずつ HomeBridge に接続する

各デバイスごとに必要なプラグインや接続情報が異なるため、個別にインストール・設定し、HomeBridgeに追加します。

> ***次に Terminal を開き、ssh でラズベリーパイに接続するか、VNC リモートデスクトップ内の Terminal を直接使って作業を続けます…。***

#### **1.米家カメラ雲台版：**

Terminalで以下のコマンドを実行し、[MijiaCamera](https://github.com/josepramon/homebridge-mijia-camera){:target="_blank"} のhomebridgeプラグインをインストールします（**sudoを付けない**）：

```bash
npm install -g homebridge-mijia-camera
```

![](/assets/99db2a1fbfe5/1*V7hZyogacXS9m_XN4qVtFw.png)

前述の設定ファイル（config.json）編集の説明を参考に、ファイルに **accessories** セクションを追加します **：**

```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"MijiaCamera",
         "name":"Mi Camera",
         "ip":"",
         "token":""
      }
   ]
}
```

`accessories:` に米家カメラの設定情報を追加します。ip にはカメラのIPアドレス、token には前述の手順で取得したトークンを入力してください。

> ***忘れずに保存してください！***

そして、Homebridgeの章で説明した通りに、起動／再起動／スキャンしてHomebridgeに追加すると、「ホーム」アプリでカメラのコントロール項目が表示されます。

![](/assets/99db2a1fbfe5/0*fHtbNC-8IL9KQUyu.jpeg)

制御項目：カメラのオン/オフ

#### 2.米家直流変頻扇風機

Terminalで以下のコマンドを実行し、[homebridge-mi-fan](https://github.com/YinHangCode/homebridge-mi-fan){:target="_blank"} というhomebridgeプラグインを**sudoなしで**インストールします：

```bash
npm install -g homebridge-mi-fan
```

![](/assets/99db2a1fbfe5/1*vwe7fapof2mA4me_3_HyfA.png)

前述の設定ファイル(config.json)の編集方法を参考に、ファイル内に **platforms** セクションを追加します（既にある場合はセクション内の「,」で新しいサブセクションを追加してください） **：**

```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "platforms":[
      {
         "platform":"MiFanPlatform",
         "deviceCfgs":[
            {
               "type":"MiDCVariableFrequencyFan",
               "ip":"",
               "token":"",
               "fanName":"部屋の扇風機",
               "fanDisable":false,
               "temperatureName":"部屋の温度",
               "temperatureDisable":true,
               "humidityName":"部屋の湿度",
               "humidityDisable":true,
               "buzzerSwitchName":"扇風機ブザーのスイッチ",
               "buzzerSwitchDisable":true,
               "ledBulbName":"扇風機LEDスイッチ",
               "ledBulbDisable":true
            }
         ]
      }
   ]
}
```

`platforms:` に米家扇風機の設定情報を追加します。ip はカメラの ip を入力し、token は前述の方法で取得した token を入力します。humidity/temperature は温湿度計情報の連動表示を制御できます。  
**type には対応するモデル名の文字列を入力してください**。4種類の異なる扇風機モデルに対応しています：

1. 智米直流変頻フロアファン：ZhiMiDCVariableFrequencyFan

2. 智米自然風扇：ZhiMiNaturalWindFan

3. 米家直流変頻：MiDCVariableFrequencyFan（台湾で販売されています）

4. 米家ファン：DmakerFan

ご自身の扇風機の型番を入力してください。

> ***忘れずに保存してください！***

そして Homebridge の章で教えられた通り、起動／再起動／スキャンして Homebridge に追加すると、「ホーム」アプリでカメラのコントロール項目が表示されます。

![](/assets/99db2a1fbfe5/1*N_N5_WCnHNsepVv7HvAjmQ.jpeg)

制御項目：扇風機のオン/オフ、風力の調整

#### 3. Xiaomi 空気清浄機 3

Terminal で以下のコマンドを実行し、[homebridge-xiaomi-air-purifier3](https://github.com/rgavril/homebridge-xiaomi-air-purifier3){:target="_blank"} という homebridge プラグインを **sudo を使わずに** インストールします：

```bash
npm install -g homebridge-xiaomi-air-purifier3
```

![](/assets/99db2a1fbfe5/1*VxEYnHaBwQVLxxXOLb1Jkg.png)

前文の設定ファイル(config.json)の編集方法を参考に、ファイル内に **accessories** セクションを追加してください（既にある場合はセクション内の「,」で子セクションを追加します） **：**

```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"XiaomiAirPurifier3",
         "name":"Xiaomi 空気清浄機",
         "did":"",
         "ip":"",
         "token":"",
         "pm25_breakpoints":[
            5,
            12,
            35,
            55
         ]
      }
   ]
}
```

`accessories:` に米家扇風機の設定情報を追加します。ipにはカメラのip、tokenには前述の方法で取得したtoken、didにはzdidを入力してください。

> ***必ず保存してください！***

そして、Homebridgeの章で説明した通りに起動／再起動／スキャンしてHomebridgeに追加すると、「ホーム」アプリでカメラのコントロール項目が表示されます。

![](/assets/99db2a1fbfe5/1*R1bxhdiGuY3SyFnrhCO6iw.png)

![](/assets/99db2a1fbfe5/1*05s08YdF6vQUWAG7nmTnfA.png)

制御可能な項目：空気清浄機のオン/オフ、風量調整  
確認可能な項目：現在の温湿度

#### 4.米家 LED スマートデスクライト

Terminalで以下のコマンドを実行し、[homebridge-yeelight-wifi](https://github.com/vieira/homebridge-yeelight-wifi){:target="_blank"}というhomebridgeプラグインを**sudoなしで**インストールします：

```bash
npm install -g homebridge-yeelight-wifi
```

![](/assets/99db2a1fbfe5/1*1fQJ9UTCJRghUk00iT2WcQ.png)

前述の設定ファイル(config.json)の編集方法を参考に、ファイル内に **platforms** ブロックを追加してください（すでにある場合は、ブロック内で「,」を使って新しいサブブロックを追加します）：

```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "platforms":[
      {
         "platform":"yeelight",
         "name":"Yeelight"
      }
   ]
}
```

特別なパラメータを渡す必要はありません！より詳細な設定を行いたい場合は、[公式ドキュメント](https://github.com/vieira/homebridge-yeelight-wifi){:target="_blank"} を参照してください（明るさや色温度など…）

> ***保存を忘れずに！***

スマートデスクライトは「[Yeelight](https://apps.apple.com/tw/app/yeelight/id977125608){:target="_blank"}」アプリに再度バインドし、「ローカルネットワーク制御」をオンにする必要があり、そうすることで Homebridge が制御可能になります。

1. iPhoneで「[Yeelight](https://apps.apple.com/tw/app/yeelight/id977125608){:target="_blank"}」アプリをダウンロードしてインストールする

![App Storeで「Yeelight」を検索してインストール](/assets/99db2a1fbfe5/1*3m-UOoI7uam4a_N5dxU5VQ.png)

App Storeで「Yeelight」を検索してインストールしてください

![](/assets/99db2a1fbfe5/1*G9-12giq1DVIw5zTKOaF4A.png)

![](/assets/99db2a1fbfe5/1*usLJKkehTDKeeFG95KDe4g.png)

![インストール後、Yeelightアプリを開く -> 「デバイスを追加」-> 「Mi Homeデスクライト」を見つける -> 再ペアリングしてバインドする](/assets/99db2a1fbfe5/1*cWBMAqa_xkL01SoURNSO8g.png)

インストール完了後、Yeelightアプリを開き、「デバイス追加」→「Mi Homeデスクライト」を見つけて、再ペアリングしてバインドします。

![最後のステップで「 **ローカルネットワーク制御** 」を必ずオンにしてください](/assets/99db2a1fbfe5/1*8un0THsUf3ZesFPGSj_p-g.jpeg)

最後のステップで「**ローカルネットワーク制御**」を必ずオンにしてください。

> *もし誤って開かない場合は、「デバイス」ページ -> テーブルランプのデバイスを選択 -> 右下の「△」タブをタップ -> 「ローカルネットワーク制御」をタップして設定 -> ローカルネットワーク制御をオンにしてください

> ***少し不満を言うと、これは本当にひどいです。米家の公式アプリにはこのスイッチ機能がなく、必ずYeelightアプリに連携する必要があります。また、連携解除や再連携を米家に戻すこともできません…そうしないと動作しなくなります。***

そして Homebridge の章で説明した通りに、起動／再起動／スキャンして Homebridge に追加すると、「ホーム」アプリでカメラのコントロール項目が表示されます。

![](/assets/99db2a1fbfe5/1*vyAiFirZgDB6_OSsHIdEPw.jpeg)

制御可能な項目：ライトのオン/オフ、色温度調整、明るさ調整

#### その他の米家スマート家電用 homebridge プラグイン：

**私の最終的な config.json は以下の通りです：**

```json
{
   "bridge":{
      "name":"Homebridge",
      "username":"CC:22:3D:E3:CE:30",
      "port":51826,
      "pin":"123-45-568"
   },
   "accessories":[
      {
         "accessory":"MijiaCamera",
         "name":"Mi Camera",
         "ip":"192.168.0.105",
         "token":"6d304e6867384b704b4f714d45314a34"
      },
      {
         "accessory":"XiaomiAirPurifier3",
         "name":"Xiaomi Air Purifier",
         "did":"270033668",
         "ip":"192.168.0.108",
         "token":"5c3eeb03065fd8fc6ad10cae1f7cce7c",
         "pm25_breakpoints":[
            5,
            12,
            35,
            55
         ]
      }
   ],
   "platforms":[
      {
         "platform":"MiFanPlatform",
         "deviceCfgs":[
            {
               "type":"MiDCVariableFrequencyFan",
               "ip":"192.168.0.106",
               "token":"dd1b6f582ba6ce34f959bbbc1c1ca59f",
               "fanName":"room fan",
               "fanDisable":false,
               "temperatureName":"room temperature",
               "temperatureDisable":true,
               "humidityName":"room humidity",
               "humidityDisable":true,
               "buzzerSwitchName":"fan buzzer switch",
               "buzzerSwitchDisable":true,
               "ledBulbName":"fan led switch",
               "ledBulbDisable":true
            }
         ]
      },
      {
         "platform":"yeelight",
         "name":"Yeelight"
      }
   ]
}
```

**みなさんの参考に！**

私が使っている米家家電は上記の通りで、他に持っていないものは試していません。皆さんはご自身で [**npmで検索（homebridge-plugin XXX英語名）**](https://www.npmjs.com/search?q=keywords%3Ahomebridge-plugin%20mi%20camera){:target="_blank"} して、上記の流れに沿ってインストール・設定して連携してください！

こちらにいくつか見つけたけれど試していない homebridge プラグインを添付します（動作保証はありません）：

1. 小米空気清浄機第1世代： [homebridge-mi-air-purifier](https://github.com/seikan/homebridge-mi-air-purifier){:target="_blank"}

2. 米家スマートプラグシリーズ： [homebridge-mi-outlet](https://github.com/YinHangCode/homebridge-mi-outlet){:target="_blank"}

3. 小米ロボット掃除機： [homebridge-mi-robot_vacuum](https://github.com/YinHangCode/homebridge-mi-robot_vacuum){:target="_blank"}

4. 米家スマートゲートウェイ： [homebridge-mi-aqara](https://github.com/YinHangCode/homebridge-mi-aqara){:target="_blank"}

### 注意事項

1. ルーターで全ての米家家電に固定IPを設定することを推奨します。そうしないとIPアドレスが変わり、config.jsonの設定を再度変更する必要があります。

2. 手順が正しいのに接続できずエラーが出る、またはHomeKitに「応答なし」と表示され続ける場合は、再度試してください。それでも同じ場合はプラグインが無効になっている可能性があるため、別のプラグインを探して接続してください。（GitHubのissueを確認してください）

3. 機能が動作しない、反応が遅い場合も解決できません。作者にissueを報告して更新を待つしかありません。オープンソースプロジェクトなので、多くを求めすぎないでください！

4. **各家電をバインドした後、Homebridgeを一度起動し、iPhoneで動作確認を行います。動作する場合は「Control」＋「C」で終了してください。すべての家電をバインドし終えたら、ラズベリーパイを再起動し、再起動後にHomebridgeサービスが自動でバックグラウンドで起動するようにします。これが望ましい動作です。**

### 結び

![](/assets/99db2a1fbfe5/1*w7WnAn3XHNW2f5fJbRd_Zw.jpeg)

![](/assets/99db2a1fbfe5/1*ph8BfcF0ivvlZyKNF9mubQ.png)

![また、「設定」->「コントロールセンター」->「カスタマイズ」で「ホーム」アプリを追加すると、下にスワイプしたコントロールセンターからHomeKitを素早く操作できます！](/assets/99db2a1fbfe5/1*e1FAJuyCLOWEkA6MAeENkA.jpeg)

また、「設定」->「コントロールセンター」->「カスタマイズ」から「ホーム」アプリを追加すると、下にスワイプしたコントロールセンターで HomeKit を素早く操作できます！

すべてを HomeKit に統合した結果、ただ一言「最高！」です。スイッチの反応も速くなり、あとはホームハブがないためリモート操作ができないだけです。これで上級者向け Homebridge の説明は終了です。ご覧いただきありがとうございました。

記事の冒頭に戻って、すべてを HomeKit に統合すれば、iOS 13 以降のショートカット自動化機能を問題なく使えるようになります。

後で homebridge プラグインがどう作られているか研究したいです。とても面白そうですね！もし HomeBridge プラグインが操作要件に合わなかったり、壊れて代替が見つからなければ、私が研究するのを待っていてください！

#### Home assistant

もう一つのスマートホームプラットフォームとして [Homeassistant](https://www.home-assistant.io/){:target="_blank"} があり、ラズベリーパイにインストールして使用できます（**ただし、起動には2Aの電源が必要です**）。[Homeassistant](https://www.home-assistant.io/){:target="_blank"} は私も試してみましたが、全てGUIのグラフィカル操作で、クリックするだけで家電を連携できます。今後さらに詳しく研究する予定ですが、多くの異なるメーカーのIOTデバイスがある場合は、こちらの方が適していると感じます。

#### 参考資料

1. <https://www.domoticz.cn/forum/viewtopic.php?t=52>{:target="_blank"}

2. <https://or2.in/2017/07/02/Homekit-and-MiJia-with-pi/#3-%E5%8F%B7%E5%A4%96-%E5%BC%80%E5%90%AF%E5%8F%AF%E8%A7%86%E5%8C%96VNC>{:target="_blank"}

### 関連記事

1. [小米スマートホーム新規購入（AIスピーカー、温湿度センサー、体重計2、DCインバーターファン）](../bcff7c157941/)

2. [iOS ≥ 13.1で「ショートカット」自動化機能を使って米家スマートホームを操作する（iOS ≥ 13.1内蔵のショートカットAPPを直接使って自動化を完了）](../21119db777dd/)

3. [米家APP / 小愛音箱の地域問題](../94a4020edb82/)

4. [スマートホーム初体験 — Apple HomeKit と小米ミジア（ミジアスマートカメラとミジアスマートデスクランプ、HomeKit設定ガイド）](../c3150cdc85dd/)

ご質問やご意見がございましたら、[こちらからご連絡ください](https://www.zhgchg.li/contact){:target="_blank"} 。

*[Post](https://medium.com/zrealm-life/%E6%89%93%E9%80%A0%E8%88%92%E9%81%A9%E7%9A%84-wfh-%E6%99%BA%E6%85%A7%E5%B1%85%E5%AE%B6%E7%92%B0%E5%A2%83-%E6%8E%A7%E5%88%B6%E5%AE%B6%E9%9B%BB%E7%9B%A1%E5%9C%A8%E6%8C%87%E5%B0%96-99db2a1fbfe5){:target="_blank"} Mediumから[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}によって変換されました。*