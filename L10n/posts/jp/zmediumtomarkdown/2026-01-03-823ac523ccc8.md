---
author: ZhgChgLi
categories:
- ZRealmの開発
date: 2026-01-03T17:03:46.382+0000
description: iOS開発者向けにCertificates, Identifiers & Profilesの役割を解説し、Fastlane Matchで憑證管理を自動化、CI/CDに統合する方法を具体的に紹介。管理ミスを減らし開発効率を大幅向上します。
image:
  path: /assets/823ac523ccc8/1*-OS8G9xu0CFpnlAQRgnGAg.jpeg
last_modified_at: 2026-01-03T17:04:16.967+0000
render_with_liquid: false
tags:
- iosアプリ開発
- fastlane
- キーチェーン
- github-actions
- macos
- japanese
- ai-translation
title: iOS Certificates, Identifiers & Profilesの関係｜Fastlane Matchで憑證管理とCI/CDを効率化
---

### iOS Certificates, Identifiers & Profiles とは何かおよび **Fastlane Match による統一** 管理 **証明書と CI/CD に関するメモ**

Certificates、Identifiers & Profiles の関係と Fastlane Match を使った証明書の一元管理および CI/CD ワークフローへの統合についての記録。

![Photo by [marcos mayer](https://unsplash.com/@mmayyer?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/823ac523ccc8/1*-OS8G9xu0CFpnlAQRgnGAg.jpeg)

Photo by [marcos mayer](https://unsplash.com/@mmayyer?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}

#### はじめに

2025年中に、GitHub Actionsを使ってAppのCI/CDの完全なワークフローを0から1まで構築する一連の記事を書きました：

- [CI/CD 実践ガイド（1）：CI/CD とは？CI/CD を使って安定で効率的な開発チームを作る方法は？ツールの選び方は？](../c008a9e8ceca/)

- [CI/CD 実践ガイド（二）：GitHub Actions と self-hosted Runner の使い方と構築大全](../404bd5c70040/)

- [CI/CD 実践ガイド（三）：GitHub Actions を使ったアプリプロジェクトの CI と CD ワークフローの実装](../4b001d2e8440/)

- [CI/CD 実践ガイド（4）：Google Apps Script Web App を使って GitHub Actions と連携し、無料で使いやすいパッケージングツールプラットフォームを構築](../4273e57e7148/)

最近、新しい環境で再度実行しましたが、毎回新しいことを学んでいます。今回は Fastlane Match を使った開発およびビルド証明書の管理に焦点を当てました。

### [Certificates, Identifiers & Profiles、Devicesとは？](https://developer.apple.com/account/resources/certificates/list){:target="_blank"}

Apple エコシステムでは、アプリ開発は証明書とプロビジョニングプロファイルの管理に基づいており、Android のように .apk ファイルがあればインストールして使用できるわけではありません。Apple は厳格な証明書管理を行っており、規則に合わない場合はインストールや使用ができません。

#### **主な構成要素と機能：**

![](/assets/823ac523ccc8/1*PyM0l-jXXcVBKubOwCiTsw.png)

#### **Certificates: 誰が発行したか**

- **Development** — 開発段階で実機上で使用（シミュレーターのみの場合は証明書不要）、所属は個人またはAPIキー（数に制限あり）。

- **Distribution** — App Store、TestFlight、または Ad Hoc 内部テスト（登録済みデバイス限定）での配布に使用され、数量制限があり、所属はチームです。

- **Enterprise** — 企業内アプリの利用。

> ***フォーマット*** *：使用するには `Private Key (秘密鍵)` と `Certificate .cer (公開鍵証明書)` が必要です。または、エクスポートした `.p12` ファイルには両方が含まれます。*

#### **Identifiers: どの App/Extension (Bundle Id) か**

App の Bundle Id 登録と有効にする必要がある Capabilities（例：Push Notifications、App Groups の有効化など）、App Services。

Extension も独自の Identifier を持ちます。

#### **Devices: 登録済みデバイス (iPhone/iPad など)**

Development は実機で動作し、Distribution Ad Hoc 内部テストは登録されたデバイスのみ使用可能です。

> ***上限：100個；キャンセルを含み、毎年の支払いサイクルまでリリース枠はリセットされません。***

#### **Provisioning Profile(以下「プロビジョニングプロファイル」または「Profile」と略す): プロファイル**

Certificates+Identifiers+Devices の関係の組み合わせ。

- **Development** — 開発段階で使用するプロビジョニングプロファイルで、実機テストを行う際に必須です。プロファイルには Certificates、Identifiers、Devices の関係が含まれます。

- **Ad Hoc** — 内部テスト用にパッケージ化されたプロビジョニングプロファイル（例：Firebase App Distributionへのデプロイ）で、プロファイルには Certificates、Identifiers、Devices の関係が含まれます。

- **App Store** — App Store / Testflight にアップロードするためのパッケージに使用されるプロビジョニングプロファイルで、プロファイルには Certificates と Identifiers の関係が含まれます。

> *フォーマット： `.mobileprovision`*

> ***注意：Profile はあくまで記述ファイルであり、関係性を示すものであって、証明書本体は含みません。***

### 日常使用の問題シーン

#### 開発用証明書

![](/assets/823ac523ccc8/1*W8bgbVPEBOQZyHBEKZHmAw.png)

- Match を導入して証明書を一元管理する前は、各開発者がそれぞれ自分の `Development Certificate` と `Development Profile` を作成していました。組織内に 1,000 人以上の開発者がいる場合、[Certificates, Identifiers & Profiles, Devices](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の管理画面は非常に混乱し、恐ろしい状態になります。

- もし外部の開発チームが開発作業のみを担当する場合でも、そのチームを Apple Developer Program の管理画面に追加し、彼らが自身の開発用証明書とプロファイルを作成できるようにする必要があります。

#### 配布用証明書

![](/assets/823ac523ccc8/1*z00mYi900fkZV-EmHXMCeg.png)

- Distribution Certificate はチーム単位で作成されるため、各開発者プログラムのチームは限られた数の配布証明書しか作成できません。

- 一般的な方法は、エンジニアの一人が Distribution Certificate を作成し、.p12 ファイルをエクスポートして、他のリリース担当の開発者や CI/CD マシンで使用することです。

- チームが大きく、アプリの数が多いと、やり取りが非常に面倒で、**毎年更新が必要**です。

- **Ad Hoc 配布時に新しいデバイスが登録されると、全員および CI/CD がプロファイルを再ダウンロードしないと新しいデバイスが有効になりません。**

### [Fastlane Match](https://docs.fastlane.tools/actions/match/){:target="_blank"}

上記の問題を踏まえ、すべての証明書関連の管理を代行するプラットフォームが必要です。すべての開発者と CI/CD サービスがこのプラットフォームから統一してデータを取得・更新します。このプラットフォームの保存は安全でなければなりません。これが — [Fastlane Match](https://docs.fastlane.tools/actions/match/){:target="_blank"} です。

> *チーム全体で証明書とプロファイルを簡単に同期*

> *iOSとmacOSのコード署名に新しいアプローチ：開発チーム全体で1つのコード署名IDを共有し、コード署名の設定を簡素化し、署名の問題を防ぎます。*

> *matchは[codesigning.guide concept](https://codesigning.guide/){:target="_blank"} の実装です。matchは必要なすべての証明書とプロビジョニングプロファイルを作成し、別のGitリポジトリ、Google Cloud、またはAmazon S3に保存します。選択したストレージにアクセスできるチームメンバーは誰でも、その資格情報をコード署名に使用できます。matchは壊れたまたは期限切れの資格情報も自動で修復します。チーム間で署名資格情報を共有する最も簡単な方法です*

![](/assets/823ac523ccc8/1*UEL7Abx3PFrYbAc2yVlq8A.png)

- 開発者もCI/CDサービスも、Fastlane Matchコマンドを使って証明書を一元管理します。

- Fastlane MatchはApp Store Connectと連携して証明書を管理し、最終的に生成された結果を**暗号化**して指定したストレージ（ここではGitを例とする）にアップロードします。  
  権限を細かく分けたい場合は、Development証明書を管理するリポジトリとDistribution証明書を管理するリポジトリの2つに分けることができます。

- **管理を担当する人だけが証明書を生成してPushでアップロードできます。他の人やCI/CDは証明書の読み取りとPullのみ操作します。**

### Fastlane Match の設定と使用方法

Git Storage を例にとると、すべての証明書。

**1.空の証明書保存用GitプライベートMatchリポジトリを作成する**  
すべてのCertificatesやProfilesは暗号化して保存されますが、そのリポジトリのアクセス権限はきちんと設定する必要があります。

2.ローカルで Git SSH アクセス権限が設定されていることを確認します。`git clone git@github.com:xxx/certificates.git` を使用できます。

> *ここでは **すべて SSH Git Clone リポジトリを統一して使用することを推奨します**。なぜなら CI/CD でも同じ方法を使うからです。*

> *fastlane match を実行していて `If cloning the repo takes too long, you can use the `clone_branch_directly` option in match.` で止まる場合、ほとんどが SSH 権限の問題です。*

3. プロジェクトディレクトリで `bundle exec fastlane match init` を実行して設定を完了する

```lua
[21:54:32]: fastlane match は複数のストレージモードをサポートしています。使用したいモードを選択してください:
1. git
2. google_cloud
3. s3
4. gitlab_secure_files
# git を使う場合は 1 を入力
?   1

[22:04:40]: 証明書とプロファイルを保存するための新しいプライベート git リポジトリを作成してください
[22:04:40]: Git リポジトリの URL: git@github.com:xxx/certificates.git
# 作成した Git プライベート Match リポジトリの SSH URL を入力

[22:04:47]: './fastlane/Matchfile' を正常に作成しました。コードエディタで開くことができます。
[22:04:47]: これで `fastlane match development`、`fastlane match adhoc`、`fastlane match enterprise`、`fastlane match appstore` を実行できます
[22:04:47]: 各環境の最初の実行時にプロビジョニングプロファイルと
[22:04:47]: 証明書が作成されます。それ以降は既存のプロファイルを自動的にインポートします。
[22:04:47]: 詳細は https://docs.fastlane.tools/actions/match/ を参照してください
```

4.完了すると **`fastlane/Matchfile`** が生成されます：

```bash
# あなたのGitプライベートMatchリポジトリのSSH URL
git_url("git@github.com:xxxx/certificates.git")

storage_mode("git")

type("development") # デフォルトのタイプ。appstore、adhoc、enterprise、developmentのいずれかを指定可能

# app_identifier(["tools.fastlane.app", "tools.fastlane.app2"])
# username("user@fastlane.tools") # Apple Developer Portalのユーザー名

# 利用可能なオプションはすべて `fastlane match --help` で確認可能
# 他のオプションを有効にするには行頭の#を外してください

# ドキュメントは https://docs.fastlane.tools/actions/match にあります
```

**5. [App Store Connect API .p8 Key](https://developer.apple.com/documentation/appstoreconnectapi/creating-api-keys-for-app-store-connect-api){:target="_blank"} を生成し、APIキーを使って証明書を一元管理する:**

![](/assets/823ac523ccc8/1*RFhS_XtZ3TfIJBAeoE-laA.png)

> *⚠️️️️ [**App Store Connect API .p8 キー**](https://developer.apple.com/documentation/appstoreconnectapi/creating-api-keys-for-app-store-connect-api){:target="_blank"} **の権限は非常に強力です。** 証明書の管理だけでなく、アプリのリリースや審査申請、バックエンドのユーザー管理やレビュー、財務データのレポート操作も可能です。*

> *チームの .git に入れて全員がアクセスできるようにするかどうかは、チームの状況に応じて決めてください。*

> ***より高いリスク管理の方法は、管理者のみがアクセスでき、CI/CDで使用するために暗号化して保存することです（記事後半で紹介します）。***

> ***ここではデモのために fastlane ディレクトリ内に直接配置してアクセスしやすくしています。***

> ***また、本記事の Fastlane スクリプトは説明を簡単にするために、重複コードやプログラム構造を考慮していません。***

#### 証明書管理

```bash
platform :ios do
  lane :match_development do \\|options\\|
    # あなたの App Identifier ID に置き換えてください
    app_identifier = "li.zhgchg.myApp"

    type = options.fetch(:type, "development")
    isRead = options.fetch(:isRead, true)
    if isRead 
      readonly = true
      force = false
    else
      readonly = false
      force = true

      # App Store Connect API Key が必要で、Appleの管理画面で証明書を操作できます
      # App Store Connect API の .p8 キーが ./fastlane/ フォルダにあると仮定
      app_store_connect_api_key(
        key_id: "XXXXXX",
        issuer_id: "XXXXXX-XXXXXX-XXXXXX-XXXXXX-XXXXXX",
        key_filepath: "./fastlane/AuthKey_XXXXXX.p8",
      )
    end

    # app_identifier の Development 証明書を取得
    match(
      type: type,
      app_identifier: app_identifier, 
      readonly: readonly, # 必要に応じて cert / profile を更新・アップロードできるかどうか
      force: force # provisioning profile を無条件で再作成するかどうか
    )
  end
end
```

**Development Certificate と Profile を作成し、Match リポジトリにアップロード:**

```
bundle exec fastlane match_development type:development isRead:false
```

- エラーがなければ、Development Certificate と Profile の生成、インストール、そして Match リポジトリへの同期プッシュが成功したことを意味します。

**初回作成時に `Passphrase` の設定が必要です：**

```markdown
[23:29:12]: 証明書の暗号化/復号に使用するパスフレーズを入力してください
[23:29:12]: このパスフレーズはリポジトリごとに固有で、ローカルのキーチェーンに保存されます
[23:29:12]: パスワードは別のマシンで match を実行する際に必要になるため、必ず覚えておいてください
[23:29:12]: Match ストレージ用のパスフレーズ:
```

- この値は、あなたのすべての Match リポジトリ上のファイルを暗号化するためのソルトです。

- [ランダム文字列](https://www.random.org/strings/?num=1&len=32&digits=on&upperalpha=on&loweralpha=on&unique=on&format=html&rnd=new){:target="_blank"} を生成して設定し、記録することをお勧めします。

- 今後の更新や他のメンバーが Match リポジトリの証明書を取得する際には、この文字列を入力して元のファイルを復号化する必要があります。

**チームの他のメンバーは統一して Match Repo から Development Certificate と Profile を Pull する:**

```bash
bundle exec fastlane match_development type:development
```

**初回使用時にログインキーチェーンのパスワードを尋ねられます。これは証明書をキーチェーンにインストールするためで、パスワードを2回入力して確認してください:**

```markdown
[16:52:59]: 証明書をインストールしています...
[16:53:00]: ローカルのコード署名IDが見つかりません。
security find-identity -v -p codesigning を実行するとこの出力を得られます。
このStack Overflowのスレッドに詳細があります: https://stackoverflow.com/q/35390072/774。
(期限切れのWWDR証明書がないかKeychain Accessで確認してください: https://stackoverflow.com/a/35409835/774 に詳細があります。)
[16:53:00]: /Users/zhgchgli/Library/Keychains/login.keychain-db のパスワードを入力してください
[16:53:00]: このパスフレーズはローカルのキーチェーンに fastlane_keychain_login という名前で保存され、今後の実行で使用されます
[16:53:00]: このプロンプトは 'keychain_password' オプションまたは 'MATCH_KEYCHAIN_PASSWORD' 環境変数を指定することで回避できます
[16:53:00]: ログインキーチェーンのパスワード: ********
[16:53:24]: ログインキーチェーンのパスワードをもう一度入力してください: ********
```

**もし「Could not create another Development certificate, reached the maximum number of available Development certificates.」と表示された場合：**

代表作成された Development Certificate は上限（2つ）に達しています。まずは管理画面で使用していないものを削除してください。

> ***ここでまた別の罠にハマりました。プロジェクトをiCloudフォルダに置いてしまい、なぜかずっと証明書の問題が発生していました（おそらくキーチェーンのアクセスに問題があると思われます）。***

**もし Match Development で証明書を取得した後もエラーや無効と表示され続ける場合：**

> *多くの場合、古い証明書や複数の証明書が残っているため、Xcodeが混乱します。*

1. Xcodeを閉じる

2. MacOS キーチェーンを開く: `open /System/Library/CoreServices/Applications/Keychain\ Access.app`

3. login キーチェーン -> すべての項目 -> `apple development` を検索 -> すべての証明書を削除

4. Finder -> 移動 -> フォルダへ移動 -> `~/Library/Developer/Xcode/UserData/Provisioning Profiles/` -> すべてのプロファイルを削除

5. `bundle exec fastlane match_development` を再実行して証明書を取得する

6. Xcode を再起動すれば正常に戻るはずです。

—

**AdHoc 配布用証明書とプロファイルの作成および Match リポジトリへのアップロード:**

```bash
bundle exec fastlane match_development type:adhoc isRead:false
```

**AppStore 配布用証明書とプロファイルの作成および Match リポジトリへのアップロード：**

```bash
bundle exec fastlane match_development type:appstore isRead:false
```

**CI/CD サービスは一元的に Match リポジトリから Distribution Certificate と Profile（`isRead:true`）をプルし、その後ビルドとリリース作業を実行します。**

#### 新しいデバイスの登録

```php
platform :ios do  
  desc "新しいデバイスを登録してプロファイルを更新する"
  lane :registerDevice do \\|options\\|
    # あなたの App Identifier ID に変更してください
    app_identifier = "li.zhgchg.myApp"

    # App Store Connect API Key が必要で、Appleの管理画面で証明書を管理する権限があります
    # App Store Connect API の .p8 キーが ./fastlane/ ディレクトリにあると仮定
    app_store_connect_api_key(
      key_id: "XXXXXX",
      issuer_id: "XXXXXX-XXXXXX-XXXXXX-XXXXXX-XXXXXX",
      key_filepath: "./fastlane/AuthKey_XXXXXX.p8",
    )
    # 入力: UDID とデバイス名
    udid = options[:udid] \\|\\| UI.input("デバイスのUDIDを入力してください:")
    device_name = options[:name] \\|\\| UI.input("デバイス名を入力してください:")
    UI.message("📱 デバイスを登録中 #{device_name} (#{udid})")
    register_device(
      name: device_name,
      udid: udid,
      platform: 'ios'
    )

    # app_identifier の Development 証明書を更新
    match(
      type: "development",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じて cert / profile を更新・アップロード
      force_for_new_devices: true # 新しいデバイスの場合、provisioning profile を再作成
    )

    # app_identifier の AdHoc 証明書を更新
    match(
      type: "adhoc",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じて cert / profile を更新・アップロード
      force_for_new_devices: true # 新しいデバイスの場合、provisioning profile を再作成
    )
  end
end
```

登録後、他の開発者や CI/CD サービスが Match リポジトリから Profile（Development または AdHoc）を取得すると、新しいデバイスが含まれます。

### Fastlane Match x CI/CD ワークフロー統合

Fastlane MatchでPushおよびPull証明書を生成した大まかな説明が終わったので、次にCI/CDプロセスへの統合方法について説明します。

#### 問題1 — Private Match リポジトリをどうやってクローンするか

最もよくある問題の一つは、CI/CD 上でどうやって Private Match Repo プロジェクトを Clone するかです。ローカル開発では、統一して ssh git clone を使い、自分のアカウントの ssh key を使っているので問題ありません。しかし、CI/CD にはその key がありません。もちろん個人の key を使うこともできますが、安全とは言えません。

**GitHub — リポジトリデプロイキー：**

1.まずローカルでプライベートキーとパブリックキーを生成します: `ssh-keygen -t rsa -b 4096 -f ./id_rsa` ( **パスフレーズは入力しないでください** )

2. **Match Private Repo** -&gt; Settings -&gt; Security -&gt; Deploy keys -&gt; Add deploy key に移動します:

![](/assets/823ac523ccc8/1*nzo-oPRi7DDxPvtJIWBspw.png)

3. テキストエディタで「 `id_rsa.pub` 」を開き、内容をコピーして Key ->「Add key」に貼り付けます

![](/assets/823ac523ccc8/1*mbwtijzM-2iAzfgFiT32rw.png)

5. メインのリポジトリに戻り、Settings -> Security -> Secrets and variables に移動します

![](/assets/823ac523ccc8/1*jvY8Yg6tI85LNKHgIaHVVQ.png)

5. SSHプライベートキーの内容をSecretに追加:

![](/assets/823ac523ccc8/1*8WiPfOz21rJWD6yiMwP3aw.png)

- 名前: `MATCH_REPO_DEPLOY_PRIVATE_KEY`

6. メインリポジトリの GitHub Actions に SSH キーを設定する:

```yaml
name: CI - Deploy

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (リポジトリA)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: クローンテスト
        run: \\|
          git clone git@github.com:xxxx/match-certificates.git
# 成功！
# .. デプロイジョブを実行...
```

7. 設定成功！

#### 問題2— App Store Connect API .p8 キーの安全な保管と使用

Github Actions はファイルを保存できないため、まず文字列として保存し、その後ファイルに書き込みます。

1. 同じ手順1で、メインリポジトリに `APP_STORE_CONNECT_API_KEY_CONTENT` シークレットを追加してください。

2. テキストエディタで `AuthKey_XXXXXX.p8` を開き、内容をコピーして貼り付けてください。

3. **メインリポジトリの GitHub Actions に内容を読み取りファイルに書き込むステップを追加:**

```yaml
name: CI - デプロイ
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (Repo A)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: シークレットキーをファイルに書き込む
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # 内容を書き込み（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （任意）権限を制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
        run: bundle exec fastlane deploy_to_firebase
```

#### 問題3 — Private Match Repo のパスフレーズ設定で、Match 実行時のプロンプト中断を防ぐ

1. 同じ手順1で、メインリポジトリに `MATCH_PASSWORD` をシークレットとして追加してください。

2. Fastlane Match リポジトリに設定した `Passphrase` を入力してください。

3. **メインリポジトリの GitHub Actions に** `env: secret.MATCH_PASSWORD` **を追加：**

```yaml
name: CI - Deploy
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (リポジトリ A)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: シークレットキーをファイルに書き込む
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # ファイルに内容を書き込む（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （任意）パーミッションを制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"、
        run: bundle exec fastlane deploy_to_firebase
```

#### 問題4 — Self-hosted Runner 上の Keychain 処理

クラウドのマシンが毎回クリーンで新しい環境であるのと違い、Self-hosted Runner を使う場合は Fastlane で `derived_data_path`、`output_directory`、`buildlog_path`、`reinstall_app` を指定して毎回クリーンな環境を作れます。しかし、Certificates や Profiles はシステムの Keychain にインストールされるため、どう扱うべきでしょうか？

実は Fastlane は私たちのために、Match の前にクリーンな Keychain を作成する方法も用意しています：

```yaml
name: CI - Deploy
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (Repo A)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: シークレットキーをファイルに書き込み
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # 内容を書き込み（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （任意）パーミッションを制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: fastlaneキーチェーンを作成
        env:
          KEYCHAIN_NAME: "${{ runner.name }}"
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
        run: \\|
          bundle exec fastlane run create_keychain \
            name:"$KEYCHAIN_NAME" \
            password:"$MATCH_PASSWORD" \
            unlock:true \
            timeout:0 \
            lock_when_sleeps:false
      
      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
          KEYCHAIN_NAME: "${{ runner.name }}"
        run: bundle exec fastlane deploy_to_firebase

      # 🔥 成功・失敗に関係なく必ず実行
      - name: fastlaneキーチェーンを削除
        if: always()
        env:
          KEYCHAIN_NAME: ${{ runner.name }}
        run: \\|
          bundle exec fastlane run delete_keychain \
            name:"$KEYCHAIN_NAME"
```

- 各 Runner は同時に一つだけ実行されるため、Runner Name を Keychain Name として使用し、各 Runner はそれぞれ自分の Keychain を持ちます。

- 実行完了後、成功・失敗に関わらず削除されます。

- `keychain_password` は特に別途設定せず、統一して `MATCH_PASSWORD` を使用しました。

`Fastlane/Fastfile` の match メソッドに keychain パラメータを追加する:

```ruby
#...
    match(
      type: "adhoc",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じて cert / profile を更新・アップロードする
      force_for_new_devices: true # 新しいデバイスの場合は provisioning profile を再作成する
      keychain_name: ENV['KEYCHAIN_NAME'], # デフォルト値: nil
      keychain_password: ENV['MATCH_PASSWORD'] # デフォルト値: nil
    )
#...
```

こうすることで、Match が証明書を取得する際に、共有の login キーチェーンではなく、指定したキーチェーンに保存されます。

### 結論

Fastlane の範囲は広いため、ここでは Fastlane Match の使用過程のみを記録します。Fastlane を使ったテスト実行やビルド・リリースなどの他の Lane については、機会があれば別の記事で補足します。Match に関する他の問題や事例があれば、また追記しますので、コメントで質問も歓迎します！

### 関連記事

- [CI/CD 実践ガイド（1）：CI/CD とは？CI/CD を使って安定かつ効率的な開発チームを作る方法は？ツールの選び方は？](../c008a9e8ceca/)

- [CI/CD 実践ガイド（二）：GitHub Actions と self-hosted Runner の使用と構築大全](../404bd5c70040/)

- [CI/CD 実践ガイド（3）：GitHub Actions を使ったアプリプロジェクトの CI と CD ワークフローの実装](../4b001d2e8440/)

- [CI/CD 実践ガイド（4）：Google Apps Script Web App を使って GitHub Actions と連携し、無料で使いやすいパッケージングツールプラットフォームを構築する](../4273e57e7148/)

**ぜひご覧ください。🤞🏻**

ご質問やご意見がありましたら、[こちらからご連絡ください](https://www.zhgchg.li/contact){:target="_blank"} 。

*[Post](https://medium.com/zrealm-ios-dev/ios-certificates-identifiers-profiles-%E6%98%AF%E4%BB%80%E9%BA%BC%E5%8F%8A-fastlane-match-%E7%B5%B1%E4%B8%80%E7%AE%A1%E7%90%86%E6%86%91%E8%AD%89%E8%88%87-ci-cd-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AD%86%E8%A8%98-823ac523ccc8){:target="_blank"} Mediumから[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}によって変換されました。