---
author: ZhgChgLi
categories:
- ZRealmの開発
date: 2026-01-03T17:03:46.382+0000
description: iOS開発者向けにCertificates、Identifiers、Profilesの関係を解説し、Fastlane Matchで証明書を一元管理しCI/CDに組み込む手順を詳述。管理負担を軽減し安全な自動化を実現します。
image:
  path: /assets/823ac523ccc8/1*-OS8G9xu0CFpnlAQRgnGAg.jpeg
last_modified_at: 2026-01-04T02:51:43.896+0000
render_with_liquid: false
tags:
- iosアプリ開発
- fastlane
- キーチェーン
- github-actions
- macos
- japanese
- ai-translation
title: iOS Certificates, Identifiers & Profilesの関係｜Fastlane Matchで憑證管理とCI/CDを効率化
---

### iOS Certificates、Identifiers、Profilesとは何かおよび**Fastlane Matchによる統一**管理**証明書とCI/CDに関するメモ**

Certificates、Identifiers、Profilesの関係とFastlane Matchを使った証明書の一元管理およびCI/CDワークフローへの統合についての記録。

![Photo by [marcos mayer](https://unsplash.com/@mmayyer?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/823ac523ccc8/1*-OS8G9xu0CFpnlAQRgnGAg.jpeg)

Photo by [marcos mayer](https://unsplash.com/@mmayyer?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}

#### 前書き

2025年中に、0から1までのGitHub Actionsを使ったApp CI/CDの完全な構築プロセスに関する一連の記事を書きました：

- [CI/CD 実践ガイド（1）：CI/CDとは何か？CI/CDを使って安定かつ効率的な開発チームを作る方法は？ツールの選択は？](../c008a9e8ceca/)

- [CI/CD 実践ガイド（二）：GitHub Actions と self-hosted Runner の使用と構築大全](../404bd5c70040/)

- [CI/CD 実践ガイド（三）：GitHub Actions を使ったアプリプロジェクトの CI と CD ワークフローの実装](../4b001d2e8440/)

- [CI/CD 実践ガイド（4）：Google Apps Script Web App を使って GitHub Actions と連携し、無料で使いやすいパッケージングツールプラットフォームを構築する](../4273e57e7148/)

最近新しい環境で再度実行しましたが、毎回新しいことを学んでいます。今回はiOSのコードサイニング：Certificates / Profiles / Devicesの関係に焦点を当て、Fastlane Matchを使って証明書管理とCI/CDを連携させる方法についてです。

### [Certificates, Identifiers & Profiles、Devicesとは何ですか？](https://developer.apple.com/account/resources/certificates/list){:target="_blank"}

Apple エコシステムでは、アプリ開発は証明書とプロビジョニングプロファイルの管理に基づいており、Androidのように .apk があればインストールして使用できるわけではありません。Apple は厳格な証明書対応の管理を行っており、規則に合わない場合はインストールや使用ができません。

#### **主要な項目の構成と機能：**

![](/assets/823ac523ccc8/1*PyM0l-jXXcVBKubOwCiTsw.png)

#### **Certificates:** アプリの署名に使う身分 (Signing Identity)

- **Development** — 開発段階で実機で使用（シミュレーターのみの場合は証明書不要）、所属は個人またはAPIキー（数に制限あり）。

- **Distribution** — App Store、TestFlight、またはAd Hoc内テスト（登録済みデバイス限定）での配布用で、数に制限があり、チームに所属します。

- **Enterprise** — 企業内で使用するアプリ。

> ***フォーマット*** *：使用するには `Private Key (秘密鍵)` と `Certificate .cer (公開鍵証明書)` の両方が必要です。または、作成した元のコンピュータのキーチェーンから `.p12` ファイルとしてエクスポートすると両方が含まれます。*

![](/assets/823ac523ccc8/1*oP_p2kJ1Prqku4D8LIZ7yg.png)

#### **Identifiers: どのApp/Extensionか（Bundle ID）**

AppのBundle ID登録と有効にする必要があるCapabilities（例えばPush NotificationsやApp Groupsの有効化など）、App Services。

Extension も独自の Identifier を持ちます。

#### **Devices: 登録済みデバイス (iPhone/iPadなど)**

Developmentは実機で動作し、Distribution Ad Hocの内測は登録されたデバイスのみ使用可能です。

> ***上限：100個；キャンセルを含め、毎年の支払いサイクルまでリリース枠はリセットされません。***

#### **Provisioning Profile (以下略してProfile): プロビジョニングプロファイル**

Certificates+Identifiers+Devices の関係の組み合わせ。

- **Development** — 開発段階で使用するプロビジョニングプロファイルで、実機テストに必須です。プロファイルはCertificates、Identifiers、Devicesの関係を含みます。

- **Ad Hoc** — 内部テスト用にパッケージするプロビジョニングプロファイル（例：Firebase App Distributionへの配布）で、Certificates、Identifiers、Devicesの関係を含みます。

- **App Store** — App Store / TestFlight にアップロードするためのプロビジョニングプロファイルで、Certificates と Identifiers の関係を含みます。

> *フォーマット： `.mobileprovision`*

> ***注意：Profileは単なる記述ファイルであり、関係性を示すものであって、証明書自体は含まれていません。***

#### 小結

総合すると、クリーンなマシンでXcodeのAppleアカウントにログインせずに実機ビルド（Development Certificate）やアーカイブビルド（Distribution Certificate）を行うには、**2つのファイルが必須**です：

- `.mobileprovision` プロビジョニングプロファイル: Certificates+Identifiers+Devices の関係を記述。

- `.p12` Certificate: 証明書の実体（元の作成したコンピュータからエクスポート）。

**また、macOS 15以降のKeychainは以下に移動しました：**

```bash
open /System/Library/CoreServices/Applications/Keychain\ Access.app
```

*ずっと探してた...*

#### よくあるエラー

**⚠️⚠️⚠️ 証明書やプロファイルが正しいのにエラーが出る場合：**

> *多くの場合、古い証明書や複数の証明書が残っているため、Xcodeが混乱します。*

> ***この問題はよく発生します！***

1. Xcodeを閉じる

2. macOSキーチェーンを開く: `open /System/Library/CoreServices/Applications/Keychain\ Access.app`

3. loginキーチェーン -> すべての項目 -> `apple development` を検索 -> すべての証明書を削除

4. Finder -> 移動 -> フォルダへ移動 -> `~/Library/MobileDevice/Provisioning\ Profiles` -> すべてのプロファイルを削除する

5. 証明書を再取得する

6. Xcodeを再起動すれば正常に動作するはずです。

**署名証明書 “iOS Distribution” が見つかりません / 署名証明書 “iOS Development” が見つかりません：**

```vbnet
チームID "" に一致するプライベートキー付きの「iOS Distribution」署名証明書が見つかりませんでした。
チームID "" に一致するプライベートキー付きの「iOS Development」署名証明書が見つかりませんでした。
```

**理由:**

- iOS Distribution/iOS Development 証明書が不足しています

- iOS Distribution/iOS Development 証明書はありますが、対応するプライベートキーがありません

**解決策:**

- Keychain内のすべての古いCertificates証明書、Profilesプロビジョニングプロファイルを削除する

- 最初にCertificateを作成したコンピュータのKeychainで該当の証明書を見つけ、`.p12`形式でエクスポートし、問題のあるコンピュータにインストールします。

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} にアクセスし、古い証明書を取り消して再生成します  
  （ご安心ください、オンライン版のAppには影響せず、開発とビルド段階のみ影響します）

**プロビジョニングプロファイル “” に署名証明書 “Apple Development: XXX” が含まれていません。 / プロビジョニングプロファイル “” に署名証明書 “Apple Distribution: XXX” が含まれていません。:**

**理由:**

- 現在選択されているProvisioning Profileは、現在のCertificateと一致していません。

**解決方法:**

- Keychain 内のすべての古い Certificates 証明書と Profiles プロビジョニングプロファイルを削除する

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} にアクセスし、プロファイルで対応する証明書が選択されているか、またはプロファイルを再生成して使用してください。

**チーム ‘’ に対応する ‘’ のプロファイルが見つかりません: Xcodeは ‘’ に一致するプロビジョニングプロファイルを見つけられませんでした。:**

**理由:**

- 指定されたプロビジョニングプロファイルが見つかりません。

**解決策:**

- Keychain内のすべての古いCertificates証明書とProfilesプロファイルを削除する

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の Profiles から対応するプロファイルをダウンロードして使用する

**プロビジョニングプロファイル “” のアプリID “” は、バンドルID “” と一致しません。 / プロビジョニングプロファイルがバンドル識別子と一致しません：**

**理由:**

- Provisioning profile に現在の Bundle Identifier が含まれていません

**解決策:**

- Keychain 内のすべての古い Certificates 証明書と Profiles プロビジョニングプロファイルを削除する

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の Identifiers で Bundle Identifier が登録されていることを確認してください

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の Profiles から対応するプロファイルをダウンロードして使用します。

**プロビジョニングプロファイル “” に現在選択されているデバイス “”（識別子 ）が含まれていません。:**

**理由:**

- Provisioning profile に選択した実機の Device Identifier が含まれていません

**解決策:**

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の Devices に実機の識別子が登録されていることを確認してください

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} の Profiles にある該当するプロビジョニングプロファイルで、実機にチェックが入っていることを確認してください。

- プロファイルの再ダウンロードに使用します

**別の開発／配布証明書を作成できません。利用可能な開発／配布証明書の最大数に達しました。 :**

**理由:**

作成された Development/Distribution 証明書が上限数に達しています。

**解決策:**

- [Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates/list){:target="_blank"} にアクセスし、使用していない証明書を削除してください。

**Xcodeの証明書は正しく正常にビルドできるが、CLI（Fastlane）でビルドコマンドを実行すると署名エラーが発生する:**

**理由:**

こちらでもう一つの落とし穴に遭遇しました。プロジェクトをうっかりiCloudの同期フォルダに置いてしまい、なぜかFastlaneでずっと証明書の問題（おそらくkeychainのアクセス問題）が発生しました。

**解決策:**

iCloud同期フォルダから移動するだけです。

### 日常使用の問題シーン

#### 開発用証明書

![](/assets/823ac523ccc8/1*W8bgbVPEBOQZyHBEKZHmAw.png)

- Matchを導入して証明書を一元管理する前は、各開発者がそれぞれ自分の`Development Certificate`と`Development Profile`を作成していました。組織内に1,000人以上の開発者がいる場合、[Certificates, Identifiers & Profiles, Devices](https://developer.apple.com/account/resources/certificates/list){:target="_blank"}の管理画面は非常に混乱し、恐ろしい状態になります。

- 外部の開発チームが開発のみを担当する場合でも、Apple Developer Programの管理画面に追加し、彼ら自身の開発証明書とプロビジョニングプロファイルを作成させる必要があります。

#### 配布用証明書

![](/assets/823ac523ccc8/1*z00mYi900fkZV-EmHXMCeg.png)

- Distribution Certificate はチーム単位で作成されるため、各開発者プランのチームは限られた数の配布証明書しか作成できません。

- 一般的な方法としては、エンジニアの一人がDistribution Certificateを作成し、.p12ファイルをエクスポートして、他のリリース担当の開発者やCI/CDマシンで使用します。

- チームが大きく、アプリの数が多いと、やり取りが非常に面倒で、**毎年更新が必要です**。

- **Ad Hocでパッケージングする際、新しいデバイスが登録されると、全員およびCI/CDがプロファイルを再ダウンロードしないと新しいデバイスが有効になりません。**

### [Fastlane Match](https://docs.fastlane.tools/actions/match/){:target="_blank"}

以上の問題を踏まえ、証明書に関するすべての管理を代行してくれるプラットフォームが必要です。すべての開発者とCI/CDサービスはこのプラットフォームから統一してデータを取得・更新します。このプラットフォームの保存は安全でなければなりません。これが— [Fastlane Match](https://docs.fastlane.tools/actions/match/){:target="_blank"} です。

> *チーム全体で証明書とプロファイルを簡単に同期*

> *iOSおよびmacOSのコード署名における新しい方法：開発チーム全体で1つのコード署名IDを共有し、コード署名の設定を簡素化し、コード署名の問題を防ぎます。*

> *matchは[codesigning.guide concept](https://codesigning.guide/){:target="_blank"}の実装です。matchは必要なすべての証明書とプロビジョニングプロファイルを作成し、それらを別のGitリポジトリ、Google Cloud、またはAmazon S3に保存します。選択したストレージにアクセスできるチームメンバーは誰でも、これらの資格情報をコード署名に使用できます。matchは壊れた資格情報や期限切れの資格情報も自動で修復します。チーム間で署名資格情報を共有する最も簡単な方法です*

![](/assets/823ac523ccc8/1*UEL7Abx3PFrYbAc2yVlq8A.png)

**Fastlane Match：**

- App Store Connect と連携する（App Store Connect API または Apple Developer ログインセッションを通じて）、証明書を生成または更新する

- 証明書の結果（`.mobileprovision` プロファイル、`.p12` 証明書、`.cer` 証明書）の3つのファイルを暗号化してGitリポジトリにアップロードします（他のストレージも使用可能です）。  
  `.cer` 証明書は別途保存します。これは証明書の有効性を確認するためです。

- 権限を細かく分ける場合、Development証明書を管理するリポジトリとDistribution証明書を管理するリポジトリの2つに分けることができます。

[**フォルダ構成:**](https://docs.fastlane.tools/actions/match/){:target="_blank"}

- `certs`フォルダには、すべての証明書とそれに対応する秘密鍵が含まれています。

- `profiles` フォルダにはすべてのプロビジョニングプロファイルが含まれています。

![<https://docs.fastlane.tools/actions/match/>{:target="_blank"}](/assets/823ac523ccc8/1*mStp0t3Ty3xGTKvbiBGtqw.png)

<https://docs.fastlane.tools/actions/match/>{:target="_blank"}

暗号化アルゴリズム： [AES-256-GCM](https://github.com/fastlane/fastlane/blob/master/match/lib/match/encryption/encryption.rb){:target="_blank"}

**開発者、CI/CD サービス：**

- Fastlane match コマンドを使って証明書を一元管理する。

- Fastlane Match はまず Git リポジトリから証明書ファイルを取得し、復号して使用します。期限切れや使用不可の場合、権限（Create/Write）があれば自動で再生成し、リポジトリにプッシュします。Read 権限のみの場合はエラーになります。

**作成/記述：**

- 証明書の管理を担当する人だけが証明書を生成・更新し、Pushでアップロードできます。

**読む：**

- 他の開発者やCI/CDサービスは **読み取り専用** のPull証明書権限のみ持っています。

- CI/CDサービスは、ジョブを実行するたびに最新の証明書を取得します。

### Fastlane Match 設定と使用

Git Storage を例にとると、すべての証明書。

**1.空の証明書保存用GitプライベートMatchリポジトリを作成する**  
すべてのCertificatesやProfilesは暗号化されて保存されますが、そのリポジトリのアクセス権限は適切に設定する必要があります。

2. ローカルにGitのSSHアクセス権限が設定されていることを確認します。`git clone git@github.com:xxx/certificates.git` を使用できます。

> *ここでは **SSH Git Cloneリポジトリを統一して使用することを推奨します**。なぜならCI/CDでも同じ方法を使うからです。*

> *fastlane match を実行していて `If cloning the repo takes too long, you can use the `clone_branch_directly` option in match.` で止まる場合、多くは SSH 権限の問題です。*

3. プロジェクトディレクトリで `bundle exec fastlane match init` を実行して設定を完了する

```lua
[21:54:32]: fastlane match は複数のストレージモードをサポートしています。使用したいものを選択してください:
1. git
2. google_cloud
3. s3
4. gitlab_secure_files
# 1 を入力して git を使用
?   1

[22:04:40]: 証明書とプロファイルを保存するための新しいプライベートgitリポジトリを作成してください
[22:04:40]: GitリポジトリのURL: git@github.com:xxx/certificates.git
# 作成したGitプライベートMatchリポジトリのSSH URLを入力

[22:04:47]: './fastlane/Matchfile' を正常に作成しました。コードエディタでファイルを開けます。
[22:04:47]: これで `fastlane match development`、`fastlane match adhoc`、`fastlane match enterprise`、`fastlane match appstore` を実行できます
[22:04:47]: 各環境で最初に実行すると、プロビジョニングプロファイルと
[22:04:47]: 証明書が作成されます。それ以降は既存のプロファイルを自動でインポートします。
[22:04:47]: 詳細は https://docs.fastlane.tools/actions/match/ をご覧ください
```

4.完了すると **`fastlane/Matchfile` :** が生成されます。

```bash
# あなたのGitプライベートMatchリポジトリのSSH URL
git_url("git@github.com:xxxx/certificates.git")

storage_mode("git")

type("development") # デフォルトのタイプ。appstore、adhoc、enterprise、developmentが指定可能

# app_identifier(["tools.fastlane.app", "tools.fastlane.app2"])
# username("user@fastlane.tools") # あなたのApple Developer Portalのユーザー名

# 利用可能なオプションは `fastlane match --help` で確認できます
# 行頭の#を外すと他のオプションが有効になります

# ドキュメントは https://docs.fastlane.tools/actions/match で確認可能です
```

**5. [App Store Connect API .p8 Key](https://developer.apple.com/documentation/appstoreconnectapi/creating-api-keys-for-app-store-connect-api){:target="_blank"} を作成し、APIキーを使って証明書を一元管理する:**

![](/assets/823ac523ccc8/1*RFhS_XtZ3TfIJBAeoE-laA.png)

> *⚠️️️️ [**App Store Connect API .p8 Key**](https://developer.apple.com/documentation/appstoreconnectapi/creating-api-keys-for-app-store-connect-api){:target="_blank"} **の権限は非常に強力** なので、証明書の管理だけでなく、アプリのリリースや審査申請、バックエンドのユーザー管理やレビュー、財務レポートの管理も可能です。*

> *チームの状況に応じて、全員がアクセスできるようにチームの .git に入れるかどうかを決めてください。*

> ***より高いセキュリティ対策としては、管理者のみがアクセスでき、CI/CDで使用する際は暗号化して保存する方法があります（記事の最後で紹介します）。***

> ***ここではデモのためにfastlaneディレクトリ内に直接配置しています。***

> ***また、本記事のFastlaneスクリプトは表示を簡単にするため、コードの重複や構造は考慮していません。***

#### 証明書管理

```bash
platform :ios do
  lane :match_development do \\|options\\|
    # あなたの App Identifier ID に変更してください
    app_identifier = "li.zhgchg.myApp"

    type = options.fetch(:type, "development")
    isRead = options.fetch(:isRead, true)
    if isRead 
      readonly = true
      force = false
    else
      readonly = false
      force = true

      # Appleの管理画面で証明書を操作するにはApp Store Connect APIキーが必要です
      # App Store Connect APIの.p8キーが ./fastlane/ フォルダにあると仮定します
      app_store_connect_api_key(
        key_id: "XXXXXX",
        issuer_id: "XXXXXX-XXXXXX-XXXXXX-XXXXXX-XXXXXX",
        key_filepath: "./fastlane/AuthKey_XXXXXX.p8",
      )
    end

    # app_identifierのDevelopment証明書を取得します
    match(
      type: type,
      app_identifier: app_identifier, 
      readonly: readonly, # 必要に応じてcert/profileを更新・アップロードできるかどうか
      force: force # プロビジョニングプロファイルを無条件に再作成するかどうか
    )
  end
end
```

**Development Certificate と Profile を作成し、Match リポジトリにアップロードする:**

```
bundle exec fastlane match_development type:development isRead:false
```

- エラーがなければ、Development Certificate と Profile の生成、インストール、および Match リポジトリへの同期プッシュが成功したことを意味します。

**初回作成時に `Passphrase` の設定が必要です：**

```markdown
[23:29:12]: 証明書の暗号化/復号に使用するパスフレーズを入力してください
[23:29:12]: このパスフレーズはリポジトリごとに固有で、ローカルキーチェーンに保存されます
[23:29:12]: 別のマシンでmatchを実行する際に必要になるため、パスワードを忘れないようにしてください
[23:29:12]: Matchストレージのパスフレーズ:
```

- この値は、あなたのすべての Match リポジトリ上のファイルを暗号化する際に必要となる参照（パスフレーズ + ランダムソルト）です。

- ランダムな[文字列](https://www.random.org/strings/?num=1&len=32&digits=on&upperalpha=on&loweralpha=on&unique=on&format=html&rnd=new){:target="_blank"}を生成し、設定して記録することをおすすめします。

- 今後の更新や他の人がMatchリポジトリの証明書を取得する際に、この文字列を入力して元のファイルを復号化する必要があります。

**チームの他のメンバーはMatchリポジトリからDevelopment証明書とプロファイルをPullで統一取得:**

```bash
bundle exec fastlane match_development type:development
```

**初回使用時にログインパスワード（login keychain）を尋ねられます。これは証明書をkeychainにインストールするためで、2回入力して確認してください:**

```markdown
[16:52:59]: 証明書をインストールしています...
[16:53:00]: ローカルのコード署名IDが見つかりませんでした。
security find-identity -v -p codesigning を実行すると、この出力を得られます。
詳細はこのStack Overflowのスレッドをご覧ください: https://stackoverflow.com/q/35390072/774。
（Keychain Accessで期限切れのWWDR証明書を確認してください: https://stackoverflow.com/a/35409835/774 に詳細があります。）
[16:53:00]: /Users/zhgchgli/Library/Keychains/login.keychain-db のパスワードを入力してください
[16:53:00]: このパスフレーズはローカルキーチェーンに fastlane_keychain_login という名前で保存され、今後の実行で使用されます
[16:53:00]: このプロンプトは 'keychain_password' オプションまたは 'MATCH_KEYCHAIN_PASSWORD' 環境変数を指定することで回避できます
[16:53:00]: ログインキーチェーンのパスワード: ********
[16:53:24]: ログインキーチェーンのパスワードを再入力してください: ********
```

**もし Match Development で証明書を取得した後に Xcode がエラーや無効と表示し続ける場合:**

前述のよくあるエラーを参考にすると、多くの場合は古い不要な証明書が原因です。すべての証明書を削除してから再取得すれば解決するはずです。

—

**AdHoc配布用の証明書とプロファイルを作成し、Matchリポジトリにアップロードする:**

```bash
bundle exec fastlane match_development type:adhoc isRead:false
```

**AppStore用のDistribution CertificateとProfileを作成し、Matchリポジトリにアップロード：**

```bash
bundle exec fastlane match_development type:appstore isRead:false
```

**CI/CDサービスは一元的にMatchリポジトリからDistribution CertificateとProfile（`isRead:true`）をPullし、その後ビルドとリリースのタスクを実行します。**

#### 新しいデバイスの登録

```php
platform :ios do  
  desc "新しいデバイスを登録してプロファイルを更新する"
  lane :registerDevice do \\|options\\|
    # あなたのApp Identifier IDに変更してください
    app_identifier = "li.zhgchg.myApp"

    # App Store Connect API Keyが必要で、Appleのバックエンドで証明書を管理する権限があります
    # App Store Connect APIの.p8キーは./fastlane/ディレクトリ内にあると仮定します
    app_store_connect_api_key(
      key_id: "XXXXXX",
      issuer_id: "XXXXXX-XXXXXX-XXXXXX-XXXXXX-XXXXXX",
      key_filepath: "./fastlane/AuthKey_XXXXXX.p8",
    )
    # 入力: UDIDとデバイス名
    udid = options[:udid] \\|\\| UI.input("デバイスのUDIDを入力してください:")
    device_name = options[:name] \\|\\| UI.input("デバイス名を入力してください:")
    UI.message("📱 デバイス #{device_name} (#{udid}) を登録中")
    register_device(
      name: device_name,
      udid: udid,
      platform: 'ios'
    )

    # app_identifierのDevelopment証明書を更新
    match(
      type: "development",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じてcert/profileを更新・アップロード
      force_for_new_devices: true # 新しいデバイスの場合はプロビジョニングプロファイルを再作成
    )

    # app_identifierのAdHoc証明書を更新
    match(
      type: "adhoc",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じてcert/profileを更新・アップロード
      force_for_new_devices: true # 新しいデバイスの場合はプロビジョニングプロファイルを再作成
    )
  end
end
```

登録後、他の開発者やCI/CDサービスがMatchリポジトリからProfile（DevelopmentまたはAdHoc）を取得すると、新しいデバイスが含まれます。

### Fastlane Match x CI/CD ワークフロー統合

Fastlane MatchでPush／Pull証明書を生成・取得する方法を大まかに紹介した後は、次にCI/CDプロセスへの統合方法について説明します。

#### 問題1 — プライベートなMatchリポジトリをどうやってクローンするか

最もよくある問題の一つは、CI/CDでプライベートなMatchリポジトリをどうやってクローンするかです。ローカル開発ではssh git cloneを統一して使い、自分のアカウントのsshキーを使っているため問題ありません。しかし、CI/CDにはこのキーがなく、個人のキーを使うこともできますが、安全とは言えません。

**GitHub — リポジトリデプロイキー:**

1.ローカルでプライベートキーとパブリックキーを生成します: `ssh-keygen -t rsa -b 4096 -f ./id_rsa` ( **パスフレーズは入力しないでください** )

2. **Match Private Repo** -&gt; 設定 -&gt; セキュリティ -&gt; デプロイキー -&gt; デプロイキーを追加:

![](/assets/823ac523ccc8/1*nzo-oPRi7DDxPvtJIWBspw.png)

3. テキストエディタで「 `id_rsa.pub` 」を開き、内容をコピーしてKey -> 「Add key」に貼り付ける

![](/assets/823ac523ccc8/1*mbwtijzM-2iAzfgFiT32rw.png)

5. メインのリポジトリに戻り、Settings → Security → Secrets and variables へ移動します。

![](/assets/823ac523ccc8/1*jvY8Yg6tI85LNKHgIaHVVQ.png)

5. SSHプライベートキーの内容をSecretに追加:

![](/assets/823ac523ccc8/1*8WiPfOz21rJWD6yiMwP3aw.png)

- 名前: `MATCH_REPO_DEPLOY_PRIVATE_KEY`

6. メインリポジトリの GitHub Actions に SSH キーを設定する:

```yaml
name: CI - Deploy

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (Repo A)
        uses: actions/checkout@v4

      - name: デプロイキー用SSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: クローンテスト
        run: \\|
          git clone git@github.com:xxxx/match-certificates.git
# 成功！
# .. デプロイジョブを実行...
```

7. 設定成功！

#### 問題2— App Store Connect API .p8 キーの安全な保管と使用

GitHub Actions はファイルを保存できないため、まず文字列として保存し、その後ファイルに書き込む必要があります。

1. 同じ問題1の手順で、メインリポジトリに `APP_STORE_CONNECT_API_KEY_CONTENT` シークレットを追加します。

2. テキストエディタで `AuthKey_XXXXXX.p8` を開き、内容をコピーして貼り付けてください。

3. **メインリポジトリのGitHub Actionsに、内容を読み取りファイルに書き込むステップを追加：**

```yaml
name: CI - Deploy
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (リポジトリA)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: 秘密鍵をファイルに書き込む
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # 内容を書き込む（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （任意）権限を制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
        run: bundle exec fastlane deploy_to_firebase
```

#### 問題3 — Private Match Repoのパスフレーズ設定で、Match実行時のプロンプト中断を防ぐ

1. 同じ問題 1 の手順で、メインリポジトリに `MATCH_PASSWORD` を Secret として追加する

2. 内容を入力し、設定した Fastlane Match リポジトリの `Passphrase` を入力してください

3. **メインリポジトリの GitHub Actions に** `env: secret.MATCH_PASSWORD` **を追加：**

```yaml
name: CI - デプロイ
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (リポジトリA)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSHセットアップ
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: シークレットキーをファイルに書き込む
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # 内容をファイルに書き込む（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （オプション）パーミッションを制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
        run: bundle exec fastlane deploy_to_firebase
```

#### 問題4 — Self-hosted Runner 上の Keychain 処理

クラウドマシンのように毎回クリーンで新しい環境とは異なり、Self-hosted Runnerを使用する場合、Fastlaneで `derived_data_path` 、 `output_directory` 、 `buildlog_path` 、 `reinstall_app` を指定して毎回クリーンな環境を作ることができます。しかし、CertificatesやProfilesはシステムのKeychainにインストールされるため、これらはどう扱えばよいのでしょうか？

実は Fastlane は私たちのために、Match の前にクリーンな Keychain を作成することも考慮しています：

```yaml
name: CI - デプロイ
on:
  push:
    branches: [ main ]
  pull_request:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 現在のリポジトリをチェックアウト (Repo A)
        uses: actions/checkout@v4

      - name: デプロイキー用のSSH設定
        run: \\|
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_REPO_DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts  
      
      - name: シークレットキーをファイルに書き込む
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: \\|
          # fastlaneディレクトリが存在することを確認
          mkdir -p ./fastlane
      
          # ファイルパスを作成
          APP_STORE_CONNECT_API_KEY_PATH=./fastlane/AuthKey_XXXXXX.p8
      
          # 内容を書き込む（改行を保持）
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > "$APP_STORE_CONNECT_API_KEY_PATH"
      
          # （任意）権限を制限
          chmod 600 "$APP_STORE_CONNECT_API_KEY_PATH"

      - name: fastlaneキーチェーンを作成
        env:
          KEYCHAIN_NAME: "${{ runner.name }}"
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
        run: \\|
          bundle exec fastlane run create_keychain \
            name:"$KEYCHAIN_NAME" \
            password:"$MATCH_PASSWORD" \
            unlock:true \
            timeout:0 \
            lock_when_sleeps:false
      
      - name: Firebaseへデプロイ
        env:
          MATCH_PASSWORD: "${{ secrets.MATCH_PASSWORD }}"
          KEYCHAIN_NAME: "${{ runner.name }}"
        run: bundle exec fastlane deploy_to_firebase

      # 🔥 前の処理が成功・失敗に関わらず必ず実行
      - name: fastlaneキーチェーンを削除
        if: always()
        env:
          KEYCHAIN_NAME: ${{ runner.name }}
        run: \\|
          bundle exec fastlane run delete_keychain \
            name:"$KEYCHAIN_NAME"
```

- 各Runnerは同時に一つだけ実行されるため、Runner名をKeychain名として使用し、各Runnerはそれぞれ独自のKeychainを持ちます。

- 実行完了後、成功・失敗に関わらず削除されます。

- `keychain_password` は特に別途設定せず、統一して `MATCH_PASSWORD` を使用しました。

`Fastlane/Fastfile` の match メソッドに keychain パラメータを追加：

```ruby
#...
    match(
      type: "adhoc",
      app_identifier: app_identifier, 
      readonly: false, # 必要に応じて cert / profile を更新・アップロード
      force_for_new_devices: true, # 新しいデバイスがあれば provisioning profile を再作成
      keychain_name: ENV['KEYCHAIN_NAME'], # デフォルト値: nil
      keychain_password: ENV['MATCH_PASSWORD'] # デフォルト値: nil
    )
#...
```

こうすることで、Matchが証明書を取得する際に共通のloginキーチェーンではなく、指定したキーチェーンに保存されます。

### 結論

Fastlane の範囲は非常に広いため、ここでは Fastlane Match の使用過程のみを記録します。テスト実行やビルド・リリースなどの他の Lane については、機会があれば別の記事で補足します。Match に関する他の問題や事例があれば、また追記しますので、コメントでの質問も歓迎します！

### 関連記事

- [CI/CD 実践ガイド（1）：CI/CDとは何か？CI/CDで安定かつ効率的な開発チームを作る方法は？ツールの選び方は？](../c008a9e8ceca/)

- [CI/CD 実践ガイド（二）：GitHub Actions と self-hosted Runner の使い方と構築大全](../404bd5c70040/)

- [CI/CD 実践ガイド（三）：GitHub Actions を使ったアプリプロジェクトの CI と CD ワークフローの実装](../4b001d2e8440/)

- [CI/CD 実践ガイド（4）：Google Apps Script Web Appを使ってGitHub Actionsと連携し、無料で使いやすいパッケージングツールプラットフォームを構築する](../4273e57e7148/)

**ぜひご覧ください。🤞🏻**

ご質問やご意見がありましたら、[こちらからご連絡ください](https://www.zhgchg.li/contact){:target="_blank"} 。

*[Post](https://medium.com/zrealm-ios-dev/ios-certificates-identifiers-profiles-%E6%98%AF%E4%BB%80%E9%BA%BC%E5%8F%8A-fastlane-match-%E7%B5%B1%E4%B8%80%E7%AE%A1%E7%90%86%E6%86%91%E8%AD%89%E8%88%87-ci-cd-%E7%9A%84%E4%B8%80%E4%BA%9B%E7%AD%86%E8%A8%98-823ac523ccc8){:target="_blank"} Mediumから[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}によって変換されました。