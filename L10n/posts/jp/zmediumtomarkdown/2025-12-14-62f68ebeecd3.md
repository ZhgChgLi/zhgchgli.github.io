---
author: ZhgChgLi
categories:
- ZRealmã®é–‹ç™º
date: 2025-12-14T08:17:06.562+0000
description: æœ‰é™çŠ¶æ…‹æ©Ÿã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§DispatchSourceTimerã‚’å®‰å…¨ã«å°è£…ã—ã€iOS Timerã®ä½¿ã„åˆ†ã‘ã¨å•é¡Œè§£æ±ºã‚’å®Ÿç¾ã€‚åŠ¹ç‡çš„ã§å®‰å…¨ãªã‚¿ã‚¤ãƒãƒ¼ç®¡ç†ã‚’æ±‚ã‚ã‚‹é–‹ç™ºè€…å¿…è¦‹ã€‚
image:
  path: /assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.jpeg
last_modified_at: 2025-12-14T16:24:36.634+0000
render_with_liquid: false
tags:
- iosã‚¢ãƒ—ãƒªé–‹ç™º
- ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
- ã‚¿ã‚¤ãƒãƒ¼
- swift
- æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°
- japanese
- ai-translation
title: iOS Timerï½œDispatchSourceTimerã®é¸ã³æ–¹ã¨å®‰å…¨ãªä½¿ã„æ–¹ã‚’å¾¹åº•è§£èª¬
---

### [iOS] Timer ã¨ DispatchSourceTimer ã®é¸ã³æ–¹ã¨å®‰å…¨ãªä½¿ã„æ–¹ã¯ï¼Ÿ

æœ‰é™çŠ¶æ…‹æ©Ÿã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ DispatchSourceTimer ã‚’ãƒ©ãƒƒãƒ—ã—ã€å®‰å…¨ã§ä½¿ã„ã‚„ã™ãã™ã‚‹ã€‚

![Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.jpeg)

Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}

#### Timer ã«ã¤ã„ã¦

iOS é–‹ç™ºã§ã¯å¿…ãšç›´é¢ã™ã‚‹è¦ä»¶ã®ä¸€ã¤ã«ã€ŒTimer ã‚¿ã‚¤ãƒãƒ¼ã€ãŒã‚ã‚Šã¾ã™ã€‚UI å±¤ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚„ãƒãƒŠãƒ¼ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã‹ã‚‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¸ãƒƒã‚¯å±¤ã§ã®ã‚¤ãƒ™ãƒ³ãƒˆã®å®šæœŸé€ä¿¡ã‚„å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ãƒ»è§£æ”¾ã¾ã§ã€ç›®æ¨™é”æˆã®ãŸã‚ã« Timer ãŒå¿…è¦ã§ã™ã€‚

### [Foundation â€” Timer (NSTimer)](https://developer.apple.com/documentation/foundation/timer){:target="_blank"}

Timer ã¯èª°ã‚‚ãŒç›´æ„Ÿçš„ã«æœ€åˆã«æ€ã„æµ®ã‹ã¹ã‚‹ API ã§ã™ãŒã€Timer ã‚’é¸æŠãƒ»ä½¿ç”¨ã™ã‚‹éš›ã«ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### åˆ©ç‚¹ã¨æ¬ ç‚¹

**Timer ã®åˆ©ç‚¹ï¼š**

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§UIæ“ä½œã¨çµ±åˆã•ã‚Œã¦ãŠã‚Šã€ç‰¹ã«ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

- ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è‡ªå‹•èª¿æ•´ã—ã¦é›»åŠ›æ¶ˆè²»ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚

- è¤‡é›‘ã•ãŒä½ãã€ç™ºç”Ÿã™ã‚‹å•é¡Œã¯æœ€å¤§ã§ Retain Cycle ã‚„ Timer ã®åœæ­¢å¿˜ã‚Œã®ã¿ã§ã€ç›´æ¥ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

**Timer ã®æ¬ ç‚¹ï¼š**

- ç²¾åº¦ã¯ RunLoop ã®çŠ¶æ…‹ã«å½±éŸ¿ã•ã‚Œã€UI ã®é«˜ã„ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚„ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ãŒé…ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

- `suspend`ã€`resume`ã€`activate` ãªã©ã®é«˜åº¦ãªæ“ä½œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“

#### é©ã—ãŸã‚·ãƒ¼ãƒ³

UI å±¤é¢ã®è¦ä»¶ã€ä¾‹ãˆã°ãƒãƒŠãƒ¼ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚¯ãƒ¼ãƒãƒ³å–å¾—ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãªã©ã€ã“ã‚Œã‚‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰æ™¯ã®ç”»é¢ã§å†…å®¹ã«åå¿œã§ãã‚Œã°ååˆ†ãªå ´åˆã€ç§ã¯ç›´æ¥ Timer ã‚’ä½¿ã„ã¾ã™ã€‚ç°¡å˜ã§è¿…é€Ÿã‹ã¤å®‰å…¨ã«ç›®çš„ã‚’é”æˆã§ãã¾ã™ã€‚

#### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

![](/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.png)

UIãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ä¸Šã§ Timer ã‚’ä½œæˆã™ã‚‹ã¨ã€Timer ã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã® RunLoop ã«å¼·ãä¿æŒã•ã‚Œã€RunLoop ã®ãƒãƒ¼ãƒªãƒ³ã‚°æ©Ÿæ§‹ã«ã‚ˆã£ã¦å®šæœŸçš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚Timer ã¯ invalidate() ãŒå‘¼ã°ã‚Œã‚‹ã¾ã§è§£æ”¾ã•ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€ViewController ã§ Timer ã‚’å¼·ãä¿æŒã—ã€deinit æ™‚ã« Timer ã® invalidate() ã‚’å‘¼ã³å‡ºã—ã¦ã€ç”»é¢ãŒçµ‚äº†ã—ãŸå¾Œã«æ­£ã—ã Timer ã‚’åœæ­¢ãƒ»è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- â­ï¸ï¸ï¸View Controller ã¯ Timer ã‚’å¼·ãä¿æŒã—ã€**Timer ã®å®Ÿè¡Œãƒ–ãƒ­ãƒƒã‚¯ï¼ˆhandler / closureï¼‰ã¯å¿…ãš Weak Self ã«ã™ã‚‹ã“ã¨ï¼›ã•ã‚‚ãªã‘ã‚Œã° Retain Cycle ãŒç™ºç”Ÿã—ã¾ã™ã€‚**

- â­ï¸ï¸ï¸ View Controller ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«çµ‚äº†æ™‚ã«å¿…ãš Timer ã® invalidate() ã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚ã•ã‚‚ãªã„ã¨ RunLoop ãŒ Timer ã‚’ä¿æŒã—ç¶šã‘ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

> *RunLoop ã¯ã‚¹ãƒ¬ãƒƒãƒ‰å†…ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ«ãƒ¼ãƒ—ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡ã¨å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ï¼›**ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã« RunLoop (RunLoop.main) ã‚’ä½œæˆ**ã—ã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯å¿…ãšã—ã‚‚ RunLoop ãŒå­˜åœ¨ã™ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚*

#### ä½¿ç”¨

`Timer.scheduledTimer` ã‚’ä½¿ã£ã¦ç›´æ¥ Timer ã‚’å®£è¨€ã§ãã¾ã™ï¼ˆè‡ªå‹•çš„ã« RunLoop.main ã¨ **Mode: .default** ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼‰:

```swift
final class HomeViewController: UIViewController {
    
    private var timer: Timer?
    
    deinit {
        self.timer?.invalidate() // ã‚¿ã‚¤ãƒãƒ¼ã‚’ç„¡åŠ¹åŒ–
        self.timer = nil
    }

    override func viewDidLoad() {
        super.viewDidLoad()
        startCarousel()
    }
    
    private func startCarousel() {
        self.timer = Timer.scheduledTimer(withTimeInterval: 1, repeats: true, block: { [weak self] _ in
            self?.doSomething()
        })
    }

    private func doSomething() {
        print("Hello World!")
    }
}
```

Timer ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªåˆ†ã§å®£è¨€ã—ã¦ RunLoop ã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™:

```swift
let timer= Timer(timeInterval: 1.0, repeats: true) { [weak self] _ in
  // ä½•ã‹ã‚’å®Ÿè¡Œã™ã‚‹..
}
self.timer = timer
// RunLoopã«è¿½åŠ ã—ã¦ã‹ã‚‰å®Ÿè¡ŒãŒå§‹ã¾ã‚‹
RunLoop.main.add(timer, forMode: .default)
```

#### Timer ã®æ“ä½œæ–¹æ³•

- `invalidate()` ã¯ Timer ã‚’çµ‚äº†ã™ã‚‹

- `fire()` ã¯å³åº§ã«ä¸€åº¦ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™

#### RunLoop **ãƒ¢ãƒ¼ãƒ‰ã®å½±éŸ¿**

- `.default` ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿½åŠ ã•ã‚Œã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã€ä¸»ã«UIè¡¨ç¤ºã‚’å‡¦ç†ã—ã¾ã™ã€‚  
  **`.tracking` ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ãã«ä¸€æ™‚åœæ­¢ã—ã¾ã™**

- `.tracking` ï¼šScrollView ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ“ä½œã‚’å‡¦ç†ã—ã¾ã™ã€‚

- `.common` ï¼š `.default` ã¨ `.tracking` ã®ä¸¡æ–¹ãŒå‡¦ç†ã•ã‚Œã¾ã™ã€‚

> *â­ï¸ï¸ï¸â­ï¸ï¸ï¸â­ï¸ï¸ï¸ãã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ Timer ã¯ `.default` ãƒ¢ãƒ¼ãƒ‰ã«è¿½åŠ ã•ã‚Œã¦ãŠã‚Šã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ ScrollView ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚Šã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼æ“ä½œã‚’è¡Œã†ã¨è‡ªå‹•çš„ã«ä¸€æ™‚åœæ­¢**ã—ã€æ“ä½œãŒçµ‚äº†ã—ã¦ã‹ã‚‰å†é–‹ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š Timer ã®ç™ºç«ãŒé…ã‚ŒãŸã‚Šã€å›æ•°ãŒäºˆæƒ³ã‚ˆã‚Šå°‘ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚*

**ã“ã‚Œã«å¯¾ã—ã¦ã€Timer ã‚’ .common ãƒ¢ãƒ¼ãƒ‰ã«è¿½åŠ ã™ã‚Œã°ä¸Šè¨˜ã®å•é¡Œã‚’è§£æ±ºã§ãã¾ã™:**

```swift
RunLoop.main.add(timer, forMode: .common)
```

### [Grand Central Dispatch â€” DispatchSourceTimer](https://developer.apple.com/documentation/dispatch/dispatchsourcetimer){:target="_blank"}

Timer ä»¥å¤–ã«ã€GCD ã¯ã‚‚ã†ä¸€ã¤ã®é¸æŠè‚¢ã¨ã—ã¦ DispatchSourceTimer ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

#### é•·æ‰€ã¨çŸ­æ‰€

**DispatchSourceTimer ã®åˆ©ç‚¹ï¼š**

- æ“ä½œã®æŸ”è»Ÿæ€§ï¼ˆ`suspend` ã¨ `resume` ã®ã‚µãƒãƒ¼ãƒˆï¼‰ãŒå„ªã‚Œã¦ã„ã‚‹

- é«˜ã„ç²¾åº¦ã¨ä¿¡é ¼æ€§ï¼šGCDã‚­ãƒ¥ãƒ¼ã«ä¾å­˜

- leeway ã‚’è¨­å®šã—ã¦æ¶ˆè²»é›»åŠ›ã‚’åˆ¶å¾¡å¯èƒ½

- å®‰å®šã—ã¦å¸¸é§ã™ã‚‹ã‚¿ã‚¹ã‚¯ï¼ˆGCD ã‚­ãƒ¥ãƒ¼ï¼‰

**DispatchSourceTimer ã®æ¬ ç‚¹ï¼š**

- UIæ“ä½œã¯è‡ªåˆ†ã§Main Threadã«åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

- APIã®ä½¿ç”¨ã¯è¤‡é›‘ã§é †åºãŒã‚ã‚Šã€**èª¤ç”¨ã™ã‚‹ã¨ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™**

- å®‰å…¨ã«ä½¿ç”¨ã™ã‚‹ã«ã¯ãƒ©ãƒƒãƒ—ãŒå¿…è¦ã§ã™

#### é©ã—ãŸã‚·ãƒ¼ãƒ³

Timer ãŒ UI å±¤ã®ã‚·ãƒ¼ãƒ³ã«é©ã—ã¦ã„ã‚‹ã®ã«å¯¾ã—ã€DispatchSourceTimer ã¯ UI ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ã®ç”»é¢ã«é–¢ä¿‚ãªã„ã‚¿ã‚¹ã‚¯ã«é©ã—ã¦ã„ã¾ã™ã€‚æœ€ã‚‚ä¸€èˆ¬çš„ãªã®ã¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ç™ºç”Ÿã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šæœŸçš„ã«ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãŸã‚Šã€ä¸è¦ãª CoreData ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šæœŸçš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸã‚Šã™ã‚‹å ´åˆã§ã™ã€‚ã“ã‚Œã‚‰ã¯ DispatchSourceTimer ã‚’ä½¿ã†ã®ã«éå¸¸ã«é©ã—ã¦ã„ã¾ã™ã€‚

#### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

![](/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.png)

DispatchSourceTimer ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¯å¤–éƒ¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã¾ã ä¿æŒã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã«ä¾å­˜ã—ã¾ã™ã€‚GCD ã‚­ãƒ¥ãƒ¼è‡ªä½“ã¯ã‚¿ã‚¤ãƒãƒ¼ã®ã‚ªãƒ¼ãƒŠãƒ¼ã‚’å¼·ãä¿æŒã›ãšã€ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¨å®Ÿè¡Œã®ã¿ã‚’æ‹…å½“ã—ã¾ã™ã€‚

#### ã‚¯ãƒ©ãƒƒã‚·ãƒ¥å•é¡Œ

DispatchSourceTimer ã¯ `activate` ã€`suspend` ã€`resume` ã€`cancel` ã¨ã„ã£ãŸå¤šãã®æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã™ãŒã€éå¸¸ã«ç¹Šç´°ã§ã€å‘¼ã³å‡ºã—é †åºã‚’é–“é•ãˆã‚‹ã¨ã™ãã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼ˆEXC_BREAKPOINT/DispatchSourceTimerï¼‰ã™ã‚‹ãŸã‚éå¸¸ã«å±é™ºã§ã™ã€‚

![](/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.png)

**ä»¥ä¸‹ã®çŠ¶æ³ã§ã¯ç›´æ¥ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ï¼š**

- âŒ suspend( ) ã¨ resume( ) ãŒãƒšã‚¢ã«ãªã£ã¦ã„ãªã„  
  suspend( ) ã®å¾Œã«å†åº¦ suspend( ) ã‚’å‘¼ã³å‡ºã™  
  resume( ) ã®å¾Œã«å†åº¦ resume( ) ã‚’å‘¼ã³å‡ºã™

- âŒ suspend( ) ã®å¾Œã« cancel( ) ã‚’å‘¼ã¶å ´åˆã¯ã€å…ˆã« resume( ) ã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- âŒ suspend( ) çŠ¶æ…‹ã§ Timer ãŒè§£æ”¾ã•ã‚Œã‚‹ (nil)

- âŒ cancel( ) ã®å¾Œã«ä»–ã®æ“ä½œã‚’å‘¼ã³å‡ºã™ã“ã¨

#### Finite-State Machineï¼ˆæœ‰é™çŠ¶æ…‹æ©Ÿï¼‰ã‚’ä½¿ã£ãŸæ“ä½œã®ãƒ©ãƒƒãƒ—

æœ¬è¨˜äº‹ã®ã‚‚ã†ä¸€ã¤ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã«å…¥ã‚Šã¾ã™ã€‚DispatchSourceTimerã‚’å®‰å…¨ã«ä½¿ã†ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

![](/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.png)

ä¸Šå›³ã®ã‚ˆã†ã«ã€æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°ã‚’ä½¿ã£ã¦ DispatchSourceTimer ã®æ“ä½œã‚’ãƒ©ãƒƒãƒ—ã—ã€ã‚ˆã‚Šå®‰å…¨ã§ä½¿ã„ã‚„ã™ãã—ã¦ã„ã¾ã™:

```swift
final class DispatchSourceTimerMachine {
    // æœ‰é™çŠ¶æ…‹æ©Ÿã®çŠ¶æ…‹
    private enum TimerState {
        // åˆæœŸçŠ¶æ…‹
        case idle
        // å®Ÿè¡Œä¸­
        case running
        // ä¸€æ™‚åœæ­¢ä¸­
        case suspended
        // çµ‚äº†ä¸­
        case cancelled
    }

    private var timer: DispatchSourceTimer?
    private lazy var timerQueue: DispatchQueue = {
        DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine", qos: .background)
    }()

    private var _state: TimerState = .idle
    
    deinit {
        // æ‰€æœ‰è€…ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¶ˆæ»…ã™ã‚‹ã¨ãã€åŒæœŸçš„ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        // å®Ÿè¡Œã—ãªãã¦ã‚‚å•é¡Œãªã„ï¼ˆhandlerã¯weakï¼‰ãŒã€å‡¦ç†ã®æœŸå¾…é€šã‚Šã‚’ä¿è¨¼ã™ã‚‹ãŸã‚
        if _state == .suspended {
            timer?.resume()
            _state = .running
        }
        if _state == .running {
            timer?.cancel()
            timer = nil
            _state = .cancelled
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        // idle, cancelled çŠ¶æ…‹ã®ã¿ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•å¯èƒ½
        guard [.idle, .cancelled].contains(_state) else { return }
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½œæˆã— activate()
        let timer = makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
        self.timer = timer
        timer.activate()
        
        // running çŠ¶æ…‹ã¸åˆ‡ã‚Šæ›¿ãˆ
        _state = .running
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢
    func suspend() {
        // running çŠ¶æ…‹ã®ã¿ä¸€æ™‚åœæ­¢å¯èƒ½
        guard [.running].contains(_state) else { return }
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢
        timer?.suspend()
        
        // suspended çŠ¶æ…‹ã¸åˆ‡ã‚Šæ›¿ãˆ
        _state = .suspended
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
    func resume() {
        // suspended çŠ¶æ…‹ã®ã¿å†é–‹å¯èƒ½
        guard [.suspended].contains(_state) else { return }
        
        // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
        timer?.resume()
        
        // running çŠ¶æ…‹ã¸åˆ‡ã‚Šæ›¿ãˆ
        _state = .running
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’çµ‚äº†
    func cancel() {
        // suspended, running çŠ¶æ…‹ã®ã¿çµ‚äº†å¯èƒ½
        guard [.suspended, .running].contains(_state) else { return }
        
        // ç¾åœ¨ suspended çŠ¶æ…‹ã®å ´åˆã¯å…ˆã« resume() ã—ã¦ã‹ã‚‰çµ‚äº†
        // ã“ã‚Œã¯ DispatchSourceTimer ã®åˆ¶ç´„ã§ã€running çŠ¶æ…‹ã§ã®ã¿ cancel() å¯èƒ½
        if _state == .suspended {
            self.resume()
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’çµ‚äº†
        timer?.cancel()
        timer = nil
        
        // cancelled çŠ¶æ…‹ã¸åˆ‡ã‚Šæ›¿ãˆ
        _state = .cancelled
    }
    
    private func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> DispatchSourceTimer {
        let timer = DispatchSource.makeTimerSource(queue: timerQueue)
        timer.schedule(deadline: .now(), repeating: repeatTimeInterval)
        timer.setEventHandler(qos: .background, handler: handler)
        return timer
    }
}
```

ç§ãŸã¡ã¯ç°¡å˜ã«æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°ã‚’ä½¿ã£ã¦ã€ŒçŠ¶æ…‹ãŒã©ã®çŠ¶æ…‹ã«é·ç§»ã§ãã‚‹ã‹ã€ã¨ã€ŒçŠ¶æ…‹ã§ä½•ã‚’ã™ã¹ãã‹ã€ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã¾ã—ãŸã€‚èª¤ã£ãŸçŠ¶æ…‹ã§å‘¼ã³å‡ºã—ã¦ã‚‚ç„¡è¦–ã•ã‚Œï¼ˆã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã›ã‚“ï¼‰ã€ã•ã‚‰ã«ã„ãã¤ã‹ã®æœ€é©åŒ–ã‚‚è¡Œã„ã¾ã—ãŸã€‚ä¾‹ãˆã°ã€suspended çŠ¶æ…‹ã§ã‚‚ cancel ãŒå¯èƒ½ã§ã€cancelled çŠ¶æ…‹ã‹ã‚‰å†åº¦ activate ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

> ***é–¢é€£è¨˜äº‹ï¼š***

> *ä»¥å‰ã«æ›¸ã„ãŸåˆ¥ã®è¨˜äº‹ã€Œ [Design Patterns å¯¦æˆ°æ‡‰ç”¨ï½œå°è£ Socket.IO å³æ™‚é€šè¨Šæ¶æ§‹](https://zhgchg.li/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/#%E9%9C%80%E6%B1%82%E5%A0%B4%E6%99%AF-3){:target="_blank"} ã€ã§ã‚‚æœ‰é™çŠ¶æ…‹æ©Ÿæ¢°ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã•ã‚‰ã« State Pattern ã‚‚å¤šç”¨ã—ã¦ã„ã¾ã™ã€‚*

> *Finite-State Machine æœ‰é™çŠ¶æ…‹æ©Ÿï¼šçŠ¶æ…‹é–“ã®é·ç§»åˆ¶å¾¡ã¨è¡Œã†ã¹ãã“ã¨ã«æ³¨ç›®ã™ã‚‹ã€‚*

> *Stateãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šå„çŠ¶æ…‹å†…ã®æŒ¯ã‚‹èˆã„ãƒ­ã‚¸ãƒƒã‚¯ã«æ³¨ç›®ã™ã‚‹ã€‚*

#### Serial Queue ã‚’ä½¿ã£ãŸæœ‰é™çŠ¶æ…‹æ©Ÿã®çŠ¶æ…‹é·ç§»æ“ä½œ

çŠ¶æ…‹æ©Ÿã§ DispatchSourceTimer ã®å®‰å…¨ãªä½¿ç”¨ã‚’ç¢ºä¿ã—ãŸå¾Œã‚‚ã€ã¾ã å•é¡Œã¯è§£æ±ºã—ã¦ã„ã¾ã›ã‚“ã€‚å¤–éƒ¨ã‹ã‚‰ DispatchSourceTimerMachine ã‚’å‘¼ã³å‡ºã™å ´æ‰€ãŒåŒã˜ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚ã‚‹ã¨ã¯é™ã‚‰ãšã€ç•°ãªã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ“ä½œã™ã‚‹ã¨ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ãŒç™ºç”Ÿã—ã€ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®åŸå› ã¨ãªã‚Šã¾ã™ã€‚

```swift
final class DispatchSourceTimerMachine {
    // æœ‰é™çŠ¶æ…‹æ©Ÿã®çŠ¶æ…‹
    private enum TimerState {
        // åˆæœŸçŠ¶æ…‹
        case idle
        // å®Ÿè¡Œä¸­
        case running
        // ä¸€æ™‚åœæ­¢ä¸­
        case suspended
        // çµ‚äº†ä¸­
        case cancelled
    }

    private var timer: DispatchSourceTimer?
    private lazy var timerQueue: DispatchQueue = {
        DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine", qos: .background)
    }()

    private var _state: TimerState = .idle

    private static let operationQueueSpecificKey = DispatchSpecificKey<ObjectIdentifier>()
    private lazy var operationQueueSpecificValue: ObjectIdentifier = ObjectIdentifier(self)
    private lazy var operationQueue: DispatchQueue = {
        let queue = DispatchQueue(label: "li.zhgchg.DispatchSourceTimerMachine.operationQueue")
        queue.setSpecific(key: Self.operationQueueSpecificKey, value: operationQueueSpecificValue)
        return queue
    }()
    private func operation(async: Bool = true, _ work: @escaping () -> Void) {
        if DispatchQueue.getSpecific(key: Self.operationQueueSpecificKey) == operationQueueSpecificValue {
            work()
        } else {
            if async {
                operationQueue.async(execute: work)
            } else {
                operationQueue.sync(execute: work)
            }
        }
    }
    
    deinit {
        // ã‚ªãƒ¼ãƒŠãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ¶ˆãˆã‚‹æ™‚ã€åŒæœŸçš„ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        // ã—ãªãã¦ã‚‚å•é¡Œãªã„ï¼ˆhandlerã¯weakï¼‰ãŒã€å‡¦ç†ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã«è¡Œã†
        // syncã§å®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
        operation(async: false) { [self] in
            if _state == .suspended {
                timer?.resume()
                _state = .running
            }
            if _state == .running {
                timer?.cancel()
                timer = nil
                _state = .cancelled
            }
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•
    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        operation { [weak self] in
            guard let self = self else { return }
            // idleã¾ãŸã¯cancelledçŠ¶æ…‹ã®ã¿ã‚¿ã‚¤ãƒãƒ¼ã‚’èµ·å‹•å¯èƒ½
            guard [.idle, .cancelled].contains(_state) else { return }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½œæˆã—ã¦èµ·å‹•
            let timer = makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
            self.timer = timer
            timer.activate()
            
            // runningçŠ¶æ…‹ã«å¤‰æ›´
            _state = .running
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢
    func suspend() {
        operation { [weak self] in
            guard let self = self else { return }
            // runningçŠ¶æ…‹ã®ã¿ä¸€æ™‚åœæ­¢å¯èƒ½
            guard [.running].contains(_state) else { return }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢
            timer?.suspend()
            
            // suspendedçŠ¶æ…‹ã«å¤‰æ›´
            _state = .suspended
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
    func resume() {
        operation { [weak self] in
            guard let self = self else { return }
            // suspendedçŠ¶æ…‹ã®ã¿å†é–‹å¯èƒ½
            guard [.suspended].contains(_state) else { return }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’å†é–‹
            timer?.resume()
            
            // runningçŠ¶æ…‹ã«å¤‰æ›´
            _state = .running
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã‚’çµ‚äº†
    func cancel() {
        operation { [weak self] in
            guard let self = self else { return }
            // suspendedã¾ãŸã¯runningçŠ¶æ…‹ã®ã¿çµ‚äº†å¯èƒ½
            guard [.suspended, .running].contains(_state) else { return }
            
            // suspendedçŠ¶æ…‹ã®å ´åˆã¯å…ˆã«resumeã—ã¦ã‹ã‚‰çµ‚äº†
            // DispatchSourceTimerã®åˆ¶ç´„ã§ã€runningçŠ¶æ…‹ã§ã®ã¿cancelå¯èƒ½
            if _state == .suspended {
                self.resume()
            }
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’çµ‚äº†
            timer?.cancel()
            timer = nil
            
            // cancelledçŠ¶æ…‹ã«å¤‰æ›´
            _state = .cancelled
        }
    }
    
    private func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> DispatchSourceTimer {
        let timer = DispatchSource.makeTimerSource(queue: timerQueue)
        timer.schedule(deadline: .now(), repeating: repeatTimeInterval)
        timer.setEventHandler(qos: .background, handler: handler)
        return timer
    }
}
```

ç¾åœ¨ã€ç§ãŸã¡ã¯å®‰å…¨ã« `DispatchSourceTimerMachine` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ Timer ã¨ã—ã¦ä½¿ç”¨ã§ãã¾ã™:

```typescript
final class TrackingEventSender {

    private let timerMachine = DispatchSourceTimerMachine()
    public var events: [String: String] = []

    // å®šæœŸãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹
    func startTracking() {
        timerMachine.activate(repeatTimeInterval: .seconds(30)) { [weak self] in
            self?.sendTrackingEvent()
        }
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ä¸€æ™‚åœæ­¢ï¼ˆä¾‹ï¼šAppãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å…¥ã‚‹ã¨ãï¼‰
    func pauseTracking() {
        timerMachine.suspend()
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’å†é–‹ï¼ˆä¾‹ï¼šAppãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã‚‹ã¨ãï¼‰
    func resumeTracking() {
        timerMachine.resume()
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’åœæ­¢ï¼ˆä¾‹ï¼šç”»é¢ã‚’é›¢ã‚Œã‚‹ã¨ãï¼‰
    func stopTracking() {
        timerMachine.cancel()
    }

    private func sendTrackingEvent() {
        // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡...
    }
}
```

ã“ã“ã¾ã§ã§ DispatchSourceTimer ã‚’å®‰å…¨ã«ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã®èª¬æ˜ã¯çµ‚äº†ã§ã™ã€‚æ¬¡ã«ã€ã„ãã¤ã‹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ´»ç”¨ã«ã¤ã„ã¦è¿°ã¹ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æŠ½è±¡åŒ–ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã‚„ DispatchSourceHandler ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã®æŠ½è±¡åŒ–ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

#### æ‹¡å¼µ â€” Adapterãƒ‘ã‚¿ãƒ¼ãƒ³ + Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ DispatchSourceTimer ã‚’ç”Ÿæˆï¼ˆæŠ½è±¡åŒ–ãƒ†ã‚¹ãƒˆã«ä¾¿åˆ©ï¼‰

DispatchSourceTimer ã¯ GCD ã® Objective-C ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚Šã€ãƒ†ã‚¹ãƒˆæ™‚ã« Mock ãŒé›£ã—ã„ï¼ˆProtocol ãŒãªã„ï¼‰ãŸã‚ã€è‡ªåˆ†ã§ Protocol ã¨ Factory Pattern ã‚’å®šç¾©ã—ã¦ç”Ÿæˆã—ã€TimerStateMachine ã‚’ãƒ†ã‚¹ãƒˆå¯èƒ½ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**Adapterãƒ‘ã‚¿ãƒ¼ãƒ³â€” DispatchSourceTimerã®æ“ä½œã‚’ãƒ©ãƒƒãƒ—:**

```swift
public protocol TimerAdapter {
    func schedule(repeating: DispatchTimeInterval)
    func setEventHandler(handler: DispatchSourceProtocol.DispatchSourceHandler?)
    func activate()
    func suspend()
    func resume()
    func cancel()
}

// DispatchSourceTimer ã® Adapter å®Ÿè£…
final class DispatchSourceTimerAdapter: TimerAdapter {
    // å…ƒã® DispatchSourceTimer
    private let timer: DispatchSourceTimer

    init(label: String = "li.zhgchg.DispatchSourceTimerAdapter") {
        let queue = DispatchQueue(label: label, qos: .background)
        let timer = DispatchSource.makeTimerSource(queue: queue)
        self.timer = timer
    }

    func schedule(repeating: DispatchTimeInterval) {
        timer.schedule(deadline: .now(), repeating: repeating)
    }

    func setEventHandler(handler: DispatchSourceProtocol.DispatchSourceHandler?) {
        timer.setEventHandler(qos: .background, handler: handler)
    }

    func activate() {
        timer.activate()
    }

    func suspend() {
        timer.suspend()
    }

    func resume() {
        timer.resume()
    }

    func cancel() {
        timer.cancel()
    }
}
```

**Factory Pattern â€” TimerAdapter ã‚’ç”Ÿæˆã™ã‚‹æŠ½è±¡çš„ãªæ–¹æ³•:**

```swift
protocol DispatchSourceTimerAdapterFactorySpec {
    func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> TimerAdapter
}

// DispatchSourceTimerAdapterã®ç”Ÿæˆæ‰‹é †ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–
final class DispatchSourceTimerAdapterFactory: DispatchSourceTimerAdapterFactorySpec {
    public func makeTimer(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSourceProtocol.DispatchSourceHandler?) -> TimerAdapter {
        let timer = DispatchSourceTimerAdapter()
        timer.schedule(repeating: repeatTimeInterval)
        timer.setEventHandler(handler: handler)
        return timer
    }
}
```

**çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨:**

```swift
var stateMachine = DispatchSourceTimerMachine(timerFactory: DispatchSourceTimerAdapterFactory())

//
final class DispatchSourceTimerMachine {
    // ç•¥..
    private var timer: TimerAdapter?
    private let timerFactory: DispatchSourceTimerAdapterFactorySpec
    public init(timerFactory: DispatchSourceTimerAdapterFactorySpec) {
        self.timerFactory = timerFactory
    }
    // ç•¥..

    func activate(repeatTimeInterval: DispatchTimeInterval, handler: DispatchSource.DispatchSourceHandler?) {
        onQueue { [weak self] in
            guard let self else { return }
            guard [.idle, .cancelled].contains(_state) else { return }
            // Factoryã§ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½œæˆ
            let timer = timerFactory.makeTimer(repeatTimeInterval: repeatTimeInterval, handler: handler)
            self.timer = timer

            timer.activate()
            _state = .running
        }
    }

    // ç•¥..
}
```

ã“ã‚Œã§ `TimerAdapter` / `DispatchSourceTimerAdapterFactorySpec` ã®ãƒ†ã‚¹ãƒˆæ®µéšã§ Mock Object ã‚’ä½œæˆã—ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

#### æ‹¡å¼µ â€” ***Strategy*** ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ DispatchSourceHandler ã®å‡¦ç†ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹

DispatchSourceHandler ãŒå®Ÿè¡Œã™ã‚‹å†…å®¹ã‚’å‹•çš„ã«å¤‰æ›´ã—ãŸã„å ´åˆã€Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦å‡¦ç†å†…å®¹ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã§ãã¾ã™ã€‚

**TrackingHandlerStrategy:**

```swift
protocol TrackingHandlerStrategy {
    static var target: String { get }
    func execute()
}

// ãƒ›ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
final class HomeTrackingHandlerStrategy: TrackingHandlerStrategy {
    static var target: String = "home"
    func execute() {
       // ãƒ›ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å–å¾—ã—ã¦é€ä¿¡
    }
}

// ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
final class ProductTrackingHandlerStrategy: TrackingHandlerStrategy {
    static var target: String = "product"
    func execute() {
       // ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã‚’å–å¾—ã—ã¦é€ä¿¡
    }
}
```

**çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ï¼š**

```swift
var sender = TrackingEventSender()
sender.register(event: HomeTrackingHandlerStrategy())
sender.register(event: ProductTrackingHandlerStrategy())
sender.startTracking()

// ...

//

final class TrackingEventSender {

    private let timerMachine = DispatchSourceTimerMachine()
    private var events: [String: TrackingHandlerStrategy] = [:]

    // å¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆæˆ¦ç•¥ã‚’ç™»éŒ²ã™ã‚‹
    func register(event: TrackingHandlerStrategy) {
        events[type(of: event).target] = event
    }

    func retrive<T: TrackingHandlerStrategy>(event: T.Type) -> T? {
        return events[event.target] as? T
    }

    // å®šæœŸãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹
    func startTracking() {
        timerMachine.activate(repeatTimeInterval: .seconds(30)) { [weak self] in
            self?.events.values.forEach { event in
                event.execute()
            }
        }
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹ï¼ˆä¾‹ï¼šã‚¢ãƒ—ãƒªãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å…¥ã‚‹ã¨ãï¼‰
    func pauseTracking() {
        timerMachine.suspend()
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’å†é–‹ã™ã‚‹ï¼ˆä¾‹ï¼šã‚¢ãƒ—ãƒªãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã‚‹ã¨ãï¼‰
    func resumeTracking() {
        timerMachine.resume()
    }

    // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’åœæ­¢ã™ã‚‹ï¼ˆä¾‹ï¼šç”»é¢ã‚’é›¢ã‚Œã‚‹ã¨ãï¼‰
    func stopTracking() {
        timerMachine.cancel()
    }
}
```

#### è¬è¾

æ„Ÿè¬ [Ethan Huang](https://medium.com/u/e13f6afcf9b9){:target="_blank"} ã•ã‚“ã® **5æœ¬ã®ãƒ“ãƒ¼ãƒ«** ã®ã”å¯„ä»˜ï¼š

[![](https://c7.patreon.com/https%3A%2F%2Fwww.patreon.com%2F%2Fcard-teaser-image%2Fcreator%2F6512681%3Fc=4366071272298850039/selector/%23creator-teaser%2C.png)](https://www.patreon.com/cw/ethanhuang13/home?vanity=ethanhuang13){:target="_blank"}

> *ç¢ºã‹ã«åŠå¹´ã»ã©ä½•ã‚‚æ›¸ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚æ–°ã—ã„ä»•äº‹ã«å°±ã„ãŸã°ã‹ã‚Šã§ã€å¼•ãç¶šãã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¢ã—ã¦ã„ã¾ã™ï¼ğŸ’ª*

> æ¬¡å›ã¯ Fastlane Match ã®è¨¼æ˜æ›¸ç®¡ç†ã‚„ Self-hosted Runner ã®æ§‹ç¯‰æ‰‹é †ã€ã¾ãŸã¯ Bitbucket Pipeline ã‚„ AppStoreConnect API ã«ã¤ã„ã¦å…±æœ‰ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

### é–¢é€£è¨˜äº‹

- [**Design Patterns ã®å®Ÿè·µå¿œç”¨è¨˜éŒ² (Socket.io ã®ãƒ©ãƒƒãƒ—)**](../78507a8de6a5/)

- [Design Patterns ã®å®Ÿè·µå¿œç”¨è¨˜éŒ² (WKWebViewã®ãƒ©ãƒƒãƒ—)](../f4b02ee342a4/)

- [Visitor Pattern in Swift](../ba5773a7bfea/)

- [TableViewã«ãŠã‘ã‚‹Visitorãƒ‘ã‚¿ãƒ¼ãƒ³](../60473cb47550/)

ã”è³ªå•ã‚„ã”æ„è¦‹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€[ã“ã¡ã‚‰ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„](https://www.zhgchg.li/contact){:target="_blank"} ã€‚

*[Post](https://dev.zhgchg.li/ios-timer-%E8%88%87-dispatchsourcetimer-%E5%A6%82%E4%BD%95%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E7%9A%84%E4%BD%BF%E7%94%A8-62f68ebeecd3){:target="_blank"} Mediumã‹ã‚‰[ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}ã‚’ä½¿ã£ã¦å¤‰æ›ã—ã¾ã—ãŸã€‚*