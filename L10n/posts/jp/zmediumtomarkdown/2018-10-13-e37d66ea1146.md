---
author: ZhgChgLi
categories:
- ZRealmã®é–‹ç™º
date: 2018-10-13T18:07:49.431+0000
description: iOSé–‹ç™ºè€…å‘ã‘ã«UITextViewã§ã®æ–‡ç¹å›³ç·¨é›†ã®èª²é¡Œã‚’è§£æ±ºã€‚Swiftã‚’ä½¿ã„ã€ãƒ†ã‚­ã‚¹ãƒˆã¨ç”»åƒã®è‡ªç”±é…ç½®ã‚’å®Ÿç¾ã—ã€UIè¨­è¨ˆã®åŠ¹ç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹å…·ä½“çš„æ‰‹æ³•ã‚’è§£èª¬ã€‚
image:
  path: /assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif
last_modified_at: 2024-04-13T07:11:24.880+0000
render_with_liquid: false
tags:
- swift
- ios
- ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™º
- uitextview
- iosã‚¢ãƒ—ãƒªé–‹ç™º
- japanese
- ai-translation
title: iOS UITextView æ–‡ç¹åœ–ç·¨é›†ï¼šSwiftã§è‡ªåœ¨ã«ãƒ†ã‚­ã‚¹ãƒˆã¨ç”»åƒã‚’é…ç½®ã™ã‚‹æ–¹æ³•ï½œåŠ¹ç‡çš„ãªUIè¨­è¨ˆ
---

### iOS UITextView æ–‡å­—å›ã‚Šç·¨é›†å™¨ (Swift)

å®Ÿè·µãƒ«ãƒ¼ãƒˆ

#### ç›®æ¨™æ©Ÿèƒ½ï¼š

APPã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨˜äº‹ã‚’æŠ•ç¨¿ã§ãã‚‹æ²ç¤ºæ¿æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚æŠ•ç¨¿ç”»é¢ã§ã¯ã€æ–‡å­—å…¥åŠ›ã€å¤šæ•°ã®ç”»åƒæŒ¿å…¥ã€ãã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã®å›ã‚Šè¾¼ã¿ï¼ˆæ–‡ç¹åœ–ï¼‰ã«å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### æ©Ÿèƒ½è¦ä»¶ï¼š

- è¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›å¯èƒ½

- è¡Œå†…ã«ç”»åƒã‚’æŒ¿å…¥ã§ãã‚‹

- è¤‡æ•°ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½

- æŒ¿å…¥ã—ãŸç”»åƒã‚’è‡ªç”±ã«å‰Šé™¤ã§ãã‚‹

- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æˆåŠŸï¼å¤±æ•—å‡¦ç†

- å…¥åŠ›å†…å®¹ã‚’è»¢é€å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›å¯èƒ½ ä¾‹: BBCODE

#### ã¾ãšå®Œæˆã—ãŸå‹•ä½œã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š

![[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}](/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif)

[çµå©šå§APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&mt=8){:target="_blank"}

### é–‹å§‹ï¼š

#### ç¬¬ä¸€ç« 

ä½•ï¼Ÿç¬¬ä¸€ç« ã¨è¨€ã£ãŸï¼ŸUITextViewã‚’ä½¿ãˆã°ç·¨é›†æ©Ÿèƒ½ã¯ã§ãã‚‹ã‹ã‚‰ã€ã€Œç« ã€ã«åˆ†ã‘ã‚‹å¿…è¦ãªã‚“ã¦ãªã„ã ã‚ã†ã¨æœ€åˆã¯æ€ã„ã¾ã—ãŸã€‚ã¯ã„ã€ç§ã‚‚æœ€åˆã¯ãã†è€ƒãˆã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ä½œã‚Šå§‹ã‚ã¦ã¿ã‚‹ã¨ãã†ç°¡å˜ã§ã¯ãªãã€2é€±é–“ã‚‚æ‚©ã¿ã€å›½å†…å¤–ã®è³‡æ–™ã‚’èª¿ã¹å°½ãã—ã¦ã‚ˆã†ã‚„ãè§£æ±ºç­–ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚ãã®å®Ÿè£…ã¾ã§ã®å¿ƒã®è»Œè·¡ã‚’ã˜ã£ãã‚ŠãŠè©±ã—ã—ã¾ã™â€¦ã€‚

ã‚‚ã—æœ€çµ‚çš„ãªè§£æ±ºç­–ã‚’ã™ãã«çŸ¥ã‚ŠãŸã„å ´åˆã¯ã€æœ€å¾Œã®ç« ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼ˆã©ã‚“ã©ã‚“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ã€‚

#### ã¯ã˜ã‚ã«

æ–‡å­—ç·¨é›†ã¯å½“ç„¶UITextViewã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€UITextViewã®attributedTextã¯NSTextAttachmentã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†…è”µã—ã¦ãŠã‚Šã€ç”»åƒã‚’æ·»ä»˜ã—ã¦æ–‡å›²ã¿åŠ¹æœã‚’å®Ÿç¾ã§ãã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚‚éå¸¸ã«ç°¡å˜ã§ã™ï¼š

```swift
let imageAttachment = NSTextAttachment()
imageAttachment.image = UIImage(named: "example")
self.contentTextView.attributedText = NSAttributedString(attachment: imageAttachment)
```

å½“æ™‚ã¯å˜ç´”ã«ã€Œç°¡å˜ã§ä¾¿åˆ©ã ãªã€ã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒã€å•é¡Œã¯ã“ã‚Œã‹ã‚‰å§‹ã¾ã£ãŸã®ã§ã™ï¼š

- ç”»åƒã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰é¸æŠï¼†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ã™ã‚‹ï¼šã“ã‚Œã¯ç°¡å˜ã«è§£æ±ºã§ãã¾ã™ã€‚ç”»åƒãƒ”ãƒƒã‚«ãƒ¼ã«ã¯ [TLPhotoPicker](https://github.com/tilltue/TLPhotoPicker){:target="_blank"} ã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼ˆè¤‡æ•°ç”»åƒé¸æŠå¯¾å¿œï¼ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®šï¼ã‚«ãƒ¡ãƒ©åˆ‡æ›¿æ’®å½±ï¼Live Photoså¯¾å¿œï¼‰ã€‚å…·ä½“çš„ãªæ–¹æ³•ã¯ã€TLPhotoPickerã§ç”»åƒã‚’é¸æŠå¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§PHAssetã‚’UIImageã«å¤‰æ›ã—ã€imageAttachment.imageã«ã‚»ãƒƒãƒˆã—ã€ã‚ã‚‰ã‹ã˜ã‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«åŠ¹æœã‚’ä»˜ã‘ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–æ“ä½œï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åŸç”»è¡¨ç¤ºï¼Xã‚’ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤ï¼‰ã‚’å®Ÿè£…ã—ãŸã„ï¼šå®Ÿç¾ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚NSTextAttachmentã§ã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãŸã ã€ã“ã®æ©Ÿèƒ½ãŒãªãã¦ã‚‚å•é¡Œãªãã€ç”»åƒã®å¾Œã‚ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€ŒBackã€ã‚­ãƒ¼ã‚’æŠ¼ã›ã°ç”»åƒã‚’å‰Šé™¤ã§ãã‚‹ã®ã§ã€ãã®ã¾ã¾ç¶šã‘ã¾ã™â€¦

- åŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¦ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚„æŒ¿å…¥ãŒé…ãã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€æŒ¿å…¥ãŠã‚ˆã³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«[Kingfisher](https://github.com/onevcat/Kingfisher){:target="_blank"}ã®resizeToã§ãƒªã‚µã‚¤ã‚ºã—ã¦ã„ã¾ã™ã€‚

- ç”»åƒã‚’ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æŒ¿å…¥ï¼šã“ã“ã§å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™

```swift
let range = self.contentTextView.selectedRange.location ?? NSRange(location: 0, length: 0)
let combination = NSMutableAttributedString(attributedString: self.contentTextView.attributedText) // ç¾åœ¨ã®å†…å®¹ã‚’å–å¾—
combination.insert(NSAttributedString(attachment: imageAttachment), at: range)
self.contentTextView.attributedText = combination // æ›¸ãæˆ»ã™
```

- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã®å‡¦ç†ï¼šã“ã“ã§ã¯ã€å…ƒã®NSTextAttachmentã‚’æ‹¡å¼µã™ã‚‹åˆ¥ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€è­˜åˆ¥ç”¨ã®å€¤ã‚’æ ¼ç´ã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```swift
class UploadImageNSTextAttachment:NSTextAttachment {
   var uuid:String? // ç”»åƒã®UUIDã‚’ä¿æŒ
}
```

ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¤‰æ›´ï¼š

```swift
let id = UUID().uuidString
let attachment = UploadImageNSTextAttachment()
// UUIDã‚’è¨­å®š
attachment.uuid = id
```

NSTextAttachmentã‚’è­˜åˆ¥ã§ãã‚Œã°ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸç”»åƒã«å¯¾ã—ã¦attributedTextå†…ã§NSTextAttachmentã‚’æ¤œç´¢ã—ã€ãã‚Œã‚’è¦‹ã¤ã‘ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»åƒã«ç½®ãæ›ãˆãŸã‚Šã€ç›´æ¥å‰Šé™¤ã—ãŸã‚Šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```swift
if let content = self.contentTextView.attributedText {
    content.enumerateAttributes(in: NSMakeRange(0, content.length),  options: NSAttributedString.EnumerationOptions(rawValue: 0)) { (object, range, stop) in
        if object.keys.contains(NSAttributedStringKey.attachment) {
            if let attachment = object[NSAttributedStringKey.attachment] as? UploadImageNSTextAttachment,attachment.uuid == "ç›®æ¨™ID" {
                attachment.bounds = CGRect(x: 0, y: 0, width: 30, height: 30) // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
                attachment.image =  UIImage(named: "IconError") // ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã«ç”»åƒã‚’å¤‰æ›´
                let combination = NSMutableAttributedString(attributedString: content)
                combination.replaceCharacters(in: range, with: NSAttributedString(attachment: attachment))
                // ç›´æ¥å‰Šé™¤ã™ã‚‹å ´åˆã¯deleteCharacters(in: range)ã‚’ä½¿ç”¨å¯èƒ½
                self.contentTextView.attributedText = combination
            }
        }
    }
}
```

ä¸Šè¨˜ã®å•é¡Œã‚’å…‹æœã—ãŸå¾Œã€ã‚³ãƒ¼ãƒ‰ã¯ã ã„ãŸã„ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```swift
class UploadImageNSTextAttachment:NSTextAttachment {
    var uuid:String?
}
func dismissPhotoPicker(withTLPHAssets: [TLPHAsset]) {
    //TLPhotoPickerã®ç”»åƒãƒ”ãƒƒã‚«ãƒ¼ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    
    let range = self.contentTextView.selectedRange.location ?? NSRange(location: 0, length: 0)
    //ã‚«ãƒ¼ã‚½ãƒ«ã®ä½ç½®ã‚’å–å¾—ã€‚ãªã‘ã‚Œã°å…ˆé ­ã‹ã‚‰
    
    guard withTLPHAssets.count > 0 else {
        return
    }
    
    DispatchQueue.global().async { in
        //ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡¦ç†
        let orderWithTLPHAssets = withTLPHAssets.sorted(by: { $0.selectedOrder > $1.selectedOrder })
        orderWithTLPHAssets.forEach { (obj) in
            if var image = obj.fullResolutionImage {
                
                let id = UUID().uuidString
                
                var maxWidth:CGFloat = 1500
                var size = image.size
                if size.width > maxWidth {
                    size.width = maxWidth
                    size.height = (maxWidth/image.size.width) * size.height
                }
                image = image.resizeTo(scaledToSize: size)
                //ãƒªã‚µã‚¤ã‚º
                
                let attachment = UploadImageNSTextAttachment()
                attachment.bounds = CGRect(x: 0, y: 0, width: size.width, height: size.height)
                attachment.uuid = id
                
                DispatchQueue.main.async {
                    //ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã«æˆ»ã£ã¦UIã‚’æ›´æ–°ã—ç”»åƒã‚’æŒ¿å…¥
                    let combination = NSMutableAttributedString(attributedString: self.contentTextView.attributedText)
                    attachments.forEach({ (attachment) in
                        combination.insert(NSAttributedString(string: "\n"), at: range)
                        combination.insert(NSAttributedString(attachment: attachment), at: range)
                        combination.insert(NSAttributedString(string: "\n"), at: range)
                    })
                    self.contentTextView.attributedText = combination
                    
                }
                
                //ç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                //Alamofireã®postãªã©
                //POST image
                //å¤±æ•—ã—ãŸå ´åˆ {
                    if let content = self.contentTextView.attributedText {
                        content.enumerateAttributes(in: NSMakeRange(0, content.length),  options: NSAttributedString.EnumerationOptions(rawValue: 0)) { (object, range, stop) in
                            
                            if object.keys.contains(NSAttributedStringKey.attachment) {
                                if let attachment = object[NSAttributedStringKey.attachment] as? UploadImageNSTextAttachment,attachment.uuid == obj.key {
                                    
                                    //ç½®ãæ›ãˆ:
                                    attachment.bounds = CGRect(x: 0, y: 0, width: 30, height: 30)
                                    attachment.image = //ã‚¨ãƒ©ãƒ¼ç”»åƒ
                                    let combination = NSMutableAttributedString(attributedString: content)
                                    combination.replaceCharacters(in: range, with: NSAttributedString(attachment: attachment))
                                    //ã¾ãŸã¯å‰Šé™¤:
                                    //combination.deleteCharacters(in: range)
                                    
                                    self.contentTextView.attributedText = combination
                                }
                            }
                        }
                    }
                //}
                //
                
            }
        }
    }
}
```

ã“ã“ã¾ã§ã§ã»ã¨ã‚“ã©ã®å•é¡Œã¯è§£æ±ºã—ã¾ã—ãŸãŒã€ãã‚Œã¯ãªãœ2é€±é–“ã‚‚ç§ã‚’æ‚©ã¾ã›ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç­”ï¼šã€Œãƒ¡ãƒ¢ãƒªã€å•é¡Œ

![iPhone 6ãŒè€ãˆã‚‰ã‚Œãªã„ï¼](/assets/e37d66ea1146/1*IcnoXq6e6OUnU_mg83XDxg.gif)

iPhone 6ã¯ã‚‚ã†é™ç•Œã ï¼

ä»¥ä¸Šã®æ–¹æ³•ã§5æšä»¥ä¸Šã®ç”»åƒã‚’æŒ¿å…¥ã™ã‚‹ã¨ã€UITextViewãŒã‚«ã‚¯ã¤ãå§‹ã‚ã¾ã™ã€‚ã‚ã‚‹ç¨‹åº¦ã‚’è¶…ãˆã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªè² è·ã«ã‚ˆã‚Šã‚¢ãƒ—ãƒªãŒç›´æ¥ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

p.s ã•ã¾ã–ã¾ãªåœ§ç¸®ã‚„ä»–ã®ä¿å­˜æ–¹æ³•ã‚’è©¦ã—ã¾ã—ãŸãŒã€çµæœã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ

æ¨æ¸¬ã•ã‚Œã‚‹åŸå› ã¯ã€UITextViewãŒç”»åƒã®NSTextAttachmentã‚’å†åˆ©ç”¨ã—ã¦ã„ãªã„ãŸã‚ã€æŒ¿å…¥ã—ãŸã™ã¹ã¦ã®ç”»åƒãŒãƒ¡ãƒ¢ãƒªå†…ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã¾ã¾è§£æ”¾ã•ã‚Œãªã„ã“ã¨ã§ã™ã€‚ãã®ãŸã‚ã€çµµæ–‡å­—ã®ã‚ˆã†ãªå°ã•ãªç”»åƒä»¥å¤–ã¯ã€æ–‡å›²ã¿ç”»åƒã¨ã—ã¦ä½¿ã†ã“ã¨ã¯ã»ã¼ä¸å¯èƒ½ã§ã™ğŸ˜…ã€‚

#### ç¬¬äºŒç« 

ãƒ¡ãƒ¢ãƒªã¨ã„ã†ã€Œè‡´å‘½çš„ãªå•é¡Œã€ã‚’ç™ºè¦‹ã—ãŸå¾Œã€ãƒãƒƒãƒˆã§è§£æ±ºç­–ã‚’æ¤œç´¢ã—ã€ä»¥ä¸‹ã®ä»–ã®æ–¹æ³•ã‚’è¦‹ã¤ã‘ã¾ã—ãŸï¼š

- WebViewã«HTMLãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ&lt;div contentEditable=â€trueâ€&gt;&lt;/div&gt;ï¼‰ã‚’åŸ‹ã‚è¾¼ã¿ã€JSã¨WebViewã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡Œã†

- UITableViewã¨UITextViewã‚’çµ„ã¿åˆã‚ã›ã¦ã€å†åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹

- TextKitã‚’ãƒ™ãƒ¼ã‚¹ã«UITextViewã‚’ç‹¬è‡ªæ‹¡å¼µğŸ†

ç¬¬ä¸€ã®æ–¹æ³•ã¯WebViewã§HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŸ‹ã‚è¾¼ã‚€ã‚„ã‚Šæ–¹ã§ã™ã€‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’è€ƒæ…®ã—ã¦æ¡ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯Githubã§é–¢é€£ã™ã‚‹è§£æ±ºç­–ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ï¼ˆä¾‹: [RichTextDemo](https://github.com/xiaosheng0601/RichTextDemo){:target="_blank"}ï¼‰ã€‚

ç¬¬äºŒé …ã¯UITableViewã¨UITextViewã‚’çµ„ã¿åˆã‚ã›ã‚‹æ–¹æ³•

ç§ã¯ç´„7å‰²ã»ã©å®Ÿè£…ã—ã¾ã—ãŸã€‚å…·ä½“çš„ã«ã¯ã€å„è¡ŒãŒ1ã¤ã®ã‚»ãƒ«ã§ã€ã‚»ãƒ«ã«ã¯2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚1ã¤ã¯UITextViewã€ã‚‚ã†1ã¤ã¯UIImageViewã§ã€ç”»åƒã¨æ–‡å­—ãŒäº¤äº’ã«1è¡Œãšã¤ä¸¦ã³ã¾ã™ã€‚å†…å®¹ã¯é…åˆ—ã§ä¿å­˜ã—ã€Reuseæ™‚ã«æ¶ˆãˆãªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

å„ªã‚ŒãŸReuseã§ãƒ¡ãƒ¢ãƒªå•é¡Œã¯è§£æ±ºã§ãã¾ã—ãŸãŒã€æœ€çµ‚çš„ã«ã¯æ–­å¿µã—ã¾ã—ãŸã€‚**è¡Œæœ«ã§Returnã‚­ãƒ¼ã‚’æŠ¼ã™ã¨æ–°ã—ã„è¡Œã‚’ä½œæˆã—ã¦ãã®è¡Œã«ç§»å‹•ã™ã‚‹**ã“ã¨ã¨ã€**è¡Œé ­ã§Backã‚­ãƒ¼ã‚’æŠ¼ã™ã¨å‰ã®è¡Œã«ç§»å‹•ã—ï¼ˆç¾åœ¨ã®è¡ŒãŒç©ºè¡Œãªã‚‰ãã®è¡Œã‚’å‰Šé™¤ã™ã‚‹ï¼‰**ã“ã®2ã¤ã®éƒ¨åˆ†ã§éå¸¸ã«è‹¦åŠ´ã—ã€åˆ¶å¾¡ãŒéå¸¸ã«é›£ã—ã‹ã£ãŸã§ã™ã€‚

èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ï¼š [MMRichTextEdit](https://gitee.com/dhar/MMRichTextEdit){:target="_blank"}

#### æœ€çµ‚ç« 

ã“ã“ã¾ã§æ¥ã‚‹ã®ã«å¤šãã®æ™‚é–“ã‚’è²»ã‚„ã—ã€é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå¤§å¹…ã«é…å»¶ã—ã¾ã—ãŸï¼›ç¾åœ¨ã®æœ€çµ‚è§£æ±ºç­–ã¯TextKitã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚

ã“ã“ã«èˆˆå‘³ã®ã‚ã‚‹æ–¹ã®ãŸã‚ã«è¦‹ã¤ã‘ãŸè¨˜äº‹ã‚’2ã¤æ·»ä»˜ã—ã¾ã™ï¼š

- [TextKit æ¢ç©¶](https://www.jianshu.com/p/3f445d7f44d6){:target="_blank"}

- [UITextViewã‹ã‚‰è¦‹ã‚‹æ–‡å­—æç”»ã®æœ€é©åŒ–](http://djs66256.github.io/2016/06/23/2016-06-23-cong-uitextviewkan-wen-zi-hui-zhi-you-hua/){:target="_blank"}

ã—ã‹ã—ã€ã‚ã‚‹ç¨‹åº¦ã®å­¦ç¿’ã‚³ã‚¹ãƒˆãŒã‚ã‚Šã€ç§ã®ã‚ˆã†ãªåˆå¿ƒè€…ã«ã¯é›£ã—ã™ãã¾ã™ã€‚ã•ã‚‰ã«æ™‚é–“ã‚‚è¶³ã‚Šãªã„ã®ã§ã€ãŸã ç„¡ç›®çš„ã«Githubã§ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã—ã¦å‚è€ƒã«ã™ã‚‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

æœ€çµ‚çš„ã« [XLYTextKitExtension](https://github.com/kaizeiyimi/XLYTextKitExtension){:target="_blank"} ã¨ã„ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¦‹ã¤ã‘ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å°å…¥ã—ã¦ä½¿ç”¨ã§ãã¾ã—ãŸã€‚

âœ” NSTextAttachmentã«ã‚«ã‚¹ã‚¿ãƒ UIViewã‚’å¯¾å¿œã•ã›ã€å¿…è¦ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦è¿½åŠ å¯èƒ½ã«ã™ã‚‹

âœ” NSTextAttachment ã¯å†åˆ©ç”¨ã§ãã€ãƒ¡ãƒ¢ãƒªã‚’åœ§è¿«ã—ã¾ã›ã‚“

å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ã¯**ç¬¬ä¸€ç« **ã¨ã»ã¼åŒã˜ã§ã€é•ã„ã¯å…ƒã€…NSTextAttachmentã‚’ä½¿ã£ã¦ã„ãŸã¨ã“ã‚ã‚’XLYTextAttachmentã«å¤‰æ›´ã—ãŸç‚¹ã ã‘ã§ã™ã€‚

ä½¿ç”¨ã™ã‚‹UITextViewã«ã¤ã„ã¦:

```swift
contentTextView.setUseXLYLayoutManager()
```

Tip 1: NSTextAttachmentã‚’æŒ¿å…¥ã™ã‚‹å ´æ‰€ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹

```swift
let combine = NSMutableAttributedString(attributedString: NSAttributedString(string: ""))
let imageView = UIView() // ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ¥ãƒ¼
let imageAttachment = XLYTextAttachment { () -> UIView in
    return imageView
}
imageAttachment.id = id
imageAttachment.bounds = CGRect(x: 0, y: 0, width: size.width, height: size.height)
combine.append(NSAttributedString(attachment: imageAttachment))
self.contentTextView.textStorage.insert(combine, at: range)
```

Tip 2:NSTextAttachmentã®æ¤œç´¢ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„

```php
self.contentTextView.textStorage.enumerateAttribute(NSAttributedStringKey.attachment, in: NSRange(location: 0, length: self.contentTextView.textStorage.length), options: []) { (value, range, stop) in
    if let attachment = value as? XLYTextAttachment {
        //attachment.id
    }
}
```

Tip 3:NSTextAttachmenté …ç›®ã®å‰Šé™¤ã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹

```swift
self.contentTextView.textStorage.deleteCharacters(in: range) // æŒ‡å®šç¯„å›²ã®æ–‡å­—ã‚’å‰Šé™¤ã™ã‚‹
```

Tip 4: ç¾åœ¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ã‚’å–å¾—ã™ã‚‹

```swift
self.contentTextView.textStorage.length
```

Tip 5: Attachmentã®Boundsã‚µã‚¤ã‚ºã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹

ä¸»ãªç†ç”±ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ãŸã‚ã§ã™ã€‚ç”»åƒã‚’æŒ¿å…¥ã™ã‚‹ã¨ãã€ã¾ãšãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»åƒã‚’æŒ¿å…¥ã—ã€æŒ¿å…¥ã—ãŸç”»åƒã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åœ§ç¸®ã—ãŸå¾Œã«å·®ã—æ›¿ãˆã¾ã™ã€‚ãã®éš›ã€TextAttachmentã®Boundsã‚’ãƒªã‚µã‚¤ã‚ºå¾Œã®ã‚µã‚¤ã‚ºã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```swift
self.contentTextView.textStorage.addAttributes([:], range: range)
```

ï¼ˆç©ºã®å±æ€§ã‚’è¿½åŠ ã—ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼ï¼‰

Tip 6: å…¥åŠ›å†…å®¹ã‚’è»¢é€å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹

Tip 2ã‚’ä½¿ã£ã¦å…¨å…¥åŠ›å†…å®¹ã‚’æ¤œç´¢ã—ã€è¦‹ã¤ã‹ã£ãŸAttachmentã®IDã‚’å–ã‚Šå‡ºã—ã¦[[ID]]å½¢å¼ã§çµ„ã¿åˆã‚ã›ã¦æ¸¡ã™

Tip 7: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç½®æ›

```swift
self.contentTextView.textStorage.replaceCharacters(in: range,with: NSAttributedString(attachment: newImageAttachment))
```

Tip 8: æ­£è¦è¡¨ç¾ã§ãƒãƒƒãƒã—ãŸå†…å®¹ã®Rangeã‚’å–å¾—ã™ã‚‹

```swift
let pattern = "(\\[\\[image_id=){1}([0-9]+){1}(\\]\\]){1}"
let textStorage = self.contentTextView.textStorage

if let regex = try? NSRegularExpression(pattern: pattern, options: .caseInsensitive) {
    while true {
        let range = NSRange(location: 0, length: textStorage.length)
        if let match = regex.matches(in: textStorage.string, options: .withTransparentBounds, range: range).first {
            let matchString = textStorage.attributedSubstring(from: match.range)
            // è¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼
        } else {
            break
        }
    }
}
```

æ³¨æ„ï¼šæ¤œç´¢ã¨ç½®æ›ã‚’è¡Œã†å ´åˆã¯ã€Whileãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚è¤‡æ•°ã®æ¤œç´¢çµæœãŒã‚ã‚‹å ´åˆã€æœ€åˆã®çµæœã‚’ç½®æ›ã™ã‚‹ã¨ã€ãã®å¾Œã®æ¤œç´¢çµæœã®ç¯„å›²ãŒãšã‚Œã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

#### çµèª

ç¾åœ¨ã“ã®æ–¹æ³•ã§å®Œæˆå“ã‚’ä½œæˆã—ã€ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã—ãŸãŒã€ã¾ã å•é¡Œã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚æ™‚é–“ãŒã‚ã‚Œã°ã€æ”¹ã‚ã¦ãã®åŸç†ã‚’ã˜ã£ãã‚Šæ¢ç©¶ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

ã“ã®æ–‡ç« ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ãªãã€å€‹äººçš„ãªå•é¡Œè§£æ±ºã®çµŒé¨“å…±æœ‰ã§ã™ã€‚åŒæ§˜ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚ã”è³ªå•ã‚„ã”æŒ‡æ‘˜ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãœã²ã”é€£çµ¡ãã ã•ã„ã€‚

> Mediumã®æ­£å¼ãªæœ€åˆã®è¨˜äº‹

### é–¢é€£è¨˜äº‹

- [ZMarkupParser HTML String å¤‰æ› NSAttributedString ãƒ„ãƒ¼ãƒ«](../a5643de271e4/)

- [æ‰‹ä½œã‚Šã®HTMLãƒ‘ãƒ¼ã‚µãƒ¼ã«ã¤ã„ã¦](../2724f02f6e7/)

ã”è³ªå•ã‚„ã”æ„è¦‹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€[ã“ã¡ã‚‰ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„](https://www.zhgchg.li/contact){:target="_blank"} ã€‚

*[Post](https://medium.com/zrealm-ios-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8-swift-e37d66ea1146){:target="_blank"} ã¯ [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"} ã«ã‚ˆã£ã¦ Medium ã‹ã‚‰å¤‰æ›ã•ã‚Œã¾ã—ãŸã€‚*