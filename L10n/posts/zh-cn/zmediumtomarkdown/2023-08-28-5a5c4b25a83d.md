---
author: ZhgChgLi
categories:
- ZRealm Dev.
date: 2023-08-28T14:53:27.813+0000
description: ä¸ºç°æˆ App åŠç°æœ‰ API æ¶æ„å®ç° E2E Testing çš„å¯èƒ½æ€§éªŒè¯
image:
  path: /assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg
last_modified_at: 2023-09-04T14:32:47.020+0000
render_with_liquid: false
tags:
- simplified-chinese
- ios-app-development
- end-to-end-testing
- ui-testing
- automation-testing
- ios
title: POC App End-to-End Testing Local Snapshot API Mock Server
---

### [POC] App End-to-End Testing Local Snapshot API Mock Server



ä¸ºç°æˆ App åŠç°æœ‰ API æ¶æ„å®ç° E2E Testing çš„å¯èƒ½æ€§éªŒè¯



![Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.jpeg)



Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}



### å‰è¨€



ä½œä¸ºä¸€ä¸ªå·²åœ¨çº¿ä¸Šè¿ä½œå¤šå¹´çš„ä¸“æ¡ˆï¼Œå¦‚ä½•æŒç»­æå‡ç¨³å®šæ€§æ˜¯ä¸€ä»¶æå…·æŒ‘æˆ˜çš„é—®é¢˜ã€‚



#### Unit Testing



![](/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.png)



App å› å¼€å‘è¯­è¨€ Swift/Kotlin é™æ€+ç¼–è¯‘+å¼ºå‹åˆ« æˆ– Objective-C to Swift åŠ¨æ€è½¬é™æ€ï¼Œåœ¨å¼€å‘æ—¶æ²¡è€ƒè™‘åˆ°å¯æµ‹è¯•æ€§æŠŠä»‹é¢ä¾èµ–åˆ‡å¹²å‡€ï¼Œåé¢è¦è¡¥ Unit Testing å‡ ä¹ä¸å¯èƒ½ï¼›ä½†åœ¨é‡æ„çš„è¿‡ç¨‹ä¹Ÿä¼šå¸¦æ¥ä¸ç¨³å®šå› ç´ ï¼Œä¼šé™·å…¥ä¸€ä¸ªé¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡é—®é¢˜ã€‚



#### UI Testing



å¯¹ UI äº¤äº’ã€æŒ‰é’®æµ‹è¯•ï¼›æ–°å¼€å‘æˆ–æ—§æœ‰çš„ç”»é¢ç¨å¾®è§£è€¦èµ„æ–™ä¾èµ–å°±å¯ä»¥å®ç°ã€‚



#### SnapShot Testing



éªŒè¯è°ƒæ•´å‰åçš„ UI æ˜¾ç¤ºå†…å®¹ã€æ ·å¼æ˜¯å¦ä¸€è‡´ï¼›åŒ UI Testingï¼Œæ–°å¼€å‘æˆ–æ—§æœ‰çš„ç”»é¢ç¨å¾®è§£è€¦èµ„æ–™ä¾èµ–å°±å¯ä»¥å®ç°ã€‚



ç”¨åœ¨ Storyboard/XIB è½¬ Code Layout or UIView from OC to Swift å¾ˆå®ç”¨ï¼›å¯ä»¥ç›´æ¥å¯¼å…¥ [pointfreeco](https://github.com/pointfreeco){:target="_blank"} / [swift-snapshot-testing](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"} å¿«é€Ÿå®ç°ã€‚



[![](https://opengraph.githubassets.com/b3cc52a5b949767e4cb0af82145ed6474334d3235bd785ee1f7891c6b65fd69a/pointfreeco/swift-snapshot-testing)](https://github.com/pointfreeco/swift-snapshot-testing){:target="_blank"}



è™½ç„¶æˆ‘ä»¬å¯ä»¥åæœŸè¡¥ä¸Š UI Testingã€SnapShot Testingï¼Œä½†èƒ½æ¶µç›–çš„æµ‹è¯•èŒƒå›´å¾ˆæœ‰é™ï¼›å› ä¸ºå¤šåŠçš„é”™è¯¯ä¸ä¼šæ˜¯ UI æ ·å¼ï¼Œè€Œæ˜¯æµç¨‹æˆ–æ˜¯é€»è¾‘é—®é¢˜ï¼Œå¯¼è‡´ä½¿ç”¨è€…ä¸­æ–­æ“ä½œï¼Œ **å¦‚æœå‡ºç°åœ¨ç»“å¸æµç¨‹ï¼Œç‰µæ¶‰åˆ°è¥æ”¶ï¼Œé—®é¢˜å±‚çº§å°±å¾ˆä¸¥é‡** ã€‚



### End-to-End Testing



å¦‚å‰è¿°ï¼Œæ— æ³•åœ¨ç°è¡Œä¸“æ¡ˆç®€æ˜“çš„è¡¥ä¸Šå•å…ƒæµ‹è¯•ä¹Ÿæ— æ³•èšæ‹¢å•å…ƒåšæ•´åˆæµ‹è¯•ï¼Œå¯¹äºé€»è¾‘ã€æµç¨‹çš„é˜²æŠ¤ï¼Œè¿˜å‰©ä¸‹ä»å¤–éƒ¨åš End-to-End é»‘ç®±æµ‹è¯•çš„æ–¹æ³•ï¼Œç›´æ¥ä»¥ä½¿ç”¨è€…è§’åº¦å‡ºå‘ï¼Œæ“ä½œæµç¨‹æ£€æŸ¥é‡è¦çš„æµç¨‹(æ³¨å†Œ/ç»“å¸â€¦)æ˜¯å¦æ­£å¸¸ã€‚



> å¯¹é‡å¤§åŠŸèƒ½çš„é‡æ„ä¹Ÿèƒ½å…ˆå»ºç«‹é‡æ„å‰çš„æµç¨‹æµ‹è¯•ï¼Œé‡æ„åé‡æ–°éªŒè¯ï¼Œç¡®ä¿é‡æ„ååŠŸèƒ½å¦‚é¢„æœŸã€‚



> é‡æ„ä¸­ä¸€å¹¶è¡¥ä¸Š Unit Testingã€Integration Testing å¢åŠ ç¨³å®šæ€§ï¼Œæ‰“ç ´é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„é—®é¢˜ã€‚



#### QA Team



End-to-End Testing æœ€ç›´æ¥æš´åŠ›çš„æ–¹å¼å°±æ˜¯è¯·ä¸€ç»„ QA Team ä¾ç…§ Test Plan è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•ï¼Œç„¶åå†æŒç»­ä¼˜åŒ–æˆ–å¼•å…¥è‡ªåŠ¨åŒ–æ“ä½œï¼›è®¡ç®—äº†ä¸€ä¸‹æˆæœ¬è‡³å°‘éœ€è¦ 2 ä½å·¥ç¨‹å¸ˆ + 1 ä½ Leader èŠ±è´¹è‡³å°‘åŠå¹´ä¸€å¹´æ—¶é—´æ‰èƒ½çœ‹åˆ°æˆæœã€‚



è¯„ä¼°æ—¶é—´ä¸æˆæœ¬ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæ˜¯ç°å†µæˆ‘ä»¬èƒ½åšçš„æˆ–æ˜¯èƒ½ä¸ºæœªæ¥ QA Team åšå¥½å‡†å¤‡ï¼Œå½“æœ‰ QA Team æ—¶èƒ½ç›´æ¥è·³åˆ°ä¼˜åŒ–ä¸è‡ªåŠ¨åŒ–æ“ä½œç”šè‡³å¯¼å…¥ AI(?)ã€‚



#### Automation



ç°é˜¶æ®µä»¥å¯¼å…¥è‡ªåŠ¨åŒ– End-to-End Testing ä¸ºç›®æ ‡ï¼Œæ”¾åœ¨ CI/CD ç¯èŠ‚è‡ªåŠ¨æ£€æŸ¥ï¼Œæµ‹è¯•å†…å®¹å¯ä»¥ä¸ç”¨å¤ªå®Œæ•´ã€åªè¦èƒ½é˜²æ­¢é‡å¤§æµç¨‹é—®é¢˜å°±å·²ç»å¾ˆæœ‰ä»·å€¼äº†ï¼›åé¢å†æ…¢æ…¢è¿­ä»£ Test Plan é€æ­¥è¡¥é½å®ˆå¤‡èŒƒå›´ã€‚



### End-to-End Testing â€”æŠ€æœ¯éš¾ç‚¹



#### UI æ“ä½œé—®é¢˜



App çš„åŸç†æ¯”è¾ƒåƒæ˜¯é€è¿‡å¦ä¸€ä¸ªæµ‹è¯• App å»æ“ä½œæˆ‘ä»¬çš„è¢«æµ‹è¯• Appï¼Œç„¶åä» View Hierarchy å»æ‰¾å¯»ç›®æ ‡ç‰©ä»¶ï¼›å¹¶ä¸”åœ¨æµ‹è¯•æ—¶æ— æ³•å–å¾—è¢«æµ‹è¯• App çš„ Log æˆ– Outputï¼Œå› ä¸ºæœ¬è´¨ä¸Šå°±æ˜¯ä¸¤ä¸ªä¸åŒ Appã€‚



iOS éœ€è¦å®Œå–„ View Accessibility Identifier å¢åŠ æ•ˆç‡ä¸å‡†ç¡®æ€§è¿˜æœ‰è¦å¤„ç† Alert (e.g. æ¨æ’­è¯·æ±‚)ã€‚



Android åœ¨ä¹‹å‰çš„å®ä½œä¸Šæœ‰é‡åˆ°æ··ç”¨ Compose ä¸ Fragment æ—¶ä¼šæ‰¾ä¸åˆ°ç›®æ ‡ç‰©ä»¶çš„é—®é¢˜ï¼Œä½†æ® Teammate è¡¨ç¤ºï¼Œæ–°ç‰ˆçš„ Compose å·²ç»è§£å†³ã€‚



é™¤ä»¥ä¸Šä¼ ç»Ÿå¸¸è§é—®é¢˜å¤–ï¼Œæ›´å¤§çš„é—®é¢˜æ˜¯åŒå¹³å°éš¾ä»¥æ•´åˆ(å†™ä¸€ä¸ªæµ‹è¯•è·‘ä¸¤ä¸ªå¹³å°)ï¼›ç›®å‰æˆ‘ä»¬åœ¨å°è¯•ä½¿ç”¨æ–°çš„æµ‹è¯•å·¥å…· [mobile-dev-inc](https://github.com/mobile-dev-inc){:target="_blank"} / [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} ï¼š



[![](https://opengraph.githubassets.com/d9e6bc8b1cb6b3db5f52dd9bfa04fe2661ed172d7be82155b8f3e4b6c874f821/mobile-dev-inc/maestro)](https://github.com/mobile-dev-inc/maestro){:target="_blank"}



å¯ä»¥ç”¨ YAML å†™ Test Plan ç„¶ååœ¨åŒå¹³å°æ‰§è¡Œæµ‹è¯•ï¼Œç»†èŠ‚ä½¿ç”¨æ–¹å¼ã€è¯•ç”¨å¿ƒå¾—ï¼Œé™å¾…å¦ä¸€ä½ Teammate çš„æ–‡ç« åˆ†äº« ccâ€™ed [Alejandra Ts.](https://medium.com/u/1139df7a27f3){:target="_blank"} ğŸ˜ã€‚



#### API èµ„æ–™é—®é¢˜



å¯¹äº App E2E Testing æœ€å¤§çš„æµ‹è¯•å˜é‡å°±æ˜¯ API èµ„æ–™ï¼Œå¦‚æœæ— æ³•æä¾›ä¿è¯ç¡®å®šçš„èµ„æ–™ï¼Œä¼šå¢åŠ æµ‹è¯•çš„ä¸ç¨³å®šæ€§ï¼Œå¯¼è‡´è¯¯æŠ¥ï¼Œæœ€åå¤§å®¶å¯¹ Test Plan ä¹Ÿä¸å†æœ‰ä¿¡å¿ƒäº†ã€‚



ä¾‹å¦‚æµ‹è¯•ç»“å¸æµç¨‹ï¼Œå¦‚æœå•†å“æœ‰å¯èƒ½è¢«ä¸‹æ¶æˆ–æ¶ˆå¤±ï¼Œä¸”è¿™äº›çŠ¶æ€æ”¹å˜ä¸æ˜¯ App å¯æ§çš„å°±å¾ˆæœ‰å¯èƒ½å‡ºç°ä»¥ä¸ŠçŠ¶å†µã€‚



è§£å†³èµ„æ–™é—®é¢˜çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥å»ºç«‹å¹²å‡€çš„ Staging æˆ– Testing ç¯å¢ƒï¼›æˆ–æ˜¯åŸºäº Open API çš„ Auto-Gen Mock API Serverï¼›ä½†éƒ½éœ€è¦ä¾èµ–åç«¯ã€ä¾èµ– API çš„å¤–éƒ¨å› ç´ ï¼ŒåŠ ä¸Šåç«¯ API åŒ App ä¸€æ ·æ˜¯åœ¨çº¿ä¸Šè¿ä½œå¤šå¹´çš„ä¸“æ¡ˆï¼Œéƒ¨ä»½è§„æ ¼ä¹Ÿè¿˜åœ¨é‡æ„ Migrate æš‚æ—¶æ— æ³•æœ‰ Mock Serverã€‚



åŸºäºä»¥ä¸Šå› ç´ ï¼Œå¦‚æœå°±å¡åœ¨è¿™ï¼Œé‚£é—®é¢˜ä¸€æ ·ä¸ä¼šæ”¹å˜ã€é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡é—®é¢˜ä¹Ÿæ— æ³•çªç ´ï¼ŒçœŸçš„å°±åªèƒ½ã€ŒæŒºè€Œèµ°é™©ã€çš„ç›´æ¥å…ˆæ”¹ã€å‡ºé—®é¢˜å†è¯´äº†ã€‚



#### Snapshot API Local Mock Server



> ã€Œåªè¦æ€æƒ³ä¸æ»‘å¡ï¼Œæ–¹æ³•æ€»æ¯”å›°éš¾å¤šã€



æˆ‘ä»¬å¯ä»¥æ¢ä¸€ä¸ªæƒ³æ³•ï¼Œå¦‚æœ UI å¯ä»¥ç”¨ Snapshot å¿«ç…§æˆå›¾ç‰‡ä¸‹æ¥ Replay è¿›è¡ŒéªŒè¯æµ‹è¯•ï¼Œé‚£ API æ˜¯å¦ä¹Ÿå¯ä»¥ï¼Ÿ æˆ‘ä»¬æ˜¯å¦å¯ä»¥æŠŠ API Request & Response å­˜ä¸‹æ¥ï¼Œåœ¨åç»­ Replay è¿›è¡ŒéªŒè¯æµ‹è¯•ï¼Ÿ



**å€Ÿæ­¤å¼•å…¥æœ¬ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼šå»ºç«‹ã€ŒSnapshot API Local Mock Serverã€Record API Request & Replay Response å‰¥ç¦»ä¸ API èµ„æ–™çš„ä¾èµ–ã€‚**



> æœ¬æ–‡åªåšäº† POC æ¦‚å¿µéªŒè¯ï¼Œè¿˜æ²¡æœ‰çœŸæ­£å…¨é¢å®ç°é«˜è¦†ç›–ç‡çš„ End To End Testingï¼Œå› æ­¤åšæ³•ä»…ä¾›å‚è€ƒï¼Œ **å¸Œæœ›å¯¹å¤§å®¶åœ¨ç°æœ‰ç¯å¢ƒä¸‹æœ‰æ–°çš„å¯å‘** ã€‚



### Snapshot API Local Mock Server



#### æ ¸å¿ƒæ¦‚å¿µ â€” Record & Replay API Data



**[Record]** â€” End-to-End Testing Test Case å¼€å‘å®Œæˆåï¼Œæ‰“å¼€å½•åˆ¶å‚æ•°ï¼Œæ‰§è¡Œä¸€æ¬¡æµ‹è¯•ï¼Œè¿‡ç¨‹ä¸­æ‰€æœ‰ API Request & Response ä¼šå­˜ä¸‹æ¥æ”¾åœ¨å„ä¸ª Test Case ç›®å½•å†…ã€‚



**[Replay]** â€” åé¢åœ¨è·‘ Test Case æ—¶ï¼Œä¾ç…§è¯·æ±‚ä» Test Case ç›®å½•ä¸­æ‰¾åˆ°å¯¹åº”å½•åˆ¶ä¸‹æ¥çš„ Response Dataï¼Œå®Œæˆæµ‹è¯•æµç¨‹ã€‚



#### ç¤ºæ„å›¾



å‡è®¾æˆ‘ä»¬è¦æµ‹è¯•åŠ å…¥è´­ä¹°æµç¨‹ï¼Œä½¿ç”¨è€…æ‰“å¼€ App ååœ¨é¦–é¡µç‚¹å‡»å•†å“å¡è¿›å…¥å•†å“è¯¦ç»†é¡µï¼ŒæŒ‰åº•éƒ¨è´­ä¹°ï¼Œè·³å‡ºç™»å…¥åŒ¡å®Œæˆç™»å…¥ï¼Œå®Œæˆè´­ä¹°ï¼Œè·³å‡ºè´­ä¹°æˆåŠŸæç¤ºï¼š



![](/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.png)



UI Testing å¦‚ä½•æ§åˆ¶æŒ‰é’®ç‚¹å‡»ã€è¾“å…¥åŒ¡è¾“å…¥â€¦ç­‰ç­‰ï¼Œä¸æ˜¯æœ¬æ–‡ä¸»è¦ç ”ç©¶é‡ç‚¹ï¼›å¯å‚è€ƒç°æœ‰çš„æµ‹è¯•æ¡†æ¶ç›´æ¥ä½¿ç”¨ã€‚



#### Regular Proxy or Reverse Proxy



è¦è¾¾æˆ Record & Replay API éœ€è¦åœ¨ App ä¸ API ä¹‹é—´åŠ ä¸Š Proxy åšä¸­é—´äººæ”»å‡»ï¼Œå¯å‚è€ƒæˆ‘æ—©æœŸçš„æ–‡ç« ã€Œ [APPæœ‰ç”¨HTTPSä¼ è¾“ï¼Œä½†èµ„æ–™è¿˜æ˜¯è¢«å·äº†ã€‚](../46410aaada00/) ã€



ç®€å•æ¥è¯´å°±æ˜¯åœ¨ App ä¸ API ä¹‹é—´å¤šäº†ä¸€ä¸ªä»£ç†çš„ä¼ é€’è€…ï¼Œå¦‚åŒä¼ çº¸æ¡ä¸€æ ·ï¼ŒåŒæ–¹ä¼ é€’çš„è¯·æ±‚ä¸å›åº”éƒ½ä¼šç»è¿‡ä»–ï¼Œä»–å¯ä»¥æ‰“å¼€æ¥çº¸æ¡çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä¼ªé€ çº¸æ¡å†…å®¹ç»™å½¼æ­¤ï¼ŒåŒæ–¹ä¸ä¼šå¯Ÿè§‰ä½ ä»ä¸­åšæ¢—ã€‚



**æ­£å‘ä»£ç† Regular Proxyï¼š**



æ­£å‘ä»£ç†æ˜¯å®¢æˆ·ç«¯å‘ä»£ç†ä¼ºæœå™¨å‘é€è¯·æ±‚ï¼Œä»£ç†ä¼ºæœå™¨å†å°†è¯·æ±‚è½¬å‘ç»™ç›®æ ‡ä¼ºæœå™¨ï¼Œå¹¶å°†ç›®æ ‡ä¼ºæœå™¨çš„å›åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚åœ¨æ­£å‘ä»£ç†æ¨¡å¼ä¸‹ï¼Œä»£ç†ä¼ºæœå™¨ä»£è¡¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ã€‚å®¢æˆ·ç«¯éœ€è¦æ˜ç¡®æŒ‡å®šä»£ç†ä¼ºæœå™¨çš„ä½å€å’ŒåŸ å·ï¼Œå¹¶å°†è¯·æ±‚å‘é€ç»™ä»£ç†ä¼ºæœå™¨ã€‚



**åå‘ä»£ç† Reverse Proxyï¼š**



åå‘ä»£ç†ä¸æ­£å‘ä»£ç†ç›¸åï¼Œå®ƒä½äºç›®æ ‡ä¼ºæœå™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´ã€‚å®¢æˆ·ç«¯å‘åå‘ä»£ç†ä¼ºæœå™¨å‘é€è¯·æ±‚ï¼Œåå‘ä»£ç†ä¼ºæœå™¨æ ¹æ®ä¸€å®šçš„è§„åˆ™å°†è¯·æ±‚è½¬å‘ç»™åç«¯çš„ç›®æ ‡ä¼ºæœå™¨ï¼Œå¹¶å°†ç›®æ ‡ä¼ºæœå™¨çš„å›åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œç›®æ ‡ä¼ºæœå™¨çœ‹èµ·æ¥å°±åƒæ˜¯åå‘ä»£ç†ä¼ºæœå™¨ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“ç›®æ ‡ä¼ºæœå™¨çš„çœŸå®ä½å€ã€‚



å¯¹æˆ‘ä»¬çš„éœ€æ±‚æ¥è¯´æ­£å‘æˆ–åå‘éƒ½å¯ä»¥è¾¾æˆç›®çš„ï¼Œå”¯ä¸€è¦è€ƒè™‘çš„äº‹æ˜¯ä»£ç†è®¾ç½®çš„æ–¹å¼ï¼š



**æ­£å‘ä»£ç†éœ€è¦åœ¨ç”µè„‘ä¸Šæˆ–æ‰‹æœºã€æ¨¡æ‹Ÿèµ·çš„ç½‘è·¯è®¾ç½®ä¸­æŒ‚ä¸Š Proxy ä»£ç†ï¼š**



- Android èƒ½åœ¨æ¨¡æ‹Ÿå™¨ä¸­ä¸ªåˆ«ç›´æ¥è®¾ç½® Proxy ä»£ç†


- iOS Simulator åŒç”µè„‘çš„ç½‘è·¯ç¯å¢ƒï¼Œæ— æ³•ä¸ªè®¾ç½® Proxyï¼Œå˜æˆè¦å»æ”¹ç”µè„‘çš„è®¾ç½®æ‰èƒ½æŒ‚ä¸Š Proxyï¼Œç”µè„‘çš„æ‰€æœ‰æµé‡ä¹Ÿéƒ½ä¼šç»è¿‡è¿™ä¸ª Proxy å¹¶ä¸”å¦‚æœåŒæ—¶å¼€å¯ Proxyman æˆ– Charles ç­‰ç­‰å…¶ä»–ç½‘è·¯å·¥å…·ï¼Œæœ‰æœºä¼šä¼šå¼ºåˆ¶æ›´æ”¹ Proxy è®¾ç½®æˆè¯¥è½¯ä½“çš„ï¼Œå¯¼è‡´å¤±æ•ˆã€‚



**åå‘ä»£ç†éœ€è¦æ”¹ Codebase ä¸­çš„ API Host å¹¶ä¸”è¦å®£å‘Šè¦ä»£ç†çš„æ‰€æœ‰ API Domainsï¼š**



- Codebase ä¸­çš„ API Host è¦åœ¨æµ‹è¯•æ—¶æ›¿æ¢æˆ Proxy Server IP


- åœ¨å¯ç”¨ Reverse Proxy æ—¶è¦å®£å‘Šå“ªäº› Domain è¦æŒ‚ä¸Š Proxy


- åªæœ‰å®£å‘Šçš„ Domain æ‰ä¼šèµ° Proxyï¼Œæ²¡å®£å‘Šçš„ä¼šç›´é€šå‡ºå»



> é…åˆ iOS Appï¼Œä»¥ä¸‹ä»¥ iOS & ä½¿ç”¨ Reverse Proxy åå‘ä»£ç†ä¸ºä¾‹åš POCï¼ŒAndroid ä¸€æ ·å¯ä»¥ä½¿ç”¨ã€‚



#### è®© iOS App çŸ¥é“ç°åœ¨æ­£åœ¨è·‘ End-to-End Testing



æˆ‘ä»¬éœ€è¦è®© App çŸ¥é“ç°åœ¨æ­£åœ¨è·‘ End-to-End Testing æ‰èƒ½åœ¨ App ç¨‹å¼é‡ŒåŠ ä¸Š API Host æ›¿æ¢é€»è¾‘ï¼š



```
// UI Testing Target:
let app = XCUIApplication()
app.launchArguments = ["duringE2ETesting"]
app.launch()
```



æˆ‘ä»¬åœ¨ Network å±‚åšåˆ¤æ–­æŠ½æ¢ã€‚



> è¿™æ˜¯ä¸å¾—å·²çš„è°ƒæ•´ï¼Œå°½é‡è¿˜æ˜¯ä¸è¦ä¸ºäº†æµ‹è¯•è€Œå»æ”¹ App çš„ Codeã€‚



### ä½¿ç”¨ MITMProxy å®ç° Reverse Proxy Server



> äº¦å¯ä½¿ç”¨ Swift è‡ªè¡Œå¼€å‘ Swift Server è¾¾æˆï¼Œæœ¬æ–‡åªæ˜¯ POC å› æ­¤ç›´æ¥ä½¿ç”¨ MITMProxy å·¥å…·ã€‚



#### [2023â€“09â€“04 Update] Mitmproxy-rodo å·²å¼€æº



ä»¥ä¸‹å®ä½œå†…å®¹å·²ç»å¼€æºåˆ° [mitmproxy-rodo](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"} ä¸“æ¡ˆï¼Œæ¬¢è¿ç›´æ¥å‰å¾€å¯¹ç…§ä½¿ç”¨ã€‚



[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}



éƒ¨ä»½ç»“æ„ä¸æœ¬æ–‡ç« å†…å®¹æœ‰æ‰€è°ƒæ•´ï¼Œå¼€æºæ—¶åç»­è°ƒæ•´äº†ï¼š



- å‚¨å­˜ç›®å½•çš„ç»“æ„ï¼Œæ”¹ä¸º `host / requestPath / method / hash`


- ä¿®æ­£ Header èµ„è®¯å‚¨å­˜ï¼Œåº”è¯¥ä¸º Bytes Data è€Œéçº¯ JSON String


- ä¿®æ­£éƒ¨ä»½é”™è¯¯


- å¢åŠ è‡ªåŠ¨å»¶é•¿ Set-Cookie æ—¶æ•ˆåŠŸèƒ½



> **âš ï¸ ä»¥ä¸‹è„šæœ¬ä»…å…± Demo å‚è€ƒï¼Œåç»­è„šæœ¬è°ƒæ•´å°†ç§»è‡³å¼€æºä¸“æ¡ˆç»´æŠ¤ã€‚**



> **âš ï¸ ä»¥ä¸‹è„šæœ¬ä»…å…± Demo å‚è€ƒï¼Œåç»­è„šæœ¬è°ƒæ•´å°†ç§»è‡³å¼€æºä¸“æ¡ˆç»´æŠ¤ã€‚**



> **âš ï¸ ä»¥ä¸‹è„šæœ¬ä»…å…± Demo å‚è€ƒï¼Œåç»­è„šæœ¬è°ƒæ•´å°†ç§»è‡³å¼€æºä¸“æ¡ˆç»´æŠ¤ã€‚**



> **âš ï¸ ä»¥ä¸‹è„šæœ¬ä»…å…± Demo å‚è€ƒï¼Œåç»­è„šæœ¬è°ƒæ•´å°†ç§»è‡³å¼€æºä¸“æ¡ˆç»´æŠ¤ã€‚**



> **âš ï¸ ä»¥ä¸‹è„šæœ¬ä»…å…± Demo å‚è€ƒï¼Œåç»­è„šæœ¬è°ƒæ•´å°†ç§»è‡³å¼€æºä¸“æ¡ˆç»´æŠ¤ã€‚**



#### [MITMProxy](https://mitmproxy.org){:target="_blank"}



ç…§è‘— [MITMProxy å®˜ç½‘](https://mitmproxy.org){:target="_blank"} å®Œæˆå®‰è£…ï¼š



```bash
brew install mitmproxy
```



MITMProxy ç»†èŠ‚ç”¨æ³•å¯å‚è€ƒæˆ‘æ—©æœŸçš„æ–‡ç« ã€Œ [APPæœ‰ç”¨HTTPSä¼ è¾“ï¼Œä½†èµ„æ–™è¿˜æ˜¯è¢«å·äº†ã€‚](../46410aaada00/) ã€



- `mitmproxy` æä¾›ä¸€ä¸ªäº’åŠ¨å¼çš„å‘½ä»¤è¡Œç•Œé¢ã€‚


- `mitmweb` æä¾›åŸºäºæµè§ˆå™¨çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚


- `mitmdump` æä¾›éäº’åŠ¨çš„ç»ˆç«¯è¾“å‡ºã€‚



#### å®ç° Record & Replay



å›  MITMProxy Reverse Proxy åŸç”Ÿæ²¡æœ‰ Record (or dump) request & Mapping Request Replay çš„åŠŸèƒ½ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªè¡Œæ’°å†™è„šæœ¬å®ç°æ­¤åŠŸèƒ½ã€‚



`mock.py` :



```python
"""
Example:
    Record: mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
    Replay: mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
"""

import re
import logging
import mimetypes
import os
import json
import hashlib

from pathlib import Path
from mitmproxy import ctx
from mitmproxy import http

class MockServerHandler:

    def load(self, loader):
        self.readHistory = {}
        self.configuration = {}

        loader.add_option(
            name="dumper_folder",
            typespec=str,
            default="dump",
            help="Response Dump ç›®å½•ï¼Œå¯ä»¥ by Test Case Name å»ºç«‹",
        )

        loader.add_option(
            name="network_restricted",
            typespec=bool,
            default=True,
            help="æœ¬åœ°æ²¡æœ‰ Mapping èµ„æ–™...è®¾ç½® true ä¼š return 404ã€false ä¼šå»æ‰“çœŸå®è¯·æ±‚æ‹¿èµ„æ–™ã€‚",
        )

        loader.add_option(
            name="record",
            typespec=bool,
            default=False,
            help="è®¾ç½® true å½•åˆ¶ Request's Response",
        )

        loader.add_option(
            name="config_file",
            typespec=str,
            default="",
            help="è®¾ç½®æ¡£æ¡ˆè·¯å¾„ï¼ŒèŒƒä¾‹æ¡£æ¡ˆåœ¨ä¸‹é¢",
        )
    
    def configure(self, updated):
        self.loadConfig()

    def loadConfig(self):
        configFile = Path(ctx.options.config_file)
        if ctx.options.config_file == "" or not configFile.exists():
            return

        self.configuration = json.loads(open(configFile, "r").read())

    def hash(self, request):
        query = request.query
        requestPath = "-".join(request.path_components)

        ignoredQueryParameterByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("queryParamters", [])
        ignoredQueryParameterGlobal = self.configuration.get("ignored", {}).get("global", {}).get("queryParamters", [])

        filteredQuery = []
        if query:
            filteredQuery = [(key, value) for key, value in query.items() if key not in ignoredQueryParameterByPaths + ignoredQueryParameterGlobal]
        
        formData = []
        if request.get_content() != None and request.get_content() != b'':
            formData = json.loads(request.get_content())
        
        # or just formData = request.urlencoded_form
        # or just formData = request.multipart_form
        # depends on your api design

        ignoredFormDataParametersByPaths = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("formDataParameters", [])
        ignoredFormDataParametersGlobal = self.configuration.get("ignored", {}).get("global", {}).get("formDataParameters", [])

        filteredFormData = []
        if formData:
            filteredFormData = [(key, value) for key, value in formData.items() if key not in ignoredFormDataParametersByPaths + ignoredFormDataParametersGlobal]
        
        # Serialize the dictionary to a JSON string
        hashData = {"query":sorted(filteredQuery), "form": sorted(filteredFormData)}
        json_str = json.dumps(hashData, sort_keys=True)

        # Apply SHA-256 hash function
        hash_object = hashlib.sha256(json_str.encode())
        hash_string = hash_object.hexdigest()
        
        return hash_string

    def readFromFile(self, request):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        if not folder.exists():
            return None

        content_type = request.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"


        count = self.readHistory.get(host, {}).get(method, {}).get(requestPath, {}) or 0

        filepath = folder / f"Content-{str(count)}{ext}"

        while not filepath.exists() and count > 0:
            count = count - 1
            filepath = folder / f"Content-{str(count)}{ext}"

        if self.readHistory.get(host) is None:
            self.readHistory[host] = {}
        if self.readHistory.get(host).get(method) is None:
            self.readHistory[host][method] = {}
        if self.readHistory.get(host).get(method).get(requestPath) is None:
            self.readHistory[host][method][requestPath] = {}

        if filepath.exists():
            headerFilePath = folder / f"Header-{str(count)}.json"
            if not headerFilePath.exists():
                headerFilePath = None
            
            count += 1
            self.readHistory[host][method][requestPath] = count

            return {"content": filepath, "header": headerFilePath}
        else:
            return None


    def saveToFile(self, request, response):
        host = request.host
        method = request.method
        hash = self.hash(request)
        requestPath = "-".join(request.path_components)

        iterable = self.configuration.get("ignored", {}).get("paths", {}).get(request.host, {}).get(requestPath, {}).get(request.method, {}).get("iterable", False)
        
        folder = Path(ctx.options.dumper_folder) / host / method / requestPath / hash

        # create dir if not exists
        if not folder.exists():
            os.makedirs(folder)

        content_type = response.headers.get("content-type", "").split(";")[0]
        ext = mimetypes.guess_extension(content_type) or ".json"

        repeatNumber = 0
        filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        while filepath.exists() and iterable == False:
            repeatNumber += 1
            filepath = folder / f"Content-{str(repeatNumber)}{ext}"
        
        # dump to file
        with open(filepath, "wb") as f:
            f.write(response.content or b'')
            
        
        headerFilepath = folder / f"Header-{str(repeatNumber)}.json"
        with open(headerFilepath, "wb") as f:
            responseDict = dict(response.headers.items())
            responseDict['_status_code'] = response.status_code
            f.write(json.dumps(responseDict).encode('utf-8'))

        return {"content": filepath, "header": headerFilepath}

    def request(self, flow):
        if ctx.options.record != True:
            host = flow.request.host
            path = flow.request.path

            result = self.readFromFile(flow.request)
            if result is not None:
                content = b''
                headers = {}
                statusCode = 200

                if result.get('content') is not None:
                    content = open(result['content'], "r").read()

                if result.get('header') is not None:
                    headers = json.loads(open(result['header'], "r").read())
                    statusCode = headers['_status_code']
                    del headers['_status_code']

                
                headers['_responseFromMitmproxy'] = '1'
                flow.response = http.Response.make(statusCode, content, headers)
                logging.info("Fullfill response from local with "+str(result['content']))
                return

            if ctx.options.network_restricted == True:
                flow.response = http.Response.make(404, b'', {'_responseFromMitmproxy': '1'})
        
    def response(self, flow):
        if ctx.options.record == True and flow.response.headers.get('_responseFromMitmproxy') != '1':
            result = self.saveToFile(flow.request, flow.response)
            logging.info("Save response to local with "+str(result['content']))

addons = [MockServerHandler()]
```



å¯ä»¥è‡ªè¡Œå‚è€ƒ [å®˜æ–¹æ–‡ä»¶](https://docs.mitmproxy.org/stable/api/events.html){:target="_blank"} ï¼Œä¾ç…§éœ€æ±‚è°ƒæ•´è„šæœ¬å†…å®¹ã€‚



**æ­¤è„šæœ¬è®¾è®¡é€»è¾‘å¦‚ä¸‹ï¼š**



- æ¡£æ¡ˆè·¯å¾„é€»è¾‘ï¼š `dumper_folder(a.k.a Test Case Name)` / `Reverse's api host` / `HTTP Method` / `Path join with -` (e.g. `app/launch` -&gt; `app-launch` ) / `Hash(Get Query & Post Content)` /


- æ¡£æ¡ˆé€»è¾‘ï¼šå›åº”çš„å†…å®¹ï¼š `Content-0.xxx` ã€ `Content-1.xxx` (åŒä¸ªè¯·æ±‚æ‰“ç¬¬äºŒæ¬¡)â€¦ä»¥æ­¤ç±»æ¨ï¼›å›åº”çš„ Header èµ„è®¯ï¼š `Header-0.json` (åŒ `Content-x` é€»è¾‘)



![](/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.png)



- å‚¨å­˜æ—¶ä¼šä¾ç…§è·¯å¾„ã€æ¡£æ¡ˆé€»è¾‘ä¾åºå‚¨å­˜ï¼›åœ¨ Replay æ—¶åŒæ ·ä¾åºå–å‡º


- å¦‚æœæ¬¡æ•°ä¸åŒ¹é…ï¼Œä¾‹å¦‚ Replay æ—¶åŒä¸ªè·¯å¾„æ‰“äº† 3 æ¬¡ï¼Œä½† Record å‚¨å­˜çš„èµ„æ–™åªå­˜åˆ°ç¬¬ 2 æ¬¡ï¼›åˆ™è¿˜æ˜¯ä¼šæŒç»­å›åº”ç¬¬ 2 æ¬¡ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡çš„ç»“æœ


- `record` ä¸º `True` æ—¶ï¼Œä¼šå»æ‰“ç›®æ ‡ Server å–å¾—å›åº”å¹¶ä¾ç…§ä¸Šè¿°é€»è¾‘å‚¨å­˜ä¸‹æ¥ï¼› `False` æ—¶åˆ™åªä¼šä»æœ¬åœ°è¯»èµ„æ–™ (ç­‰äº Replay Mode)


- `network_restricted` ä¸º `False` æ—¶ï¼Œæœ¬åœ°æ²¡ Mapping èµ„æ–™ä¼šç›´æ¥å›åº” `404` ï¼›ä¸º `True` æ—¶ä¼šå»æ‰“ç›®æ ‡ Server æ‹¿èµ„æ–™ã€‚


- `_responseFromMitmproxy` ç”¨äºå‘ŠçŸ¥ Response Method å½“å‰å›åº”æ¥è‡ª Localï¼Œå¯ä»¥å¿½ç•¥ä¸ç®¡ã€ `_status_code` å€Ÿç”¨ Header.json æ ä½å‚¨å­˜ HTTP Response çŠ¶æ€ç ã€‚



`config_file.json` **è®¾ç½®æ¡£æ¡ˆé€»è¾‘è®¾è®¡å¦‚ä¸‹ï¼š**



```json
{
  "ignored": {
    "paths": {
      "yourapihost.com": {
        "add-to-cart": {
          "POST": {
            "queryParamters": [
              "created_timestamp"
            ],
            "formDataParameters": []
          }
        },
        "api-status-checker": {
          "GET": {
            "iterable": true
          }
        }
      }
    },
    "global": {
      "queryParamters": [
        "timestamp"
      ],
      "formDataParameters": []
    }
  }
}
```



`queryParamters` **& `formDataParameters` :**



å› éƒ¨åˆ† API å‚æ•°å¯èƒ½ä¼šéšå‘¼å«æ”¹å˜ï¼Œä¾‹å¦‚æœ‰çš„ Endpoint ä¼šå¸¦ä¸Šæ—¶é—´å‚æ•°ï¼Œæ­¤æ—¶ä¾ç…§ Server çš„è®¾è®¡ï¼Œ `Hash(Query Parameter & Body Content)` çš„å€¼å°±ä¼šåœ¨ Replay Request æ—¶ä¸ä¸€æ ·ï¼Œå¯¼è‡´ Mapping ä¸åˆ° Local Responseï¼Œå› æ­¤å¤šå¼€äº†ä¸€ä¸ª `config.json` å¤„ç†è¿™ä¸ªæƒ…å†µï¼Œå¯ä»¥ by Endpoint Path or Global è®¾å®šæŸä¸ªå‚æ•°åº”è¯¥åœ¨æ’é™¤ Hash æ—¶æ’é™¤ï¼Œå°±èƒ½å–å¾—åŒæ ·çš„ Mapping ç»“æœã€‚



`iterable` **:**



å› éƒ¨åˆ†è½®è¯¢æ£€æŸ¥çš„ API å¯èƒ½ä¼šé‡å¤å®šæ—¶ä¸æ–­å‘¼å«ï¼Œç…§ Server çš„è®¾è®¡ä¼šäº§å‡ºå¾ˆå¤š `Content-x.xxx` & `Header-x.json` æ¡£æ¡ˆï¼›ä½†å‡è®¾æˆ‘ä»¬ä¸åœ¨æ„åˆ™å¯è®¾å®šä¸º `True` ï¼ŒResponse ä¼šæŒç»­å‚¨å­˜è¦†ç›–åˆ° `Content-0.xxx` & `Header-0.json` ç¬¬ä¸€ä¸ªæ¡£æ¡ˆå†…ã€‚



**å¯ç”¨ Reverse Proxy Record Modeï¼š**



```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
```



**å¯ç”¨ Reverse Proxy Replay Modeï¼š**



```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
```



### ç»„è£… & Proof Of Concept



#### 0. å®Œæˆ Codebase ä¸­ Host çš„æŠ½æ¢



å¹¶ç¡®è®¤åœ¨è·‘æµ‹è¯•æ—¶ï¼ŒAPI å·²æ”¹ç”¨ `http://127.0.0.1:8080`



#### 1. å¯åŠ¨ Snapshot API Local Mock Server (a.k.a Reverse Proxy Server) Record Mode



```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=addCart --set config_file=config.json
```



#### 2. æ‰§è¡Œ E2E Testing UI æ“ä½œ



ä»¥ [Pinkoi iOS App](https://apps.apple.com/tw/app/pinkoi-%E4%BA%9E%E6%B4%B2%E9%A0%98%E5%85%88%E8%B7%A8%E5%A2%83%E8%A8%AD%E8%A8%88%E8%B3%BC%E7%89%A9%E7%B6%B2%E7%AB%99/id557252416){:target="_blank"} ä¸ºä¾‹ï¼Œæµ‹è¯•ä»¥ä¸‹æµç¨‹ï¼š



> Launch App -&gt; Home -&gt; Scroll Down -&gt; Similar to Wish List Items Section -&gt; First Product -&gt; Click First Product -&gt; Enter Product Page -&gt; Click Add to Cart -&gt; UI Response Added to Cart -&gt; Test Successful âœ…



![](/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.png)



UI è‡ªåŠ¨åŒ–æ“ä½œæ–¹å¼å‰é¢æœ‰æåˆ°ï¼Œè¿™è¾¹å…ˆæ‰‹åŠ¨æµ‹è¯•ç›¸åŒçš„æµç¨‹éªŒè¯ç»“æœã€‚



#### 3. å–å¾— Record ç»“æœ



æ“ä½œå®Œæˆåå¯ä»¥ä¸‹ `^ + C` ç»ˆæ­¢ Snapshot API Mock Serverï¼Œåˆ°æ¡£æ¡ˆç›®å½•æŸ¥çœ‹å½•åˆ¶ç»“æœï¼š



![](/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.png)



#### 4. Replay éªŒè¯åŒä¸ªæµç¨‹ï¼Œå¯åŠ¨ Server & Using Replay Mode



```bash
mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=addCart --set config_file=config.json
```



#### 5. å†æ¬¡æ‰§è¡Œåˆšåˆšçš„ UI æ“ä½œéªŒè¯ç»“æœ



![](/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.png)



- å·¦ï¼šTest Successful âœ…


- å³ï¼šæµ‹è¯•ç‚¹å‡»å½•åˆ¶ä»¥å¤–çš„å•†å“ï¼Œæ­¤æ—¶ä¼šå‡ºç° Error (å› æœ¬åœ°æ²¡èµ„æ–™ + `network_restricted` é¢„è®¾æ˜¯ `False` æœ¬åœ°æ²¡èµ„æ–™ç›´æ¥ä¼  404ï¼Œä¸ä¼šä»ç½‘è·¯æ‹¿èµ„æ–™)



#### 6. Proof Of Concept âœ…



æ¦‚å¿µéªŒè¯é€šè¿‡ï¼Œæˆ‘ä»¬ç¡®å®èƒ½é€è¿‡å®ç° Reverse Proxy Server æ¥è‡ªè¡Œå‚¨å­˜ API Request & Response å¹¶ä½œä¸º Mock API Server åœ¨æµ‹è¯•æ—¶å›åº”èµ„æ–™ç»™ App ğŸ‰ğŸ‰ğŸ‰ã€‚



### [2023â€“09â€“04] mitmproxy-rodo å·²å¼€æº



[![](https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4)](https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main){:target="_blank"}



### åç»­å’Œæ‚è®°



æœ¬æ–‡åªæ¢è®¨äº†æ¦‚å¿µéªŒè¯ï¼Œåç»­è¿˜æœ‰è®¸å¤šåœ°æ–¹è¦è¡¥é½ä¹Ÿè¿˜æœ‰æ›´å¤šåŠŸèƒ½å¯ä»¥å®ç°ã€‚



1. ä¸ [maestro](https://github.com/mobile-dev-inc/maestro){:target="_blank"} UI Testinga å·¥å…·æ•´åˆ


2. CI/CD æµç¨‹æ•´åˆè®¾è®¡ (æ€ä¹ˆè‡ªåŠ¨èµ· Reverse Proxy? èµ·åœ¨å“ªé‡Œ? )


3. æ€ä¹ˆæŠŠ MITMProxy å°è£…åœ¨å¼€å‘å·¥å…·å†…?


4. éªŒè¯æ›´å¤æ‚çš„æµ‹è¯•åœºæ™¯


5. **é’ˆå¯¹å‘é€çš„ Tracking Request åšéªŒè¯ï¼Œéœ€å¤šå®ç°å­˜ Request Bodyï¼Œç„¶åä»ä¸­å–å¾—æ‰“äº†å“ªäº› Tracking Event Dataã€æ˜¯å¦ç¬¦åˆæµç¨‹è¯¥é€çš„äº‹ä»¶**



#### Cookie é—®é¢˜



```python
#...
    def response(self, flow):
        setCookies = flow.response.headers.get_all("set-cookie")
        # setCookies = ['ad=0; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/', 'sessionid=xxxx; Secure; HttpOnly; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/']
        
        # OR Replace Cookie Domain From .xxx.com To 127.0.0.1
        setCookies = [re.sub(r"\s*\.xxx\.com\s*", "127.0.0.1", s) for s in setCookies]

        # AND ç§»é™¤å®‰å…¨æ€§ç›¸å…³é™åˆ¶
        setCookies = [re.sub(r";\s*Secure\s*", "", s) for s in setCookies]
        setCookies = [re.sub(r";\s*HttpOnly;\s*", "", s) for s in setCookies]

        flow.response.headers.set_all("Set-Cookie", setCookies)

        #...
```



å¦‚æœæœ‰é‡åˆ° Cookie æ–¹é¢çš„é—®é¢˜ï¼Œä¾‹å¦‚ API æœ‰å›åº” Cookie ä½† App æ²¡æ¥åˆ°ï¼Œå¯å‚è€ƒä»¥ä¸Šçš„è°ƒæ•´ã€‚



#### åœ¨ Pinkoi çš„æœ€åä¸€ç¯‡æ–‡ç« 



åœ¨ Pinkoi 900 å¤šå¤©çš„æ—¥å­é‡Œï¼Œå®ç°äº†è®¸å¤šæˆ‘èŒæ¶¯ä¸Šè¿˜æœ‰ iOS / App å¼€å‘ã€æµç¨‹çš„æƒ³åƒï¼Œæ„Ÿè°¢æ‰€æœ‰é˜Ÿå‹ï¼Œä¸€èµ·èµ°è¿‡ç–«æƒ…ã€ç»å†é£é›¨ï¼›å‘Šåˆ«çš„å‹‡æ°”å¦‚åŒå½“åˆè¿½å¯»æ¢¦æƒ³å…¥èŒçš„å‹‡æ°”ã€‚



> [**æ­£åœ¨å¯èˆªæ‰¾å¯»æ–°çš„äººç”ŸæŒ‘æˆ˜(åŒ…æ‹¬ä½†ä¸é™äºå·¥ç¨‹)ï¼Œå¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼ˆiOS or å·¥ç¨‹ç®¡ç† or æ–°åˆ›äº§å“ï¼‰æ¬¢è¿ä¸æˆ‘è”ç»œã€‚**](http://resume.zhgchg.li/){:target="_blank"} ğŸ™ğŸ™ğŸ™



æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ [ä¸æˆ‘è”ç»œ](https://www.zhgchg.li/contact){:target="_blank"} ã€‚



*[Post](https://medium.com/zrealm-ios-dev/poc-app-end-to-end-testing-local-snapshot-api-mock-server-5a5c4b25a83d){:target="_blank"} converted from Medium by [ZMediumToMarkdown](https://github.com/ZhgChgLi/ZMediumToMarkdown){:target="_blank"}.*