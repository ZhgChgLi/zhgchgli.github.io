<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对 iOS 与 Android 即时通讯需求，解析封装 Socket.IO 过程中遇到的复杂连线管理与跨平台挑战，透过七大设计模式优化连线复用、离线事件缓存与状态管理，提升系统稳定性与扩充性，助你打造高效且易维护的双向通讯架构。" /><meta property="og:description" content="针对 iOS 与 Android 即时通讯需求，解析封装 Socket.IO 过程中遇到的复杂连线管理与跨平台挑战，透过七大设计模式优化连线复用、离线事件缓存与状态管理，提升系统稳定性与扩充性，助你打造高效且易维护的双向通讯架构。" /><link rel="canonical" href="https://zhgchg.li/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/" /><meta property="og:url" content="https://zhgchg.li/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-07T22:49:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" /><meta property="twitter:title" content="Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-09-06T14:00:33+08:00","datePublished":"2022-04-07T22:49:17+08:00","description":"针对 iOS 与 Android 即时通讯需求，解析封装 Socket.IO 过程中遇到的复杂连线管理与跨平台挑战，透过七大设计模式优化连线复用、离线事件缓存与状态管理，提升系统稳定性与扩充性，助你打造高效且易维护的双向通讯架构。","headline":"Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"},"url":"https://zhgchg.li/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"}</script><title>Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/"><link rel="alternate" hreflang="zh-Hant" href="/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"><link rel="alternate" hreflang="zh-Hans" href="/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"><link rel="alternate" hreflang="x-default" href="/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析</h1><p class="post-desc fw-light mb-4">针对 iOS 与 Android 即时通讯需求，解析封装 Socket.IO 过程中遇到的复杂连线管理与跨平台挑战，透过七大设计模式优化连线复用、离线事件缓存与状态管理，提升系统稳定性与扩充性，助你打造高效且易维护的双向通讯架构。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1649342957" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 7, 2022 </time> </span> <span> Updated <time data-ts="1725602433" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 6, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" class="popup img-link preview-img blur"><img data-src="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="6515 words" > <em>36 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Design Patterns 实战应用｜封装 Socket.IO 即时通讯架构与七大设计模式解析</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><hr /><h3 id="design-patterns-的实战应用纪录"><span class="me-2">Design Patterns 的实战应用纪录</span><a href="#design-patterns-的实战应用纪录" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>封装 Socket.IO Client Library 需求时遇到的问题场景及解决方法应用到的 Design Patterns</p><p><a href="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*mkG0YtCzyPQpU9MG0HI79w.webp" alt="Photo by [Daniel McCullough](https://unsplash.com/@d_mccullough?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@d_mccullough?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Daniel McCullough</a></p><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>此篇文章是真实的需求开发，所运用到 Design Pattern 解决问题的场景记录；内容篇幅会涵盖需求背景、实际遇到的问题场景 (What?)、为何要套用 Pattern 解决问题 (Why?)、实作上如何使用 (How?)，建议可以从头阅读会比较有连贯性。</p><blockquote><p><em>本文会介绍四个开发此需求遇到的场景及七个解决此场景的 Design Patterns 应用。</em></p></blockquote><h3 id="背景"><span class="me-2">背景</span><a href="#背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="组织架构"><span class="me-2">组织架构</span><a href="#组织架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>敝司于今年拆分出 Feature Teams (multiple) 与 Platform Team；前者不必多说主要负责使用者端需求、Platform Team 这边则面对的是公司内部的成员，其中一个工作项目就是技术引入、基础建设及做好系统性整合，为 Feature Teams 开发需求时先锋铺好道路。</p><h4 id="当前需求"><span class="me-2">当前需求</span><a href="#当前需求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Feature Teams 要将原本的讯息功能 (进页面打 API 拿讯息资料，要更新最新讯息只能重整) 改为 即时通讯 (能即时收到最新讯息、对传讯息)。</p><h4 id="platform-team-工作"><span class="me-2">Platform Team 工作</span><a href="#platform-team-工作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Platform Team 著重的点不只是当下的即时通讯需求，而是长远的建设与复用性；评估后 webSocket 双向通讯的机制在现代 App 中是不可或缺，除了此次的需求之外，以后也有很多机会都会用到，加上人力资源许可，故投入协助设计开发介面。</p><p><strong>目标：</strong></p><ul><li><p>封装 Pinkoi Server Side 与 Socket.IO 通讯、身份验证逻辑</p><li><p>封装 Socket.IO 烦琐操作，提供基于 Pinkoi 商业需求的可扩充及方便使用介面</p><li><p>统一双平台介面 <strong>(Socket.IO 的 Android 与 iOS Client Side Library 支援的功能及介面不相同)</strong></p><li><p>Feature 端无需了解 Socket.IO 机制</p><li><p>Feature 端无需管理复杂的连线状态</p><li><p>未来有 webSocket 双向通讯需求能直接使用</p></ul><p><strong>时间及人力：</strong></p><ul><li><p>iOS &amp; Android 各投入一位</p><li><p>开发时程：时程 3 周</p></ul><h4 id="技术细节"><span class="me-2">技术细节</span><a href="#技术细节" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Web &amp; iOS &amp; Android 三平台均会支援此 Feature；要引入 webSocket 双向通讯协议来实现，后端预计直接使用 <a href="http://socket.io/" target="_blank">Socket.io</a> 服务。</p><blockquote><p><strong><em>首先要说 Socket != WebSocket</em></strong></p></blockquote><p>关于 Socket 与 WebSocket 及技术细节可参考以下两篇文章：</p><ul><li><p><a href="https://leesonhsu.blogspot.com/2018/07/socketwebsocketsocketio.html" target="_blank">Socket，Websocket，Socket.io的差异</a></p><li><p><a href="https://github.com/onlyliuxin/coding2017/issues/497" target="_blank">为什么不直接使用socket ,还要定义一个新的websocket 的呢？</a></p></ul><p>简而言之：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Socket 是 TCP/UDP 传输层的抽象封装介面，而 WebSocket 是应用层的传输协议。
Socket 与 WebSocket 的关系就像狗跟热狗的关系一样，没有关系。
</pre></table></code></div></div><p><a href="/assets/78507a8de6a5/1*MC_nQC382khMeWggLejWOA.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*MC_nQC382khMeWggLejWOA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Socket.IO 是 Engine.IO 的一层抽象操作封装，Engine.IO 则是对 WebSocket 的使用封装，每层只负责对上对下之间的交流，不允许贯穿操作(e.g. Socket.IO 直接操作 WebSocket 连线)。</p><p>Socket.IO/Engine.IO 除了基本的 WebSocket 连线外还实做了很多方便好用的功能集合(e.g. 离线发送 Event 机制、类似 Http Request 机制、Room/Group 机制…等等)。</p><p>Platform Team 这层的主要职责是桥接 Socket.IO 与 Pinkoi Server Side 之间的逻辑，供应上层 Feature Teams 开发功能时使用。</p><h4 id="socketio-swift-client-有坑"><span class="me-2"><a href="https://github.com/socketio/socket.io-client-swift" target="_blank">Socket.IO Swift Client</a> 有坑</span><a href="#socketio-swift-client-有坑" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>已许久未更新 (最新一版还在 2019)，不确定是否还有在维护。</p><li><p>Client &amp; Server Side Socket IO Version 要对齐，Server Side 可加上 <code class="language-plaintext highlighter-rouge">{allowEIO3: true}</code> / 或 Client Side 指定相同版本 <code class="language-plaintext highlighter-rouge">.version</code> 否则怎么连都连不上。</p><li><p>命名方式、介面与官网范例很多都对不起来。</p><li><p>Socket.io 官网范例都是拿 Web 做介绍，实际上 Swift Client <strong>并不一定有全支援官网写的功能</strong> 。 此次实作发现 iOS 这边 Library 并未实现离线发送 Event 机制 (我们是自行实现的，请往后继续阅读)</p></ul><blockquote><p><strong><em>建议有要采用 Socket.IO 前先实验看看你想要的机制是否支援。</em></strong></p></blockquote><blockquote><p><em>Socket.IO Swift Client 是基于 <strong><a href="https://github.com/daltoniam/Starscream" target="_blank">Starscream</a></strong> WebSocket Library 的封装，必要时可降级使用 Starscream。</em></p></blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>背景资讯补充到此结束，接下来进入正题。
</pre></table></code></div></div><h3 id="design-patterns"><span class="me-2">Design Patterns</span><a href="#design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>设计模式说穿了就只是软体设计当中常见问题的解决方案，不一定要用设计模式才能开发、设计模式不一定能适用所有场景、也没人说不能自行归纳出新的设计模式。</p><p><a href="/assets/78507a8de6a5/1*MAm5WPynbv7M9tdmW2lNGQ.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*MAm5WPynbv7M9tdmW2lNGQ.webp" alt="[The Catalog of Design Patterns](https://refactoring.guru/design-patterns/catalog){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjEwODMiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p><a href="https://refactoring.guru/design-patterns/catalog" target="_blank">The Catalog of Design Patterns</a></p><p>但现有的设计模式 (The 23 Gang of Four Design Patterns) 已是软体设计中的共同知识，只要提到 XXX Pattern 大家脑中就会有相应的架构蓝图，不需多做解释、后续维护也比较好知道脉络、且已是经过业界验证的方法不太需要花时间审视物件依赖问题；在适合的场景选用适合的模式可以降低沟通及维护成本，提升开发效率。</p><blockquote><p><strong><em>设计模式可以组合使用，但不建议对现有设计模式魔改、强行为套用而套用、套用不符合分类的 Pattern (e.g. 用责任练模式来产生物件)，会失去使用的意义更可能造成后续接手的人的误会。</em></strong></p></blockquote><h4 id="本篇会提到的-design-patterns"><span class="me-2">本篇会提到的 Design Patterns：</span><a href="#本篇会提到的-design-patterns" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><a href="https://refactoring.guru/design-patterns/singleton" target="_blank">Singleton Pattern</a></p><li><p><a href="https://refactoring.guru/design-patterns/flyweight" target="_blank">Flywieght Pattern</a></p><li><p><a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a></p><li><p><a href="https://refactoring.guru/design-patterns/command" target="_blank">Command Pattern</a></p><li><p><a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank">Finite-State Machine</a> + <a href="https://refactoring.guru/design-patterns/state" target="_blank">State Pattern</a></p><li><p><a href="https://refactoring.guru/design-patterns/chain-of-responsibility" target="_blank">Chain Of Resposibility</a></p><li><p><a href="https://refactoring.guru/design-patterns/builder" target="_blank">Builder Pattern</a></p></ul><p>会逐一在后面解释什么场境用了、为何要用。</p><blockquote><p><em>本文著重在 Design Pattern 的应用，而非 Socket.IO 的操作，部分示例会因为描述方便而有所删减， <strong>无法适用真实的 Socket.IO 封装</strong> 。</em></p></blockquote><blockquote><p><em>因篇幅有限，本文不会详细介绍每个设计模式的架构，请先点各个模式的连结进入了解该模式的架构后再继续阅读。</em></p></blockquote><blockquote><p><em>Demo Code 会使用 Swift 撰写。</em></p></blockquote><h3 id="需求场景-1"><span class="me-2">需求场景 1.</span><a href="#需求场景-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what"><span class="me-2">What?</span><a href="#what" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>使用相同的 Path 在不同页面、Object 请求 Connection 时能复用取得相同的物件。</p><li><p>Connection 需为抽象介面，不直接依赖 Socket.IO Object</p></ul><h4 id="why"><span class="me-2">Why?</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>减少记忆体开销及重复连线的时间、流量成本。</p><li><p>为未来抽换成其他框架预留空间</p></ul><h4 id="how"><span class="me-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><a href="https://refactoring.guru/design-patterns/singleton" target="_blank">Singleton Pattern</a> ：创建型 Pattern，保证一个物件只会有一个实体。</p><li><p><a href="https://refactoring.guru/design-patterns/flyweight" target="_blank">Flywieght Pattern</a> ：结构型 Pattern，基于共享多个物件相同的状态，重复使用。</p><li><p><a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a> ：创建型 Pattern，抽象物件产生方法，使其能在外部抽换。</p></ul><p><strong>实际案例使用：</strong></p><p><a href="/assets/78507a8de6a5/1*flQa_EfErGBwbmEwpI7ZgQ.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*flQa_EfErGBwbmEwpI7ZgQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NDAiIGhlaWdodD0iNzA3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p><strong>Singleton Pattern：</strong> <code class="language-plaintext highlighter-rouge">ConnectionManager</code> 在 App Lifecycle 中仅存在一个的物件，用来管理 <code class="language-plaintext highlighter-rouge">Connection</code> 取用操作。</p><li><p><strong>Flywieght Pattern：</strong> <code class="language-plaintext highlighter-rouge">ConnectionPool</code> 顾名思义就是 Connection 的共用池子，统一从这个池子的方法拿出 Connection，其中逻辑就会包含当发现 URL Path 一样时直接给予已经在池子里的 Connection。 <code class="language-plaintext highlighter-rouge">ConnectionHandler</code> 则做为 <code class="language-plaintext highlighter-rouge">Connection</code> 的外在操作、状态管理器。</p><li><p><strong>Factory Pattern：</strong> <code class="language-plaintext highlighter-rouge">ConnectionFactory</code> 搭配上面 Flywieght Pattern 当发现池子没有可复用的 <code class="language-plaintext highlighter-rouge">Connection</code> 时则用此工厂介面去产生。</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Combine</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionPool</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">connections</span><span class="p">:</span> <span class="p">[</span><span class="kt">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connectionFactory</span> <span class="o">=</span> <span class="n">connectionFactory</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">getOrCreateConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">url</span> <span class="p">})</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">connection</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">connections</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">connection</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionHandler</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">getConnectionUUID</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">UUID</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">id</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ConnectionManager</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">ConnectionManager</span><span class="p">(</span><span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span><span class="p">(</span><span class="nv">connectionFactory</span><span class="p">:</span> <span class="kt">SIOConnectionFactory</span><span class="p">()))</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span>
    <span class="kd">private</span> <span class="nf">init</span><span class="p">(</span><span class="nv">connectionPool</span><span class="p">:</span> <span class="kt">ConnectionPool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connectionPool</span> <span class="o">=</span> <span class="n">connectionPool</span>
    <span class="p">}</span>
    
    <span class="c1">//</span>
    <span class="kd">func</span> <span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ConnectionHandler</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="n">connectionPool</span><span class="o">.</span><span class="nf">getOrCreateConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">ConnectionHandler</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="n">connection</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionFactory</span><span class="p">:</span> <span class="kt">ConnectionFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//</span>

<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="kt">ConnectionManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">requestConnectionHandler</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/2"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">getConnectionUUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">)</span>

<span class="c1">// output:</span>
<span class="c1">// D99F5429-1C6D-4EB5-A56E-9373D6F37307</span>
<span class="c1">// D99F5429-1C6D-4EB5-A56E-9373D6F37307</span>
<span class="c1">// 599CF16F-3D7C-49CF-817B-5A57C119FE31</span>
</pre></table></code></div></div><h3 id="需求场景-2"><span class="me-2">需求场景 2.</span><a href="#需求场景-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-1"><span class="me-2">What?</span><a href="#what-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>如背景技术细节所述，Socket.IO Swift Client 的 <code class="language-plaintext highlighter-rouge">Send Event</code> 并不支援离线发送 (但 Web/Android 版的 Library 却可以)，因此 iOS 端需要自行实现此功能。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>神奇的是 Socket.IO Swift Client - onEvent 是支援离线订阅的。
</pre></table></code></div></div><h4 id="why-1"><span class="me-2">Why?</span><a href="#why-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>跨平台功能统一</p><li><p>程式码容易理解</p></ul><h4 id="how-1"><span class="me-2">How?</span><a href="#how-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/command" target="_blank">Command Pattern</a> ：行为型 Pattern，将操作包装成对象，提供队列、延迟、取消…等等集合操作。</ul><p><a href="/assets/78507a8de6a5/1*O9zc28nMx64HDiDy4aiexA.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*O9zc28nMx64HDiDy4aiexA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4ODkiIGhlaWdodD0iMzQ0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><strong>Command Pattern：</strong> <code class="language-plaintext highlighter-rouge">SIOManager</code> 为与 Socket.IO 沟通的最底层封装，其中的 <code class="language-plaintext highlighter-rouge">send</code> 、 <code class="language-plaintext highlighter-rouge">request</code> 方法都是对 Socket.IO Send Event 的操作，当发现当前 Socket.IO 处于断线状态，则将请求参数放到 <code class="language-plaintext highlighter-rouge">bufferedCommands</code> 中，当连上之后就逐一拿出来处理 (First In First Out)。</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">SendBufferedCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">sioManager</span><span class="p">?</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RequestBufferedCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">sioManager</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">SIOManagerSpec</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span> <span class="p">{</span>
        
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="p">{</span>
                <span class="nf">executeBufferedCommands</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">bufferedCommands</span><span class="p">:</span> <span class="p">[</span><span class="kt">BufferedCommand</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">SendBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"Send:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">RequestBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"request:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connectionCommand</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">executeBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// First in, first out</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">connectionCommand</span> <span class="k">in</span>
            <span class="n">connectionCommand</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">removeAllBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">manager</span> <span class="o">=</span> <span class="kt">SIOManager</span><span class="p">()</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_1"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_2"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"request_event_1"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="c1">//</span>
<span class="p">}</span>
<span class="n">manager</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
</pre></table></code></div></div><p>同理也可以实现到 <code class="language-plaintext highlighter-rouge">onEvent</code> 上。</p><p>延伸：可以再套用 <a href="https://refactoring.guru/design-patterns/proxy" target="_blank">Proxy Pattern</a> ，将 Buffer 功能视为一种 Proxy。</p><h3 id="需求场景-3"><span class="me-2">需求场景 3.</span><a href="#需求场景-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-2"><span class="me-2">What?</span><a href="#what-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Connection 有多个状态，有序的状态与状态间切换、各状态允许不同的操作。</p><p><a href="/assets/78507a8de6a5/1*DBl6K1cPQc_cHOYXZ1VQ8A.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*DBl6K1cPQc_cHOYXZ1VQ8A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OTMiIGhlaWdodD0iMzE0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/78507a8de6a5/1*-Xk_TT6SMW5Jxd-c8iSCcw.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*-Xk_TT6SMW5Jxd-c8iSCcw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MTAiIGhlaWdodD0iMTMyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p>Created：物件被建立，允许 -&gt; <code class="language-plaintext highlighter-rouge">Connected</code> 或直接进 <code class="language-plaintext highlighter-rouge">Disconnected</code></p><li><p>Connected：已连上 Socket.IO，允许 -&gt; <code class="language-plaintext highlighter-rouge">Disconnected</code></p><li><p>Disconnected：已与 Socket.IO 断线，允许 -&gt; <code class="language-plaintext highlighter-rouge">Reconnectiong</code> 、 <code class="language-plaintext highlighter-rouge">Released</code></p><li><p>Reconnectiong：正在尝试重新连上 Socket.IO，允许 -&gt; <code class="language-plaintext highlighter-rouge">Connected</code> 、 <code class="language-plaintext highlighter-rouge">Disconnected</code></p><li><p>Released：物件已被标示为等待被记忆体回收，不允许任何操作及切换状态</p></ul><h4 id="why-2"><span class="me-2">Why?</span><a href="#why-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>状态与状态的切换逻辑跟表述不容易</p><li><p>各状态要限制操作方法(e.g. State = Released 时无法 Call Send Event)，直接使用 if. .else 会让程式难以维护阅读</p></ul><h4 id="how-2"><span class="me-2">How?</span><a href="#how-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><a href="https://en.wikipedia.org/wiki/Finite-state_machine" target="_blank">Finite State Machine</a> ：管理状态间的切换</p><li><p><a href="https://refactoring.guru/design-patterns/state" target="_blank">State Pattern</a> ：行为型 Pattern，对象的状态有变化时，有不同的相应处理</p></ul><p><a href="/assets/78507a8de6a5/1*NgehABZTiXL_fFEYQh63Hg.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*NgehABZTiXL_fFEYQh63Hg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjYyMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p><strong>Finite State Machine</strong> ： <code class="language-plaintext highlighter-rouge">SIOConnectionStateMachine</code> 为状态机实作， <code class="language-plaintext highlighter-rouge">currentSIOConnectionState</code> 为当前状态， <code class="language-plaintext highlighter-rouge">created、connected、disconnected、reconnecting、released</code> 表列出此状态机可能的切换状态。 <code class="language-plaintext highlighter-rouge">enterXXXState() throws</code> 为从 Current State 进入某个状态时的允许与不允许(throw error)实作。</p><li><p><strong>State Pattern</strong> ： <code class="language-plaintext highlighter-rouge">SIOConnectionState</code> 为所有状态会用到的操作方法介面抽象。</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">SIOManagerSpec</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span> <span class="p">{</span>
        
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="p">{</span>
                <span class="nf">executeBufferedCommands</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">bufferedCommands</span><span class="p">:</span> <span class="p">[</span><span class="kt">BufferedCommand</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">SendBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"Send:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">RequestBufferedCommand</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span> <span class="nv">sioManager</span><span class="p">:</span> <span class="k">self</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">print</span><span class="p">(</span><span class="s">"request:</span><span class="se">\(</span><span class="n">event</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendBufferedCommands</span><span class="p">(</span><span class="nv">connectionCommand</span><span class="p">:</span> <span class="kt">BufferedCommand</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">connectionCommand</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">executeBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// First in, first out</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">connectionCommand</span> <span class="k">in</span>
            <span class="n">connectionCommand</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">removeAllBufferedCommands</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bufferedCommands</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">manager</span> <span class="o">=</span> <span class="kt">SIOManager</span><span class="p">()</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_1"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="s">"send_event_2"</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="s">"request_event_1"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
    <span class="c1">//</span>
<span class="p">}</span>
<span class="n">manager</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">SIOConnectionStateMachine</span> <span class="p">{</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">currentSIOConnectionState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">created</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">connected</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">disconnected</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">reconnecting</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">released</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="o">!</span>
    
    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="kt">SIOConnectionCreatedState</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kt">SIOConnectionConnectedState</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">disconnected</span> <span class="o">=</span> <span class="kt">SIOConnectionDisconnectedState</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">reconnecting</span> <span class="o">=</span> <span class="kt">SIOConnectionReconnectingState</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">released</span> <span class="o">=</span> <span class="kt">SIOConnectionReleasedState</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">currentSIOConnectionState</span> <span class="o">=</span> <span class="n">created</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">enterConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">created</span><span class="o">.</span><span class="n">connectionState</span><span class="p">,</span> <span class="n">reconnecting</span><span class="o">.</span><span class="n">connectionState</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">enter</span><span class="p">(</span><span class="n">connected</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="se">)</span><span class="s"> can't enter to Connected"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">enterDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">created</span><span class="o">.</span><span class="n">connectionState</span><span class="p">,</span> <span class="n">connected</span><span class="o">.</span><span class="n">connectionState</span><span class="p">,</span> <span class="n">reconnecting</span><span class="o">.</span><span class="n">connectionState</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">enter</span><span class="p">(</span><span class="n">disconnected</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="se">)</span><span class="s"> can't enter to Disconnected"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enterReconnecting</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">disconnected</span><span class="o">.</span><span class="n">connectionState</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">enter</span><span class="p">(</span><span class="n">reconnecting</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="se">)</span><span class="s"> can't enter to Reconnecting"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enterReleased</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">disconnected</span><span class="o">.</span><span class="n">connectionState</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">enter</span><span class="p">(</span><span class="n">released</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="n">connectionState</span><span class="se">)</span><span class="s"> can't enter to Released"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">enter</span><span class="p">(</span><span class="n">_</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">SIOConnectionState</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentSIOConnectionState</span> <span class="o">=</span> <span class="n">state</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kd">protocol</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span>

    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span>
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span>
    
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span>
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">String</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">localizedDescription</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">message</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionCreatedState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">created</span>
    <span class="k">let</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">stateMachine</span> <span class="o">=</span> <span class="n">stateMachine</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterConnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterDisconnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ConnectedState can't release!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"CreatedState can't disconnect!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionConnectedState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">connected</span>
    <span class="k">let</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">stateMachine</span> <span class="o">=</span> <span class="n">stateMachine</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterDisconnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ConnectedState can't release!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ConnectedState can't connect!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionDisconnectedState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">disconnected</span>
    <span class="k">let</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">stateMachine</span> <span class="o">=</span> <span class="n">stateMachine</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterConnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterReleased</span><span class="p">()</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterReconnecting</span><span class="p">()</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionReconnectingState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">reconnecting</span>
    <span class="k">let</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">stateMachine</span> <span class="o">=</span> <span class="n">stateMachine</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterConnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="nf">enterDisconnected</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReconnectState can't release!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReconnectState can't connect!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="c1">// allow</span>
        <span class="c1">// can use Helper to reduce the repeating code</span>
        <span class="c1">// e.g. helper.XXX(socketManager: SIOManagerSpec, ....)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionReleasedState</span><span class="p">:</span> <span class="kt">SIOConnectionState</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">released</span>
    <span class="k">let</span> <span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">stateMachine</span><span class="p">:</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">stateMachine</span> <span class="o">=</span> <span class="n">stateMachine</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">onConnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't onConnected!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onDisconnected</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't onDisconnected!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't release!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't request!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Data</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't receiveOn!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't send!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't connect!"</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="kt">SIOManagerSpec</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">SIOConnectionStateMachineError</span><span class="p">(</span><span class="s">"ReleasedState can't disconnect!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">do</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">stateMachine</span> <span class="o">=</span> <span class="kt">SIOConnectionStateMachine</span><span class="p">()</span>
    <span class="c1">// mock on socket.io connect:</span>
    <span class="c1">// socketIO.on(connect){</span>
    <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="nf">onConnected</span><span class="p">()</span>
    <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="n">manager</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="s">"test"</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="nf">release</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="n">manager</span><span class="p">)</span>
    <span class="k">try</span> <span class="n">stateMachine</span><span class="o">.</span><span class="n">currentSIOConnectionState</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="nv">socketManager</span><span class="p">:</span> <span class="n">manager</span><span class="p">,</span> <span class="nv">event</span><span class="p">:</span> <span class="s">"test"</span><span class="p">)</span>
    <span class="c1">// }</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// output:</span>
<span class="c1">// error: SIOConnectionStateMachineError(message: "ConnectedState can\'t release!")</span>
</pre></table></code></div></div><h3 id="需求场景-3-1"><span class="me-2">需求场景 3.</span><a href="#需求场景-3-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-3"><span class="me-2">What?</span><a href="#what-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>结合场景 1. 2.，有了 <code class="language-plaintext highlighter-rouge">ConnectionPool</code> 享元池子加上 State Pattern 状态管理后；我们继续往下延伸，如背景目标所述，Feature 端不需去管背后 Connection 的连线机制；因此我们建立了一个轮询器 (命名为 <code class="language-plaintext highlighter-rouge">ConnectionKeeper</code> ) 会定时扫描 <code class="language-plaintext highlighter-rouge">ConnectionPool</code> 中强持有的 <code class="language-plaintext highlighter-rouge">Connection</code> ，并在发生以下状况时做操作：</p><ul><li><p><code class="language-plaintext highlighter-rouge">Connection</code> 有人在使用且状态非 <code class="language-plaintext highlighter-rouge">Connected</code> ：将状态改为 <code class="language-plaintext highlighter-rouge">Reconnecting</code> 并尝试重新连线</p><li><p><code class="language-plaintext highlighter-rouge">Connection</code> 已无人使用且状态为 <code class="language-plaintext highlighter-rouge">Connected</code> ：将状态改为 <code class="language-plaintext highlighter-rouge">Disconnected</code></p><li><p><code class="language-plaintext highlighter-rouge">Connection</code> 已无人使用且状态为 <code class="language-plaintext highlighter-rouge">Disconnected</code> ：将状态改为 <code class="language-plaintext highlighter-rouge">Released</code> 并从 <code class="language-plaintext highlighter-rouge">ConnectionPool</code> 中移除</p></ul><h4 id="why-3"><span class="me-2">Why?</span><a href="#why-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>三个操作有上下关系且互斥 (disconnected -&gt; released or reconnecting)</p><li><p>可弹性抽换、增加状况操作</p><li><p>未封装的话只能将三个判断及操作直接写在方法中 (难以测试其中逻辑)</p><li><p>e.g:</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="o">!</span><span class="n">connection</span><span class="o">.</span><span class="nf">isOccupie</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">connection</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">disconnected</span><span class="p">()</span>
<span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">connection</span><span class="o">.</span><span class="nf">isOccupie</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">released</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">release</span><span class="p">()</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="nf">isOccupie</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">state</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="n">then</span>
<span class="o">...</span> <span class="n">connection</span><span class="o">.</span><span class="nf">reconnecting</span><span class="p">()</span>
<span class="n">end</span>
</pre></table></code></div></div><h4 id="how-3"><span class="me-2">How?</span><a href="#how-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/chain-of-responsibility" target="_blank">Chain Of Resposibility</a> ：行为型 Pattern，顾名思义是一条链，每个节点都有相应的操作，输入资料后节点可决定是否要操作还是丢给下一个节点处理，另一个现实应用是 <a href="https://swiftrocks.com/understanding-the-ios-responder-chain" target="_blank">iOS Responder Chain</a> 。</ul><blockquote><p><em>照定义 Chain of responsibility Pattern 是不允许某个节点已经接下处理资料，但处理完又丢给下一个节点继续处理， <strong>要做就做完，不然不要做</strong> 。</em></p></blockquote><blockquote><p><em>如果是上述场景比较适合的应该是 <a href="https://stackoverflow.com/questions/7951306/chain-of-responsibility-vs-interceptor" target="_blank">Interceptor Pattern</a> 。</em></p></blockquote><p><a href="/assets/78507a8de6a5/1*e8jHpykN1m3Y66Ukf-5OJA.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*e8jHpykN1m3Y66Ukf-5OJA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjM5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><strong>Chain of responsibility：</strong> <code class="language-plaintext highlighter-rouge">ConnectionKeeperHandler</code> 为炼的节点抽象，特别抽出 <code class="language-plaintext highlighter-rouge">canExcute</code> 方法避免发生上述 这个节点接下来处理了，但做完又想呼叫后面的节点继续执行的状况、 <code class="language-plaintext highlighter-rouge">handle</code> 为炼的节点串连、 <code class="language-plaintext highlighter-rouge">excute</code> 为要处理的话会怎么处理的逻辑。 <code class="language-plaintext highlighter-rouge">ConnectionKeeperHandlerContext</code> 用来存放会用到的资料， <code class="language-plaintext highlighter-rouge">isOccupie</code> 代表 Connection 有无人在使用。</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">created</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">struct</span> <span class="kt">ConnectionKeeperHandlerContext</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connection</span><span class="p">:</span> <span class="kt">Connection</span>
    <span class="k">let</span> <span class="nv">isOccupie</span><span class="p">:</span> <span class="kt">Bool</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">canExcute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nf">canExcute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">nextHandler</span><span class="p">?</span><span class="o">.</span><span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">DisconnectedConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExcute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="n">isOccupie</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ReconnectConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">reconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExcute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">.</span><span class="n">isOccupie</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ReleasedConnectionKeeperHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">nextHandler</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandler</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="nf">disconnect</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">canExcute</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connectionState</span> <span class="o">==</span> <span class="o">.</span><span class="n">disconnected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="n">isOccupie</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">connection</span> <span class="o">=</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">disconnectedHandler</span> <span class="o">=</span> <span class="kt">DisconnectedConnectionKeeperHandler</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">reconnectHandler</span> <span class="o">=</span> <span class="kt">ReconnectConnectionKeeperHandler</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">releasedHandler</span> <span class="o">=</span> <span class="kt">ReleasedConnectionKeeperHandler</span><span class="p">()</span>
<span class="n">disconnectedHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">reconnectHandler</span>
<span class="n">reconnectHandler</span><span class="o">.</span><span class="n">nextHandler</span> <span class="o">=</span> <span class="n">releasedHandler</span>

<span class="n">disconnectedHandler</span><span class="o">.</span><span class="nf">handle</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="kt">ConnectionKeeperHandlerContext</span><span class="p">(</span><span class="nv">connection</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="nv">isOccupie</span><span class="p">:</span> <span class="kc">false</span><span class="p">))</span>
</pre></table></code></div></div><h3 id="需求场景-4"><span class="me-2">需求场景 4.</span><a href="#需求场景-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="what-4"><span class="me-2">What?</span><a href="#what-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我们封装出的 <code class="language-plaintext highlighter-rouge">Connection</code> 需要经过 setup 后才能使用，例如给予 URL Path、设定 Config…等等</p><h4 id="why-4"><span class="me-2">Why?</span><a href="#why-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>可以弹性的增减构建开口</p><li><p>可复用构建逻辑</p><li><p>未封装的话，外部可以不照预期操作类别</p><li><p>e.g.:</p></ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❌
let connection = Connection()
connection.send(event) // unexpected method call, should call .connect() first
✅
let connection = Connection()
connection.connect()
connection.send(event)
// but...who knows???
</pre></table></code></div></div><h4 id="how-4"><span class="me-2">How?</span><a href="#how-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://refactoring.guru/design-patterns/builder" target="_blank">Builder Pattern</a> ：创建型 Pattern，能够分步骤构建对象及复用构建方法。</ul><p><a href="/assets/78507a8de6a5/1*J5eKaks1-fT6u8FojeUkUQ.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*J5eKaks1-fT6u8FojeUkUQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjE0IiBoZWlnaHQ9IjQ3OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><strong>Builder Pattern：</strong> <code class="language-plaintext highlighter-rouge">SIOConnectionBuilder</code> 为 <code class="language-plaintext highlighter-rouge">Connection</code> 的构建器，负责设定、存放构建 <code class="language-plaintext highlighter-rouge">Connection</code> 时会用到的资料； <code class="language-plaintext highlighter-rouge">ConnectionConfiguration</code> 抽象介面用来保证要使用 <code class="language-plaintext highlighter-rouge">Connection</code> 前必须呼叫 <code class="language-plaintext highlighter-rouge">.connect()</code> 才能拿到 <code class="language-plaintext highlighter-rouge">Connection</code> 实体。</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">ConnectionState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">created</span>
    <span class="k">case</span> <span class="n">connected</span>
    <span class="k">case</span> <span class="n">disconnected</span>
    <span class="k">case</span> <span class="n">reconnecting</span>
    <span class="k">case</span> <span class="n">released</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    <span class="k">var</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="p">{</span><span class="k">get</span><span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// Socket.IO Implementation</span>
<span class="kd">class</span> <span class="kt">SIOConnection</span><span class="p">:</span> <span class="kt">Connection</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">connectionState</span><span class="p">:</span> <span class="kt">ConnectionState</span> <span class="o">=</span> <span class="o">.</span><span class="n">created</span>
    <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">sendEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">onEvent</span><span class="p">(</span><span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">//</span>
        <span class="k">return</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Data</span><span class="p">?,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="kd">class</span> <span class="kt">SIOConnectionClient</span><span class="p">:</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Connection</span> <span class="p">{</span>
        <span class="c1">// set config</span>
        <span class="k">return</span> <span class="kt">SIOConnection</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Connection</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">SIOConnectionBuilder</span> <span class="p">{</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    
    <span class="kd">func</span> <span class="nf">setConfig</span><span class="p">(</span><span class="n">_</span> <span class="nv">config</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">SIOConnectionBuilder</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">// url is required parameter</span>
    <span class="kd">func</span> <span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ConnectionConfiguration</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">SIOConnectionClient</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">config</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">builder</span> <span class="o">=</span> <span class="kt">SIOConnectionBuilder</span><span class="p">()</span><span class="o">.</span><span class="nf">setConfig</span><span class="p">([</span><span class="s">"test"</span><span class="p">:</span><span class="mi">123</span><span class="p">])</span>


<span class="k">let</span> <span class="nv">connection1</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">connect</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">connection2</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">build</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"wss://pinkoi.com/1"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span><span class="o">.</span><span class="nf">connect</span><span class="p">()</span>
</pre></table></code></div></div><p>延伸：这里也可以再套用 <a href="https://refactoring.guru/design-patterns/factory-method" target="_blank">Factory Pattern</a> ，将用工厂产出 <code class="language-plaintext highlighter-rouge">SIOConnection</code> 。</p><h3 id="完结"><span class="me-2">完结!</span><a href="#完结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>以上就是本次封装 Socket.IO 中遇到的四个场景及七个使用到解决问题的 Design Patterns。</p><h4 id="最后附上此次封装-socketio-的完整设计蓝图"><span class="me-2">最后附上此次封装 Socket.IO 的完整设计蓝图</span><a href="#最后附上此次封装-socketio-的完整设计蓝图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*DMfFpmF7aVCIIM1dskn97w.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*DMfFpmF7aVCIIM1dskn97w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU0NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>与文中命名、示范略为不同，这张图才是真实的设计架构；有机会再请原设计者分享设计理念及开源。</p><h3 id="who"><span class="me-2">Who?</span><a href="#who" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>谁做了这些设计跟负责 Socket.IO 封装专案呢？</p><h4 id="sean-zheng--android-engineer--pinkoi"><span class="me-2"><a href="https://www.linkedin.com/in/%E5%AE%87%E7%BF%94-%E9%84%AD-9b3409175/" target="_blank">Sean Zheng</a> , Android Engineer @ Pinkoi</span><a href="#sean-zheng--android-engineer--pinkoi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*Q_35023LtcZbOtnfvSxv-A.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*Q_35023LtcZbOtnfvSxv-A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>主要架构设计者、Design Pattern 评估套用、在 Android 端使用 Kotlin 实现设计。</p><h4 id="zhgchgli--enginner-leadios-enginner--pinkoi"><span class="me-2"><a href="https://www.linkedin.com/in/zhgchgli/" target="_blank">ZhgChgLi</a> , Enginner Lead/iOS Enginner @ Pinkoi</span><a href="#zhgchgli--enginner-leadios-enginner--pinkoi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/78507a8de6a5/1*1NCE3Q7fO5Mh15NT2xoYlA.webp" class="popup img-link blur"><img data-src="/assets/78507a8de6a5/1*1NCE3Q7fO5Mh15NT2xoYlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Platform Team 专案负责人、Pair programming、在 iOS 端使用 Swift 实现设计、讨论并提出质疑(a.k.a. 出一张嘴)及最后撰写本文与大家分享。</p><h3 id="延伸阅读"><span class="me-2">延伸阅读</span><a href="#延伸阅读" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p>Design Patterns 的实战应用纪录 — In WKWebView with Builder, Strategy &amp; Chain of Responsibility Pattern</p><li><p><a href="/posts/zrealm-dev/zh-cn/visitor-pattern-%E5%9C%A8-ios-swift-%E5%88%86%E4%BA%AB%E5%8A%9F%E8%83%BD%E5%BA%94%E7%94%A8-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E5%8A%A1%E8%A7%A3%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E6%9E%B6%E6%9E%84%E4%BC%98%E5%8C%96-ba5773a7bfea/">Visitor Pattern in Swift (Share Object to XXX Example)</a></p><li><p><a href="/posts/zrealm-dev/zh-cn/visitor-pattern-%E6%8F%90%E5%8D%87-tableview-%E5%8F%AF%E6%89%A9%E5%85%85%E6%80%A7%E4%B8%8E%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%80%A7%E8%AE%BE%E8%AE%A1%E8%8C%83%E4%BE%8B-60473cb47550/">Visitor Pattern in TableView</a></p></ul><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/78507a8de6a5" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2022-04-07-78507a8de6a5.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/pinkoi-engineering/">Pinkoi Engineering</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/design-patterns/" class="post-tag no-text-decoration" >design-patterns</a> <a href="/tags/socketio/" class="post-tag no-text-decoration" >socketio</a> <a href="/tags/websocket/" class="post-tag no-text-decoration" >websocket</a> <a href="/tags/finite-state-machine/" class="post-tag no-text-decoration" >finite-state-machine</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Design%20Patterns%20%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%EF%BD%9C%E5%B0%81%E8%A3%85%20Socket.IO%20%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fpinkoi-engineering%2Fzh-cn%2Fdesign-patterns-%25E5%25AE%259E%25E6%2588%2598%25E5%25BA%2594%25E7%2594%25A8-%25E5%25B0%2581%25E8%25A3%2585-socket-io-%25E5%258D%25B3%25E6%2597%25B6%25E9%2580%259A%25E8%25AE%25AF%25E6%259E%25B6%25E6%259E%2584%25E4%25B8%258E%25E4%25B8%2583%25E5%25A4%25A7%25E8%25AE%25BE%25E8%25AE%25A1%25E6%25A8%25A1%25E5%25BC%258F%25E8%25A7%25A3%25E6%259E%2590-78507a8de6a5%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Design%20Patterns%20%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%EF%BD%9C%E5%B0%81%E8%A3%85%20Socket.IO%20%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fpinkoi-engineering%2Fzh-cn%2Fdesign-patterns-%25E5%25AE%259E%25E6%2588%2598%25E5%25BA%2594%25E7%2594%25A8-%25E5%25B0%2581%25E8%25A3%2585-socket-io-%25E5%258D%25B3%25E6%2597%25B6%25E9%2580%259A%25E8%25AE%25AF%25E6%259E%25B6%25E6%259E%2584%25E4%25B8%258E%25E4%25B8%2583%25E5%25A4%25A7%25E8%25AE%25BE%25E8%25AE%25A1%25E6%25A8%25A1%25E5%25BC%258F%25E8%25A7%25A3%25E6%259E%2590-78507a8de6a5%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fpinkoi-engineering%2Fzh-cn%2Fdesign-patterns-%25E5%25AE%259E%25E6%2588%2598%25E5%25BA%2594%25E7%2594%25A8-%25E5%25B0%2581%25E8%25A3%2585-socket-io-%25E5%258D%25B3%25E6%2597%25B6%25E9%2580%259A%25E8%25AE%25AF%25E6%259E%25B6%25E6%259E%2584%25E4%25B8%258E%25E4%25B8%2583%25E5%25A4%25A7%25E8%25AE%25BE%25E8%25AE%25A1%25E6%25A8%25A1%25E5%25BC%258F%25E8%25A7%25A3%25E6%259E%2590-78507a8de6a5%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/en/ios-shortcut-automation-auto-forward-sms-create-reminder-tasks-effortlessly-309d0302877b/">iOS Shortcut Automation｜Auto-Forward SMS & Create Reminder Tasks Effortlessly</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/ios-%E6%8D%B7%E5%BE%84%E8%87%AA%E5%8A%A8%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%AE%80%E8%AE%AF%E4%B8%8E%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E6%95%99%E5%AD%A6-309d0302877b/">iOS 捷径自动化应用场景 — 自动转发简讯与自动建立提醒待办事项</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/ios-%E6%8D%B7%E5%BE%91%E8%87%AA%E5%8B%95%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8B%95%E8%BD%89%E7%99%BC%E7%B0%A1%E8%A8%8A%E8%88%87%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E8%BE%A6%E4%BA%8B%E9%A0%85%E6%95%99%E5%AD%B8-309d0302877b/">iOS 捷徑自動化應用場景 — 自動轉發簡訊與自動建立提醒待辦事項</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxing｜Premium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/apple-watch-%E7%B1%B3%E5%85%B0%E8%A1%A8%E5%B8%A6%E5%BC%80%E7%AE%B1-%E5%8E%9F%E5%8E%82%E4%B8%8D%E9%94%88%E9%92%A2%E7%9F%B3%E5%A2%A8%E8%89%B2%E4%BC%98%E7%BC%BA%E7%82%B9%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原厂不锈钢米兰表带开箱</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1649342957" data-df="ll" > Apr 7, 2022 </time><h4 class="pt-0 my-2">Design Patterns 的實戰應用紀錄</h4><div class="text-muted"><p>封裝 Socket.IO Client Library 需求時遇到的問題場景及解決方法應用到的 Design Patterns</p></div></div></a></article><article class="col"> <a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1649342957" data-df="ll" > Apr 7, 2022 </time><h4 class="pt-0 my-2">Design Patterns｜Practical Solutions for Socket.IO Client Library Challenges</h4><div class="text-muted"><p>Developers facing Socket.IO Client Library issues can apply proven Design Patterns to encapsulate functionality effectively, resolving integration challenges and improving code maintainability in r...</p></div></div></a></article><article class="col"> <a href="/posts/kkday-tech-blog/zh-cn/wkwebview-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98-builder-strategy-%E4%B8%8E%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%9C%80%E4%BD%B3%E5%BA%94%E7%94%A8%E6%8A%80%E5%B7%A7-f4b02ee342a4/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1725601667" data-df="ll" > Sep 6, 2024 </time><h4 class="pt-0 my-2">Design Patterns 的实战应用纪录—In WKWebView with Builder, Strategy & Chain of Responsibility Pattern</h4><div class="text-muted"><p>封装 iOS WKWebView 时使用到的 Design Patterns 场景 (策略、责任链、建造模式)。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/" class="btn btn-outline-primary" aria-label="Older" ><p>Design Patterns｜Practical Solutions for Socket.IO Client Library Challenges</p></a> <a href="/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/" class="btn btn-outline-primary" aria-label="Newer" ><p>Design Patterns 的實戰應用紀錄</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
