<!doctype html><html lang="zh-tw" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="zh_tw" /><meta name="description" content="針對 iOS AVPlayer 播放 HLS m3u8 串流時無法攔截快取的痛點，深入分析多種快取方案，從 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技術瓶頸與可行解法，助你優化串流體驗並有效節省伺服器與流量成本。" /><meta property="og:description" content="針對 iOS AVPlayer 播放 HLS m3u8 串流時無法攔截快取的痛點，深入分析多種快取方案，從 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技術瓶頸與可行解法，助你優化串流體驗並有效節省伺服器與流量成本。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-09T01:12:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" /><meta property="twitter:title" content="iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T16:09:26+08:00","datePublished":"2020-04-09T01:12:17+08:00","description":"針對 iOS AVPlayer 播放 HLS m3u8 串流時無法攔截快取的痛點，深入分析多種快取方案，從 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技術瓶頸與可行解法，助你優化串流體驗並有效節省伺服器與流量成本。","headline":"iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"},"url":"https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"}</script><title>iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/zh.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="https://en.zhgchg.li/posts/zrealm-dev/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/"><link rel="alternate" hreflang="ja" href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/ios-hls-cache-avplayer%E3%81%A7m3u8%E3%82%92%E5%86%8D%E7%94%9F%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-d796bf8e661e/"><link rel="alternate" hreflang="zh-Hans" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/"><link rel="alternate" hreflang="zh-Hant" href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"><link rel="alternate" hreflang="x-default" href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"如何在 iOS 使用 AVPlayer 播放 HLS 串流時實現邊播邊快取功能？","acceptedAnswer":{"@type":"Answer","text":"AVPlayer 本身無法攔截 .ts 檔案的下載請求，因此無法直接使用 AVAssetResourceLoaderDelegate 或 URLProtocol 來實現邊播邊快取，最實用的方案是透過在 App 內建立本地 Reverse Proxy Server 攔截請求並快取，但此方案在 App 背景執行時會有被系統暫停的限制，需要額外機制保持連線。"}},{"@type":"Question","name":"為何 AVAssetResourceLoaderDelegate 無法攔截 HLS 串流中的 .ts 檔案下載？","acceptedAnswer":{"@type":"Answer","text":"AVAssetResourceLoaderDelegate 只支援攔截自訂 Scheme 的資源請求，但 HLS 的 .ts 檔案下載是由 AVFoundation 內部直接使用 HTTP/HTTPS 發起，無法透過 Delegate 攔截，導致無法在此階段實現快取功能。"}},{"@type":"Question","name":"使用 URLProtocol 攔截 AVPlayer HLS 請求為何無法成功快取？","acceptedAnswer":{"@type":"Answer","text":"AVPlayer 對 HLS 請求不走標準 URL Loading System，導致 URLProtocol 無法攔截真實的 .m3u8 與 .ts 請求，且嘗試改用自訂 Scheme 會遇到 CoreMediaErrorDomain 12881 錯誤，無法成功替代快取資料。"}},{"@type":"Question","name":"本地 Reverse Proxy Server 方案快取 HLS 串流有什麼限制？","acceptedAnswer":{"@type":"Answer","text":"雖然本地 HTTP Server 方案可攔截 .m3u8 和 .ts 請求並實現快取，但在 App 進入背景後，系統可能會暫停或中斷本地 Server 連線，必須透過持續發送請求等技巧保持 Server 運作，否則會影響播放體驗。"}},{"@type":"Question","name":"是否有其他可行方案實現 iOS HLS 串流快取？","acceptedAnswer":{"@type":"Answer","text":"除了本地 Reverse Proxy，其他方案如完整下載後再播放（離線播放）、自行實作播放器或轉檔成 mp3/mp4 都可行，但技術難度高且複雜，且 AVFoundation 內建的 HTTP Client Cache 對 HLS 不生效，故實務上多以本地 Proxy 搭配快取為主。"}}]} </script><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item" style="padding:0 15px 0 15px;"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background:#EDF4FF;color:#0A84FF;font-size:15px;transition:background-color .2s,color .2s;" onmouseover="this.style.backgroundColor='#0A84FF';this.style.color='#ffffff';" onmouseout="this.style.backgroundColor='#EDF4FF';this.style.color='#0A84FF';"> <i class="fa-brands fa-medium"></i> <span><span style="font-size: 18px; font-weight: boild;">Follow Me on Medium!</span><br/><u>1,050+</u> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首頁</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分類</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>標籤</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>歸檔</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>關於我</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>聯絡我</span> </a><li class="nav-item"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;"> <a href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #666;background:#111;color:#fff;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a></div><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;margin-top:5px;"> <a href="https://en.zhgchg.li/posts/zrealm-dev/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/ios-hls-cache-avplayer%E3%81%A7m3u8%E3%82%92%E5%86%8D%E7%94%9F%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首頁</a> </span> <span>iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜尋..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析</h1><p class="post-desc fw-light mb-4">針對 iOS AVPlayer 播放 HLS m3u8 串流時無法攔截快取的痛點，深入分析多種快取方案，從 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技術瓶頸與可行解法，助你優化串流體驗並有效節省伺服器與流量成本。</p><div class="post-meta text-muted"> <span> 發佈於 <time data-ts="1586365937" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2020 年 04 月 09 日 </time> </span> <span> 更新於 <time data-ts="1712995766" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024 年 04 月 13 日 </time> </span><div class="mt-3 mb-3"> <a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" class="popup img-link preview-img blur"><img data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> 作者 <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3004 字" > <em>16 分鐘</em>閱讀</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節目錄 🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:flex-end;"> <a href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #dc3545;background:#dc3545;color:#fff !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a> <a href="https://en.zhgchg.li/posts/zrealm-dev/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/ios-hls-cache-avplayer%E3%81%A7m3u8%E3%82%92%E5%86%8D%E7%94%9F%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AB%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95-d796bf8e661e/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div><blockquote class="prompt-info"><p>基於 SEO 考量，本文標題與描述經 AI 調整，原始版本請參考內文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目錄</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>iOS HLS Cache 實踐方法探究之旅 <a href="#ios-hls-cache-實踐方法探究之旅">#</a></summary><ul><li><a href="#20230312-update">[2023/03/12] Update</a></li></ul></details></li><li><a href="#關於">關於</a></li><li><a href="#目標">目標</a></li><li><a href="#問題">問題</a></li><li><a href="#20210105-更新">2021–01–05 更新</a></li><li class="has-children"><details><summary>實踐方案 <a href="#實踐方案">#</a></summary><ul><li><a href="#方案-1-avassetresourceloaderdelegate-">方案 1. AVAssetResourceLoaderDelegate ❌</a></li><li><a href="#方案-21-urlprotocol-攔截請求-">方案 2.1 URLProtocol 攔截請求 ❌</a></li><li><a href="#方案-22-暴力讓他能進-urlprotocol-">方案 2.2 暴力讓他能進 URLProtocol ❌</a></li><li><a href="#方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-來實現-">方案 2.2–2 同方案 2.2 但是搭配 方案 1 AVAssetResourceLoaderDelegate 來實現 ❌</a></li><li><a href="#方案-3-reverse-proxy-server--可行但非完美">方案 3. Reverse Proxy Server ⍻ (可行，但非完美)</a></li><li><a href="#方案-4-使用-http-client-本身的-caching-機制-">方案 4. 使用 HTTP Client 本身的 caching 機制 ❌</a></li><li><a href="#方案-5-不使用-avfoundation-avplayer-播放音訊檔-">方案 5. 不使用 AVFoundation AVPlayer 播放音訊檔 ✔</a></li><li><a href="#方案-51-不使用-hls">方案 5–1. 不使用 HLS</a></li><li><a href="#方案-6-將-ts-分割檔轉成-mp3mp4-檔案-">方案 6. 將 .ts 分割檔轉成 .mp3/.mp4 檔案 ✔</a></li><li><a href="#方案-7-下載完整檔案後再播放-">方案 7. 下載完整檔案後再播放 ⍻</a></li></ul></details></li><li class="has-children"><details><summary>結語 <a href="#結語">#</a></summary><ul><li><a href="#參考資料">參考資料</a></li></ul></details></li></ul></nav><hr /><h3 id="ios-hls-cache-實踐方法探究之旅"><span class="me-2">iOS HLS Cache 實踐方法探究之旅</span><a href="#ios-hls-cache-實踐方法探究之旅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>使用 AVPlayer 播放 m3u8 串流影音檔時如何做到邊播放邊 Cache 的功能</p><p><a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" alt="photo by [Mihis Alex](https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>photo by <a href="https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank">Mihis Alex</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>下篇「 <a href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/">AVPlayer 實踐本地 Cache 功能大全</a> 」教您實現 AVPlayer Caching</ul><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>我將之前的實作開源了，有需求的朋友可直接使用。</p><ul><li>客製化 Cache 策略，可以用 PINCache or 其他…<li>外部只需呼叫 make AVAsset 工廠，帶入 URL，則 AVAsset 就能支援 Caching<li>使用 Combine 實現 Data Flow 策略<li>寫了一些測試</ul><h3 id="關於"><span class="me-2">關於</span><a href="#關於" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>HTTP Live Streaming (簡稱HLS) 是蘋果提出基於HTTP的串流媒體網絡傳輸協議。</p><p>以播放音樂來說，非串流情況下我們使用 mp3 作為音樂檔，這個檔案有多大就要花多久時間全部下載下來才能播放；而 HLS 就是把一個檔案分割成多個小檔案，讀到哪播到哪，所以拿到第一個分割區塊就能開始播放，不用整個都下載完！</p><p><code class="language-plaintext highlighter-rouge">.m3u8</code> 檔就是紀錄這些分割的 <code class="language-plaintext highlighter-rouge">.ts</code> 小檔案的碼率、播放順序、時間 還有整個音訊的資訊，另外也可以做加解密保護、低延遲直播…等等</p><p><code class="language-plaintext highlighter-rouge">.m3u8</code> 檔範例(aviciiwakemeup.m3u8)：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>#EXTM3U
#EXT-X-VERSION:3
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:9.900411,
aviciiwakemeup–00001.ts
#EXTINF:9.900400,
aviciiwakemeup–00002.ts
#EXTINF:9.900411,
aviciiwakemeup–00003.ts
#EXTINF:9.900411,
.
.
.
#EXTINF:6.269389,
aviciiwakemeup-00028.ts
#EXT-X-ENDLIST
</pre></table></code></div></div><p><em>*EXT-X-ALLOW-CACHE 已在 <a href="https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag?language=objc" target="_blank">iOS≥ 8/Protocol Ver.7 deprecated</a> ，有沒有這行都沒有用意義了。</em></p><h3 id="目標"><span class="me-2">目標</span><a href="#目標" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>對於一個影音串流服務， <strong>Cache 非常之重要</strong> ；因為每個音訊檔案小則 MB 大則幾 GB ，如果每次重播都要再從伺服器拉一次檔案，對 Server 的 Loading 來說非常吃力，而且流量都是 \(\) ，如果有個 Cache 層能為服務節省許多金錢，對使用者來說也不用浪費網路、浪費時間重新下載；是一個雙贏的機制 (但要記得設定上限/定時清除，避免把使用者的設備塞爆)。</p><h3 id="問題"><span class="me-2">問題</span><a href="#問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>以往非串流時 mp3/mp4 沒什麼好處理的，就是在播放前先下載到設備上，下載完成才開始播放；反正不管怎樣都要載完才能播，那不如我們自己用 URLSession 下載完檔案後再餵 file:// 下載在本地的檔案路徑給 AVPlayer 做播放即可；或正規方式，使用 AVAssetResourceLoaderDelegate 在 Delegate 方法中對下載的資料進行 Cache 緩存。</p><p>遇到串流想法其實也很直白，就是先讀 <code class="language-plaintext highlighter-rouge">.m3u8</code> 檔，然後在解析裡面的資訊，對每個 <code class="language-plaintext highlighter-rouge">.ts</code> 檔做 Cache 即可；但實作發現事情沒有這麼簡單，處理難度超乎我的想像，所以才會有此篇文章！</p><p>播放部分我們一樣直接使用 iOS AVFoundation 的 AVPlayer，在操作上串流/非串流檔案沒有差異。</p><p><strong>Example:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span><span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span><span class="s">"https://zhgchg.li/aviciiwakemeup.m3u8"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="20210105-更新"><span class="me-2"><strong>2021–01–05 更新：</strong></span><a href="#20210105-更新" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我們退而求其次退回去使用 mp3 檔，這樣就能直接使用 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> 進行實作，詳細實作可參考「 <a href="https://zhgchg.li/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/">AVPlayer 邊播邊 Cache 實戰</a> 」。</p><h3 id="實踐方案"><span class="me-2">實踐方案</span><a href="#實踐方案" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>針對我們的目標能達成的幾個方案及實踐時遇到的問題。</p><h4 id="方案-1-avassetresourceloaderdelegate-"><span class="me-2">方案 1. AVAssetResourceLoaderDelegate ❌</span><a href="#方案-1-avassetresourceloaderdelegate-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>第一個想法就是，那我們就照 mp3/mp4 時的做法就好啦！一樣用 AVAssetResourceLoaderDelegate 在 Delegate 方法中緩存 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案。</p><p>不過很抱歉，此路不通，因為無法在 Delegate 中攔截到 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案的下載請求資訊，可以在這則 <a href="https://stackoverflow.com/questions/29752028/unknown-error-12881-when-using-avassetresourceloader/30239876#30239876" target="_blank">問答</a> 和 <a href="https://developer.apple.com/library/archive/technotes/tn2232/_index.html#//apple_ref/doc/uid/DTS40012884-CH1-SECHTTPLIVESTREAMING" target="_blank">官方文件</a> 上確切此事。</p><p>AVAssetResourceLoaderDelegate 實作可參考「 <a href="https://zhgchg.li/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/">AVPlayer 邊播邊 Cache 實戰</a> 」。</p><h4 id="方案-21-urlprotocol-攔截請求-"><span class="me-2">方案 2.1 URLProtocol 攔截請求 ❌</span><a href="#方案-21-urlprotocol-攔截請求-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>URLProtocol 也是最近才學到的方法，所有基於 <code class="language-plaintext highlighter-rouge">URL Loading System</code> 的請求 (URLSession、Call API、下載圖片…) 都可以被我們攔截下來修改 Request、Response 然後再返回，一切就像沒發生一樣，偷偷來；關於 URLProtocol 可以參考 <a href="https://www.jianshu.com/p/fbe57730d3e1" target="_blank">此篇文章</a> 。</p><p>應用此方法，我們打算攔截 AVFoundation AVPlayer 在要求 <code class="language-plaintext highlighter-rouge">.m3u8</code> 、 <code class="language-plaintext highlighter-rouge">.ts</code> 的請求時，攔截下來然後如果本地有 Cache 就直接返回 Cache Data，沒有則再真的再發 Request 出去；這樣也能達到我們的目標。</p><p>一樣，很抱歉，此路也不通；因為 AVFoundation AVPlayer 的請求不是在 <code class="language-plaintext highlighter-rouge">URL Loading System</code> 上，我們無從攔截。 <em>*有一說是 模擬器上可以但實機上不行</em></p><h4 id="方案-22-暴力讓他能進-urlprotocol-"><span class="me-2">方案 2.2 暴力讓他能進 URLProtocol ❌</span><a href="#方案-22-暴力讓他能進-urlprotocol-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>根據 方案 2.1 腦洞大開的暴力法，如果我把請求網址換成一個自訂的 Scheme (EX: streetVoiceCache://)，因 AVFoundation 無法處理這個請求，所以會丟出來，這樣我們的 URLProtocol 就能攔截到，做我們想做的事。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span><span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span><span class="s">"streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originSchme=https"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><p>URLProtocol 會攔截到 <code class="language-plaintext highlighter-rouge">streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originSchme=https</code> ，這時我們只要幫他還原成原來的網址，然後發個 URLSession 去要資料就能在這邊自己做 Cache；m3u8 中的 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案請求一樣也會被 URLProtocol 攔截到，一樣我們能在這自己做 Cache。</p><p>一切看似都那麼完美，但當我興高采烈的 Build-Run 完 APP 後，蘋果直接搧了我一巴掌：</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p>他不吃我給 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案 Request 的 Response Data，我只能用 <code class="language-plaintext highlighter-rouge">urlProtocol:wasRedirectedTo</code> 這個方法 redirectTo 原始 Https 請求才能正常播放，即使我把 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案下載到本地然後 redirectTo 那個 file:// 檔案；他也不接受，查 <a href="https://forums.developer.apple.com/thread/30833" target="_blank">官方論壇</a> 得到答案就是不能這樣做； <code class="language-plaintext highlighter-rouge">.m3u8</code> 只能是來源於 Http/Https (所以即使你把整個 <code class="language-plaintext highlighter-rouge">.m3u8</code> 還有所有分割檔 <code class="language-plaintext highlighter-rouge">.ts</code> 都放在本地，有無法使用 file:// 給 AVPlayer播放)，另外 <code class="language-plaintext highlighter-rouge">.ts</code> 也不能使用 URLProtocol 自行給予 Data。</p><p><code class="language-plaintext highlighter-rouge">fxxk…</code></p><h4 id="方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-來實現-"><span class="me-2">方案 2.2–2 同方案 2.2 但是搭配 方案 1 AVAssetResourceLoaderDelegate 來實現 ❌</span><a href="#方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-來實現-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>實作方式如方案 2.2 ，餵給 AVPlayer 自訂的 Scheme 讓他進 AVAssetResourceLoaderDelegate；然後我們在自己處理。</p><p>同 2.2 結果：</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p><a href="https://forums.developer.apple.com/thread/113063" target="_blank">官方論壇</a> 同樣的回答。</p><p>可以拿來做解密處理(可以參考 <a href="https://medium.com/@marslin_dev/how-to-play-aes-encrypted-video-with-airplay-2-82a353044f40" target="_blank">此篇文章</a> 或 <a href="https://www.jianshu.com/p/2c2cbe173e99" target="_blank">此範例</a> )但還是無法實現 Cache 功能。</p><h4 id="方案-3-reverse-proxy-server--可行但非完美"><span class="me-2">方案 3. Reverse Proxy Server ⍻ (可行，但非完美)</span><a href="#方案-3-reverse-proxy-server--可行但非完美" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>這個方法是在找如何處理 HLS Cache 時，最多人給的答案；就是在 APP 上起一個 HTTP Server 做 Reverse Proxy Server 服務。</p><p>原理也很簡單，APP 上 On 一個 HTTP Server 假設是 8080 Port，網址就會是 <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/</code> ；然後我們可以對連進來的 Request 做處理，給出 Response。</p><p>套用到我們的案例就是，把請求網址換成： <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/aviciiwakemeup.m3u8?origin=http://zhgchg.li/</code></p><p>在 HTTP Server 的 Handler 上對 <code class="language-plaintext highlighter-rouge">*.m3u8</code> 攔截處理，這時有 Request 進來就會進到我們的 Handler 中，看我們想幹嘛就幹嘛，想 Response 什麼 Data 都是我們自己控制， <code class="language-plaintext highlighter-rouge">.ts</code> 檔同樣會進來；這邊就可以做我們想做的 Cache 機制。</p><p>對 AVPlayer 來說就是個 http://.m3u8 的標準串流音訊檔，所以不會有任何問題。</p><p><strong>完整實作範例可參考：</strong></p><p><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer/blob/master/Sources/HLSCachingReverseProxyServer/HLSCachingReverseProxyServer.swift" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/f82feda77c302ecf87673688fe78a46bccc4669783dda9b10093ecb5382f9895/StyleShare/HLSCachingReverseProxyServer" alt="" loading="lazy"></a></p><p>因為我也是參考此範例做的，所以 Local HTTP Server 的部分我也是使用 <a href="https://github.com/swisspol/GCDWebServer" target="_blank">GCDWebServer</a> ，另外還有更新的 <a href="https://github.com/Building42/Telegraph" target="_blank">Telegraph</a> 可以使用。( <a href="https://github.com/robbiehanson/CocoaHTTPServer" target="_blank">CocoaHttpServer</a> 太久沒更新就不推薦用了)</p><p><strong>看起來不錯！但有個問題：</strong></p><p>我們的服務是音樂串流而非影音播放平台，音樂串流很多時候使用者都是在背景執行音樂切換的；這時候 Local HTTP Server 還會在？？</p><p>GCDWebServer 的說明是當進入背景時會自動斷線、回前景自動恢復，但可以透過設置參數 <code class="language-plaintext highlighter-rouge">GCDWebServerOption_AutomaticallySuspendInBackground:false</code> 不讓他有這個機制。</p><p>但是實測如果一段時間沒有發送請求 Server 還是會斷線 (且狀態會是錯的，還是 isRunning) 感覺就是被系統砍了；深掘了 <a href="https://izeeshan.wordpress.com/2014/08/25/local-http-server-for-ios/" target="_blank">HTTP Server 的做法</a> 後發現底層都是基於 socket，查了 <a href="https://developer.apple.com/library/archive/technotes/tn2277/_index.html" target="_blank">官方對 socket 服務的文件</a> 後，此缺陷是無法解決的，本來在背景下沒有新的連接時就會被系統暫停。</p><p><em>*網路上有找到很繞的方法…就是發個長請求、或不斷發空的請求確保 Server 在背景不會被系統暫停掉。</em></p><p>以上都是針對 APP 在背景的狀況，在前景時 Server 很穩，也不會因為閒置被暫停，沒這問題！</p><p><strong>是說畢竟是依賴在其他服務上，開發環境測試沒問題，實際應用也建議要接個 rollback 處理(AVPlayer.AVPlayerItemFailedToPlayToEndTimeErrorKey 通知)；否則有個萬一服務掛掉，使用者會卡死。</strong></p><p><code class="language-plaintext highlighter-rouge">所以說不完美啊…</code></p><h4 id="方案-4-使用-http-client-本身的-caching-機制-"><span class="me-2">方案 4. 使用 HTTP Client 本身的 caching 機制 ❌</span><a href="#方案-4-使用-http-client-本身的-caching-機制-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我們的 <code class="language-plaintext highlighter-rouge">.m3u8/.ts</code> 檔的 Response Headers 都有給予 <code class="language-plaintext highlighter-rouge">Cache-Control</code> 、 <code class="language-plaintext highlighter-rouge">Age</code> 、 <code class="language-plaintext highlighter-rouge">eTag</code> … 這些 HTTP Client Cache 資訊；我們的網站 Cache 機制在 Chrome 上使用也完全沒問題，另外也在官方新的針對 <a href="https://developer.apple.com/documentation/http_live_streaming/protocol_extension_for_low-latency_hls_preliminary_specification" target="_blank">Protocol Extension for Low-Latency HLS (低延遲HLS)</a> 初步規格文件中提到 Cache 的地方也看到可以設定 cache-control headers 來做緩存。</p><p><a href="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzEiIGhlaWdodD0iMTM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>但實際 AVFoundation AVPlayer 並沒有任何 HTTP Client Caching 效果，此路也不通！單純癡人說夢。</p><h4 id="方案-5-不使用-avfoundation-avplayer-播放音訊檔-"><span class="me-2">方案 5. 不使用 AVFoundation AVPlayer 播放音訊檔 ✔</span><a href="#方案-5-不使用-avfoundation-avplayer-播放音訊檔-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>自己實現音訊檔解析、緩存、編碼、播放功能。</p><p><strong>太硬核了，需要很深的技術能力及大量時間；沒研究。</strong></p><p>附上一個網路開源播放器做參考： <a href="https://github.com/muhku/FreeStreamer" target="_blank">FreeStreamer</a> ，真要選擇此方案不如站在巨人的肩膀上，直接用第三方套件了。</p><h4 id="方案-51-不使用-hls"><span class="me-2">方案 5–1. 不使用 HLS</span><a href="#方案-51-不使用-hls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>同方案 5 ， <strong>太硬核了，需要很深的技術能力及大量時間；沒研究。</strong></p><h4 id="方案-6-將-ts-分割檔轉成-mp3mp4-檔案-"><span class="me-2">方案 6. 將 .ts 分割檔轉成 .mp3/.mp4 檔案 ✔</span><a href="#方案-6-將-ts-分割檔轉成-mp3mp4-檔案-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>沒研究，但的確可行；不過想起來就覺得複雜，要處理已下載的 <code class="language-plaintext highlighter-rouge">.ts</code> 檔案，個別轉成 .mp3 或 .mp4 檔案然後照順序播放、或是壓縮成一個檔案什麼的，想起來就不太好做。</p><p>有興趣可參考 <a href="https://github.com/xyqjay/m3u8ToMP4" target="_blank">此篇文章</a> 。</p><h4 id="方案-7-下載完整檔案後再播放-"><span class="me-2">方案 7. 下載完整檔案後再播放 ⍻</span><a href="#方案-7-下載完整檔案後再播放-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>這個方法不能確切叫邊播邊 Cache，實際是載下整個音訊檔案的內容，然後才開始播放；如果是 <code class="language-plaintext highlighter-rouge">.m3u8</code> 如同方案 2.2 提到的，不能直接載下來放在本地播放。</p><p>要實作的話要用到 iOS ≥ 10 的 API <code class="language-plaintext highlighter-rouge">AVAssetDownloadTask.makeAssetDownloadTask</code> ，實際會將 . <code class="language-plaintext highlighter-rouge">m3u8</code> 打包成 <strong><code class="language-plaintext highlighter-rouge">.movpkg</code></strong> 放在本地，供使用者播放。</p><p><strong>這邊比較像是做離線播放而非做 Cache 的功能。</strong></p><p>另外使用者也能從「設定」-&gt;「一般」-&gt;「iPhone 儲存空間」-&gt; APP 中查看、管理已下載打包的音訊檔案。</p><p><a href="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.webp" alt="下方 已下載的影片 部分" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTAiIGhlaWdodD0iMTMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>下方 已下載的影片 部分</p><p><strong>詳細實作可參考此範例：</strong></p><p><a href="https://github.com/zhonglaoban/HLS-Stream" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/a2ceae202336428494e5cd51b78cfbba3d139c135eaf232b4d2dffd2a7673eba/zhonglaoban/HLS-Stream" alt="" loading="lazy"></a></p><h3 id="結語"><span class="me-2">結語</span><a href="#結語" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>以上的探索路程大概花了快一整週，繞來繞去、快要喪心病狂了；目前還沒有一個可靠的、容易部署的方法。</p><p>如果有新的想法再來更新!</p><h4 id="參考資料"><span class="me-2">參考資料</span><a href="#參考資料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="http://msching.github.io/blog/2016/05/24/audio-in-ios-9/" target="_blank">iOS音频播放 (九)：边播边缓存</a><li><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer" target="_blank">StyleShare/HLSCachingReverseProxyServer</a></ul><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">🔗</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="https://www.paypal.com/ncp/payment/CMALMPT8UUTY2" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">🍺 Buy me a beer on PayPal</a></p><blockquote class="prompt-tip"><p>👉👉👉 <a href="https://medium.com/@zhgchgli" target="_blank"><strong>Follow Me On Medium!</strong> (1,050+ Followers)</a> 👈👈👈</p></blockquote><blockquote class="prompt-info"><p>本文首次發表於 Medium (<a href="https://medium.com/p/d796bf8e661e" target="_blank"><strong>點此查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2020-04-08-d796bf8e661e.md" target="_blank">Improve this page on Github.</a></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/hls/" class="post-tag no-text-decoration" >hls</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/reverse-proxy/" class="post-tag no-text-decoration" >reverse-proxy</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者以 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh-hant"> CC BY 4.0 </a> 授權。</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20HLS%20Cache%20%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5%EF%BD%9CAVPlayer%20%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-hls-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E9%2582%258A%25E6%2592%25AD%25E9%2582%258A%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E8%25A1%2593%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20HLS%20Cache%20%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5%EF%BD%9CAVPlayer%20%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-hls-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E9%2582%258A%25E6%2592%25AD%25E9%2582%258A%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E8%25A1%2593%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-hls-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E9%2582%258A%25E6%2592%25AD%25E9%2582%258A%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E8%25A1%2593%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="複製連結" data-title-succeed="連結已成功複製！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/medium-private-api-%E7%88%AC%E5%8F%96%E8%B3%87%E6%96%99%E8%88%87%E7%AA%81%E7%A0%B4-cloudflare-%E9%98%B2%E8%AD%B7-%E5%AE%8C%E6%95%B4-graphql-%E6%93%8D%E4%BD%9C%E6%95%99%E5%AD%B8-88f0fb935120/">Medium Private API 資料爬蟲與 Cloudflare 攻防的心路歷程</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/app-store-connect-api-webhook-%E4%B8%B2%E6%8E%A5-%E6%8F%90%E5%8D%87-ios-ci-cd-%E8%87%AA%E5%8B%95%E5%8C%96%E6%95%88%E7%8E%87%E8%88%87%E9%80%9A%E7%9F%A5%E6%B5%81%E7%A8%8B-7c0974856393/">CI/CD 使用 App Store Connect API Webhook 串接自動化工作流程</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD 實戰指南（一）：CI/CD 是什麼？如何透過 CI/CD 打造穩定高效的開發團隊？工具選擇？</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%A8%82%E8%A1%A8%E5%96%AE%E6%8F%90%E5%8D%87%E9%96%8B%E7%99%BC%E6%95%88%E7%8E%87-4cb4437818f2/">使用 Google Apps Script Web App 表單串接 Github Action CI/CD 工作</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/github-action-%E5%85%8D%E8%B2%BB%E9%83%A8%E7%BD%B2-zreviewtender-app-%E5%95%86%E5%9F%8E%E8%A9%95%E5%83%B9%E7%9B%A3%E6%8E%A7%E6%A9%9F%E5%99%A8%E4%BA%BA-%E4%B8%89%E6%AD%A5%E9%A9%9F%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-0095528cf875/">Quick Start! Github Action x ZReviewTender 免費快速部署你的 App 商城評價監控機器人</a></ul></section><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/cicd/">cicd</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節目錄 🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">延伸閱讀</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="YYYY 年 M 月 D 日" > 2021 年 01 月 05 日 </time><h4 class="pt-0 my-2">AVPlayer 邊播邊 Cache 實戰</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset 實作 AVAssetResourceLoaderDelegate 達成邊播放音樂/影片邊緩存</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-wkwebview-%E9%A0%90%E8%BC%89%E8%88%87-cache-%E7%B7%A9%E5%AD%98%E6%8A%80%E8%A1%93-%E6%8F%90%E5%8D%87%E9%A0%81%E9%9D%A2%E8%BC%89%E5%85%A5%E9%80%9F%E5%BA%A6%E8%88%87%E8%B3%87%E6%BA%90%E7%AE%A1%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90-5033090c18ba/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1722160385" data-df="YYYY 年 M 月 D 日" > 2024 年 07 月 28 日 </time><h4 class="pt-0 my-2">iOS WKWebView 頁面與檔案資源 Preload 預載 / Cache 緩存研究</h4><div class="text-muted"><p>iOS WKWebView 預先下載與緩存資源提升頁面載入速度研究。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1612089702" data-df="YYYY 年 M 月 D 日" > 2021 年 01 月 31 日 </time><h4 class="pt-0 my-2">AVPlayer 實踐本地 Cache 功能大全</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset 實作 AVAssetResourceLoaderDelegate</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/ios-%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E5%85%A8%E6%94%BB%E7%95%A5-%E8%B6%8A%E7%8D%84%E6%8F%90%E5%8F%96ipa%E6%AA%94-ui%E5%88%86%E6%9E%90%E5%88%B0%E5%8F%8D%E7%B7%A8%E8%AD%AF%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-7498e1ff93ce/" class="btn btn-outline-primary" aria-label="上一篇" ><p>iOS 逆向工程全攻略｜越獄提取iPA檔、UI分析到反編譯技術詳解</p></a> <a href="/posts/zrealm-life/homebridge-%E6%A8%B9%E8%8E%93%E6%B4%BE%E4%B8%B2%E6%8E%A5%E7%B1%B3%E5%AE%B6%E5%AE%B6%E9%9B%BB%E5%88%B0homekit-%E6%89%93%E9%80%A0%E6%99%BA%E6%85%A7%E5%B1%85%E5%AE%B6wfh%E7%92%B0%E5%A2%83-99db2a1fbfe5/" class="btn btn-outline-primary" aria-label="下一篇" ><p>打造舒適的 WFH 智慧居家環境，控制家電盡在指尖</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有註明，本網站上的所有文章皆由作者依據 創用 CC 姓名標示 4.0 國際授權條款（CC BY 4.0）授權使用。" >版權所有。</span> <br/> 最後更新時間:2026-01-01 11:16:34 +08:00</p><p>本站使用 <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> 主題建置於 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>。<br/> Medium 文章由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 轉換而成。</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/cicd/">cicd</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">發現有新的內容版本。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-TW';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOHdowL84CU-q5', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">找不到符合的結果。</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
