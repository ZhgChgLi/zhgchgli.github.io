<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对iOS开发者打造的GitHub Actions CI/CD流程，解决手动建置与测试繁琐问题，结合Fastlane与Firebase实现自动化打包与部署，提升团队开发效率与产品品质。" /><meta property="og:description" content="针对iOS开发者打造的GitHub Actions CI/CD流程，解决手动建置与测试繁琐问题，结合Fastlane与Firebase实现自动化打包与部署，提升团队开发效率与产品品质。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-07-07T23:02:24+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" /><meta property="twitter:title" content="GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2025-07-12T10:52:21+08:00","datePublished":"2025-07-07T23:02:24+08:00","description":"针对iOS开发者打造的GitHub Actions CI/CD流程，解决手动建置与测试繁琐问题，结合Fastlane与Firebase实现自动化打包与部署，提升团队开发效率与产品品质。","headline":"GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/"}</script><title>GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/github-actions-ios-app-ci-cd-workflow-automation-for-faster-builds-and-deployments-4b001d2e8440/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AF%A6%E4%BD%9C%E8%87%AA%E5%8B%95%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B8%AC%E8%A9%A6%E8%88%87%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%B8-4b001d2e8440/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学</h1><p class="post-desc fw-light mb-4">针对iOS开发者打造的GitHub Actions CI/CD流程，解决手动建置与测试繁琐问题，结合Fastlane与Firebase实现自动化打包与部署，提升团队开发效率与产品品质。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1751900544" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 7, 2025 </time> </span> <span> Updated <time data-ts="1752288741" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 12, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" class="popup img-link preview-img blur"><img data-src="/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="11619 words" > <em>64 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">GitHub Actions iOS CI/CD｜完整实作自动化建置、测试与部署流程教学</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/github-actions-ios-app-ci-cd-workflow-automation-for-faster-builds-and-deployments-4b001d2e8440/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AF%A6%E4%BD%9C%E8%87%AA%E5%8B%95%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B8%AC%E8%A9%A6%E8%88%87%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%B8-4b001d2e8440/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><hr /><h3 id="cicd-实战指南三使用-github-actions-实作-app-ios-ci-与-cd-工作流程"><span class="me-2">CI/CD 实战指南（三）：使用 GitHub Actions 实作 App iOS CI 与 CD 工作流程</span><a href="#cicd-实战指南三使用-github-actions-实作-app-ios-ci-与-cd-工作流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>iOS App 自动化建置、测试、部署的 GitHub Actions 实作步骤完整教学</p><p><a href="/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*0LK6m6CTImL6rcsrliiOQA.webp" alt="Photo by [Robs](https://unsplash.com/@robinne?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@robinne?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target="_blank">Robs</a></p><h4 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>前篇「 <a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/"><strong>CI/CD 实战指南（二）：GitHub Actions 与 Self-hosted Runner 使用与建置大全</strong></a> 」我们介绍了 GitHub Actions 的基础知识与运作流程还有如何使用自己的机器当成 Runner、带大家实现了三个简单的自动化 Actions； <strong>本篇将深入著重在现实使用 GitHub Actions 建置 App (iOS) CI/CD 工作流程上</strong> ，一样手把手带大家一步一步完成并一边补足 GitHub Actions 相关知识。</p><h3 id="app-cicd-流程关系图"><span class="me-2">App CI/CD 流程关系图</span><a href="#app-cicd-流程关系图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/4b001d2e8440/1*VRygfRAkBRNEDAC4RyGzRA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*VRygfRAkBRNEDAC4RyGzRA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU3MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>本篇将关注在 GitHub Actions 建置 CI/CD 的区块，下一篇「 <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E5%B9%B3%E5%8F%B0-%E4%BD%BF%E7%94%A8-google-apps-script-web-app-%E4%B8%B2%E6%8E%A5-github-actions-%E6%8F%90%E5%8D%87%E8%B7%A8%E5%9B%A2%E9%98%9F%E6%95%88%E7%8E%87-4273e57e7148/">CI/CD 实战指南（四）：使用 Google Apps Script Web App 串接 GitHub Actions 建置免费易用的打包工具平台</a> 」才会介绍右半部分的使用 Google Apps Script Web App 建置跨团队协作打包平台。</p><h4 id="运作流程"><span class="me-2">运作流程：</span><a href="#运作流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>GitHub Actions 开 Pull Request 触发 or 表单触发 or 定时触发</p><li><p>执行对应 Workflow Jobs/Steps</p><li><p>Step 执行对应 Fastlane (iOS) or (Android Gradle) 脚本</p><li><p>Fastlane 执行对应 xcodebuild (iOS) 指令</p><li><p>取得执行结果</p><li><p>后续 Workflow Jobs/Steps 处理结果</p><li><p>完成</p></ol><h4 id="github-actions-成果图"><span class="me-2">GitHub Actions 成果图</span><a href="#github-actions-成果图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>先上最终成果给大家一点实作动力！</p><p><a href="/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.webp" alt="[CI Testing](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MTEiIGhlaWdodD0iNTY2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11" target="_blank">CI Testing</a></p><p><a href="/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjgwMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.webp" alt="[CI Nightly Build, CD Deploy](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NTQiIGhlaWdodD0iMTIwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747" target="_blank">CI Nightly Build, CD Deploy</a></p><h3 id="github-actions-x-self-hosted-runner-基础知识"><span class="me-2">GitHub Actions x Self-hosted Runner 基础知识</span><a href="#github-actions-x-self-hosted-runner-基础知识" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如果你对 GitHub Actions 与架设 Self-hosted Runner 还不熟悉强烈建议先看过上篇「 <a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/"><strong>CI/CD 实战指南（二）：GitHub Actions 与 Self-hosted Runner 使用与建置大全</strong></a> 」或是搭配上篇知识一起实作。</p><blockquote><p><strong><em>实作开始！</em></strong></p></blockquote><h3 id="ios-demo-专案的-infra-架构"><span class="me-2">iOS Demo 专案的 Infra 架构</span><a href="#ios-demo-专案的-infra-架构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/5952f3220c95ced947b9ee50d9c542b2edbb424be50c51c582cb226ce5f5df63/ZhgChgLi/github-actions-ci-cd-demo" alt="" loading="lazy"></a></p><p><strong>本文用到的 iOS 专案内容包含测试项目都是用 AI 产生的</strong> ，不需在意 iOS 的程式细节，只针对 Infra &amp; CI/CD 部分做讨论。</p><blockquote><p><strong><em>以下工具只是凭以往经验，如果是新专案可以考虑使用更新的 <a href="https://github.com/jdx/mise" target="_blank">mise</a> 和 <a href="https://github.com/tuist/tuist" target="_blank">tuist</a> 。</em></strong></p></blockquote><h4 id="mint"><span class="me-2">Mint</span><a href="#mint" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/yonaskolb/Mint" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/cfba5c7658c860d0ee4e97df8176a3fc6bbfd9f84c2e8334eaa30988c2700d63/yonaskolb/Mint" alt="" loading="lazy"></a></p><p>Mint 工具可以帮我们统一管理依赖工具的版本(Gemfile 只能管理 Ruby Gems)，例如 XCodeGen、XCodeGen、SwiftFormat、SwiftLint、Periphery</p><p>…etc</p><p><strong>Mintfile:</strong></p><div class="language-graphql highlighter-rouge"><div class="code-header"> <span data-label-text="GraphQL"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="err">yonaskolb/Mint@0.17.5</span><span class="w">
</span><span class="err">yonaskolb/XcodeGen@2.35.0</span><span class="w">
</span><span class="err">nicklockwood/SwiftFormat@0.51.13</span><span class="w">
</span></pre></table></code></div></div><p>这边我们只用到三个。</p><blockquote><p><strong><em>觉得太复杂不使用也可以，直接在 Action Workflow Step 中用 brew install 安装需要的工具即可。</em></strong></p></blockquote><h4 id="bundle"><span class="me-2">Bundle</span><a href="#bundle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Gemfile:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">source</span> <span class="s1">'https://rubygems.org'</span>
gem <span class="s1">'cocoapods'</span>, <span class="s1">'~&gt;1.16.0'</span>
gem <span class="s1">'fastlane'</span>, <span class="s1">'~&gt;2.228.0'</span>

plugins_path <span class="o">=</span> File.join<span class="o">(</span>File.dirname<span class="o">(</span>__FILE__<span class="o">)</span>, <span class="s1">'Product'</span>, <span class="s1">'fastlane'</span>, <span class="s1">'Pluginfile'</span><span class="o">)</span>
eval_gemfile<span class="o">(</span>plugins_path<span class="o">)</span> <span class="k">if </span>File.exist?<span class="o">(</span>plugins_path<span class="o">)</span>
</pre></table></code></div></div><p>管理 Ruby (Gems) 相关依赖，一般 iOS 专案最常用的就是这两个 <code class="language-plaintext highlighter-rouge">cocoapods</code> 跟 <code class="language-plaintext highlighter-rouge">fastlane</code> 。</p><h4 id="cocoapods"><span class="me-2">Cocoapods</span><a href="#cocoapods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Product/podfile:</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'13.0'</span>
<span class="n">use_frameworks!</span>

<span class="n">target</span> <span class="s1">'app-ci-cd-github-actions-demo'</span> <span class="k">do</span>
  <span class="n">pod</span> <span class="s1">'SnapKit'</span>
<span class="k">end</span> 
</pre></table></code></div></div><p>虽然已宣告 <a href="https://blog.cocoapods.org/CocoaPods-Specs-Repo/" target="_blank">即将停止维护</a> ，但 Cocoapods 在有年代的 iOS 专案中仍很常见，这边简单加一个 Snapkit 当 Demo。</p><h4 id="xcodegen"><span class="me-2">XCodeGen</span><a href="#xcodegen" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>避免多人开发中 <code class="language-plaintext highlighter-rouge">.xcodeproj</code> / <code class="language-plaintext highlighter-rouge">.xcworkspace</code> 异动造成的冲突，统一使用 Project.yaml 定义 XCode Project 内容，然后在本地自己 Gen Project 档案(不上 Git)。</p><p><strong>Product/project.yaml:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demo</span>
<span class="na">options</span><span class="pi">:</span>
  <span class="na">bundleIdPrefix</span><span class="pi">:</span> <span class="s">com.example</span>
  <span class="na">deploymentTarget</span><span class="pi">:</span>
    <span class="na">iOS</span><span class="pi">:</span> <span class="s1">'</span><span class="s">13.0'</span>
  <span class="na">usesTabs</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">indentWidth</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">tabWidth</span><span class="pi">:</span> <span class="m">2</span>

<span class="na">configs</span><span class="pi">:</span>
  <span class="na">Debug</span><span class="pi">:</span> <span class="s">debug</span>
  <span class="na">Release</span><span class="pi">:</span> <span class="s">release</span>

<span class="na">targets</span><span class="pi">:</span>
  <span class="na">app-ci-cd-github-actions-demo</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">application</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">iOS</span>
    <span class="na">sources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">app-ci-cd-github-actions-demo</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">app-ci-cd-github-actions-demo/Assets.xcassets</span>
      <span class="pi">-</span> <span class="s">app-ci-cd-github-actions-demo/Base.lproj</span>
    <span class="na">info</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demo/Info.plist</span>
      <span class="na">properties</span><span class="pi">:</span>
        <span class="na">CFBundleIdentifier</span><span class="pi">:</span> <span class="s">$(PRODUCT_BUNDLE_IDENTIFIER)</span>
    <span class="na">settings</span><span class="pi">:</span>
      <span class="na">base</span><span class="pi">:</span>
        <span class="na">PRODUCT_BUNDLE_IDENTIFIER</span><span class="pi">:</span> <span class="s">com.test.appcicdgithubactionsdemo</span>
    <span class="na">cocoapods</span><span class="pi">:</span> <span class="kc">true</span>

  <span class="na">app-ci-cd-github-actions-demoTests</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">bundle.unit-test</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">iOS</span>
    <span class="na">sources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">app-ci-cd-github-actions-demoTests</span>
    <span class="na">dependencies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demo</span>
    <span class="na">info</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demoTests/Info.plist</span>
    <span class="na">settings</span><span class="pi">:</span>
      <span class="na">base</span><span class="pi">:</span>
        <span class="na">PRODUCT_BUNDLE_IDENTIFIER</span><span class="pi">:</span> <span class="s">com.test.appcicdgithubactionsdemo.tests</span>

  <span class="na">app-ci-cd-github-actions-demoUITests</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">bundle.ui-testing</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">iOS</span>
    <span class="na">sources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">app-ci-cd-github-actions-demoUITests</span>
    <span class="na">dependencies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demo</span>
    <span class="na">info</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demoUITests/Info.plist</span>
    <span class="na">settings</span><span class="pi">:</span>
      <span class="na">base</span><span class="pi">:</span>
        <span class="na">PRODUCT_BUNDLE_IDENTIFIER</span><span class="pi">:</span> <span class="s">com.test.appcicdgithubactionsdemo.uitests</span>

  <span class="na">app-ci-cd-github-actions-demoSnapshotTests</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">bundle.unit-test</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">iOS</span>
    <span class="na">sources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demoSnapshotTests</span>
        <span class="na">excludes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">**/__Snapshots__/**"</span>
    <span class="na">dependencies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">target</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demo</span>
      <span class="pi">-</span> <span class="na">product</span><span class="pi">:</span> <span class="s">SnapshotTesting</span>
        <span class="na">package</span><span class="pi">:</span> <span class="s">SnapshotTesting</span>
    <span class="na">info</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s">app-ci-cd-github-actions-demoSnapshotTests/Info.plist</span>
      <span class="na">settings</span><span class="pi">:</span>
        <span class="na">base</span><span class="pi">:</span>
          <span class="na">PRODUCT_BUNDLE_IDENTIFIER</span><span class="pi">:</span> <span class="s">com.test.appcicdgithubactionsdemo.snapshottests</span>

<span class="na">packages</span><span class="pi">:</span>
  <span class="na">SnapshotTesting</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">https://github.com/pointfreeco/swift-snapshot-testing</span>
    <span class="na">from</span><span class="pi">:</span> <span class="s">1.18.4</span>
</pre></table></code></div></div><p>SnapshotTesting: 使用 Swift Package Manager 管理。</p><h4 id="fastlane"><span class="me-2">Fastlane</span><a href="#fastlane" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>封装 xcodebuild 指令、封装串接 App Store Connect API、Firebase API. .等服务的复杂步骤。</p><p><strong>Product/fastlane/Fastfile:</strong></p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre>
<span class="nf">default_platform</span><span class="p">(</span><span class="o">:</span><span class="n">ios</span><span class="p">)</span>

<span class="n">platform</span> <span class="o">:</span><span class="n">ios</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Run all tests (Unit Tests + UI Tests)"</span>
  <span class="n">lane</span> <span class="o">:</span><span class="n">run_all_tests</span> <span class="k">do</span> <span class="err">\\</span><span class="o">|</span><span class="n">options</span><span class="err">\\</span><span class="o">|</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">device</span><span class="p">]</span>
    <span class="nf">scan</span><span class="p">(</span>
      <span class="n">scheme</span><span class="o">:</span> <span class="s2">"app-ci-cd-github-actions-demo"</span><span class="p">,</span>
      <span class="n">device</span><span class="o">:</span> <span class="n">device</span><span class="p">,</span>
      <span class="n">clean</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="n">output_directory</span><span class="o">:</span> <span class="s2">"fastlane/test_output"</span><span class="p">,</span>
      <span class="n">output_types</span><span class="o">:</span> <span class="s2">"junit"</span>
    <span class="p">)</span>
  <span class="n">end</span>

  <span class="n">desc</span> <span class="s2">"Run only Unit Tests"</span>
  <span class="n">lane</span> <span class="o">:</span><span class="n">run_unit_tests</span> <span class="k">do</span> <span class="err">\\</span><span class="o">|</span><span class="n">options</span><span class="err">\\</span><span class="o">|</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">device</span><span class="p">]</span>
    <span class="nf">scan</span><span class="p">(</span>
      <span class="n">scheme</span><span class="o">:</span> <span class="s2">"app-ci-cd-github-actions-demo"</span><span class="p">,</span>
      <span class="n">device</span><span class="o">:</span> <span class="n">device</span><span class="p">,</span>
      <span class="n">clean</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="n">only_testing</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">"app-ci-cd-github-actions-demoTests"</span>
      <span class="p">],</span>
      <span class="n">output_directory</span><span class="o">:</span> <span class="s2">"fastlane/test_output"</span><span class="p">,</span>
      <span class="n">output_types</span><span class="o">:</span> <span class="s2">"junit"</span>
    <span class="p">)</span>
  <span class="n">end</span>

  <span class="n">desc</span> <span class="s2">"Build and upload to Firebase App Distribution"</span>
  <span class="n">lane</span> <span class="o">:</span><span class="n">beta</span> <span class="k">do</span> <span class="err">\\</span><span class="o">|</span><span class="n">options</span><span class="err">\\</span><span class="o">|</span>
    
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">version_number</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">version_number</span><span class="p">]</span><span class="mf">.</span><span class="n">to_s</span><span class="mf">.</span><span class="n">strip</span> <span class="o">!=</span> <span class="s2">""</span>
      <span class="nf">increment_version_number</span><span class="p">(</span><span class="n">version_number</span><span class="o">:</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">version_number</span><span class="p">])</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">build_number</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">build_number</span><span class="p">]</span><span class="mf">.</span><span class="n">to_s</span><span class="mf">.</span><span class="n">strip</span> <span class="o">!=</span> <span class="s2">""</span>
      <span class="nf">increment_build_number</span><span class="p">(</span><span class="n">build_number</span><span class="o">:</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">build_number</span><span class="p">])</span>
    <span class="n">end</span>

    <span class="nf">update_code_signing_settings</span><span class="p">(</span>
      <span class="n">use_automatic_signing</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="n">path</span><span class="o">:</span> <span class="s2">"app-ci-cd-github-actions-demo.xcodeproj"</span><span class="p">,</span>
      <span class="n">team_id</span><span class="o">:</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'TEAM_ID'</span><span class="p">],</span>
      <span class="n">code_sign_identity</span><span class="o">:</span> <span class="s2">"iPhone Developer"</span><span class="p">,</span>
      <span class="n">sdk</span><span class="o">:</span> <span class="s2">"iphoneos*"</span><span class="p">,</span>
      <span class="n">profile_name</span><span class="o">:</span> <span class="s2">"cicd"</span>
    <span class="p">)</span>

    <span class="nf">gym</span><span class="p">(</span>
      <span class="n">scheme</span><span class="o">:</span> <span class="s2">"app-ci-cd-github-actions-demo"</span><span class="p">,</span>
      <span class="n">clean</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="n">export_method</span><span class="o">:</span> <span class="s2">"development"</span><span class="p">,</span>
      <span class="n">output_directory</span><span class="o">:</span> <span class="s2">"fastlane/build"</span><span class="p">,</span>
      <span class="n">output_name</span><span class="o">:</span> <span class="s2">"app-ci-cd-github-actions-demo.ipa"</span><span class="p">,</span>
      <span class="n">export_options</span><span class="o">:</span> <span class="p">{</span>
          <span class="n">provisioningProfiles</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"com.test.appcicdgithubactionsdemo"</span> <span class="o">=&gt;</span> <span class="s2">"cicd"</span><span class="p">,</span>
          <span class="p">},</span>
      <span class="p">}</span>
    <span class="p">)</span>

    <span class="nf">firebase_app_distribution</span><span class="p">(</span>
      <span class="n">app</span><span class="o">:</span> <span class="s2">"1:127683058219:ios:98896929fa131c7a80686e"</span><span class="p">,</span>
      <span class="n">firebase_cli_token</span><span class="o">:</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"FIREBASE_CLI_TOKEN"</span><span class="p">],</span>
      <span class="n">release_notes</span><span class="o">:</span> <span class="n">options</span><span class="p">[</span><span class="o">:</span><span class="n">release_notes</span><span class="p">]</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="s2">"New beta build"</span>
    <span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>
</pre></table></code></div></div><p>注: provisioningProfiles、profile_name 对应的是 <a href="https://developer.apple.com/account/resources/certificates/list" target="_blank">App Developer 中的 Profiles 凭证名称</a> 。(如果有用 match 则也不需要这些指定。)</p><p><a href="/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE3IiBoZWlnaHQ9IjYxNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>Fastlane 是 iOS CI/CD 当中不可或缺的一部分</strong> ，直接使用它封装好的方法就能快速开发 CI/CD 实际执行的步骤；我们只需关注在整体的脚本设计，而不需去处理复杂的 API 串接或指令撰写。</p><p>例如：Fastlane 只需要写「scan(xxx)」就能执行测试，如果要写成 xcodebuild 则需要「 <code class="language-plaintext highlighter-rouge">xcodebuild -workspace ./xxx.xcworkspace -scheme xxx -derivedDataPath xxx ‘platform=iOS Simulator,id=xxx’ clean build test</code> 」，打包部署要自己做更是麻烦，要自行串接 App Store Connect/Firebase API，光金钥验证都要写超过 10 行程式了。</p><p><strong>Demo 专案我们只有三个 Lane:</strong></p><ul><li><p>run_all_tests: 跑所有类型的测试 (Snapshot+Unit)</p><li><p>run_unit_tests: 只跑单元测试 (Unit)</p><li><p>beta: 打包部署到 Firebase App Distribution</p></ul><h4 id="fastlane--match"><span class="me-2">Fastlane — Match</span><a href="#fastlane--match" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因 Demo 专案限制，这边没用到 Match 管理团队开发、部署凭证，但这边还是要提一下，建议使用 Match 去管理团队的所有开发、部署凭证，方便控管跟统一更新。</p><blockquote><p><em>有用 Match 就能在专案 Setup 步骤直接使用 <code class="language-plaintext highlighter-rouge">match all</code> 之类的指令一键安装好所有开发需要的凭证。</em></p></blockquote><ul><li><strong>Fastlane Match 会使用另一个 Private Repo 管理凭证金钥，在 GitHub Actions 中需要设定好 SSH Agent 才能 Clone 另一个 Private Repo。</strong> (请参考文末补充)</ul><p>— — —</p><h4 id="makefile"><span class="me-2">Makefile</span><a href="#makefile" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/4b001d2e8440/1*jYACUYFP3MkeHCgeUY7j3w.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*jYACUYFP3MkeHCgeUY7j3w.webp" alt="Makefile" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQyMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Makefile</p><p>让开发端与 CI/CD 统一都使用 Makefile 执行指令，方便我们封装同样的环境、路径与操作行为。</p><blockquote><p><em>经典的案例是有的人使用的是本机安装的 <code class="language-plaintext highlighter-rouge">pod install</code> 有的人则使用的是 Bundel 管理的 <code class="language-plaintext highlighter-rouge">bundle exec pod install</code> 如果版本不同就可能产生差异。</em></p></blockquote><blockquote><p><strong><em>觉得太复杂不使用也可以，那就是在 Action Workflow Step 中直接写要执行的指令即可。</em></strong></p></blockquote><p><strong>Makefile:</strong></p><div class="language-makefile highlighter-rouge"><div class="code-header"> <span data-label-text="Makefile"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="c">#!make
</span><span class="nv">PRODUCT_FOLDER</span> <span class="o">=</span> ./Product/
<span class="nv">SHELL</span>         <span class="o">:=</span> /bin/zsh
<span class="nv">.DEFAULT_GOAL</span> <span class="o">:=</span> <span class="nb">install</span>
<span class="nv">MINT_DIRECTORY</span> <span class="o">:=</span> ./mint/

<span class="k">export </span><span class="nv">MINT_PATH</span><span class="o">=</span><span class="p">$(</span>MINT_DIRECTORY<span class="p">)</span>

<span class="c">## 👇 Help function
</span><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">help</span>
<span class="nl">help</span><span class="o">:</span>
 <span class="err">@echo</span> <span class="s2">""</span>
 <span class="nl">@echo "📖 可用指令</span><span class="o">:</span><span class="nf">"</span>
 <span class="nl">@grep -E '^[a-zA-Z_-]+</span><span class="o">:</span><span class="nf">.*?</span><span class="c">##</span><span class="nf"> .*$$' $(MAKEFILE_LIST) </span>\\<span class="nf">| </span>\
<span class="nf">  awk 'BEGIN {FS = ":.*?</span><span class="c">##</span><span class="nf"> "}; {printf "  </span>\0<span class="nf">33[36m%-20s</span>\0<span class="nf">33[0m %s</span>\n<span class="nf">"</span><span class="p">,</span><span class="nf"> $$1</span><span class="p">,</span><span class="nf"> $$2}'</span>
 <span class="err">@echo</span> <span class="s2">""</span>

<span class="c">## Setup
</span><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">setup</span>
<span class="nl">setup</span><span class="o">:</span> <span class="nf">check-mint </span><span class="c">##</span><span class="nf"> 安装 Ruby 和 Mint 依赖</span>
 <span class="err">@echo</span> <span class="s2">"🔨 Installing Ruby dependencies..."</span>
 <span class="err">bundle</span> <span class="err">config</span> <span class="err">set</span> <span class="err">path</span> <span class="s1">'vendor/bundle'</span>
 <span class="err">bundle</span> <span class="err">install</span>
 <span class="err">@echo</span> <span class="s2">"🔨 Installing Mint dependencies..."</span>
 <span class="err">mint</span> <span class="err">bootstrap</span>

<span class="c">## Install
</span><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">install</span>
<span class="nl">install</span><span class="o">:</span> <span class="nf">XcodeGen PodInstall </span><span class="c">##</span><span class="nf"> 执行 XcodeGen 和 CocoaPods 安装</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">XcodeGen</span>
<span class="nl">XcodeGen</span><span class="o">:</span> <span class="nf">check-mint </span><span class="c">##</span><span class="nf"> 用 XcodeGen 产生 .xcodeproj</span>
 <span class="err">@echo</span> <span class="s2">"🔨 Execute XcodeGen"</span>
 <span class="err">cd</span> <span class="err">$(PRODUCT_FOLDER)</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
 <span class="err">mint</span> <span class="err">run</span> <span class="err">yonaskolb/XcodeGen</span> <span class="err">--quiet</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">PodInstall</span>
<span class="nl">PodInstall</span><span class="o">:</span> <span class="c">##</span><span class="nf"> 安装 CocoaPods 依赖</span>
 <span class="err">@echo</span> <span class="s2">"📦 Installing CocoaPods dependencies..."</span>
 <span class="err">cd</span> <span class="err">$(PRODUCT_FOLDER)</span> <span class="err">&amp;&amp;</span> <span class="err">\</span>
 <span class="err">bundle</span> <span class="err">exec</span> <span class="err">pod</span> <span class="err">install</span>

<span class="c">### Mint
</span><span class="nl">check-mint</span><span class="o">:</span> <span class="nf">check-brew </span><span class="c">##</span><span class="nf"> 检查 Mint 是否安装，没有就自动安装</span>
 <span class="err">@if</span> <span class="err">!</span> <span class="err">command</span> <span class="err">-v</span> <span class="err">mint</span> <span class="err">&amp;&gt;</span> <span class="err">/dev/null;</span> <span class="err">then</span> <span class="err">\</span>
  <span class="err">echo</span> <span class="s2">"🔨 Installing mint..."</span><span class="err">;</span> <span class="err">\</span>
  <span class="err">brew</span> <span class="err">install</span> <span class="err">mint;</span> <span class="err">\</span>
 <span class="err">fi</span>

<span class="c">### Brew
</span><span class="nl">check-brew</span><span class="o">:</span> <span class="c">##</span><span class="nf"> 检查 Homebrew 是否安装，没有就自动安装</span>
 <span class="err">@if</span> <span class="err">!</span> <span class="err">command</span> <span class="err">-v</span> <span class="err">brew</span> <span class="err">&amp;&gt;</span> <span class="err">/dev/null;</span> <span class="err">then</span> <span class="err">\</span>
  <span class="err">echo</span> <span class="s2">"🔨 Installing Homebrew..."</span><span class="err">;</span> <span class="err">\</span>
  <span class="nl">/bin/bash -c "$$(curl -fsSL https</span><span class="o">:</span><span class="nf">//raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; </span>\
<span class="nf"> fi</span>

<span class="c">## Format only git swift files
</span><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">format</span>
<span class="nl">format</span><span class="o">:</span> <span class="nf">check-mint </span><span class="c">##</span><span class="nf"> 格式化 Product/ 下所有 Swift 档</span>
 <span class="err">mint</span> <span class="err">run</span> <span class="err">swiftformat</span> <span class="err">$(PRODUCT_FOLDER)</span>
</pre></table></code></div></div><p>为了避免污染整个系统或其他专案，我们尽可能把 Dependency 套件(e.g. mint, bundle…etc)的路径都改指定在专案目录之下 (再搭配 <code class="language-plaintext highlighter-rouge">.gitignore</code> 排除)。</p><div class="language-scss highlighter-rouge"><div class="code-header"> <span data-label-text="SCSS"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="err">├──</span> <span class="nt">mint</span> <span class="o">(</span><span class="nt">Mint</span> <span class="err">依赖</span><span class="o">)</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="nt">packages</span>
<span class="err">├──</span> <span class="nt">Product</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demo</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demo</span><span class="nc">.xcodeproj</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demo</span><span class="nc">.xcworkspace</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demoSnapshotTests</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demoTests</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">app-ci-cd-github-actions-demoUITests</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="nt">fastlane</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="nt">Pods</span> <span class="o">(</span><span class="nt">Cocoapods</span> <span class="err">依赖</span><span class="o">)</span>
<span class="err">└──</span> <span class="nt">vendor</span> <span class="o">(</span><span class="nt">Bundle</span> <span class="err">依赖</span><span class="o">)</span>
    <span class="err">└──</span> <span class="nt">bundle</span>
</pre></table></code></div></div><p><a href="/assets/4b001d2e8440/1*F1KFntT8bCZzyYm9JahiuA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*F1KFntT8bCZzyYm9JahiuA.webp" alt="make help" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NDkiIGhlaWdodD0iMTQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>make help</p><p><strong>使用 Makefine 的统一专案 Setup 步骤：</strong></p><ol><li><p><code class="language-plaintext highlighter-rouge">git clone repo</code></p><li><p><code class="language-plaintext highlighter-rouge">cd ./repo</code></p><li><p><code class="language-plaintext highlighter-rouge">make setup</code> 安装必要的工具依赖 ( <strong>brew</strong> , <strong>mint</strong> , <strong>bundle</strong> , xcodegen, swiftformat,…)</p><li><p><code class="language-plaintext highlighter-rouge">make install</code> 产生专案 (执行 pod install, xcodegen)</p><li><p>完成</p><li><p>打开、执行专案</p></ol><blockquote><p><strong><em>不管是 CI/CD 或新人 onboard 都是照以上步骤把专案建置起来。</em></strong></p></blockquote><h3 id="本篇-github-actions-cicd-案例"><span class="me-2">本篇 GitHub Actions CI/CD 案例</span><a href="#本篇-github-actions-cicd-案例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>本篇会介绍三个 GitHub Actions CI/CD 工作流程建置案例，大家也可以参考其中的步骤建置符合自己团队工作流程的 CI/CD。</p><ol><li><p>CI — 发 Pull Request 执行单元测试</p><li><p>CD — 打包+部署到 Firebase App Distribution</p><li><p>CI +CD— Nightly Build 执行快照+单元测试+打包+部署到 Firebase App Distribution</p></ol><blockquote><p><em>因 Demo 限制，本文只会串接 打包部署到 Firebase App Distribution，打包到 Testflight 或是 App Store 也是同样步骤只差别在 Fastlane 里的脚本不同，大家可以自行发挥。</em></p></blockquote><h3 id="ci--发-pull-request-执行单元测试"><span class="me-2">CI — 发 Pull Request 执行单元测试</span><a href="#ci--发-pull-request-执行单元测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="流程"><span class="me-2">流程</span><a href="#流程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Develop 分支 <strong>无法直接推送</strong> ，必须发 Pull Request 才能更新；所有 Pull Request <strong>均需 Review 通过加上单元测试通过才能 Merge</strong> 、有新 Commit Push 会重新测试。</p><h4 id="ci-testingyml"><span class="me-2">CI-Testing.yml</span><a href="#ci-testingyml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Repo → Actions → New workflow → set up a workflow yourself。</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
</pre><td class="rouge-code"><pre><span class="c1"># Workflow(Action) 名称</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">CI-Testing</span>

<span class="c1"># Actions Log 的标题名称</span>
<span class="na">run-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[CI-Testing]</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">github.event.pull_request.title</span><span class="nv"> </span><span class="se">\\</span><span class="s">|</span><span class="se">\\</span><span class="s">|</span><span class="nv"> </span><span class="s">github.ref</span><span class="nv"> </span><span class="s">}}"</span>

<span class="c1"># 同个 Concurrency Group 如果有新的 Job 会取消正在跑的</span>
<span class="c1"># 例如 Push Commit 触发的任务还没执行就又 Push Commit 时，会取消前一个任务</span>
<span class="na">concurrency</span><span class="pi">:</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number \\|\\| github.ref }}</span>
  <span class="na">cancel-in-progress</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># 触发事件</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># PR 事件</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="c1"># PR - 开启、重开、有新 Push Commit 时</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">opened</span><span class="pi">,</span> <span class="nv">synchronize</span><span class="pi">,</span> <span class="nv">reopened</span><span class="pi">]</span>
  <span class="c1"># 手动表单触发</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="c1"># 表单 Inputs 栏位</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="c1"># 执行的 Test Fastlane Lane</span>
      <span class="na">TEST_LANE</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Test</span><span class="nv"> </span><span class="s">Lane'</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s1">'</span><span class="s">run_unit_tests'</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">choice</span>
        <span class="na">options</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">run_unit_tests</span>
          <span class="pi">-</span> <span class="s">run_all_tests</span>
  <span class="c1"># 其他 Workflow 呼叫此 Workflow 触发</span>
  <span class="c1"># Nightly Build 会呼叫使用</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
    <span class="c1"># 表单 Inputs 栏位</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="c1"># 执行的 Test Fastlane Lane</span>
      <span class="na">TEST_LANE</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Test</span><span class="nv"> </span><span class="s">Lane'</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s1">'</span><span class="s">run_unit_tests'</span>
        <span class="c1"># workflow_call inputs 不支援 choice</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">BRANCH</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Branch'</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  
<span class="c1"># Job 工作项目</span>
<span class="c1"># Job 会并发执行</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># Job ID</span>
  <span class="na">testing</span><span class="pi">:</span>
    <span class="c1"># Job 名称 (可省略，有设定在 Log 显示比较好读)</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Testing</span>
    
    <span class="c1"># Runner Label - 使用 GitHub Hosted Runner macos-15 来执行工作</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 如果是 Private Repo 需要按计量收费，macOS 机器是最贵的(10倍)，可能跑 10 次就达到 2,000 分钟免费上限</span>
    <span class="c1"># 建议使用 self-hosted Runner</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">macos-15</span>

    <span class="c1"># 设定最长 Timeout 时间，防止异常情况发生时无止尽的等待</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>

    <span class="c1"># use zsh</span>
    <span class="c1"># 可省略，只是我习惯用 zsh，预设是 bash</span>
    <span class="na">defaults</span><span class="pi">:</span>
      <span class="na">run</span><span class="pi">:</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">zsh {0}</span>
          
    <span class="c1"># 工作步骤</span>
    <span class="c1"># 工作步骤会照顺序执行  </span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># git clone 当前专案 &amp; checkout 到执行的分支</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="c1"># Git Large File Storage，我们的测试环境用不到</span>
          <span class="c1"># default: false</span>
          <span class="na">lfs</span><span class="pi">:</span> <span class="kc">false</span>
          
          <span class="c1"># 如果有指定则 Checkout 指定分支，没有则使用预设(当前分支)</span>
          <span class="c1"># 因 on: schedule 事件只能在 main 主分支执行，因此想做 Nightly Build 之类的工作就需要指定分支</span>
          <span class="c1"># e.g. on: schedule -&gt; main 分支，Nightly Build master 分支</span>
          <span class="na">ref</span><span class="pi">:</span> <span class="s">${{ github.event.inputs.BRANCH \\|\\| '' }}</span>

      <span class="c1"># ========== Env Setup Steps ==========</span>
      
      <span class="c1"># 读取专案指定的 XCode 版本</span>
      <span class="c1"># 在后续之中，我们自己手动指定使用的 XCode_x.x.x.app</span>
      <span class="c1"># 而不使用 xcversion，因为 xcversion 已经 sunset 不稳定。 </span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Read .xcode-version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">read_xcode_version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">XCODE_VERSION=$(cat .xcode-version)</span>
          <span class="s">echo "XCODE_VERSION</span><span class="err">:</span> <span class="s">${XCODE_VERSION}"</span>
          <span class="s">echo "xcode_version=${XCODE_VERSION}" &gt;&gt; $GITHUB_OUTPUT</span>

          <span class="s"># 也可以直接在这指定全域 XCode 版本，这样就不用在后续步骤指定 DEVELOPER_DIR</span>
          <span class="s"># 但此指令需要 sudoer 权限，如果是 self-hosted runner 就要确定 runner 执行环境有 sudo 权限</span>
          <span class="s"># sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"</span>

      <span class="c1"># 读取专案指定的 Ruby 版本</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Read .ruby-version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">read_ruby_version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">RUBY_VERSION=$(cat .ruby-version)</span>
          <span class="s">echo "RUBY_VERSION</span><span class="err">:</span> <span class="s">${RUBY_VERSION}"</span>
          <span class="s">echo "ruby_version=${RUBY_VERSION}" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="c1"># 安装或设定 Runner Ruby 版本成专案指定版本</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Ruby</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">ruby/setup-ruby@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">ruby-version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{</span><span class="nv"> </span><span class="s">steps.read_ruby_version.outputs.ruby_version</span><span class="nv"> </span><span class="s">}}"</span>

      <span class="c1"># 可设可不设，原因是之前在 self-hosted 起多个 runner 跑 CI/CD 因为 cocoapods repos 是共用目录</span>
      <span class="c1"># 解决的问题是：有很小的机率会出现在同时 pod install 时拉 cocoapods repos 出现冲突(因为预设都是用) $HOME/.cocoapods/</span>
      <span class="c1"># GitHub Hosted Runner 则不需此设定</span>
      <span class="c1"># - name: Change Cocoapods Repos Folder</span>
      <span class="c1">#   if: contains(runner.labels, 'self-hosted')</span>
      <span class="c1">#   run: \\|</span>
      <span class="c1">#     # 每个 Runner 用自己的 .cocoapods 资料夹，防止资源冲突</span>
      <span class="c1">#     mkdir -p "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/"</span>
      <span class="c1">#     export CP_HOME_DIR="$HOME/.cocoapods-${{ env.RUNNER_NAME }}"</span>
      <span class="c1">#     rm -f "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/repos/cocoapods/.git/index.lock"</span>

      <span class="c1"># ========== Cache Setting Steps ==========</span>
      <span class="c1"># 请注意，就算是 self-hosted，Cache 目前也是 Cloud Cache 会计算用量</span>
      <span class="c1"># 规则：7 天未 hit 自动删除、单个 Cache 上限 10 GB、Action 成功才会 Cache</span>
      <span class="c1"># Public Repo: 免费无限制</span>
      <span class="c1"># Private Repo: 5 GB 起</span>
      <span class="c1"># Self-hosted 可以自己用 shell script 撰写 Cache &amp; Restore 策略或使用其他工具协助</span>
      
      <span class="c1"># Bundle Cache (Gemfile)</span>
      <span class="c1"># 对应 Makefile 中我们指定了 Bundle  安装路径 ./vendor 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache Bundle</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">./vendor</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-bundle-</span>

      <span class="c1"># CocoaPods Cache (Podfile)</span>
      <span class="c1"># 默认就是 专案/Pods 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache CocoaPods</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">./Product/Pods</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-cocoapods-</span>

      <span class="c1"># Mint cache</span>
      <span class="c1"># 对应 Makefile 中我们指定的 Mint 安装路径 ./mint 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache Mint</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./mint</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-mint-</span>

      <span class="c1"># ====================</span>

      <span class="c1"># 专案 Setup &amp; 依赖安装</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup &amp; Install Dependency</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s"># 执行 Makefile 中封装的 Setup 指令，对应成指令大概是：</span>
          <span class="s"># brew install mint</span>
          <span class="s"># bundle config set path 'vendor/bundle'</span>
          <span class="s"># bundle install</span>
          <span class="s"># mint bootstrap</span>
          <span class="s"># ...</span>
          <span class="s"># 等等 setup 指令</span>
          <span class="s">make setup</span>

          <span class="s"># 执行 Makefile 中封装的 Install 指令，对应成指令大概是：</span>
          <span class="s"># mint run yonaskolb/XcodeGen --quiet</span>
          <span class="s"># bundle exec pod install</span>
          <span class="s"># ...</span>
          <span class="s"># 等等 install 指令</span>
          <span class="s">make install</span>

      <span class="c1"># 执行 Fastlane Unit 测试 Lane</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Tests</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">testing</span>
        <span class="c1"># 指定工作目录，这样后续指令就不用在特别 cd ./Product/</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./Product/</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="c1"># 测试计划，全跑还是只跑单元测试</span>
          <span class="c1"># 如为开 PR 触发则使用 run_unit_tests，否则看 inputs.TEST_LANE 的值，预设值 run_all_tests</span>
          <span class="na">TEST_LANE</span><span class="pi">:</span> <span class="s">${{ github.event_name == 'pull_request' &amp;&amp; 'run_unit_tests' \\|\\| github.event.inputs.TEST_LANE \\|\\| 'run_all_tests' }}</span>
          
          <span class="c1"># 指定这个 Job 要使用 XCode_x.x.x 指定的版本执行</span>
          <span class="na">DEVELOPER_DIR</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/Applications/Xcode_${{</span><span class="nv"> </span><span class="s">steps.read_xcode_version.outputs.xcode_version</span><span class="nv"> </span><span class="s">}}.app/Contents/Developer"</span>
          
          <span class="c1"># Repo -&gt; Settings -&gt; Actions secrets and variables -&gt; variables</span>
          <span class="c1"># 使用的模拟器名称</span>
          <span class="na">SIMULATOR_NAME</span><span class="pi">:</span> <span class="s">${{ vars.SIMULATOR_NAME }}</span>
          <span class="c1"># 模拟器的 iOS 版本</span>
          <span class="na">SIMULATOR_IOS_VERSION</span><span class="pi">:</span> <span class="s">${{ vars.SIMULATOR_IOS_VERSION }}</span>

          <span class="c1"># 当前 Runner 名称</span>
          <span class="na">RUNNER_NAME</span><span class="pi">:</span> <span class="s">${{ runner.name }}</span>
          
          <span class="c1"># 提升 XCodebuild 指令 timeout 时间, retry 次数</span>
          <span class="c1"># 因为机器 Loading 比较大的时候可能 3 次就失败了</span>
          <span class="na">FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT</span><span class="pi">:</span> <span class="m">60</span>
          <span class="na">FASTLANE_XCODEBUILD_SETTINGS_RETRIES</span><span class="pi">:</span> <span class="m">10</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>

          <span class="s"># 如果是 self-hosted 在同一台机器起多个 Runner 会出现抢模拟器的问题 (文章后会讲)</span>
          <span class="s"># 要避免这问题建议将模拟名称命名成 Runner 名称，每个 Runner 都设一个模拟器，这样就不会互抢导致测试失败</span>
          <span class="s"># e.g. bundle exec fastlane run_unit_tests device:"${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})"</span>
          <span class="s"># 这边是用 GitHub Hosted Runner 没这问题，所以直接用 device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})"</span>

          <span class="s"># 发生错误不直接退出并将所有输出都写入 temp/testing_output.txt 档案</span>
          <span class="s"># 后续我们会分析档案内容区分出是 Build Failed 还是 Test Failed，Comment 不同讯息到 PR</span>
          <span class="s">set +e</span>
          
          <span class="s"># EXIT_CODE 储存执行结果的 exit code.</span>
          <span class="s"># 0 = OK</span>
          <span class="s"># 1 = exit</span>
          <span class="s">EXIT_CODE=0</span>
          
          <span class="s"># 所有输出都写入档案</span>
          <span class="s">bundle exec fastlane ${TEST_LANE} device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})" \\| tee "$RUNNER_TEMP/testing_output.txt"</span>
          <span class="s"># 如果目前 EXIT_CODE 是 0，则将 ${pipestatus[1]} 赋值给 EXIT_CODE</span>
          <span class="s">[[ $EXIT_CODE -eq 0 ]] &amp;&amp; EXIT_CODE=${pipestatus[1]}</span>

          <span class="s"># 恢复出错就退出</span>
          <span class="s">set -e</span>

          <span class="s"># 检查 Testing Output</span>
          <span class="s"># 如果 Testing Output 包含 "Error building"，则设 is_build_error=true 给 Actions 环境变数，为 Build 就失败</span>
          <span class="s"># 如果 Testing Output 包含 "Tests have failed"，则设 is_test_error=true 给 Actions 环境变数，为测试失败</span>
          
          <span class="s">if grep -q "Error building" "$RUNNER_TEMP/testing_output.txt"; then</span>
            <span class="s">echo "is_build_error=true" &gt;&gt; $GITHUB_OUTPUT</span>
            <span class="s">echo "❌ Detected Build Error"</span>
          <span class="s">elif grep -q "Tests have failed" "$RUNNER_TEMP/testing_output.txt"; then</span>
            <span class="s">echo "is_test_error=true" &gt;&gt; $GITHUB_OUTPUT</span>
            <span class="s">echo "❌ Detected Test Error"</span>
          <span class="s">fi</span>

          <span class="s"># 恢复 Exit Code Output</span>
          <span class="s">exit $EXIT_CODE</span>
          
      <span class="c1"># ========== Handle Result Steps ==========</span>
      
      <span class="c1"># 解析 *.junit 测试报告，并标记结果、Comment(如果是 PR 的话)</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Publish Test Report</span>
        <span class="c1"># 直接复用别人写好的 .junit Paser Actions: https://github.com/mikepenz/action-junit-report</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">mikepenz/action-junit-report@v5</span>
        <span class="c1"># if:</span>
        <span class="c1"># 上一步(Testing) success or</span>
        <span class="c1"># 上一步(Testing) failed and is_test_error (build failed 不执行这个 step)</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">${{ (failure() &amp;&amp; steps.testing.outputs.is_test_error == 'true') \\|\\| success() }}</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">check_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Testing</span><span class="nv"> </span><span class="s">Report"</span>
          <span class="na">comment</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">updateComment</span><span class="pi">:</span> <span class="kc">false</span>
          <span class="na">require_tests</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">detailed_summary</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">report_paths</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./Product/fastlane/test_output/*.junit"</span>

      <span class="c1"># 测试建置失败 Comment</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build Failure Comment</span>
        <span class="c1"># if:</span>
        <span class="c1"># 上一步(Testing) failed and is_build_error and 有 PR Number</span>
        <span class="c1"># </span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">${{ failure() &amp;&amp; steps.testing.outputs.is_build_error == 'true' &amp;&amp; github.event.pull_request.number }}</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">action_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{</span><span class="nv"> </span><span class="s">github.server_url</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">github.repository</span><span class="nv"> </span><span class="s">}}/actions/runs/${{</span><span class="nv"> </span><span class="s">github.run_id</span><span class="nv"> </span><span class="s">}}/attempts/${{</span><span class="nv"> </span><span class="s">github.run_attempt</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">with</span><span class="pi">:</span>
            <span class="na">script</span><span class="pi">:</span> <span class="s">\\|</span>
              <span class="s">const action_url = process.env.action_url</span>
              <span class="s">const pullRequest = context.payload.pull_request \\|\\| {}</span>
              <span class="s">const commitSha = pullRequest.head?.sha \\|\\| context.sha</span>
              <span class="s">const creator = pullRequest.user?.login \\|\\| context.actor</span>
        
              <span class="s">const commentBody = [</span>
                <span class="s">`# 专案或测试建置失败 ❌`,</span>
                <span class="s">`请确认您的 Pull Request 是否可以正确编译与执行测试。`,</span>
                <span class="s">``,</span>
                <span class="s">`🔗 **Action**</span><span class="err">:</span> <span class="pi">[</span><span class="nv">View Workflow Run</span><span class="pi">]</span><span class="s">(${action_url})`,</span>
                <span class="s">`📝 **Commit**</span><span class="err">:</span> <span class="s">${commitSha}`,</span>
                <span class="s">`👤 **Author**</span><span class="err">:</span> <span class="err">@</span><span class="s">${creator}`</span>
              <span class="s">].join('\n')</span>
        
              <span class="s">await github.rest.issues.createComment({</span>
                <span class="s">owner</span><span class="err">:</span> <span class="s">context.repo.owner,</span>
                <span class="s">repo</span><span class="err">:</span> <span class="s">context.repo.repo,</span>
                <span class="s">issue_number</span><span class="err">:</span> <span class="s">context.payload.pull_request.number,</span>
                <span class="s">body</span><span class="err">:</span> <span class="s">commentBody</span>
              <span class="s">})</span>
</pre></table></code></div></div><p><strong>技术重点说明：</strong></p><ul><li><p>runs-on: 建议改用 self-hosted Runner， <a href="https://docs.github.com/en/billing/managing-billing-for-your-products/about-billing-for-github-actions#per-minute-rates" target="_blank">GitHub Hosted Runner macOS 很贵的</a> 。</p><li><p>手动读取 <code class="language-plaintext highlighter-rouge">.xcode-version</code> 档案取得指定的 XCode 版本并在需要指定 XCode 的 Step 设定 <code class="language-plaintext highlighter-rouge">DEVELOPER_DIR</code> env 可以轻松免 Sudo 切换 XCode</p><li><p>Cache: 可以加速依赖安装速度，但需注意就算是 self-hosted Runner 依然会使用 GitHub Cloud Cache，受到收费限制</p><li><p>使用 <code class="language-plaintext highlighter-rouge">set +e</code> 使指令执行失败不会马上退出+将 output 都输出到档案+读取档案判断是 Build Failed or Test Failed；如果不这样做讯息统一都会是 Test Failed。 也可以延伸去判断其他错误，例如： <code class="language-plaintext highlighter-rouge">Underlying Error: Unable to boot the Simulator.</code> 模拟器启动失败，请重新尝试。</p><li><p>Checkout Code 可接受指定分支：因为 <code class="language-plaintext highlighter-rouge">on: schedule</code> 事件只能在 main (Default Branch) 触发，如果我们希望排程对某个其他分支操作，就需要指定分支。</p><li><p>指定 .cocoapods Repo 路径可做可不做，之前是遇过 self-hosted 同一台机器两个 Runner 同时卡在 pod install 就是因为刚好都在针对 .cocoapods Repo 操作造成 git lock。 (但机率很低就是了)</p><li><p><strong>如果你有 Private Pods Repo 需要设定 SSH Agent 才有权限 Clone。</strong> <strong>(请参考文末补充)</strong></p><li><p>记得到 Repo -&gt; Settings -&gt; Actions secrets and variables -&gt; variables 新增： <code class="language-plaintext highlighter-rouge">SIMULATOR_IOS_VERSION</code> 模拟器 iOS 版本 <code class="language-plaintext highlighter-rouge">SIMULATOR_NAME</code> 模拟器名称</p></ul><p><a href="/assets/4b001d2e8440/1*Vj37P9vZ6KL5wWNvU3Cq3Q.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Vj37P9vZ6KL5wWNvU3Cq3Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTU2IiBoZWlnaHQ9IjU0OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>Commit 档案到 Repo 主分支，手动触发一次验证正不正确：</strong></p><p><a href="/assets/4b001d2e8440/1*tA2nKehTJ7aURSGgU7MM0g.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*tA2nKehTJ7aURSGgU7MM0g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjQ4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/4b001d2e8440/1*Qap3KmhIJrLov2O7GneV3w.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Qap3KmhIJrLov2O7GneV3w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMxIiBoZWlnaHQ9IjkxMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>正确后继续设定。</p><h4 id="github-流程设定"><span class="me-2">GitHub 流程设定</span><a href="#github-流程设定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Repo → Settins → Rules → Rulesets。</p><p><a href="/assets/4b001d2e8440/1*cf_M6NnakdcbzvC2VHSfpw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*cf_M6NnakdcbzvC2VHSfpw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAyIiBoZWlnaHQ9Ijk2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p>Ruleset Name: 规则名称</p><li><p>Enforcement status: 启用/停用 此规则限制</p><li><p>Target branches: 目标的 Base 分支，设 Default Branch 就是所有想合进到 main or develop 的分支都受到此规则限制</p><li><p>Bypass list: 可指定特殊身份、Team 可以不受此限</p><li><p>Branch rules:</p></ul><p><a href="/assets/4b001d2e8440/1*Hzd9CCTsu18kyDR1goRWag.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Hzd9CCTsu18kyDR1goRWag.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3OTIiIGhlaWdodD0iMTIwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p>Restrict deletions: 禁止删除分支</p><li><p>Require a pull request before mergin: 只能透过 PR Merge Required approvals: 限制需要几人 Approve</p><li><p>Require status checks to pass: 限制哪些 Checks 要 Passed 才能 Merge 点 + Add checks 输入 <code class="language-plaintext highlighter-rouge">Testing</code> 选择有 GitHub Actions 标志的。 <strong>这边有个小问题，如果 Suggestions</strong> <strong>找不到 <code class="language-plaintext highlighter-rouge">Testing</code> 那需要先回到 Actions 触发(开 PR 试试)成功一次，这里才会出现。</strong></p></ul><p><a href="/assets/4b001d2e8440/1*MRPwUEVVbbz8nH0sS2hFfQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*MRPwUEVVbbz8nH0sS2hFfQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MzQiIGhlaWdodD0iMzk0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>Block force pushes: 禁止 Force push</ul><p>储存、确定 Enforcement status 是 Active 后，规则就会生效了。</p><p><strong>都设定好之后，开 PR 测试看看：</strong></p><p><a href="/assets/4b001d2e8440/1*iPETBWx6Boq12rY1fHXmuQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*iPETBWx6Boq12rY1fHXmuQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MTkiIGhlaWdodD0iNTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>Checks 有出现 CI-Testing ( <strong>Requried</strong> )、Merging is blocked、At least X approving review is required by reviewers with write access. 代表设置成功了。</ul><p><strong>如果专案建置失败 (Build Failed) 会 Comment：</strong></p><p><a href="/assets/4b001d2e8440/1*4E35VRPo--pI8uqrR4UZNA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*4E35VRPo--pI8uqrR4UZNA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MTUiIGhlaWdodD0iMjk1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>如果专案建置成功但测试案例失败 (Test Failed) 会 Comment：</strong></p><p><a href="/assets/4b001d2e8440/1*wYFzsn5a_yvi8CbZxi-QdQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*wYFzsn5a_yvi8CbZxi-QdQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MjEiIGhlaWdodD0iMzg5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>如果专案建置成功测试也成功(Test Success) 会 Comment：</strong></p><p><a href="/assets/4b001d2e8440/1*WqPK1629jYdYTEWCWBHWqg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*WqPK1629jYdYTEWCWBHWqg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MTUiIGhlaWdodD0iMzIxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>完成 Review Approve + Check 测试通过后：</strong></p><p><a href="/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*5gnQYdVAOtGR-bMK4ZrOhA.webp" alt="[Demo PR](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MTEiIGhlaWdodD0iNTY2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/pull/11" target="_blank">Demo PR</a></p><p>就能 Merge PR。</p><ul><li>如果有 Push New Commit 会自动重跑 Checks 测试。</ul><p><strong>完整程式码： <a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/blob/main/.github/workflows/CI-Testing.yml" target="_blank">CI-Testing.yml</a></strong></p><p><strong>Auto-merge:</strong></p><p>另外，也可以打开 Repo Settings → General → Pull Request 中的：</p><p><a href="/assets/4b001d2e8440/1*hl6mfqnnv_zAA3YVrI_M0w.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*hl6mfqnnv_zAA3YVrI_M0w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NTYiIGhlaWdodD0iMjU3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p>Automatically delete head branches: Merge PR 后自动删除分支</p><li><p>Allow Auto-merge: 当 Checks 通过＋符合条件的 Approvals 达成会自动 Merge PR <strong>只有当有设条件＋当前条件还不能 Merge 时才会出现 Enable auto-merge 按钮。</strong></p></ul><p><a href="/assets/4b001d2e8440/1*gi0LaaMVXit-DGKnsxS1lQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*gi0LaaMVXit-DGKnsxS1lQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MjciIGhlaWdodD0iNDMxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="cd--打包部署到-firebase-app-distribution"><span class="me-2">CD — 打包+部署到 Firebase App Distribution</span><a href="#cd--打包部署到-firebase-app-distribution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="流程-1"><span class="me-2">流程</span><a href="#流程-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>使用 GitHub Actions 表单触发打包工作，可指定版本号、Release Notes，打包完会自动上传到 Firebase App Distribution 供团队下载测试使用。</p><h4 id="cd-deployyml"><span class="me-2">CD-Deploy.yml</span><a href="#cd-deployyml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Repo → Actions → New workflow → set up a workflow yourself。</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
</pre><td class="rouge-code"><pre><span class="c1"># Workflow(Action) 名称</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">CD-Deploy</span>

<span class="c1"># Actions Log 的标题名称</span>
<span class="na">run-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[CD-Deploy]</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">github.ref</span><span class="nv"> </span><span class="s">}}"</span>

<span class="c1"># 同个 Concurrency Group 如果有新的 Job 会取消正在跑的</span>
<span class="c1"># 例如 重复触发相同分支的打包任务，会取消前一个任务</span>
<span class="na">concurrency</span><span class="pi">:</span>
  <span class="na">group</span><span class="pi">:</span> <span class="s">${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}</span>
  <span class="na">cancel-in-progress</span><span class="pi">:</span> <span class="kc">true</span>

<span class="c1"># 触发事件</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># 手动表单触发</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="c1"># 表单 Inputs 栏位</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="c1"># App 版本号</span>
      <span class="na">VERSION_NUMBER</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Version</span><span class="nv"> </span><span class="s">Number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">app</span><span class="nv"> </span><span class="s">(e.g.,</span><span class="nv"> </span><span class="s">1.0.0).</span><span class="nv"> </span><span class="s">Auto-detect</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Xcode</span><span class="nv"> </span><span class="s">project</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">left</span><span class="nv"> </span><span class="s">blank.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="c1"># App Build Number</span>
      <span class="na">BUILD_NUMBER</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">app</span><span class="nv"> </span><span class="s">(e.g.,</span><span class="nv"> </span><span class="s">1).</span><span class="nv"> </span><span class="s">Will</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">timestamp</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">left</span><span class="nv"> </span><span class="s">blank.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="c1"># App Release Note</span>
      <span class="na">RELEASE_NOTE</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release</span><span class="nv"> </span><span class="s">notes</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">deployment.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="c1"># 其他 Workflow 呼叫此 Workflow 触发</span>
  <span class="c1"># Nightly Build 会呼叫使用</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="c1"># App 版本号</span>
      <span class="na">VERSION_NUMBER</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Version</span><span class="nv"> </span><span class="s">Number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">app</span><span class="nv"> </span><span class="s">(e.g.,</span><span class="nv"> </span><span class="s">1.0.0).</span><span class="nv"> </span><span class="s">Auto-detect</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Xcode</span><span class="nv"> </span><span class="s">project</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">left</span><span class="nv"> </span><span class="s">blank.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="c1"># App Build Number</span>
      <span class="na">BUILD_NUMBER</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Build</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">app</span><span class="nv"> </span><span class="s">(e.g.,</span><span class="nv"> </span><span class="s">1).</span><span class="nv"> </span><span class="s">Will</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">timestamp</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">left</span><span class="nv"> </span><span class="s">blank.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="c1"># App Release Note</span>
      <span class="na">RELEASE_NOTE</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release</span><span class="nv"> </span><span class="s">notes</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">deployment.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">BRANCH</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Branch'</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>


<span class="c1"># 定义全域静态变数</span>
<span class="na">env</span><span class="pi">:</span>
  <span class="na">APP_STORE_CONNECT_API_KEY_FILE_NAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">app_store_connect_api_key.json"</span>

<span class="c1"># Job 工作项目</span>
<span class="c1"># Job 会并发执行</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># Job ID</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="c1"># Job 名称 (可省略，有设定在 Log 显示比较好读)</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy - Firebase App Distribution</span>
    
    <span class="c1"># Runner Label - 使用 GitHub Hosted Runner macos-15 来执行工作</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 请注意：因为此专案是 Public Repo 可以无限免费使用</span>
    <span class="c1"># 如果是 Private Repo 需要按计量收费，macOS 机器是最贵的(10倍)，可能跑 10 次就达到 2,000 分钟免费上限</span>
    <span class="c1"># 建议使用 self-hosted Runner</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">macos-15</span>

    <span class="c1"># 设定最长 Timeout 时间，防止异常情况发生时无止尽的等待</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>

    <span class="c1"># use zsh</span>
    <span class="c1"># 可省略，只是我习惯用 zsh，预设是 bash</span>
    <span class="na">defaults</span><span class="pi">:</span>
      <span class="na">run</span><span class="pi">:</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">zsh {0}</span>

    <span class="c1"># 工作步骤</span>
    <span class="c1"># 工作步骤会照顺序执行  </span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># git clone 当前专案 &amp; checkout 到执行的分支</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout repository</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="c1"># Git Large File Storage，我们的测试环境用不到</span>
          <span class="c1"># default: false</span>
          <span class="na">lfs</span><span class="pi">:</span> <span class="kc">false</span>
          
          <span class="c1"># 如果有指定则 Checkout 指定分支，没有则使用预设(当前分支)</span>
          <span class="c1"># 因 on: schedule 事件只能在 main 主分支执行，因此想做 Nightly Build 之类的工作就需要指定分支</span>
          <span class="c1"># e.g. on: schedule -&gt; main 分支，Nightly Build master 分支</span>
          <span class="na">ref</span><span class="pi">:</span> <span class="s">${{ github.event.inputs.BRANCH \\|\\| '' }}</span>

      <span class="c1"># ========== Certificates Steps ==========</span>
      
      <span class="c1"># 建议是使用 Fastlnae - Match 管理开发凭证并在 Lane 中直接执行 match 安装设定好</span>
      <span class="c1"># Match 会用另一个 Private Repo 管理凭证，但要设定好 SSH Agent 才有权限 git clone private repo</span>
      <span class="c1"># ref: https://stackoverflow.com/questions/57612428/cloning-private-github-repository-within-organisation-in-actions</span>
      <span class="c1">#</span>
      <span class="c1">#</span>
      <span class="c1"># --- 以下是没有使用 Fastlane - Match 的情况下直接下载 &amp; Import 凭证给 Runner 的做法 ---</span>
      <span class="c1"># ref: https://docs.github.com/en/actions/how-tos/use-cases-and-examples/deploying/installing-an-apple-certificate-on-macos-runners-for-xcode-development</span>
      <span class="c1">#</span>
      <span class="c1"># GitHub Actions Secret 无法储存档案，因此所有凭证档案都要先转成 Base64 Encoded 文字格式存在 Secret</span>
      <span class="c1"># 在 GitHub Actions Step 中再动态读出来写入 TEMP 档案并移动到正确位置给系统读取使用</span>
      <span class="c1"># 其他设定细节请参考文章</span>
      <span class="c1">#</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install the Apple certificate and provisioning profile</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">BUILD_CERTIFICATE_BASE64</span><span class="pi">:</span> <span class="s">${{ secrets.BUILD_CERTIFICATE_BASE64 }}</span>
          <span class="na">P12_PASSWORD</span><span class="pi">:</span> <span class="s">${{ secrets.BUILD_CERTIFICATE_P12_PASSWORD }}</span>
          <span class="na">BUILD_PROVISION_PROFILE_BASE64</span><span class="pi">:</span> <span class="s">${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}</span>
          <span class="c1"># GitHub Hosted Runner 为自定义字串</span>
          <span class="c1"># Self-hosted Runner 为机器登入密码</span>
          <span class="na">KEYCHAIN_PASSWORD</span><span class="pi">:</span> <span class="s">${{ secrets.KEYCHAIN_PASSWORD }}</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s"># create variables</span>
          <span class="s">CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12</span>
          <span class="s">PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision</span>
          <span class="s">KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db</span>

          <span class="s"># import certificate and provisioning profile from secrets</span>
          <span class="s">echo -n "$BUILD_CERTIFICATE_BASE64" \\| base64 --decode -o $CERTIFICATE_PATH</span>
          <span class="s">echo -n "$BUILD_PROVISION_PROFILE_BASE64" \\| base64 --decode -o $PP_PATH</span>

          <span class="s"># create temporary keychain</span>
          <span class="s">security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH</span>
          <span class="s">security set-keychain-settings -lut 21600 $KEYCHAIN_PATH</span>
          <span class="s">security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH</span>

          <span class="s"># import certificate to keychain</span>
          <span class="s">security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH</span>
          <span class="s">security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH</span>
          <span class="s">security list-keychain -d user -s $KEYCHAIN_PATH</span>

          <span class="s"># apply provisioning profile</span>
          <span class="s">mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles</span>
          <span class="s">cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles</span>

      <span class="c1"># App Store Connect API Fastlane JSON Key</span>
      <span class="c1"># 另一个在打包环境几乎是必须的 App Store Connect API Fastlane JSON Key (.json)</span>
      <span class="c1"># format: .json 内容格式：https://docs.fastlane.tools/app-store-connect-api/</span>
      <span class="c1"># 里面包含 App Store Connect API .p8 Key</span>
      <span class="c1"># 会在后续带给 Fastlane，用于上传到 Testflight、App Store API 使用</span>
      <span class="c1">#</span>
      <span class="c1"># GitHub Actions Secret 无法储存档案，因此所有凭证档案都要先转成 Base64 Encoded 文字格式存在 Secret</span>
      <span class="c1"># 在 GitHub Actions Step 中再动态读出来写入 TEMP 档案供其他步骤引用使用</span>
      <span class="c1"># 其他设定细节请参考文章</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Read and Write Apple Store Connect API Key to Temp</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">APP_STORE_CONNECT_API_KEY_BASE64</span><span class="pi">:</span> <span class="s">${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}</span>
          <span class="na">APP_STORE_CONNECT_API_KEY_PATH</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{</span><span class="nv"> </span><span class="s">runner.temp</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">env.APP_STORE_CONNECT_API_KEY_FILE_NAME</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s"># import certificate and provisioning profile from secrets</span>
          <span class="s">echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" \\| base64 --decode -o $APP_STORE_CONNECT_API_KEY_PATH</span>

      <span class="c1"># ========== Env Setup Steps ==========</span>
      
      <span class="c1"># 读取专案指定的 XCode 版本</span>
      <span class="c1"># 在后续之中，我们自己手动指定使用的 XCode_x.x.x.app</span>
      <span class="c1"># 而不使用 xcversion，因为 xcversion 已经 sunset 不稳定。 </span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Read .xcode-version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">read_xcode_version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">XCODE_VERSION=$(cat .xcode-version)</span>
          <span class="s">echo "XCODE_VERSION</span><span class="err">:</span> <span class="s">${XCODE_VERSION}"</span>
          <span class="s">echo "xcode_version=${XCODE_VERSION}" &gt;&gt; $GITHUB_OUTPUT</span>

          <span class="s"># 也可以直接在这指定全域 XCode 版本，这样就不用在后续步骤指定 DEVELOPER_DIR</span>
          <span class="s"># 但此指令需要 sudoer 权限，如果是 self-hosted runner 就要确定 runner 执行环境有 sudo 权限</span>
          <span class="s"># sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"</span>

      <span class="c1"># 读取专案指定的 Ruby 版本</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Read .ruby-version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">read_ruby_version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">RUBY_VERSION=$(cat .ruby-version)</span>
          <span class="s">echo "RUBY_VERSION</span><span class="err">:</span> <span class="s">${RUBY_VERSION}"</span>
          <span class="s">echo "ruby_version=${RUBY_VERSION}" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="c1"># 安装或设定 Runner Ruby 版本成专案指定版本</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Ruby</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">ruby/setup-ruby@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">ruby-version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{</span><span class="nv"> </span><span class="s">steps.read_ruby_version.outputs.ruby_version</span><span class="nv"> </span><span class="s">}}"</span>

      <span class="c1"># 可设可不设，原因是之前在 self-hosted 起多个 runner 跑 CI/CD 因为 cocoapods repos 是共用目录</span>
      <span class="c1"># 解决的问题是：有很小的机率会出现在同时 pod install 时拉 cocoapods repos 出现冲突(因为预设都是用) $HOME/.cocoapods/</span>
      <span class="c1"># GitHub Hosted Runner 则不需此设定</span>
      <span class="c1"># - name: Change Cocoapods Repos Folder</span>
      <span class="c1">#   if: contains(runner.labels, 'self-hosted')</span>
      <span class="c1">#   run: \\|</span>
      <span class="c1">#     # 每个 Runner 用自己的 .cocoapods 资料夹，防止资源冲突</span>
      <span class="c1">#     mkdir -p "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/"</span>
      <span class="c1">#     export CP_HOME_DIR="$HOME/.cocoapods-${{ env.RUNNER_NAME }}"</span>
      <span class="c1">#     rm -f "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/repos/cocoapods/.git/index.lock"</span>

      <span class="c1"># ========== Cache Setting Steps ==========</span>
      <span class="c1"># 请注意，就算是 self-hosted，Cache 目前也是 Cloud Cache 会计算用量</span>
      <span class="c1"># 规则：7 天未 hit 自动删除、单个 Cache 上限 10 GB、Action 成功才会 Cache</span>
      <span class="c1"># Public Repo: 免费无限制</span>
      <span class="c1"># Private Repo: 5 GB 起</span>
      <span class="c1"># Self-hosted 可以自己用 shell script 撰写 Cache &amp; Restore 策略或使用其他工具协助</span>
      
      <span class="c1"># Bundle Cache (Gemfile)</span>
      <span class="c1"># 对应 Makefile 中我们指定了 Bundle  安装路径 ./vendor 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache Bundle</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">./vendor</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-bundle-</span>

      <span class="c1"># CocoaPods Cache (Podfile)</span>
      <span class="c1"># 默认就是 专案/Pods 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache CocoaPods</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">./Product/Pods</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-cocoapods-</span>

      <span class="c1"># Mint cache</span>
      <span class="c1"># 对应 Makefile 中我们指定的 Mint 安装路径 ./mint 下</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache Mint</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./mint</span>
          <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}</span>
          <span class="na">restore-keys</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">${{ runner.os }}-mint-</span>

      <span class="c1"># ====================</span>

      <span class="c1"># 专案 Setup &amp; 依赖安装</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup &amp; Install Dependency</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s"># 执行 Makefile 中封装的 Setup 指令，对应成指令大概是：</span>
          <span class="s"># brew install mint</span>
          <span class="s"># bundle config set path 'vendor/bundle'</span>
          <span class="s"># bundle install</span>
          <span class="s"># mint bootstrap</span>
          <span class="s"># ...</span>
          <span class="s"># 等等 setup 指令</span>
          <span class="s">make setup</span>

          <span class="s"># 执行 Makefile 中封装的 Install 指令，对应成指令大概是：</span>
          <span class="s"># mint run yonaskolb/XcodeGen --quiet</span>
          <span class="s"># bundle exec pod install</span>
          <span class="s"># ...</span>
          <span class="s"># 等等 install 指令</span>
          <span class="s">make install</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Beta</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">deploy</span>
        <span class="c1"># 指定工作目录，这样后续指令就不用在特别 cd ./Product/</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./Product/</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="c1"># 打包 Input 参数</span>
          <span class="na">VERSION_NUMBER</span><span class="pi">:</span> <span class="s">${{ inputs.VERSION_NUMBER \\|\\| '' }}</span>
          <span class="na">BUILD_NUMBER</span><span class="pi">:</span> <span class="s">${{ inputs.BUILD_NUMBER \\|\\| '' }}</span>
          <span class="na">RELEASE_NOTE</span><span class="pi">:</span> <span class="s">${{ inputs.RELEASE_NOTE \\|\\| '' }}</span>
          <span class="na">AUTHOR</span><span class="pi">:</span> <span class="s">${{ github.actor }}</span>

          <span class="c1"># Repo -&gt; Settings -&gt; Actions secrets and variables -&gt; secrets</span>
          <span class="c1"># Firebase CLI Token 密钥 (取得方式请参考文章)</span>
          <span class="na">FIREBASE_CLI_TOKEN</span><span class="pi">:</span> <span class="s">${{ secrets.FIREBASE_CLI_TOKEN }}</span>
          <span class="c1"># Apple Developer Program Team ID</span>
          <span class="na">TEAM_ID</span><span class="pi">:</span> <span class="s">${{ secrets.TEAM_ID }}</span>
                    
          <span class="c1"># 指定这个 Job 要使用 XCode_x.x.x 指定的版本执行</span>
          <span class="na">DEVELOPER_DIR</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/Applications/Xcode_${{</span><span class="nv"> </span><span class="s">steps.read_xcode_version.outputs.xcode_version</span><span class="nv"> </span><span class="s">}}.app/Contents/Developer"</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s"># 取得当前 Timestamp</span>
          <span class="s">BUILD_TIMESTAMP=$(date +'%Y%m%d%H%M%S')</span>

          <span class="s"># 如果 BUILD_NUMBER 没有值，用 Timestamp 当 App Build Number</span>
          <span class="s">BUILD_NUMBER="${BUILD_NUMBER:-$BUILD_TIMESTAMP}"</span>
  
          <span class="s">ID="${{ github.run_id }}"</span>
          <span class="s">COMMIT_SHA="${{ github.sha }}"</span>
          <span class="s">BRANCH_NAME="${{ github.ref_name }}"</span>
          <span class="s">AUTHOR="${{ env.AUTHOR }}"</span>

          <span class="s"># 组合 Release Note</span>
          <span class="s">RELEASE_NOTE="${{ env.RELEASE_NOTE }}</span>
          <span class="s">ID</span><span class="err">:</span> <span class="s">${ID}</span>
          <span class="s">Commit SHA</span><span class="err">:</span> <span class="s">${COMMIT_SHA}</span>
          <span class="s">Branch</span><span class="err">:</span> <span class="s">${BRANCH_NAME}</span>
          <span class="s">Author</span><span class="err">:</span> <span class="s">${AUTHOR}</span>
          <span class="s">"</span>

          <span class="s"># 执行 Fastlane 打包＆部署 Lane</span>
          <span class="s">bundle exec fastlane beta release_notes:"${RELEASE_NOTE}" version_number:"${VERSION_NUMBER}" build_number:"${BUILD_NUMBER}"</span>

      <span class="c1"># GitHub Actions 建议的 self-hosted 安全性设定：</span>
      <span class="c1"># ref: https://docs.github.com/en/actions/how-tos/use-cases-and-examples/deploying/installing-an-apple-certificate-on-macos-runners-for-xcode-development#required-clean-up-on-self-hosted-runners</span>
      <span class="c1"># 对应 Step: Install the Apple certificate and provisioning profile</span>
      <span class="c1"># 用途是删除机器上下载下来的金钥凭证</span>
      <span class="c1"># 如果你是用 Match 则需要改写成 Match 的 Clean</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Clean up keychain and provisioning profile</span>
        <span class="na">if</span><span class="pi">:</span> <span class="s">${{ always() &amp;&amp; contains(runner.labels, 'self-hosted') }}</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">security delete-keychain $RUNNER_TEMP/app-signing.keychain-db</span>
          <span class="s">rm ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision</span>
</pre></table></code></div></div><ul><li>记得到 Repo -&gt; Settings -&gt; Actions secrets and variables -&gt; secrets 新增一个 <code class="language-plaintext highlighter-rouge">TEAM_ID</code> 变数，内容是 Apple Developer Team ID 字串。</ul><p><a href="/assets/4b001d2e8440/1*dxdmT_N_w_VUd56f6GRLSQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*dxdmT_N_w_VUd56f6GRLSQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTgxIiBoZWlnaHQ9IjQ5OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>Commit 档案到 Repo 主分支，测试看看打包功能：</strong></p><p><a href="/assets/4b001d2e8440/1*Z_UAfWAsJSIoWxeTRMvtDQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Z_UAfWAsJSIoWxeTRMvtDQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDcyIiBoZWlnaHQ9IjY4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p><em>请注意若其他分支要使用此 Action 需要先 Merge 主分支的 CD-Deploy.yml 档案。</em></p></blockquote><p><strong>等待任务跑完：</strong></p><p><a href="/assets/4b001d2e8440/1*Q-c2IUlJpssooiqcqcm_Bg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Q-c2IUlJpssooiqcqcm_Bg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMzg2IiBoZWlnaHQ9IjEyODgiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p><a href="/assets/4b001d2e8440/1*W8PBkatfsITMDFSlp7xpjg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*W8PBkatfsITMDFSlp7xpjg.webp" alt="[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16114046420){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijk3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16114046420" target="_blank">Demo</a></p><blockquote><p><strong><em>打包＋部署成功 ✅</em></strong></p></blockquote><p><strong>完整程式码： <a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/blob/main/.github/workflows/CD-Deploy.yml" target="_blank">CD-Deploy.yml</a></strong></p><h4 id="技术细节--firebase-cli-token-取得设定"><span class="me-2">技术细节 — Firebase CLI Token 取得＆设定</span><a href="#技术细节--firebase-cli-token-取得设定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>按照 <a href="https://firebase.google.com/docs/cli?hl=zh-tw#install-cli-mac-linux" target="_blank">Firebase 官方文件步骤</a> ：</p><p>先安装好 Firebase CLI 工具：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-sL</span> https://firebase.tools <span class="se">\\</span>| bash
</pre></table></code></div></div><p>执行：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase login:ci
</pre></table></code></div></div><p>完成登入、授权：</p><p><a href="/assets/4b001d2e8440/1*Jex5aYzRSs7Trfx6z_e1Aw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Jex5aYzRSs7Trfx6z_e1Aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYzIiBoZWlnaHQ9IjcwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/4b001d2e8440/1*S-1ckn9WC6j0DIqZGSdUUg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*S-1ckn9WC6j0DIqZGSdUUg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MjciIGhlaWdodD0iMjEzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>回到 Terminal 复制 Firebase CLI Token:</p><p><a href="/assets/4b001d2e8440/1*sa_h8L08JbeC2nA0kACQtQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*sa_h8L08JbeC2nA0kACQtQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODIiIGhlaWdodD0iNDgzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">FIREBASE_CLI_TOKEN</code> 并贴上 Firebase CLI Token。</p><p><a href="/assets/4b001d2e8440/1*Lc6yGPu7L_0z6u1HH2PB5A.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Lc6yGPu7L_0z6u1HH2PB5A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcxIiBoZWlnaHQ9IjUxNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p><strong><em>这个 Token = 你的登入身份</em></strong> <em>，请妥善保存，如果帐号离职也需要进行更换。</em></p></blockquote><h4 id="技术细节--install-the-apple-certificate-and-provisioning-profile"><span class="me-2">技术细节 — Install the Apple certificate and provisioning profile</span><a href="#技术细节--install-the-apple-certificate-and-provisioning-profile" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>补充开发凭证汇入 Runner 的步骤细节。</p><p>因 GitHub Actions Secret 无法储存档案，因此所有凭证档案都要先转成 Base64 Encoded 文字格式存在 Secrets，GitHub Actions Step 中再动态读出来写入 TEMP 档案并移动到正确位置给系统读取使用。</p><p><strong>打包 Development 需要两把金钥凭证：</strong></p><ul><li><p><a href="https://developer.apple.com/account/resources/certificates/list" target="_blank">Provision Profile ( .mobileprovision)</a></p><li><p><a href="https://developer.apple.com/account/resources/certificates/list" target="_blank">Development Certifcate ( .p12)</a></p></ul><p><a href="/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*WXqqnErto3nn8rnNg6TXgw.webp" alt="cicd.mobileprovision" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE3IiBoZWlnaHQ9IjYxNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>cicd.mobileprovision</p><p><a href="/assets/4b001d2e8440/1*RkeZ1PkXeY9Nt1kSRJKEQw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*RkeZ1PkXeY9Nt1kSRJKEQw.webp" alt="development.cer" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDc4IiBoZWlnaHQ9IjczOCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>development.cer</p><p>从 <a href="https://developer.apple.com/account/resources/certificates/list" target="_blank">Apple Developer</a> 中下载的 Certificate 是 .cer 格式，而我们需要的是 .p12 格式，可以先把下载下来的 .cer 点两下安装到 Keychain，然后打开 Keychain 选择该凭证右键 Export 汇出。</p><p><a href="/assets/4b001d2e8440/1*HJMxwM3IDjxT-UGqnoUtWw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*HJMxwM3IDjxT-UGqnoUtWw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MjQiIGhlaWdodD0iNTI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>档案名称：cicd.p12、格式 .p12</p><p>P12 金钥密码：输入一组安全的自订义字串 (范例是不好的示范，用 <code class="language-plaintext highlighter-rouge">123456</code> )</p><p><a href="/assets/4b001d2e8440/1*tyH0XqDVPGPWFJPL4dxksw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*tyH0XqDVPGPWFJPL4dxksw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NzIiIGhlaWdodD0iMzU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/4b001d2e8440/1*qKeZWel3w_5wW7meMtHmLA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*qKeZWel3w_5wW7meMtHmLA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NTYiIGhlaWdodD0iMzgxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>现在两个档案：</strong> cicd.p12、cicd.mobileprovision 都准备好了</p><p><strong>转换成 BASE64 格式字串并存到 Repo Secrets：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">base64</span> <span class="nt">-i</span> cicd.mobileprovision <span class="se">\\</span>| pbcopy
</pre></table></code></div></div><p>到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">BUILD_PROVISION_PROFILE_BASE64</code> 并贴上以上内容。</p><p>-</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">base64</span> <span class="nt">-i</span> cicd.p12 <span class="se">\\</span>| pbcopy
</pre></table></code></div></div><p>到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">BUILD_CERTIFICATE_BASE64</code> 并贴上以上内容。</p><p>-</p><p>到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">P12_PASSWORD</code> 内容是刚汇出 P12 金钥设定的密码。</p><p>- 到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">KEYCHAIN_PASSWORD</code> ： 如果是 GitHub Hosted Runner 则随便输入一个任意字串， <strong>如果是 Self-hosted Runner 则为 macOS Runner 使用者的登入密码</strong> 。</p><p><a href="/assets/4b001d2e8440/1*JZCkFUJCQsggqYtW8acjTw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*JZCkFUJCQsggqYtW8acjTw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDg4IiBoZWlnaHQ9IjQ5MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="技术细节-app-store-connect-api-key"><span class="me-2">技术细节 —App Store Connect API Key</span><a href="#技术细节-app-store-connect-api-key" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Fastlane 打包部署到 App Store, Testflight <a href="https://docs.fastlane.tools/app-store-connect-api/" target="_blank">必须提供的 .json 金钥</a> ，同样受限 GitHub Actions Secrets 只能存字串不能存档案，所以我们也要把金钥内容转成 Base64 字串，GitHub Actions Step 中再动态读出来写入 TEMP 档案并把档案路径给 Fastlane 引用使用。</p><p><strong>首先到 <a href="/posts/zrealm-dev/zh-cn/app-store-connect-api-%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96%E4%B8%8E%E7%AE%A1%E7%90%86-customer-reviews-%E6%8F%90%E5%8D%87-ios-app-%E8%AF%84%E4%BB%B7%E6%95%B4%E5%90%88%E6%95%88%E7%8E%87-f1365e51902c/">App Store Connect 建立&amp;下载好 App Store Connect API Key</a> ( .p8) ：</strong></p><pre><code class="language-vbnet">-----BEGIN PRIVATE KEY-----
sss
axzzvcxz
zxzvzcxv
vzxcvzxvczxcvz
-----END PRIVATE KEY-----
</code></pre><p>新增一个 <code class="language-plaintext highlighter-rouge">app_store_connect_api.json</code> 档案( <a href="https://docs.fastlane.tools/app-store-connect-api/" target="_blank">内容参考</a> )：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">{</span>
  <span class="s2">"key_id"</span>: <span class="s2">"App Store Connect 上写的 Key ID"</span>,
  <span class="s2">"issuer_id"</span>: <span class="s2">"App Store Connect 上写的 Issuer ID"</span>,
  <span class="s2">"key"</span>: <span class="s2">"-----BEGIN PRIVATE KEY-----记得把换行改成</span><span class="se">\n</span><span class="s2">-----END PRIVATE KEY-----"</span>,
  <span class="s2">"duration"</span>: 1200, <span class="c"># optional (maximum 1200)</span>
  <span class="s2">"in_house"</span>: <span class="nb">false</span> <span class="c"># optional but may be required if using match/sigh</span>
<span class="o">}</span>
</pre></table></code></div></div><p>储存档案后执行：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">base64</span> <span class="nt">-i</span> app_store_connect_api.json <span class="se">\\</span>| pbcopy
</pre></table></code></div></div><p>将字串内容贴到 Repo → Settings → Secrets and variables → Actions → 新增一个 Secret: <code class="language-plaintext highlighter-rouge">APP_STORE_CONNECT_API_KEY_BASE64</code> 并贴上以上内容。</p><p><a href="/assets/4b001d2e8440/1*QxRuxEPEfWbJ383hhnxGkA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*QxRuxEPEfWbJ383hhnxGkA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTU5IiBoZWlnaHQ9IjU0OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><code class="language-plaintext highlighter-rouge">Read and Write Apple Store Connect API Key to Temp</code> Step 完成之后在后续的 Step 只要传入 env <code class="language-plaintext highlighter-rouge">APP_STORE_CONNECT_API_KEY_PATH</code> :</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
  <span class="na">env</span><span class="pi">:</span>
    <span class="na">APP_STORE_CONNECT_API_KEY_PATH</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{</span><span class="nv"> </span><span class="s">runner.temp</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">env.APP_STORE_CONNECT_API_KEY_FILE_NAME</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
    <span class="s">....</span>
</pre></table></code></div></div><p>Fastlane 就能自动取得使用。</p><h4 id="技术延伸--reuse-action-workflow-拆分打包和部署动作"><span class="me-2">技术延伸 — Reuse Action Workflow 拆分打包和部署动作</span><a href="#技术延伸--reuse-action-workflow-拆分打包和部署动作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在这个案例中我们直接使用 Fastlane <code class="language-plaintext highlighter-rouge">beta</code> Lane 执行打包＋部署两个动作。</p><p>在实际案例中我们可能需要将同一包打包结果分别部署到不同平台上(Firebase, Testflight…etc) 因此比较好的做法是打包是一个 Action、部署是一个 Action，不然会重复跑两次打包；而且也更符合 CI/CD 的权责划分。</p><blockquote><p><strong><em>以下为范例介绍：</em></strong></p></blockquote><p><strong>CI-Build.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Build</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">main</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
     <span class="na">inputs</span><span class="pi">:</span>
        <span class="na">RELEASE_NOTE</span><span class="pi">:</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release</span><span class="nv"> </span><span class="s">notes</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">deployment.'</span>
          <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">macos-latest</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">make steup</span>
          <span class="s">make instal</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build Project</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">bundle exec fastlane build</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload Build Artifact</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/upload-artifact@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">build-artifact</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./fastlane/build/</span>
</pre></table></code></div></div><p><strong>CD-Deploy-Firebase.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Firebase</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># 当 Build Action 完成时自动触发执行</span>
  <span class="na">workflow_run</span><span class="pi">:</span>
    <span class="na">workflows</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Build"</span><span class="pi">]</span>
    <span class="na">types</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">completed</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="c1"># 完成＋执行成功才执行部署</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ github.event.workflow_run.conclusion == 'success' }}</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">make steup</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Download Build Artifact</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/download-artifact@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">build-artifact</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./fastlane/build/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Production</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">bundle exec fastlane deploy-firebase</span>
</pre></table></code></div></div><p><strong>CD-Deploy-Testflight.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Testflight</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># 当 Build Action 完成时自动触发执行</span>
  <span class="na">workflow_run</span><span class="pi">:</span>
    <span class="na">workflows</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">Build"</span><span class="pi">]</span>
    <span class="na">types</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">completed</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="c1"># 完成＋执行成功才执行部署</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ github.event.workflow_run.conclusion == 'success' }}</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">make steup</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Download Build Artifact</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/download-artifact@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">build-artifact</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./fastlane/build/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Production</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">bundle exec fastlane deploy-testflight</span>
</pre></table></code></div></div><p><strong>另外也可以用 <a href="https://docs.github.com/en/actions/how-tos/sharing-automations/reusing-workflows" target="_blank">Reusing Workflow</a> :</strong></p><p><strong>CD-Deploy-Firebase.yml:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Firebase</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># 任意的触发条件，这里以手动表单触发为例</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">RELEASE_NOTE</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Release</span><span class="nv"> </span><span class="s">notes</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">deployment.'</span>
        <span class="na">required</span><span class="pi">:</span> <span class="kc">false</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">Build</span>
    <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/CD-Build.yml</span>
    <span class="na">secrets</span><span class="pi">:</span> <span class="s">inherit</span>
    <span class="na">with</span><span class="pi">:</span>
      <span class="na">RELEASE_NOTE</span><span class="pi">:</span> <span class="s">${{ inputs.RELEASE_NOTE }}</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="c1"># Job 预设是并发执行，用 needs 限制需等待 build 完成才执行</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">build</span><span class="pi">]</span>
    <span class="c1"># 执行成功，才部署</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ always() &amp;&amp; needs.deploy.result == 'success' }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout Code</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">make steup</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Download Build Artifact</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/download-artifact@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">build-artifact</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">./fastlane/build/</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy to Production</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">bundle exec fastlane deploy-firebase</span>
</pre></table></code></div></div><h4 id="github-actions--artifact"><span class="me-2">GitHub Actions — Artifact</span><a href="#github-actions--artifact" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>同 Cache，目前 <strong>就算是 Self-hosted Runner Artifcact 功能依然会走 GitHub Cloud</strong> 受到使用量限制 ( <a href="https://docs.github.com/en/billing/managing-billing-for-your-products/about-billing-for-github-actions#included-storage-and-minutes" target="_blank">免费帐号 500MB 起</a> )。</p><blockquote><p><em>Self-hosted Runner 要达到类似的效果可以自行建立共享主机目录或找其他工具替代。</em></p></blockquote><p>因此目前 Artifact 实际我只用来存放小资料，例如 Snapshot Tests 的错误结果、测试报告…等等</p><h3 id="ci-nightly-build-执行快照单元测试打包cd-部署到-firebase-app-distribution"><span class="me-2">CI— Nightly Build 执行快照+单元测试+打包+CD 部署到 Firebase App Distribution</span><a href="#ci-nightly-build-执行快照单元测试打包cd-部署到-firebase-app-distribution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="流程-2"><span class="me-2">流程</span><a href="#流程-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>每天凌晨 3 点自动针对 main(develop or master) 分支跑全部测试(unit+snapshot tests)，如果失败则传送失败通知到 Slack 工作群组；如果成功则打包+部署一个版本到 Firebase App Disturbution，打包成功/失败都会传送 Slack 通知。</p><h4 id="ci-nightly-build-and-deployyml"><span class="me-2">CI-Nightly-Build-And-Deploy.yml</span><a href="#ci-nightly-build-and-deployyml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Repo → Actions → New workflow → set up a workflow yourself。</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="c1"># Workflow(Action) 名称</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">CI-Nightly Build And Deploy</span>

<span class="c1"># Actions Log 的标题名称</span>
<span class="na">run-name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[CI-Nightly</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">And</span><span class="nv"> </span><span class="s">Deploy]</span><span class="nv"> </span><span class="s">${{</span><span class="nv"> </span><span class="s">github.ref</span><span class="nv"> </span><span class="s">}}"</span>

<span class="c1"># 触发事件</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="c1"># 排程定时自动执行</span>
  <span class="c1"># https://crontab.guru/</span>
  <span class="c1"># UTC 时间</span>
  <span class="na">schedule</span><span class="pi">:</span>
    <span class="c1"># UTC 的 19:00 = 每天 UTC+8 的 03:00</span>
    <span class="pi">-</span> <span class="na">cron</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0</span><span class="nv"> </span><span class="s">19</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*'</span>
  <span class="c1"># 手动触发</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="c1"># Job 工作项目</span>
<span class="c1"># Job 会并发执行</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># 测试工作</span>
  <span class="na">testing</span><span class="pi">:</span>
    <span class="c1"># Reuse Workflow (workflow_call)</span>
    <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/CI-Testing.yml</span>
    <span class="c1"># 传递所有 Secrets 给 CD-Testing.yml</span>
    <span class="na">secrets</span><span class="pi">:</span> <span class="s">inherit</span>
    <span class="na">with</span><span class="pi">:</span>
      <span class="c1"># 执行全部测试</span>
      <span class="na">TEST_LANE</span><span class="pi">:</span> <span class="s2">"</span><span class="s">run_all_tests"</span>
      <span class="c1"># 目标分支：main, develop or master...etc</span>
      <span class="na">BRANCH</span><span class="pi">:</span> <span class="s2">"</span><span class="s">main"</span>

  <span class="na">deploy-env</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">DATE_STRING</span><span class="pi">:</span> <span class="s">${{ steps.get_date.outputs.DATE_STRING }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Get Date String</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">get_date</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">VERSION_DATE=$(date -u '+%Y%m%d')</span>
          <span class="s">echo "${VERSION_DATE}"</span>
          <span class="s">echo "DATE_STRING=${VERSION_DATE}" &gt;&gt; $GITHUB_ENV</span>
          <span class="s">echo "DATE_STRING=${VERSION_DATE}" &gt;&gt; $GITHUB_OUTPUT</span>
    
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="c1"># Job 预设是并发执行，用 needs 限制需等待 testing 和 deploy-env 完成才执行</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">testing</span><span class="pi">,</span> <span class="nv">deploy-env</span><span class="pi">]</span>
    <span class="c1"># 如果测试成功才执行</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ needs.testing.result == 'success' }}</span>
    <span class="c1"># Reuse Workflow (workflow_call)</span>
    <span class="na">uses</span><span class="pi">:</span> <span class="s">./.github/workflows/CD-Deploy.yml</span>
    <span class="c1"># 传递所有 Secrets 给 CD-Deploy.yml</span>
    <span class="na">secrets</span><span class="pi">:</span> <span class="s">inherit</span>
    <span class="na">with</span><span class="pi">:</span>
      <span class="na">VERSION_NUMBER</span><span class="pi">:</span> <span class="s">NightlyBuild-${{ needs.deploy-env.outputs.DATE_STRING }}</span>
      <span class="na">RELEASE_NOTE</span><span class="pi">:</span> <span class="s">NightlyBuild-${{ needs.deploy-env.outputs.DATE_STRING }}</span>
      <span class="c1"># 目标分支：main, develop or master...etc</span>
      <span class="na">BRANCH</span><span class="pi">:</span> <span class="s2">"</span><span class="s">main"</span>

<span class="c1"># ----- Slack Notify -----</span>
  <span class="na">testing-failed-slack-notify</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">testing</span><span class="pi">]</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ needs.testing.result == 'failure' }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Post text to a Slack channel</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">slackapi/slack-github-action@v2.1.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">chat.postMessage</span>
          <span class="na">token</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">payload</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">channel</span><span class="err">:</span> <span class="s">${{ vars.SLACK_TEAM_CHANNEL_ID }}</span>
            <span class="s">text</span><span class="err">:</span> <span class="s2">"</span><span class="s">:x:</span><span class="nv"> </span><span class="s">Nightly</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Testing</span><span class="nv"> </span><span class="s">失败</span><span class="se">\n</span><span class="s">Workflow:</span><span class="nv"> </span><span class="s">&lt;${{</span><span class="nv"> </span><span class="s">github.server_url</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">github.repository</span><span class="nv"> </span><span class="s">}}/actions/runs/${{</span><span class="nv"> </span><span class="s">github.run_id</span><span class="nv"> </span><span class="s">}}</span><span class="se">\\</span><span class="s">|View</span><span class="nv"> </span><span class="s">Run&gt;"</span>

  <span class="na">deploy-failed-slack-notify</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">deploy</span><span class="pi">]</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ needs.deploy.result == 'failure' }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Post text to a Slack channel</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">slackapi/slack-github-action@v2.1.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">chat.postMessage</span>
          <span class="na">token</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">payload</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">channel</span><span class="err">:</span> <span class="s">${{ vars.SLACK_TEAM_CHANNEL_ID }}</span>
            <span class="s">text</span><span class="err">:</span> <span class="s2">"</span><span class="s">:x:</span><span class="nv"> </span><span class="s">Nightly</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">Deploy</span><span class="nv"> </span><span class="s">失败</span><span class="se">\n</span><span class="s">Workflow:</span><span class="nv"> </span><span class="s">&lt;${{</span><span class="nv"> </span><span class="s">github.server_url</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">github.repository</span><span class="nv"> </span><span class="s">}}/actions/runs/${{</span><span class="nv"> </span><span class="s">github.run_id</span><span class="nv"> </span><span class="s">}}</span><span class="se">\\</span><span class="s">|View</span><span class="nv"> </span><span class="s">Run&gt;"</span>

  <span class="na">deploy-success-slack-notify</span><span class="pi">:</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">deploy</span><span class="pi">]</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">${{ needs.deploy.result == 'success' }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Post text to a Slack channel</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">slackapi/slack-github-action@v2.1.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">method</span><span class="pi">:</span> <span class="s">chat.postMessage</span>
          <span class="na">token</span><span class="pi">:</span> <span class="s">${{ secrets.SLACK_BOT_TOKEN }}</span>
          <span class="na">payload</span><span class="pi">:</span> <span class="s">\\|</span>
            <span class="s">channel</span><span class="err">:</span> <span class="s">${{ vars.SLACK_TEAM_CHANNEL_ID }}</span>
            <span class="s">text</span><span class="err">:</span> <span class="s2">"</span><span class="s">:white_check_mark:</span><span class="nv"> </span><span class="s">Nightly</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">Deploy</span><span class="nv"> </span><span class="s">成功</span><span class="se">\n</span><span class="s">Workflow:</span><span class="nv"> </span><span class="s">&lt;${{</span><span class="nv"> </span><span class="s">github.server_url</span><span class="nv"> </span><span class="s">}}/${{</span><span class="nv"> </span><span class="s">github.repository</span><span class="nv"> </span><span class="s">}}/actions/runs/${{</span><span class="nv"> </span><span class="s">github.run_id</span><span class="nv"> </span><span class="s">}}</span><span class="se">\\</span><span class="s">|View</span><span class="nv"> </span><span class="s">Run&gt;"</span>
</pre></table></code></div></div><p><strong>Commit 档案到 Repo 主分支，手动触发测试、打包功能看看结果：</strong></p><p><a href="/assets/4b001d2e8440/1*l71fL8oLoeAv-JX_FgkqzQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*l71fL8oLoeAv-JX_FgkqzQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjU2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p><em>日后会每日自动触发。</em></p></blockquote><p><a href="/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*u6A77KwkXS2SY5-DPPPR9A.webp" alt="[Demo](https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjgwMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/runs/16119750747" target="_blank">Demo</a></p><p><a href="/assets/4b001d2e8440/1*6DQL_v4eahSqSuVJZRPrEA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*6DQL_v4eahSqSuVJZRPrEA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTAiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>等待测试任务、打包部署任务、通知任务都完成后，查看结果。</p><p><a href="/assets/4b001d2e8440/1*4UVgyCQljqZQgzxHpXPB4g.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*4UVgyCQljqZQgzxHpXPB4g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MDMiIGhlaWdodD0iOTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*t9PrQfcTANyvG7gfXXC-bw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NTQiIGhlaWdodD0iMTIwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>我们就能直接在手机上安装 Nightly Build 版本来进行抢先体验测试。</p><h4 id="技术细节"><span class="me-2">技术细节</span><a href="#技术细节" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>这个 Action 我们直接复用前面设计的 CI-Testing 和 CD-Deploy，组合成我们的 Nightly Build，非常弹性好用！</p><p><strong>完整程式码： <a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/workflows/CI-Nightly-Build-And-Deploy.yml" target="_blank">CI-Nightly-Build-And-Deploy.yml</a></strong></p><h3 id="self-hosted-runner-注意事项"><span class="me-2">Self-hosted Runner 注意事项</span><a href="#self-hosted-runner-注意事项" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>本文是 Public Repo 因此直接使用 GitHub Hosted 的 macOS Runner，但在实际工作上我们的 Repo 一定是 Private，直接使用 GitHub Hosted Runner 超贵不划算(约一个月就能买一台 Mac Mini 放在公司吃到饱爽爽跑)，每一台依照效能可以起多个 Runner 同时并发接任务来做。</p><blockquote><p><strong><em>细节可参考 <a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/">上一篇</a> 「 <a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/">Self-hosted Runner 建置与改用</a> 」部分</em></strong> <em>，在本地电脑安装好 XCode 跟基本环境后注册、启用 Runner、Action Worflow YAML 中把 <code class="language-plaintext highlighter-rouge">runs-on</code> 改成 <code class="language-plaintext highlighter-rouge">[self-hosted]</code> 即可。</em></p></blockquote><p>多个 Runner 在同一台电脑的问题，我们多半已在上面的 Actions 里解决了，例如把所有依赖的共用目录都改成本地目录，还有一个测试会遇到的问题要解决，就是抢模拟器问题：「 <strong>当两个测试 Job 被两个 Runner 在同一台机器上同时检来做，如果指定同个模拟器就会互相干扰导致测试失败。」</strong></p><p>解决方法也很容易，就是为个别 Runner 都设定一台模拟器。</p><h4 id="多个-runner-在同台机器的模拟器设定"><span class="me-2">多个 Runner 在同台机器的模拟器设定</span><a href="#多个-runner-在同台机器的模拟器设定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>假设我 <strong>同一台电脑上有两个 Runner</strong> 在并行接收任务：</p><ul><li><p><code class="language-plaintext highlighter-rouge">ZhgChgLideMacBook-Pro-Runner-A</code></p><li><p><code class="language-plaintext highlighter-rouge">ZhgChgLideMacBook-Pro-Runner-B</code></p></ul><p><a href="/assets/4b001d2e8440/1*3ptg9Tl5fBbEIYB4kgh0kw.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*3ptg9Tl5fBbEIYB4kgh0kw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MTkiIGhlaWdodD0iMzMzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>在 XCode 模拟器设定我们就需要新增两个模拟器：</p><p><a href="/assets/4b001d2e8440/1*k9bR2C12Wk11HAKKiYJ2zg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*k9bR2C12Wk11HAKKiYJ2zg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDM3IiBoZWlnaHQ9IjY5NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/4b001d2e8440/1*iigArewZEW0063Q6xwZn7g.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*iigArewZEW0063Q6xwZn7g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMjIiIGhlaWdodD0iMjgxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>型号、iOS 版本同测试环境</ul><p><strong>CI-Testing.yml 中测试步骤改成：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c"># 执行 Fastlane Unit 测试 Lane</span>
      - name: Run Tests
        <span class="nb">id</span>: testing
        <span class="c"># 指定工作目录，这样后续指令就不用在特别 cd ./Product/</span>
        working-directory: ./Product/
        <span class="nb">env</span>:
          <span class="c"># ...</span>
          <span class="c"># Repo -&gt; Settings -&gt; Actions secrets and variables -&gt; variables</span>
          <span class="c"># 模拟器的 iOS 版本</span>
          SIMULATOR_IOS_VERSION: <span class="k">${</span><span class="p">{ vars.SIMULATOR_IOS_VERSION </span><span class="k">}</span><span class="o">}</span>

          <span class="c"># 当前 Runner 名称</span>
          RUNNER_NAME: <span class="k">${</span><span class="p">{ runner.name </span><span class="k">}</span><span class="o">}</span>
          
          <span class="c"># ...</span>
        run: <span class="se">\\</span>|

          <span class="c"># ...</span>
          bundle <span class="nb">exec </span>fastlane <span class="k">${</span><span class="nv">TEST_LANE</span><span class="k">}</span> device:<span class="s2">"</span><span class="k">${</span><span class="nv">RUNNER_NAME</span><span class="k">}</span><span class="s2"> (</span><span class="k">${</span><span class="nv">SIMULATOR_IOS_VERSION</span><span class="k">}</span><span class="s2">)"</span> <span class="se">\\</span>| <span class="nb">tee</span> <span class="s2">"</span><span class="nv">$RUNNER_TEMP</span><span class="s2">/testing_output.txt"</span>
          <span class="c"># ...</span>
</pre></table></code></div></div><ul><li><p><code class="language-plaintext highlighter-rouge">device</code> <strong>改成</strong> <code class="language-plaintext highlighter-rouge">${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})</code></p><li><p><code class="language-plaintext highlighter-rouge">SIMULATOR_IOS_VERSION</code> 还是统一看 Repo variables 变数</p></ul><p><strong>组合结果就会是(以 18.4 为例)：</strong></p><ul><li><p>Runner: <code class="language-plaintext highlighter-rouge">ZhgChgLideMacBook-Pro-Runner-A</code> 模拟器: <strong>ZhgChgLideMacBook-Pro-Runner-A(18.4)</strong></p><li><p>Runner: <code class="language-plaintext highlighter-rouge">ZhgChgLideMacBook-Pro-Runner-B</code> 模拟器: <strong>ZhgChgLideMacBook-Pro-Runner-B(18.4)</strong></p></ul><p>这样两个 Runner 同时在执行测试时就会起两个模拟器自己跑自己的了。</p><h4 id="完整专案-repo"><span class="me-2">完整专案 Repo</span><a href="#完整专案-repo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/5952f3220c95ced947b9ee50d9c542b2edbb424be50c51c582cb226ce5f5df63/ZhgChgLi/github-actions-ci-cd-demo" alt="" loading="lazy"></a></p><h3 id="补充-ssh-agent-设定--for-fastlane-match-or-private-cocoapods-repo"><span class="me-2">补充 SSH Agent 设定 — For Fastlane Match or Private CocoaPods Repo</span><a href="#补充-ssh-agent-设定--for-fastlane-match-or-private-cocoapods-repo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在使用 Fastlane Match 或 Private CocoaPods Repo，因为是在另一个 Private Repo 当中，当前 Repo/Action 环境无法直接 git clone，需要使用 ssh agent 设定好环境，在 Action 执行时才有权限操作。</p><h4 id="step-1-产生-ssh-key"><span class="me-2">Step 1. 产生 SSH Key</span><a href="#step-1-产生-ssh-key" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/4b001d2e8440/1*kPWl9hombBgQ15i-n2sY2A.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*kPWl9hombBgQ15i-n2sY2A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODIiIGhlaWdodD0iNDgzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-C</span> <span class="s2">"zhgchgli@gmail.com"</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Enter file in which to save the key (/Users/zhgchgli/.ssh/id_ed25519):</code> /Users/zhgchgli/Downloads/zhgchgli</p><ul><li>输入到下载路径方便我们拷贝内容</ul><p><code class="language-plaintext highlighter-rouge">Enter passphrase for “/Users/zhgchgli/Downloads/zhgchgli” (empty for no passphrase):</code></p><ul><li><p><strong>留空：</strong> CI/CD 使用，无法在 CLI 交互下输入 Passphrase， <strong>因此请留空</strong></p><li><p>产生完毕 ( .pub/private_key)</p></ul><p><a href="/assets/4b001d2e8440/1*aF5P6EK9Hfv-CI3MRZ8MCA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*aF5P6EK9Hfv-CI3MRZ8MCA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMjAiIGhlaWdodD0iNTEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h4 id="step-2-到-private-repo-设定-deploy-key"><span class="me-2">Step 2. 到 Private Repo 设定 Deploy Key</span><a href="#step-2-到-private-repo-设定-deploy-key" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/4b001d2e8440/1*3K6JvCHa23QfvWoNq2xdBQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*3K6JvCHa23QfvWoNq2xdBQ.webp" alt="github-actions-ci-cd-demo-certificates Repo" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcyIiBoZWlnaHQ9Ijc4MSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>github-actions-ci-cd-demo-certificates Repo</p><p>Settings → Security → Deploy keys → Add deploy key。</p><ul><li><p>Title: 输入 Key 名称</p><li><p>Key: <code class="language-plaintext highlighter-rouge">贴上 .pub Key 内容</code></p></ul><p>完成。</p><p><a href="/assets/4b001d2e8440/1*Xo_g-AchEk0j4SGXOmBuxg.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Xo_g-AchEk0j4SGXOmBuxg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTY4IiBoZWlnaHQ9IjgxNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="step-3-回-action-的-repo-设定-ssh-private-key-to-secrets"><span class="me-2">Step 3. 回 Action 的 Repo 设定 SSH Private Key to Secrets</span><a href="#step-3-回-action-的-repo-设定-ssh-private-key-to-secrets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/4b001d2e8440/1*Jm92pQHMOImQzZtmmvd1ng.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*Jm92pQHMOImQzZtmmvd1ng.webp" alt="github-actions-ci-cd-demo Repo" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTc0IiBoZWlnaHQ9Ijg5OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>github-actions-ci-cd-demo Repo</p><p>Settings → Secrets and variables → Actions → New repository secret。</p><ul><li><p>Name: 输入密钥变数名称 <code class="language-plaintext highlighter-rouge">SSH_PRIVATE_KEY</code></p><li><p>Secret: <code class="language-plaintext highlighter-rouge">贴上 private_key 内容</code></p></ul><p>完成。</p><h4 id="step-4-ssh-agent-设定完成来验证一下-git-clone-private-repo-的权限"><span class="me-2">Step 4. SSH Agent 设定完成，来验证一下 Git Clone Private Repo 的权限</span><a href="#step-4-ssh-agent-设定完成来验证一下-git-clone-private-repo-的权限" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/github-actions-ci-cd-demo/actions/workflows/Demo-Git-Clone-Private-Repo.yml" target="_blank"><strong>Demo-Git-Clone-Private-Repo.yml</strong></a> <strong>:</strong></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Demo Git Clone Private Repo</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">clone-private-repo</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">Git Clone Private Repo</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">timeout-minutes</span><span class="pi">:</span> <span class="m">30</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="c1"># 🔐 启用 SSH Agent 并加入私钥</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup SSH Agent</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">webfactory/ssh-agent@v0.9.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">ssh-private-key</span><span class="pi">:</span> <span class="s">${{ secrets.SSH_PRIVATE_KEY }}</span>

      <span class="c1"># 🛡️ 将 github.com 加入 known_hosts 以避免 host verification 错误</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Add GitHub to known_hosts</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">mkdir -p ~/.ssh</span>
          <span class="s">ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span>
      <span class="c1"># 📦 使用 SSH clone private repo 并验证</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Clone and Verify Private Repo</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\\|</span>
          <span class="s">git clone git@github.com:ZhgChgLi/github-actions-ci-cd-demo-certificates.git ./fakeMatch/</span>
          <span class="s">if [ -d "./fakeMatch/.git" ]; then</span>
            <span class="s">echo "✅ Repo cloned successfully into ./fakeMatch/"</span>
            <span class="s">cd ./fakeMatch</span>
            <span class="s">echo "📌 Current commit</span><span class="err">:</span> <span class="s">$(git rev-parse --short HEAD)"</span>
          <span class="s">else</span>
            <span class="s">echo "❌ Clone failed. SSH Agent may not be configured properly."</span>
            <span class="s">exit </span><span class="m">1</span>
          <span class="s">fi</span>
</pre></table></code></div></div><p>可以用以上 Action 验证一下是否设定成功。</p><p><a href="/assets/4b001d2e8440/1*YLbr7l0FBSOYx_fQT-tiCA.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*YLbr7l0FBSOYx_fQT-tiCA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>成功，后续 <code class="language-plaintext highlighter-rouge">fastlane match</code> or <code class="language-plaintext highlighter-rouge">pod install</code> private pods 应该就能正确执行。</p><h3 id="总结"><span class="me-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>这篇文章详细纪录了使用 GitHub Actions 开发完整的 iOS CI/CD 流程，下一篇将优化使用者端(工程师/PM/设计师)体验， <strong>完善 Slack 通知及使用 Google Apps Script Web App 串接 GitHub Actions 打造免费易用的跨团队打包平台工具。</strong></p><h3 id="系列文章"><span class="me-2">系列文章：</span><a href="#系列文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/"><strong>CI/CD 实战指南（一）：CI/CD 是什么？如何透过 CI/CD 打造稳定高效的开发团队？工具选择？</strong></a></p><li><p><a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/"><strong>CI/CD 实战指南（二）：GitHub Actions 与 self-hosted Runner 使用与建置大全</strong></a></p><li><p><a href="/posts/zrealm-dev/zh-cn/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6-4b001d2e8440/"><strong>CI/CD 实战指南（三）：使用 GitHub Actions 实作 App 专案的 CI 与 CD 工作流程</strong></a></p><li><p><a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E5%B9%B3%E5%8F%B0-%E4%BD%BF%E7%94%A8-google-apps-script-web-app-%E4%B8%B2%E6%8E%A5-github-actions-%E6%8F%90%E5%8D%87%E8%B7%A8%E5%9B%A2%E9%98%9F%E6%95%88%E7%8E%87-4273e57e7148/"><strong>CI/CD 实战指南（四）：使用 Google Apps Script Web App 串接 GitHub Actions 建置免费易用的打包工具平台</strong></a></p></ul><h4 id="buy-me-a-coffee"><span class="me-2"><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank">Buy me a coffee</a></span><a href="#buy-me-a-coffee" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank"><strong><em>本系列文章花费了大量的时间精力撰写，如果内容对您有帮助、对您的团队有实质提升工作效率与产品品质；欢迎请我喝杯咖啡，感谢支持！</em></strong></a></p></blockquote><p><a href="/assets/4b001d2e8440/1*QJj54G9gOjtQS-rbHVT1SQ.webp" class="popup img-link blur"><img data-src="/assets/4b001d2e8440/1*QJj54G9gOjtQS-rbHVT1SQ.webp" alt="[Buy me a coffee](https://www.buymeacoffee.com/zhgchgli){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDAiIGhlaWdodD0iNzAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank">Buy me a coffee</a></p><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/4b001d2e8440" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2025-07-07-4b001d2e8440.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cicd/" class="post-tag no-text-decoration" >cicd</a> <a href="/tags/github-actions/" class="post-tag no-text-decoration" >github-actions</a> <a href="/tags/firebase/" class="post-tag no-text-decoration" >firebase</a> <a href="/tags/cicd-pipeline/" class="post-tag no-text-decoration" >cicd-pipeline</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GitHub%20Actions%20iOS%20CI/CD%EF%BD%9C%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE%E3%80%81%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fgithub-actions-ios-ci-cd-%25E5%25AE%258C%25E6%2595%25B4%25E5%25AE%259E%25E4%25BD%259C%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E5%25BB%25BA%25E7%25BD%25AE-%25E6%25B5%258B%25E8%25AF%2595%25E4%25B8%258E%25E9%2583%25A8%25E7%25BD%25B2%25E6%25B5%2581%25E7%25A8%258B%25E6%2595%2599%25E5%25AD%25A6-4b001d2e8440%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GitHub%20Actions%20iOS%20CI/CD%EF%BD%9C%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%9C%E8%87%AA%E5%8A%A8%E5%8C%96%E5%BB%BA%E7%BD%AE%E3%80%81%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%A6%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fgithub-actions-ios-ci-cd-%25E5%25AE%258C%25E6%2595%25B4%25E5%25AE%259E%25E4%25BD%259C%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E5%25BB%25BA%25E7%25BD%25AE-%25E6%25B5%258B%25E8%25AF%2595%25E4%25B8%258E%25E9%2583%25A8%25E7%25BD%25B2%25E6%25B5%2581%25E7%25A8%258B%25E6%2595%2599%25E5%25AD%25A6-4b001d2e8440%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fgithub-actions-ios-ci-cd-%25E5%25AE%258C%25E6%2595%25B4%25E5%25AE%259E%25E4%25BD%259C%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E5%25BB%25BA%25E7%25BD%25AE-%25E6%25B5%258B%25E8%25AF%2595%25E4%25B8%258E%25E9%2583%25A8%25E7%25BD%25B2%25E6%25B5%2581%25E7%25A8%258B%25E6%2595%2599%25E5%25AD%25A6-4b001d2e8440%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/en/ios-shortcut-automation-auto-forward-sms-create-reminder-tasks-effortlessly-309d0302877b/">iOS Shortcut Automation｜Auto-Forward SMS & Create Reminder Tasks Effortlessly</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/ios-%E6%8D%B7%E5%BE%84%E8%87%AA%E5%8A%A8%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%AE%80%E8%AE%AF%E4%B8%8E%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E6%95%99%E5%AD%A6-309d0302877b/">iOS 捷径自动化应用场景 — 自动转发简讯与自动建立提醒待办事项</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/ios-%E6%8D%B7%E5%BE%91%E8%87%AA%E5%8B%95%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8B%95%E8%BD%89%E7%99%BC%E7%B0%A1%E8%A8%8A%E8%88%87%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E8%BE%A6%E4%BA%8B%E9%A0%85%E6%95%99%E5%AD%B8-309d0302877b/">iOS 捷徑自動化應用場景 — 自動轉發簡訊與自動建立提醒待辦事項</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxing｜Premium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/apple-watch-%E7%B1%B3%E5%85%B0%E8%A1%A8%E5%B8%A6%E5%BC%80%E7%AE%B1-%E5%8E%9F%E5%8E%82%E4%B8%8D%E9%94%88%E9%92%A2%E7%9F%B3%E5%A2%A8%E8%89%B2%E4%BC%98%E7%BC%BA%E7%82%B9%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原厂不锈钢米兰表带开箱</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AF%A6%E4%BD%9C%E8%87%AA%E5%8B%95%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B8%AC%E8%A9%A6%E8%88%87%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%B8-4b001d2e8440/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1751900544" data-df="ll" > Jul 7, 2025 </time><h4 class="pt-0 my-2">CI/CD 實戰指南（三）：使用 GitHub Actions 實作 App iOS CI 與 CD 工作流程</h4><div class="text-muted"><p>iOS App 自動化建置、測試、部署的 GitHub Actions 實作步驟完整教學</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/github-actions-self-hosted-runner-%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B-ci-cd-%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%BB%BA%E7%BD%AE-404bd5c70040/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1751458952" data-df="ll" > Jul 2, 2025 </time><h4 class="pt-0 my-2">GitHub Actions｜Self-hosted Runner 详解与实战案例｜CI/CD 自动化工作流程建置</h4><div class="text-muted"><p>针对开发团队自动化需求，解析 GitHub Actions 与 Self-hosted Runner 架构与设定，并透过三大实战案例教你快速建立自动标记 PR、指派负责人及每日 PR 统计通知，提升 CI/CD 执行效率与成本优化。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1751267416" data-df="ll" > Jun 30, 2025 </time><h4 class="pt-0 my-2">CI/CD 是什么｜打造高效稳定开发团队的关键流程与工具选择</h4><div class="text-muted"><p>针对 iOS App 团队，解析无 CI/CD 流程的痛点，透过 GitHub Actions 与 self-hosted Runner 自动化测试与打包，减少人力浪费与错误，提升团队稳定性与开发效率，搭配 Google Apps Script Web App 实现跨职能便捷操作。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/github-actions-ios-app-ci-cd-workflow-automation-for-faster-builds-and-deployments-4b001d2e8440/" class="btn btn-outline-primary" aria-label="Older" ><p>GitHub Actions｜iOS App CI/CD Workflow Automation for Faster Builds and Deployments</p></a> <a href="/posts/zrealm-dev/github-actions-ios-ci-cd-%E5%AE%8C%E6%95%B4%E5%AF%A6%E4%BD%9C%E8%87%AA%E5%8B%95%E5%8C%96%E5%BB%BA%E7%BD%AE-%E6%B8%AC%E8%A9%A6%E8%88%87%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B%E6%95%99%E5%AD%B8-4b001d2e8440/" class="btn btn-outline-primary" aria-label="Newer" ><p>CI/CD 實戰指南（三）：使用 GitHub Actions 實作 App iOS CI 與 CD 工作流程</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
