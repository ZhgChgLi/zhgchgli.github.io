<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对开发者面临后端推播统计不准确与 Server 压力问题，解析如何运用 Firebase Firestore 与 Functions 快速搭建可测试的 API 服务，并示范完整 RESTful API 范例及分散式计数器设计，提升推播点击率统计精准度与系统稳定性。" /><meta property="og:description" content="针对开发者面临后端推播统计不准确与 Server 压力问题，解析如何运用 Firebase Firestore 与 Functions 快速搭建可测试的 API 服务，并示范完整 RESTful API 范例及分散式计数器设计，提升推播点击率统计精准度与系统稳定性。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-24T01:09:34+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" /><meta property="twitter:title" content="Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-14T00:34:17+08:00","datePublished":"2021-03-24T01:09:34+08:00","description":"针对开发者面临后端推播统计不准确与 Server 压力问题，解析如何运用 Firebase Firestore 与 Functions 快速搭建可测试的 API 服务，并示范完整 RESTful API 范例及分散式计数器设计，提升推播点击率统计精准度与系统稳定性。","headline":"Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/"}</script><title>Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/firebase-firestore-functions-build-testable-api-services-fast-for-push-notification-analytics-9659db1357e4/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8-api-%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C-9659db1357e4/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作</h1><p class="post-desc fw-light mb-4">针对开发者面临后端推播统计不准确与 Server 压力问题，解析如何运用 Firebase Firestore 与 Functions 快速搭建可测试的 API 服务，并示范完整 RESTful API 范例及分散式计数器设计，提升推播点击率统计精准度与系统稳定性。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1616519374" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 24, 2021 </time> </span> <span> Updated <time data-ts="1713026057" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" class="popup img-link preview-img blur"><img data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4405 words" > <em>24 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Firebase Firestore｜Functions 快速打造测试用 API 服务教学与推播统计实作</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/firebase-firestore-functions-build-testable-api-services-fast-for-push-notification-analytics-9659db1357e4/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目录</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li><a href="#使用-firebase-firestore--functions-快速搭建可供测试的-api-服务">使用 Firebase Firestore + Functions 快速搭建可供测试的 API 服务</a></li><li class="has-children"><details><summary>前言 <a href="#前言">#</a></summary><ul><li><a href="#推播精确统计功能">推播精确统计功能</a></li><li><a href="#问题">问题</a></li></ul></details></li><li class="has-children"><details><summary>Prototype <a href="#prototype">#</a></summary><ul><li><a href="#firebase-functions">Firebase Functions</a></li><li><a href="#firebase-firestore">Firebase Firestore</a></li></ul></details></li><li><a href="#安装-nodejs-环境">安装 node.js 环境</a></li><li class="has-children"><details><summary>部署 Firebase Functions <a href="#部署-firebase-functions">#</a></summary><ul><li><a href="#安装-firebase-tools">安装 Firebase-tools</a></li></ul></details></li><li><a href="#coding">Coding!</a></li><li><a href="#log">Log</a></li><li class="has-children"><details><summary>Example Goal <a href="#example-goal">#</a></summary><ul><li><a href="#post-新增文章">POST 新增文章</a></li><li><a href="#put-修改文章">PUT 修改文章</a></li><li><a href="#delete-删除文章">DELETE 删除文章</a></li><li><a href="#select-查询文章">SELECT 查询文章</a></li><li><a href="#insertorupdate">InsertOrUpdate?</a></li><li><a href="#文章按赞计数器">文章按赞计数器</a></li><li><a href="#大流量文章按赞计数器">大流量文章按赞计数器</a></li><li><a href="#使用-siege-工具进行压力测试">使用 Siege 工具进行压力测试</a></li><li><a href="#完整-example-code">完整 Example Code</a></li></ul></details></li><li class="has-children"><details><summary>回归主题，推播统计 <a href="#回归主题推播统计">#</a></summary><ul><li><a href="#新增推播纪录">新增推播纪录</a></li><li><a href="#检视推播统计数字">检视推播统计数字</a></li><li><a href="#踩坑">踩坑</a></li></ul></details></li><li class="has-children"><details><summary>Pricing <a href="#pricing">#</a></summary><ul><li><a href="#functions">Functions</a></li><li><a href="#firestore">Firestore</a></li></ul></details></li><li class="has-children"><details><summary>结论 <a href="#结论">#</a></summary><ul><li><a href="#收费贵难迁移">收费贵、难迁移</a></li><li><a href="#仅供测试">仅供测试</a></li><li><a href="#更多功能">更多功能</a></li></ul></details></li><li><a href="#参考资料">参考资料</a></li><li><a href="#延伸阅读">延伸阅读</a></li></ul></nav><hr /><h3 id="使用-firebase-firestore--functions-快速搭建可供测试的-api-服务"><span class="me-2">使用 Firebase Firestore + Functions 快速搭建可供测试的 API 服务</span><a href="#使用-firebase-firestore--functions-快速搭建可供测试的-api-服务" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>当推播统计遇上 Firebase Firestore + Functions</p><p><a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" alt="Photo by [Carlos Muza](https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijk5NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Carlos Muza</a></p><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="推播精确统计功能"><span class="me-2">推播精确统计功能</span><a href="#推播精确统计功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>最近想为 APP 导入的功能，未实作前我们只能从后端 Post 资料给 APNS/FCM 的成功与否当作推播基数并记录推播点击，计算出「点击率」；但此方法其实非常不准确，基数包含许多无效装置，APP 已删除的（不一定会马上失效）、关闭推播权限的在后端 Post 时都还是会得到成功的回传。</p><p>在 iOS 10 之后可以透过实践 Notification Service Extension 在推播横幅出现时的时机点偷偷 Call API 回传做统计；好处是非常精准，只有在使用者推播横幅有出现才会 Call；如果 APP 删除、关闭通知、通知没开横幅，都不会有动作，横幅等于有出现推播讯息，用此当推播基数然后再算上点击数就能得到「精确的点击率」。</p><blockquote><p><em>详细原理及实作方式可参考之前的文章：「 <a href="/posts/zrealm-dev/zh-cn/ios-notification-service-extension-swift-%E5%AE%9E%E4%BD%9C%E5%9B%BE%E7%89%87%E6%8E%A8%E6%92%AD%E4%B8%8E%E6%98%BE%E7%A4%BA%E7%BB%9F%E8%AE%A1%E6%8A%80%E5%B7%A7-cb6eba52a342/">i <strong>OS ≥ 10 Notification Service Extension 应用 (Swift)</strong></a> 」</em></p></blockquote><blockquote><p><em>目前测试下来 APP 的 Loss 率应该是 0%，实际常见应用像是 Line 的讯息点对点加解密（推播的讯息是加密过的，在手机收到才解密然后显示出来）。</em></p></blockquote><h4 id="问题"><span class="me-2">问题</span><a href="#问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>APP 端的功其实不大，iOS/Android 都只要实作类似的功能（但 Android 如果要考虑中国市场就比较麻烦，要为更平台实作推播框架内容）；比较大的功是后端还有 Server 的压力处理，因为推播一次出去会同时 Call API 回传纪录，可能会塞爆 Server 的 max connection 如果又是使用 RDBMS 储存记录可能会更严重，如果发现统计数有 Loss 多半发生在此环节。</p><blockquote><p><em>这边可以以 log 写档案方式做纪录，要查询时在自行做统计显示。</em></p></blockquote><blockquote><p><em>另外，后来想想一次出去同时回来的情境，数量可能没有想像中的大；因为发推播也不会一口气发个十万百万笔，也是几笔几笔批次发送；只要能扛住批次发出去同时回来的数量即可！</em></p></blockquote><h3 id="prototype"><span class="me-2">Prototype</span><a href="#prototype" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>因原先有问题中的考量，后端需要花功力研究修改且市场也不一定在意做出来的成效；所以想说先用能使用的资源弄个 Prototype 出来试试水温。</p><p>这边选择的是 APP 几乎都会使用的 Firebase 服务，其中的 Functions 和 Firestore 功能。</p><h4 id="firebase-functions"><span class="me-2">Firebase Functions</span><a href="#firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://developers.google.com/learn/topics/functions" target="_blank">Functions</a> 是 Google 提供的 serverless 服务，只需撰写好程式逻辑，Google 自动帮你弄好伺服器、执行环境，也不用去管伺服器扩充及流量的问题。</p><p><a href="https://firebase.google.com/docs/functions" target="_blank">Firebase Functions</a> 其实就是 Google Cloud Functions 但只能使用 JavaScript (node.js) 撰写，没试过但如果用 Google Cloud Functions 选择用其他语言撰写然后同样 import Firebase 服务我想应该也能用。</p><p>用在 API 就是我可以写一个 node.js 档案，得到一个实体 URL (ex: my-project.cloudfunctions.net/getUser)，自行撰写取得 Request 资讯和给予相应的 Response 逻辑。</p><blockquote><p><em>之前写过一篇关于 Google Functions 的文章「 <a href="/posts/zrealm-dev/zh-cn/python-%E6%90%AD%E9%85%8D-google-cloud-platform-%E4%B8%8E-line-bot-%E6%89%93%E9%80%A0%E6%AF%8F%E6%97%A5%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0%E8%84%9A%E6%9C%AC%E4%B8%8E%E6%8E%92%E7%A8%8B-70a1409b149a/">使用 Python+Google Cloud Platform+Line Bot 自动执行例行琐事</a> 」</em></p></blockquote><blockquote><p><em>Firebase Functions 必须启用 Blaze 专案（用多少、付多少）才能使用。</em></p></blockquote><p><a href="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDkiIGhlaWdodD0iNTA3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="firebase-firestore"><span class="me-2">Firebase Firestore</span><a href="#firebase-firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://firebase.google.com/docs/firestore" target="_blank">Firebase Firestore</a> ，NoSql 资料库，用来存放、管理数据。</p><p>结合 Firebase Functions 可在 Request 时 import Firestore 进来操作资料库，然后Response 给使用者，就能搭建简单的 Restful API 服务！</p><blockquote><p>动手实作开始！</p></blockquote><h3 id="安装-nodejs-环境"><span class="me-2">安装 node.js 环境</span><a href="#安装-nodejs-环境" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>这边建议使用 NVM，node.js 版本管理工具进行安装管理（像 python 用 pyenv）。</p><p>到 NVM Github 专案复制安装 shell script：</p><p><a href="https://github.com/nvm-sh/nvm#installing-and-updating" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612230/53a0c44a-1f6e-4f8d-918f-89762fafe369" alt="" loading="lazy"></a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh <span class="se">\\</span>| bash
</pre></table></code></div></div><p>如果安装过程出现错误，请确认有 <code class="language-plaintext highlighter-rouge">~/.bashrc</code> 或 <code class="language-plaintext highlighter-rouge">~/.zshrc</code> 档案，没有可用 <code class="language-plaintext highlighter-rouge">touch ~/.bashrc</code> 或 <code class="language-plaintext highlighter-rouge">touch ~/.zshrc</code> 建立档案然后再跑一下 install script。</p><p>再来就可以使用 <code class="language-plaintext highlighter-rouge">nvm install node</code> 安装最新版的 node.js。</p><p><a href="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NzUiIGhlaWdodD0iMTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可下 <code class="language-plaintext highlighter-rouge">npm --version</code> 确认 npm 安装成功、安装版本：</p><p><a href="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNDgiIGhlaWdodD0iMzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h3 id="部署-firebase-functions"><span class="me-2">部署 Firebase Functions</span><a href="#部署-firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="安装-firebase-tools"><span class="me-2">安装 Firebase-tools：</span><a href="#安装-firebase-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>npm <span class="nb">install</span> <span class="nt">-g</span> firebase-tools
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MTIiIGhlaWdodD0iMjI1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>安装成功后，第一次使用请先输入：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase login
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDQ5IiBoZWlnaHQ9IjIxMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>完成 Firebase 登入验证。</p><p>启动专案：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase init
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODIiIGhlaWdodD0iNTI1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>记下 Firebase init 所在路径：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>You're about to initialize a Firebase project in this directory:
</pre></table></code></div></div><p>这边可以选择要安装的 Firebase CLI 工具，按 「↑」「↓」进行选择，「空白键」进行选择；这边可以只选择「Functions」或连「Firestore」一起选择安装。</p><p><strong>=== Functions Setup</strong></p><p><a href="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDYiIGhlaWdodD0iMTU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p>语言选择「 <strong>JavaScript</strong> 」</p><li><p>关于「use ESLint to catch probable bugs and enforce style」语法 style 检查 ， <strong>YES / NO 都可</strong> 。</p><li><p>install dependencies with npm? <strong>YES</strong></p></ul><p><strong>===Emulators Setup</strong></p><p><a href="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1ODAiIGhlaWdodD0iMjU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可在本地环境测试 Functions、Firestore 功能及设定，不会算在使用度且不需等到部署上线才能测试。</p><blockquote><p><em>依个人需求安装，我有装但没有用．．．因为只是小功能而已。</em></p></blockquote><h3 id="coding"><span class="me-2">Coding!</span><a href="#coding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>前往上述记下的路径，找到 <code class="language-plaintext highlighter-rouge">functions 资料夹</code> ，用编辑器打开里面的 <code class="language-plaintext highlighter-rouge">index.js</code> 档案。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">targetID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">targetID</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">action</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">targetID</span><span class="dl">"</span><span class="p">:</span> <span class="nx">targetID</span><span class="p">,</span> <span class="dl">"</span><span class="s2">action</span><span class="dl">"</span><span class="p">:</span> <span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span><span class="p">});</span>
    <span class="k">return</span>
<span class="p">})</span>
</pre></table></code></div></div><p>贴上以上内容，我们定义了一个路径接口 <code class="language-plaintext highlighter-rouge">/hello</code> 然后会回传 URL <strong>Query</strong> <code class="language-plaintext highlighter-rouge">?targetID=</code> 、 <strong>POST</strong> <code class="language-plaintext highlighter-rouge">action</code> 、 <code class="language-plaintext highlighter-rouge">name</code> 参数资讯。</p><p>修改＆储存完成后回到 console 下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase deploy
</pre></table></code></div></div><blockquote><p><strong><em>以后的每次修改都记得要回来下 <code class="language-plaintext highlighter-rouge">firebase deploy</code> 指令，才会生效。</em></strong></p></blockquote><p>开始验证＆部署到 Firebase…</p><p><a href="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjciIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可能需要稍等一下， <code class="language-plaintext highlighter-rouge">Deploy complete!</code> 后你的第一个 Request &amp; Response 网页就完成了！</p><p>这时候可以回到 Firebase -&gt; Functions 页面：</p><p><a href="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjI4NiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>就会看到刚刚撰写的接口和网址位置。</p><p>复制下方网址贴到 PostMan 测试：</p><p><a href="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDUiIGhlaWdodD0iNTExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><em>POST Body 记得选择 <code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> 。</em></p></blockquote><p><strong>成功！</strong></p><h3 id="log"><span class="me-2">Log</span><a href="#log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们可以在程式码中使用：</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">functions</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">log:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</pre></table></code></div></div><p>进行 Log 纪录。</p><p>并可在 Firebase -&gt; Functions -&gt; 纪录中查看 log 结果：</p><p><a href="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijc2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h3 id="example-goal"><span class="me-2">Example Goal</span><a href="#example-goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>建立一个可新增、修改、删除、查询文章和按赞的 API</p></blockquote><p>我们希望能达成 Restful API 的功能设计，所以不能再使用上面范例的纯 Path 方式，要改藉用 <code class="language-plaintext highlighter-rouge">Express</code> 框架达成。</p><h4 id="post-新增文章"><span class="me-2">POST 新增文章</span><a href="#post-新增文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// 这边的 POST 指的是 HTTP Method POST</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span> <span class="c1">// 这边的 POST 指的是 /post 路径</span>
</pre></table></code></div></div><p>现在我们改用 Express 来处理网路请求，这边先新增一个 路径 <code class="language-plaintext highlighter-rouge">/ 的 POST</code> 方法，最后一行表示路径都在 <code class="language-plaintext highlighter-rouge">/post</code> 之下，再来我们会加上修改、删除的 API。</p><p>下 <code class="language-plaintext highlighter-rouge">firebase deploy</code> 部署成功后，回到 Post Man 测试：</p><p><a href="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NTIiIGhlaWdodD0iNDI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Post Man 打成功后可以再到 Firebase -&gt; Firestore 检查一下资料是否有正确写入：</p><p><a href="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjk3IiBoZWlnaHQ9IjY2MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="put-修改文章"><span class="me-2">PUT 修改文章</span><a href="#put-修改文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">修改成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>部署＆测试方式如新增，Post Man Http Method 记得改成 <code class="language-plaintext highlighter-rouge">PUT</code> 。</p><h4 id="delete-删除文章"><span class="me-2">DELETE 删除文章</span><a href="#delete-删除文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">文章成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>部署＆测试方式如新增，Post Man Http Method 记得改成 <code class="language-plaintext highlighter-rouge">DELETE</code> 。</p><p>新增、修改、删除做完了，来做查询！</p><h4 id="select-查询文章"><span class="me-2">SELECT 查询文章</span><a href="#select-查询文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDQiIGhlaWdodD0iNjAzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>部署＆测试方式如新增，Post Man Http Method 记得改成 <code class="language-plaintext highlighter-rouge">GET</code> 还有将 <code class="language-plaintext highlighter-rouge">Body</code> 切回 <code class="language-plaintext highlighter-rouge">none</code> 。</p><h4 id="insertorupdate"><span class="me-2">InsertOrUpdate?</span><a href="#insertorupdate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>有时候我们需要当值存在时做更新，当值不存在时新增，这时候可以用 <code class="language-plaintext highlighter-rouge">set</code> 搭配 <code class="language-plaintext highlighter-rouge">merge: true</code> ：</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>这边以新增 tag 为例，部署＆测试方式如新增，可以看到 Firestore 不会一直重复新增新资料。</p><p><a href="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU3OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="文章按赞计数器"><span class="me-2">文章按赞计数器</span><a href="#文章按赞计数器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>假设我们的文章资料现在多一个 <code class="language-plaintext highlighter-rouge">likeCount</code> 栏位纪录按赞数量，那我们该怎么做呢？</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按赞成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>运用 <code class="language-plaintext highlighter-rouge">increment</code> 这个变数就能直接做到取出值 +1 的动作。</p><h4 id="大流量文章按赞计数器"><span class="me-2">大流量文章按赞计数器</span><a href="#大流量文章按赞计数器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因为 Firestore 有 <a href="https://cloud.google.com/firestore/quotas?hl=zh-tw#soft_limits" target="_blank">写入速度限制</a> 的：</p><p><a href="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4ODgiIGhlaWdodD0iNzAzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>一个文档一秒只能写入一次</strong> ，所以当按赞的人一多；同时请求下可能会变得很慢。</p><p>官方给的解决方法「 <a href="https://cloud.google.com/firestore/docs/solutions/counters#node.js_2" target="_blank">Distributed counters</a> 」其实也没什么高深的技术，就是多用几个分散的 likeCount 栏位来统计，然后读取的时候再加总起来。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按赞成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY4IiBoZWlnaHQ9IjYxMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>以上就是分散出栏位来纪录 Count 避免写入太慢；但如果分散的栏位太多会增加读取成本($$)，但应该还是比每次按赞都 add 一笔新纪录还便宜。</p><h4 id="使用-siege-工具进行压力测试"><span class="me-2">使用 Siege 工具进行压力测试</span><a href="#使用-siege-工具进行压力测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>使用 <code class="language-plaintext highlighter-rouge">brew</code> 安装 <code class="language-plaintext highlighter-rouge">siege</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>siege
</pre></table></code></div></div><p><em>p.s 如果你出现 brew: command not found 请先安装 <a href="https://brew.sh/index_zh-tw" target="_blank">brew</a> 套件管理工具</em> ：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span>
</pre></table></code></div></div><p>安装完成后可下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>siege <span class="nt">-c</span> 100 <span class="nt">-r</span> 1 <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="s1">'https://us-central1-project.cloudfunctions.net/post/like/id POST {}'</span>
</pre></table></code></div></div><p>进行压力测试：</p><ul><li><p><code class="language-plaintext highlighter-rouge">-c 100</code> ：100 个任务同步执行</p><li><p><code class="language-plaintext highlighter-rouge">-r 1</code> ：每个任务执行 1 次请求</p><li><p><code class="language-plaintext highlighter-rouge">-H ‘Content-Type: application/json’</code> ：如果是 POST 时需加上</p><li><p><code class="language-plaintext highlighter-rouge">‘https://us-central1-project.cloudfunctions.net/post/like/id POST {}’</code> ：POST 网址、Post Body (ex: <code class="language-plaintext highlighter-rouge">{“name”:”1234”}</code> )</p></ul><p>执行完成后可看到执行结果：</p><p><a href="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzODYiIGhlaWdodD0iMTk4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><code class="language-plaintext highlighter-rouge">successful_transactions: 100</code> 表示 100 次都执行成功。</p><p><strong>可以回 Firebase -&gt; Firestore 查看结果是否有 Loss Data：</strong></p><p><a href="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY5IiBoZWlnaHQ9IjYwOSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>成功！</p></blockquote><h4 id="完整-example-code"><span class="me-2">完整 Example Code</span><a href="#完整-example-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">修改成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">文章成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按赞成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按赞成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="回归主题推播统计"><span class="me-2">回归主题，推播统计</span><a href="#回归主题推播统计" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>回到一开始我们想做的，推播统计功能。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="kd">const</span> <span class="nx">vaildPlatformTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">iOS</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Android</span><span class="dl">"</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">vaildActionTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">]</span>

<span class="c1">// Insert Log</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">platformType</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">platformType</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">pushID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">pushID</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">actionType</span> <span class="o">=</span>  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">actionType</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">vaildPlatformTypes</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">platformType</span><span class="p">)</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="nx">pushID</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="err">\\</span><span class="o">|</span><span class="err">\\</span><span class="o">|</span> <span class="o">!</span><span class="nx">vaildActionTypes</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">actionType</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">参数错误！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">platformType</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">actionType</span><span class="o">+</span><span class="dl">"</span><span class="s2">_</span><span class="dl">"</span><span class="o">+</span><span class="nx">pushID</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
        <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">纪录成功！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// View Log</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:type/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// received</span>
    <span class="kd">const</span> <span class="nx">receivedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">received_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">receivedDocs</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">received</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="c1">// clicked</span>
    <span class="kd">const</span> <span class="nx">clickedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">clicked_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">clicked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">clickedDocs</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">clicked</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>
    
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">:</span><span class="nx">received</span><span class="p">,</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">:</span><span class="nx">clicked</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">notification</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h4 id="新增推播纪录"><span class="me-2">新增推播纪录</span><a href="#新增推播纪录" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDciIGhlaWdodD0iNDIyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="检视推播统计数字"><span class="me-2">检视推播统计数字</span><a href="#检视推播统计数字" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://us-centra1-xxx.cloudfunctions.net/notification/iOS/1
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDE3IiBoZWlnaHQ9IjQ4NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>另外也做了个介面统计推播数字。</p><h4 id="踩坑"><span class="me-2">踩坑</span><a href="#踩坑" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>因为对 node.js 用法不太熟悉，一开始摸索的时候在 add 资料时没加上 <code class="language-plaintext highlighter-rouge">await</code> 再加上写入速度限制，导致在大流量情况下会 Data Loss…</em></p></blockquote><p><a href="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NDUiIGhlaWdodD0iMTg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="pricing"><span class="me-2">Pricing</span><a href="#pricing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>别忘了参考 Firebase Functions &amp; Firestore 的定价策略。</p><h4 id="functions"><span class="me-2">Functions</span><a href="#functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/functions/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDIwIiBoZWlnaHQ9IjI2OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.webp" alt="运算时间" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTM4IiBoZWlnaHQ9IjU2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>运算时间</p><p><a href="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.webp" alt="网路" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjM1MSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>网路</p><blockquote><p><em>Cloud Functions 针对运算时间资源提供永久免费方案，当中包含 GB/秒和 GHz/秒的运算时间。除了 200 万次叫用以外，免费方案也提供 400,000 GB/秒和 200,000 GHz/秒的运算时间，以及每月 5 GB 的网际网路输出流量。</em></p></blockquote><h4 id="firestore"><span class="me-2">Firestore</span><a href="#firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/firestore/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/firestore/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjU4NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><a href="https://cloud.google.com/firestore/docs/billing-example?hl=zh-tw" target="_blank">计算范例</a></ul><blockquote><p><strong><em>价格可能随时更改，请以官网最新资讯为准。</em></strong></p></blockquote><h3 id="结论"><span class="me-2">结论</span><a href="#结论" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如同标题所写「可供测试」、「可供测试」、「可供测试」不太建议将以上服务用于正式环境，甚至当作产品的核心上线。</p><h4 id="收费贵难迁移"><span class="me-2">收费贵、难迁移</span><a href="#收费贵难迁移" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>之前曾听说某个蛮大的服务就是使用 Firebase 服务搭建起家，结果后期资料、流量大，收费爆贵；要转移也很困难，程式还好但资料非常难搬；只能说是初期省了小钱却造成后期巨大的亏损，不值得。</p><h4 id="仅供测试"><span class="me-2">仅供测试</span><a href="#仅供测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因为以上原因，使用 Firebase Functions + Firestore 搭建的 API 服务个人建议仅供测试或是 Prototype 产品展示。</p><h4 id="更多功能"><span class="me-2">更多功能</span><a href="#更多功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Functions 还可以串 Authentication(身份验证)、Storage(档案上传)，但这部分我就没研究了。</p><h3 id="参考资料"><span class="me-2">参考资料</span><a href="#参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="https://firebase.google.com/docs/firestore/query-data/queries" target="_blank">https://firebase.google.com/docs/firestore/query-data/queries</a></p><li><p><a href="https://coder.tw/?p=7198" target="_blank">https://coder.tw/?p=7198</a></p><li><p><a href="https://firebase.google.com/docs/firestore/solutions/counters#node.js_1" target="_blank">https://firebase.google.com/docs/firestore/solutions/counters#node.js_1</a></p><li><p><a href="https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80" target="_blank">https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80</a></p></ul><h3 id="延伸阅读"><span class="me-2">延伸阅读</span><a href="#延伸阅读" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="/posts/zrealm-dev/zh-cn/python-%E6%90%AD%E9%85%8D-google-cloud-platform-%E4%B8%8E-line-bot-%E6%89%93%E9%80%A0%E6%AF%8F%E6%97%A5%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0%E8%84%9A%E6%9C%AC%E4%B8%8E%E6%8E%92%E7%A8%8B-70a1409b149a/">使用 Python+Google Cloud Platform+Line Bot 自动执行例行琐事</a></p><li><p><a href="/posts/zrealm-dev/zh-cn/ios-notification-service-extension-swift-%E5%AE%9E%E4%BD%9C%E5%9B%BE%E7%89%87%E6%8E%A8%E6%92%AD%E4%B8%8E%E6%98%BE%E7%A4%BA%E7%BB%9F%E8%AE%A1%E6%8A%80%E5%B7%A7-cb6eba52a342/">i <strong>OS ≥ 10 Notification Service Extension 应用 (Swift)</strong></a></p><li><p><a href="/posts/zrealm-dev/zh-cn/google-apps-script-%E6%95%99%E5%AD%A6-%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91-gmail-%E9%82%AE%E4%BB%B6%E5%88%B0-slack-channel-%E5%AE%A2%E5%88%B6%E5%8C%96%E9%80%9A%E7%9F%A5-d414bdbdb8c9/">运用 Google Apps Script 转发 Gmail 信件到 Slack</a></p></ul><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/9659db1357e4" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2021-03-23-9659db1357e4.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/firebase/" class="post-tag no-text-decoration" >firebase</a> <a href="/tags/google-cloud-platform/" class="post-tag no-text-decoration" >google-cloud-platform</a> <a href="/tags/notifications/" class="post-tag no-text-decoration" >notifications</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Firebase%20Firestore%EF%BD%9CFunctions%20%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8%20API%20%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B5%258B%25E8%25AF%2595%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258A%25A1%25E6%2595%2599%25E5%25AD%25A6%25E4%25B8%258E%25E6%258E%25A8%25E6%2592%25AD%25E7%25BB%259F%25E8%25AE%25A1%25E5%25AE%259E%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Firebase%20Firestore%EF%BD%9CFunctions%20%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B5%8B%E8%AF%95%E7%94%A8%20API%20%E6%9C%8D%E5%8A%A1%E6%95%99%E5%AD%A6%E4%B8%8E%E6%8E%A8%E6%92%AD%E7%BB%9F%E8%AE%A1%E5%AE%9E%E4%BD%9C%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B5%258B%25E8%25AF%2595%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258A%25A1%25E6%2595%2599%25E5%25AD%25A6%25E4%25B8%258E%25E6%258E%25A8%25E6%2592%25AD%25E7%25BB%259F%25E8%25AE%25A1%25E5%25AE%259E%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B5%258B%25E8%25AF%2595%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258A%25A1%25E6%2595%2599%25E5%25AD%25A6%25E4%25B8%258E%25E6%258E%25A8%25E6%2592%25AD%25E7%25BB%259F%25E8%25AE%25A1%25E5%25AE%259E%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/line-bank-to-firstrade-transfer-fast-deposit-150-nt-fee-guide-with-account-upgrade-fee-subsidy-e4d139fe0685/">LINE Bank to Firstrade Transfer｜Fast Deposit & 150 NT Fee Guide with Account Upgrade & Fee Subsidy</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/line-bank-%E5%85%A5%E9%87%91-firstrade-%E6%95%99%E5%AD%A6-%E5%BF%AB%E9%80%9F%E5%88%B0%E5%B8%90-%E4%BD%8E%E6%89%8B%E7%BB%AD%E8%B4%B9150%E5%85%83-%E5%B8%90%E6%88%B7%E5%8D%87%E7%BA%A7%E4%B8%8E%E6%89%8B%E7%BB%AD%E8%B4%B9%E8%A1%A5%E5%8A%A9%E7%94%B3%E8%AF%B7%E5%85%A8%E6%94%BB%E7%95%A5-e4d139fe0685/">手把手教学 — LINE Bank 入金 Firstrade 快速到帐、手续费只要 150 元及帐户升级/约定转帐/手续费补助申请教学</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/line-bank-%E5%85%A5%E9%87%91-firstrade-%E6%95%99%E5%AD%B8-%E5%BF%AB%E9%80%9F%E5%88%B0%E5%B8%B3-%E4%BD%8E%E6%89%8B%E7%BA%8C%E8%B2%BB150%E5%85%83-%E5%B8%B3%E6%88%B6%E5%8D%87%E7%B4%9A%E8%88%87%E6%89%8B%E7%BA%8C%E8%B2%BB%E8%A3%9C%E5%8A%A9%E7%94%B3%E8%AB%8B%E5%85%A8%E6%94%BB%E7%95%A5-e4d139fe0685/">手把手教學 — LINE Bank 入金 Firstrade 快速到帳、手續費只要 150 元及帳戶升級/約定轉帳/手續費補助申請教學</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/en/ios-shortcut-automation-auto-forward-sms-create-reminder-tasks-effortlessly-309d0302877b/">iOS Shortcut Automation｜Auto-Forward SMS & Create Reminder Tasks Effortlessly</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/ios-%E6%8D%B7%E5%BE%84%E8%87%AA%E5%8A%A8%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%AE%80%E8%AE%AF%E4%B8%8E%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E6%95%99%E5%AD%A6-309d0302877b/">iOS 捷径自动化应用场景 — 自动转发简讯与自动建立提醒待办事项</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1616519374" data-df="ll" > Mar 24, 2021 </time><h4 class="pt-0 my-2">使用 Firebase Firestore + Functions 快速搭建可供測試的 API 服務</h4><div class="text-muted"><p>當推播統計遇上 Firebase Firestore + Functions</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/firebase-firestore-functions-build-testable-api-services-fast-for-push-notification-analytics-9659db1357e4/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1616519374" data-df="ll" > Mar 24, 2021 </time><h4 class="pt-0 my-2">Firebase Firestore + Functions｜Build Testable API Services Fast for Push Notification Analytics</h4><div class="text-muted"><p>Developers facing challenges in push notification analytics can leverage Firebase Firestore and Functions to rapidly build and test scalable API services, boosting development efficiency and data a...</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/google-apps-script-%E5%BF%AB%E9%80%9F%E4%B8%B2%E6%8E%A5-firebase-app-distribution-api-%E6%95%99%E5%AD%A6%E4%B8%8E%E8%BF%9B%E9%98%B6%E8%AE%BE%E5%AE%9A-71400d408dc8/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1742479968" data-df="ll" > Mar 20, 2025 </time><h4 class="pt-0 my-2">Google Apps Script x Google APIs 快速串接整合方式</h4><div class="text-muted"><p>以 Google Apps Script x Firebase App Distribution API 串接为例</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/firebase-firestore-functions-build-testable-api-services-fast-for-push-notification-analytics-9659db1357e4/" class="btn btn-outline-primary" aria-label="Older" ><p>Firebase Firestore + Functions｜Build Testable API Services Fast for Push Notification Analytics</p></a> <a href="/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/" class="btn btn-outline-primary" aria-label="Newer" ><p>使用 Firebase Firestore + Functions 快速搭建可供測試的 API 服務</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
