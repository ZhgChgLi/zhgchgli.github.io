<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对 iOS AVPlayer 播放 HLS m3u8 串流时无法拦截快取的痛点，深入分析多种快取方案，从 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技术瓶颈与可行解法，助你优化串流体验并有效节省伺服器与流量成本。" /><meta property="og:description" content="针对 iOS AVPlayer 播放 HLS m3u8 串流时无法拦截快取的痛点，深入分析多种快取方案，从 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技术瓶颈与可行解法，助你优化串流体验并有效节省伺服器与流量成本。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-09T01:12:17+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" /><meta property="twitter:title" content="iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T16:09:26+08:00","datePublished":"2020-04-09T01:12:17+08:00","description":"针对 iOS AVPlayer 播放 HLS m3u8 串流时无法拦截快取的痛点，深入分析多种快取方案，从 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技术瓶颈与可行解法，助你优化串流体验并有效节省伺服器与流量成本。","headline":"iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/"}</script><title>iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/"><link rel="stylesheet" href="/assets/css/post-toc.css"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,049+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析</h1><p class="post-desc fw-light mb-4">针对 iOS AVPlayer 播放 HLS m3u8 串流时无法拦截快取的痛点，深入分析多种快取方案，从 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技术瓶颈与可行解法，助你优化串流体验并有效节省伺服器与流量成本。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1586365937" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 9, 2020 </time> </span> <span> Updated <time data-ts="1712995766" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" class="popup img-link preview-img blur"><img data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3010 words" > <em>16 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters 🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS HLS Cache 实作全攻略｜AVPlayer 串流边播边快取技术解析</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目录</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>iOS HLS Cache 实践方法探究之旅 <a href="#ios-hls-cache-实践方法探究之旅">#</a></summary><ul><li><a href="#20230312-update">[2023/03/12] Update</a></li></ul></details></li><li><a href="#关于">关于</a></li><li><a href="#目标">目标</a></li><li><a href="#问题">问题</a></li><li><a href="#20210105-更新">2021–01–05 更新</a></li><li class="has-children"><details><summary>实践方案 <a href="#实践方案">#</a></summary><ul><li><a href="#方案-1-avassetresourceloaderdelegate-">方案 1. AVAssetResourceLoaderDelegate ❌</a></li><li><a href="#方案-21-urlprotocol-拦截请求-">方案 2.1 URLProtocol 拦截请求 ❌</a></li><li><a href="#方案-22-暴力让他能进-urlprotocol-">方案 2.2 暴力让他能进 URLProtocol ❌</a></li><li><a href="#方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-来实现-">方案 2.2–2 同方案 2.2 但是搭配 方案 1 AVAssetResourceLoaderDelegate 来实现 ❌</a></li><li><a href="#方案-3-reverse-proxy-server--可行但非完美">方案 3. Reverse Proxy Server ⍻ (可行，但非完美)</a></li><li><a href="#方案-4-使用-http-client-本身的-caching-机制-">方案 4. 使用 HTTP Client 本身的 caching 机制 ❌</a></li><li><a href="#方案-5-不使用-avfoundation-avplayer-播放音讯档-">方案 5. 不使用 AVFoundation AVPlayer 播放音讯档 ✔</a></li><li><a href="#方案-51-不使用-hls">方案 5–1. 不使用 HLS</a></li><li><a href="#方案-6-将-ts-分割档转成-mp3mp4-档案-">方案 6. 将 .ts 分割档转成 .mp3/.mp4 档案 ✔</a></li><li><a href="#方案-7-下载完整档案后再播放-">方案 7. 下载完整档案后再播放 ⍻</a></li></ul></details></li><li class="has-children"><details><summary>结语 <a href="#结语">#</a></summary><ul><li><a href="#参考资料">参考资料</a></li></ul></details></li></ul></nav><hr /><h3 id="ios-hls-cache-实践方法探究之旅"><span class="me-2">iOS HLS Cache 实践方法探究之旅</span><a href="#ios-hls-cache-实践方法探究之旅" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>使用 AVPlayer 播放 m3u8 串流影音档时如何做到边播放边 Cache 的功能</p><p><a href="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*x_Js63o52qJMmYHKIuKF7A.webp" alt="photo by [Mihis Alex](https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>photo by <a href="https://www.pexels.com/zh-tw/@mcraftpix?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" target="_blank">Mihis Alex</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>下篇「 <a href="/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/">AVPlayer 实践本地 Cache 功能大全</a> 」教您实现 AVPlayer Caching</ul><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>我将之前的实作开源了，有需求的朋友可直接使用。</p><ul><li><p>客制化 Cache 策略，可以用 PINCache or 其他…</p><li><p>外部只需呼叫 make AVAsset 工厂，带入 URL，则 AVAsset 就能支援 Caching</p><li><p>使用 Combine 实现 Data Flow 策略</p><li><p>写了一些测试</p></ul><h3 id="关于"><span class="me-2">关于</span><a href="#关于" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>HTTP Live Streaming (简称HLS) 是苹果提出基于HTTP的串流媒体网络传输协议。</p><p>以播放音乐来说，非串流情况下我们使用 mp3 作为音乐档，这个档案有多大就要花多久时间全部下载下来才能播放；而 HLS 就是把一个档案分割成多个小档案，读到哪播到哪，所以拿到第一个分割区块就能开始播放，不用整个都下载完！</p><p><code class="language-plaintext highlighter-rouge">.m3u8</code> 档就是纪录这些分割的 <code class="language-plaintext highlighter-rouge">.ts</code> 小档案的码率、播放顺序、时间 还有整个音讯的资讯，另外也可以做加解密保护、低延迟直播…等等</p><p><code class="language-plaintext highlighter-rouge">.m3u8</code> 档范例(aviciiwakemeup.m3u8)：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>#EXTM3U
#EXT-X-VERSION:3
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:9.900411,
aviciiwakemeup–00001.ts
#EXTINF:9.900400,
aviciiwakemeup–00002.ts
#EXTINF:9.900411,
aviciiwakemeup–00003.ts
#EXTINF:9.900411,
.
.
.
#EXTINF:6.269389,
aviciiwakemeup-00028.ts
#EXT-X-ENDLIST
</pre></table></code></div></div><p><em>*EXT-X-ALLOW-CACHE 已在 <a href="https://developer.apple.com/documentation/http_live_streaming/about_the_ext-x-version_tag?language=objc" target="_blank">iOS≥ 8/Protocol Ver.7 deprecated</a> ，有没有这行都没有用意义了。</em></p><h3 id="目标"><span class="me-2">目标</span><a href="#目标" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>对于一个影音串流服务， <strong>Cache 非常之重要</strong> ；因为每个音讯档案小则 MB 大则几 GB ，如果每次重播都要再从伺服器拉一次档案，对 Server 的 Loading 来说非常吃力，而且流量都是 \(\) ，如果有个 Cache 层能为服务节省许多金钱，对使用者来说也不用浪费网路、浪费时间重新下载；是一个双赢的机制 (但要记得设定上限/定时清除，避免把使用者的设备塞爆)。</p><h3 id="问题"><span class="me-2">问题</span><a href="#问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>以往非串流时 mp3/mp4 没什么好处理的，就是在播放前先下载到设备上，下载完成才开始播放；反正不管怎样都要载完才能播，那不如我们自己用 URLSession 下载完档案后再喂 file:// 下载在本地的档案路径给 AVPlayer 做播放即可；或正规方式，使用 AVAssetResourceLoaderDelegate 在 Delegate 方法中对下载的资料进行 Cache 缓存。</p><p>遇到串流想法其实也很直白，就是先读 <code class="language-plaintext highlighter-rouge">.m3u8</code> 档，然后在解析里面的资讯，对每个 <code class="language-plaintext highlighter-rouge">.ts</code> 档做 Cache 即可；但实作发现事情没有这么简单，处理难度超乎我的想像，所以才会有此篇文章！</p><p>播放部分我们一样直接使用 iOS AVFoundation 的 AVPlayer，在操作上串流/非串流档案没有差异。</p><p><strong>Example:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span><span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span><span class="s">"https://zhgchg.li/aviciiwakemeup.m3u8"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><h3 id="20210105-更新"><span class="me-2"><strong>2021–01–05 更新：</strong></span><a href="#20210105-更新" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我们退而求其次退回去使用 mp3 档，这样就能直接使用 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> 进行实作，详细实作可参考「 <a href="/posts/zh-cn/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/">AVPlayer 边播边 Cache 实战</a> 」。</p><h3 id="实践方案"><span class="me-2">实践方案</span><a href="#实践方案" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>针对我们的目标能达成的几个方案及实践时遇到的问题。</p><h4 id="方案-1-avassetresourceloaderdelegate-"><span class="me-2">方案 1. AVAssetResourceLoaderDelegate ❌</span><a href="#方案-1-avassetresourceloaderdelegate-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>第一个想法就是，那我们就照 mp3/mp4 时的做法就好啦！一样用 AVAssetResourceLoaderDelegate 在 Delegate 方法中缓存 <code class="language-plaintext highlighter-rouge">.ts</code> 档案。</p><p>不过很抱歉，此路不通，因为无法在 Delegate 中拦截到 <code class="language-plaintext highlighter-rouge">.ts</code> 档案的下载请求资讯，可以在这则 <a href="https://stackoverflow.com/questions/29752028/unknown-error-12881-when-using-avassetresourceloader/30239876#30239876" target="_blank">问答</a> 和 <a href="https://developer.apple.com/library/archive/technotes/tn2232/_index.html#//apple_ref/doc/uid/DTS40012884-CH1-SECHTTPLIVESTREAMING" target="_blank">官方文件</a> 上确切此事。</p><p>AVAssetResourceLoaderDelegate 实作可参考「 <a href="/posts/zh-cn/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/">AVPlayer 边播边 Cache 实战</a> 」。</p><h4 id="方案-21-urlprotocol-拦截请求-"><span class="me-2">方案 2.1 URLProtocol 拦截请求 ❌</span><a href="#方案-21-urlprotocol-拦截请求-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>URLProtocol 也是最近才学到的方法，所有基于 <code class="language-plaintext highlighter-rouge">URL Loading System</code> 的请求 (URLSession、Call API、下载图片…) 都可以被我们拦截下来修改 Request、Response 然后再返回，一切就像没发生一样，偷偷来；关于 URLProtocol 可以参考 <a href="https://www.jianshu.com/p/fbe57730d3e1" target="_blank">此篇文章</a> 。</p><p>应用此方法，我们打算拦截 AVFoundation AVPlayer 在要求 <code class="language-plaintext highlighter-rouge">.m3u8</code> 、 <code class="language-plaintext highlighter-rouge">.ts</code> 的请求时，拦截下来然后如果本地有 Cache 就直接返回 Cache Data，没有则再真的再发 Request 出去；这样也能达到我们的目标。</p><p>一样，很抱歉，此路也不通；因为 AVFoundation AVPlayer 的请求不是在 <code class="language-plaintext highlighter-rouge">URL Loading System</code> 上，我们无从拦截。 <em>*有一说是 模拟器上可以但实机上不行</em></p><h4 id="方案-22-暴力让他能进-urlprotocol-"><span class="me-2">方案 2.2 暴力让他能进 URLProtocol ❌</span><a href="#方案-22-暴力让他能进-urlprotocol-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>根据 方案 2.1 脑洞大开的暴力法，如果我把请求网址换成一个自订的 Scheme (EX: streetVoiceCache://)，因 AVFoundation 无法处理这个请求，所以会丢出来，这样我们的 URLProtocol 就能拦截到，做我们想做的事。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">url</span><span class="p">:</span><span class="kt">URL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span><span class="s">"streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originSchme=https"</span><span class="p">)</span>
<span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="n">player</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
</pre></table></code></div></div><p>URLProtocol 会拦截到 <code class="language-plaintext highlighter-rouge">streetVoiceCache://zhgchg.li/aviciiwakemeup.m3u8?originSchme=https</code> ，这时我们只要帮他还原成原来的网址，然后发个 URLSession 去要资料就能在这边自己做 Cache；m3u8 中的 <code class="language-plaintext highlighter-rouge">.ts</code> 档案请求一样也会被 URLProtocol 拦截到，一样我们能在这自己做 Cache。</p><p>一切看似都那么完美，但当我兴高采烈的 Build-Run 完 APP 后，苹果直接搧了我一巴掌：</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p>他不吃我给 <code class="language-plaintext highlighter-rouge">.ts</code> 档案 Request 的 Response Data，我只能用 <code class="language-plaintext highlighter-rouge">urlProtocol:wasRedirectedTo</code> 这个方法 redirectTo 原始 Https 请求才能正常播放，即使我把 <code class="language-plaintext highlighter-rouge">.ts</code> 档案下载到本地然后 redirectTo 那个 file:// 档案；他也不接受，查 <a href="https://forums.developer.apple.com/thread/30833" target="_blank">官方论坛</a> 得到答案就是不能这样做； <code class="language-plaintext highlighter-rouge">.m3u8</code> 只能是来源于 Http/Https (所以即使你把整个 <code class="language-plaintext highlighter-rouge">.m3u8</code> 还有所有分割档 <code class="language-plaintext highlighter-rouge">.ts</code> 都放在本地，有无法使用 file:// 给 AVPlayer播放)，另外 <code class="language-plaintext highlighter-rouge">.ts</code> 也不能使用 URLProtocol 自行给予 Data。</p><p><code class="language-plaintext highlighter-rouge">fxxk…</code></p><h4 id="方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-来实现-"><span class="me-2">方案 2.2–2 同方案 2.2 但是搭配 方案 1 AVAssetResourceLoaderDelegate 来实现 ❌</span><a href="#方案-222-同方案-22-但是搭配-方案-1-avassetresourceloaderdelegate-来实现-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>实作方式如方案 2.2 ，喂给 AVPlayer 自订的 Scheme 让他进 AVAssetResourceLoaderDelegate；然后我们在自己处理。</p><p>同 2.2 结果：</p><p><code class="language-plaintext highlighter-rouge">Error: 12881 “CoreMediaErrorDomain custom url not redirect”</code></p><p><a href="https://forums.developer.apple.com/thread/113063" target="_blank">官方论坛</a> 同样的回答。</p><p>可以拿来做解密处理(可以参考 <a href="https://medium.com/@marslin_dev/how-to-play-aes-encrypted-video-with-airplay-2-82a353044f40" target="_blank">此篇文章</a> 或 <a href="https://www.jianshu.com/p/2c2cbe173e99" target="_blank">此范例</a> )但还是无法实现 Cache 功能。</p><h4 id="方案-3-reverse-proxy-server--可行但非完美"><span class="me-2">方案 3. Reverse Proxy Server ⍻ (可行，但非完美)</span><a href="#方案-3-reverse-proxy-server--可行但非完美" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>这个方法是在找如何处理 HLS Cache 时，最多人给的答案；就是在 APP 上起一个 HTTP Server 做 Reverse Proxy Server 服务。</p><p>原理也很简单，APP 上 On 一个 HTTP Server 假设是 8080 Port，网址就会是 <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/</code> ；然后我们可以对连进来的 Request 做处理，给出 Response。</p><p>套用到我们的案例就是，把请求网址换成： <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/aviciiwakemeup.m3u8?origin=http://zhgchg.li/</code></p><p>在 HTTP Server 的 Handler 上对 <code class="language-plaintext highlighter-rouge">*.m3u8</code> 拦截处理，这时有 Request 进来就会进到我们的 Handler 中，看我们想干嘛就干嘛，想 Response 什么 Data 都是我们自己控制， <code class="language-plaintext highlighter-rouge">.ts</code> 档同样会进来；这边就可以做我们想做的 Cache 机制。</p><p>对 AVPlayer 来说就是个 http://.m3u8 的标准串流音讯档，所以不会有任何问题。</p><p><strong>完整实作范例可参考：</strong></p><p><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer/blob/master/Sources/HLSCachingReverseProxyServer/HLSCachingReverseProxyServer.swift" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/f82feda77c302ecf87673688fe78a46bccc4669783dda9b10093ecb5382f9895/StyleShare/HLSCachingReverseProxyServer" alt="" loading="lazy"></a></p><p>因为我也是参考此范例做的，所以 Local HTTP Server 的部分我也是使用 <a href="https://github.com/swisspol/GCDWebServer" target="_blank">GCDWebServer</a> ，另外还有更新的 <a href="https://github.com/Building42/Telegraph" target="_blank">Telegraph</a> 可以使用。( <a href="https://github.com/robbiehanson/CocoaHTTPServer" target="_blank">CocoaHttpServer</a> 太久没更新就不推荐用了)</p><p><strong>看起来不错！但有个问题：</strong></p><p>我们的服务是音乐串流而非影音播放平台，音乐串流很多时候使用者都是在背景执行音乐切换的；这时候 Local HTTP Server 还会在？？</p><p>GCDWebServer 的说明是当进入背景时会自动断线、回前景自动恢复，但可以透过设置参数 <code class="language-plaintext highlighter-rouge">GCDWebServerOption_AutomaticallySuspendInBackground:false</code> 不让他有这个机制。</p><p>但是实测如果一段时间没有发送请求 Server 还是会断线 (且状态会是错的，还是 isRunning) 感觉就是被系统砍了；深掘了 <a href="https://izeeshan.wordpress.com/2014/08/25/local-http-server-for-ios/" target="_blank">HTTP Server 的做法</a> 后发现底层都是基于 socket，查了 <a href="https://developer.apple.com/library/archive/technotes/tn2277/_index.html" target="_blank">官方对 socket 服务的文件</a> 后，此缺陷是无法解决的，本来在背景下没有新的连接时就会被系统暂停。</p><p><em>*网路上有找到很绕的方法…就是发个长请求、或不断发空的请求确保 Server 在背景不会被系统暂停掉。</em></p><p>以上都是针对 APP 在背景的状况，在前景时 Server 很稳，也不会因为闲置被暂停，没这问题！</p><p><strong>是说毕竟是依赖在其他服务上，开发环境测试没问题，实际应用也建议要接个 rollback 处理(AVPlayer.AVPlayerItemFailedToPlayToEndTimeErrorKey 通知)；否则有个万一服务挂掉，使用者会卡死。</strong></p><p><code class="language-plaintext highlighter-rouge">所以说不完美啊…</code></p><h4 id="方案-4-使用-http-client-本身的-caching-机制-"><span class="me-2">方案 4. 使用 HTTP Client 本身的 caching 机制 ❌</span><a href="#方案-4-使用-http-client-本身的-caching-机制-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我们的 <code class="language-plaintext highlighter-rouge">.m3u8/.ts</code> 档的 Response Headers 都有给予 <code class="language-plaintext highlighter-rouge">Cache-Control</code> 、 <code class="language-plaintext highlighter-rouge">Age</code> 、 <code class="language-plaintext highlighter-rouge">eTag</code> … 这些 HTTP Client Cache 资讯；我们的网站 Cache 机制在 Chrome 上使用也完全没问题，另外也在官方新的针对 <a href="https://developer.apple.com/documentation/http_live_streaming/protocol_extension_for_low-latency_hls_preliminary_specification" target="_blank">Protocol Extension for Low-Latency HLS (低延迟HLS)</a> 初步规格文件中提到 Cache 的地方也看到可以设定 cache-control headers 来做缓存。</p><p><a href="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*vyvVp1sf9Hbtb_nWiLXYEg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzEiIGhlaWdodD0iMTM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>但实际 AVFoundation AVPlayer 并没有任何 HTTP Client Caching 效果，此路也不通！单纯痴人说梦。</p><h4 id="方案-5-不使用-avfoundation-avplayer-播放音讯档-"><span class="me-2">方案 5. 不使用 AVFoundation AVPlayer 播放音讯档 ✔</span><a href="#方案-5-不使用-avfoundation-avplayer-播放音讯档-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>自己实现音讯档解析、缓存、编码、播放功能。</p><p><strong>太硬核了，需要很深的技术能力及大量时间；没研究。</strong></p><p>附上一个网路开源播放器做参考： <a href="https://github.com/muhku/FreeStreamer" target="_blank">FreeStreamer</a> ，真要选择此方案不如站在巨人的肩膀上，直接用第三方套件了。</p><h4 id="方案-51-不使用-hls"><span class="me-2">方案 5–1. 不使用 HLS</span><a href="#方案-51-不使用-hls" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>同方案 5 ， <strong>太硬核了，需要很深的技术能力及大量时间；没研究。</strong></p><h4 id="方案-6-将-ts-分割档转成-mp3mp4-档案-"><span class="me-2">方案 6. 将 .ts 分割档转成 .mp3/.mp4 档案 ✔</span><a href="#方案-6-将-ts-分割档转成-mp3mp4-档案-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>没研究，但的确可行；不过想起来就觉得复杂，要处理已下载的 <code class="language-plaintext highlighter-rouge">.ts</code> 档案，个别转成 .mp3 或 .mp4 档案然后照顺序播放、或是压缩成一个档案什么的，想起来就不太好做。</p><p>有兴趣可参考 <a href="https://github.com/xyqjay/m3u8ToMP4" target="_blank">此篇文章</a> 。</p><h4 id="方案-7-下载完整档案后再播放-"><span class="me-2">方案 7. 下载完整档案后再播放 ⍻</span><a href="#方案-7-下载完整档案后再播放-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>这个方法不能确切叫边播边 Cache，实际是载下整个音讯档案的内容，然后才开始播放；如果是 <code class="language-plaintext highlighter-rouge">.m3u8</code> 如同方案 2.2 提到的，不能直接载下来放在本地播放。</p><p>要实作的话要用到 iOS ≥ 10 的 API <code class="language-plaintext highlighter-rouge">AVAssetDownloadTask.makeAssetDownloadTask</code> ，实际会将 . <code class="language-plaintext highlighter-rouge">m3u8</code> 打包成 <strong><code class="language-plaintext highlighter-rouge">.movpkg</code></strong> 放在本地，供使用者播放。</p><p><strong>这边比较像是做离线播放而非做 Cache 的功能。</strong></p><p>另外使用者也能从「设定」-&gt;「一般」-&gt;「iPhone 储存空间」-&gt; APP 中查看、管理已下载打包的音讯档案。</p><p><a href="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.webp" class="popup img-link blur"><img data-src="/assets/d796bf8e661e/1*_YNIdy8NRkhVdeDTNvXzxA.webp" alt="下方 已下载的影片 部分" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTAiIGhlaWdodD0iMTMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>下方 已下载的影片 部分</p><p><strong>详细实作可参考此范例：</strong></p><p><a href="https://github.com/zhonglaoban/HLS-Stream" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/a2ceae202336428494e5cd51b78cfbba3d139c135eaf232b4d2dffd2a7673eba/zhonglaoban/HLS-Stream" alt="" loading="lazy"></a></p><h3 id="结语"><span class="me-2">结语</span><a href="#结语" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>以上的探索路程大概花了快一整周，绕来绕去、快要丧心病狂了；目前还没有一个可靠的、容易部署的方法。</p><p>如果有新的想法再来更新!</p><h4 id="参考资料"><span class="me-2">参考资料</span><a href="#参考资料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><a href="http://msching.github.io/blog/2016/05/24/audio-in-ios-9/" target="_blank">iOS音频播放 (九)：边播边缓存</a></p><li><p><a href="https://github.com/StyleShare/HLSCachingReverseProxyServer" target="_blank">StyleShare/HLSCachingReverseProxyServer</a></p></ul><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/d796bf8e661e" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2020-04-08-d796bf8e661e.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,049+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/hls/" class="post-tag no-text-decoration" >hls</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/reverse-proxy/" class="post-tag no-text-decoration" >reverse-proxy</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20HLS%20Cache%20%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5%EF%BD%9CAVPlayer%20%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-hls-cache-%25E5%25AE%259E%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E8%25BE%25B9%25E6%2592%25AD%25E8%25BE%25B9%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E6%259C%25AF%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20HLS%20Cache%20%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5%EF%BD%9CAVPlayer%20%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-hls-cache-%25E5%25AE%259E%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E8%25BE%25B9%25E6%2592%25AD%25E8%25BE%25B9%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E6%259C%25AF%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-hls-cache-%25E5%25AE%259E%25E4%25BD%259C%25E5%2585%25A8%25E6%2594%25BB%25E7%2595%25A5-avplayer-%25E4%25B8%25B2%25E6%25B5%2581%25E8%25BE%25B9%25E6%2592%25AD%25E8%25BE%25B9%25E5%25BF%25AB%25E5%258F%2596%25E6%258A%2580%25E6%259C%25AF%25E8%25A7%25A3%25E6%259E%2590-d796bf8e661e%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and Efficiency｜Tool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD 实战指南（一）：CI/CD 是什么？如何透过 CI/CD 打造稳定高效的开发团队？工具选择？</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD 實戰指南（一）：CI/CD 是什麼？如何透過 CI/CD 打造穩定高效的開發團隊？工具選擇？</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web App｜Integrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">使用 Google Apps Script Web App 表单串接 Github Action CI/CD 工作</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters 🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586365937" data-df="ll" > Apr 9, 2020 </time><h4 class="pt-0 my-2">iOS HLS Cache 實踐方法探究之旅</h4><div class="text-muted"><p>使用 AVPlayer 播放 m3u8 串流影音檔時如何做到邊播放邊 Caching 的功能</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586365937" data-df="ll" > Apr 9, 2020 </time><h4 class="pt-0 my-2">iOS HLS Cache｜Optimize AVPlayer Streaming with Real-Time Caching Techniques</h4><div class="text-muted"><p>Discover how to implement real-time caching for m3u8 streaming on iOS using AVPlayer, solving buffering issues and enhancing playback smoothness for seamless video experiences.</p></div></div></a></article><article class="col"> <a href="/posts/zh-cn/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer 边播边 Cache 实战</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset 实作 AVAssetResourceLoaderDelegate 达成边播放音乐/影片边缓存</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/ios-hls-cache-optimize-avplayer-streaming-with-real-time-caching-techniques-d796bf8e661e/" class="btn btn-outline-primary" aria-label="Older" ><p>iOS HLS Cache｜Optimize AVPlayer Streaming with Real-Time Caching Techniques</p></a> <a href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" class="btn btn-outline-primary" aria-label="Newer" ><p>iOS HLS Cache 實踐方法探究之旅</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">正體中文</a> | <a href="/tags/simplified-chinese">简体中文</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-19 15:57:44 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
