<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对 iOS UITextView 图片穿插与多图上传痛点，分享 Swift 实作文绕图编辑器的完整解法，包含图片插入游标定位、上传失败处理及记忆体优化技巧，有效避免多图导致卡顿与闪退，提升 APP 稳定度与使用体验。" /><meta property="og:description" content="针对 iOS UITextView 图片穿插与多图上传痛点，分享 Swift 实作文绕图编辑器的完整解法，包含图片插入游标定位、上传失败处理及记忆体优化技巧，有效避免多图导致卡顿与闪退，提升 APP 稳定度与使用体验。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-10-14T02:07:49+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" /><meta property="twitter:title" content="iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-13T15:11:24+08:00","datePublished":"2018-10-14T02:07:49+08:00","description":"针对 iOS UITextView 图片穿插与多图上传痛点，分享 Swift 实作文绕图编辑器的完整解法，包含图片插入游标定位、上传失败处理及记忆体优化技巧，有效避免多图导致卡顿与闪退，提升 APP 稳定度与使用体验。","headline":"iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/"}</script><title>iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8%E9%96%8B%E7%99%BC%E6%94%BB%E7%95%A5-swift-%E5%9C%96%E7%89%87%E6%8F%92%E5%85%A5%E8%88%87%E8%A8%98%E6%86%B6%E9%AB%94%E5%84%AA%E5%8C%96%E5%AF%A6%E6%88%B0-e37d66ea1146/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/ios-uitextview-%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5-swift-%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98-e37d66ea1146/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战</h1><p class="post-desc fw-light mb-4">针对 iOS UITextView 图片穿插与多图上传痛点，分享 Swift 实作文绕图编辑器的完整解法，包含图片插入游标定位、上传失败处理及记忆体优化技巧，有效避免多图导致卡顿与闪退，提升 APP 稳定度与使用体验。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1539454069" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Oct 14, 2018 </time> </span> <span> Updated <time data-ts="1712992284" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" class="popup img-link preview-img blur"><img data-src="/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2558 words" > <em>14 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS UITextView 文绕图编辑器开发攻略｜Swift 图片插入与记忆体优化实战</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8%E9%96%8B%E7%99%BC%E6%94%BB%E7%95%A5-swift-%E5%9C%96%E7%89%87%E6%8F%92%E5%85%A5%E8%88%87%E8%A8%98%E6%86%B6%E9%AB%94%E5%84%AA%E5%8C%96%E5%AF%A6%E6%88%B0-e37d66ea1146/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目录</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>iOS UITextView 文绕图编辑器 (Swift) <a href="#ios-uitextview-文绕图编辑器-swift">#</a></summary><ul><li><a href="#目标功能">目标功能</a></li><li><a href="#功能需求">功能需求</a></li><li><a href="#先上个成品效果图">先上个成品效果图</a></li></ul></details></li><li class="has-children"><details><summary>开始 <a href="#开始">#</a></summary><ul><li><a href="#第一章">第一章</a></li><li><a href="#一开始">一开始</a></li><li><a href="#第二章">第二章</a></li><li><a href="#最终章">最终章</a></li><li><a href="#结语">结语</a></li></ul></details></li><li><a href="#延伸阅读">延伸阅读</a></li></ul></nav><hr /><h3 id="ios-uitextview-文绕图编辑器-swift"><span class="me-2">iOS UITextView 文绕图编辑器 (Swift)</span><a href="#ios-uitextview-文绕图编辑器-swift" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>实战路线</p><h4 id="目标功能"><span class="me-2">目标功能：</span><a href="#目标功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>APP上有一个让使用者能发表文章的讨论区功能，发表文章功能介面需要能输入文字、插入多张图片、支援文绕图穿插．</p><h4 id="功能需求"><span class="me-2">功能需求：</span><a href="#功能需求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>能输入多行文字</p><li><p>能在行中穿插图片</p><li><p>能上传多张图片</p><li><p>能随意移除插入的图片</p><li><p>图片上传效果/失败处理</p><li><p>能将输入内容转译成可传递文本 EX: BBCODE</p></ul><h4 id="先上个成品效果图"><span class="me-2">先上个成品效果图：</span><a href="#先上个成品效果图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" class="popup img-link blur"><img data-src="/assets/e37d66ea1146/1*Sh0XaryqYnqVGV0wJ_dDHA.gif" alt="[结婚吧APP](https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&amp;mt=8){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNzAiIGhlaWdodD0iNzk4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://itunes.apple.com/tw/app/%E7%B5%90%E5%A9%9A%E5%90%A7-%E4%B8%8D%E6%89%BE%E6%9C%80%E8%B2%B4-%E5%8F%AA%E6%89%BE%E6%9C%80%E5%B0%8D/id1356057329?ls=1&amp;mt=8" target="_blank">结婚吧APP</a></p><h3 id="开始"><span class="me-2">开始：</span><a href="#开始" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="第一章"><span class="me-2">第一章</span><a href="#第一章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>什么？你说第一章？不就用UITextView就能做到编辑器功能，哪来还需要分到「章节」；是的，我一开始的反应也是如此，直到我开始做才发现事情没有那么简单，其中苦恼了我两个星期、翻片国内外各种资料最后才找到解法，实作的心路历程就让我娓娓道来….</p><p>如果想直接知道最终解法，请直接跳到最后一章(往下滚滚滚滚滚)．</p><h4 id="一开始"><span class="me-2">一开始</span><a href="#一开始" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>文字编辑器理所当然是使用UITextView元件，看了一下文件UITextView attributedText 自带 NSTextAttachment物件 可以附加图片实做出文绕图效果，程式码也很简单：</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">imageAttachment</span> <span class="o">=</span> <span class="kt">NSTextAttachment</span><span class="p">()</span>
<span class="n">imageAttachment</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="kt">UIImage</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"example"</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">imageAttachment</span><span class="p">)</span>
</pre></table></code></div></div><p>当初天真的我还很开心想说蛮简单的啊、好方便；问题现在才正要开始：</p><ul><li><p>图片要能是从本地选择&amp;上传：这好解决，图片选择器我使用 <a href="https://github.com/tilltue/TLPhotoPicker" target="_blank">TLPhotoPicker</a> 这个套件(支援多图选择/客制化设定/切换相机拍照/Live Photos)，具体作法就是 TLPhotoPicker选完图片Callback后将PHAsset转成UIImage塞进去imageAttachment.image并预先在背景上传图片至Server。</p><li><p>图片上传要有效果并能添加互动操作(点击查看原图/点击X能删除)：没做出来，找不到NSTextAttachment有什么办法能做到这项需求，不过这功能没有还行反正还是能删除(在图片后按键盘上的「Back」键能删除图片)，我们继续…</p><li><p>原始图档案过大，上传慢、插入慢、吃效能：插入及上传前先Resize过，用 <a href="https://github.com/onevcat/Kingfisher" target="_blank">Kingfisher</a> 的resizeTo</p><li><p>图片插入在游标停留的位置：这里就要将原本的Code改成如下</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">selectedRange</span><span class="o">.</span><span class="n">location</span> <span class="p">??</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">combination</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span><span class="p">)</span> <span class="c1">//取得当前内容</span>
<span class="n">combination</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">imageAttachment</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">combination</span> <span class="c1">//回写回去</span>
</pre></table></code></div></div><ul><li>图片上传失败处理：这里要说一下，我实际另外写了一个Class 扩充原始的 NSTextAttachment 目的就是要多塞个属性存识别用的值</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">:</span><span class="kt">NSTextAttachment</span> <span class="p">{</span>
   <span class="k">var</span> <span class="nv">uuid</span><span class="p">:</span><span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>
</pre></table></code></div></div><p>上传图片时改成：</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span>
<span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">()</span>
<span class="n">attachment</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">id</span>
</pre></table></code></div></div><p>有办法辨识NSTextAttachment的对应之后，我们就能针对上传失败的图片，去attributedTextd里做NSTextAttachment搜索，找到他并取代成错误提示图或直接移除</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="k">let</span> <span class="nv">content</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="p">{</span>
    <span class="n">content</span><span class="o">.</span><span class="nf">enumerateAttributes</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>  <span class="nv">options</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">EnumerationOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="kt">NSAttributedStringKey</span><span class="o">.</span><span class="n">attachment</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="n">object</span><span class="p">[</span><span class="kt">NSAttributedStringKey</span><span class="o">.</span><span class="n">attachment</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">,</span><span class="n">attachment</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="s">"目标ID"</span> <span class="p">{</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span>  <span class="kt">UIImage</span><span class="p">(</span><span class="nv">named</span><span class="p">:</span> <span class="s">"IconError"</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">combination</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span>
                <span class="n">combination</span><span class="o">.</span><span class="nf">replaceCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">attachment</span><span class="p">))</span>
                <span class="c1">//如要直接移除可用deleteCharacters(in: range)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">combination</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>克服上述问题后，程式码大约会长成这样：</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">:</span><span class="kt">NSTextAttachment</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">uuid</span><span class="p">:</span><span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">dismissPhotoPicker</span><span class="p">(</span><span class="nv">withTLPHAssets</span><span class="p">:</span> <span class="p">[</span><span class="kt">TLPHAsset</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">//TLPhotoPicker 图片选择器的Callback</span>
    
    <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">selectedRange</span><span class="o">.</span><span class="n">location</span> <span class="p">??</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">//取得游标停留位置，无则从头</span>
    
    <span class="k">guard</span> <span class="n">withTLPHAssets</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="k">in</span>
        <span class="c1">//在背景处理</span>
        <span class="k">let</span> <span class="nv">orderWithTLPHAssets</span> <span class="o">=</span> <span class="n">withTLPHAssets</span><span class="o">.</span><span class="nf">sorted</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">selectedOrder</span> <span class="o">&gt;</span> <span class="nv">$1</span><span class="o">.</span><span class="n">selectedOrder</span> <span class="p">})</span>
        <span class="n">orderWithTLPHAssets</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">var</span> <span class="nv">image</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fullResolutionImage</span> <span class="p">{</span>
                
                <span class="k">let</span> <span class="nv">id</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span>
                
                <span class="k">var</span> <span class="nv">maxWidth</span><span class="p">:</span><span class="kt">CGFloat</span> <span class="o">=</span> <span class="mi">1500</span>
                <span class="k">var</span> <span class="nv">size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
                <span class="k">if</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">maxWidth</span> <span class="p">{</span>
                    <span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">maxWidth</span>
                    <span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxWidth</span><span class="o">/</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span>
                <span class="p">}</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="nf">resizeTo</span><span class="p">(</span><span class="nv">scaledToSize</span><span class="p">:</span> <span class="n">size</span><span class="p">)</span>
                <span class="c1">//缩图</span>
                
                <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">()</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">id</span>
                
                <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                    <span class="c1">//切回主执行绪更新UI插入图片</span>
                    <span class="k">let</span> <span class="nv">combination</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span><span class="p">)</span>
                    <span class="n">attachments</span><span class="o">.</span><span class="nf">forEach</span><span class="p">({</span> <span class="p">(</span><span class="n">attachment</span><span class="p">)</span> <span class="k">in</span>
                        <span class="n">combination</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                        <span class="n">combination</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">attachment</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                        <span class="n">combination</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">combination</span>
                    
                <span class="p">}</span>
                
                <span class="c1">//上传图片至Server</span>
                <span class="c1">//Alamofire post or....</span>
                <span class="c1">//POST image</span>
                <span class="c1">//if failed {</span>
                    <span class="k">if</span> <span class="k">let</span> <span class="nv">content</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="p">{</span>
                        <span class="n">content</span><span class="o">.</span><span class="nf">enumerateAttributes</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">content</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>  <span class="nv">options</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">EnumerationOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="k">in</span>
                            
                            <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="kt">NSAttributedStringKey</span><span class="o">.</span><span class="n">attachment</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="n">object</span><span class="p">[</span><span class="kt">NSAttributedStringKey</span><span class="o">.</span><span class="n">attachment</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">UploadImageNSTextAttachment</span><span class="p">,</span><span class="n">attachment</span><span class="o">.</span><span class="n">uuid</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">key</span> <span class="p">{</span>
                                    
                                    <span class="c1">//REPLACE:</span>
                                    <span class="n">attachment</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>
                                    <span class="n">attachment</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="c1">//ERROR Image</span>
                                    <span class="k">let</span> <span class="nv">combination</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">content</span><span class="p">)</span>
                                    <span class="n">combination</span><span class="o">.</span><span class="nf">replaceCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">attachment</span><span class="p">))</span>
                                    <span class="c1">//OR DELETE:</span>
                                    <span class="c1">//combination.deleteCharacters(in: range)</span>
                                    
                                    <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">combination</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="c1">//}</span>
                <span class="c1">//</span>
                
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>到此差不多问题都解决了，那是什么苦恼了我两周呢？</p><p>答：「记忆体」问题</p><p><a href="/assets/e37d66ea1146/1*IcnoXq6e6OUnU_mg83XDxg.gif" class="popup img-link blur"><img data-src="/assets/e37d66ea1146/1*IcnoXq6e6OUnU_mg83XDxg.gif" alt="iPhone 6顶不住啊!" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjYiIGhlaWdodD0iMTE4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>iPhone 6顶不住啊!</p><p>以上做法插入超过5张图片，UITextView就会开始卡顿；到一个程度就会因为记忆体负荷不了APP直接闪退</p><p>p.s 试过各种压缩/其他储存方式，结果依然</p><p>推测原因是，UITextView没有针对图片的NSTextAttachment做Reuse，你所插入的所有图片都Load在记忆体之中不会释放；所以除非是拿来穿插表情符号那种小图😅，不然根本不能拿来做文绕图</p><h4 id="第二章"><span class="me-2">第二章</span><a href="#第二章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>发现记忆体这个「硬伤」后，继续在网路上搜索解决方案，得到以下其他做法：</p><ul><li><p>用WebView嵌套HTML档案( &lt;div contentEditable=”true”&gt;&lt;/div&gt;)并用JS跟WebView做交互处理</p><li><p>用UITableView结合UITextView，能Reuse</p><li><p>基于TextKit自行扩充UITextView🏆</p></ul><p>第一项用WebView嵌套HTML档案的做法；考量到效能跟使用者体验，所以不考虑，有兴趣的朋友可以在Github搜寻相关的解决方案(EX: <a href="https://github.com/xiaosheng0601/RichTextDemo" target="_blank">RichTextDemo</a> )</p><p>第二项用UITableView结合UITextView</p><p>我实作了大约7成出来，具体大约是每一行都是一个Cell，Cell有两种，一种是UITextView另一种是UIImageView，图片一行文字一行；内容必须用阵列去储存，避免Reuse过程消失</p><p>能优秀的Reuse解决记忆体问题，但做到后面还是放弃了，在 <strong>控制行尾按Return要能新建一行并跳到该行</strong> 和 <strong>控制行头按Back键要能跳到上一行(若当前为空行要能删除该行)</strong> 这两个部分上吃足苦头，非常难控制</p><p>有兴趣的朋友可参考： <a href="https://gitee.com/dhar/MMRichTextEdit" target="_blank">MMRichTextEdit</a> 」</p><h4 id="最终章"><span class="me-2">最终章</span><a href="#最终章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>走到这里已经耗费了许多时间，开发时程严重拖延；目前最终解法就是用TextKit</p><p>这里附上两篇找到的文章给有兴趣研究的朋友：</p><ul><li><p><a href="https://www.jianshu.com/p/3f445d7f44d6" target="_blank">TextKit 探究</a></p><li><p><a href="http://djs66256.github.io/2016/06/23/2016-06-23-cong-uitextviewkan-wen-zi-hui-zhi-you-hua/" target="_blank">从UITextView看文字绘制优化</a></p></ul><p>但有一定的学习门槛，对我这个菜鸟来说太难了，再说时间也已不够，只能漫无目的在Github寻找他山之石借借用用</p><p>最终找到 <a href="https://github.com/kaizeiyimi/XLYTextKitExtension" target="_blank">XLYTextKitExtension</a> 这个项目，可以直接引入Code使用</p><p>✔ 让 NSTextAttachment 支援自订义UIView 要加什么交互操作都可以</p><p>✔ NSTextAttachment 可以Reuse 不会撑爆记忆体</p><p>具体实作方式跟 <strong>第一章</strong> 差不多，就只差在原本是用NSTextAttachment而现在改用XLYTextAttachment</p><p>针对要使用的UITextView:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">contentTextView</span><span class="o">.</span><span class="nf">setUseXLYLayoutManager</span><span class="p">()</span>
</pre></table></code></div></div><p>Tip 1:插入NSTextAttachment的地方改为</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">combine</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">""</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">imageView</span> <span class="o">=</span> <span class="kt">UIView</span><span class="p">()</span> <span class="c1">// your custom view</span>
<span class="k">let</span> <span class="nv">imageAttachment</span> <span class="o">=</span> <span class="kt">XLYTextAttachment</span> <span class="p">{</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">UIView</span> <span class="k">in</span>
    <span class="k">return</span> <span class="n">imageView</span>
<span class="p">}</span>
<span class="n">imageAttachment</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span>
<span class="n">imageAttachment</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">combine</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">imageAttachment</span><span class="p">))</span>
<span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">combine</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
</pre></table></code></div></div><p>Tip 2:NSTextAttachment搜索改为</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">self</span><span class="mf">.</span><span class="n">contentTextView</span><span class="mf">.</span><span class="n">textStorage</span><span class="mf">.</span><span class="nf">enumerateAttribute</span><span class="p">(</span><span class="nc">NSAttributedStringKey</span><span class="mf">.</span><span class="n">attachment</span><span class="p">,</span> <span class="n">in</span><span class="o">:</span> <span class="nf">NSRange</span><span class="p">(</span><span class="n">location</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="o">:</span> <span class="k">self</span><span class="mf">.</span><span class="n">contentTextView</span><span class="mf">.</span><span class="n">textStorage</span><span class="mf">.</span><span class="n">length</span><span class="p">),</span> <span class="n">options</span><span class="o">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">range</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span> <span class="n">in</span>
    <span class="k">if</span> <span class="n">let</span> <span class="n">attachment</span> <span class="o">=</span> <span class="n">value</span> <span class="k">as</span><span class="o">?</span> <span class="nc">XLYTextAttachment</span> <span class="p">{</span>
        <span class="c1">//attachment.id</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Tip 3:删除NSTextAttachment项目改为</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span><span class="o">.</span><span class="nf">deleteCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
</pre></table></code></div></div><p>Tip 4:取得当前内容长度</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span><span class="o">.</span><span class="n">length</span>
</pre></table></code></div></div><p>Tip 5:刷新Attachment的Bounds大小</p><p>主因是为了使用者体验；插入图片时我会先塞一张loading图，插入的图片在背景压缩后才会替换上去，要去更新TextAttachment的Bounds成Resize后大小</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">([:],</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
</pre></table></code></div></div><p>(新增空属性，触发刷新)</p><p>Tip 6: 将输入内容转译成可传递文本</p><p>运用Tip 2搜索全部输入内容并将找到的Attachment取出ID组合成类似[ [ID] ]格式传递</p><p>Tip 7: 内容取代</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span><span class="o">.</span><span class="nf">replaceCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span><span class="nv">with</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">attachment</span><span class="p">:</span> <span class="n">newImageAttachment</span><span class="p">))</span>
</pre></table></code></div></div><p>Tip 8: 正规表示法匹配内容所在Range</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">pattern</span> <span class="o">=</span> <span class="s">"(</span><span class="se">\\</span><span class="s">[</span><span class="se">\\</span><span class="s">[image_id=){1}([0-9]+){1}(</span><span class="se">\\</span><span class="s">]</span><span class="se">\\</span><span class="s">]){1}"</span>
<span class="k">let</span> <span class="nv">textStorage</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">contentTextView</span><span class="o">.</span><span class="n">textStorage</span>

<span class="k">if</span> <span class="k">let</span> <span class="nv">regex</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">caseInsensitive</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">textStorage</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="nf">matches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">textStorage</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">withTransparentBounds</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">matchString</span> <span class="o">=</span> <span class="n">textStorage</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
            <span class="c1">//FINDED!</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>注意：如果你要搜寻＆取代项目，需要使用While回圈，不然当有多个搜寻结果时，找到第一个并取代后，后面的搜寻结果的Range就会错误导致闪退．</p><h4 id="结语"><span class="me-2">结语</span><a href="#结语" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>目前使用此方法完成成品并上线了，还没遇到有什么问题；有时间我再来好好探究一下其中的原理吧！</p><p>这篇比较不是教学文章，而是个人解题心得分享；如果您也在实作类似功能，希望有帮助到你，有任何问题及指教欢迎与我联络．</p><blockquote><p>Medium的正式第一篇</p></blockquote><h3 id="延伸阅读"><span class="me-2">延伸阅读</span><a href="#延伸阅读" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="/posts/zrealm-dev/zh-cn/zmarkupparser-swift-html-string-%E8%BD%AC-nsattributedstring-%E5%B7%A5%E5%85%B7-%E6%94%AF%E6%8F%B4%E5%AE%A2%E5%88%B6%E6%A0%B7%E5%BC%8F%E4%B8%8E%E9%AB%98%E6%95%88%E8%83%BD%E6%B8%B2%E6%9F%93-a5643de271e4/">ZMarkupParser HTML String 转换 NSAttributedString 工具</a></p><li><p><a href="/posts/zrealm-dev/zh-cn/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%AC%E6%8D%A2-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3-2724f02f6e7/">手工打造 HTML 解析器的那些事</a></p></ul><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/e37d66ea1146" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2018-10-13-e37d66ea1146.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/mobile-app-development/" class="post-tag no-text-decoration" >mobile-app-development</a> <a href="/tags/uitextview/" class="post-tag no-text-decoration" >uitextview</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20UITextView%20%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5%EF%BD%9CSwift%20%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-uitextview-%25E6%2596%2587%25E7%25BB%2595%25E5%259B%25BE%25E7%25BC%2596%25E8%25BE%2591%25E5%2599%25A8%25E5%25BC%2580%25E5%258F%2591%25E6%2594%25BB%25E7%2595%25A5-swift-%25E5%259B%25BE%25E7%2589%2587%25E6%258F%2592%25E5%2585%25A5%25E4%25B8%258E%25E8%25AE%25B0%25E5%25BF%2586%25E4%25BD%2593%25E4%25BC%2598%25E5%258C%2596%25E5%25AE%259E%25E6%2588%2598-e37d66ea1146%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20UITextView%20%E6%96%87%E7%BB%95%E5%9B%BE%E7%BC%96%E8%BE%91%E5%99%A8%E5%BC%80%E5%8F%91%E6%94%BB%E7%95%A5%EF%BD%9CSwift%20%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5%E4%B8%8E%E8%AE%B0%E5%BF%86%E4%BD%93%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-uitextview-%25E6%2596%2587%25E7%25BB%2595%25E5%259B%25BE%25E7%25BC%2596%25E8%25BE%2591%25E5%2599%25A8%25E5%25BC%2580%25E5%258F%2591%25E6%2594%25BB%25E7%2595%25A5-swift-%25E5%259B%25BE%25E7%2589%2587%25E6%258F%2592%25E5%2585%25A5%25E4%25B8%258E%25E8%25AE%25B0%25E5%25BF%2586%25E4%25BD%2593%25E4%25BC%2598%25E5%258C%2596%25E5%25AE%259E%25E6%2588%2598-e37d66ea1146%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-uitextview-%25E6%2596%2587%25E7%25BB%2595%25E5%259B%25BE%25E7%25BC%2596%25E8%25BE%2591%25E5%2599%25A8%25E5%25BC%2580%25E5%258F%2591%25E6%2594%25BB%25E7%2595%25A5-swift-%25E5%259B%25BE%25E7%2589%2587%25E6%258F%2592%25E5%2585%25A5%25E4%25B8%258E%25E8%25AE%25B0%25E5%25BF%2586%25E4%25BD%2593%25E4%25BC%2598%25E5%258C%2596%25E5%25AE%259E%25E6%2588%2598-e37d66ea1146%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/en/tokyo-area-travel-guide-kawagoe-little-edo-atami-fireworks-festival-5-day-itinerary-958599363857/">Tokyo Area Travel Guide｜Kawagoe Little Edo & Atami Fireworks Festival 5-Day Itinerary</a><li class="text-truncate lh-lg"> <a href="/posts/zh-cn/%E4%B8%9C%E4%BA%AC%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-%E5%B7%9D%E8%B6%8A%E5%B0%8F%E6%B1%9F%E6%88%B7%E4%B8%80%E6%97%A5%E6%B8%B8%E4%B8%8E%E7%83%AD%E6%B5%B7%E6%B5%B7%E4%B8%8A%E8%8A%B1%E7%81%AB%E5%A4%A7%E4%BC%9A%E5%85%A8%E7%BA%AA%E5%BD%95-958599363857/">游记 2025 东京地区 — 川越小江户与热海海上花火大会 5 日自由行</a><li class="text-truncate lh-lg"> <a href="/posts/%E6%9D%B1%E4%BA%AC%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-%E5%B7%9D%E8%B6%8A%E5%B0%8F%E6%B1%9F%E6%88%B6%E4%B8%80%E6%97%A5%E9%81%8A%E8%88%87%E7%86%B1%E6%B5%B7%E6%B5%B7%E4%B8%8A%E8%8A%B1%E7%81%AB%E5%A4%A7%E6%9C%83%E5%85%A8%E7%B4%80%E9%8C%84-958599363857/">遊記 2025 東京地區 — 川越小江戶與熱海海上花火大會 5 日自由行</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/line-bank-to-firstrade-transfer-fast-deposit-150-nt-fee-guide-with-account-upgrade-fee-subsidy-e4d139fe0685/">LINE Bank to Firstrade Transfer｜Fast Deposit & 150 NT Fee Guide with Account Upgrade & Fee Subsidy</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/line-bank-%E5%85%A5%E9%87%91-firstrade-%E6%95%99%E5%AD%A6-%E5%BF%AB%E9%80%9F%E5%88%B0%E5%B8%90-%E4%BD%8E%E6%89%8B%E7%BB%AD%E8%B4%B9150%E5%85%83-%E5%B8%90%E6%88%B7%E5%8D%87%E7%BA%A7%E4%B8%8E%E6%89%8B%E7%BB%AD%E8%B4%B9%E8%A1%A5%E5%8A%A9%E7%94%B3%E8%AF%B7%E5%85%A8%E6%94%BB%E7%95%A5-e4d139fe0685/">手把手教学 — LINE Bank 入金 Firstrade 快速到帐、手续费只要 150 元及帐户升级/约定转帐/手续费补助申请教学</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8%E9%96%8B%E7%99%BC%E6%94%BB%E7%95%A5-swift-%E5%9C%96%E7%89%87%E6%8F%92%E5%85%A5%E8%88%87%E8%A8%98%E6%86%B6%E9%AB%94%E5%84%AA%E5%8C%96%E5%AF%A6%E6%88%B0-e37d66ea1146/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1539454069" data-df="ll" > Oct 14, 2018 </time><h4 class="pt-0 my-2">iOS UITextView 文繞圖編輯器 (Swift)</h4><div class="text-muted"><p>文</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1539454069" data-df="ll" > Oct 14, 2018 </time><h4 class="pt-0 my-2">iOS UITextView Text Wrap Editor｜Swift Implementation for Seamless Layout</h4><div class="text-muted"><p>Discover how to implement a UITextView text wrap editor in Swift that resolves layout challenges and enhances text editing efficiency. This guide helps developers streamline text flow around images...</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/ios-uiviewcontroller-%E8%BD%AC%E5%9C%BA%E5%8A%A8%E7%94%BB-%E4%B8%8B%E6%8B%89%E5%85%B3%E9%97%AD-%E4%B8%8A%E6%8B%89%E6%B8%90%E5%85%A5%E4%B8%8E%E5%85%A8%E9%A1%B5%E5%8F%B3%E6%BB%91%E8%BF%94%E5%9B%9E%E5%AE%9E%E4%BD%9C%E6%8A%80%E5%B7%A7-14cee137c565/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1578768066" data-df="ll" > Jan 12, 2020 </time><h4 class="pt-0 my-2">iOS UIViewController 转场二三事</h4><div class="text-muted"><p>UIViewController 下拉关闭/上拉出现/全页右滑返回 效果全解</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/" class="btn btn-outline-primary" aria-label="Older" ><p>iOS UITextView Text Wrap Editor｜Swift Implementation for Seamless Layout</p></a> <a href="/posts/zrealm-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8%E9%96%8B%E7%99%BC%E6%94%BB%E7%95%A5-swift-%E5%9C%96%E7%89%87%E6%8F%92%E5%85%A5%E8%88%87%E8%A8%98%E6%86%B6%E9%AB%94%E5%84%AA%E5%8C%96%E5%AF%A6%E6%88%B0-e37d66ea1146/" class="btn btn-outline-primary" aria-label="Newer" ><p>iOS UITextView 文繞圖編輯器 (Swift)</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
