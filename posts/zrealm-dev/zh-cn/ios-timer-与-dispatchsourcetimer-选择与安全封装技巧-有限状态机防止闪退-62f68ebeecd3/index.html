<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="iOS å¼€å‘å¿…å¤‡ Timer ä½¿ç”¨æŒ‡å—ï¼Œè§£æ Timer ä¸ DispatchSourceTimer ä¼˜ç¼ºç‚¹ï¼Œå¹¶æä¾›æœ‰é™çŠ¶æ€æœºå°è£… DispatchSourceTimerï¼Œé¿å…é—ªé€€åŠ Race Conditionï¼Œå®ç°é«˜ç²¾åº¦ä¸”å®‰å…¨çš„å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚" /><meta property="og:description" content="iOS å¼€å‘å¿…å¤‡ Timer ä½¿ç”¨æŒ‡å—ï¼Œè§£æ Timer ä¸ DispatchSourceTimer ä¼˜ç¼ºç‚¹ï¼Œå¹¶æä¾›æœ‰é™çŠ¶æ€æœºå°è£… DispatchSourceTimerï¼Œé¿å…é—ªé€€åŠ Race Conditionï¼Œå®ç°é«˜ç²¾åº¦ä¸”å®‰å…¨çš„å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-14T16:17:06+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" /><meta property="twitter:title" content="iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2025-12-15T00:24:36+08:00","datePublished":"2025-12-14T16:17:06+08:00","description":"iOS å¼€å‘å¿…å¤‡ Timer ä½¿ç”¨æŒ‡å—ï¼Œè§£æ Timer ä¸ DispatchSourceTimer ä¼˜ç¼ºç‚¹ï¼Œå¹¶æä¾›æœ‰é™çŠ¶æ€æœºå°è£… DispatchSourceTimerï¼Œé¿å…é—ªé€€åŠ Race Conditionï¼Œå®ç°é«˜ç²¾åº¦ä¸”å®‰å…¨çš„å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚","headline":"iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"}</script><title>iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€ | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan ğŸ‡¹ğŸ‡¼ who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,049+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€</h1><p class="post-desc fw-light mb-4">iOS å¼€å‘å¿…å¤‡ Timer ä½¿ç”¨æŒ‡å—ï¼Œè§£æ Timer ä¸ DispatchSourceTimer ä¼˜ç¼ºç‚¹ï¼Œå¹¶æä¾›æœ‰é™çŠ¶æ€æœºå°è£… DispatchSourceTimerï¼Œé¿å…é—ªé€€åŠ Race Conditionï¼Œå®ç°é«˜ç²¾åº¦ä¸”å®‰å…¨çš„å®šæ—¶ä»»åŠ¡ç®¡ç†ã€‚</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1765700226" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 14, 2025 </time> </span> <span> Updated <time data-ts="1765729476" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 14, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" class="popup img-link preview-img blur"><img data-src="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3885 words" > <em>21 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters ğŸ”–</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS Timer ä¸ DispatchSourceTimer é€‰æ‹©ä¸å®‰å…¨å°è£…æŠ€å·§ï½œæœ‰é™çŠ¶æ€æœºé˜²æ­¢é—ªé€€</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/"><strong>é»æ“Šé€™è£¡</strong></a>æŸ¥çœ‹æœ¬æ–‡ç« æ­£é«”ä¸­æ–‡ç‰ˆæœ¬ã€‚</p></blockquote><blockquote class="prompt-info"><p>åŸºäº SEO è€ƒé‡ï¼Œæœ¬æ–‡æ ‡é¢˜ä¸æè¿°ç» AI è°ƒæ•´ï¼ŒåŸå§‹ç‰ˆæœ¬è¯·å‚è€ƒå†…æ–‡ã€‚</p></blockquote><h4 id="zhgchgli-table-of-contents">æ–‡ç« ç›®å½•</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>[iOS] Timer ä¸ DispatchSourceTimer å¦‚ä½•é€‰æ‹©ä¸å®‰å…¨çš„ä½¿ç”¨? <a href="#ios-timer-ä¸-dispatchsourcetimer-å¦‚ä½•é€‰æ‹©ä¸å®‰å…¨çš„ä½¿ç”¨">#</a></summary><ul><li><a href="#å…³äº-timer">å…³äº Timer</a></li></ul></details></li><li class="has-children"><details><summary>Foundation â€” Timer (NSTimer) <a href="#foundation--timer-nstimer">#</a></summary><ul><li><a href="#ä¼˜ç¼ºç‚¹">ä¼˜ç¼ºç‚¹</a></li><li><a href="#é€‚åˆåœºæ™¯">é€‚åˆåœºæ™¯</a></li><li><a href="#ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="#ä½¿ç”¨">ä½¿ç”¨</a></li><li><a href="#timer-çš„æ“ä½œæ–¹æ³•">Timer çš„æ“ä½œæ–¹æ³•</a></li><li><a href="#runloop-mode-çš„å½±å“">RunLoop Mode çš„å½±å“</a></li></ul></details></li><li class="has-children"><details><summary>Grand Central Dispatch â€” DispatchSourceTimer <a href="#grand-central-dispatch--dispatchsourcetimer">#</a></summary><ul><li><a href="#ä¼˜ç¼ºç‚¹-1">ä¼˜ç¼ºç‚¹</a></li><li><a href="#é€‚åˆåœºæ™¯-1">é€‚åˆåœºæ™¯</a></li><li><a href="#ç”Ÿå‘½å‘¨æœŸ-1">ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href="#é—ªé€€é—®é¢˜">é—ªé€€é—®é¢˜</a></li><li><a href="#ä½¿ç”¨-finite-state-machine-æœ‰é™çŠ¶æ€æœºå°è£…æ“ä½œ">ä½¿ç”¨ Finite-State Machine æœ‰é™çŠ¶æ€æœºå°è£…æ“ä½œ</a></li><li><a href="#ä½¿ç”¨-serial-queue-æ“ä½œæœ‰é™çŠ¶æ€æœºçŠ¶æ€è½¬æ¢">ä½¿ç”¨ Serial Queue æ“ä½œæœ‰é™çŠ¶æ€æœºçŠ¶æ€è½¬æ¢</a></li><li><a href="#å»¶ä¼¸--ä½¿ç”¨-adapter-pattern--factory-pattern-äº§ç”Ÿ-dispatchsourcetimer-åˆ©äºæŠ½è±¡æµ‹è¯•">å»¶ä¼¸ â€” ä½¿ç”¨ Adapter Pattern + Factory Pattern äº§ç”Ÿ DispatchSourceTimer (åˆ©äºæŠ½è±¡æµ‹è¯•)</a></li><li><a href="#å»¶ä¼¸--ä½¿ç”¨-strategy-pattern-å°è£…-dispatchsourcehandler-å·¥ä½œ">å»¶ä¼¸ â€” ä½¿ç”¨ Strategy Pattern å°è£… DispatchSourceHandler å·¥ä½œ</a></li><li><a href="#é¸£è°¢">é¸£è°¢</a></li></ul></details></li><li><a href="#å»¶ä¼¸é˜…è¯»">å»¶ä¼¸é˜…è¯»</a></li></ul></nav><hr /><h3 id="ios-timer-ä¸-dispatchsourcetimer-å¦‚ä½•é€‰æ‹©ä¸å®‰å…¨çš„ä½¿ç”¨"><span class="me-2">[iOS] Timer ä¸ DispatchSourceTimer å¦‚ä½•é€‰æ‹©ä¸å®‰å…¨çš„ä½¿ç”¨?</span><a href="#ios-timer-ä¸-dispatchsourcetimer-å¦‚ä½•é€‰æ‹©ä¸å®‰å…¨çš„ä½¿ç”¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>ä½¿ç”¨æœ‰é™çŠ¶æ€æœºä¸ Design Patterns å°è£… DispatchSourceTimerï¼Œä½¿å…¶æ›´å®‰å…¨æ˜“ç”¨ã€‚</p><p><a href="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" alt="Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@pixelfreund?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Ralph Hutter</a></p><h4 id="å…³äº-timer"><span class="me-2">å…³äº Timer</span><a href="#å…³äº-timer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>åœ¨ iOS å¼€å‘ä¸­ä¸€å®šä¼šé‡åˆ°çš„éœ€æ±‚åœºæ™¯ã€ŒTimer å®šæ—¶è§¦å‘å™¨ã€ï¼›ä» UI å±‚é¢ä¸Šæ˜¾ç¤ºå€’æ•°è®¡æ—¶ã€Banner è½®æ’­åˆ°èµ„æ–™é€»è¾‘å±‚é¢ä¸Šçš„å®šæ—¶å‘é€ Eventsã€å®šæ—¶æ¸…é™¤é‡Šæ”¾èµ„æ–™ï¼›æˆ‘ä»¬éƒ½éœ€è¦ Timer æ¥å¸®åŠ©æˆ‘ä»¬è¾¾æˆç›®æ ‡ã€‚</p><h3 id="foundation--timer-nstimer"><span class="me-2"><a href="https://developer.apple.com/documentation/foundation/timer" target="_blank">Foundation â€” Timer (NSTimer)</a></span><a href="#foundation--timer-nstimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Timer åº”è¯¥æ˜¯å¤§å®¶æœ€ç›´è§‰ä¼šå…ˆæƒ³åˆ°çš„ APIï¼Œä½†æ˜¯åœ¨é€‰æ‹©åŠä½¿ç”¨ Timer ä¸Šæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªç‚¹ã€‚</p><h4 id="ä¼˜ç¼ºç‚¹"><span class="me-2">ä¼˜ç¼ºç‚¹</span><a href="#ä¼˜ç¼ºç‚¹" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Timer çš„ä¼˜ç‚¹ï¼š</strong></p><ul><li><p>é»˜è®¤ä¸ UI å·¥ä½œæ•´åˆï¼Œä¸éœ€è¦ç‰¹åˆ«åˆ‡ Main Thread æ‰§è¡Œ</p><li><p>è‡ªåŠ¨è°ƒæ•´è§¦å‘æ—¶æœºä¼˜åŒ–ä½¿ç”¨ç”µé‡</p><li><p>ä½¿ç”¨å¤æ‚åº¦è¾ƒä½ï¼Œæœ€å¤šåªä¼šå‘ç”Ÿ Retain Cycle æˆ–å¿˜è®°åœæ­¢ Timerï¼Œä½†ä¸ä¼šç›´æ¥é€ æˆ Crash</p></ul><p><strong>Timer çš„ç¼ºç‚¹ï¼š</strong></p><ul><li><p>ç²¾ç¡®åº¦å— RunLoop çŠ¶æ€å½±å“ï¼Œåœ¨ UI é«˜äº’åŠ¨æˆ– Mode åˆ‡æ¢æ—¶å¯èƒ½å»¶åè§¦å‘</p><li><p>ä¸æ”¯æ´ <code class="language-plaintext highlighter-rouge">suspend</code> , <code class="language-plaintext highlighter-rouge">resume</code> , <code class="language-plaintext highlighter-rouge">activate</code> â€¦ç­‰è¿›é˜¶æ“ä½œ</p></ul><h4 id="é€‚åˆåœºæ™¯"><span class="me-2">é€‚åˆåœºæ™¯</span><a href="#é€‚åˆåœºæ™¯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>UI å±‚é¢éœ€æ±‚ï¼Œä¾‹å¦‚è½®æ’­ Banners (Auto Scroll ScrollView)æˆ–æ˜¯ä¼˜æƒ åˆ¸é¢†å–å€’æ•°è®¡æ—¶ï¼›è¿™äº›åªè¦æ±‚ä½¿ç”¨è€…åœ¨å‰æ™¯å½“å‰ç”»é¢èƒ½å“åº”å†…å®¹çš„åœºæ™¯ï¼Œæˆ‘ä¼šé€‰æ‹©ç›´æ¥ç”¨ Timerï¼Œæ–¹ä¾¿ã€å¿«é€Ÿã€å®‰å…¨çš„è¾¾æˆç›®çš„ã€‚</p><h4 id="ç”Ÿå‘½å‘¨æœŸ"><span class="me-2">ç”Ÿå‘½å‘¨æœŸ</span><a href="#ç”Ÿå‘½å‘¨æœŸ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg3IiBoZWlnaHQ9IjEyMzciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>åœ¨ UI Main Thread ä¸Šå»ºç«‹ Timerï¼ŒTimer ä¼šè¢« Main Thread çš„ RunLoop å¼ºæŒæœ‰ã€å¹¶é€è¿‡ RunLoop è½®è¯¢æœºåˆ¶å®šæœŸè§¦å‘ï¼Œç›´åˆ° Timer invalidate( ) æ‰ä¼šè¢«é‡Šæ”¾ï¼›å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ ViewController ä¸Šå¼ºæŒæœ‰ Timer å¹¶åœ¨ deinit æ—¶å‘¼å« Timer invalidate( )ï¼Œæ‰èƒ½åœ¨ç”»é¢é€€å‡ºåæ­£ç¡®ç»ˆæ­¢é‡Šæ”¾ Timerã€‚</p><ul><li><p>â­ï¸ï¸ï¸View Controller å¼ºæŒæœ‰ Timerï¼Œ <strong>Timer çš„ Execution Block (handler / closure)åŠ¡å¿…ä¸º Weak Selfï¼›å¦åˆ™ä¼š Retain Cycleã€‚</strong></p><li><p>â­ï¸ï¸ï¸åŠ¡å¿…åœ¨ View Controller ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶å‘¼å« Timer invalidate( )ï¼Œå¦åˆ™ RunLoop ä»ä¼šæŒæœ‰ Timer ç»§ç»­æ‰§è¡Œã€‚</p></ul><blockquote><p><em>RunLoop æ˜¯ Thread å†…çš„äº‹ä»¶å¤„ç†å›åœˆï¼Œä¼šè½®è¯¢æ¥æ”¶å¤„ç†äº‹ä»¶ï¼› <strong>Main Thread ç³»ç»Ÿä¼šè‡ªåŠ¨å»ºç«‹ RunLoop (RunLoop.main)</strong> ï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»– Thread ä¸ä¸€å®šä¼šæœ‰ RunLoopã€‚</em></p></blockquote><h4 id="ä½¿ç”¨"><span class="me-2">ä½¿ç”¨</span><a href="#ä½¿ç”¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Timer.scheduledTimer</code> å®£å‘Šä¸€ä¸ª Timer (ä¼šè‡ªåŠ¨åŠ å…¥ RunLoop.main &amp; <strong>Mode: .default</strong> ):</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">HomeViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">Timer</span><span class="p">?</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidate</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="nf">startCarousel</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startCarousel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="o">.</span><span class="nf">scheduledTimer</span><span class="p">(</span><span class="nv">withTimeInterval</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">repeats</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">block</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">doSomething</span><span class="p">()</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ä¹Ÿå¯ä»¥è‡ªè¡Œå®£å‘Š Timer ç‰©ä»¶åŠ å…¥åˆ° RunLoop:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">timer</span><span class="o">=</span> <span class="kt">Timer</span><span class="p">(</span><span class="nv">timeInterval</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">repeats</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
  <span class="c1">// do something..</span>
<span class="p">}</span>
<span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
<span class="c1">// åŠ å…¥ RunLoop åæ‰ä¼šå¼€å§‹æ‰§è¡Œ</span>
<span class="kt">RunLoop</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="nv">forMode</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span>
</pre></table></code></div></div><h4 id="timer-çš„æ“ä½œæ–¹æ³•"><span class="me-2">Timer çš„æ“ä½œæ–¹æ³•</span><a href="#timer-çš„æ“ä½œæ–¹æ³•" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><code class="language-plaintext highlighter-rouge">invalidate()</code> ç»ˆæ­¢ Timer</p><li><p><code class="language-plaintext highlighter-rouge">fire()</code> ç«‹å³è§¦å‘ä¸€æ¬¡</p></ul><h4 id="runloop-mode-çš„å½±å“"><span class="me-2">RunLoop <strong>Mode çš„å½±å“</strong></span><a href="#runloop-mode-çš„å½±å“" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><code class="language-plaintext highlighter-rouge">.default</code> ï¼šé¢„è®¾åŠ å…¥çš„ Modeï¼Œä¸»è¦æ˜¯å¤„ç† UI æ˜¾ç¤ºã€‚ <strong>ä¼šåœ¨åˆ‡æ¢åˆ° <code class="language-plaintext highlighter-rouge">.tracking</code> Mode æ—¶å…ˆæš‚åœ</strong></p><li><p><code class="language-plaintext highlighter-rouge">.tracking</code> ï¼šå¤„ç† ScrollView æ»šåŠ¨ã€Gesture æ‰‹åŠ¿ã€‚</p><li><p><code class="language-plaintext highlighter-rouge">.common</code> ï¼š <code class="language-plaintext highlighter-rouge">.default</code> + <code class="language-plaintext highlighter-rouge">.tracking</code> éƒ½ä¼šå¤„ç†ã€‚</p></ul><blockquote><p><em>â­ï¸ï¸ï¸â­ï¸ï¸ï¸â­ï¸ï¸ï¸å› æ­¤åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ Timer æ˜¯åŠ åˆ° <code class="language-plaintext highlighter-rouge">.default</code> Modeï¼Œ <strong>ä¼šåœ¨ä½¿ç”¨è€…æ»šåŠ¨ ScrollView æˆ–æ˜¯æ‰‹åŠ¿æ“ä½œæ—¶è‡ªåŠ¨æš‚åœ</strong> ï¼Œç­‰åˆ°æ“ä½œç»“æŸåæ‰ä¼šç»§ç»­ï¼Œå¯èƒ½é€ æˆ Timer å»¶åè§¦å‘æˆ–æ˜¯æ¬¡æ•°ä½äºé¢„æœŸã€‚</em></p></blockquote><p><strong>å¯¹æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Timer æ”¹åŠ å…¥åˆ° .common Mode å°±èƒ½è§£å†³ä»¥ä¸Šé—®é¢˜:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">RunLoop</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="nv">forMode</span><span class="p">:</span> <span class="o">.</span><span class="n">common</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="grand-central-dispatch--dispatchsourcetimer"><span class="me-2"><a href="https://developer.apple.com/documentation/dispatch/dispatchsourcetimer" target="_blank">Grand Central Dispatch â€” DispatchSourceTimer</a></span><a href="#grand-central-dispatch--dispatchsourcetimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>é™¤äº† Timer ä¹‹å¤–ï¼ŒGCD ä¹Ÿæä¾›äº†å¦ä¸€ä¸ª DispatchSourceTimer æ–¹æ³•å¯ä¾›é€‰æ‹©ã€‚</p><h4 id="ä¼˜ç¼ºç‚¹-1"><span class="me-2">ä¼˜ç¼ºç‚¹</span><a href="#ä¼˜ç¼ºç‚¹-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>DispatchSourceTimer çš„ä¼˜ç‚¹ï¼š</strong></p><ul><li><p>æ“ä½œå¼¹æ€§(æ”¯æ´ <code class="language-plaintext highlighter-rouge">suspend</code> , <code class="language-plaintext highlighter-rouge">resume</code> ) è¾ƒå¥½</p><li><p>ç²¾ç¡®åº¦ä¸å¯é ç¨‹åº¦è¾ƒé«˜ï¼šä¾èµ– GCD Queue</p><li><p>å¯è‡ªè¡Œè®¾å®š leeway æ§åˆ¶è€—ç”µé‡</p><li><p>å¯ç¨³å®šå¸¸é©»ä»»åŠ¡ (GCD Queue)</p></ul><p><strong>DispatchSourceTimer çš„ç¼ºç‚¹ï¼š</strong></p><ul><li><p>UI æ“ä½œéœ€è‡ªè¡Œåˆ‡æ¢å› Main Thread</p><li><p>API ä½¿ç”¨å¤æ‚ä¸”æœ‰é¡ºåºï¼Œ <strong>ç”¨é”™ä¼š Crash</strong></p><li><p>éœ€è¦å°è£…æ‰èƒ½å®‰å…¨ä½¿ç”¨</p></ul><h4 id="é€‚åˆåœºæ™¯-1"><span class="me-2">é€‚åˆåœºæ™¯</span><a href="#é€‚åˆåœºæ™¯-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>ç›¸è¾ƒ Timer é€‚åˆ UI å±‚é¢çš„åœºæ™¯ï¼ŒDispatchSourceTimer æ¯”è¾ƒé€‚åˆåšé‚£äº›è·Ÿ UI æˆ–ä½¿ç”¨è€…å½“å‰ç”»é¢æ— å…³çš„ä»»åŠ¡åœºæ™¯ï¼›æœ€å¸¸è§çš„å°±æ˜¯å‘é€ Tracking äº‹ä»¶ï¼Œæˆ‘ä»¬ä¼šå®šæ—¶æŠŠä½¿ç”¨è€…æ“ä½œäº§ç”Ÿçš„äº‹ä»¶å‘é€åˆ°ä¼ºæœå™¨ï¼Œæˆ–æ˜¯å®šæ—¶æ¸…ç†æ— ç”¨çš„ CoreData èµ„æ–™ï¼›è¿™äº›å°±å¾ˆé€‚åˆä½¿ç”¨ DispatchSourceTimerã€‚</p><h4 id="ç”Ÿå‘½å‘¨æœŸ-1"><span class="me-2">ç”Ÿå‘½å‘¨æœŸ</span><a href="#ç”Ÿå‘½å‘¨æœŸ-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjg5IiBoZWlnaHQ9IjkxNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>DispatchSourceTimer çš„ç”Ÿå‘½å‘¨æœŸå–å†³äºæ˜¯å¦ä»è¢«å¤–éƒ¨ç‰©ä»¶æŒæœ‰ï¼›GCD queue æœ¬èº«ä¸ä¼šå¼ºæŒæœ‰ timer çš„ ownerï¼Œåªè´Ÿè´£è°ƒåº¦ä¸æ‰§è¡Œäº‹ä»¶ã€‚</p><h4 id="é—ªé€€é—®é¢˜"><span class="me-2">é—ªé€€é—®é¢˜</span><a href="#é—ªé€€é—®é¢˜" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>DispatchSourceTimer è™½ç„¶æä¾›æ›´å¤šå¯æ“ä½œæ–¹æ³•ï¼š <code class="language-plaintext highlighter-rouge">activate</code> , <code class="language-plaintext highlighter-rouge">suspend</code> , <code class="language-plaintext highlighter-rouge">resume</code> , <code class="language-plaintext highlighter-rouge">cancel</code> ï¼›ä½†æ˜¯å®ƒæå…¶æ•æ„Ÿï¼Œåªè¦å‘¼å«çš„é¡ºåºä¸å¯¹å°±ä¼šç›´é—ªé€€ (EXC_BREAKPOINT/DispatchSourceTimer) éå¸¸å±é™©ã€‚</p><p><a href="/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODMiIGhlaWdodD0iMTg1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>ä»¥ä¸‹æƒ…å†µå‡ä¼šç›´æ¥é—ªé€€ï¼š</strong></p><ul><li><p>âŒ suspend( ) ä¸ resume( ) æ²¡æœ‰æˆå¯¹ä½¿ç”¨ suspend( ) ååˆå‘¼å«ä¸€æ¬¡ suspend( ) resume( ) ååˆå‘¼å«ä¸€æ¬¡ resume( )</p><li><p>âŒ suspend( ) åå‘¼å« cancel( ) éœ€è¦å…ˆ resume( ) æ‰èƒ½ cancel( )</p><li><p>âŒ suspend( ) çŠ¶æ€ä¸‹ Timer è¢«é‡Šæ”¾ (nil)</p><li><p>âŒ cancel( ) åå†å‘¼å«å…¶ä»–æ“ä½œ</p></ul><h4 id="ä½¿ç”¨-finite-state-machine-æœ‰é™çŠ¶æ€æœºå°è£…æ“ä½œ"><span class="me-2">ä½¿ç”¨ Finite-State Machine æœ‰é™çŠ¶æ€æœºå°è£…æ“ä½œ</span><a href="#ä½¿ç”¨-finite-state-machine-æœ‰é™çŠ¶æ€æœºå°è£…æ“ä½œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>è¿›å…¥æœ¬ç¯‡æ–‡ç« çš„å¦ä¸€ä¸ªé‡ç‚¹ï¼Œè¯¥å¦‚ä½•å®‰å…¨çš„ä½¿ç”¨ DispatchSourceTimer?</p><p><a href="/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjExNTEiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨æœ‰é™çŠ¶æ€æœºå°è£… DispatchSourceTimer çš„æ“ä½œï¼Œä½¿å…¶å¯ä»¥æ›´å®‰å…¨ã€æ›´å®¹æ˜“çš„ä½¿ç”¨:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// æœ‰é™çŠ¶æ€æœºæœ‰å“ªäº›çŠ¶æ€</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">TimerState</span> <span class="p">{</span>
        <span class="c1">// åˆå§‹çŠ¶æ€</span>
        <span class="k">case</span> <span class="n">idle</span>
        <span class="c1">// æ‰§è¡Œä¸­</span>
        <span class="k">case</span> <span class="n">running</span>
        <span class="c1">// æš‚åœä¸­</span>
        <span class="k">case</span> <span class="n">suspended</span>
        <span class="c1">// ç»ˆæ­¢ä¸­</span>
        <span class="k">case</span> <span class="n">cancelled</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">timerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_state</span><span class="p">:</span> <span class="kt">TimerState</span> <span class="o">=</span> <span class="o">.</span><span class="n">idle</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="c1">// Owner ç‰©ä»¶æ¶ˆå¤±æ—¶ï¼ŒåŒæ­¥ cancel timer</span>
        <span class="c1">// è™½ä¸åšä¹Ÿä¸å½±å“(handler æ˜¯ weak)ï¼Œä½†æ˜¯å¯ä»¥ç¡®ä¿æµç¨‹ç¬¦åˆé¢„æœŸ</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">running</span> <span class="p">{</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// å¯åŠ¨ Timer</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// åªæœ‰ idle, cancelled çŠ¶æ€å¯ä»¥å¯ç”¨ Timer</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// å»ºç«‹ Timer and activate()</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
        
        <span class="c1">// åˆ‡æ¢åˆ° running çŠ¶æ€</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
    <span class="p">}</span>

    <span class="c1">// æš‚åœ Timer</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// åªæœ‰åœ¨ running çŠ¶æ€å¯ä»¥æš‚åœ Timer</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// æš‚åœ Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
        
        <span class="c1">// åˆ‡æ¢åˆ° suspended çŠ¶æ€</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">suspended</span>
    <span class="p">}</span>

    <span class="c1">// æ¢å¤ Timer</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// åªæœ‰åœ¨ suspended çŠ¶æ€å¯ä»¥æ¢å¤ Timer</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// æ¢å¤ Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        
        <span class="c1">// åˆ‡æ¢åˆ° running çŠ¶æ€</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
    <span class="p">}</span>

    <span class="c1">// ç»ˆæ­¢ Timer</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// åªæœ‰åœ¨ suspended, running çŠ¶æ€å¯ä»¥ç»ˆæ­¢ Timer</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// å¦‚æœå½“å‰æ˜¯ suspended çŠ¶æ€ï¼Œå…ˆ resume() å†ç»ˆæ­¢</span>
        <span class="c1">// æ­¤ä¸º DispatchSourceTimer çš„é™åˆ¶ï¼Œåªèƒ½åœ¨ running æ‰èƒ½ cancel()</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1">// ç»ˆæ­¢ Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
        
        <span class="c1">// åˆ‡æ¢åˆ° cancelled çŠ¶æ€</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">DispatchSourceTimer</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">timerQueue</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>æˆ‘ä»¬ç®€å•ä½¿ç”¨æœ‰é™çŠ¶æ€æœºã€Œå°è£…äº†çŠ¶æ€å¯ä»¥è½¬æ¢æˆä»€ä¹ˆçŠ¶æ€ã€ä¸ã€ŒçŠ¶æ€éœ€è¦åšä»€ä¹ˆã€çš„é€»è¾‘ï¼Œå¦‚æœåœ¨é”™è¯¯çš„çŠ¶æ€ä¸‹å‘¼å«ä¼šè¢«å¿½ç•¥(ä¸ä¼šé—ªé€€)ï¼Œæˆ‘ä»¬è¿˜å¤šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¾‹å¦‚ suspended çŠ¶æ€ä¹Ÿèƒ½ cancelã€cancelled çŠ¶æ€èƒ½é‡æ–° activateã€‚</p><blockquote><p><strong><em>å»¶ä¼¸é˜…è¯»ï¼š</em></strong></p></blockquote><blockquote><p><em>ä¹‹å‰å†™è¿‡å¦ä¸€ç¯‡æ–‡ç« ã€Œ <a href="https://zhgchg.li/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/#%E9%9C%80%E6%B1%82%E5%A0%B4%E6%99%AF-3" target="_blank">Design Patterns å®æˆ˜åº”ç”¨ï½œå°è£… Socket.IO å³æ—¶é€šè®¯æ¶æ„</a> ã€ä¸­ä¹Ÿæœ‰ä½¿ç”¨åˆ°æœ‰é™çŠ¶æ€æœºï¼Œå¦å¤–è¿˜å¤šä½¿ç”¨äº† State Patternã€‚</em></p></blockquote><blockquote><p><em>Finite-State Machine æœ‰é™çŠ¶æ€æœº: å…³æ³¨çš„æ˜¯çŠ¶æ€ä¹‹é—´çš„è½¬æ¢æ§åˆ¶ä¸è¯¥åšä»€ä¹ˆã€‚</em></p></blockquote><blockquote><p><em>State Pattern: å…³æ³¨çš„æ˜¯æ¯ä¸ªçŠ¶æ€å†…çš„è¡Œä¸ºé€»è¾‘ã€‚</em></p></blockquote><h4 id="ä½¿ç”¨-serial-queue-æ“ä½œæœ‰é™çŠ¶æ€æœºçŠ¶æ€è½¬æ¢"><span class="me-2">ä½¿ç”¨ Serial Queue æ“ä½œæœ‰é™çŠ¶æ€æœºçŠ¶æ€è½¬æ¢</span><a href="#ä½¿ç”¨-serial-queue-æ“ä½œæœ‰é™çŠ¶æ€æœºçŠ¶æ€è½¬æ¢" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æœ‰äº†çŠ¶æ€æœºç¡®ä¿ DispatchSourceTimer èƒ½å®‰å…¨ä½¿ç”¨ä¹‹åè¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯åœ¨å¤–éƒ¨å‘¼å«ä½¿ç”¨ DispatchSourceTimerMachine çš„åœ°æ–¹æ˜¯åœ¨åŒä¸ª Threadï¼Œå¦‚æœä¸åŒ Thread éƒ½æ“ä½œäº†è¿™ä¸ªç‰©ä»¶å°±ä¼šé€ æˆ Race Condition ä¸€æ ·ä¼šå¼•å‘é—ªé€€ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// æœ‰é™çŠ¶æ€æœºæœ‰å“ªäº›çŠ¶æ€</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">TimerState</span> <span class="p">{</span>
        <span class="c1">// åˆå§‹çŠ¶æ€</span>
        <span class="k">case</span> <span class="n">idle</span>
        <span class="c1">// æ‰§è¡Œä¸­</span>
        <span class="k">case</span> <span class="n">running</span>
        <span class="c1">// æš‚åœä¸­</span>
        <span class="k">case</span> <span class="n">suspended</span>
        <span class="c1">// ç»ˆæ­¢ä¸­</span>
        <span class="k">case</span> <span class="n">cancelled</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">timerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_state</span><span class="p">:</span> <span class="kt">TimerState</span> <span class="o">=</span> <span class="o">.</span><span class="n">idle</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">operationQueueSpecificKey</span> <span class="o">=</span> <span class="kt">DispatchSpecificKey</span><span class="o">&lt;</span><span class="kt">ObjectIdentifier</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">operationQueueSpecificValue</span><span class="p">:</span> <span class="kt">ObjectIdentifier</span> <span class="o">=</span> <span class="kt">ObjectIdentifier</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">operationQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine.operationQueue"</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="nf">setSpecific</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">operationQueueSpecificKey</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">operationQueueSpecificValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queue</span>
    <span class="p">}()</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">operation</span><span class="p">(</span><span class="nv">async</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">_</span> <span class="nv">work</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">getSpecific</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">operationQueueSpecificKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">operationQueueSpecificValue</span> <span class="p">{</span>
            <span class="nf">work</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">async</span> <span class="p">{</span>
                <span class="n">operationQueue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="n">work</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">operationQueue</span><span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="n">work</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="c1">// Owner ç‰©ä»¶æ¶ˆå¤±æ—¶ï¼ŒåŒæ­¥ cancel timer</span>
        <span class="c1">// è™½ä¸åšä¹Ÿä¸å½±å“(handler æ˜¯ weak)ï¼Œä½†æ˜¯å¯ä»¥ç¡®ä¿æµç¨‹ç¬¦åˆé¢„æœŸ</span>
        <span class="c1">// ç¡®ä¿ sync æ‰§è¡Œå®Œæ¯•</span>
        <span class="nf">operation</span><span class="p">(</span><span class="nv">async</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
                <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
                <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">running</span> <span class="p">{</span>
                <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// å¯åŠ¨ Timer</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// åªæœ‰ idle, cancelled çŠ¶æ€å¯ä»¥å¯ç”¨ Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// å»ºç«‹ Timer and activate()</span>
            <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
            <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
            
            <span class="c1">// åˆ‡æ¢åˆ° running çŠ¶æ€</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// æš‚åœ Timer</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// åªæœ‰åœ¨ running çŠ¶æ€å¯ä»¥æš‚åœ Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// æš‚åœ Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
            
            <span class="c1">// åˆ‡æ¢åˆ° suspended çŠ¶æ€</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">suspended</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// æ¢å¤ Timer</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// åªæœ‰åœ¨ suspended çŠ¶æ€å¯ä»¥æ¢å¤ Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// æ¢å¤ Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            
            <span class="c1">// åˆ‡æ¢åˆ° running çŠ¶æ€</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ç»ˆæ­¢ Timer</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// åªæœ‰åœ¨ suspended, running çŠ¶æ€å¯ä»¥ç»ˆæ­¢ Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// å¦‚æœå½“å‰æ˜¯ suspended çŠ¶æ€ï¼Œå…ˆ resume() å†ç»ˆæ­¢</span>
            <span class="c1">// æ­¤ä¸º DispatchSourceTimer çš„é™åˆ¶ï¼Œåªèƒ½åœ¨ running æ‰èƒ½ cancel()</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="c1">// ç»ˆæ­¢ Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
            
            <span class="c1">// åˆ‡æ¢åˆ° cancelled çŠ¶æ€</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">DispatchSourceTimer</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">timerQueue</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨æ— å¿§çš„ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DispatchSourceTimerMachine</code> ç‰©ä»¶ä½œä¸º Timer äº†:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nx">final</span> <span class="kd">class</span> <span class="nc">TrackingEventSender</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">let</span> <span class="nx">timerMachine</span> <span class="o">=</span> <span class="nc">DispatchSourceTimerMachine</span><span class="p">()</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="nx">events</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">// å¯åŠ¨å®šæœŸ tracking</span>
    <span class="nx">func</span> <span class="nf">startTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">activate</span><span class="p">(</span><span class="nx">repeatTimeInterval</span><span class="p">:</span> <span class="p">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span> <span class="p">[</span><span class="nx">weak</span> <span class="nb">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="nb">self</span><span class="p">?.</span><span class="nf">sendTrackingEvent</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// æš‚åœ trackingï¼ˆä¾‹å¦‚ App è¿›èƒŒæ™¯ï¼‰</span>
    <span class="nx">func</span> <span class="nf">pauseTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// æ¢å¤ trackingï¼ˆä¾‹å¦‚ App å›å‰æ™¯ï¼‰</span>
    <span class="nx">func</span> <span class="nf">resumeTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// åœæ­¢ trackingï¼ˆä¾‹å¦‚é¡µé¢ç¦»å¼€ï¼‰</span>
    <span class="nx">func</span> <span class="nf">stopTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="nx">func</span> <span class="nf">sendTrackingEvent</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// send events to server...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>åˆ°æ­¤å¦‚ä½•å®‰å…¨çš„ä½¿ç”¨ DispatchSourceTimer ç¯èŠ‚å·²ç»“æŸï¼Œå†æ¥å»¶ä¼¸å‡ ä¸ª Design Patterns çš„ä½¿ç”¨ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŠ½è±¡ç‰©ä»¶è¿›è¡Œæµ‹è¯•è·Ÿ DispatchSourceHandler æ‰§è¡Œé€»è¾‘æŠ½è±¡ã€‚</p><h4 id="å»¶ä¼¸--ä½¿ç”¨-adapter-pattern--factory-pattern-äº§ç”Ÿ-dispatchsourcetimer-åˆ©äºæŠ½è±¡æµ‹è¯•"><span class="me-2">å»¶ä¼¸ â€” ä½¿ç”¨ Adapter Pattern + Factory Pattern äº§ç”Ÿ DispatchSourceTimer (åˆ©äºæŠ½è±¡æµ‹è¯•)</span><a href="#å»¶ä¼¸--ä½¿ç”¨-adapter-pattern--factory-pattern-äº§ç”Ÿ-dispatchsourcetimer-åˆ©äºæŠ½è±¡æµ‹è¯•" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>DispatchSourceTimer æ˜¯ GCD çš„ Objective-C ç‰©ä»¶ï¼Œåœ¨æµ‹è¯•ç¯èŠ‚æˆ‘ä»¬å¾ˆéš¾å¯¹å…¶ Mock (æ—  Protocol)ï¼›å› æ­¤æˆ‘ä»¬éœ€è¦è‡ªå·±å®šä¹‰ä¸€å±‚ Protocol + Factory Pattern äº§ç”Ÿï¼Œè®© TimerStateMachine æ˜¯èƒ½å†™æµ‹è¯•çš„ã€‚</p><p><strong>Adapter Patternâ€” å°è£… DispatchSourceTimer æ“ä½œ:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// DispatchSourceTimer çš„ Adapter å®ç°</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerAdapter</span><span class="p">:</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
    <span class="c1">// åŸå§‹çš„ DispatchSourceTimer</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"li.zhgchg.DispatchSourceTimerAdapter"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeating</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Factory Pattern â€” æŠ½è±¡äº§ç”Ÿ TimerAdapter çš„æ–¹æ³•:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimerAdapter</span>
<span class="p">}</span>

<span class="c1">// å°è£… DispatchSourceTimerAdapter äº§ç”Ÿæ­¥éª¤</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerAdapterFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerAdapter</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>ç»„åˆä½¿ç”¨:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">stateMachine</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerMachine</span><span class="p">(</span><span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactory</span><span class="p">())</span>

<span class="c1">//</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// ç•¥..</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">TimerAdapter</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timerFactory</span> <span class="o">=</span> <span class="n">timerFactory</span>
    <span class="p">}</span>
    <span class="c1">// ç•¥..</span>

    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">onQueue</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// ä½¿ç”¨ Factory MakeTimer</span>
            <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="n">timerFactory</span><span class="o">.</span><span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>

            <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// ç•¥..</span>
<span class="p">}</span>
</pre></table></code></div></div><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½å¯¹ <code class="language-plaintext highlighter-rouge">TimerAdapter</code> / <code class="language-plaintext highlighter-rouge">DispatchSourceTimerAdapterFactorySpec</code> åœ¨æµ‹è¯•ç¯èŠ‚æ’°å†™ Mock Object è·‘å•å…ƒæµ‹è¯•ã€‚</p><h4 id="å»¶ä¼¸--ä½¿ç”¨-strategy-pattern-å°è£…-dispatchsourcehandler-å·¥ä½œ"><span class="me-2">å»¶ä¼¸ â€” ä½¿ç”¨ <strong><em>Strategy</em></strong> Pattern å°è£… DispatchSourceHandler å·¥ä½œ</span><a href="#å»¶ä¼¸--ä½¿ç”¨-strategy-pattern-å°è£…-dispatchsourcehandler-å·¥ä½œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å‡è®¾æˆ‘ä»¬çš„ DispatchSourceHandler å¸Œæœ›æ‰§è¡Œçš„äº‹èƒ½åŠ¨æ€æ”¹å˜ï¼Œå¯ä»¥ä½¿ç”¨ Strategy Pattern æ¥å°è£…å·¥ä½œå†…å®¹ã€‚</p><p><strong>TrackingHandlerStrategy:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Home Event</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HomeTrackingHandlerStrategy</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"home"</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// fetch home event logs..and send</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Product Event</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ProductTrackingHandlerStrategy</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"product"</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// fetch product event logs..and send</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>ç»„åˆä½¿ç”¨ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">sender</span> <span class="o">=</span> <span class="kt">TrackingEventSender</span><span class="p">()</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">HomeTrackingHandlerStrategy</span><span class="p">())</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">ProductTrackingHandlerStrategy</span><span class="p">())</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">startTracking</span><span class="p">()</span>

<span class="c1">// ...</span>

<span class="c1">//</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">TrackingEventSender</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timerMachine</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerMachine</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">events</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

    <span class="c1">// æ³¨å†Œéœ€è¦çš„ Event ç­–ç•¥</span>
    <span class="kd">func</span> <span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">events</span><span class="p">[</span><span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="n">retrive</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="k">Type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">events</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">T</span>
    <span class="p">}</span>

    <span class="c1">// å¯åŠ¨å®šæœŸ tracking</span>
    <span class="kd">func</span> <span class="nf">startTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
                <span class="n">event</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// æš‚åœ trackingï¼ˆä¾‹å¦‚ App è¿›èƒŒæ™¯ï¼‰</span>
    <span class="kd">func</span> <span class="nf">pauseTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// æ¢å¤ trackingï¼ˆä¾‹å¦‚ App å›å‰æ™¯ï¼‰</span>
    <span class="kd">func</span> <span class="nf">resumeTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// åœæ­¢ trackingï¼ˆä¾‹å¦‚é¡µé¢ç¦»å¼€ï¼‰</span>
    <span class="kd">func</span> <span class="nf">stopTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="é¸£è°¢"><span class="me-2">é¸£è°¢</span><a href="#é¸£è°¢" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æ„Ÿè°¢ <a href="https://medium.com/u/e13f6afcf9b9" target="_blank">Ethan Huang</a> å¤§å¤§ Donate çš„ <strong>5 Beers</strong> :</p><p><a href="https://www.patreon.com/cw/ethanhuang13/home?vanity=ethanhuang13" target="_blank" class="img-link shimmer" ><img src="https://c7.patreon.com/https%3A%2F%2Fwww.patreon.com%2F%2Fcard-teaser-image%2Fcreator%2F6512681%3Fc=4366071272298850039/selector/%23creator-teaser%2C.png" alt="" loading="lazy"></a></p><blockquote><p><em>çš„ç¡®å¿«åŠå¹´æ²¡å†™ä»€ä¹ˆäº†ï¼Œæ–°å·¥ä½œåˆšåˆ°èŒï¼ŒæŒç»­æ‰¾å¯»çµæ„Ÿä¸­ï¼ğŸ’ª</em></p></blockquote><blockquote><p>ä¸‹ä¸€ç¯‡å¯èƒ½åˆ†äº« Fastlane Match å‡­è¯ç®¡ç†è·Ÿ Self-hosted Runner çš„å»ºç½®è¿‡ç¨‹. .æˆ–æ˜¯ Bitbucket Pipeline. .æˆ–æ˜¯ AppStoreConnect APIâ€¦</p></blockquote><h3 id="å»¶ä¼¸é˜…è¯»"><span class="me-2">å»¶ä¼¸é˜…è¯»</span><a href="#å»¶ä¼¸é˜…è¯»" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/"><strong>Design Patterns çš„å®æˆ˜åº”ç”¨çºªå½• (å°è£… Sockiet.io)</strong></a></p><li><p><a href="/posts/kkday-tech-blog/zh-cn/wkwebview-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E6%88%98-builder-strategy-%E4%B8%8E%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E6%9C%80%E4%BD%B3%E5%BA%94%E7%94%A8%E6%8A%80%E5%B7%A7-f4b02ee342a4/">Design Patterns çš„å®æˆ˜åº”ç”¨çºªå½• (å°è£… WKWebView)</a></p><li><p><a href="/posts/zrealm-dev/zh-cn/visitor-pattern-%E5%9C%A8-ios-swift-%E5%88%86%E4%BA%AB%E5%8A%9F%E8%83%BD%E5%BA%94%E7%94%A8-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%AE%9E%E5%8A%A1%E8%A7%A3%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E6%9E%B6%E6%9E%84%E4%BC%98%E5%8C%96-ba5773a7bfea/">Visitor Pattern in Swift</a></p><li><p><a href="/posts/zrealm-dev/zh-cn/visitor-pattern-%E6%8F%90%E5%8D%87-tableview-%E5%8F%AF%E6%89%A9%E5%85%85%E6%80%A7%E4%B8%8E%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%80%A7%E8%AE%BE%E8%AE%A1%E8%8C%83%E4%BE%8B-60473cb47550/">Visitor Pattern in TableView</a></p></ul><p>æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ <a href="https://www.zhgchg.li/contact" target="_blank">ä¸æˆ‘è”ç»œ</a> ã€‚</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zhgchg.li/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">ğŸ”—</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="https://www.paypal.com/ncp/payment/CMALMPT8UUTY2" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">ğŸº Buy me a beer on PayPal</a></p><blockquote class="prompt-info"><p>æœ¬æ–‡é¦–æ¬¡å‘è¡¨äº Medium (<a href="https://medium.com/p/62f68ebeecd3" target="_blank"><strong>ç‚¹å‡»æŸ¥çœ‹åŸå§‹ç‰ˆæœ¬</strong></a>)ï¼Œç”± <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> æä¾›è‡ªåŠ¨è½¬æ¢ä¸åŒæ­¥æŠ€æœ¯ã€‚</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2025-12-14-62f68ebeecd3.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,049+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/design-patterns/" class="post-tag no-text-decoration" >design-patterns</a> <a href="/tags/timer/" class="post-tag no-text-decoration" >timer</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a> <a href="/tags/finite-state-machine/" class="post-tag no-text-decoration" >finite-state-machine</a> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20Timer%20%E4%B8%8E%20DispatchSourceTimer%20%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7%EF%BD%9C%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-timer-%25E4%25B8%258E-dispatchsourcetimer-%25E9%2580%2589%25E6%258B%25A9%25E4%25B8%258E%25E5%25AE%2589%25E5%2585%25A8%25E5%25B0%2581%25E8%25A3%2585%25E6%258A%2580%25E5%25B7%25A7-%25E6%259C%2589%25E9%2599%2590%25E7%258A%25B6%25E6%2580%2581%25E6%259C%25BA%25E9%2598%25B2%25E6%25AD%25A2%25E9%2597%25AA%25E9%2580%2580-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20Timer%20%E4%B8%8E%20DispatchSourceTimer%20%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7%EF%BD%9C%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-timer-%25E4%25B8%258E-dispatchsourcetimer-%25E9%2580%2589%25E6%258B%25A9%25E4%25B8%258E%25E5%25AE%2589%25E5%2585%25A8%25E5%25B0%2581%25E8%25A3%2585%25E6%258A%2580%25E5%25B7%25A7-%25E6%259C%2589%25E9%2599%2590%25E7%258A%25B6%25E6%2580%2581%25E6%259C%25BA%25E9%2598%25B2%25E6%25AD%25A2%25E9%2597%25AA%25E9%2580%2580-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fios-timer-%25E4%25B8%258E-dispatchsourcetimer-%25E9%2580%2589%25E6%258B%25A9%25E4%25B8%258E%25E5%25AE%2589%25E5%2585%25A8%25E5%25B0%2581%25E8%25A3%2585%25E6%258A%2580%25E5%25B7%25A7-%25E6%259C%2589%25E9%2599%2590%25E7%258A%25B6%25E6%2580%2581%25E6%259C%25BA%25E9%2598%25B2%25E6%25AD%25A2%25E9%2597%25AA%25E9%2580%2580-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and Efficiencyï½œTool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD å®æˆ˜æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šCI/CD æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é€è¿‡ CI/CD æ‰“é€ ç¨³å®šé«˜æ•ˆçš„å¼€å‘å›¢é˜Ÿï¼Ÿå·¥å…·é€‰æ‹©ï¼Ÿ</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šCI/CD æ˜¯ä»€éº¼ï¼Ÿå¦‚ä½•é€é CI/CD æ‰“é€ ç©©å®šé«˜æ•ˆçš„é–‹ç™¼åœ˜éšŠï¼Ÿå·¥å…·é¸æ“‡ï¼Ÿ</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web Appï½œIntegrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">ä½¿ç”¨ Google Apps Script Web App è¡¨å•ä¸²æ¥ Github Action CI/CD å·¥ä½œ</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters ğŸ”–</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765700226" data-df="ll" > Dec 14, 2025 </time><h4 class="pt-0 my-2">iOS Timer èˆ‡ DispatchSourceTimer å¦‚ä½•é¸æ“‡èˆ‡å®‰å…¨çš„ä½¿ç”¨?</h4><div class="text-muted"><p>ä½¿ç”¨æœ‰é™ç‹€æ…‹æ©Ÿèˆ‡ Design Patterns å°è£ DispatchSourceTimerï¼Œä½¿å…¶æ›´å®‰å…¨æ˜“ç”¨ã€‚</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765700226" data-df="ll" > Dec 14, 2025 </time><h4 class="pt-0 my-2">iOS Timer vs DispatchSourceTimerï½œSafe Usage with Finite State Machine & Design Patterns</h4><div class="text-muted"><p>Discover how to enhance iOS timer safety by encapsulating DispatchSourceTimer using finite state machines and design patterns, solving common concurrency issues for reliable app performance.</p></div></div></a></article><article class="col"> <a href="/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1649342957" data-df="ll" > Apr 7, 2022 </time><h4 class="pt-0 my-2">Design Patterns å®æˆ˜åº”ç”¨ï½œå°è£… Socket.IO å³æ—¶é€šè®¯æ¶æ„ä¸ä¸ƒå¤§è®¾è®¡æ¨¡å¼è§£æ</h4><div class="text-muted"><p>é’ˆå¯¹ iOS ä¸ Android å³æ—¶é€šè®¯éœ€æ±‚ï¼Œè§£æå°è£… Socket.IO è¿‡ç¨‹ä¸­é‡åˆ°çš„å¤æ‚è¿çº¿ç®¡ç†ä¸è·¨å¹³å°æŒ‘æˆ˜ï¼Œé€è¿‡ä¸ƒå¤§è®¾è®¡æ¨¡å¼ä¼˜åŒ–è¿çº¿å¤ç”¨ã€ç¦»çº¿äº‹ä»¶ç¼“å­˜ä¸çŠ¶æ€ç®¡ç†ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§ä¸æ‰©å……æ€§ï¼ŒåŠ©ä½ æ‰“é€ é«˜æ•ˆä¸”æ˜“ç»´æŠ¤çš„åŒå‘é€šè®¯æ¶æ„ã€‚</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/" class="btn btn-outline-primary" aria-label="Older" ><p>iOS Timer vs DispatchSourceTimerï½œSafe Usage with Finite State Machine & Design Patterns</p></a> <a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/" class="btn btn-outline-primary" aria-label="Newer" ><p>iOS Timer èˆ‡ DispatchSourceTimer å¦‚ä½•é¸æ“‡èˆ‡å®‰å…¨çš„ä½¿ç”¨?</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">æ­£é«”ä¸­æ–‡</a> | <a href="/tags/simplified-chinese">ç®€ä½“ä¸­æ–‡</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-22 11:06:36 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
