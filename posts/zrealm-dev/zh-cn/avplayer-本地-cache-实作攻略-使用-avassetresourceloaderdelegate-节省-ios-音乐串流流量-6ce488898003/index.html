<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="é’ˆå¯¹ iOS éŸ³ä¹ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå®ç° AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡å¤ä¸‹è½½åŒä¸€æ¡£æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€è¿‡è‡ªè®¢ Resource Loader ä¸ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è¯·æ±‚ä¸æ’­æ”¾ä¸ä¸­æ–­ï¼Œæå‡ä½¿ç”¨ä½“éªŒä¸æ•ˆèƒ½ã€‚" /><meta property="og:description" content="é’ˆå¯¹ iOS éŸ³ä¹ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå®ç° AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡å¤ä¸‹è½½åŒä¸€æ¡£æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€è¿‡è‡ªè®¢ Resource Loader ä¸ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è¯·æ±‚ä¸æ’­æ”¾ä¸ä¸­æ–­ï¼Œæå‡ä½¿ç”¨ä½“éªŒä¸æ•ˆèƒ½ã€‚" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="twitter:title" content="AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"é’ˆå¯¹ iOS éŸ³ä¹ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå®ç° AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡å¤ä¸‹è½½åŒä¸€æ¡£æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€è¿‡è‡ªè®¢ Resource Loader ä¸ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è¯·æ±‚ä¸æ’­æ”¾ä¸ä¸­æ–­ï¼Œæå‡ä½¿ç”¨ä½“éªŒä¸æ•ˆèƒ½ã€‚","headline":"AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"}</script><title>AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡ | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="stylesheet" href="/assets/css/post-toc.css"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan ğŸ‡¹ğŸ‡¼ who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,049+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡</h1><p class="post-desc fw-light mb-4">é’ˆå¯¹ iOS éŸ³ä¹ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå®ç° AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡å¤ä¸‹è½½åŒä¸€æ¡£æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€è¿‡è‡ªè®¢ Resource Loader ä¸ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è¯·æ±‚ä¸æ’­æ”¾ä¸ä¸­æ–­ï¼Œæå‡ä½¿ç”¨ä½“éªŒä¸æ•ˆèƒ½ã€‚</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1612089702" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 31, 2021 </time> </span> <span> Updated <time data-ts="1712997921" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link preview-img blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="7224 words" > <em>40 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters ğŸ”–</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AVPlayer æœ¬åœ° Cache å®ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate èŠ‚çœ iOS éŸ³ä¹ä¸²æµæµé‡</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><strong>é»æ“Šé€™è£¡</strong></a>æŸ¥çœ‹æœ¬æ–‡ç« æ­£é«”ä¸­æ–‡ç‰ˆæœ¬ã€‚</p></blockquote><blockquote class="prompt-info"><p>åŸºäº SEO è€ƒé‡ï¼Œæœ¬æ–‡æ ‡é¢˜ä¸æè¿°ç» AI è°ƒæ•´ï¼ŒåŸå§‹ç‰ˆæœ¬è¯·å‚è€ƒå†…æ–‡ã€‚</p></blockquote><h4 id="zhgchgli-table-of-contents">æ–‡ç« ç›®å½•</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>AVPlayer å®è·µæœ¬åœ° Cache åŠŸèƒ½å¤§å…¨ <a href="#avplayer-å®è·µæœ¬åœ°-cache-åŠŸèƒ½å¤§å…¨">#</a></summary><ul><li><a href="#20230312-update">[2023/03/12] Update</a></li></ul></details></li><li><a href="#å‰è¨€">å‰è¨€</a></li><li><a href="#ç›®æ ‡">ç›®æ ‡</a></li><li class="has-children"><details><summary>å‰å¯¼çŸ¥è¯† (1)â€” HTTP/1.1 Range èŒƒå›´è¯·æ±‚ã€Connection Keep-Alive <a href="#å‰å¯¼çŸ¥è¯†-1-http11-range-èŒƒå›´è¯·æ±‚connection-keep-alive">#</a></summary><ul><li><a href="#http11-range-èŒƒå›´è¯·æ±‚">HTTP/1.1 Range èŒƒå›´è¯·æ±‚</a></li><li><a href="#å¦‚ä½•åº”ç”¨">å¦‚ä½•åº”ç”¨ï¼Ÿ</a></li><li><a href="#connection-keep-alive">Connection Keep-Alive</a></li><li><a href="#å¦‚æœå‘ç°ä¼ºæœå™¨ä¸æ”¯æ´-range-keep-alive-">å¦‚æœå‘ç°ä¼ºæœå™¨ä¸æ”¯æ´ Rangeã€ Keep-Alive ï¼Ÿ</a></li></ul></details></li><li class="has-children"><details><summary>å‰å¯¼çŸ¥è¯† (2) â€” AVPlayer åŸç”Ÿæ˜¯å¦‚ä½•å¤„ç† AVURLAsset èµ„æºï¼Ÿ <a href="#å‰å¯¼çŸ¥è¯†-2--avplayer-åŸç”Ÿæ˜¯å¦‚ä½•å¤„ç†-avurlasset-èµ„æº">#</a></summary><ul><li><a href="#cancel-å‘èµ·çš„æ—¶æœº">Cancel å‘èµ·çš„æ—¶æœº</a></li><li><a href="#avqueue-pre-buffering">AVQueue Pre-buffering</a></li></ul></details></li><li class="has-children"><details><summary>å®ç° <a href="#å®ç°">#</a></summary><ul><li><a href="#è¿›å…¥è‡ªè®¢çš„-resource-loader-çš„æ—¶æœºç‚¹">è¿›å…¥è‡ªè®¢çš„ Resource Loader çš„æ—¶æœºç‚¹</a></li><li><a href="#avassetresourceloaderdelegate">AVAssetResourceLoaderDelegate</a></li><li><a href="#æœ¬åœ°-cache-å®ç°æ–¹å¼">æœ¬åœ° Cache å®ç°æ–¹å¼</a></li></ul></details></li><li class="has-children"><details><summary>å¼€å·¥ï¼ <a href="#å¼€å·¥">#</a></summary><ul><li><a href="#assetdata">AssetData</a></li><li><a href="#pincacheassetdatamanager">PINCacheAssetDataManager</a></li><li><a href="#cachingavurlasset">CachingAVURLAsset</a></li><li><a href="#resourceloaderrequest">ResourceLoaderRequest</a></li><li><a href="#resourceloader">ResourceLoader</a></li></ul></details></li><li class="has-children"><details><summary>è¡¥å……åŠé¸£è°¢ <a href="#è¡¥å……åŠé¸£è°¢">#</a></summary><ul><li><a href="#æœ¬ç¯‡åªé’ˆå¯¹éŸ³ä¹å°æ¡£">æœ¬ç¯‡åªé’ˆå¯¹éŸ³ä¹å°æ¡£</a></li><li><a href="#avqueueplayer-åˆ‡æ¢æ’­æ”¾é¡¹ç›®æ—¶å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„é¡¹ç›®">AVQueuePlayer åˆ‡æ¢æ’­æ”¾é¡¹ç›®æ—¶å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„é¡¹ç›®</a></li><li><a href="#éŸ³è®¯èµ„æ–™åŠ è§£å¯†">éŸ³è®¯èµ„æ–™åŠ è§£å¯†</a></li><li><a href="#pincache-ç›¸å…³æ“ä½œ">PINCache ç›¸å…³æ“ä½œ</a></li></ul></details></li><li><a href="#åè®°">åè®°</a></li><li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li><li><a href="#å»¶ä¼¸">å»¶ä¼¸</a></li></ul></nav><hr /><h3 id="avplayer-å®è·µæœ¬åœ°-cache-åŠŸèƒ½å¤§å…¨"><span class="me-2">AVPlayer å®è·µæœ¬åœ° Cache åŠŸèƒ½å¤§å…¨</span><a href="#avplayer-å®è·µæœ¬åœ°-cache-åŠŸèƒ½å¤§å…¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AVPlayer/AVQueuePlayer with AVURLAsset å®ä½œ AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>æˆ‘å°†ä¹‹å‰çš„å®ä½œå¼€æºäº†ï¼Œæœ‰éœ€æ±‚çš„æœ‹å‹å¯ç›´æ¥ä½¿ç”¨ã€‚</p><ul><li><p>å®¢åˆ¶åŒ– Cache ç­–ç•¥ï¼Œå¯ä»¥ç”¨ PINCache or å…¶ä»–â€¦</p><li><p>å¤–éƒ¨åªéœ€å‘¼å« make AVAsset å·¥å‚ï¼Œå¸¦å…¥ URLï¼Œåˆ™ AVAsset å°±èƒ½æ”¯æ´ Caching</p><li><p>ä½¿ç”¨ Combine å®ç° Data Flow ç­–ç•¥</p><li><p>å†™äº†ä¸€äº›æµ‹è¯•</p></ul><h3 id="å‰è¨€"><span class="me-2">å‰è¨€</span><a href="#å‰è¨€" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æ—¢ä¸Šä¸€ç¯‡ã€Œ <a href="/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache å®è·µæ–¹æ³•æ¢ç©¶ä¹‹æ—…</a> ã€åå·²è¿‡äº†å¤§åŠå¹´ï¼Œå›¢é˜Ÿè¿˜æ˜¯ä¸€ç›´æƒ³è¦å®ç°è¾¹æ’­è¾¹ Cache åŠŸèƒ½å› ä¸ºå¯¹æˆæœ¬çš„å½±å“æå¤§ï¼›æˆ‘ä»¬æ˜¯éŸ³ä¹ä¸²æµå¹³å°ï¼Œå¦‚æœæ¯æ¬¡æ’­æ”¾åŒæ ·çš„æ­Œæ›²éƒ½è¦é‡æ–°æ‹¿æ•´ä¸ªæ¡£æ¡ˆï¼Œå¯¹æˆ‘ä»¬æˆ–å¯¹éåƒåˆ°é¥±çš„ä½¿ç”¨è€…æ¥è¯´éƒ½å¾ˆä¼¤æµé‡ï¼Œè™½ç„¶éŸ³ä¹æ¡£æ¡ˆé¡¶å¤šå‡  MBï¼Œä½†ç§¯æ²™æˆå¡”éƒ½æ˜¯é’±ï¼</p><p>å¦å¤–å› ä¸º Android é‚£è¾¹å·²ç»æœ‰å®ä½œè¾¹æ’­è¾¹ Cache çš„åŠŸèƒ½äº†ï¼Œä¹‹å‰æœ‰æ¯”è¾ƒè¿‡èŠ±è´¹ï¼ŒAndroid ç«¯ä¸Šçº¿åæ˜æ˜¾èŠ‚çœäº†è®¸å¤šæµé‡ï¼›ç›¸å¯¹æ›´å¤šä½¿ç”¨è€…çš„ iOS åº”è¯¥èƒ½æœ‰æ›´å¥½çš„èŠ‚æµä½“ç°ã€‚</p><p>æ ¹æ® <a href="/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">ä¸Šä¸€ç¯‡</a> çš„ç»éªŒï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­ä½¿ç”¨ HLS ( .m3u8/.ts) æ¥è¾¾æˆç›®çš„ï¼›äº‹æƒ…å°†ä¼šå˜å¾—éå¸¸å¤æ‚ç”šè‡³æ— æ³•è¾¾æˆï¼›æˆ‘ä»¬é€€è€Œæ±‚å…¶æ¬¡é€€å›å»ä½¿ç”¨ mp3 æ¡£ï¼Œè¿™æ ·å°±èƒ½ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> è¿›è¡Œå®ä½œã€‚</p><h3 id="ç›®æ ‡"><span class="me-2">ç›®æ ‡</span><a href="#ç›®æ ‡" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p>æ’­æ”¾è¿‡çš„éŸ³ä¹ä¼šåœ¨æœ¬åœ°äº§ç”Ÿ Cache å¤‡ä»½</p><li><p>æ’­æ”¾éŸ³ä¹æ—¶å…ˆæ£€æŸ¥æœ¬åœ°æœ‰æ—  Cache è¯»å–ï¼Œæœ‰åˆ™ä¸å†é‡ä¼ºæœå™¨è¦æ¡£æ¡ˆ</p><li><p>å¯è®¾ Cache ç­–ç•¥ï¼›ä¸Šé™æ€»å®¹é‡ï¼Œè¶…è¿‡æ—¶å¼€å§‹åˆ é™¤æœ€æ—§çš„ Cache æ¡£æ¡ˆ</p><li><p>ä¸å¹²æ¶‰åŸæœ¬ AVPlayer æ’­æ”¾æœºåˆ¶ ï¼ˆä¸ç„¶æœ€å¿«çš„æ–¹æ³•å°±æ˜¯è‡ªå·±å…ˆç”¨ URLSession æŠŠ mp3 è½½ä¸‹æ¥å¡ç»™ AVPlayerï¼Œä½†è¿™æ ·å°±å¤±å»åŸæœ¬èƒ½æ’­åˆ°å“ªè½½åˆ°å“ªçš„åŠŸèƒ½ï¼Œä½¿ç”¨è€…éœ€è¦ç­‰å¾…æ›´é•¿æ—¶é—´ï¼†æ›´æ¶ˆè€—æµé‡ï¼‰</p></ul><h3 id="å‰å¯¼çŸ¥è¯†-1-http11-range-èŒƒå›´è¯·æ±‚connection-keep-alive"><span class="me-2">å‰å¯¼çŸ¥è¯† (1)â€” HTTP/1.1 Range èŒƒå›´è¯·æ±‚ã€Connection Keep-Alive</span><a href="#å‰å¯¼çŸ¥è¯†-1-http11-range-èŒƒå›´è¯·æ±‚connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-èŒƒå›´è¯·æ±‚"><span class="me-2">HTTP/1.1 Range èŒƒå›´è¯·æ±‚</span><a href="#http11-range-èŒƒå›´è¯·æ±‚" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>é¦–å…ˆæˆ‘ä»¬è¦å…ˆäº†è§£åœ¨æ’­æ”¾å½±ç‰‡ã€éŸ³ä¹æ—¶æ˜¯æ€ä¹ˆè·Ÿä¼ºæœå™¨è¦æ±‚èµ„æ–™çš„ï¼›ä¸€èˆ¬æ¥è¯´å½±ç‰‡ã€éŸ³ä¹æ¡£æ¡ˆéƒ½å¾ˆå¤§ï¼Œä¸å¯èƒ½ç­‰åˆ°å…¨éƒ¨æ‹¿å®Œæ‰å¼€å§‹æ’­æ”¾å¸¸è§çš„æ˜¯æ’­åˆ°å“ªæ‹¿åˆ°äº†ï¼Œåªè¦æœ‰æ­£åœ¨æ’­æ”¾åŒºæ®µçš„èµ„æ–™å°±èƒ½è¿ä½œã€‚</p><p>è¦è¾¾åˆ°è¿™ä¸ªåŠŸèƒ½çš„æ–¹æ³•å°±æ˜¯é€è¿‡ HTTP/1.1 Range åªè¿”å›æŒ‡å®šèµ„æ–™å­—èŠ‚èŒƒå›´çš„èµ„æ–™ï¼Œä¾‹å¦‚æŒ‡å®š 0â€“100 å°±åªè¿”å› 0â€“100 è¿™ 100 bytes å¤§å°çš„èµ„æ–™ï¼›é€è¿‡è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä¾åºåˆ†æ®µå–å¾—èµ„æ–™ï¼Œç„¶åå†æ±‡æ•´å†ä¸€èµ·æˆå®Œæ•´çš„æ¡£æ¡ˆï¼›è¿™ä¸ªæ–¹æ³•ä¹Ÿèƒ½è¿ç”¨åœ¨æ¡£æ¡ˆä¸‹è½½ç»­ä¼ åŠŸèƒ½ä¸Šã€‚</p><h4 id="å¦‚ä½•åº”ç”¨"><span class="me-2">å¦‚ä½•åº”ç”¨ï¼Ÿ</span><a href="#å¦‚ä½•åº”ç”¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æˆ‘ä»¬ä¼šå…ˆä½¿ç”¨ HEAD å»çœ‹ Response Header äº†è§£åˆ°ä¼ºæœå™¨æ˜¯å¦æ”¯æ´ Range èŒƒå›´è¯·æ±‚ã€èµ„æºæ€»é•¿åº¦ã€æ¡£æ¡ˆç±»å‹ï¼š</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>ä½¿ç”¨ HEAD æˆ‘ä»¬èƒ½ä» Response Header å¾—åˆ°ä»¥ä¸‹èµ„è®¯ï¼š</strong></p><ul><li><p><strong>Accept-Ranges: bytes</strong> ä»£è¡¨ä¼ºæœå™¨æ”¯æ´ Range èŒƒå›´è¯·æ±‚ å¦‚æœæ²¡æœ‰ Response è¿™ä¸ªå€¼æˆ–æ˜¯æ˜¯ Accept-Ranges: none éƒ½ä»£è¡¨ä¸æ”¯æ´</p><li><p><strong>Content-Length:</strong> èµ„æºæ€»é•¿åº¦ï¼Œæˆ‘ä»¬è¦çŸ¥é“æ€»é•¿åº¦æ‰èƒ½å»åˆ†æ®µè¦èµ„æ–™ã€‚</p><li><p><strong>Content-Type:</strong> æ¡£æ¡ˆç±»å‹ï¼ŒAVPlayer æ’­æ”¾æ—¶éœ€è¦çŸ¥é“çš„èµ„è®¯ã€‚</p></ul><p>ä½†æœ‰æ—¶æˆ‘ä»¬ä¹Ÿä¼šä½¿ç”¨ GET <code class="language-plaintext highlighter-rouge">Range: bytes=0â€“1</code> ï¼Œæ„æ€æ˜¯æˆ‘è¦æ±‚ 0â€“1 èŒƒå›´çš„èµ„æ–™ä½†å®é™…æˆ‘æ ¹æœ¬ä¸ Care 0â€“1æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œæˆ‘åªæ˜¯è¦çœ‹ Response Header çš„èµ„è®¯ï¼› <strong>åŸç”Ÿ AVPlayer å°±æ˜¯ä½¿ç”¨ GET å»çœ‹ï¼Œæ‰€ä»¥æœ¬ç¯‡ä¹Ÿç…§æ—§ä½¿ç”¨</strong> ã€‚</p><blockquote><p><em>ä½†æ¯”è¾ƒå»ºè®®ä½¿ç”¨ HEAD å»çœ‹ï¼Œä¸€æ–¹æ³•æ¯”è¾ƒæ­£ç¡®ï¼Œå¦ä¸€æ–¹é¢ä¸‡ä¸€ä¼ºæœå™¨ä¸æ”¯æ´ Range åŠŸèƒ½ï¼›ç”¨ GET å»æ‘¸å°±ä¼šå˜å¼ºè¿«ä¸‹è½½å®Œæ•´æ¡£æ¡ˆã€‚</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“1"</span>
</pre></table></code></div></div><p><strong>ä½¿ç”¨ GET æˆ‘ä»¬èƒ½ä» Response Header å¾—åˆ°ä»¥ä¸‹èµ„è®¯ï¼š</strong></p><ul><li><p><strong>Accept-Ranges: bytes</strong> ä»£è¡¨ä¼ºæœå™¨æ”¯æ´ Range èŒƒå›´è¯·æ±‚ å¦‚æœæ²¡æœ‰ Response è¿™ä¸ªå€¼æˆ–æ˜¯æ˜¯ Accept-Ranges: none éƒ½ä»£è¡¨ä¸æ”¯æ´</p><li><p><strong>Content-Range: bytes 0â€“1/èµ„æºæ€»é•¿åº¦</strong> ï¼Œã€Œ/ã€åçš„æ•°å­—åŠèµ„æºæ€»é•¿åº¦ï¼Œæˆ‘ä»¬è¦çŸ¥é“æ€»é•¿åº¦æ‰èƒ½å»åˆ†æ®µè¦èµ„æ–™ã€‚</p><li><p><strong>Content-Type:</strong> æ¡£æ¡ˆç±»å‹ï¼ŒAVPlayer æ’­æ”¾æ—¶éœ€è¦çŸ¥é“çš„èµ„è®¯ã€‚</p></ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>çŸ¥é“ä¼ºæœå™¨æ”¯æ´ Range èŒƒå›´è¯·æ±‚åï¼Œå°±èƒ½åˆ†æ®µå‘èµ·èŒƒå›´è¯·æ±‚ï¼š</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“100"</span>
</pre></table></code></div></div><p><strong>ä¼ºæœå™¨ä¼šè¿”å› 206 Partial Contentï¼š</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/æ€»é•¿åº¦
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>è¿™æ—¶æˆ‘ä»¬å°±å¾—åˆ° Range 0â€“100 çš„ Dataï¼Œå¯å†ç»§ç»­å‘æ–°è¯·æ±‚æ‹¿ Range 100â€“200. .200â€“300â€¦åˆ°ç»“æŸã€‚</p><p>å¦‚æœæ‹¿çš„ Range è¶…è¿‡èµ„æºæ€»é•¿åº¦ä¼šè¿”å› 416 Range Not Satisfiableã€‚</p><p>å¦å¤–ï¼Œæƒ³æ‹¿å®Œæ•´æ¡£æ¡ˆèµ„æ–™é™¤äº†å¯ä»¥è¯·æ±‚ Range 0-æ€»é•¿åº¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ 0- æ–¹å¼å³å¯ï¼š</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“"</span>
</pre></table></code></div></div><p>å…¶ä»–è¿˜å¯ä»¥åŒä¸ªè¯·æ±‚è¦æ±‚å¤šä¸ª Range èµ„æ–™åŠä¸‹æ¡ä»¶å¼å­ï¼Œä½†æˆ‘ä»¬ç”¨ä¸åˆ°ï¼Œè¯¦æƒ…å¯ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">å‚è€ƒè¿™</a> ã€‚</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>http 1.1 é¢„è®¾æ˜¯å¼€å¯çŠ¶æ€ï¼Œ <strong>æ­¤ç‰¹æ€§èƒ½å®æ—¶å–å¾—å·²ä¸‹è½½çš„èµ„æ–™</strong> ï¼Œä¾‹å¦‚æ¡£æ¡ˆ 5 mbï¼Œèƒ½ 16 kbã€16 kbã€16 kbâ€¦ çš„å–å¾—ï¼Œä¸ç”¨ç­‰åˆ° 5mb éƒ½å¥½æ‰ç»™ä½ ã€‚</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keey-Alive
</pre></table></code></div></div><h4 id="å¦‚æœå‘ç°ä¼ºæœå™¨ä¸æ”¯æ´-range-keep-alive-"><span class="me-2"><strong><em>å¦‚æœå‘ç°ä¼ºæœå™¨ä¸æ”¯æ´ Rangeã€</em></strong> Keep-Alive <strong><em>ï¼Ÿ</em></strong></span><a href="#å¦‚æœå‘ç°ä¼ºæœå™¨ä¸æ”¯æ´-range-keep-alive-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>é‚£ä¹Ÿä¸ç”¨æè¿™ä¹ˆå¤šäº†ï¼Œç›´æ¥è‡ªå·±ç”¨ URLSession ä¸‹è½½å®Œ mp3 æ¡£æ¡ˆå¡ç»™æ’­æ”¾å™¨å°±å¥½â€¦.ä½†è¿™ä¸æ˜¯æˆ‘ä»¬è¦çš„ç»“æœï¼Œå¯ä»¥è¯·åç«¯å¸®å¿™ä¿®æ”¹ä¼ºæœå™¨è®¾å®šã€‚</em></p></blockquote><h3 id="å‰å¯¼çŸ¥è¯†-2--avplayer-åŸç”Ÿæ˜¯å¦‚ä½•å¤„ç†-avurlasset-èµ„æº"><span class="me-2">å‰å¯¼çŸ¥è¯† (2) â€” AVPlayer åŸç”Ÿæ˜¯å¦‚ä½•å¤„ç† AVURLAsset èµ„æºï¼Ÿ</span><a href="#å‰å¯¼çŸ¥è¯†-2--avplayer-åŸç”Ÿæ˜¯å¦‚ä½•å¤„ç†-avurlasset-èµ„æº" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY1IiBoZWlnaHQ9Ijc5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å½“æˆ‘ä»¬ä½¿ç”¨ AVURLAsset init with URL èµ„æºå¹¶èµ‹äºˆç»™ AVPlayer/AVQueuePlayer å¼€å§‹æ’­æ”¾ä¹‹åï¼ŒåŒä¸Šæ‰€è¿°ï¼Œé¦–å…ˆä¼šç”¨ GET Range 0â€“1 å»å–å¾—æ˜¯å¦æ”¯æ´ Range èŒƒå›´è¯·æ±‚ã€èµ„æºæ€»é•¿åº¦ã€æ¡£æ¡ˆç±»å‹è¿™ä¸‰ä¸ªèµ„è®¯ã€‚</p><p>æœ‰äº†æ¡£æ¡ˆèµ„è®¯åï¼Œä¼šå†å‘èµ·ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œè¯·æ±‚ä» 0-æ€»é•¿åº¦ çš„èµ„æ–™ã€‚</p><blockquote><p><em>âš ï¸ <strong>AVPlayer ä¼šè¯·æ±‚ä» 0-æ€»é•¿åº¦ çš„èµ„æ–™ï¼Œå¹¶é€è¿‡å®æ—¶å–å¾—å·²ä¸‹è½½çš„èµ„æ–™ç‰¹æ€§ (</strong> 16 kbã€16 kbã€16 kbâ€¦) <strong>å–å¾—åˆ°ä»–è§‰å¾—èµ„æ–™è¶³å¤Ÿåï¼Œä¼šå‘èµ· Cancel å–æ¶ˆè¿™ä¸ªç½‘è·¯è¯·æ±‚</strong> ï¼ˆæ‰€ä»¥å®é™…ä¹Ÿä¸ä¼šæ‹¿å®Œï¼Œé™¤éæ¡£æ¡ˆå¤ªå°ï¼‰ã€‚</em></p></blockquote><blockquote><p><em>ç»§ç»­æ’­æ”¾åæ‰ä¼šé€è¿‡ Range å¾€åè¯·æ±‚èµ„æ–™ã€‚</em></p></blockquote><blockquote><p><em>ï¼ˆè¿™éƒ¨åˆ†è·Ÿæˆ‘ä¹‹å‰æƒ³çš„ä¸ä¸€æ ·ï¼Œæˆ‘ä»¥ä¸ºä¼šæ˜¯0â€“100ã€100â€“200. .è¿™æ ·è¯·æ±‚ï¼‰</em></p></blockquote><p><strong>AVPlayer è¯·æ±‚èŒƒä¾‹ï¼š</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: æ€»é•¿åº¦ 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 kb receive
4. 16 kb receive...
5. cancel() // current offset is 700
6. ç»§ç»­æ’­æ”¾
7. GET 700-150000...
8. 16 kb receive
9. 16 kb receive...
10. cancel() // current offset is 1500
11. ç»§ç»­æ’­æ”¾
12. GET 1500-150000...
13. 16 kb receive
14. 16 kb receive...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 kb receive
20. 16 kb receive...
...
</pre></table></code></div></div><blockquote><p><em>âš ï¸ <strong>iOS â‰¤12 çš„æƒ…å†µä¸‹ï¼Œä¼šå…ˆå‘å‡ ä¸ªè¾ƒçŸ­çš„è¯·æ±‚è¯•è‘—æ‘¸æ‘¸çœ‹ï¼ˆï¼Ÿç„¶åæ‰ä¼šå‘è¦æ±‚åˆ°æ€»é•¿åº¦çš„è¯·æ±‚ï¼› iOS â‰¥ 13 åˆ™ä¼šç›´æ¥å‘è¦æ±‚åˆ°æ€»é•¿åº¦çš„è¯·æ±‚ã€‚</strong></em></p></blockquote><p>è¿˜æœ‰ä¸ªé¢˜å¤–çš„å‘ï¼Œå°±æ˜¯åœ¨è§‚å¯Ÿæ€ä¹ˆæ‹¿èµ„æºçš„æ—¶å€™ï¼Œæˆ‘ä½¿ç”¨äº† <a href="/posts/zrealm-dev/zh-cn/app-https%E4%BC%A0%E8%BE%93%E4%BB%8D%E9%81%AD%E7%AA%83%E5%8F%96-mitmproxy%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E6%88%98%E6%95%99%E5%AD%A6%E4%B8%8E%E9%98%B2%E8%8C%83%E6%8A%80%E5%B7%A7-46410aaada00/">mitmproxy</a> å·¥å…·å—…æ¢ï¼Œç»“æœå‘ç°å®ƒæ˜¾ç¤ºæœ‰é”™ï¼Œä¼šç­‰åˆ° response å…¨éƒ¨å›æ¥æ‰ä¼šæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºåˆ†æ®µã€ä½¿ç”¨æŒä¹…è¿æ¥æ¥ç»­ä¸‹è½½ï¼›å®³æˆ‘å“äº†ä¸€å¤§è·³ï¼ä»¥ä¸º iOS å¾ˆç¬¨å±…ç„¶æ¯æ¬¡éƒ½è¦æ•´ä¸ªæ¡£æ¡ˆå›æ¥ï¼ä¸‹æ¬¡è¦ç”¨å·¥å…·æ—¶è¦æœ‰ä¿æŒä¸€ç‚¹æ€€ç–‘ Orz</p><h4 id="cancel-å‘èµ·çš„æ—¶æœº"><span class="me-2">Cancel å‘èµ·çš„æ—¶æœº</span><a href="#cancel-å‘èµ·çš„æ—¶æœº" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li><p>å‰é¢è¯´åˆ°çš„ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œè¯·æ±‚ä» 0 å¼€å§‹ åˆ°æ€»é•¿åº¦çš„èµ„æºï¼Œæœ‰è¶³å¤Ÿ Data åä¼šå‘èµ· Cancel å–æ¶ˆè¯·æ±‚ã€‚</p><li><p>Seek æ—¶ä¼šå…ˆå‘èµ· Cancel å–æ¶ˆå…ˆå‰çš„è¯·æ±‚ã€‚</p></ol><blockquote><p><em>âš ï¸ åœ¨ AVQueuePlayer ä¸­åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèµ„æºã€AVPlayer æ›´æ¢æ’­æ”¾èµ„æºæ—¶å¹¶ä¸ä¼šå‘èµ· Cancel å–æ¶ˆå‰ä¸€é¦–çš„è¯·æ±‚ã€‚</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å…¶å®ä¹Ÿæ˜¯åŒæ ·å‘¼å« Resource Loader å¤„ç†ï¼Œåªæ˜¯ä»–è¦æ±‚çš„èµ„æ–™èŒƒå›´ä¼šæ¯”è¾ƒå°ã€‚</p><h3 id="å®ç°"><span class="me-2">å®ç°</span><a href="#å®ç°" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ‰äº†ä»¥ä¸Šå‰å¯¼çŸ¥è¯†åæˆ‘ä»¬æ¥çœ‹å®ç° AVPlayer æœ¬åœ° Cache åŠŸèƒ½çš„åŸç†æ–¹å¼ã€‚</p><p>å°±æ˜¯ä¹‹å‰æœ‰æåˆ°çš„ <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> ï¼Œè¿™ä¸ªæ¥å£è®©æˆ‘ä»¬èƒ½ <strong>è‡ªè¡Œå®è·µ Resource Loader</strong> ç»™ Asset ç”¨ã€‚</p><p>Resource Loader å®é™…å°±æ˜¯ä¸ªæ‰“å·¥ä»”ï¼Œæ’­æ”¾å™¨æ˜¯è¦æ¡£æ¡ˆèµ„è®¯è¿˜æ˜¯æ¡£æ¡ˆèµ„æ–™ï¼ŒèŒƒå›´å“ªé‡Œéƒ½å“ªé‡Œéƒ½æ˜¯ä»–å‘Šè¯‰æˆ‘ä»¬ï¼Œæˆ‘ä»¬å»åšå°±æ˜¯ã€‚</p><blockquote><p><em>çœ‹åˆ°æœ‰èŒƒä¾‹æ˜¯ä¸€ä¸ª <strong>Resource Loader æœåŠ¡æ‰€æœ‰ AVURLAsset</strong> ï¼Œæˆ‘è§‰å¾—æ˜¯é”™çš„ï¼Œåº”è¯¥è¦ä¸€ä¸ª Resource Loader æœåŠ¡ä¸€ä¸ª AVURLAssetï¼Œè·Ÿè‘— AVURLAsset çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»–æœ¬æ¥å°±å±äº AVURLAssetã€‚</em></p></blockquote><blockquote><p><em>ä¸€ä¸ª Resource Loader æœåŠ¡æ‰€æœ‰ AVURLAsset åœ¨ AVQueuePlayer ä¸Šä¼šå˜å¾—éå¸¸å¤æ‚ä¸”éš¾ä»¥ç®¡ç†ã€‚</em></p></blockquote><h4 id="è¿›å…¥è‡ªè®¢çš„-resource-loader-çš„æ—¶æœºç‚¹"><span class="me-2">è¿›å…¥è‡ªè®¢çš„ Resource Loader çš„æ—¶æœºç‚¹</span><a href="#è¿›å…¥è‡ªè®¢çš„-resource-loader-çš„æ—¶æœºç‚¹" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>è¦æ³¨æ„çš„æ˜¯ä¸æ˜¯å®è·µäº†è‡ªå·±çš„ Resource Loader ä»–å°±ä¼šç†ä½ ï¼Œåªæœ‰å½“ç³»ç»Ÿæ— æ³•è¾¨è¯†å¤„ç†è¿™ä¸ªèµ„æºçš„æ—¶å€™ï¼Œæ‰ä¼šèµ°ä½ çš„ Resource Loaderã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨å°† URL èµ„æºç»™äºˆ AVURLAsset ä¹‹å‰è¦å…ˆå°† Scheme æ¢æˆæˆ‘ä»¬è‡ªè®¢çš„ Schemeï¼Œä¸èƒ½æ˜¯ http/httpsâ€¦ è¿™äº›ç³»ç»Ÿèƒ½å¤„ç†çš„ Schemeã€‚</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>åªæœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦å®ç°ï¼š</strong></p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) -&gt; Bool :</ul><p>æ­¤æ–¹æ³•é—®æˆ‘ä»¬èƒ½ä¸èƒ½å¤„ç†æ­¤èµ„æºï¼Œreturn true èƒ½ï¼Œreturn false æˆ‘ä»¬ä¹Ÿä¸å¤„ç†ï¼ˆunsupported urlï¼‰ã€‚</p><p>æˆ‘ä»¬èƒ½ä» <code class="language-plaintext highlighter-rouge">loadingRequest</code> å–å‡ºè¦è¯·æ±‚ä»€ä¹ˆï¼ˆç¬¬ä¸€æ¬¡è¯·æ±‚æ¡£æ¡ˆèµ„è®¯è¿˜æ˜¯è¯·æ±‚èµ„æ–™ï¼Œè¯·æ±‚èµ„æ–™çš„è¯ Range æ˜¯å¤šå°‘åˆ°å¤šå°‘ï¼‰ï¼›çŸ¥é“è¯·æ±‚åæˆ‘ä»¬è‡ªè¡Œå‘èµ·è¯·æ±‚å»æ‹¿èµ„æ–™ï¼Œ <strong>åœ¨è¿™æˆ‘ä»¬å°±èƒ½å†³å®šè¦å‘èµ· URLSession è¿˜æ˜¯ä»æœ¬åœ°è¿”å› Data</strong> ã€‚</p><p>å¦å¤–ä¹Ÿèƒ½åœ¨æ­¤åš Data åŠ è§£å¯†æ“ä½œï¼Œä¿æŠ¤åŸå§‹èµ„æ–™ã€‚</p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) :</ul><p>å‰è¿°è¯´åˆ°çš„ <strong>Cancel å‘èµ·æ—¶æœº</strong> å‘èµ· Cancel æ—¶â€¦</p><p>æˆ‘ä»¬å¯ä»¥åœ¨è¿™å»å–æ¶ˆæ­£åœ¨è¯·æ±‚çš„ URLSessionã€‚</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYwIiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="æœ¬åœ°-cache-å®ç°æ–¹å¼"><span class="me-2">æœ¬åœ° Cache å®ç°æ–¹å¼</span><a href="#æœ¬åœ°-cache-å®ç°æ–¹å¼" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Cache çš„éƒ¨åˆ†æˆ‘ç›´æ¥ä½¿ç”¨ <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a> ï¼Œå°† Cache å·¥ä½œäº¤ç”±ä»–å¤„ç†ï¼Œå…å»æˆ‘ä»¬è¦å¤„ç† Cache è¯»å†™ DeadLockã€æ¸…é™¤ Cache LRU ç­–ç•¥ å®ä½œä¸Šçš„é—®é¢˜ã€‚</p><blockquote><p><strong><em>ï¸ï¸âš ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸OOMè­¦å‘Šï¼</em></strong></p></blockquote><blockquote><p><em>å› ä¸ºè¿™è¾¹æ˜¯é’ˆå¯¹éŸ³ä¹åš Cache æ¡£æ¡ˆå¤§å°é¡¶å¤š 10 MB ä¸Šä¸‹ï¼Œæ‰€ä»¥æ‰èƒ½ä½¿ç”¨ PINCache ä½œä¸ºæœ¬åœ° Cache å·¥å…·ï¼›å¦‚æœæ˜¯è¦æœåŠ¡å½±ç‰‡å°±æ— æ³•ä½¿ç”¨æ­¤æ–¹æ³•ï¼ˆå¯èƒ½ä¸€æ¬¡è¦è½½å…¥å¥½å‡  GB çš„èµ„æ–™åˆ°è®°å¿†ä½“ï¼‰</em></p></blockquote><p>æœ‰è¿™éƒ¨åˆ†éœ€æ±‚å¯å‚è€ƒå¤§å¤§çš„åšæ³•ï¼Œç”¨ FileHandle seek read/write çš„ç‰¹æ€§è¿›è¡Œå¤„ç†ã€‚</p><h3 id="å¼€å·¥"><span class="me-2">å¼€å·¥ï¼</span><a href="#å¼€å·¥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>ä¸å•°å”†ï¼Œå…ˆä¸Šå®Œæ•´ä¸“æ¡ˆï¼š</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" loading="lazy"></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æœ¬åœ° Cache èµ„æ–™ç‰©ä»¶æ˜ å°„å®ç° NSCodingï¼Œå›  PINCache æ˜¯ä¾èµ– archivedData æ–¹æ³• encode/decodeã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>å­˜æ”¾ï¼š</strong></p><ul><li><p><code class="language-plaintext highlighter-rouge">contentInformation</code> : AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code> ï¼š å­˜æ”¾ æ˜¯å¦æ”¯æ´ Range èŒƒå›´è¯·æ±‚(isByteRangeAccessSupported)ã€èµ„æºæ€»é•¿åº¦(contentLength)ã€æ¡£æ¡ˆç±»å‹(contentType)</p><li><p><code class="language-plaintext highlighter-rouge">mediaData</code> : åŸå§‹éŸ³è®¯ Data <strong>ï¼ˆè¿™è¾¹æ¡£æ¡ˆå¤ªå¤§ä¼š OOMï¼‰</strong></p></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å°è£… Data å­˜å…¥ã€å–å‡º PINCache é€»è¾‘ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>è¿™è¾¹å¤šæŠ½å‡º Protocol å› ä¸ºæœªæ¥å¯èƒ½ä½¿ç”¨å…¶ä»–å‚¨å­˜æ–¹å¼æ›¿ä»£ PINCacheï¼Œæ‰€ä»¥å…¶ä»–ç¨‹å¼åœ¨ä½¿ç”¨æ—¶æ˜¯ä¾èµ– Protocol è€Œé Class å®ä½“ã€‚</p><blockquote><p><em>âš ï¸ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>è¿™ä¸ªæ–¹æ³•æå…¶é‡è¦ã€‚</strong></em></p></blockquote><p>ç…§çº¿æ€§æ’­æ”¾åªè¦ä¸€ç›´ append æ–° Data åˆ° Cache Data ä¸­å³å¯ï¼Œä½†ç°å®æƒ…å†µå¤æ‚å¾—å¤šï¼Œä½¿ç”¨è€…å¯èƒ½æ’­äº† Range 0~100ï¼Œç›´æ¥ Seek åˆ° Range 200â€“500 æ’­æ”¾ï¼›å¦‚ä½•å°†å·²æœ‰çš„ 0-100 Data ä¸æ–°çš„ 200â€“500 Data åˆå¹¶å°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚</p><blockquote><p><em>âš ï¸Data åˆå¹¶æœ‰é—®é¢˜ä¼šå‡ºç°å¯æ€•çš„æ’­æ”¾é¬¼ç•œé—®é¢˜â€¦.</em></p></blockquote><p>è¿™è¾¹çš„ç­”æ¡ˆæ˜¯ï¼Œ <strong>æˆ‘ä»¬ä¸å¤„ç†éè¿ç»­èµ„æ–™</strong> ï¼›å› ä¸ºæ•ä¸“æ¡ˆä»…ä¸ºéŸ³è®¯ï¼Œæ¡£æ¡ˆä¹Ÿå°±å‡  MB (â‰¤ 10MB) ä»¥è€ƒé‡å¼€å‘æˆæœ¬å°±æ²¡åšäº†ï¼Œæˆ‘åªå¤„ç†åˆå¹¶è¿ç»­çš„èµ„æ–™ï¼ˆä¾‹å¦‚ç›®å‰å·²æœ‰ 0~100ï¼Œæ–°èµ„æ–™æ˜¯ 75~200ï¼Œåˆå¹¶ä¹‹åå˜0~200ï¼›å¦‚æœæ–°èµ„æ–™æ˜¯ 150~200ï¼Œæˆ‘åˆ™ä¼šå¿½ç•¥ä¸åˆå¹¶å¤„ç†ï¼‰</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijc4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å¦‚æœè¦è€ƒè™‘éè¿ç»­åˆå¹¶ï¼Œé™¤äº†åœ¨å‚¨å­˜ä¸Šè¦ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼ˆè¦æœ‰åŠæ³•è¾¨è¯†ç©ºç¼ºéƒ¨åˆ†ï¼‰ï¼›åœ¨ Request æ—¶ä¹Ÿè¦èƒ½ Query å‡ºå“ªæ®µéœ€è¦å‘ç½‘è·¯è¯·æ±‚å»æ‹¿ã€å“ªæ®µæ˜¯ä»æœ¬åœ°æ‹¿ï¼›è¦è€ƒé‡åˆ°è¿™æƒ…å†µå®ä½œä¼šéå¸¸å¤æ‚ã€‚</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" alt="å›¾ç‰‡å–è‡ªï¼š [iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMjQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å›¾ç‰‡å–è‡ªï¼š <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset æ˜¯ weak æŒæœ‰ ResourceLoader Delegateï¼Œæ‰€ä»¥è¿™è¾¹å»ºè®®è‡ªå·±å»ºç«‹ä¸€ä¸ª AVURLAsset Class ç»§æ‰¿è‡ª AVURLAssetï¼Œåœ¨å†…éƒ¨å»ºç«‹ã€èµ‹äºˆã€æŒæœ‰ ResourceLoader ï¼Œè®©ä»–è·Ÿè‘— AVURLAsset çš„ç”Ÿå‘½å‘¨æœŸï¼›å¦å¤–ä¹Ÿå¯ä»¥å‚¨å­˜åŸå§‹ URLã€CacheKey ç­‰èµ„è®¯â€¦ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>ä½¿ç”¨ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> æ˜¯ç”¨æ¥åˆ¤æ–­ URL æ˜¯å¦æ”¯æ´æŒ‚æˆ‘ä»¬çš„ Resource Loaderï¼ˆæ’é™¤ file:// ï¼‰ã€‚</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> å­˜æ”¾åŸå§‹èµ„æº URLã€‚</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> å­˜æ”¾è¿™ä¸ªèµ„æºçš„ Cache Keyï¼Œè¿™è¾¹ç›´æ¥ç”¨æ¡£æ¡ˆåç§°å½“ Cache Keyã€‚</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> è¯·ä¾ç…§ç°å®åœºæ™¯åšè°ƒæ•´ï¼Œå¦‚æœæ¡£æ¡ˆåç§°æœª hash å¯èƒ½é‡å¤å°±å»ºè®®å…ˆ hash åå½“ key é¿å…ç¢°æ’ï¼›å¦‚æœè¦ hash æ•´ä¸ª URL å½“ key ä¹Ÿè¦æ³¨æ„ URL æ˜¯å¦ä¼šå˜åŠ¨ (ä¾‹å¦‚æœ‰ç”¨ CDN)ã€‚</p><p>Hash å¯ä½¿ç”¨ md5â€¦sha. .ï¼ŒiOS â‰¥ 13 å¯ç›´æ¥ä½¿ç”¨ Apple çš„ <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a> ï¼Œå…¶ä»–å°±ä¸Š Github æ‰¾å§ï¼</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>é’ˆå¯¹ Remote Request çš„å°è£…ï¼Œä¸»è¦æ˜¯æœåŠ¡ ResourceLoader å‘èµ·çš„èµ„æ–™è¯·æ±‚ã€‚</p><p><code class="language-plaintext highlighter-rouge">RequestType</code> ï¼šç”¨æ¥åŒºåˆ†æ­¤ Request æ˜¯ ç¬¬ä¸€æ¬¡è¯·æ±‚æ¡£æ¡ˆèµ„è®¯(contentInformation)ã€è¿˜æ˜¯è¯·æ±‚èµ„æ–™(dataRequest)</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code> ï¼šè¯·æ±‚ Range èŒƒå›´ï¼Œend å¯æŒ‡å®šåˆ°å“ª(requestTo(Int64) )æˆ–å…¨éƒ¨(requestToEnd)ã€‚</p><p>æ¡£æ¡ˆèµ„è®¯å¯ç”±ï¼š</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>ä¸­å–å¾— Response Headerï¼Œå¦å¤–è¦æ³¨æ„å¦‚æœè¦æ”¹ HEAD å»æ‘¸ï¼Œä¸ä¼šè¿›è¿™ä¸ªè¦ç”¨å…¶ä»–æ–¹æ³•æ¥ã€‚</p><ul><li><p><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code> ï¼šçœ‹ Response Header ä¸­çš„ <strong>Accept-Ranges == bytes</strong></p><li><p><code class="language-plaintext highlighter-rouge">contentType</code> ï¼šæ’­æ”¾å™¨è¦çš„æ¡£æ¡ˆç±»å‹èµ„è®¯ï¼Œæ ¼å¼æ˜¯ç»Ÿä¸€ç±»è¯†åˆ«ç¬¦ï¼Œä¸æ˜¯ audio/mpeg ï¼Œè€Œæ˜¯å†™ä½œ public.mp3</p><li><p><code class="language-plaintext highlighter-rouge">contentLength</code> ï¼šçœ‹ Response Header ä¸­çš„ <strong>Content-Range</strong> ï¼šbytes 0â€“1/ <strong>èµ„æºæ€»é•¿åº¦</strong></p></ul><blockquote><p><em>âš ï¸è¿™è¾¹è¦æ³¨æ„ä¼ºæœå™¨ç»™çš„æ ¼å¼å¤§å°å†™ï¼Œä¸ä¸€å®šæ˜¯å†™ä½œ Accept-Ranges/Content-Rangeï¼›æœ‰çš„ä¼ºæœå™¨çš„æ ¼å¼æ˜¯å°å†™ accept-rangesã€Accept-rangesâ€¦</em></p></blockquote><p><strong>è¡¥å……ï¼šå¦‚æœè¦è€ƒé‡å¤§å°å†™å¯ä»¥å†™ HTTPURLResponse Extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">\\</span><span class="o">|</span><span class="p">\\</span><span class="o">|</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ä½¿ç”¨ï¼š</p><ul><li><p>contentLength = response.parseContentLengthFromContentRange( )</p><li><p>isByteRangeAccessSupported = response.parseAcceptRanges( )</p><li><p>contentType = response.mimeTypeUTI( )</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>åŒå‰å¯¼çŸ¥è¯†æ‰€è¿°ï¼Œä¼šå®æ—¶å–å¾—å·²ä¸‹è½½çš„èµ„æ–™ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¼šä¸€ç›´è¿›ï¼Œç‰‡æ®µç‰‡æ®µçš„æ‹¿åˆ° Dataï¼›æˆ‘ä»¬å°†ä»– append è¿› <code class="language-plaintext highlighter-rouge">downloadedData</code> å­˜æ”¾ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>ä»»åŠ¡å–æ¶ˆæˆ–ç»“æŸæ—¶éƒ½ä¼šè¿›è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™å°†å·²ä¸‹è½½çš„èµ„æ–™ä¿å­˜ä¸‹æ¥ã€‚</p><p>å¦‚å‰å¯¼çŸ¥è¯†ä¸­æåˆ°çš„ Cancel æœºåˆ¶ï¼Œå› æ’­æ”¾å™¨åœ¨æ‹¿åˆ°è¶³å¤Ÿèµ„æ–™åå°±ä¼šå‘èµ· Cancelï¼ŒCancel Requestï¼›æ‰€ä»¥è¿›åˆ°è¿™ä¸ªæ–¹æ³•æ—¶å®é™…ä¼šæ˜¯ <code class="language-plaintext highlighter-rouge">error = NSURLErrorCancelled</code> ï¼Œå› æ­¤ä¸ç®¡ error æˆ‘ä»¬æœ‰æ‹¿åˆ°èµ„æ–™éƒ½ä¼šå°è¯•å­˜ä¸‹æ¥ã€‚</p><blockquote><p><em>âš ï¸ å›  URLSession ä¼šç”¨å¹¶è¡Œæ–¹å¼å‡ºå»è¯·æ±‚èµ„æ–™ï¼Œæ‰€ä»¥è¯·ä¿æŒæ“ä½œéƒ½åœ¨DispatchQueueé‡Œï¼Œé¿å…èµ„æ–™é”™ä¹±(èµ„æ–™é”™ä¹±ä¸€æ ·ä¼šå‡ºç°å¯æ€•çš„æ’­æ”¾é¬¼ç•œ)ã€‚</em></p></blockquote><blockquote><p><em>ï¸ï¸âš ï¸URLSession æ²¡æœ‰å‘¼å« <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> æˆ– <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code> ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šå¼ºæŒæœ‰ç‰©ä»¶å¯¼è‡´ Memory Leakï¼›æ‰€ä»¥ä¸ç®¡æ˜¯å–æ¶ˆæˆ–æ˜¯å®Œæˆæˆ‘ä»¬éƒ½è¦å‘¼å«ï¼Œè¿™æ ·æ‰èƒ½åœ¨ä»»åŠ¡ç»“æŸé‡Šæ”¾ Requestã€‚</em></p></blockquote><blockquote><p><em>ï¸ï¸âš ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸å¦‚æœæ€• <code class="language-plaintext highlighter-rouge">downloadedData</code> OOMï¼Œå¯ä»¥åœ¨ didReceive Data ä¸­å°±å­˜å…¥æœ¬åœ°ã€‚</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                       <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil åˆ™ä»£è¡¨æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œæ’­æ”¾å™¨è¦æ±‚å…ˆç»™æ¡£æ¡ˆèµ„è®¯ã€‚</p><p>è¯·æ±‚æ¡£æ¡ˆèµ„è®¯æ—¶æˆ‘ä»¬éœ€è¦èµ‹äºˆè¿™ä¸‰é¡¹èµ„è®¯ï¼š</p><ul><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code> ï¼šæ˜¯å¦æ”¯æ´ Range æ‹¿ Data</p><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code> ï¼šç»Ÿä¸€ç±»è¯†åˆ«ç¬¦</p><li><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code> ï¼šæ¡£æ¡ˆæ€»é•¿åº¦ Int64</p></ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> å¯å–å¾—è¦æ±‚ Range çš„èµ·å§‹ offsetã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> å¯å–å¾—è¦æ±‚ Range çš„é•¿åº¦ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true åˆ™ä¸ç®¡è¦æ±‚ Range çš„é•¿åº¦ï¼Œç›´æ¥æ‹¿åˆ°åº•ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> è¿”å›å·²è½½å…¥çš„ Data ç»™æ’­æ”¾å™¨ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> å¯å–å¾—å½“å‰ data offsetï¼Œ <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> å <code class="language-plaintext highlighter-rouge">currentOffset</code> ä¼šè·Ÿè‘—æ¨ç§»ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> èµ„æ–™éƒ½è½½å®Œäº†ï¼Œå‘ŠçŸ¥æ’­æ”¾å™¨ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>æ’­æ”¾å™¨è¯·æ±‚èµ„æ–™ï¼Œæˆ‘ä»¬å…ˆçœ‹æœ¬åœ° Cache æœ‰æ— èµ„æ–™ï¼Œæœ‰åˆ™è¿”å›ï¼›è‹¥åªæœ‰éƒ¨åˆ†èµ„æ–™åˆ™ä¸€æ ·è¿”å›éƒ¨åˆ†ï¼Œä¾‹å¦‚æˆ‘æœ¬åœ°æœ‰ 0â€“100 ï¼Œæ’­æ”¾å™¨è¦æ±‚ 0â€“200ï¼Œåˆ™å…ˆè¿”å› 0â€“100ã€‚</p><p>è‹¥æ²¡æœ‰æœ¬åœ° Cacheã€è¿”å›çš„èµ„æ–™ä¸å¤Ÿï¼Œåˆ™ä¼šå‘èµ· ResourceLoaderRequest è¯·æ±‚ä»ç½‘è·¯æ‹¿èµ„æ–™ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>æ’­æ”¾å™¨å–æ¶ˆè¯·æ±‚ï¼Œå–æ¶ˆ ResourceLoaderRequestã€‚</p><blockquote><p><em>ä½ å¯èƒ½æœ‰å‘ç°</em> <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> <em>çš„ offset æ˜¯çœ‹ <code class="language-plaintext highlighter-rouge">currentOffset</code> ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå…ˆä»æœ¬åœ° <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> å·²ä¸‹è½½ Dataï¼›æ‰€ä»¥ç›´æ¥çœ‹æ¨ç§»åçš„ offset å³å¯ã€‚</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>âš ï¸ requests æœ‰çš„èŒƒä¾‹æ˜¯åªç”¨ <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> æ¥å­˜æ”¾ï¼Œè¿™ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå› ä¸ºå¯èƒ½å½“å‰çš„ request æ­£åœ¨æ‹¿å–ï¼Œä½¿ç”¨è€…åˆ seek è¿™æ—¶ä¼šå–æ¶ˆæ—§çš„å‘èµ·æ–°çš„ï¼›ä½†å› ä¸ä¸€å®šä¼šç…§é¡ºåºå‘ç”Ÿï¼Œå¯èƒ½å…ˆèµ°å‘æ–°è¯·æ±‚å†èµ°å–æ¶ˆï¼›æ‰€ä»¥ç”¨ Dictionary å»å­˜å–æ“ä½œè¿˜æ˜¯æ¯”è¾ƒå®‰å…¨ï¼</em></p></blockquote><blockquote><p><em>âš ï¸è®©æ‰€æœ‰æ“ä½œéƒ½åœ¨åŒä¸ª DispatchQueue é˜²æ­¢å‡ºç°èµ„æ–™é¬¼ç•œã€‚</em></p></blockquote><p><strong>deinit æ—¶å–æ¶ˆæ‰€æœ‰è¿˜åœ¨è¯·æ±‚çš„ requests</strong> Resource Loader Deinit å³ä»£è¡¨ AVURLAsset Deinitï¼Œä»£è¡¨æ’­æ”¾å™¨å·²ç»ä¸éœ€è¦è¿™ä¸ªèµ„æºäº†ï¼›æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ Cancel è¿˜åœ¨å–èµ„æ–™çš„ Requestï¼Œå·²ç»è½½çš„ä¸€æ ·ä¼šå†™å…¥ Cacheã€‚</p><h3 id="è¡¥å……åŠé¸£è°¢"><span class="me-2">è¡¥å……åŠé¸£è°¢</span><a href="#è¡¥å……åŠé¸£è°¢" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æ„Ÿè°¢ <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex æ±¤</a> å¤§å¤§æŒ‡ç‚¹ã€‚</p><p>æ„Ÿè°¢ <a href="https://medium.com/u/aab116fd9d4d" target="_blank">å¤–å­™å¥³</a> æä¾›å¼€å‘ä¸Šçš„æ„è§åŠæ”¯æŒã€‚</p><h4 id="æœ¬ç¯‡åªé’ˆå¯¹éŸ³ä¹å°æ¡£"><span class="me-2">æœ¬ç¯‡åªé’ˆå¯¹éŸ³ä¹å°æ¡£</span><a href="#æœ¬ç¯‡åªé’ˆå¯¹éŸ³ä¹å°æ¡£" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å½±ç‰‡å¤§æ¡£æ¡ˆå¯èƒ½ä¼šåœ¨ downloadedDataã€AssetData/PINCacheAssetDataManager å‘ç”Ÿ Out Of Memory é—®é¢˜ã€‚</p><p>åŒå‰è¿°ï¼Œå¦‚æœè¦è§£å†³è¿™ä¸ªé—®é¢˜è¯·ä½¿ç”¨ fileHandler seek read/wirte å»æ“ä½œæœ¬åœ° Cache è¯»å–å†™å…¥ï¼ˆå–ä»£AssetData/PINCacheAssetDataManagerï¼‰ï¼›æˆ–æ‰¾çœ‹çœ‹ Github æœ‰æ²¡æœ‰å¤§ data write/read to file çš„ä¸“æ¡ˆå¯ç”¨ã€‚</p><h4 id="avqueueplayer-åˆ‡æ¢æ’­æ”¾é¡¹ç›®æ—¶å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„é¡¹ç›®"><span class="me-2">AVQueuePlayer åˆ‡æ¢æ’­æ”¾é¡¹ç›®æ—¶å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„é¡¹ç›®</span><a href="#avqueueplayer-åˆ‡æ¢æ’­æ”¾é¡¹ç›®æ—¶å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„é¡¹ç›®" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>åŒå‰å¯¼çŸ¥è¯†ä¸­æ‰€è¿°ï¼Œåœ¨æ›´æ¢æ’­æ”¾ç›®æ ‡æ—¶æ˜¯ä¸ä¼šå‘èµ· Cancel çš„ï¼›å¦‚æœæ˜¯ AVPlayer ä¼šèµ° AVURLAsset Deinit æ‰€ä»¥ä¸‹è½½ä¹Ÿä¼šä¸­æ–­ï¼›ä½† AVQueuePlayer ä¸ä¼šï¼Œå› ä¸ºéƒ½è¿˜åœ¨ Queue é‡Œï¼Œåªæ˜¯æ’­æ”¾ç›®æ ‡æ¢åˆ°ä¸‹ä¸€é¦–è€Œå·²ã€‚</p><p>è¿™è¾¹å”¯ä¸€åšæ³•å°±åªèƒ½æ¥æ”¶å˜æ¢æ’­æ”¾ç›®æ ‡é€šçŸ¥ï¼Œç„¶ååœ¨æ”¶åˆ°é€šçŸ¥åå–æ¶ˆä¸Šä¸€æ‰‹çš„ AVURLAsset loadingã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="éŸ³è®¯èµ„æ–™åŠ è§£å¯†"><span class="me-2">éŸ³è®¯èµ„æ–™åŠ è§£å¯†</span><a href="#éŸ³è®¯èµ„æ–™åŠ è§£å¯†" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>éŸ³è®¯åŠ è§£å¯†å¯åœ¨ ResourceLoaderRequest ä¸­æ‹¿åˆ° Data è¿›è¡Œã€è¿˜æœ‰å‚¨å­˜æ—¶èƒ½åœ¨ AssetData çš„ encode/decode å¯¹å­˜åœ¨æœ¬åœ°çš„ Dataè¿›è¡ŒåŠ è§£å¯†ã€‚</p><p><strong>CryptoKit SHA ä½¿ç”¨èŒƒæœ¬ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-ç›¸å…³æ“ä½œ"><span class="me-2">PINCache ç›¸å…³æ“ä½œ</span><a href="#pincache-ç›¸å…³æ“ä½œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache åŒ…å« PINMemoryCache å’Œ PINDiskCacheï¼ŒPINCache ä¼šå¸®æˆ‘ä»¬å¤„ç†ä»æ¡£æ¡ˆè¯»åˆ° Memory æˆ–ä» Memory å†™å…¥æ¡£æ¡ˆçš„äº‹ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ PINCache è¿›è¡Œæ“ä½œã€‚</p><p>åœ¨æ¨¡æ‹Ÿå™¨ä¸­æŸ¥æ‰¾ Cache æ¡£æ¡ˆä½ç½®ï¼š</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzgiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> å–å¾—æ¨¡æ‹Ÿå™¨æ¡£æ¡ˆè·¯å¾„</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Finder -&gt; å‰å¾€ -&gt; è´´ä¸Šè·¯å¾„</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>åœ¨ Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader å°±æ˜¯æˆ‘ä»¬å»ºçš„ Resource Loader Cache ç›®å½•ã€‚</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: â€œResourceLoaderâ€)</code> å…¶ä¸­çš„ name å°±æ˜¯ç›®å½•åç§°ã€‚</p><p>ä¹Ÿå¯ä»¥æŒ‡å®š rootPath ï¼Œç›®å½•å°±å¯ä»¥æ”¹åˆ° Documents åº•ä¸‹ï¼ˆä¸æ€•è¢«ç³»ç»Ÿæ¸…æ‰ï¼‰ã€‚</p><p><strong>è®¾å®š PINCache æœ€å¤§ä¸Šé™ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" alt="ç³»ç»Ÿé¢„è®¾ä¸Šé™" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMzYiIGhlaWdodD0iODkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>ç³»ç»Ÿé¢„è®¾ä¸Šé™</p><p>è®¾ 0 çš„è¯å°±ä¸ä¼šä¸»åŠ¨åˆ é™¤æ¡£æ¡ˆã€‚</p><h3 id="åè®°"><span class="me-2">åè®°</span><a href="#åè®°" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>åŸå…ˆå¤ªå°çœ‹è¿™ä¸ªåŠŸèƒ½çš„å›°éš¾åº¦ï¼Œä»¥ä¸ºä¸‰ä¸¤ä¸‹å°±èƒ½å¤„ç†å¥½ï¼›ç»“æœåƒå°½è‹¦å¤´ï¼Œå¤§æ¦‚åˆå¤šèŠ±äº†ä¸¤å‘¨å¤„ç†èµ„æ–™å‚¨å­˜çš„é—®é¢˜ï¼Œä¸è¿‡ä¹Ÿå°±æ­¤å½»åº•äº†è§£æ•´ä¸ª Resource Loader è¿ä½œæœºåˆ¶ã€ GCD ã€Dataã€‚</p><h3 id="å‚è€ƒèµ„æ–™"><span class="me-2">å‚è€ƒèµ„æ–™</span><a href="#å‚è€ƒèµ„æ–™" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ€åé™„ä¸Šç ”ç©¶å¦‚ä½•å®ä½œçš„å‚è€ƒèµ„æ–™</p><ol><li><p><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°</a> ä»…è®²åŸç†</p><li><p><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">åŸºäºAVPlayerå®ç°éŸ³è§†é¢‘æ’­æ”¾å’Œç¼“å­˜ï¼Œæ”¯æŒè§†é¢‘ç”»é¢çš„åŒæ­¥è¾“å‡º</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] æœ‰é™„ç¨‹å¼ï¼ˆå¾ˆå®Œæ•´ï¼Œä½†å¾ˆå¤æ‚ï¼‰</p><li><p><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> ï¼ˆç®€æ˜“å®ç°ï¼Œè¾ƒå¥½æ‡‚ä½†ä¸å®Œæ•´ï¼‰</p><li><p><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">å¯èƒ½æ˜¯ç›®å‰æœ€å¥½çš„ AVPlayer éŸ³è§†é¢‘ç¼“å­˜æ–¹æ¡ˆ AVAssetResourceLoaderDelegate</a></p><li><p><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">ä»¿æŠ–éŸ³ Swift ç‰ˆ</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ]ï¼ˆè›®æœ‰æ„æ€çš„ä¸“æ¡ˆï¼Œå¤åˆ»æŠ–éŸ³ APPï¼›é‡Œé¢ä¹Ÿæœ‰ç”¨åˆ° Resource Loaderï¼‰</p><li><p><a href="/posts/zrealm-dev/zh-cn/ios-hls-cache-%E5%AE%9E%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E8%BE%B9%E6%92%AD%E8%BE%B9%E5%BF%AB%E5%8F%96%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache å®è·µæ–¹æ³•æ¢ç©¶ä¹‹æ—…</a></p></ol><h3 id="å»¶ä¼¸"><span class="me-2">å»¶ä¼¸</span><a href="#å»¶ä¼¸" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C ç‰ˆ)</ul><p>æœ‰ä»»ä½•é—®é¢˜åŠæŒ‡æ•™æ¬¢è¿ <a href="https://www.zhgchg.li/contact" target="_blank">ä¸æˆ‘è”ç»œ</a> ã€‚</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=ğŸº&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>æœ¬æ–‡é¦–æ¬¡å‘è¡¨äº Medium (<a href="https://medium.com/p/6ce488898003" target="_blank"><strong>ç‚¹å‡»æŸ¥çœ‹åŸå§‹ç‰ˆæœ¬</strong></a>)ï¼Œç”± <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> æä¾›è‡ªåŠ¨è½¬æ¢ä¸åŒæ­¥æŠ€æœ¯ã€‚</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2021-01-31-6ce488898003.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,049+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E8%8A%82%E7%9C%81%20iOS%20%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E8%8A%82%E7%9C%81%20iOS%20%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AE%259E%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E8%258A%2582%25E7%259C%2581-ios-%25E9%259F%25B3%25E4%25B9%2590%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and Efficiencyï½œTool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD å®æˆ˜æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šCI/CD æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•é€è¿‡ CI/CD æ‰“é€ ç¨³å®šé«˜æ•ˆçš„å¼€å‘å›¢é˜Ÿï¼Ÿå·¥å…·é€‰æ‹©ï¼Ÿ</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD å¯¦æˆ°æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šCI/CD æ˜¯ä»€éº¼ï¼Ÿå¦‚ä½•é€é CI/CD æ‰“é€ ç©©å®šé«˜æ•ˆçš„é–‹ç™¼åœ˜éšŠï¼Ÿå·¥å…·é¸æ“‡ï¼Ÿ</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web Appï½œIntegrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">ä½¿ç”¨ Google Apps Script Web App è¡¨å•ä¸²æ¥ Github Action CI/CD å·¥ä½œ</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters ğŸ”–</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zh-cn/avplayer-%E8%BE%B9%E6%92%AD%E8%BE%B9-cache-%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98-ios-%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer è¾¹æ’­è¾¹ Cache æŠ€æœ¯å®æˆ˜ï½œiOS æœ¬åœ°ç¼“å­˜ä¼˜åŒ–æ”»ç•¥</h4><div class="text-muted"><p>é’ˆå¯¹ iOS å¼€å‘è€…é¢ä¸´ AVPlayer æ’­æ”¾æ—¶ç¼“å­˜ä¸è¶³é—®é¢˜ï¼Œè§£æ AVAssetResourceLoaderDelegate å®ä½œæŠ€å·§ï¼Œæœ‰æ•ˆæå‡æ’­æ”¾æµç•…åº¦ä¸æœ¬åœ°ç¼“å­˜æ•ˆç‡ï¼Œå‡å°‘é‡å¤ä¸‹è½½ä¸å»¶è¿Ÿï¼Œæ‰“é€ ç¨³å®šéŸ³ä¹ä¸å½±ç‰‡æ’­æ”¾å™¨ä½“éªŒã€‚</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1612089702" data-df="ll" > Jan 31, 2021 </time><h4 class="pt-0 my-2">AVPlayer å¯¦è¸æœ¬åœ° Cache åŠŸèƒ½å¤§å…¨</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset å¯¦ä½œ AVAssetResourceLoaderDelegate</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1612089702" data-df="ll" > Jan 31, 2021 </time><h4 class="pt-0 my-2">AVPlayer Local Cache Implementationï½œMaster AVAssetResourceLoaderDelegate for Smooth Playback</h4><div class="text-muted"><p>Discover how to implement local caching with AVPlayer and AVQueuePlayer using AVURLAsset and AVAssetResourceLoaderDelegate to reduce buffering and ensure seamless video playback on iOS devices.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" class="btn btn-outline-primary" aria-label="Older" ><p>AVPlayer Local Cache Implementationï½œMaster AVAssetResourceLoaderDelegate for Smooth Playback</p></a> <a href="/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" class="btn btn-outline-primary" aria-label="Newer" ><p>AVPlayer å¯¦è¸æœ¬åœ° Cache åŠŸèƒ½å¤§å…¨</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">æ­£é«”ä¸­æ–‡</a> | <a href="/tags/simplified-chinese">ç®€ä½“ä¸­æ–‡</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-19 15:57:44 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
