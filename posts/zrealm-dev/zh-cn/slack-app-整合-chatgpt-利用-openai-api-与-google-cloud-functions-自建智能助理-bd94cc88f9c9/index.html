<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="针对团队协作痛点，打造可自订 OpenAI API Key 的 Slack ChatGPT 机器人，运用 Google Cloud Functions 快速部署，实现即时问答与上下文串接，提升工作效率并保障资料安全。" /><meta property="og:description" content="针对团队协作痛点，打造可自订 OpenAI API Key 的 Slack ChatGPT 机器人，运用 Google Cloud Functions 快速部署，实现即时问答与上下文串接，提升工作效率并保障资料安全。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-16T21:17:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="twitter:title" content="Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-02-18T12:09:17+08:00","datePublished":"2024-02-16T21:17:01+08:00","description":"针对团队协作痛点，打造可自订 OpenAI API Key 的 Slack ChatGPT 机器人，运用 Google Cloud Functions 快速部署，实现即时问答与上下文串接，提升工作效率并保障资料安全。","headline":"Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"},"url":"https://zhgchg.li/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"}</script><title>Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</h1><p class="post-desc fw-light mb-4">针对团队协作痛点，打造可自订 OpenAI API Key 的 Slack ChatGPT 机器人，运用 Google Cloud Functions 快速部署，实现即时问答与上下文串接，提升工作效率并保障资料安全。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1708089421" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 16, 2024 </time> </span> <span> Updated <time data-ts="1708229357" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link preview-img blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="11578 words" > <em>64 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><strong>點擊這裡</strong></a>查看本文章正體中文版本。</p></blockquote><blockquote class="prompt-info"><p>基于 SEO 考量，本文标题与描述经 AI 调整，原始版本请参考内文。</p></blockquote><hr /><h3 id="slack--chatgpt-integration"><span class="me-2">Slack &amp; ChatGPT Integration</span><a href="#slack--chatgpt-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>自行打造 ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p><h4 id="背景"><span class="me-2">背景</span><a href="#背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>最近在团队内推广运用 Generative AI 提升工作效率，初步只希望达成 AI Assistant (ChatGPT 功能)，从减少日常资料查询、整理繁琐资料、手工处理资料的时间，以提升工作效率；希望是工程师、设计师、PM、行销…都能自由使用的。</p><p>最简单的方法就是直接买 ChatGPT Team 方案，一个席位 $25 美金一年；但由于尚不确定大家的使用频率(量)及希望能在外来与更多协作、开发流程进行整合，所以改采用 OpenAI API 方式，再透过其他服务封装整合供团队成员使用。</p><p>OpenAI API Key 可从 <a href="https://platform.openai.com/api-keys" target="_blank">此页面产生</a> ，Key 没有分对应的 Model 版本，使用时才需指定要使用的 Model 版本并产生对应的 Token 费用。</p><blockquote><p>我们需要一个服务能自行设定 OpenAI API Key 并使用该 Key 进行类 ChatGPT 使用。</p></blockquote><blockquote><p>不管是 Chrome Extension 或 Slack App 都蛮难找到能自行设定 OpenAI API Key 的服务，大部分服务都是要卖他们自己的订阅制，让使用者自订 API Key 等于赚不到钱纯做慈善。</p></blockquote><h4 id="chrome-extension-sidebargpt"><span class="me-2">[Chrome Extension] <a href="https://chromewebstore.google.com/detail/chatgpt-assistant-for-chr/mejjgaogggabifjfjdbnobinfibaamla" target="_blank">SidebarGPT</a></span><a href="#chrome-extension-sidebargpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>安装完后可到设定 -&gt; General -&gt; 填入 OpenAI API Key。</p><p><a href="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY1OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>可从浏览器小工具栏、侧边 Icon 直接呼叫出聊天界面，直接使用：</p><p><a href="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjcwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="chrome-extension-openai-translator"><span class="me-2">[Chrome Extension] <a href="https://chrome.google.com/webstore/detail/ogjibjphoadhljaoicdnjnmgokohngcc" target="_blank">OpenAI Translator</a></span><a href="#chrome-extension-openai-translator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>如果只有翻译需求可使用这个，能自订 OpenAI API Key 用于翻译。</p><p><a href="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzQiIGhlaWdodD0iMTI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MzkiIGhlaWdodD0iMzc2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>另外他是 <a href="https://github.com/openai-translator/openai-translator" target="_blank">开源专案</a> ，并同时提供 macOS/Windows 桌面版程式：</p><p><a href="https://github.com/openai-translator/openai-translator" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/609416865/2fee2046-51a5-407c-9641-851e5032ec63" alt="" loading="lazy"></a></p><p>Chrome Extension 的优点是快速简单方便，直接装直接使用；缺点是需要将 API Key 提供给所有成员，难以管控外泄问题，还有使用第三方服务也难以保证大家的资料安全。</p><h4 id="self-hosted-librechat"><span class="me-2">[Self-hosted] <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a></span><a href="#self-hosted-librechat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/danny-avila/LibreChat" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/102ca4ff10ae06f9a1fa9f7126e73ef92a641310dd20377ac942cdc7132b79f9/danny-avila/LibreChat" alt="" loading="lazy"></a></p><p>研发部同事推荐的 OpenAI API Chat 封装服务，提供身份认证使用及几乎还原 ChatGPT 使用介面、功能比 ChatGPT 更强大的开源专案。</p><p><a href="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMzU3IiBoZWlnaHQ9Ijc3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>只需专案、装好 Docker、设定好 .env、启 Docker 服务就能直接透过网站连入使用。</p><blockquote><p><strong>试了一下简直无懈可击，就是本地版 ChatGPT 服务；要说缺点的话就只有需要伺服器部署服务吧；如果没其他考量，可以直接使用此开源专案。</strong></p></blockquote><h3 id="slack-app"><span class="me-2">Slack App</span><a href="#slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>其实 <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a> 服务起起来放上伺服器就已经达成效果了，但是灵光一闪想说如果能整合在日常工具当中是不是更方便？加上公司伺服器有严格的权限设定，不太能随意起服务。</p><p>当时也没想太多，想说 Slack App 的 OpenAI API 整合服务应该很多，找一个设定一下就好；没想到事情没有那么简单。</p><p>Google 搜寻只找到一篇 Slack x OpenAI 2023/03 官方的新闻稿「 <a href="https://slack.com/intl/zh-tw/blog/news/why-we-built-the-chatgpt-app-for-slack" target="_blank">Why we built the ChatGPT app for Slack</a> 」及一些 Beta 图片：</p><p><a href="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" alt="&lt;https://www.salesforce.com/news/stories/chatgpt-app-for-slack/&gt;{:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjU2MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://www.salesforce.com/news/stories/chatgpt-app-for-slack/" target="_blank">https://www.salesforce.com/news/stories/chatgpt-app-for-slack/</a></p><p>看起来功能非常完整而且能大大提升工作效率，不过截自 2024/01 为止尚无释出的消息，文末提供的 <a href="http://openai.com/waitlist/slack" target="_blank">Beta 注册连结</a> 也已经失效，暂时没有下文。(还是微软想先让 Teams 支援？)</p><p><strong>[2024/02/14 Update]：</strong></p><ul><li>看 <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack 官方新闻</a> 猜测与 ChatGPT(OpenAI) 整合的功能应该已经被放弃或改整合成 <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack AI</a> 。</ul><h4 id="slack-apps"><span class="me-2">Slack Apps</span><a href="#slack-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjkiIGhlaWdodD0iODU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>因无官方的 App 转而搜寻第三方开发者的 App，搜寻并试用了几个都碰壁；符合的 App 不多就算了，也没有一个是能提供自订 Key 功能的，每个都是做来卖服务、卖钱的。</p><h3 id="自行实现-chatgpt-openai-api-for-slack-app"><span class="me-2">自行实现 ChatGPT OpenAI API for Slack App</span><a href="#自行实现-chatgpt-openai-api-for-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>之前有一些 Slack App 开发经验，决定自己动手做。</p><blockquote><p><strong>⚠️声明⚠️</strong></p></blockquote><blockquote><p>本文是以串接 OpenAI API 为例演示如何建立 Slack App 和快速使用 Google Cloud Funtions 来达成需求，Slack App 有需多应用可做，大家可以自由发挥。</p></blockquote><blockquote><p>⚠️⚠️ Google Cloud Functions，Function as a Service (FaaS) 的优点是方便快速、有免费额度，程式写好就能直接部署执行、自动扩充，缺点是服务环境由 GCP 控制，当服务太久没被呼叫会进入休眠，此时再次呼叫会进入 <a href="https://cloud.google.com/functions/docs/configuring/recommender?hl=en" target="_blank">Cold Start</a> 冷启动，需要较长的反应时间；另外也较难起多个服务互相使用。</p></blockquote><blockquote><p>更完整或使用需求量大的话还是建议自己起 VM (App Engine) 架 Server 跑服务。</p></blockquote><h4 id="最终成果图"><span class="me-2">最终成果图</span><a href="#最终成果图" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDIiIGhlaWdodD0iNDg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>完整 Cloud Functions Python 程式码、Slack App 设定已附在文末，懒得一步一步看的朋友可快速前往查阅。</p></blockquote><h3 id="step-1-建立-slack-app"><span class="me-2">Step 1. 建立 Slack App</span><a href="#step-1-建立-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>前往 <a href="https://api.slack.com/apps" target="_blank">Slack App</a> ：</p><p><a href="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjYiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>点击「Create New App」</p><p><a href="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTAiIGhlaWdodD0iNDExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>选择「From scratch」</p><p><a href="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTEiIGhlaWdodD0iNDg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>输入「App Name」、选择要加入的 Workspace。</p><p><a href="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5ODIiIGhlaWdodD0iNzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>建立完成后先到「OAuth &amp; Permissions」新增 Bot 需要的权限。</p><p><a href="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNjMxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>下滑找到「Scopes」区块，点击「Add an OAuth Scope」搜寻加入以下几个权限：</p><ul><li><p>chat:write</p><li><p>im:history</p><li><p>im:read</p><li><p>im:write</p></ul><p>Bot 权限加完之后点击左方「Install App」-&gt;「Install to Workspace」</p><p><a href="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA5IiBoZWlnaHQ9IjMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>尔后如果 Slack App 有新增其他权限，都需要再点击一次「Reinstall」才会生效。</p><p><a href="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzMiIGhlaWdodD0iODI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><strong>但请放心，Bot Token 不会因为重新安装而改变。</strong></p></blockquote><p>Slack Bot Token 权限设定好之后，前往「App Home」：</p><p><a href="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTkiIGhlaWdodD0iNDkzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>下滑找到「Show Tabs」区块，启用「Messages Tab」及「Allow users to send Slash commands and messages from the messages tab」(这个没勾一样不能传讯息，会显示「Sending messages to this app has been turned off.」)</p><p><a href="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDgiIGhlaWdodD0iNTU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>回到 Slack Workspace，按「Command+R」更新画面就能看到新建立的 Slack App 和讯息输入匡：</p><p><a href="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg2IiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>此时传送讯息给 App 还没有任何功能。</p><h4 id="启用-event-subscriptions-功能"><span class="me-2">启用 Event Subscriptions 功能</span><a href="#启用-event-subscriptions-功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjEiIGhlaWdodD0iNzc4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>再来，我们需要启用 Slack App 的事件订阅功能，当指定事件发生时会打 API 到指定 URL。</p><h4 id="新增-google-cloud-funtions"><span class="me-2">新增 Google Cloud Funtions</span><a href="#新增-google-cloud-funtions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Request URL 的部分， <a href="https://console.cloud.google.com/functions/list" target="_blank">Google Cloud Funtions</a> 就要上场了。</p><p>设定好专案、帐单资讯后点击「Create Function」</p><p><a href="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjI4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDgiIGhlaWdodD0iODM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Function name 输入专案名称、Authentication 选择「Allow unauthenticated invocations」意即知道网址就能存取。</p><blockquote><p>如果你无法建立 Function 或无法更改 Authentication 代表你的 GCP 帐号没有完整的 Google Cloud Functions 权限，需要请组织管理员在原本的身份之外额外加上 Cloud Functions Admin 的权限，才能使用。</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTUyIiBoZWlnaHQ9Ijc4MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Runtime: Python 3.8 or 更高</p><p><code class="language-plaintext highlighter-rouge">main.py</code> ：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># 可以简单使用 print 纪录执行阶段 Log，可在 Logs 中查看
</span>    <span class="c1"># 进阶 Logging Level 使用可参考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服务太久没呼叫，再次呼叫会进入冷启动的特性，可能无法在 Slack 规定的 3 秒内回应
</span>    <span class="c1"># 加上 OpenAI API 请求到答复需要一定时间(依照回应长度可能要接近 1 分钟才能结束)
</span>    <span class="c1"># Slack 在时限内收不到回应会认为 Request lost，Slack 会再次重复呼叫
</span>    <span class="c1"># 会造成重复请求、回应的问题，因此我们可以在 Response Headers 设置 X-Slack-No-Retry: 1 告知 Slack ，就算没在时限内收到回应也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的请求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> 输入以下依赖：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>functions-framework==3.*
requests==2.31.0
openai==1.9.0
</pre></table></code></div></div><p>目前还没有什么功能，只是让 Slack App 能通过 Event Subscriptions 启用验证，可以直接点击「Deploy」完成首次部署。</p><blockquote><p>⚠️如果你不熟悉 Cloud Functions 编辑器，可先下拉到文章底部查看补充内容。</p></blockquote><p><strong>等待部署完成后（绿勾勾）</strong> ，复制 Cloud Functions URL：</p><p><a href="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjI3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>将 Request URL 贴回 Slack App Enable Events。</p><p><a href="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iMzAyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>如果没问题就会出现「Verified」完成验证。</p><p>这边做的事是收到 Slack 发来的验证请求时：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jhj5dZrVaK7ZwHHjRyZWjbDl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"challenge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url_verification"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>回应 <code class="language-plaintext highlighter-rouge">challenge</code> 栏位内容，就能通过验证。</p><p><a href="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MzciIGhlaWdodD0iODYxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>启用成功后往下滑找到「Subscribe to bot events」区块，点击「Add Bot User Event」新增「message.im」权限。</p><p><a href="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDQiIGhlaWdodD0iMTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>新增完全权限后点击上方「reinstall your app」连结重新安装 Slack App 到 Workspace 后，Slack App 的设定就告一段落啰。</p><p>也可以去「App Home」或「Basic Information」客制化 Slack App 的名称与大头贴。</p><p><a href="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" alt="Basic Information" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjUiIGhlaWdodD0iNTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Basic Information</p><h3 id="step-2-完善-openai-api-与-slack-app-串接-direct-讯息"><span class="me-2">Step 2. 完善 OpenAI API 与 Slack App 串接 (Direct 讯息)</span><a href="#step-2-完善-openai-api-与-slack-app-串接-direct-讯息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>首先我们先要取得必备的 <code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> 与 <code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> 两个 Key。</p><ul><li><code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> ： <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI API key page</a> .</ul><p><a href="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcwIiBoZWlnaHQ9IjQwNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> ： <a href="https://api.slack.com/apps/" target="_blank">OAuth Tokens for Your Workspace</a></ul><p><a href="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTEiIGhlaWdodD0iNzE4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="处理-direct-message-im-event--串接-openai-api-回应"><span class="me-2">处理 Direct Message (IM) Event &amp; 串接 OpenAI API 回应</span><a href="#处理-direct-message-im-event--串接-openai-api-回应" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>当使用者在与 Slack App 讯息传送时会收到以下 Event Json Paylod ：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"api_app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"client_msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"block_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"orfng"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text_section"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"team"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"event_ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"im"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event_callback"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1707920753</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorizations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_bot"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_enterprise_install"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"is_ext_shared_channel"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_context"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4-XXX"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>基于以上 Json Payload，我们可以完善 Slack 讯息到 OpenAI API 再到回复 Slack 讯息的串接：</p><p><strong>Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># 可以简单使用 print 纪录执行阶段 Log，可在 Logs 中查看
</span>    <span class="c1"># 进阶 Logging Level 使用可参考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服务太久没呼叫，再次呼叫会进入冷启动的特性，可能无法在 Slack 规定的 3 秒内回应
</span>    <span class="c1"># 加上 OpenAI API 请求到答复需要一定时间(依照回应长度可能要接近 1 分钟才能结束)
</span>    <span class="c1"># Slack 在时限内收不到回应会认为 Request lost，Slack 会再次重复呼叫
</span>    <span class="c1"># 会造成重复请求、回应的问题，因此我们可以在 Response Headers 设置 X-Slack-No-Retry: 1 告知 Slack ，就算没在时限内收到回应也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的请求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># 如果 Event 来源是 App 且 App ID == Slack App ID 代表是自己 Slack App 触发的事件
</span>        <span class="c1"># 忽略不处理，否则会陷入无限循环 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名称，例如：message(讯息相关), app_mention(被标记提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(编辑讯息), message_deleted(删除讯息)...
</span>        <span class="c1"># 新讯息无 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是讯息编辑、删除、被回应...
</span>            <span class="c1"># 忽略不处理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台湾繁体中文与英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂简体字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说中文就使用台湾繁体中文回答，并且必须符合台湾常用语。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回应我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文与英文之间要有一个空格。中文文字与任何其他语言文字包含数字与 emoji 之间都要有一个空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知识太旧，请上网搜寻后回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回应产生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回应)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次讯息，避免频繁呼叫 Slack Update 讯息 API 导致失败或浪费 Cloud Functions 请求次数
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[发生错误]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 测试看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>现在你已经可以进行类 ChatGPT 与 OpenAI API 进行问与答了。</p><h4 id="增加中断-stream-response-功能节省-token"><span class="me-2">增加中断 Stream Response 功能节省 Token</span><a href="#增加中断-stream-response-功能节省-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>实现方式有很多种，可在同条讨论串下如果还没回应完，使用者又输入新讯息则中断之前的 Response 抑或是点击讯息增加中断回应的 Shortcut。</p><p><a href="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDEiIGhlaWdodD0iNDUxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>本文以新增「讯息中断」Shortcut 为例。</p><p>不管哪一种中断方式，核心原理都是相同的，因为我们没有 Database 储存产生的讯息、讯息状态的资讯；因此实现方式是依赖 Slack 讯息的 <a href="https://api.slack.com/metadata/using" target="_blank"><strong>metadata 栏位</strong></a> (可存放客制化资讯在指定讯息内)。</p><p>我们在使用 <a href="https://api.slack.com/methods/chat.update" target="_blank">chat.update</a> API Endpoint 时，如果呼叫成功会回传当前讯息的文字内容与 metadata，因此我们在上面的 OpenAI API Stream -&gt; Slack Update Message 的程式码之中多加入判断修改请求的回应中的 metadata 是否有「中断」的标记，如果有则中断 OpenAI Stream Response。</p><p><strong>首先需要先新增 Slack App 讯息 Shortcut</strong></p><p>前往 <a href="https://api.slack.com/apps" target="_blank">Slack App</a> 管理介面，找到「Interactivity &amp; Shortcuts」区块，点击启用，网址一样使用同个 Cloud Functions URL。</p><p><a href="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTQiIGhlaWdodD0iNzQ3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>点击「Create New Shortcut」新增新的讯息 Shortcut。</p><p><a href="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTAiIGhlaWdodD0iNTk0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>选择「On messages」。</p><p><a href="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTAwIiBoZWlnaHQ9IjUyNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p>Name 动作标题： <code class="language-plaintext highlighter-rouge">停止 OpenAI API 产生回应</code></p><li><p>Short Description 简介： <code class="language-plaintext highlighter-rouge">停止 OpenAI API 产生回应</code></p><li><p>Callback ID： <code class="language-plaintext highlighter-rouge">abort_openai_api</code> (程式识别用，可自订)</p></ul><p>点击「Create」建立完成后，最后记得点右下「Save Changes」储存设定。</p><p><a href="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTYiIGhlaWdodD0iNTkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>再次点击上方「reinstall your app」才会生效。</p><p><a href="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjQ0NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>回到 Slack 在讯息上点击右上角「…」就会出现「停止 OpenAI API 产生回应」Shortcut (此时点击无作用)。</p><p><a href="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzEiIGhlaWdodD0iMzg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>当使用者在讯息上按下</strong> Shortcut <strong>会发送一个 Event Json Payload：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="s">"type"</span><span class="p">:</span> <span class="s">"message_action"</span><span class="p">,</span>
  <span class="s">"token"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"action_ts"</span><span class="p">:</span> <span class="s">"1706188005.387646"</span><span class="p">,</span>
  <span class="s">"team"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"domain"</span><span class="p">:</span> <span class="s">"XXXXXX-XXXXXX"</span>
  <span class="p">},</span>
  <span class="s">"user"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"zhgchgli"</span><span class="p">,</span>
    <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"zhgchgli"</span>
  <span class="p">},</span>
  <span class="s">"channel"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"directmessage"</span>
  <span class="p">},</span>
  <span class="s">"is_enterprise_install"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s">"enterprise"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">"callback_id"</span><span class="p">:</span> <span class="s">"abort_openai_api"</span><span class="p">,</span>
  <span class="s">"trigger_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"response_url"</span><span class="p">:</span> <span class="s">"https://hooks.slack.com/app/XXXXXX/XXXXXX/XXXXXX"</span><span class="p">,</span>
  <span class="s">"message_ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
  <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"bot_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"type"</span><span class="p">:</span> <span class="s">"message"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">:</span> <span class="s">"高丽菜包 的英文翻译是 </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">。如果您是将它作为菜名使用，有时候会具体到菜里的内容来命名，比如 </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">（猪肉高丽菜包）或 </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">（蔬菜高丽菜包）。"</span><span class="p">,</span>
    <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
    <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text"</span><span class="p">,</span>
        <span class="s">"block_id"</span><span class="p">:</span> <span class="s">"eKgaG"</span><span class="p">,</span>
        <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text_section"</span><span class="p">,</span>
            <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"高丽菜包 的英文翻译是 </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">。如果您是将它作为菜名使用，有时候会具体到菜里的内容来命名，比如 </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">（猪肉高丽菜包）或 </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">（蔬菜高丽菜包）。"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"team"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"bot_profile"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"deleted"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="s">"Rick C-137"</span><span class="p">,</span>
      <span class="s">"updated"</span><span class="p">:</span> <span class="mi">1706001605</span><span class="p">,</span>
      <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"icons"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"image_36"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_36.png"</span><span class="p">,</span>
        <span class="s">"image_48"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_48.png"</span><span class="p">,</span>
        <span class="s">"image_72"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_72.png"</span>
      <span class="p">},</span>
      <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
    <span class="p">},</span>
    <span class="s">"edited"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706187989.000000"</span>
    <span class="p">},</span>
    <span class="s">"thread_ts"</span><span class="p">:</span> <span class="s">"1706178832.102439"</span><span class="p">,</span>
    <span class="s">"parent_user_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>完善 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 会从 post payload field 给
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以简单使用 print 纪录执行阶段 Log，可在 Logs 中查看
</span>    <span class="c1"># 进阶 Logging Level 使用可参考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服务太久没呼叫，再次呼叫会进入冷启动的特性，可能无法在 Slack 规定的 3 秒内回应
</span>    <span class="c1"># 加上 OpenAI API 请求到答复需要一定时间(依照回应长度可能要接近 1 分钟才能结束)
</span>    <span class="c1"># Slack 在时限内收不到回应会认为 Request lost，Slack 会再次重复呼叫
</span>    <span class="c1"># 会造成重复请求、回应的问题，因此我们可以在 Response Headers 设置 X-Slack-No-Retry: 1 告知 Slack ，就算没在时限内收到回应也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的请求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># 如果 Event 来源是 App 且 App ID == Slack App ID 代表是自己 Slack App 触发的事件
</span>        <span class="c1"># 忽略不处理，否则会陷入无限循环 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名称，例如：message(讯息相关), app_mention(被标记提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(编辑讯息), message_deleted(删除讯息)...
</span>        <span class="c1"># 新讯息无 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是讯息编辑、删除、被回应...
</span>            <span class="c1"># 忽略不处理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 处理 Shortcut
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 讯息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 产生回应 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 产生回应成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台湾繁体中文与英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂简体字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说中文就使用台湾繁体中文回答，并且必须符合台湾常用语。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回应我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文与英文之间要有一个空格。中文文字与任何其他语言文字包含数字与 emoji 之间都要有一个空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知识太旧，请上网搜寻后回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回应产生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回应)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次讯息，避免频繁呼叫 Slack Update 讯息 API 导致失败或浪费 Cloud Functions 请求次数
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 讯息有 metadata &amp; metadata event_type == aborted 则代表此回应已被使用者标记为终止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已终止]*</span><span class="sh">"</span>
                <span class="c1"># 讯息已被删除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[发生错误]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 测试看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NDUiIGhlaWdodD0iMzgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjUwNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>成功！当我们完成 <code class="language-plaintext highlighter-rouge">停止 OpenAI API</code> Shortcut 之后，正在产生的回应就会终止，并回应 <strong>[已终止]</strong> 。</p><blockquote><p>另外相同原理，你也可以建立一个删除讯息的 Shortcut，实作删除 Slack App 所发出的讯息。</p></blockquote><h4 id="同个讨论串threads-增加上下文context-功能"><span class="me-2">同个讨论串(Threads) 增加上下文(Context) 功能</span><a href="#同个讨论串threads-增加上下文context-功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>如果在同个讨论串下再发送新讯息，可以当成是同个问题的再次追问，此时可以加上一个功能，为新的 prompt 补上前面对话内容。</p><p><strong>补上 <code class="language-plaintext highlighter-rouge">slackGetReplies</code> &amp; 将内容填充到 OpenAI API Prompt：</strong></p><p><strong>完善 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 会从 post payload field 给
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以简单使用 print 纪录执行阶段 Log，可在 Logs 中查看
</span>    <span class="c1"># 进阶 Logging Level 使用可参考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服务太久没呼叫，再次呼叫会进入冷启动的特性，可能无法在 Slack 规定的 3 秒内回应
</span>    <span class="c1"># 加上 OpenAI API 请求到答复需要一定时间(依照回应长度可能要接近 1 分钟才能结束)
</span>    <span class="c1"># Slack 在时限内收不到回应会认为 Request lost，Slack 会再次重复呼叫
</span>    <span class="c1"># 会造成重复请求、回应的问题，因此我们可以在 Response Headers 设置 X-Slack-No-Retry: 1 告知 Slack ，就算没在时限内收到回应也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的请求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># 如果 Event 来源是 App 且 App ID == Slack App ID 代表是自己 Slack App 触发的事件
</span>        <span class="c1"># 忽略不处理，否则会陷入无限循环 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名称，例如：message(讯息相关), app_mention(被标记提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(编辑讯息), message_deleted(删除讯息)...
</span>        <span class="c1"># 新讯息无 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是讯息编辑、删除、被回应...
</span>            <span class="c1"># 忽略不处理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 处理 Shortcut (讯息)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 讯息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 产生回应 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 产生回应成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台湾繁体中文与英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂简体字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说中文就使用台湾繁体中文回答，并且必须符合台湾常用语。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回应我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文与英文之间要有一个空格。中文文字与任何其他语言文字包含数字与 emoji 之间都要有一个空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知识太旧，请上网搜寻后回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># 如果是 Slac App (OpenAI API Response) 则标示为 assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 使用者的讯息内容标为 user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回应产生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回应)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次讯息，避免频繁呼叫 Slack Update 讯息 API 导致失败或浪费 Cloud Functions 请求次数
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 讯息有 metadata &amp; metadata event_type == aborted 则代表此回应已被使用者标记为终止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已终止]*</span><span class="sh">"</span>
                <span class="c1"># 讯息已被删除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[发生错误]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 测试看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTUiIGhlaWdodD0iMjk3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p>左图为原本没有补上 Context 时再追问问题，会是全新的对话。</p><li><p><strong>右图是加上补上 Context 后就能理解整个对话情境跟新的问题。</strong></p></ul><h3 id="完成"><span class="me-2">完成！</span><a href="#完成" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>至此我们已经自己打造了一个 ChatGPT (via OpenAI API) Slack App Bot 机器人。</p><blockquote><p>您也可以依照自己的需求参考 <a href="https://api.slack.com/" target="_blank">Slack API</a> 与 OpenAI API Custom instructions 在 Cloud Functions Python 程式中进行搭配，例如训练一个频道专门回答团队问题与查找专案文件、一个频道专门负责翻译、一个频道专门分析数据…等等。</p></blockquote><h3 id="补充"><span class="me-2">补充</span><a href="#补充" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="在-11-讯息之外标记机器人回答问题"><span class="me-2">在 1:1 讯息之外，标记机器人回答问题</span><a href="#在-11-讯息之外标记机器人回答问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzAiIGhlaWdodD0iMzEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>可以在任一频道(需要将机器人加入频道)标记机器人请他回答问题</ul><p><strong>首先需要增加 <code class="language-plaintext highlighter-rouge">app_mention</code> Event Subscription：</strong></p><p><a href="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA1IiBoZWlnaHQ9IjU1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>加入完成-&gt;「Save Changes」储存完成-&gt;「reinstall your app」完成。</p><p>在上述的 <code class="language-plaintext highlighter-rouge">main.py</code> 程式 <code class="language-plaintext highlighter-rouge">#Handle Event Subscriptions Events…</code></p><p>Code Block <strong>中加入新的 Event Type 判断：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>        <span class="c1"># 提及类 Event (@SlcakApp 你好)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容，移除开头标记字串 &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>部署后，即可完成。</p><h4 id="slack-app-删除所发的讯息"><span class="me-2">Slack App 删除所发的讯息</span><a href="#slack-app-删除所发的讯息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>您无法直接在 Slack 上删除 Slack App 发出的讯息，可以参考上述「 <code class="language-plaintext highlighter-rouge">停止 OpenAI API 产生回应</code> 」Shortcut 方式，新增一个「删除讯息」Shortcut。</p><p>并在 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> 程式中：</p><p><code class="language-plaintext highlighter-rouge"># 处理 Shortcut Code Block</code> 新增一个 callback_id 判断，判断等于你定的「删除讯息」Shortcut Callback ID 然后将参数带入以下方法，即可完成删：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></table></code></div></div><p><a href="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MjYiIGhlaWdodD0iNTAxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="slack-app-没反应"><span class="me-2">Slack App 没反应</span><a href="#slack-app-没反应" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>检查 Token 是否正确</p><li><p>查看 Cloud Functions Logs 是否有错误</p><li><p>Cloud Functions 是否部署完成</p><li><p>Slack App 是否在你发问的频道(如非与 Slack App 1:1 的对话频道要把机器人加入频道才会生效)</p><li><p>在 SlackRequest 方法下 Log 纪录 Slack API Response</p></ul><h4 id="cloud-functions-public-url-不够安全"><span class="me-2">Cloud Functions Public URL 不够安全</span><a href="#cloud-functions-public-url-不够安全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>如果怕 Cloud Functions URL 不够安全，可以自己加上 query token 验证</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>
    <span class="c1"># 验证 token 参数是否合法
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="cloud-functions-相关问题"><span class="me-2">Cloud Functions 相关问题</span><a href="#cloud-functions-相关问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="计费方式"><span class="me-2">计费方式</span><a href="#计费方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>不同区域、CPU、RAM、容量、流量…价格不一样，请参考 <a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">官方计价</a> 表。</p><p><a href="https://cloud.google.com/functions/pricing?hl=zh-tw#free_tier" target="_blank">免费额度</a> 如下：(2024/02/15)</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">Cloud</span> <span class="nx">Functions</span> <span class="nx">针对运算时间资源提供永久免费方案</span><span class="err">，</span>
<span class="nx">当中包括</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">秒和</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">秒的分配方式</span><span class="err">。</span><span class="nx">除了</span> <span class="mi">200</span> <span class="nx">万次叫用以外</span><span class="err">，</span>
<span class="nx">这个免费方案也提供</span> <span class="mi">400</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">秒和</span> <span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">秒的运算时间</span><span class="err">，</span>
<span class="nx">以及每月</span> <span class="mi">5</span> <span class="nx">GB</span> <span class="nx">的网际网路资料传输量</span><span class="err">。</span>

<span class="nx">免费方案的使用额度</span><span class="err">，</span><span class="nx">是以上述级别</span> <span class="mi">1</span> <span class="nx">价格的同等美元金额计算</span><span class="err">。</span>
<span class="nx">无论执行函式的区域采用的是级别</span> <span class="mi">1</span> <span class="nx">和</span><span class="o">/</span><span class="nx">或级别</span> <span class="mi">2</span> <span class="nx">价格</span><span class="err">，</span><span class="nx">系统都会分配同等美元金额给您</span><span class="err">。</span>
<span class="nx">不过在扣除免费方案的额度时</span><span class="err">，</span><span class="nf">系统将以函式执行区域的级别 </span><span class="p">(</span><span class="nx">级别</span> <span class="mi">1</span> <span class="nx">或级别</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">为准</span><span class="err">。</span>

<span class="nx">请注意</span><span class="err">，</span><span class="nx">即便您采用的是免费方案</span><span class="err">，</span><span class="nx">也必须拥有有效的帐单帐户</span><span class="err">。</span>
</pre></table></code></div></div><blockquote><p>btw. .Slack App 免费、不限一定要 Premium 才能使用。</p></blockquote><h4 id="slack-app-回应太慢太久-timeout"><span class="me-2">Slack App 回应太慢、太久 Timeout</span><a href="#slack-app-回应太慢太久-timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>(撇除 OpenAI API 高峰时间回应较慢问题)</strong> ，如果是 Cloud Function 贫颈，可在 Cloud Function 编辑器第一页展开设定：</p><p><a href="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDQiIGhlaWdodD0iODM5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可调整 CPU、RAM、Timeout 时间、Concurrent 数量…提升处理请求速度。</p><blockquote><p>*但可能会需要计费</p></blockquote><h4 id="开发阶段-testing--debug"><span class="me-2">开发阶段 Testing &amp; Debug</span><a href="#开发阶段-testing--debug" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjczNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>点击「Test Function」就会跑出 Cloud Shell 视窗在下方工具列，等待约 3–5 分钟(第一次启动较久)，Build 完成并同意以下授权后：</p><p><a href="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzEiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>看到出现「Function is ready to test」后即可点击「Run Test」执行方法 Debug 测试。</p><p>可使用右方「Triggering event」区块输入 JSON Body 会带入 <code class="language-plaintext highlighter-rouge">request_json</code> 参数进行测试，或直接改程式 inject test object 进行测试。</p><blockquote><p>*请注意 Cloud Shell/Cloud Run可能有延伸费用。</p></blockquote><blockquote><p>建议部署(Deploy)前都先跑一次测试看看，至少确保 Build 能成功。</p></blockquote><h4 id="build-失败程式码不见了该怎么办"><span class="me-2">Build 失败，程式码不见了该怎么办？</span><a href="#build-失败程式码不见了该怎么办" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg0IiBoZWlnaHQ9IjE0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>如果不小心写错程式造成 Cloud Function Deploy Build Failed，会出现错误提示，此时点击「EDIT AND REDEPLOY」回到 <strong>编辑器后会发现刚刚改的 Code 都不见了！！！</strong></p><p>无须担心，此时点击左方「Source Code」选择「Last Failed Deployment」就能恢复刚刚 Build Failed 的 Code：</p><p><a href="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjQ3MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="查看执行阶段-print-logs"><span class="me-2">查看执行阶段 <code class="language-plaintext highlighter-rouge">print</code> Logs</span><a href="#查看执行阶段-print-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>*请注意 Cloud Logging、Query 查询 Logs 可能有延伸费用。</p></blockquote><h3 id="最终程式码-python-38"><span class="me-2">最终程式码 (Python 3.8)</span><a href="#最终程式码-python-38" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="cloud-functions"><span class="me-2">Cloud Functions</span><a href="#cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">main.py</code> ：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 自己定义的安全验证 Token
# 网址需带上 ?token=SAFE_ACCESS_TOKEN 参数才会接受请求  
</span><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 会从 post payload field 给
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以简单使用 print 纪录执行阶段 Log，可在 Logs 中查看
</span>    <span class="c1"># 进阶 Logging Level 使用可参考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="c1"># print(payload)
</span>
    <span class="c1"># 受限 FAAS(Cloud Functions)，服务太久没呼叫，再次呼叫会进入冷启动的特性，可能无法在 Slack 规定的 3 秒内回应
</span>    <span class="c1"># 加上 OpenAI API 请求到答复需要一定时间(依照回应长度可能要接近 1 分钟才能结束)
</span>    <span class="c1"># Slack 在时限内收不到回应会认为 Request lost，Slack 会再次重复呼叫
</span>    <span class="c1"># 会造成重复请求、回应的问题，因此我们可以在 Response Headers 设置 X-Slack-No-Retry: 1 告知 Slack ，就算没在时限内收到回应也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 验证 token 参数是否合法
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># 如果是 Slack Retry 的请求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># 如果 Event 来源是 App 且 App ID == Slack App ID 代表是自己 Slack App 触发的事件
</span>        <span class="c1"># 忽略不处理，否则会陷入无限循环 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名称，例如：message(讯息相关), app_mention(被标记提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(编辑讯息), message_deleted(删除讯息)...
</span>        <span class="c1"># 新讯息无 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># 讯息类 Event
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是讯息编辑、删除、被回应...
</span>            <span class="c1"># 忽略不处理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        
        <span class="c1"># 提及类 Event (@SlcakApp 你好)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Event之讯息 发送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息 所属频道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之讯息内容，移除开头标记字串 &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Event之讯息 TS (讯息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之讯息的讨论串母讯息 TS (讯息 ID)
</span>            <span class="c1"># 讨论串内的新讯息才会有这个资料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 处理 Shortcut (讯息)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 讯息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 产生回应 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 产生回应成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="c1"># 如果是 删除讯息
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delete_message</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">删除 Slack App 讯息成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台湾繁体中文与英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂简体字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说中文就使用台湾繁体中文回答，并且必须符合台湾常用语。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我说英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回应我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文与英文之间要有一个空格。中文文字与任何其他语言文字包含数字与 emoji 之间都要有一个空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知识太旧，请上网搜寻后回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># 如果是 Slac App (OpenAI API Response) 则标示为 assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 使用者的讯息内容标为 user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回应产生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回应)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次讯息，避免频繁呼叫 Slack Update 讯息 API 导致失败或浪费 Cloud Functions 请求次数
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 讯息有 metadata &amp; metadata event_type == aborted 则代表此回应已被使用者标记为终止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已终止]*</span><span class="sh">"</span>
                <span class="c1"># 讯息已被删除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[发生错误]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> ：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="py">functions-framework</span><span class="p">=</span><span class="s">=3.*</span>
<span class="py">requests</span><span class="p">=</span><span class="s">=2.31.0</span>
<span class="py">openai</span><span class="p">=</span><span class="s">=1.9.0</span>
</pre></table></code></div></div><h4 id="slack-app-设定"><span class="me-2">Slack App 设定</span><a href="#slack-app-设定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>OAuth &amp; Permissions</strong></p><p><a href="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNTk5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>删除按钮反灰的项目是加入 Shortcut 后 Slack 自动补上的权限。</ul><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li><p>Interactivity: Enable</p><li><p>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code></p><li><p>Subscribe to bot events:</p></ul><p><a href="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDkiIGhlaWdodD0iMzUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li><p>Interactivity: Enable</p><li><p>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code></p><li><p>Shortcuts:</p></ul><p><a href="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iMzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>App Home</strong></p><ul><li><p>Always Show My Bot as Online: Enable</p><li><p>Messages Tab: Enable</p><li><p>Allow users to send Slash commands and messages from the messages tab: ✅</p></ul><p><strong>Basic Information</strong></p><p><a href="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iNTUyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>Rick &amp; Morty 🤘🤘🤘</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" alt="[Reddit](https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NzMiIGhlaWdodD0iNzcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/" target="_blank">Reddit</a></p><h3 id="工商时间"><span class="me-2">工商时间</span><a href="#工商时间" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如果您与您的团队有自动化工具、流程串接需求，不论是 Slack App 开发、Notion、Asana、Google Sheet、Google Form、GA 数据，各种串接需求，欢迎与我 <a href="https://zhgchg.li/contact/" target="_blank"><strong>联络开发</strong></a> 。</p><p>有任何问题及指教欢迎 <a href="https://www.zhgchg.li/contact" target="_blank">与我联络</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次发表于 Medium (<a href="https://medium.com/p/bd94cc88f9c9" target="_blank"><strong>点击查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自动转换与同步技术。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-cn/zmediumtomarkdown/2024-02-16-bd94cc88f9c9.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/simplified-chinese/" class="post-tag no-text-decoration" >simplified-chinese</a> <a href="/tags/cloud-functions/" class="post-tag no-text-decoration" >cloud-functions</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/chatgpt/" class="post-tag no-text-decoration" >chatgpt</a> <a href="/tags/slack/" class="post-tag no-text-decoration" >slack</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E4%B8%8E%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E4%25B8%258E-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E4%B8%8E%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E4%25B8%258E-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fzh-cn%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E4%25B8%258E-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/en/ios-shortcut-automation-auto-forward-sms-create-reminder-tasks-effortlessly-309d0302877b/">iOS Shortcut Automation｜Auto-Forward SMS & Create Reminder Tasks Effortlessly</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/ios-%E6%8D%B7%E5%BE%84%E8%87%AA%E5%8A%A8%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%AE%80%E8%AE%AF%E4%B8%8E%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E6%95%99%E5%AD%A6-309d0302877b/">iOS 捷径自动化应用场景 — 自动转发简讯与自动建立提醒待办事项</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/ios-%E6%8D%B7%E5%BE%91%E8%87%AA%E5%8B%95%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8B%95%E8%BD%89%E7%99%BC%E7%B0%A1%E8%A8%8A%E8%88%87%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E8%BE%A6%E4%BA%8B%E9%A0%85%E6%95%99%E5%AD%B8-309d0302877b/">iOS 捷徑自動化應用場景 — 自動轉發簡訊與自動建立提醒待辦事項</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxing｜Premium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/apple-watch-%E7%B1%B3%E5%85%B0%E8%A1%A8%E5%B8%A6%E5%BC%80%E7%AE%B1-%E5%8E%9F%E5%8E%82%E4%B8%8D%E9%94%88%E9%92%A2%E7%9F%B3%E5%A2%A8%E8%89%B2%E4%BC%98%E7%BC%BA%E7%82%B9%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原厂不锈钢米兰表带开箱</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration</h4><div class="text-muted"><p>自行打造 ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration｜Build Custom OpenAI API Slack App with Google Cloud Functions & Python</h4><div class="text-muted"><p>Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently.</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/python-%E6%90%AD%E9%85%8D-google-cloud-platform-%E4%B8%8E-line-bot-%E6%89%93%E9%80%A0%E6%AF%8F%E6%97%A5%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0%E8%84%9A%E6%9C%AC%E4%B8%8E%E6%8E%92%E7%A8%8B-70a1409b149a/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1613822151" data-df="ll" > Feb 20, 2021 </time><h4 class="pt-0 my-2">Python 搭配 Google Cloud Platform 与 Line Bot｜打造每日自动签到脚本与排程</h4><div class="text-muted"><p>透过 Python 结合 Google Cloud Function、Cloud Scheduler 及 Line Bot，自动完成每日签到任务并即时通知，解决手动操作繁琐问题，提升工作效率并节省时间成本。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/" class="btn btn-outline-primary" aria-label="Older" ><p>Slack & ChatGPT Integration｜Build Custom OpenAI API Slack App with Google Cloud Functions & Python</p></a> <a href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="btn btn-outline-primary" aria-label="Newer" ><p>Slack & ChatGPT Integration</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
