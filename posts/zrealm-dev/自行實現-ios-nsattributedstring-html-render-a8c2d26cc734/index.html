<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="iOS 開發者面對 NSAttributedString HTML 渲染閃退與效能瓶頸，透過 XMLParser 自行打造可擴充的 HTML 解析與渲染機制，解決 iOS 15 以上版本頻繁崩潰問題，提升 5~20 倍渲染速度，確保主線程安全與多樣樣式支援，打造穩定且高效的原生文字渲染體驗。" /><meta property="og:description" content="iOS 開發者面對 NSAttributedString HTML 渲染閃退與效能瓶頸，透過 XMLParser 自行打造可擴充的 HTML 解析與渲染機制，解決 iOS 15 以上版本頻繁崩潰問題，提升 5~20 倍渲染速度，確保主線程安全與多樣樣式支援，打造穩定且高效的原生文字渲染體驗。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-ios-nsattributedstring-html-render-a8c2d26cc734/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-ios-nsattributedstring-html-render-a8c2d26cc734/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-10T00:11:59+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" /><meta property="twitter:title" content="iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-14T10:07:40+08:00","datePublished":"2022-06-10T00:11:59+08:00","description":"iOS 開發者面對 NSAttributedString HTML 渲染閃退與效能瓶頸，透過 XMLParser 自行打造可擴充的 HTML 解析與渲染機制，解決 iOS 15 以上版本頻繁崩潰問題，提升 5~20 倍渲染速度，確保主線程安全與多樣樣式支援，打造穩定且高效的原生文字渲染體驗。","headline":"iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg==","url":"https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-ios-nsattributedstring-html-render-a8c2d26cc734/"},"url":"https://zhgchg.li/posts/zrealm-dev/%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-ios-nsattributedstring-html-render-a8c2d26cc734/"}</script><title>iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染</h1><p class="post-desc fw-light mb-4">iOS 開發者面對 NSAttributedString HTML 渲染閃退與效能瓶頸，透過 XMLParser 自行打造可擴充的 HTML 解析與渲染機制，解決 iOS 15 以上版本頻繁崩潰問題，提升 5~20 倍渲染速度，確保主線程安全與多樣樣式支援，打造穩定且高效的原生文字渲染體驗。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1654791119" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 10, 2022 </time> </span> <span> Updated <time data-ts="1713060460" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 14, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" class="popup img-link preview-img blur"><img data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5670 words" > <em>31 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS NSAttributedString HTML Render 替代方案｜XMLParser 自行實現高效穩定渲染</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><p><br /></p><ul><li>For SEO purposes, <strong>all post titles and descriptions were rewritten by OpenAI</strong>. The original versions are shown below. <a href="/posts/en/a8c2d26cc734/"><strong>Click here</strong></a> to view the English version of this article, translated by OpenAI.</ul><hr /><h3 id="自行實現-ios-nsattributedstring-html-render"><span class="me-2">自行實現 iOS NSAttributedString HTML Render</span><a href="#自行實現-ios-nsattributedstring-html-render" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>iOS NSAttributedString DocumentType.html 的替代方案</p><p><a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" alt="Photo by [Florian Olivo](https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Florian Olivo</a></p><h3 id="tldr-20230312"><span class="me-2">[TL;DR] 2023/03/12</span><a href="#tldr-20230312" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>重新使用其他方式開發了 <em>「 <a href="/posts/zrealm-dev/zmarkupparser-html-string-轉換-nsattributedstring-工具-a5643de271e4/"><strong>ZMarkupParser HTML String 轉換 NSAttributedString 工具</strong></a> 」</em> ，技術細節及開發故事請前往「 <a href="/posts/zrealm-dev/手工打造-html-解析器的那些事-2724f02f6e7/">手工打造 HTML 解析器的那些事</a> 」</p><h3 id="起源"><span class="me-2">起源</span><a href="#起源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>從去年 iOS 15 發佈以來，App 始終被一項 Crash 問題長年霸榜，從數據來看，近 90 天 (2022/03/11~2022/06/08) 一共造成 2.4K+ 次閃退、影響 1.4K+ 位使用者。</p><p><a href="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjM1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>此大量閃退問題從數據上看，官方應該已在 iOS ≥ 15.2 後續的版本修復(或減少發生機率)，數據已呈現趨勢下降。</p></blockquote><p><strong>最大宗受影響版本：</strong> iOS 15.0.X ~ iOS 15.X.X</p><p>另外有發現 iOS 12、iOS 13 也有零星閃退數，所以此問題應該已存在許久，只是 iOS 15 前幾版發生的機率幾乎是 100%。</p><h4 id="閃退原因"><span class="me-2">閃退原因：</span><a href="#閃退原因" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MDkiIGhlaWdodD0iMjIyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;compiler-generated&gt; line 2147483647 specialized @nonobjc NSAttributedString.init(data:options:documentAttributes:)
</pre></table></code></div></div><p>NSAttributedString 在 init 時發生 <code class="language-plaintext highlighter-rouge">Crashed: com.apple.main-thread EXC_BREAKPOINT 0x00000001de9d4e44</code> 閃退問題。</p><blockquote><p>亦有可能是操作的地方不在 Main Thread.</p></blockquote><h4 id="重現方式"><span class="me-2">重現方式：</span><a href="#重現方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>此問題大量橫空出世時，讓開發團隊想破腦袋；複測 Crash Log 上的點都沒問題，不清楚使用者是在什麼情況下發生的；直到有一次因緣巧合下我剛好切換成「省電模式」然後就觸發問題了! ! <strong>WTF ! ! !</strong></p><p><a href="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTIiIGhlaWdodD0iNjg2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="解答"><span class="me-2">解答</span><a href="#解答" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>經過一番搜索發現網路上有許多相同案例，也從 App Developer Forums 找到最早的相同 <a href="https://developer.apple.com/forums/thread/115405" target="_blank">閃退問題提問</a> ，並獲得來自 <strong>官方</strong> 的回答：</p><p><a href="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTIzIiBoZWlnaHQ9IjU1NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li>這是已知的 iOS Foundation Bug：自 iOS 12 就已存在<li>如要渲染複雜的、無使用上約束的 HTML：請使用 WKWebView<li><strong>有渲染約束：可自行撰寫 HTML Parser &amp; Render</strong><li>直接使用 Markdown 做為渲染約束：iOS ≥ 15 NSAttributedString 可 <a href="https://developer.apple.com/documentation/foundation/nsattributedstring/3796598-init" target="_blank">直接使用 Markdown 格式渲染文字</a></ul><blockquote><p><strong>渲染約束</strong> 的意思是限定 App 端能支援的渲染格式，例如只支援 <strong>粗體</strong> 、斜體、 <a href="https://zhgchg.li" target="_blank">超連結</a> 。</p></blockquote><h4 id="補充-渲染複雜的-html--想製作文饒圖效果"><span class="me-2">補充. 渲染複雜的 HTML — 想製作文饒圖效果</span><a href="#補充-渲染複雜的-html--想製作文饒圖效果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>可與後端共同協調ㄧ個介面：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"content"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"第1段純文字"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"第2段純文字"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"第3段純文字"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"第4段純文字"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"image"</span><span class="p">,</span><span class="nl">"src"</span><span class="p">:</span><span class="s2">"https://zhgchg.li/logo.png"</span><span class="p">,</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"ZhgChgLi"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"第5段純文字"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>可與 Markdown 組合加上支援文字渲染，或參考 Medium 做法：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nl">"Paragraph"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code in text, and link in text, and ZhgChgLi, and bold, and I, only i"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"markups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CODE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
        </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://zhgchg.li"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LINK"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"STRONG"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">63</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EM"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">69</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>意思是 <code class="language-plaintext highlighter-rouge">code in text, and link in text, and ZhgChgLi, and bold, and I, only i</code> 這段文字的:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>- 第 5 到第 7 字元要標示為 程式碼 (用`Text`格式包裝)
- 第 18 到第 22 字元要標示為 連結 (用[Text](URL)格式包裝)
- 第 50 到第 63 字元要標示為 粗體(用*Text*格式包裝)
- 第 55 到第 69 字元要標示為 斜體(用_Text_格式包裝)
</pre></table></code></div></div><p>有規範＆可描述的結構後，App 就能自行使用原生方式渲染，達到效能、使用體驗最佳化。</p><blockquote><p>UITextView 做文饒圖的坑，可參考我之前的文章： <a href="/posts/zrealm-dev/ios-uitextview-文繞圖編輯器-swift-e37d66ea1146/">iOS UITextView 文繞圖編輯器 (Swift)</a></p></blockquote><h3 id="why"><span class="me-2">Why?</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在實踐解答之前我們先回歸探究問題本身，個人認為這個問題主因並非來自 Apple，官方的 Bug 只是這個問題的引爆點。</p><p>問題主要來自 <strong>App 端被當成 Web 來進行渲染</strong> ，優點是 Web 開發快速，同個 API Endpoint 可以不用區分 Client 都給 HTML、可以彈性渲染任何想呈現的內容；缺點是 HTML 並非 App 的常見接口、不能期望 App Engineer 懂 HTML、 <strong>效能極差</strong> 、只能在 Main Thread、開發階段無法預期結果、無法確認支援規格。</p><p>再往上找問題，多半是原始需求無法確定、不能確定 App 需要支援哪些規格、為了求快，才導致直接使用 HTML 做為 App 與 Web 的接口。</p><h4 id="效能極差"><span class="me-2"><strong>效能極差</strong></span><a href="#效能極差" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>補充效能部分，實測直接使用 <code class="language-plaintext highlighter-rouge">NSAttributedString DocumentType.html</code> 與自行實現渲染的方式有 5~20 倍的速度差距。</p><h4 id="better"><span class="me-2">Better</span><a href="#better" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>既然是 App 要用，更好的做法要以 App 開發方式為出發點，對 App 來說需求的調整成本比 Web 高很多；有效的 App 開發應該要基於有規格的迭代調整，當下需要確定能支援的規格，之後如果要改我們就安排時間擴充規格，無法快速的想改就改，可以減少溝通成本、增加工作效率。</p><ul><li>確認需求範圍<li>確認支援的規格<li>確認接口規範 (Markdown/BBCode/…要繼續用 HTML 也行，但要是有約束的，例如只用 <code class="language-plaintext highlighter-rouge">&lt;b&gt;/&lt;i&gt;/&lt;a&gt;/&lt;u&gt;</code> ，要在程式 <strong>明確告知</strong> 開發者)<li>自行實現渲染機制<li>維護、迭代支援規格</ul><h3 id="20230227-updated-tldr"><span class="me-2">[2023/02/27 Updated] [TL;DR]:</span><a href="#20230227-updated-tldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>已更新做法，不使用 XMLParser，因容錯率為 0 :</p><p><code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code> 以上三種有可能出現的情境 XMLParser 解析都會出錯直接 Throw Error 顯示空白。 使用 XMLParser，HTML 字串必須完全符合 XML 規則，無法像瀏覽器或 NSAttributedString.DocumentType.html 容錯正常顯示。</p><p><a href="https://medium.com/zrealm-ios-dev/zmarkupparser-html-string-%E8%BD%89%E6%8F%9B-nsattributedstring-%E5%B7%A5%E5%85%B7-a5643de271e4" target="_blank" class="img-link shimmer" ><img src="https://miro.medium.com/v2/resize:fit:1200/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" alt="" loading="lazy"></a></p><p>改使用純 Swift 開發，透過 Regex 剖析出 HTML Tag 並經過 Tokenization，分析修正 Tag 正確性(修正沒有 end 的 tag &amp; 錯位 tag)，再轉換成 abstract syntax tree，最終使用 Visitor Pattern 將 HTML Tag 與抽象樣式對應，得到最終 NSAttributedString 結果；其中不依賴任何 Parser Lib。</p><p>— —</p><h3 id="how"><span class="me-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>木已成舟，回歸正題，目前已用 HTML 在渲染 <code class="language-plaintext highlighter-rouge">NSAttributedString</code> 那我們該如何解決上述的閃退還有效能問題呢？</p><h4 id="inspired-by"><span class="me-2">Inspired by</span><a href="#inspired-by" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/malcommac/SwiftRichString" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/7e71c0eb7d2a88f00a77cb8e0181081b88683ab2d359221336aa9776a4cd097d/malcommac/SwiftRichString" alt="" loading="lazy"></a></p><h3 id="strip-html-去除-html"><span class="me-2">Strip HTML 去除 HTML</span><a href="#strip-html-去除-html" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在談 HTML Render 之前先談 Strip HTML，還是再提一次前文 <code class="language-plaintext highlighter-rouge">Why?</code> 章節所說的，App 哪裡會拿到 HTML、會拿到哪些 HTML 應該要在規格協定好；而不是 App 這邊「 <strong>可能</strong> 」會拿到 HTML，需要 Strip 掉。</p><blockquote><p>套句之前主管的名言：這樣太瘋了吧？</p></blockquote><h4 id="option-1-nsattributedstring"><span class="me-2">Option 1. NSAttributedString</span><a href="#option-1-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Text&lt;/div&gt;"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">unicode</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributed</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nv">documentType</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span> <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span><span class="p">],</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="n">attributed</span><span class="o">.</span><span class="n">string</span>
</pre></table></code></div></div><ul><li>使用 NSAttributedString Render HTML 然後再取 string 出來就會是乾淨的 String 了<li>問題同本章問題，iOS 15 容易閃退、效能不好、只能在 Main Thread 操作</ul><h4 id="option-2-regex"><span class="me-2">Option 2. Regex</span><a href="#option-2-regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">htmlString</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Test&lt;/div&gt;"</span>
<span class="n">htmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;[^&gt;]+&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">regularExpression</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>最簡單有效的方式<li>Regex 並不能保證完全正確 e.g <code class="language-plaintext highlighter-rouge">&lt;p foo="&gt;now what?"&gt;Paragraph&lt;/p&gt;</code> 是合法的 HTML 但會 Strip 錯誤</ul><h4 id="option-3-xmlparser"><span class="me-2">Option 3. XMLParser</span><a href="#option-3-xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>參考 <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> 的做法，使用 Foundation 中的 <strong><a href="https://developer.apple.com/documentation/foundation/xmlparser" target="_blank">XMLParser</a></strong> 將 HTML 做為 XML 解析自行實現 HTML Parser &amp; Strip 功能。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLStripper</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">storedString</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">storedString</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">storedString</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: XMLParserDelegate</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: Support Private Methods</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="n">storedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">currentString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which is not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"我&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;同意&lt;/a&gt;提供&lt;b&gt;&lt;i&gt;個&lt;/i&gt;人&lt;/b&gt;身分證字號／護照／居留&lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;證號碼&lt;/span&gt;，以供&lt;i&gt;跨境物流&lt;/i&gt;方通關&lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;使用&lt;/span&gt;，並已&lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;了解跨境&lt;br/&gt;商品之物&lt;p&gt;流需&lt;/p&gt;求"</span>

<span class="k">let</span> <span class="nv">stripper</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">HTMLStripper</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">stripper</span><span class="o">.</span><span class="nf">parse</span><span class="p">())</span>

<span class="c1">// 我同意提供個人身分證 字號／護照／居留證號碼，以供跨境物流方通關使用，並已了解跨境商品之物流需求</span>
</pre></table></code></div></div><p>使用 Foundation XML Parser 去處理 String，實現 <code class="language-plaintext highlighter-rouge">XMLParserDelegate</code> 用 <code class="language-plaintext highlighter-rouge">currentString</code> 存放 String，因 String 有時會拆成多個 String 所以 <code class="language-plaintext highlighter-rouge">foundCharacters</code> 是有機會被重複呼叫的， <code class="language-plaintext highlighter-rouge">didStartElement</code> 、 <code class="language-plaintext highlighter-rouge">didEndElement</code> 找到字串開始時、結束時，將當前結果存下並清空 <code class="language-plaintext highlighter-rouge">currentString</code> 。</p><ul><li>優點是會連帶轉換 HTML Entity to 實際字元 e.g. <code class="language-plaintext highlighter-rouge">&amp;#103; -&gt; g</code><li>優點是實現複雜、遇到不合規格的 HTML 會 XMLParser 失敗 e.g. <code class="language-plaintext highlighter-rouge">&lt;br&gt; 忘了寫成 &lt;br/&gt;</code></ul><blockquote><p>個人認為單純要 Strip HTML <strong>Option 2. 是比較好的方法</strong> ，會介紹此方法是因為 Render HTML 也是使用相同原理，先用這個做為簡單範例 :)</p></blockquote><h3 id="html-render-wxmlparser"><span class="me-2">HTML Render w/XMLParser</span><a href="#html-render-wxmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>使用 XMLParser 自行實現，同 Strip 原理，我們可以多加上剖析到什麼 Tag 時要做對應的渲染方式。</p><p>需求規格：</p><ul><li>支援擴充想剖析的 Tag<li>支援設定 Tag Default Style e.g &lt;a&gt; Tag 套用連結樣式<li>支援剖析 <code class="language-plaintext highlighter-rouge">style</code> Attributed，因 HTML 會在 <code class="language-plaintext highlighter-rouge">style="color:red"</code> 上去明示要顯示的樣式<li>樣式支援更改文字粗細、大小、底線、行距、字距、背景顏色、字顏色<li>不支援 Image Tag、Table Tag…等較複雜 TAG</ul><blockquote><p>大家可依照自己的規格需求去刪減功能，例如不需支援背景顏色調整，則不需要開出可設定背景顏色的口。</p></blockquote><blockquote><p>本文只是概念實現， <strong>並非架構上的 Best Practice</strong> ；如有明確規格、使用方式，可考慮套用些 Design Pattern 來實現，達成好維護好擴充。</p></blockquote><h3 id="️️️-attention-️️️"><span class="me-2">⚠️⚠️⚠️ Attention ⚠️⚠️⚠️</span><a href="#️️️-attention-️️️" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>再次提醒， <strong>如果你的 App 是全新的或有機會直接全改成 Markdown 格式，建議還是採用以上方式，本篇自行撰寫 Render 太複雜且效能不會比 Markdown 好</strong> 。</p><blockquote><p>即使你是 iOS &lt; 15 不支援原生 Markdown，還是可以在 Github 上找到 <a href="https://github.com/chockenberry/MarkdownAttributedString" target="_blank">大神做好的 Markdown Parser 方案</a> 。</p></blockquote><h4 id="htmltagparser"><span class="me-2">HTMLTagParser</span><a href="#htmltagparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// 宣告想解析的 Tag Name, e.g. a</span>
    <span class="k">var</span> <span class="nv">storedHTMLAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// Attributed 解析結果將存放於此, e.g. href,style</span>
    <span class="k">var</span> <span class="nv">style</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// 此 Tag 想套用的樣式</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="c1">// 實現渲染 HTML to attributedString 的邏輯</span>
<span class="p">}</span>
</pre></table></code></div></div><p>宣告可剖析的 HTML Tag 實體，方便擴充管理。</p><h4 id="attributedstringstyle"><span class="me-2">AttributedStringStyle</span><a href="#attributedstringstyle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">UIFont</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">wordSpacing</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">customs</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// 萬能設定口，建議確定可支援規格後將其抽象出來，並關閉此開口</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// abstract implement</span>
<span class="kd">extension</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">font</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="n">color</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">backgroundColor</span> <span class="o">=</span> <span class="n">backgroundColor</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">wordSpacing</span> <span class="o">=</span> <span class="n">wordSpacing</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">wordSpacing</span> <span class="k">as</span> <span class="kt">Any</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="n">paragraphStyle</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">customAttributes</span> <span class="o">=</span> <span class="n">customs</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">customAttributes</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>宣告 Tag 可供設定的樣式。</p><h4 id="htmlstyleattributedparser"><span class="me-2">HTMLStyleAttributedParser</span><a href="#htmlstyleattributedparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c1">// only support tag attributed down below</span>
<span class="c1">// can set color,font seize,line height,word spacing,background color</span>

<span class="kd">enum</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">color</span> <span class="o">=</span> <span class="s">"color"</span>
    <span class="k">case</span> <span class="n">fontSize</span> <span class="o">=</span> <span class="s">"font-size"</span>
    <span class="k">case</span> <span class="n">lineHeight</span> <span class="o">=</span> <span class="s">"line-height"</span>
    <span class="k">case</span> <span class="n">wordSpacing</span> <span class="o">=</span> <span class="s">"word-spacing"</span>
    <span class="k">case</span> <span class="n">backgroundColor</span> <span class="o">=</span> <span class="s">"background-color"</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">backgroundColor</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">fontSize</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UIFont</span><span class="o">.</span><span class="nf">systemFont</span><span class="p">(</span><span class="nv">ofSize</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)),</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">lineHeight</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="kt">NSMutableParagraphStyle</span><span class="p">()</span>
                <span class="n">paragraphStyle</span><span class="o">.</span><span class="n">lineSpacing</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">wordSpacing</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="c1">// convert 36px -&gt; 36</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">regex</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"^([0-9]+)"</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">firstMatch</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="nf">firstMatch</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">)),</span>
              <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">Range</span><span class="p">(</span><span class="n">firstMatch</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">range</span><span class="p">]))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// convert html hex color #ffffff to UIKit Color</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">_</span> <span class="nv">hexString</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">cString</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cString</span><span class="o">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="s">"#"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cString</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">cString</span><span class="o">.</span><span class="n">startIndex</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cString</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="k">var</span> <span class="nv">rgbValue</span><span class="p">:</span> <span class="kt">UInt64</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kt">Scanner</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">cString</span><span class="p">)</span><span class="o">.</span><span class="nf">scanHexInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgbValue</span><span class="p">)</span>

        <span class="k">return</span> <span class="kt">UIColor</span><span class="p">(</span>
            <span class="nv">red</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0xFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">green</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x00FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">blue</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>實現 Style Attributed Parser 解析 <code class="language-plaintext highlighter-rouge">style="color:red;font-size:16px"</code> 但 CSS Style 有非常多可設定樣式，所以需要列舉可支援範圍。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// setup default style to NSMutableAttributedString</span>
        <span class="n">style</span><span class="p">?</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
        
        <span class="c1">// setup &amp; override HTML style (style="color:red;background-color:black") to NSMutableAttributedString if is exists</span>
        <span class="c1">// any html tag can have style attribute</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">style</span> <span class="o">=</span> <span class="n">storedHTMLAttributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttributed</span> <span class="o">=</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">key</span><span class="p">),</span> <span class="n">styleAttributed</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Unsupport style attributed or value[</span><span class="se">\(</span><span class="n">key</span><span class="se">)</span><span class="s">:</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">]"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>套用 HTMLStyleAttributedParser &amp; HTMLStyleAttributedParser 抽象實現。</p><h4 id="一些-tag-parser--attributedstringstyle-的實現範例"><span class="me-2">一些 Tag Parser &amp; AttributedStringStyle 的實現範例</span><a href="#一些-tag-parser--attributedstringstyle-的實現範例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>struct LinkStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14)
   var color: UIColor? = UIColor.blue
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct ATagParser: HTMLTagParser {
    // &lt;a&gt;&lt;/a&gt;
    static let tag: String = "a"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = LinkStyle()
    
    func render(attributedString: inout NSMutableAttributedString) {
        defaultStyleRender(attributedString: &amp;attributedString)
        if let href = storedHTMLAttributes?["href"], let url = URL(string: href) {
            let range = NSMakeRange(0, attributedString.length)
            attributedString.addAttribute(NSAttributedString.Key.link, value: url, range: range)
        }
    }
}
struct BoldStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14, weight: .bold)
   var color: UIColor? = UIColor.black
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct BoldTagParser: HTMLTagParser {
    // &lt;b&gt;&lt;/b&gt;
    static let tag: String = "b"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = BoldStyle()
}
</pre></table></code></div></div><h4 id="htmltoattributedstringparser-xmlparserdelegate-核心實現"><span class="me-2">HTMLToAttributedStringParser: XMLParserDelegate 核心實現</span><a href="#htmltoattributedstringparser-xmlparserdelegate-核心實現" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
</pre><td class="rouge-code"><pre><span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSMutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">supportedTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span>
    
    <span class="c1">/// Styles applied at each fragment.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">renderingTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">register</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagRender</span><span class="p">:</span> <span class="kt">HTMLTagParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">tagRender</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="p">})</span> <span class="p">{</span>
            <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        
        <span class="c1">// make sure &lt;br/&gt; format is correct XML</span>
        <span class="c1">// because Web may use &lt;br&gt; to present &lt;br/&gt;, but &lt;br&gt; is not a vaild XML</span>
        <span class="n">xmlString</span> <span class="o">=</span> <span class="n">xmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;br&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="n">xmlParser</span>
        
        <span class="n">attributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
        
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Private Method</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">enter</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// elementName = tagName, EX: a,span,div...</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">elementName</span> <span class="p">})</span> <span class="p">{</span>
            <span class="k">var</span> <span class="nv">tagRender</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">tagRender</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="n">attributes</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">exit</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="c1">// currentString != nil ,ex: &lt;i&gt;currentString&lt;/i&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">currentString</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// Render Style</span>
                    <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                    <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// currentString == nil ,ex: &lt;br/&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// Render Style</span>
                <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Helper</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which is not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: XMLParserDelegate</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="nf">enter</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">attributeDict</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">exit</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>套用 Strip 的邏輯，我們可以幫拆好的架構在其中進行組合從 <code class="language-plaintext highlighter-rouge">elementName</code> 知道當前的 Tag 並套用相應的 Tag Parser 及套上定義好的 Style。</p><h4 id="test-result"><span class="me-2">Test Result</span><a href="#test-result" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"我&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;同意&lt;/a&gt;提供&lt;b&gt;&lt;i&gt;個&lt;/i&gt;人&lt;/b&gt;身分證字號／護照／居留&lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;證號碼&lt;/span&gt;，以供&lt;i&gt;跨境物流&lt;/i&gt;方通關&lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;使用&lt;/span&gt;，並已&lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;了解跨境&lt;br/&gt;商品之物&lt;p&gt;流需&lt;/p&gt;求"</span>
<span class="k">let</span> <span class="nv">render</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">DefaultTextStyle</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">ATagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">BoldTagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">SpanTagParser</span><span class="p">())</span>
<span class="c1">//...</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">render</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">))</span>

<span class="c1">// Result:</span>
<span class="c1">// 我{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }同意{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 0 0 1 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSLink = "http://google.com";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }提供{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }個{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Bold 14.00 pt. P [] (0x13a013870) fobj=0x13a013870, spc=3.46\"";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }人身分證字號／護照／居留{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }證號碼{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 1 0 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 20.00 pt. P [] (0x13a015fa0) fobj=0x13a015fa0, spc=4.82\"";</span>
<span class="c1">//     NSKern = 10;</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 10, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }，以供跨境物流方通關{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }使用{</span>
<span class="c1">//     NSBackgroundColor = "UIExtendedSRGBColorSpace 0 1 0 1";</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }，並已了解跨境商品之物流需求{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }</span>
</pre></table></code></div></div><p><strong>顯示結果：</strong></p><p><a href="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NzEiIGhlaWdodD0iNDkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h3 id="done"><span class="me-2">Done!</span><a href="#done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>這樣我們就完成了透過 XMLParser 自行實現 HTML Render 功能，並且保留擴充性跟規格性，可以從 Code 上管理、了解到目前 App 能支援的字串渲染類型。</p><h3 id="完整-github-repo-如下"><span class="me-2">完整 Github Repo 如下</span><a href="#完整-github-repo-如下" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/zhgchgli0718/HTMLToAttributedStringRednerExample" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/c021159c3da82c37ff65d210c7a64aa4e56e398964b824baf4f248bb25bdb805/zhgchgli0718/HTMLToAttributedStringRednerExample" alt="" loading="lazy"></a></p><blockquote><p><em>本文同步發表於個人 Blog： <a href="/posts/zrealm-dev/自行實現-ios-nsattributedstring-html-render-a8c2d26cc734/"><strong>[點我前往]</strong></a> 。</em></p></blockquote><blockquote><p><em>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</em></p></blockquote><hr /><p>本文首次發表於 Medium ➡️ <a href="https://medium.com/p/a8c2d26cc734" target="_blank"><strong>前往查看</strong></a></p><p>由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 與 <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a> 提供自動轉換與同步技術。</p><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2022-06-09-a8c2d26cc734.md" target="_blank">Improve this page on Github.</a></p><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 2,313 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-16 | 1,765 Views on <a href="https://medium.com/p/a8c2d26cc734" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/markdown/" class="post-tag no-text-decoration" >markdown</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20NSAttributedString%20HTML%20Render%20%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%EF%BD%9CXMLParser%20%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E6%B8%B2%E6%9F%93%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2F%25E8%2587%25AA%25E8%25A1%258C%25E5%25AF%25A6%25E7%258F%25BE-ios-nsattributedstring-html-render-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20NSAttributedString%20HTML%20Render%20%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%EF%BD%9CXMLParser%20%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E6%B8%B2%E6%9F%93%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2F%25E8%2587%25AA%25E8%25A1%258C%25E5%25AF%25A6%25E7%258F%25BE-ios-nsattributedstring-html-render-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2F%25E8%2587%25AA%25E8%25A1%258C%25E5%25AF%25A6%25E7%258F%25BE-ios-nsattributedstring-html-render-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2025-%E9%9F%93%E5%9C%8B%E9%87%9C%E5%B1%B1-8-%E5%A4%A9-7-%E5%A4%9C%E8%87%AA%E7%94%B1%E8%A1%8C-8ace34a1a3d8/">遊記 2025 韓國釜山 8 天 7 夜自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-travel-diaries/en/travel-diary-8-days-and-7-nights-in-busan-south-korea-2025-8ace34a1a3d8/">Travel Diary: 8 Days and 7 Nights in Busan, South Korea 2025</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-9-11-%E5%90%8D%E5%8F%A4%E5%B1%8B%E4%B8%80%E6%97%A5%E5%BF%AB%E9%96%83%E8%87%AA%E7%94%B1%E8%A1%8C-7b8a0563c157/">遊記 9/11 名古屋一日快閃自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2023-%E4%B9%9D%E5%B7%9E-10-%E6%97%A5%E8%87%AA%E7%94%B1%E8%A1%8C%E7%8D%A8%E6%97%85-d78e0b15a08a/">遊記 2023 九州 10 日自由行獨旅</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2023-%E4%BA%AC%E9%98%AA%E7%A5%9E-8-%E6%97%A5%E8%87%AA%E7%94%B1%E8%A1%8C-76d66c2e34af/">遊記 2023 京阪神 8 日自由行</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/en/implementing-ios-nsattributedstring-html-rendering-on-your-own-a8c2d26cc734/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654791119" data-df="ll" > Jun 10, 2022 </time><h4 class="pt-0 my-2">Implementing iOS NSAttributedString HTML Rendering on Your Own</h4><div class="text-muted"><p>An alternative to iOS NSAttributedString DocumentType.html</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0-html-%E8%A7%A3%E6%9E%90%E5%99%A8%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">手工打造 HTML 解析器的那些事</h4><div class="text-muted"><p>ZMarkupParser HTML to NSAttributedString 渲染引擎的開發實錄</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/the-journey-of-building-a-custom-html-parser-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">The Journey of Building a Custom HTML Parser</h4><div class="text-muted"><p>A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/implementing-ios-nsattributedstring-html-rendering-on-your-own-a8c2d26cc734/" class="btn btn-outline-primary" aria-label="Older" ><p>Implementing iOS NSAttributedString HTML Rendering on Your Own</p></a> <a href="/posts/zrealm-dev/en/visitor-pattern-in-tableview-60473cb47550/" class="btn btn-outline-primary" aria-label="Newer" ><p>Visitor Pattern in TableView</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-17 15:39:21 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
