<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="針對 iOS App 及現有 API 無法輕易補足單元測試的痛點，透過 Snapshot API Local Mock Server 實現 API Request &amp; Response 錄製與回放，穩定模擬測試環境，降低測試誤報率，提升自動化 E2E 測試可靠度與開發效率。" /><meta property="og:description" content="針對 iOS App 及現有 API 無法輕易補足單元測試的痛點，透過 Snapshot API Local Mock Server 實現 API Request &amp; Response 錄製與回放，穩定模擬測試環境，降低測試誤報率，提升自動化 E2E 測試可靠度與開發效率。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-08-28T22:53:27+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" /><meta property="twitter:title" content="End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2023-09-04T22:32:47+08:00","datePublished":"2023-08-28T22:53:27+08:00","description":"針對 iOS App 及現有 API 無法輕易補足單元測試的痛點，透過 Snapshot API Local Mock Server 實現 API Request &amp; Response 錄製與回放，穩定模擬測試環境，降低測試誤報率，提升自動化 E2E 測試可靠度與開發效率。","headline":"End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/"},"url":"https://zhgchg.li/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/"}</script><title>End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/poc-app-e2e-testing-local-snapshot-api-mock-server-for-reliable-validation-5a5c4b25a83d/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E5%86%B3-ios-app-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%96%99%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98-5a5c4b25a83d/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E6%B1%BA-ios-app-%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C-5a5c4b25a83d/"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"如何在現有無法完整單元測試的 App 架構中實現穩定的 End-to-End 測試？","acceptedAnswer":{"@type":"Answer","text":"透過建立 Snapshot API Local Mock Server，利用 Proxy 技術錄製並重播 API 請求與回應，剝離對實際 API 資料的依賴，讓測試流程更穩定且可重現，避免因資料變動導致測試誤報。"}},{"@type":"Question","name":"如何解決 End-to-End 測試中 API 資料不穩定導致測試失敗的問題？","acceptedAnswer":{"@type":"Answer","text":"透過 Reverse Proxy 代理攔截 API 請求，錄製真實回應並存檔，後續測試可直接從本地 Mock Server 重播回應，確保測試資料一致性，降低因後端資料變動而導致的測試不穩定。"}},{"@type":"Question","name":"如何在 iOS App 中切換到使用本地 Mock Server 進行 End-to-End 測試？","acceptedAnswer":{"@type":"Answer","text":"在 UI Testing 中透過 launchArguments 傳入旗標（如 duringE2ETesting），程式碼判斷後替換 API Host 為本地 Mock Server 地址，達成測試環境與正式環境的切換，且不需大幅修改 App 架構。"}},{"@type":"Question","name":"MITMProxy 如何實現 API 請求與回應的 Record & Replay 功能？","acceptedAnswer":{"@type":"Answer","text":"自訂 mitmproxy 腳本攔截 API 請求，利用 SHA-256 對請求參數做 Hash 以分類存檔回應內容與 Header，Record 模式時保存資料，Replay 模式時根據請求 Hash 回傳本地資料，實現 API Mock Server 功能。"}},{"@type":"Question","name":"如何處理測試中因 API 請求參數（如時間戳）變動導致的 Mock 資料不匹配問題？","acceptedAnswer":{"@type":"Answer","text":"透過配置檔設定忽略特定 API 路徑或全域的 query 及 formData 參數，排除如 timestamp 等不影響測試邏輯的動態參數，確保 Hash 計算一致，避免因參數變動導致 Mock 資料不匹配。"}}]} </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題</h1><p class="post-desc fw-light mb-4">針對 iOS App 及現有 API 無法輕易補足單元測試的痛點，透過 Snapshot API Local Mock Server 實現 API Request & Response 錄製與回放，穩定模擬測試環境，降低測試誤報率，提升自動化 E2E 測試可靠度與開發效率。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1693234407" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 28, 2023 </time> </span> <span> Updated <time data-ts="1693837967" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 4, 2023 </time> </span><div class="mt-3 mb-3"> <a href="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" class="popup img-link preview-img blur"><img data-src="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5135 words" > <em>28 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">End-to-End Testing｜用 Snapshot API Local Mock Server 解決 iOS App 測試資料不穩定問題</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/poc-app-e2e-testing-local-snapshot-api-mock-server-for-reliable-validation-5a5c4b25a83d/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E5%86%B3-ios-app-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%96%99%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98-5a5c4b25a83d/"><strong>点击这里</strong></a>查看本文章简体中文版本。</p></blockquote><blockquote class="prompt-info"><p>基於 SEO 考量，本文標題與描述經 AI 調整，原始版本請參考內文。</p></blockquote><hr /><h3 id="poc-app-end-to-end-testing-local-snapshot-api-mock-server"><span class="me-2">[POC] App End-to-End Testing Local Snapshot API Mock Server</span><a href="#poc-app-end-to-end-testing-local-snapshot-api-mock-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>為現成 App 及現有 API 架構實現 E2E Testing 的可能性驗證</p><p><a href="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*L-FE2o3LRQQZSLZQx96urw.webp" alt="Photo by [freestocks](https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@freestocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">freestocks</a></p><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>作為一個已在線上運作多年的專案，如何持續提升穩定性是一件極具挑戰的問題。</p><h4 id="unit-testing"><span class="me-2">Unit Testing</span><a href="#unit-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*QAuldnLTydk33IgAdkXR-w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iMTY4OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>App 因開發語言 Swift/Kotlin 靜態+編譯+強型別 或 Objective-C to Swift 動態轉靜態，在開發時沒考慮到可測試性把介面依賴切乾淨，後面要補 Unit Testing 幾乎不可能；但在重構的過程也會帶來不穩定因素，會陷入一個雞生蛋蛋生雞問題。</p><h4 id="ui-testing"><span class="me-2">UI Testing</span><a href="#ui-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>對 UI 交互、按鈕測試；新開發或舊有的畫面稍微解耦資料依賴就可以實現。</p><h4 id="snapshot-testing"><span class="me-2">SnapShot Testing</span><a href="#snapshot-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>驗證調整前後的 UI 顯示內容、樣式是否一致；同 UI Testing，新開發或舊有的畫面稍微解耦資料依賴就可以實現。</p><p>用在 Storyboard/XIB 轉 Code Layout or UIView from OC to Swift 很實用；可以直接導入 <a href="https://github.com/pointfreeco" target="_blank">pointfreeco</a> / <a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank">swift-snapshot-testing</a> 快速實現。</p><p><a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b3cc52a5b949767e4cb0af82145ed6474334d3235bd785ee1f7891c6b65fd69a/pointfreeco/swift-snapshot-testing" alt="" loading="lazy"></a></p><p>雖然我們可以後期補上 UI Testing、SnapShot Testing，但能涵蓋的測試範圍很有限；因為多半的錯誤不會是 UI 樣式，而是流程或是邏輯問題，導致使用者中斷操作， <strong>如果出現在結帳流程，牽涉到營收，問題層級就很嚴重</strong> 。</p><h3 id="end-to-end-testing"><span class="me-2">End-to-End Testing</span><a href="#end-to-end-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如前述，無法在現行專案簡易的補上單元測試也無法聚攏單元做整合測試，對於邏輯、流程的防護，還剩下從外部做 End-to-End 黑箱測試的方法，直接以使用者角度出發，操作流程檢查重要的流程(註冊/結帳…)是否正常。</p><blockquote><p>對重大功能的重構也能先建立重構前的流程測試，重構後重新驗證，確保重構後功能如預期。</p></blockquote><blockquote><p>重構中一併補上 Unit Testing、Integration Testing 增加穩定性，打破雞生蛋蛋生雞的問題。</p></blockquote><h4 id="qa-team"><span class="me-2">QA Team</span><a href="#qa-team" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>End-to-End Testing 最直接暴力的方式就是請一組 QA Team 依照 Test Plan 進行手動測試，然後再持續優化或引入自動化操作；計算了一下成本至少需要 2 位工程師 + 1 位 Leader 花費至少半年一年時間才能看到成果。</p><p>評估時間與成本，有沒有什麼是現況我們能做的或是能為未來 QA Team 做好準備，當有 QA Team 時能直接跳到優化與自動化操作甚至導入 AI(?)。</p><h4 id="automation"><span class="me-2">Automation</span><a href="#automation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>現階段以導入自動化 End-to-End Testing 為目標，放在 CI/CD 環節自動檢查，測試內容可以不用太完整、只要能防止重大流程問題就已經很有價值了；後面再慢慢迭代 Test Plan 逐步補齊守備範圍。</p><h3 id="end-to-end-testing-技術難點"><span class="me-2">End-to-End Testing —技術難點</span><a href="#end-to-end-testing-技術難點" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="ui-操作問題"><span class="me-2">UI 操作問題</span><a href="#ui-操作問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>App 的原理比較像是透過另一個測試 App 去操作我們的被測試 App，然後從 View Hierarchy 去找尋目標物件；並且在測試時無法取得被測試 App 的 Log 或 Output，因為本質上就是兩個不同 App。</p><p>iOS 需要完善 View Accessibility Identifier 增加效率與準確性還有要處理 Alert (e.g. 推播請求)。</p><p>Android 在之前的實作上有遇到混用 Compose 與 Fragment 時會找不到目標物件的問題，但據 Teammate 表示，新版的 Compose 已經解決。</p><p>除以上傳統常見問題外，更大的問題是雙平台難以整合(寫一個測試跑兩個平台)；目前我們在嘗試使用新的測試工具 <a href="https://github.com/mobile-dev-inc" target="_blank">mobile-dev-inc</a> / <a href="https://github.com/mobile-dev-inc/maestro" target="_blank">maestro</a> ：</p><p><a href="https://github.com/mobile-dev-inc/maestro" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/d9e6bc8b1cb6b3db5f52dd9bfa04fe2661ed172d7be82155b8f3e4b6c874f821/mobile-dev-inc/maestro" alt="" loading="lazy"></a></p><p>可以用 YAML 寫 Test Plan 然後在雙平台執行測試，細節使用方式、試用心得，靜待另一位 Teammate 的文章分享 cc’ed <a href="https://medium.com/u/1139df7a27f3" target="_blank">Alejandra Ts.</a> 😝。</p><h4 id="api-資料問題"><span class="me-2">API 資料問題</span><a href="#api-資料問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>對於 App E2E Testing 最大的測試變量就是 API 資料，如果無法提供保證確定的資料，會增加測試的不穩定性，導致誤報，最後大家對 Test Plan 也不再有信心了。</p><p>例如測試結帳流程，如果商品有可能被下架或消失，且這些狀態改變不是 App 可控的就很有可能出現以上狀況。</p><p>解決資料問題的方式有很多種，可以建立乾淨的 Staging 或 Testing 環境；或是基於 Open API 的 Auto-Gen Mock API Server；但都需要依賴後端、依賴 API 的外部因素，加上後端 API 同 App 一樣是在線上運作多年的專案，部份規格也還在重構 Migrate 暫時無法有 Mock Server。</p><p>基於以上因素，如果就卡在這，那問題一樣不會改變、雞生蛋蛋生雞問題也無法突破，真的就只能「挺而走險」的直接先改、出問題再說了。</p><h4 id="snapshot-api-local-mock-server"><span class="me-2">Snapshot API Local Mock Server</span><a href="#snapshot-api-local-mock-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p>「只要思想不滑坡，方法總比困難多」</p></blockquote><p>我們可以換一個想法，如果 UI 可以用 Snapshot 快照成圖片下來 Replay 進行驗證測試，那 API 是否也可以？ 我們是否可以把 API Request &amp; Response 存下來，在後續 Replay 進行驗證測試？</p><p><strong>藉此引入本篇文章的重點：建立「Snapshot API Local Mock Server」Record API Request &amp; Replay Response 剝離與 API 資料的依賴。</strong></p><blockquote><p>本文只做了 POC 概念驗證，還沒有真正全面實現高覆蓋率的 End To End Testing，因此做法僅供參考， <strong>希望對大家在現有環境下有新的啟發</strong> 。</p></blockquote><h3 id="snapshot-api-local-mock-server-1"><span class="me-2">Snapshot API Local Mock Server</span><a href="#snapshot-api-local-mock-server-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="核心概念--record--replay-api-data"><span class="me-2">核心概念 — Record &amp; Replay API Data</span><a href="#核心概念--record--replay-api-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>[Record]</strong> — End-to-End Testing Test Case 開發完成後，打開錄製參數，執行一次測試，過程中所有 API Request &amp; Response 會存下來放在各個 Test Case 目錄內。</p><p><strong>[Replay]</strong> — 後面在跑 Test Case 時，依照請求從 Test Case 目錄中找到對應錄製下來的 Response Data，完成測試流程。</p><h4 id="示意圖"><span class="me-2">示意圖</span><a href="#示意圖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>假設我們要測試加入購買流程，使用者打開 App 後在首頁點擊商品卡進入商品詳細頁，按底部購買，跳出登入匡完成登入，完成購買，跳出購買成功提示：</p><p><a href="/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*VtCOkH7iply6RQPs9zxJrw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjExMjAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>UI Testing 如何控制按鈕點擊、輸入匡輸入…等等，不是本文主要研究重點；可參考現有的測試框架直接使用。</p><h4 id="regular-proxy-or-reverse-proxy"><span class="me-2">Regular Proxy or Reverse Proxy</span><a href="#regular-proxy-or-reverse-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>要達成 Record &amp; Replay API 需要在 App 與 API 之間加上 Proxy 做中間人攻擊，可參考我早期的文章「 <a href="/posts/zrealm-dev/app-https%E5%82%B3%E8%BC%B8%E4%BB%8D%E9%81%AD%E7%AB%8A%E5%8F%96-mitmproxy%E4%B8%AD%E9%96%93%E4%BA%BA%E6%94%BB%E6%93%8A%E5%AF%A6%E6%88%B0%E6%95%99%E5%AD%B8%E8%88%87%E9%98%B2%E7%AF%84%E6%8A%80%E5%B7%A7-46410aaada00/">APP有用HTTPS傳輸，但資料還是被偷了。</a> 」</p><p>簡單來說就是在 App 與 API 之間多了一個代理的傳遞者，如同傳紙條一樣，雙方傳遞的請求與回應都會經過他，他可以打開來紙條的內容，也可以偽造紙條內容給彼此，雙方不會察覺你從中做梗。</p><p><strong>正向代理 Regular Proxy：</strong></p><p>正向代理是客戶端向代理伺服器發送請求，代理伺服器再將請求轉發給目標伺服器，並將目標伺服器的回應返回給客戶端。在正向代理模式下，代理伺服器代表客戶端發起請求。客戶端需要明確指定代理伺服器的位址和埠號，並將請求發送給代理伺服器。</p><p><strong>反向代理 Reverse Proxy：</strong></p><p>反向代理與正向代理相反，它位於目標伺服器和客戶端之間。客戶端向反向代理伺服器發送請求，反向代理伺服器根據一定的規則將請求轉發給後端的目標伺服器，並將目標伺服器的回應返回給客戶端。對於客戶端來說，目標伺服器看起來就像是反向代理伺服器，客戶端不需要知道目標伺服器的真實位址。</p><p>對我們的需求來說正向或反向都可以達成目的，唯一要考慮的事是代理設置的方式：</p><p><strong>正向代理需要在電腦上或手機、模擬起的網路設置中掛上 Proxy 代理：</strong></p><ul><li>Android 能在模擬器中個別直接設置 Proxy 代理<li>iOS Simulator 同電腦的網路環境，無法個設置 Proxy，變成要去改電腦的設置才能掛上 Proxy，電腦的所有流量也都會經過這個 Proxy 並且如果同時開啟 Proxyman 或 Charles 等等其他網路工具，有機會會強制更改 Proxy 設置成該軟體的，導致失效。</ul><p><strong>反向代理需要改 Codebase 中的 API Host 並且要宣告要代理的所有 API Domains：</strong></p><ul><li>Codebase 中的 API Host 要在測試時替換成 Proxy Server IP<li>在啟用 Reverse Proxy 時要宣告哪些 Domain 要掛上 Proxy<li>只有宣告的 Domain 才會走 Proxy，沒宣告的會直通出去</ul><blockquote><p>配合 iOS App，以下以 iOS &amp; 使用 Reverse Proxy 反向代理為例做 POC，Android 一樣可以使用。</p></blockquote><h4 id="讓-ios-app-知道現在正在跑-end-to-end-testing"><span class="me-2">讓 iOS App 知道現在正在跑 End-to-End Testing</span><a href="#讓-ios-app-知道現在正在跑-end-to-end-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我們需要讓 App 知道現在正在跑 End-to-End Testing 才能在 App 程式裡加上 API Host 替換邏輯：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>// UI Testing Target:
let app = XCUIApplication()
app.launchArguments = ["duringE2ETesting"]
app.launch()
</pre></table></code></div></div><p>我們在 Network 層做判斷抽換。</p><blockquote><p>這是不得已的調整，盡量還是不要為了測試而去改 App 的 Code。</p></blockquote><h3 id="使用-mitmproxy-實現-reverse-proxy-server"><span class="me-2">使用 MITMProxy 實現 Reverse Proxy Server</span><a href="#使用-mitmproxy-實現-reverse-proxy-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>亦可使用 Swift 自行開發 Swift Server 達成，本文只是 POC 因此直接使用 MITMProxy 工具。</p></blockquote><h4 id="20230904-update-mitmproxy-rodo-已開源"><span class="me-2">[2023–09–04 Update] Mitmproxy-rodo 已開源</span><a href="#20230904-update-mitmproxy-rodo-已開源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>以下實作內容已經開源到 <a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank">mitmproxy-rodo</a> 專案，歡迎直接前往對照使用。</p><p><a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4" alt="" loading="lazy"></a></p><p>部份結構與本文章內容有所調整，開源時後續調整了：</p><ul><li>儲存目錄的結構，改為 <code class="language-plaintext highlighter-rouge">host / requestPath / method / hash</code><li>修正 Header 資訊儲存，應該為 Bytes Data 而非純 JSON String<li>修正部份錯誤<li>增加自動延長 Set-Cookie 時效功能</ul><blockquote><p><strong>⚠️ 以下腳本僅共 Demo 參考，後續腳本調整將移至開源專案維護。</strong></p></blockquote><blockquote><p><strong>⚠️ 以下腳本僅共 Demo 參考，後續腳本調整將移至開源專案維護。</strong></p></blockquote><blockquote><p><strong>⚠️ 以下腳本僅共 Demo 參考，後續腳本調整將移至開源專案維護。</strong></p></blockquote><blockquote><p><strong>⚠️ 以下腳本僅共 Demo 參考，後續腳本調整將移至開源專案維護。</strong></p></blockquote><blockquote><p><strong>⚠️ 以下腳本僅共 Demo 參考，後續腳本調整將移至開源專案維護。</strong></p></blockquote><h4 id="mitmproxy"><span class="me-2"><a href="https://mitmproxy.org" target="_blank">MITMProxy</a></span><a href="#mitmproxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>照著 <a href="https://mitmproxy.org" target="_blank">MITMProxy 官網</a> 完成安裝：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>mitmproxy
</pre></table></code></div></div><p>MITMProxy 細節用法可參考我早期的文章「 <a href="/posts/zrealm-dev/app-https%E5%82%B3%E8%BC%B8%E4%BB%8D%E9%81%AD%E7%AB%8A%E5%8F%96-mitmproxy%E4%B8%AD%E9%96%93%E4%BA%BA%E6%94%BB%E6%93%8A%E5%AF%A6%E6%88%B0%E6%95%99%E5%AD%B8%E8%88%87%E9%98%B2%E7%AF%84%E6%8A%80%E5%B7%A7-46410aaada00/">APP有用HTTPS傳輸，但資料還是被偷了。</a> 」</p><ul><li><code class="language-plaintext highlighter-rouge">mitmproxy</code> 提供一個互動式的命令行界面。<li><code class="language-plaintext highlighter-rouge">mitmweb</code> 提供基於瀏覽器的圖形用戶界面。<li><code class="language-plaintext highlighter-rouge">mitmdump</code> 提供非互動的終端輸出。</ul><h4 id="實現-record--replay"><span class="me-2">實現 Record &amp; Replay</span><a href="#實現-record--replay" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因 MITMProxy Reverse Proxy 原生沒有 Record (or dump) request &amp; Mapping Request Replay 的功能，因此我們需要自行撰寫腳本實現此功能。</p><p><code class="language-plaintext highlighter-rouge">mock.py</code> :</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
</pre><td class="rouge-code"><pre><span class="sh">"""</span><span class="s">
Example:
    Record: mitmdump -m reverse:https://yourapihost.com -s mock.py --set record=true --set dumper_folder=loginFlow --set config_file=config.json
    Replay: mitmdump -m reverse:https://yourapihost.com -s mock.py --set dumper_folder=loginFlow --set config_file=config.json
</span><span class="sh">"""</span>

<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">mimetypes</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">hashlib</span>

<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="n">mitmproxy</span> <span class="kn">import</span> <span class="n">ctx</span>
<span class="kn">from</span> <span class="n">mitmproxy</span> <span class="kn">import</span> <span class="n">http</span>

<span class="k">class</span> <span class="nc">MockServerHandler</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">loader</span><span class="p">.</span><span class="nf">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">dumper_folder</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="sh">"</span><span class="s">dump</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">Response Dump 目錄，可以 by Test Case Name 建立</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="nf">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">network_restricted</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">本地沒有 Mapping 資料...設置 true 會 return 404、false 會去打真實請求拿資料。</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="nf">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">record</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">設置 true 錄製 Request</span><span class="sh">'</span><span class="s">s Response</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loader</span><span class="p">.</span><span class="nf">add_option</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">config_file</span><span class="sh">"</span><span class="p">,</span>
            <span class="n">typespec</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="sh">""</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sh">"</span><span class="s">設置檔案路徑，範例檔案在下面</span><span class="sh">"</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">updated</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">loadConfig</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">loadConfig</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">configFile</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">self</span><span class="p">.</span><span class="n">configuration</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="n">configFile</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">query</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">ignoredQueryParameterByPaths</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ignored</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">paths</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">queryParamters</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ignoredQueryParameterGlobal</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ignored</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">global</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">queryParamters</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filteredQuery</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">filteredQuery</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">query</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignoredQueryParameterByPaths</span> <span class="o">+</span> <span class="n">ignoredQueryParameterGlobal</span><span class="p">]</span>
        
        <span class="n">formData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_content</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_content</span><span class="p">()</span> <span class="o">!=</span> <span class="sa">b</span><span class="sh">''</span><span class="p">:</span>
            <span class="n">formData</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">get_content</span><span class="p">())</span>
        
        <span class="c1"># or just formData = request.urlencoded_form
</span>        <span class="c1"># or just formData = request.multipart_form
</span>        <span class="c1"># depends on your api design
</span>
        <span class="n">ignoredFormDataParametersByPaths</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ignored</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">paths</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">formDataParameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">ignoredFormDataParametersGlobal</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ignored</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">global</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">formDataParameters</span><span class="sh">"</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">filteredFormData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">formData</span><span class="p">:</span>
            <span class="n">filteredFormData</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">formData</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignoredFormDataParametersByPaths</span> <span class="o">+</span> <span class="n">ignoredFormDataParametersGlobal</span><span class="p">]</span>
        
        <span class="c1"># Serialize the dictionary to a JSON string
</span>        <span class="n">hashData</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">query</span><span class="sh">"</span><span class="p">:</span><span class="nf">sorted</span><span class="p">(</span><span class="n">filteredQuery</span><span class="p">),</span> <span class="sh">"</span><span class="s">form</span><span class="sh">"</span><span class="p">:</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">filteredFormData</span><span class="p">)}</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">hashData</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Apply SHA-256 hash function
</span>        <span class="n">hash_object</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="n">json_str</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
        <span class="n">hash_string</span> <span class="o">=</span> <span class="n">hash_object</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">hash_string</span>

    <span class="k">def</span> <span class="nf">readFromFile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">host</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">folder</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">dumper_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">host</span> <span class="o">/</span> <span class="n">method</span> <span class="o">/</span> <span class="n">requestPath</span> <span class="o">/</span> <span class="nb">hash</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="nf">guess_extension</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">.json</span><span class="sh">"</span>


        <span class="n">count</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{})</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Content-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">filepath</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Content-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="sh">"</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">host</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="n">method</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">][</span><span class="n">requestPath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="n">headerFilePath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Header-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">headerFilePath</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
                <span class="n">headerFilePath</span> <span class="o">=</span> <span class="bp">None</span>
            
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">readHistory</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="n">method</span><span class="p">][</span><span class="n">requestPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

            <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span> <span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">:</span> <span class="n">headerFilePath</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">saveToFile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">host</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">hash</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">requestPath</span> <span class="o">=</span> <span class="sh">"</span><span class="s">-</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">path_components</span><span class="p">)</span>

        <span class="n">iterable</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">configuration</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">ignored</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">paths</span><span class="sh">"</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">requestPath</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="p">,</span> <span class="p">{}).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">iterable</span><span class="sh">"</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="n">folder</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">dumper_folder</span><span class="p">)</span> <span class="o">/</span> <span class="n">host</span> <span class="o">/</span> <span class="n">method</span> <span class="o">/</span> <span class="n">requestPath</span> <span class="o">/</span> <span class="nb">hash</span>

        <span class="c1"># create dir if not exists
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">.</span><span class="nf">exists</span><span class="p">():</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">content-type</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">;</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="p">.</span><span class="nf">guess_extension</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span> <span class="ow">or</span> <span class="sh">"</span><span class="s">.json</span><span class="sh">"</span>

        <span class="n">repeatNumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Content-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="sh">"</span>
        <span class="k">while</span> <span class="n">filepath</span><span class="p">.</span><span class="nf">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iterable</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">repeatNumber</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Content-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="sh">"</span>
        
        <span class="c1"># dump to file
</span>        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)</span>
            
        
        <span class="n">headerFilepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Header-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">repeatNumber</span><span class="p">)</span><span class="si">}</span><span class="s">.json</span><span class="sh">"</span>
        <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">headerFilepath</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">responseDict</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">items</span><span class="p">())</span>
            <span class="n">responseDict</span><span class="p">[</span><span class="sh">'</span><span class="s">_status_code</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span>
            <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">responseDict</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span> <span class="sh">"</span><span class="s">header</span><span class="sh">"</span><span class="p">:</span> <span class="n">headerFilepath</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">record</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">host</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">path</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">readFromFile</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">statusCode</span> <span class="o">=</span> <span class="mi">200</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">header</span><span class="sh">'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">headers</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">header</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">())</span>
                    <span class="n">statusCode</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">_status_code</span><span class="sh">'</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">_status_code</span><span class="sh">'</span><span class="p">]</span>

                
                <span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">_responseFromMitmproxy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span>
                <span class="n">flow</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">make</span><span class="p">(</span><span class="n">statusCode</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Fullfill response from local with </span><span class="sh">"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]))</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">network_restricted</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">flow</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">make</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">_responseFromMitmproxy</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">})</span>
        
    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">record</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">_responseFromMitmproxy</span><span class="sh">'</span><span class="p">)</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">saveToFile</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">request</span><span class="p">,</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">)</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Save response to local with </span><span class="sh">"</span><span class="o">+</span><span class="nf">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">content</span><span class="sh">'</span><span class="p">]))</span>

<span class="n">addons</span> <span class="o">=</span> <span class="p">[</span><span class="nc">MockServerHandler</span><span class="p">()]</span>
</pre></table></code></div></div><p>可以自行參考 <a href="https://docs.mitmproxy.org/stable/api/events.html" target="_blank">官方文件</a> ，依照需求調整腳本內容。</p><p><strong>此腳本設計邏輯如下：</strong></p><ul><li>檔案路徑邏輯： <code class="language-plaintext highlighter-rouge">dumper_folder(a.k.a Test Case Name)</code> / <code class="language-plaintext highlighter-rouge">Reverse's api host</code> / <code class="language-plaintext highlighter-rouge">HTTP Method</code> / <code class="language-plaintext highlighter-rouge">Path join with -</code> (e.g. <code class="language-plaintext highlighter-rouge">app/launch</code> -&gt; <code class="language-plaintext highlighter-rouge">app-launch</code> ) / <code class="language-plaintext highlighter-rouge">Hash(Get Query &amp; Post Content)</code> /<li>檔案邏輯：回應的內容： <code class="language-plaintext highlighter-rouge">Content-0.xxx</code> 、 <code class="language-plaintext highlighter-rouge">Content-1.xxx</code> (同個請求打第二次)…以此類推；回應的 Header 資訊： <code class="language-plaintext highlighter-rouge">Header-0.json</code> (同 <code class="language-plaintext highlighter-rouge">Content-x</code> 邏輯)</ul><p><a href="/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*Lud_shSJYv4LSUfpfALGFA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTAiIGhlaWdodD0iMjQxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>儲存時會依照路徑、檔案邏輯依序儲存；在 Replay 時同樣依序取出<li>如果次數不匹配，例如 Replay 時同個路徑打了 3 次，但 Record 儲存的資料只存到第 2 次；則還是會持續回應第 2 次，也就是最後一次的結果<li><code class="language-plaintext highlighter-rouge">record</code> 為 <code class="language-plaintext highlighter-rouge">True</code> 時，會去打目標 Server 取得回應並依照上述邏輯儲存下來； <code class="language-plaintext highlighter-rouge">False</code> 時則只會從本地讀資料 (等於 Replay Mode)<li><code class="language-plaintext highlighter-rouge">network_restricted</code> 為 <code class="language-plaintext highlighter-rouge">False</code> 時，本地沒 Mapping 資料會直接回應 <code class="language-plaintext highlighter-rouge">404</code> ；為 <code class="language-plaintext highlighter-rouge">True</code> 時會去打目標 Server 拿資料。<li><code class="language-plaintext highlighter-rouge">_responseFromMitmproxy</code> 用於告知 Response Method 當前回應來自 Local，可以忽略不管、 <code class="language-plaintext highlighter-rouge">_status_code</code> 借用 Header.json 欄位儲存 HTTP Response 狀態碼。</ul><p><code class="language-plaintext highlighter-rouge">config_file.json</code> <strong>設置檔案邏輯設計如下：</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"ignored"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"yourapihost.com"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"add-to-cart"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"POST"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"queryParamters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"created_timestamp"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"formDataParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"api-status-checker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"GET"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"iterable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"global"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"queryParamters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"timestamp"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"formDataParameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">queryParamters</code> <strong>&amp; <code class="language-plaintext highlighter-rouge">formDataParameters</code> :</strong></p><p>因部分 API 參數可能會隨呼叫改變，例如有的 Endpoint 會帶上時間參數，此時依照 Server 的設計， <code class="language-plaintext highlighter-rouge">Hash(Query Parameter &amp; Body Content)</code> 的值就會在 Replay Request 時不一樣，導致 Mapping 不到 Local Response，因此多開了一個 <code class="language-plaintext highlighter-rouge">config.json</code> 處理這個情況，可以 by Endpoint Path or Global 設定某個參數應該在排除 Hash 時排除，就能取得同樣的 Mapping 結果。</p><p><code class="language-plaintext highlighter-rouge">iterable</code> <strong>:</strong></p><p>因部分輪詢檢查的 API 可能會重複定時不斷呼叫，照 Server 的設計會產出很多 <code class="language-plaintext highlighter-rouge">Content-x.xxx</code> &amp; <code class="language-plaintext highlighter-rouge">Header-x.json</code> 檔案；但假設我們不在意則可設定為 <code class="language-plaintext highlighter-rouge">True</code> ，Response 會持續儲存覆蓋到 <code class="language-plaintext highlighter-rouge">Content-0.xxx</code> &amp; <code class="language-plaintext highlighter-rouge">Header-0.json</code> 第一個檔案內。</p><p><strong>啟用 Reverse Proxy Record Mode：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">record</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>loginFlow <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><p><strong>啟用 Reverse Proxy Replay Mode：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>loginFlow <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h3 id="組裝--proof-of-concept"><span class="me-2">組裝 &amp; Proof Of Concept</span><a href="#組裝--proof-of-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="0-完成-codebase-中-host-的抽換"><span class="me-2">0. 完成 Codebase 中 Host 的抽換</span><a href="#0-完成-codebase-中-host-的抽換" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>並確認在跑測試時，API 已改用 <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080</code></p><h4 id="1-啟動-snapshot-api-local-mock-server-aka-reverse-proxy-server-record-mode"><span class="me-2">1. 啟動 Snapshot API Local Mock Server (a.k.a Reverse Proxy Server) Record Mode</span><a href="#1-啟動-snapshot-api-local-mock-server-aka-reverse-proxy-server-record-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">record</span><span class="o">=</span><span class="nb">true</span> <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>addCart <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h4 id="2-執行-e2e-testing-ui-操作"><span class="me-2">2. 執行 E2E Testing UI 操作</span><a href="#2-執行-e2e-testing-ui-操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>以 <a href="https://apps.apple.com/tw/app/pinkoi-%E4%BA%9E%E6%B4%B2%E9%A0%98%E5%85%88%E8%B7%A8%E5%A2%83%E8%A8%AD%E8%A8%88%E8%B3%BC%E7%89%A9%E7%B6%B2%E7%AB%99/id557252416" target="_blank">Pinkoi iOS App</a> 為例，測試以下流程：</p><blockquote><p>Launch App -&gt; Home -&gt; Scroll Down -&gt; Similar to Wish List Items Section -&gt; First Product -&gt; Click First Product -&gt; Enter Product Page -&gt; Click Add to Cart -&gt; UI Response Added to Cart -&gt; Test Successful ✅</p></blockquote><p><a href="/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*aLaMSaG-DFWzYy9RcwCfag.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ2NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>UI 自動化操作方式前面有提到，這邊先手動測試相同的流程驗證結果。</p><h4 id="3-取得-record-結果"><span class="me-2">3. 取得 Record 結果</span><a href="#3-取得-record-結果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>操作完成後可以下 <code class="language-plaintext highlighter-rouge">^ + C</code> 終止 Snapshot API Mock Server，到檔案目錄查看錄製結果：</p><p><a href="/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*YO957r5CGMOlsPrm26GbcA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NTciIGhlaWdodD0iNTUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="4-replay-驗證同個流程啟動-server--using-replay-mode"><span class="me-2">4. Replay 驗證同個流程，啟動 Server &amp; Using Replay Mode</span><a href="#4-replay-驗證同個流程啟動-server--using-replay-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mitmdump <span class="nt">-m</span> reverse:https://yourapihost.com <span class="nt">-s</span> mock.py <span class="nt">--set</span> <span class="nv">dumper_folder</span><span class="o">=</span>addCart <span class="nt">--set</span> <span class="nv">config_file</span><span class="o">=</span>config.json
</pre></table></code></div></div><h4 id="5-再次執行剛剛的-ui-操作驗證結果"><span class="me-2">5. 再次執行剛剛的 UI 操作驗證結果</span><a href="#5-再次執行剛剛的-ui-操作驗證結果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.webp" class="popup img-link blur"><img data-src="/assets/5a5c4b25a83d/1*70qzxOiM9uJVcvyhKdosVg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDQiIGhlaWdodD0iODkyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>左：Test Successful ✅<li>右：測試點擊錄製以外的商品，此時會出現 Error (因本地沒資料 + <code class="language-plaintext highlighter-rouge">network_restricted</code> 預設是 <code class="language-plaintext highlighter-rouge">False</code> 本地沒資料直接傳 404，不會從網路拿資料)</ul><h4 id="6-proof-of-concept-"><span class="me-2">6. Proof Of Concept ✅</span><a href="#6-proof-of-concept-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>概念驗證通過，我們確實能透過實現 Reverse Proxy Server 來自行儲存 API Request &amp; Response 並作為 Mock API Server 在測試時回應資料給 App 🎉🎉🎉。</p><h3 id="20230904-mitmproxy-rodo-已開源"><span class="me-2">[2023–09–04] mitmproxy-rodo 已開源</span><a href="#20230904-mitmproxy-rodo-已開源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/mitmproxy-rodo/tree/main" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/686628812/44cf2ec7-4de1-4a10-b213-bf7dd30748a4" alt="" loading="lazy"></a></p><h3 id="後續和雜記"><span class="me-2">後續和雜記</span><a href="#後續和雜記" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>本文只探討了概念驗證，後續還有許多地方要補齊也還有更多功能可以實現。</p><ol><li>與 <a href="https://github.com/mobile-dev-inc/maestro" target="_blank">maestro</a> UI Testinga 工具整合<li>CI/CD 流程整合設計 (怎麼自動起 Reverse Proxy? 起在哪裡? )<li>怎麼把 MITMProxy 封裝在開發工具內?<li>驗證更複雜的測試場景<li><strong>針對發送的 Tracking Request 做驗證，需多實現存 Request Body，然後從中取得打了哪些 Tracking Event Data、是否符合流程該送的事件</strong></ol><h4 id="cookie-問題"><span class="me-2">Cookie 問題</span><a href="#cookie-問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">#...
</span>    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="n">setCookies</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">get_all</span><span class="p">(</span><span class="sh">"</span><span class="s">set-cookie</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># setCookies = ['ad=0; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/', 'sessionid=xxxx; Secure; HttpOnly; Domain=.xxx.com; expires=Wed, 23 Aug 2023 04:59:07 GMT; Max-Age=1800; Path=/']
</span>        
        <span class="c1"># OR Replace Cookie Domain From .xxx.com To 127.0.0.1
</span>        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">\s*\.xxx\.com\s*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>

        <span class="c1"># AND 移除安全性相關限制
</span>        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">;\s*Secure\s*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>
        <span class="n">setCookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">;\s*HttpOnly;\s*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setCookies</span><span class="p">]</span>

        <span class="n">flow</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="nf">set_all</span><span class="p">(</span><span class="sh">"</span><span class="s">Set-Cookie</span><span class="sh">"</span><span class="p">,</span> <span class="n">setCookies</span><span class="p">)</span>

        <span class="c1">#...
</span></pre></table></code></div></div><p>如果有遇到 Cookie 方面的問題，例如 API 有回應 Cookie 但 App 沒接到，可參考以上的調整。</p><h4 id="在-pinkoi-的最後一篇文章"><span class="me-2">在 Pinkoi 的最後一篇文章</span><a href="#在-pinkoi-的最後一篇文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在 Pinkoi 900 多天的日子裡，實現了許多我職涯上還有 iOS / App 開發、流程的想像，感謝所有隊友，一起走過疫情、經歷風雨；告別的勇氣如同當初追尋夢想入職的勇氣。</p><blockquote><p><a href="http://resume.zhgchg.li/" target="_blank"><strong>正在啟航找尋新的人生挑戰(包括但不限於工程)，如果您有合適的機會（iOS or 工程管理 or 新創產品）歡迎與我聯絡。</strong></a> 🙏🙏🙏</p></blockquote><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次發表於 Medium (<a href="https://medium.com/p/5a5c4b25a83d" target="_blank"><strong>點此查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2023-08-28-5a5c4b25a83d.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/end-to-end-testing/" class="post-tag no-text-decoration" >end-to-end-testing</a> <a href="/tags/ui-testing/" class="post-tag no-text-decoration" >ui-testing</a> <a href="/tags/automation-testing/" class="post-tag no-text-decoration" >automation-testing</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=End-to-End%20Testing%EF%BD%9C%E7%94%A8%20Snapshot%20API%20Local%20Mock%20Server%20%E8%A7%A3%E6%B1%BA%20iOS%20App%20%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fend-to-end-testing-%25E7%2594%25A8-snapshot-api-local-mock-server-%25E8%25A7%25A3%25E6%25B1%25BA-ios-app-%25E6%25B8%25AC%25E8%25A9%25A6%25E8%25B3%2587%25E6%2596%2599%25E4%25B8%258D%25E7%25A9%25A9%25E5%25AE%259A%25E5%2595%258F%25E9%25A1%258C-5a5c4b25a83d%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=End-to-End%20Testing%EF%BD%9C%E7%94%A8%20Snapshot%20API%20Local%20Mock%20Server%20%E8%A7%A3%E6%B1%BA%20iOS%20App%20%E6%B8%AC%E8%A9%A6%E8%B3%87%E6%96%99%E4%B8%8D%E7%A9%A9%E5%AE%9A%E5%95%8F%E9%A1%8C%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fend-to-end-testing-%25E7%2594%25A8-snapshot-api-local-mock-server-%25E8%25A7%25A3%25E6%25B1%25BA-ios-app-%25E6%25B8%25AC%25E8%25A9%25A6%25E8%25B3%2587%25E6%2596%2599%25E4%25B8%258D%25E7%25A9%25A9%25E5%25AE%259A%25E5%2595%258F%25E9%25A1%258C-5a5c4b25a83d%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fend-to-end-testing-%25E7%2594%25A8-snapshot-api-local-mock-server-%25E8%25A7%25A3%25E6%25B1%25BA-ios-app-%25E6%25B8%25AC%25E8%25A9%25A6%25E8%25B3%2587%25E6%2596%2599%25E4%25B8%258D%25E7%25A9%25A9%25E5%25AE%259A%25E5%2595%258F%25E9%25A1%258C-5a5c4b25a83d%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/en/ios-shortcut-automation-auto-forward-sms-create-reminder-tasks-effortlessly-309d0302877b/">iOS Shortcut Automation｜Auto-Forward SMS & Create Reminder Tasks Effortlessly</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/zh-cn/ios-%E6%8D%B7%E5%BE%84%E8%87%AA%E5%8A%A8%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E7%AE%80%E8%AE%AF%E4%B8%8E%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E5%8A%9E%E4%BA%8B%E9%A1%B9%E6%95%99%E5%AD%A6-309d0302877b/">iOS 捷径自动化应用场景 — 自动转发简讯与自动建立提醒待办事项</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/ios-%E6%8D%B7%E5%BE%91%E8%87%AA%E5%8B%95%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8B%95%E8%BD%89%E7%99%BC%E7%B0%A1%E8%A8%8A%E8%88%87%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E8%BE%A6%E4%BA%8B%E9%A0%85%E6%95%99%E5%AD%B8-309d0302877b/">iOS 捷徑自動化應用場景 — 自動轉發簡訊與自動建立提醒待辦事項</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxing｜Premium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/apple-watch-%E7%B1%B3%E5%85%B0%E8%A1%A8%E5%B8%A6%E5%BC%80%E7%AE%B1-%E5%8E%9F%E5%8E%82%E4%B8%8D%E9%94%88%E9%92%A2%E7%9F%B3%E5%A2%A8%E8%89%B2%E4%BC%98%E7%BC%BA%E7%82%B9%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原厂不锈钢米兰表带开箱</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/zh-cn/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E5%86%B3-ios-app-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%96%99%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98-5a5c4b25a83d/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1693234407" data-df="ll" > Aug 28, 2023 </time><h4 class="pt-0 my-2">End-to-End Testing｜用 Snapshot API Local Mock Server 解决 iOS App 测试资料不稳定问题</h4><div class="text-muted"><p>针对 iOS App 及现有 API 无法轻易补足单元测试的痛点，透过 Snapshot API Local Mock Server 实现 API Request &amp; Response 录制与回放，稳定模拟测试环境，降低测试误报率，提升自动化 E2E 测试可靠度与开发效率。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/poc-app-e2e-testing-local-snapshot-api-mock-server-for-reliable-validation-5a5c4b25a83d/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1693234407" data-df="ll" > Aug 28, 2023 </time><h4 class="pt-0 my-2">POC App E2E Testing｜Local Snapshot API Mock Server for Reliable Validation</h4><div class="text-muted"><p>Developers facing challenges in end-to-end testing for existing apps and APIs can implement a local snapshot API mock server to simulate real interactions, ensuring thorough validation and faster d...</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-robotic-process-automation/ios-%E6%8D%B7%E5%BE%91%E8%87%AA%E5%8B%95%E5%8C%96-3-%E6%8B%9B%E8%87%AA%E5%8B%95%E8%BD%89%E7%99%BC%E7%B0%A1%E8%A8%8A%E8%88%87%E5%BB%BA%E7%AB%8B%E6%8F%90%E9%86%92%E5%BE%85%E8%BE%A6%E4%BA%8B%E9%A0%85%E6%95%99%E5%AD%B8-309d0302877b/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1724083008" data-df="ll" > Aug 19, 2024 </time><h4 class="pt-0 my-2">iOS 捷徑自動化應用場景 — 自動轉發簡訊與自動建立提醒待辦事項</h4><div class="text-muted"><p>iOS 使用 捷徑 Shortcut 簡單幾個步驟自動轉發特定簡訊給家長和自動創建包裹到貨領取與信用卡繳費提醒代辦事項</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/zh-cn/end-to-end-testing-%E7%94%A8-snapshot-api-local-mock-server-%E8%A7%A3%E5%86%B3-ios-app-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%96%99%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98-5a5c4b25a83d/" class="btn btn-outline-primary" aria-label="Older" ><p>End-to-End Testing｜用 Snapshot API Local Mock Server 解决 iOS App 测试资料不稳定问题</p></a> <a href="/posts/travel-journals/en/nagoya-one-day-quick-trip-peach-aviation-flight-experience-and-travel-tips-7b8a0563c157/" class="btn btn-outline-primary" aria-label="Newer" ><p>Nagoya One-Day Quick Trip｜Peach Aviation Flight Experience and Travel Tips</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
