<!doctype html><html lang="zh-tw" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="zh_tw" /><meta name="description" content="針對 iOS 開發者解決裝置唯一識別難題，透過 DeviceCheck API 實現防止多次試用與優惠濫用，教你 Swift 端取得 Token、後端組合 JWT 串接 Apple 伺服器，保障一次性優惠功能穩定執行。" /><meta property="og:description" content="針對 iOS 開發者解決裝置唯一識別難題，透過 DeviceCheck API 實現防止多次試用與優惠濫用，教你 Swift 端取得 Token、後端組合 JWT 串接 Apple 伺服器，保障一次性優惠功能穩定執行。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-04-29T23:30:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" /><meta property="twitter:title" content="iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T15:43:24+08:00","datePublished":"2019-04-29T23:30:01+08:00","description":"針對 iOS 開發者解決裝置唯一識別難題，透過 DeviceCheck API 實現防止多次試用與優惠濫用，教你 Swift 端取得 Token、後端組合 JWT 串接 Apple 伺服器，保障一次性優惠功能穩定執行。","headline":"iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"},"url":"https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"}</script><title>iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/zh.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="https://en.zhgchg.li/posts/zrealm-dev/ios-devicecheck-implement-one-time-offers-and-trials-seamlessly-with-swift-c5e7e580c341/"><link rel="alternate" hreflang="zh-Hans" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AE%9E%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BC%98%E6%83%A0%E4%B8%8E%E8%AF%95%E7%94%A8-swift-%E6%95%99%E5%AD%A6%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"><link rel="alternate" hreflang="zh-Hant" href="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"><link rel="alternate" hreflang="x-default" href="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"如何利用 DeviceCheck API 實現一次性優惠或試用功能，避免使用者重置手機或換帳號重複享受？","acceptedAnswer":{"@type":"Answer","text":"DeviceCheck 提供每個裝置2 bits的雲端儲存空間，可標記裝置是否已使用過優惠或試用，透過 iOS 端產生臨時裝置Token並由後端使用 JWT 驗證向 Apple 伺服器讀寫該標記，確保即使使用者重置手機或換 iCloud 帳號仍無法重複領取優惠。"}},{"@type":"Question","name":"DeviceCheck API 在 iOS 裝置識別上與傳統 UUID 或 IDFV + KeyChain 有何差異？","acceptedAnswer":{"@type":"Answer","text":"傳統 UUID 或 IDFV + KeyChain 在 iCloud 換帳號或重置手機後會重置，無法確保裝置唯一性；DeviceCheck 則由 Apple 伺服器管理 2 bits 雲端標記，可持續追蹤裝置狀態不受帳號變動影響，提升識別穩定度。"}},{"@type":"Question","name":"DeviceCheck API 的兩個 bits 資料能應用在哪些場景？","acceptedAnswer":{"@type":"Answer","text":"兩個 bits 可組合出四種狀態，適用於標記裝置是否已試用、付費或被列為拒絕往來戶等場景，雖然容量有限，但足以實現一次性優惠、試用限制等簡單判斷邏輯。"}},{"@type":"Question","name":"如何在後端安全地使用 DeviceCheck API 與 Apple 伺服器通訊？","acceptedAnswer":{"@type":"Answer","text":"後端需先於 Apple 開發者後台取得 Team ID、Key ID 與 privateKey.p8，使用 ES256 演算法組合 JWT 令牌，並在 HTTP 請求中以 Bearer Token 授權，呼叫 Apple DeviceCheck API 的查詢與更新端點，確保請求安全且合法。"}},{"@type":"Question","name":"是否能在 iOS APP 內直接完成 DeviceCheck 的 JWT 組合與 API 呼叫？","acceptedAnswer":{"@type":"Answer","text":"技術上可以利用第三方套件如 CupertinoJWT 在 APP 內產生 JWT 並呼叫 DeviceCheck API，但因涉及 private key 安全風險，不建議用於正式環境，正式環境仍應由後端負責此流程。"}}]} </script><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:2px"> <a href="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #dc3545;background:#dc3545;color:#fff;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AE%9E%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BC%98%E6%83%A0%E4%B8%8E%E8%AF%95%E7%94%A8-swift-%E6%95%99%E5%AD%A6%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://en.zhgchg.li/posts/zrealm-dev/ios-devicecheck-implement-one-time-offers-and-trials-seamlessly-with-swift-c5e7e580c341/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a></div><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,050+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首頁</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分類</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>標籤</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>歸檔</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>關於我</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>聯絡我</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首頁</a> </span> <span>iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜尋..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析</h1><p class="post-desc fw-light mb-4">針對 iOS 開發者解決裝置唯一識別難題，透過 DeviceCheck API 實現防止多次試用與優惠濫用，教你 Swift 端取得 Token、後端組合 JWT 串接 Apple 伺服器，保障一次性優惠功能穩定執行。</p><div class="post-meta text-muted"> <span> 發佈於 <time data-ts="1556551801" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2019 年 04 月 29 日 </time> </span> <span> 更新於 <time data-ts="1712994204" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024 年 04 月 13 日 </time> </span><div class="mt-3 mb-3"> <a href="/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" class="popup img-link preview-img blur"><img data-src="/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> 作者 <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2396 字" > <em>13 分鐘</em>閱讀</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節目錄 🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS DeviceCheck 實作一次性優惠與試用｜Swift 教學完整流程解析</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><blockquote class="prompt-tip"><p><a href="https://en.zhgchg.li/posts/zrealm-dev/ios-devicecheck-implement-one-time-offers-and-trials-seamlessly-with-swift-c5e7e580c341/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AE%9E%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E4%BC%98%E6%83%A0%E4%B8%8E%E8%AF%95%E7%94%A8-swift-%E6%95%99%E5%AD%A6%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/"><strong>点击这里</strong></a>查看本文章简体中文版本。</p></blockquote><blockquote class="prompt-info"><p>基於 SEO 考量，本文標題與描述經 AI 調整，原始版本請參考內文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目錄</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li><a href="#ios-完美實踐一次性優惠或試用的方法-swift">iOS 完美實踐一次性優惠或試用的方法 (Swift)</a></li><li class="has-children"><details><summary>DeviceCheck 能幹嘛？ <a href="#devicecheck-能幹嘛">#</a></summary><ul><li><a href="#2-bits-能存什麼">2 bits? 能存什麼？</a></li><li><a href="#與原本儲存方式比較">與原本儲存方式比較</a></li><li><a href="#主要運作流程如下">主要運作流程如下</a></li></ul></details></li><li><a href="#devicecheck-的應用">DeviceCheck 的應用</a></li><li class="has-children"><details><summary>開始！ <a href="#開始">#</a></summary><ul><li><a href="#ios-app-端">iOS APP 端</a></li><li><a href="#後端">後端</a></li><li><a href="#1首先登入-開發者後台-記下-team-id">1.首先登入 開發者後台 記下 Team ID</a></li><li><a href="#2-再點側欄的-certificates-ids--profiles-前往憑證管理平台">2. 再點側欄的 Certificates, IDs & Profiles 前往憑證管理平台</a></li><li><a href="#3-依apple規範組合-jwtjson-web-token-格式">3. 依Apple規範組合 JWT(JSON Web Token) 格式</a></li><li><a href="#4-將資料發送給apple伺服器取得回傳結果">4. 將資料發送給Apple伺服器＆取得回傳結果</a></li><li><a href="#5-取得apple伺服器回傳結果">5. 取得Apple伺服器回傳結果</a></li><li><a href="#6-後端api回傳結果給app">6. 後端API回傳結果給APP</a></li></ul></details></li><li class="has-children"><details><summary>後端部分補充 <a href="#後端部分補充">#</a></summary><ul><li><a href="#swift-版示範demo">Swift 版示範Demo</a></li><li><a href="#完整專案下載">完整專案下載</a></li></ul></details></li></ul></nav><hr /><h3 id="ios-完美實踐一次性優惠或試用的方法-swift"><span class="me-2">iOS 完美實踐一次性優惠或試用的方法 (Swift)</span><a href="#ios-完美實踐一次性優惠或試用的方法-swift" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>iOS DeviceCheck 跟著你到天涯海角</p><p>在寫上一篇 <a href="https://zhgchg.li/posts/zrealm-dev/swift-ios%E9%9B%BB%E8%A9%B1%E8%BE%A8%E8%AD%98%E5%AF%A6%E4%BD%9C-call-directory-extension%E9%9B%A2%E7%B7%9A%E8%99%9F%E7%A2%BC%E6%A8%99%E8%A8%98%E5%AE%8C%E6%95%B4%E6%94%BB%E7%95%A5-ac557047d206/">Call Directory Extension</a> 時無意間發現這個冷門的API，雖然已不是什麼新鮮事(WWDC 2017時公布/iOS ≥11支援)、實作方面也非常簡易；但還是小小的研究測試了一下並整理出文章當做個紀錄．</p><h3 id="devicecheck-能幹嘛"><span class="me-2">DeviceCheck 能幹嘛？</span><a href="#devicecheck-能幹嘛" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p><strong>允許開發者針對使用者的裝置進行識別標記</strong></p></blockquote><p>自從 iOS ≥ 6 之後開發者無法取得使用者裝置的唯一識別符(UUID)，折衷的做法是使用IDFV結合KeyChain(詳細可參考之前 <a href="https://zhgchg.li/posts/zrealm-dev/ios-uuid-%E8%A7%A3%E6%9E%90-swift%E8%A3%9D%E7%BD%AE%E5%94%AF%E4%B8%80%E8%AD%98%E5%88%A5%E8%88%87idfv%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88%E5%85%A8%E6%94%BB%E7%95%A5-a4bc3bce7513/">這篇</a> )，但在 iCloud 換帳號或是重置手機…等狀況下，UUID還是會重置；無法保證裝置的唯一性，如果以此作為一些業務邏輯的儲存及判斷，例如：首次免費試用，就可能發生使用者狂換帳號、重置手機，可不斷無限試用的漏洞．</p><p>DeviceCheck 雖然不能讓我們得到保證不會改變的UUID，但他能做到「 <strong>儲存」</strong> 的功能，每個裝置Apple提供2 bits的雲端儲存空間，透過傳送裝置產生的臨時識別Token給Apple，可寫入/讀取那2 bits的資訊。</p><h4 id="2-bits-能存什麼"><span class="me-2">2 bits? 能存什麼？</span><a href="#2-bits-能存什麼" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/c5e7e580c341/1*29HWP-4vlMaMng3O2hJSQw.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*29HWP-4vlMaMng3O2hJSQw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMzEiIGhlaWdodD0iNzUiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>只能組合出4種狀態，能做的功能有限．</p><h4 id="與原本儲存方式比較"><span class="me-2">與原本儲存方式比較：</span><a href="#與原本儲存方式比較" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/c5e7e580c341/1*fhw8C_wb2ehP_xgwMtPmoQ.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*fhw8C_wb2ehP_xgwMtPmoQ.webp" alt="✓ 表示資料還在" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzAiIGhlaWdodD0iOTkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>✓ 表示資料還在</p><p><em>p.s. 這邊小弟犧牲了自已的手機實際做了測試，結果吻合；就算我登出換iCloud、清出所有資料、還原所有設定、回到原廠初始狀態，重新安裝完APP都還是能取到值．</em></p><h4 id="主要運作流程如下"><span class="me-2">主要運作流程如下：</span><a href="#主要運作流程如下" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/c5e7e580c341/1*pB25wJ1uEzzznUfT05gfBw.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*pB25wJ1uEzzznUfT05gfBw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDcxIiBoZWlnaHQ9IjEwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>iOS APP 這邊透過DeviceCheck API產生一組識別裝置用的臨時Token，傳給後端再經由後端組合開發者的private key資訊、開發者資訊成JWT格式後轉傳給Apple伺服器；後端取得Apple回傳結果後處理完格式再丟回iOS APP．</p><h3 id="devicecheck-的應用"><span class="me-2">DeviceCheck 的應用</span><a href="#devicecheck-的應用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>附上 DeviceCheck 在 <a href="https://developer.apple.com/videos/play/wwdc2017/702/" target="_blank">WWDC2017</a> 上的截圖：</p><p><a href="/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*yXSqoDouuL4Jl2sM49iLHA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTUiIGhlaWdodD0iMjkwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>因 <strong>每個裝置只能存2 bits的資訊</strong> ，所以能做的項目差不多就如官方所提及的應用包含裝置是否曾經已試用過、是否付費過、是否是拒絕往來戶…等等；且只能實現一項．</p><p><strong>支援度：</strong> iOS ≥ 11</p><h3 id="開始"><span class="me-2">開始！</span><a href="#開始" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>了解完基本資訊後，讓我們開始動手做吧！</p><h4 id="ios-app-端"><span class="me-2">iOS APP 端：</span><a href="#ios-app-端" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">DeviceCheck</span>
<span class="c1">//....</span>
<span class="c1">//</span>
<span class="kt">DCDevice</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">generateToken</span> <span class="p">{</span> <span class="n">dataOrNil</span><span class="p">,</span> <span class="n">errorOrNil</span> <span class="k">in</span>
  <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">dataOrNil</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
  <span class="k">let</span> <span class="nv">deviceToken</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nf">base64EncodedString</span><span class="p">()</span>
            
   <span class="c1">//...</span>
   <span class="c1">//POST deviceToken 到後端，請後端去跟蘋果伺服器查詢，然後再回傳結果給APP處理</span>
<span class="p">}</span>
</pre></table></code></div></div><p>如流程所述，APP要做的只有取得臨時識別Token（ <strong>deviceToken</strong> ）！</p><p>再來就是將deviceToken發送到後端我們自己的API去處理．</p><h4 id="後端"><span class="me-2">後端：</span><a href="#後端" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>重點在後端處理的部分</p><h4 id="1首先登入-開發者後台-記下-team-id"><span class="me-2">1.首先登入 <a href="https://developer.apple.com/account/#/membership/" target="_blank">開發者後台</a> <strong>記下 Team ID</strong></span><a href="#1首先登入-開發者後台-記下-team-id" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/c5e7e580c341/1*4_DB0CfHmEqt0HO6mDt8mA.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*4_DB0CfHmEqt0HO6mDt8mA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDIwIiBoZWlnaHQ9Ijg2NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="2-再點側欄的-certificates-ids--profiles-前往憑證管理平台"><span class="me-2">2. 再點側欄的 <a href="https://developer.apple.com/account/ios/certificate/" target="_blank">Certificates, IDs &amp; Profiles</a> 前往憑證管理平台</span><a href="#2-再點側欄的-certificates-ids--profiles-前往憑證管理平台" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/c5e7e580c341/1*zoRcWhT9HcwLXWlmui5wNw.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*zoRcWhT9HcwLXWlmui5wNw.webp" alt="選擇「Keys」-&gt; 「All」-&gt; 右上角「+」新增" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjkiIGhlaWdodD0iNDc2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>選擇「Keys」-&gt; 「All」-&gt; 右上角「+」新增</p><p><a href="/assets/c5e7e580c341/1*QgSEmllj-9AjM74tGucUag.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*QgSEmllj-9AjM74tGucUag.webp" alt="Step 1.建立新Key，勾選「DeviceCheck」" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjUiIGhlaWdodD0iOTQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Step 1.建立新Key，勾選「DeviceCheck」</p><p><a href="/assets/c5e7e580c341/1*hC4rOksfkDJzo3TWJMFrXg.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*hC4rOksfkDJzo3TWJMFrXg.webp" alt="Step 2. 「Confirm」確認" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzIiIGhlaWdodD0iODUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Step 2. 「Confirm」確認</p><p><a href="/assets/c5e7e580c341/1*I9TWEmsmEqZA-01OGq52kA.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*I9TWEmsmEqZA-01OGq52kA.webp" alt="Finished." data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjYiIGhlaWdodD0iODQ5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Finished.</p><p>最後一步建立完成後， <strong>記下 Key ID</strong> 及點擊「Download」下載回 privateKey.p8 私鑰檔案．</p><p>這時候你已經準備齊全了所有推播所需資料：</p><ol><li>Team ID<li>Key ID<li>privateKey.p8</ol><h4 id="3-依apple規範組合-jwtjson-web-token-格式"><span class="me-2">3. 依Apple規範組合 <a href="https://yami.io/jwt/" target="_blank">JWT(JSON Web Token)</a> 格式</span><a href="#3-依apple規範組合-jwtjson-web-token-格式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>演算法：</strong> ES256</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="err">//HEADER:</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ES256"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="err">Key</span><span class="w"> </span><span class="err">ID</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">//PAYLOAD:</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="err">Team</span><span class="w"> </span><span class="err">ID</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="err">請求時間戳(Unix</span><span class="w"> </span><span class="err">Timestamp</span><span class="p">,</span><span class="err">EX:</span><span class="mi">1556549164</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="err">逾期時間戳(Unix</span><span class="w"> </span><span class="err">Timestamp</span><span class="p">,</span><span class="err">EX:</span><span class="mi">1557000000</span><span class="err">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">//時間戳務必是整數格式！</span><span class="w">
</span></pre></table></code></div></div><p>取得組合的JWT字串：xxxxxx.xxxxxx.xxxxxx</p><h4 id="4-將資料發送給apple伺服器取得回傳結果"><span class="me-2">4. 將資料發送給Apple伺服器＆取得回傳結果</span><a href="#4-將資料發送給apple伺服器取得回傳結果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>同APNS推播有分開發環境跟正式環境：</strong> 1.開發環境：api.development.devicecheck.apple.com <em>（不知道為什麼我開發環境發送都會回傳失敗）</em> 2.正式環境：api.devicecheck.apple.com</p><p><strong>DeviceCheck API 提供兩個操作：</strong> <strong>1.查詢儲存資料：</strong> https://api.devicecheck.apple.com/v1/query_two_bits</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>//Headers:
Authorization: Bearer xxxxxx.xxxxxx.xxxxxx (組合的JWT字串)

//Content:
device_token:deviceToken (要查詢的裝置Token)
transaction_id:UUID().uuidString (查詢識別符，這裡直接用UUID代表)
timestamp: 請求時間戳（毫秒），注意！這裡是毫秒（EX: 1556549164000）
</pre></table></code></div></div><p><strong>回傳狀態：</strong></p><p><a href="/assets/c5e7e580c341/1*MAa5Z8bK9ppAN6WJxEButg.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*MAa5Z8bK9ppAN6WJxEButg.webp" alt="[官方文件](https://developer.apple.com/documentation/devicecheck/accessing_and_modifying_per-device_data){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTciIGhlaWdodD0iNzU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://developer.apple.com/documentation/devicecheck/accessing_and_modifying_per-device_data" target="_blank">官方文件</a></p><p><strong>回傳內容：</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"bit0"</span><span class="p">:</span><span class="w"> </span><span class="err">Int：</span><span class="mi">2</span><span class="w"> </span><span class="err">bits</span><span class="w"> </span><span class="err">資料中第一位的資料：</span><span class="mi">0</span><span class="err">或</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"bit1"</span><span class="p">:</span><span class="w"> </span><span class="err">Int：</span><span class="mi">2</span><span class="w"> </span><span class="err">bits</span><span class="w"> </span><span class="err">資料中第二位的資料：</span><span class="mi">0</span><span class="err">或</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_update_time"</span><span class="p">:</span><span class="w"> </span><span class="err">String：</span><span class="s2">"最後修改時間 YYYY-MM"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><em>p.s. 你沒看錯，最後修改時間就只能顯示到年-月</em></p><p><strong>2.寫入儲存資料：</strong> https://api.devicecheck.apple.com/v1/update_two_bits</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>//Headers:
Authorization: Bearer xxxxxx.xxxxxx.xxxxxx (組合的JWT字串)

//Content:
device_token:deviceToken (要查詢的裝置Token)
transaction_id:UUID().uuidString (查詢識別符，這裡直接用UUID代表)
timestamp: 請求時間戳（毫秒），注意！這裡是毫秒（EX: 1556549164000）
bit0: 2 bits 資料中第一位的資料：0或1
bit1: 2 bits 資料中第二位的資料：0或1
</pre></table></code></div></div><h4 id="5-取得apple伺服器回傳結果"><span class="me-2">5. 取得Apple伺服器回傳結果</span><a href="#5-取得apple伺服器回傳結果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>回傳狀態：</strong></p><p><a href="/assets/c5e7e580c341/1*MAa5Z8bK9ppAN6WJxEButg.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*MAa5Z8bK9ppAN6WJxEButg.webp" alt="[官方文件](https://developer.apple.com/documentation/devicecheck/accessing_and_modifying_per-device_data){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3NTciIGhlaWdodD0iNzU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://developer.apple.com/documentation/devicecheck/accessing_and_modifying_per-device_data" target="_blank">官方文件</a></p><p><strong>回傳內容：無，回傳狀態 200 即表示寫入成功！</strong></p><h4 id="6-後端api回傳結果給app"><span class="me-2">6. 後端API回傳結果給APP</span><a href="#6-後端api回傳結果給app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>APP在針對相應的狀態做回應就完成了！</p><h3 id="後端部分補充"><span class="me-2">後端部分補充：</span><a href="#後端部分補充" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>這邊太久沒碰PHP了，有興趣請參考 <a href="https://qiita.com/owen/items/85dff1e45083d2805140" target="_blank">iOS11で追加されたDeviceCheckについて</a> 這篇文章的 requestToken.php 部分</p><h4 id="swift-版示範demo"><span class="me-2">Swift 版示範Demo：</span><a href="#swift-版示範demo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因後端部分我無法提供實作且不是大家都會PHP，這邊提供一個用純iOS (Swift) 做的範例，直接在APP裡處理後端該做的那些事(組JWT,發送資料給頻果)，給大家做參考！</p><p>不需撰寫後端程式就能模擬執行所有內容．</p><blockquote><p>⚠請注意 <em>僅為測試示範所需，不建議用於正式環境</em> ⚠</p></blockquote><p>這邊要感謝 <a href="https://medium.com/u/e13f6afcf9b9" target="_blank">Ethan Huang</a> 大大的 <a href="https://github.com/ethanhuang13/CupertinoJWT" target="_blank">CupertinoJWT</a> 提供 iOS 在APP內產生JWT格式內容的支援！</p><p><strong>Demo 主要程式及畫面：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">DeviceCheck</span>
<span class="kd">import</span> <span class="kt">CupertinoJWT</span>

<span class="kd">extension</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">queryEncode</span><span class="p">:</span><span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">addingPercentEncoding</span><span class="p">(</span><span class="nv">withAllowedCharacters</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)?</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"+"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"%2B"</span><span class="p">)</span> <span class="p">??</span> <span class="s">""</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">getBtn</span><span class="p">:</span> <span class="kt">UIButton</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">statusBtn</span><span class="p">:</span> <span class="kt">UIButton</span><span class="o">!</span>
    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">getBtnClick</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">DCDevice</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">generateToken</span> <span class="p">{</span> <span class="n">dataOrNil</span><span class="p">,</span> <span class="n">errorOrNil</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">dataOrNil</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">deviceToken</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nf">base64EncodedString</span><span class="p">()</span>
            
            <span class="c1">//正式情況：</span>
            <span class="c1">//POST deviceToken 到後端，請後端去跟蘋果伺服器查詢，然後再回傳結果給APP處理</span>
            
            
            <span class="c1">//!!!!!!以下僅為測試、示範所需，不建議用於正式環境!!!!!!</span>
            <span class="c1">//!!!!!!      請勿隨意暴露您的PRIVATE KEY    !!!!!!</span>
                <span class="k">let</span> <span class="nv">p8</span> <span class="o">=</span> <span class="s">"""
                    -----BEGIN PRIVATE KEY-----
                    -----END PRIVATE KEY-----
                    """</span>
                <span class="k">let</span> <span class="nv">keyID</span> <span class="o">=</span> <span class="s">""</span> <span class="c1">//你的KEY ID</span>
                <span class="k">let</span> <span class="nv">teamID</span> <span class="o">=</span> <span class="s">""</span> <span class="c1">//你的Developer Team ID :https://developer.apple.com/account/#/membership</span>
            
                <span class="k">let</span> <span class="nv">jwt</span> <span class="o">=</span> <span class="kt">JWT</span><span class="p">(</span><span class="nv">keyID</span><span class="p">:</span> <span class="n">keyID</span><span class="p">,</span> <span class="nv">teamID</span><span class="p">:</span> <span class="n">teamID</span><span class="p">,</span> <span class="nv">issueDate</span><span class="p">:</span> <span class="kt">Date</span><span class="p">(),</span> <span class="nv">expireDuration</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            
                <span class="k">do</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">token</span> <span class="o">=</span> <span class="k">try</span> <span class="n">jwt</span><span class="o">.</span><span class="nf">sign</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">p8</span><span class="p">)</span>
                    <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://api.devicecheck.apple.com/v1/update_two_bits"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">=</span> <span class="s">"POST"</span>
                    <span class="n">request</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"Bearer </span><span class="se">\(</span><span class="n">token</span><span class="se">)</span><span class="s">"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Authorization"</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"application/x-www-form-urlencoded"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Content-Type"</span><span class="p">)</span>
                    <span class="k">let</span> <span class="nv">json</span><span class="p">:[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"device_token"</span><span class="p">:</span><span class="n">deviceToken</span><span class="p">,</span><span class="s">"transaction_id"</span><span class="p">:</span><span class="kt">UUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">,</span><span class="s">"timestamp"</span><span class="p">:</span><span class="kt">Int</span><span class="p">(</span><span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span><span class="o">.</span><span class="nf">rounded</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span><span class="s">"bit0"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="s">"bit1"</span><span class="p">:</span><span class="kc">false</span><span class="p">]</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">httpBody</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">withJSONObject</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
                    
                    <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">return</span>
                        <span class="p">}</span>
                        <span class="nf">print</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span><span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">))</span>
                        <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                            <span class="k">self</span><span class="o">.</span><span class="n">getBtn</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">true</span>
                            <span class="k">self</span><span class="o">.</span><span class="n">statusBtn</span><span class="o">.</span><span class="n">isSelected</span> <span class="o">=</span> <span class="kc">true</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                    <span class="c1">// Handle error</span>
                <span class="p">}</span>
            <span class="c1">//!!!!!!以上僅為測試、示範所需，不建議用於正式環境!!!!!!</span>
            <span class="c1">//</span>
            
        <span class="p">}</span>

    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        
        <span class="kt">DCDevice</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">generateToken</span> <span class="p">{</span> <span class="n">dataOrNil</span><span class="p">,</span> <span class="n">errorOrNil</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">dataOrNil</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">deviceToken</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nf">base64EncodedString</span><span class="p">()</span>
            
            <span class="c1">//正式情況：</span>
                <span class="c1">//POST deviceToken 到後端，請後端去跟蘋果伺服器查詢，然後再回傳結果給APP處理</span>
            
            
            <span class="c1">//!!!!!!以下僅為測試、示範所需，不建議用於正式環境!!!!!!</span>
            <span class="c1">//!!!!!!      請勿隨意暴露您的PRIVATE KEY    !!!!!!</span>
                <span class="k">let</span> <span class="nv">p8</span> <span class="o">=</span> <span class="s">"""
                -----BEGIN PRIVATE KEY-----
                
                -----END PRIVATE KEY-----
                """</span>
                <span class="k">let</span> <span class="nv">keyID</span> <span class="o">=</span> <span class="s">""</span> <span class="c1">//你的KEY ID</span>
                <span class="k">let</span> <span class="nv">teamID</span> <span class="o">=</span> <span class="s">""</span> <span class="c1">//你的Developer Team ID :https://developer.apple.com/account/#/membership</span>
            
                <span class="k">let</span> <span class="nv">jwt</span> <span class="o">=</span> <span class="kt">JWT</span><span class="p">(</span><span class="nv">keyID</span><span class="p">:</span> <span class="n">keyID</span><span class="p">,</span> <span class="nv">teamID</span><span class="p">:</span> <span class="n">teamID</span><span class="p">,</span> <span class="nv">issueDate</span><span class="p">:</span> <span class="kt">Date</span><span class="p">(),</span> <span class="nv">expireDuration</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
            
                <span class="k">do</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">token</span> <span class="o">=</span> <span class="k">try</span> <span class="n">jwt</span><span class="o">.</span><span class="nf">sign</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">p8</span><span class="p">)</span>
                    <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://api.devicecheck.apple.com/v1/query_two_bits"</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">=</span> <span class="s">"POST"</span>
                    <span class="n">request</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"Bearer </span><span class="se">\(</span><span class="n">token</span><span class="se">)</span><span class="s">"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Authorization"</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"application/x-www-form-urlencoded"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Content-Type"</span><span class="p">)</span>
                    <span class="k">let</span> <span class="nv">json</span><span class="p">:[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">"device_token"</span><span class="p">:</span><span class="n">deviceToken</span><span class="p">,</span><span class="s">"transaction_id"</span><span class="p">:</span><span class="kt">UUID</span><span class="p">()</span><span class="o">.</span><span class="n">uuidString</span><span class="p">,</span><span class="s">"timestamp"</span><span class="p">:</span><span class="kt">Int</span><span class="p">(</span><span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span><span class="o">.</span><span class="nf">rounded</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">]</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">httpBody</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">withJSONObject</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>
                    
                    <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span><span class="k">let</span> <span class="nv">json</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">mutableContainers</span><span class="p">)</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span><span class="kt">Any</span><span class="p">],</span><span class="k">let</span> <span class="nv">stauts</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s">"bit0"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">Int</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="k">return</span>
                        <span class="p">}</span>
                        <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">stauts</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
                            <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
                                <span class="k">self</span><span class="o">.</span><span class="n">getBtn</span><span class="o">.</span><span class="n">isHidden</span> <span class="o">=</span> <span class="kc">true</span>
                                <span class="k">self</span><span class="o">.</span><span class="n">statusBtn</span><span class="o">.</span><span class="n">isSelected</span> <span class="o">=</span> <span class="kc">true</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                    <span class="c1">// Handle error</span>
                <span class="p">}</span>
            <span class="c1">//!!!!!!以上僅為測試、示範所需，不建議用於正式環境!!!!!!</span>
            <span class="c1">//</span>
            
        <span class="p">}</span>
        <span class="c1">// Do any additional setup after loading the view.</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></table></code></div></div><p><a href="/assets/c5e7e580c341/1*SwCOuRX_5KD4GsBNfaTQDQ.webp" class="popup img-link blur"><img data-src="/assets/c5e7e580c341/1*SwCOuRX_5KD4GsBNfaTQDQ.webp" alt="畫面截圖" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNzEiIGhlaWdodD0iNzkzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>畫面截圖</p><p>這邊做的是一個一次性的優惠領取，每個裝置只能領一次！</p><h4 id="完整專案下載"><span class="me-2">完整專案下載：</span><a href="#完整專案下載" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/zhgchgli0718/iOSDeviceCheckExample" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/5b9e31058f9022c9102e9f1235cb0d3535b7db18c15a0dc2affda91d0f97507e/zhgchgli0718/iOSDeviceCheckExample" alt="" loading="lazy"></a></p><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zhgchg.li/posts/zrealm-dev/ios-devicecheck-%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8-swift-%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90-c5e7e580c341/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">🔗</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="https://www.paypal.com/ncp/payment/CMALMPT8UUTY2" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">🍺 Buy me a beer on PayPal</a></p><blockquote class="prompt-info"><p>本文首次發表於 Medium (<a href="https://medium.com/p/c5e7e580c341" target="_blank"><strong>點此查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2019-04-29-c5e7e580c341.md" target="_blank">Improve this page on Github.</a></p></blockquote><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,050+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/ios-11/" class="post-tag no-text-decoration" >ios-11</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a> <a href="/tags/mobile-app-development/" class="post-tag no-text-decoration" >mobile-app-development</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者以 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh-hant"> CC BY 4.0 </a> 授權。</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20DeviceCheck%20%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8%EF%BD%9CSwift%20%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-devicecheck-%25E5%25AF%25A6%25E4%25BD%259C%25E4%25B8%2580%25E6%25AC%25A1%25E6%2580%25A7%25E5%2584%25AA%25E6%2583%25A0%25E8%2588%2587%25E8%25A9%25A6%25E7%2594%25A8-swift-%25E6%2595%2599%25E5%25AD%25B8%25E5%25AE%258C%25E6%2595%25B4%25E6%25B5%2581%25E7%25A8%258B%25E8%25A7%25A3%25E6%259E%2590-c5e7e580c341%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20DeviceCheck%20%E5%AF%A6%E4%BD%9C%E4%B8%80%E6%AC%A1%E6%80%A7%E5%84%AA%E6%83%A0%E8%88%87%E8%A9%A6%E7%94%A8%EF%BD%9CSwift%20%E6%95%99%E5%AD%B8%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-devicecheck-%25E5%25AF%25A6%25E4%25BD%259C%25E4%25B8%2580%25E6%25AC%25A1%25E6%2580%25A7%25E5%2584%25AA%25E6%2583%25A0%25E8%2588%2587%25E8%25A9%25A6%25E7%2594%25A8-swift-%25E6%2595%2599%25E5%25AD%25B8%25E5%25AE%258C%25E6%2595%25B4%25E6%25B5%2581%25E7%25A8%258B%25E8%25A7%25A3%25E6%259E%2590-c5e7e580c341%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fios-devicecheck-%25E5%25AF%25A6%25E4%25BD%259C%25E4%25B8%2580%25E6%25AC%25A1%25E6%2580%25A7%25E5%2584%25AA%25E6%2583%25A0%25E8%2588%2587%25E8%25A9%25A6%25E7%2594%25A8-swift-%25E6%2595%2599%25E5%25AD%25B8%25E5%25AE%258C%25E6%2595%25B4%25E6%25B5%2581%25E7%25A8%258B%25E8%25A7%25A3%25E6%259E%2590-c5e7e580c341%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="複製連結" data-title-succeed="連結已成功複製！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/app-store-connect-api-webhook-%E4%B8%B2%E6%8E%A5-%E6%8F%90%E5%8D%87-ios-ci-cd-%E8%87%AA%E5%8B%95%E5%8C%96%E6%95%88%E7%8E%87%E8%88%87%E9%80%9A%E7%9F%A5%E6%B5%81%E7%A8%8B-7c0974856393/">CI/CD 使用 App Store Connect API Webhook 串接自動化工作流程</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD 實戰指南（一）：CI/CD 是什麼？如何透過 CI/CD 打造穩定高效的開發團隊？工具選擇？</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%A8%82%E8%A1%A8%E5%96%AE%E6%8F%90%E5%8D%87%E9%96%8B%E7%99%BC%E6%95%88%E7%8E%87-4cb4437818f2/">使用 Google Apps Script Web App 表單串接 Github Action CI/CD 工作</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-robotic-process-automation/github-action-%E5%85%8D%E8%B2%BB%E9%83%A8%E7%BD%B2-zreviewtender-app-%E5%95%86%E5%9F%8E%E8%A9%95%E5%83%B9%E7%9B%A3%E6%8E%A7%E6%A9%9F%E5%99%A8%E4%BA%BA-%E4%B8%89%E6%AD%A5%E9%A9%9F%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B-0095528cf875/">Quick Start! Github Action x ZReviewTender 免費快速部署你的 App 商城評價監控機器人</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/">iOS Timer 與 DispatchSourceTimer 如何選擇與安全的使用?</a></ul></section><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/cicd/">cicd</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節目錄 🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">延伸閱讀</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/ios-uiviewcontroller-%E8%BD%89%E5%A0%B4%E5%8B%95%E7%95%AB-%E4%B8%8B%E6%8B%89%E9%97%9C%E9%96%89-%E4%B8%8A%E6%8B%89%E6%BC%B8%E5%85%A5%E8%88%87%E5%85%A8%E9%A0%81%E5%8F%B3%E6%BB%91%E8%BF%94%E5%9B%9E%E5%AF%A6%E4%BD%9C%E6%8A%80%E5%B7%A7-14cee137c565/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1578768066" data-df="YYYY 年 M 月 D 日" > 2020 年 01 月 12 日 </time><h4 class="pt-0 my-2">iOS UIViewController 轉場二三事</h4><div class="text-muted"><p>UIViewController 下拉關閉/上拉出現/全頁右滑返回 效果全解</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-uitextview-%E6%96%87%E7%B9%9E%E5%9C%96%E7%B7%A8%E8%BC%AF%E5%99%A8%E9%96%8B%E7%99%BC%E6%94%BB%E7%95%A5-swift-%E5%9C%96%E7%89%87%E6%8F%92%E5%85%A5%E8%88%87%E8%A8%98%E6%86%B6%E9%AB%94%E5%84%AA%E5%8C%96%E5%AF%A6%E6%88%B0-e37d66ea1146/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1539454069" data-df="YYYY 年 M 月 D 日" > 2018 年 10 月 14 日 </time><h4 class="pt-0 my-2">iOS UITextView 文繞圖編輯器開發攻略｜Swift 圖片插入與記憶體優化實戰</h4><div class="text-muted"><p>針對 iOS UITextView 圖片穿插與多圖上傳痛點，分享 Swift 實作文繞圖編輯器的完整解法，包含圖片插入游標定位、上傳失敗處理及記憶體優化技巧，有效避免多圖導致卡頓與閃退，提升 APP 穩定度與使用體驗。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/swift-%E5%8E%9F%E7%94%9F%E9%A1%9E%E5%9E%8B%E6%93%B4%E5%B1%95-%E6%89%93%E9%80%A0-namespace-%E5%AE%B9%E5%99%A8%E9%81%BF%E5%85%8D%E5%91%BD%E5%90%8D%E8%A1%9D%E7%AA%81-%E6%8F%90%E5%8D%87%E6%A8%A1%E7%B5%84%E5%8C%96%E7%B6%AD%E8%AD%B7%E6%80%A7-a8925ad9ed01/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1735740152" data-df="YYYY 年 M 月 D 日" > 2025 年 01 月 01 日 </time><h4 class="pt-0 my-2">Swift 一個優雅的原生類型擴展方式</h4><div class="text-muted"><p>自行封裝擴充方法，使其有 Namespace 的功能</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/swift-ios%E9%9B%BB%E8%A9%B1%E8%BE%A8%E8%AD%98%E5%AF%A6%E4%BD%9C-call-directory-extension%E9%9B%A2%E7%B7%9A%E8%99%9F%E7%A2%BC%E6%A8%99%E8%A8%98%E5%AE%8C%E6%95%B4%E6%94%BB%E7%95%A5-ac557047d206/" class="btn btn-outline-primary" aria-label="上一篇" ><p>Swift iOS電話辨識實作｜Call Directory Extension離線號碼標記完整攻略</p></a> <a href="/posts/zrealm-life/airpods-2-%E9%96%8B%E7%AE%B1-%E7%84%A1%E7%B7%9A%E8%88%87%E6%9C%89%E7%B7%9A%E7%89%88%E6%9C%AC%E5%B7%AE%E7%95%B0-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E5%8F%8A%E9%80%9A%E8%A9%B1%E9%9F%B3%E8%B3%AA%E5%AE%8C%E6%95%B4%E8%A9%95%E6%B8%AC-33afa0ae557d/" class="btn btn-outline-primary" aria-label="下一篇" ><p>AirPods 2 開箱及上手體驗心得</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有註明，本網站上的所有文章皆由作者依據 創用 CC 姓名標示 4.0 國際授權條款（CC BY 4.0）授權使用。" >版權所有。</span> <br/> 最後更新時間:2025-12-29 23:05:27 +08:00</p><p>本站使用 <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> 主題建置於 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>。<br/> Medium 文章由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 轉換而成。</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/cicd/">cicd</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">發現有新的內容版本。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-TW';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOHdowL84CU-q5', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">找不到符合的結果。</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
