<!doctype html><html lang="zh-tw" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="zh_tw" /><meta name="description" content="針對 iOS 音樂串流播放需求，實現 AVPlayer 本地 Cache 功能，避免重複下載同一檔案，降低流量成本；透過自訂 Resource Loader 與 PINCache 管理快取，支援分段 Range 請求與播放不中斷，提升使用體驗與效能。" /><meta property="og:description" content="針對 iOS 音樂串流播放需求，實現 AVPlayer 本地 Cache 功能，避免重複下載同一檔案，降低流量成本；透過自訂 Resource Loader 與 PINCache 管理快取，支援分段 Range 請求與播放不中斷，提升使用體驗與效能。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="twitter:title" content="AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"針對 iOS 音樂串流播放需求，實現 AVPlayer 本地 Cache 功能，避免重複下載同一檔案，降低流量成本；透過自訂 Resource Loader 與 PINCache 管理快取，支援分段 Range 請求與播放不中斷，提升使用體驗與效能。","headline":"AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"},"url":"https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"}</script><title>AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/zh.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/"><link rel="alternate" hreflang="ja" href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/"><link rel="alternate" hreflang="zh-Hans" href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="zh-Hant" href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"><link rel="alternate" hreflang="x-default" href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"如何利用 AVAssetResourceLoaderDelegate 實現 AVPlayer 本地 Cache，減少重複下載音樂檔案？","acceptedAnswer":{"@type":"Answer","text":"透過自訂 Resource Loader 並將 URL Scheme 改成自訂的 cacheable，AVAssetResourceLoaderDelegate 會攔截 AVPlayer 的資料請求，先檢查本地 Cache 是否有對應資料，有則直接回傳，無則透過 URLSession 分段下載並存入本地，達成邊播邊 Cache，避免重複下載音樂檔案，節省流量與成本。"}},{"@type":"Question","name":"AVPlayer 請求資源時如何利用 HTTP Range 範圍請求搭配本地 Cache 優化播放體驗？","acceptedAnswer":{"@type":"Answer","text":"AVPlayer 會先用 GET Range 0-1 請求取得檔案總長度與支援度，接著請求整個檔案，但會在取得足夠資料後取消請求並分段後續請求。利用此機制，自訂 Resource Loader 可判斷並回應本地 Cache 的資料範圍，並對缺少的部分發起網路請求，確保播放流暢且節省流量。"}},{"@type":"Question","name":"使用 PINCache 作為本地 Cache 儲存 AVPlayer 下載的音訊資料有什麼限制及注意事項？","acceptedAnswer":{"@type":"Answer","text":"PINCache 適合用於音訊小檔案（約 10 MB 以下）因為它會將資料載入記憶體，檔案過大容易導致 OOM。且實作時需注意資料合併策略，只合併連續範圍的資料避免播放異常。若是大檔案影片，建議改用 FileHandle 進行 seek、讀寫以避免記憶體溢位。"}},{"@type":"Question","name":"AVQueuePlayer 切換播放項目時，如何確保前一個資源的下載請求能被正確取消？","acceptedAnswer":{"@type":"Answer","text":"AVQueuePlayer 切換播放項目時不會自動取消前一個 AVURLAsset 的下載請求，因此需要在收到播放項目變換通知後，主動呼叫前一個 AVURLAsset 的 cancelLoading() 方法，手動取消正在進行的下載，避免浪費流量與資源。"}},{"@type":"Question","name":"如何在 ResourceLoaderRequest 中正確處理資料請求與檔案資訊請求，並確保資料安全？","acceptedAnswer":{"@type":"Answer","text":"ResourceLoaderRequest 會區分 contentInformation 與 dataRequest 兩種請求，分別向伺服器發起帶 Range 的 HTTP 請求取得檔案資訊或音訊資料。可在取得資料時進行加解密處理（例如使用 CryptoKit 的 ChaChaPoly），並將解密後的資料存入本地 Cache，確保資料安全且符合 AVPlayer 播放需求。"}}]} </script><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item" style="padding:0 15px 0 15px;"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background:#EDF4FF;color:#0A84FF;font-size:15px;transition:background-color .2s,color .2s;" onmouseover="this.style.backgroundColor='#0A84FF';this.style.color='#ffffff';" onmouseout="this.style.backgroundColor='#EDF4FF';this.style.color='#0A84FF';"> <i class="fa-brands fa-medium"></i> <span><span style="font-size: 18px; font-weight: boild;">Follow Me on Medium!</span><br/><u>1,053+</u> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首頁</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分類</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>標籤</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>歸檔</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>關於我</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>聯絡我</span> </a><li class="nav-item"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;"> <a href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #666;background:#111;color:#fff;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a></div><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:center;gap:5px;margin-top:5px;"> <a href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <span style="width:1px;height:18px;background:rgba(0,0,0,.12);"></span> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #ccc;background:#f3f3f3;color:#555;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首頁</a> </span> <span>AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜尋..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量</h1><p class="post-desc fw-light mb-4">針對 iOS 音樂串流播放需求，實現 AVPlayer 本地 Cache 功能，避免重複下載同一檔案，降低流量成本；透過自訂 Resource Loader 與 PINCache 管理快取，支援分段 Range 請求與播放不中斷，提升使用體驗與效能。</p><div class="post-meta text-muted"> <span> 發佈於 <time data-ts="1612089702" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2021 年 01 月 31 日 </time> </span> <span> 更新於 <time data-ts="1712997921" data-df="YYYY 年 M 月 D 日" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2024 年 04 月 13 日 </time> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link preview-img blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> 作者 <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="7218 字" > <em>40 分鐘</em>閱讀</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節目錄 🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AVPlayer 本地 Cache 實作攻略｜使用 AVAssetResourceLoaderDelegate 節省 iOS 音樂串流流量</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><div aria-label="Language switch" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;"><div aria-label="Views" style="display:inline-flex;align-items:center;gap:6px;font-size:.85rem;"> <span style="display:inline-flex;align-items:center;justify-content:center;"> 瀏覽次數: <span style="margin-left:4px;" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-original-title="最後更新時間: 2026-01-19 11:14:12 +08:00"><u>6,177+</u></span> </span></div><div style="display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-wrap:wrap;"> <a href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid #dc3545;background:#dc3545;color:#fff !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 正體中文 </a> <a href="https://zh-hans.zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AE%9E%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E8%8A%82%E7%9C%81-ios-%E9%9F%B3%E4%B9%90%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 简体中文 </a> <a href="https://en.zhgchg.li/posts/zrealm-dev/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> English </a> <a href="https://jp.zhgchg.li/posts/zrealm%E3%81%AE%E9%96%8B%E7%99%BA/avplayer-%E6%9C%AC%E5%9C%B0cache%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-avurlasset%E3%81%A8avassetresourceloaderdelegate%E6%B4%BB%E7%94%A8%E6%B3%95-6ce488898003/" style="display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(220,53,69,.35);background:rgba(220,53,69,.08);color:#dc3545 !important;font-size:12px;font-weight:600;line-height:1;text-decoration:none;"> 日本語 </a></div></div><blockquote class="prompt-info"><p>基於 SEO 考量，本文標題與描述經 AI 調整，原始版本請參考內文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目錄</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>AVPlayer 實踐本地 Cache 功能大全 <a href="#avplayer-實踐本地-cache-功能大全">#</a></summary><ul><li><a href="#20230312-update">[2023/03/12] Update</a></li></ul></details></li><li><a href="#前言">前言</a></li><li><a href="#目標">目標</a></li><li class="has-children"><details><summary>前導知識 (1)— HTTP/1.1 Range 範圍請求、Connection Keep-Alive <a href="#前導知識-1-http11-range-範圍請求connection-keep-alive">#</a></summary><ul><li><a href="#http11-range-範圍請求">HTTP/1.1 Range 範圍請求</a></li><li><a href="#如何應用">如何應用？</a></li><li><a href="#connection-keep-alive">Connection Keep-Alive</a></li><li><a href="#如果發現伺服器不支援-range-keep-alive-">如果發現伺服器不支援 Range、 Keep-Alive ？</a></li></ul></details></li><li class="has-children"><details><summary>前導知識 (2) — AVPlayer 原生是如何處理 AVURLAsset 資源？ <a href="#前導知識-2--avplayer-原生是如何處理-avurlasset-資源">#</a></summary><ul><li><a href="#cancel-發起的時機">Cancel 發起的時機</a></li><li><a href="#avqueue-pre-buffering">AVQueue Pre-buffering</a></li></ul></details></li><li class="has-children"><details><summary>實現 <a href="#實現">#</a></summary><ul><li><a href="#進入自訂的-resource-loader-的時機點">進入自訂的 Resource Loader 的時機點</a></li><li><a href="#avassetresourceloaderdelegate">AVAssetResourceLoaderDelegate</a></li><li><a href="#本地-cache-實現方式">本地 Cache 實現方式</a></li></ul></details></li><li class="has-children"><details><summary>開工！ <a href="#開工">#</a></summary><ul><li><a href="#assetdata">AssetData</a></li><li><a href="#pincacheassetdatamanager">PINCacheAssetDataManager</a></li><li><a href="#cachingavurlasset">CachingAVURLAsset</a></li><li><a href="#resourceloaderrequest">ResourceLoaderRequest</a></li><li><a href="#resourceloader">ResourceLoader</a></li></ul></details></li><li class="has-children"><details><summary>補充及鳴謝 <a href="#補充及鳴謝">#</a></summary><ul><li><a href="#本篇只針對音樂小檔">本篇只針對音樂小檔</a></li><li><a href="#avqueueplayer-切換播放項目時取消正在下載的項目">AVQueuePlayer 切換播放項目時取消正在下載的項目</a></li><li><a href="#音訊資料加解密">音訊資料加解密</a></li><li><a href="#pincache-相關操作">PINCache 相關操作</a></li></ul></details></li><li><a href="#後記">後記</a></li><li><a href="#參考資料">參考資料</a></li><li><a href="#延伸">延伸</a></li></ul></nav><hr /><h3 id="avplayer-實踐本地-cache-功能大全"><span class="me-2">AVPlayer 實踐本地 Cache 功能大全</span><a href="#avplayer-實踐本地-cache-功能大全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AVPlayer/AVQueuePlayer with AVURLAsset 實作 AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>我將之前的實作開源了，有需求的朋友可直接使用。</p><ul><li>客製化 Cache 策略，可以用 PINCache or 其他…<li>外部只需呼叫 make AVAsset 工廠，帶入 URL，則 AVAsset 就能支援 Caching<li>使用 Combine 實現 Data Flow 策略<li>寫了一些測試</ul><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>既上一篇「 <a href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache 實踐方法探究之旅</a> 」後已過了大半年，團隊還是一直想要實現邊播邊 Cache 功能因為對成本的影響極大；我們是音樂串流平台，如果每次播放同樣的歌曲都要重新拿整個檔案，對我們或對非吃到飽的使用者來說都很傷流量，雖然音樂檔案頂多幾 MB，但積沙成塔都是錢！</p><p>另外因為 Android 那邊已經有實作邊播邊 Cache 的功能了，之前有比較過花費，Android 端上線後明顯節省了許多流量；相對更多使用者的 iOS 應該能有更好的節流體現。</p><p>根據 <a href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/">上一篇</a> 的經驗，如果我們要繼續使用 HLS ( .m3u8/.ts) 來達成目的；事情將會變得非常複雜甚至無法達成；我們退而求其次退回去使用 mp3 檔，這樣就能直接使用 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> 進行實作。</p><h3 id="目標"><span class="me-2">目標</span><a href="#目標" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>播放過的音樂會在本地產生 Cache 備份<li>播放音樂時先檢查本地有無 Cache 讀取，有則不再重伺服器要檔案<li>可設 Cache 策略；上限總容量，超過時開始刪除最舊的 Cache 檔案<li>不干涉原本 AVPlayer 播放機制 （不然最快的方法就是自己先用 URLSession 把 mp3 載下來塞給 AVPlayer，但這樣就失去原本能播到哪載到哪的功能，使用者需要等待更長時間＆更消耗流量）</ul><h3 id="前導知識-1-http11-range-範圍請求connection-keep-alive"><span class="me-2">前導知識 (1)— HTTP/1.1 Range 範圍請求、Connection Keep-Alive</span><a href="#前導知識-1-http11-range-範圍請求connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-範圍請求"><span class="me-2">HTTP/1.1 Range 範圍請求</span><a href="#http11-range-範圍請求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>首先我們要先了解在播放影片、音樂時是怎麼跟伺服器要求資料的；一般來說影片、音樂檔案都很大，不可能等到全部拿完才開始播放常見的是播到哪拿到了，只要有正在播放區段的資料就能運作。</p><p>要達到這個功能的方法就是透過 HTTP/1.1 Range 只返回指定資料字節範圍的資料，例如指定 0–100 就只返回 0–100 這 100 bytes 大小的資料；透過這個方法，可以依序分段取得資料，然後再彙整再一起成完整的檔案；這個方法也能運用在檔案下載續傳功能上。</p><h4 id="如何應用"><span class="me-2">如何應用？</span><a href="#如何應用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>我們會先使用 HEAD 去看 Response Header 了解到伺服器是否支援 Range 範圍請求、資源總長度、檔案類型：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>使用 HEAD 我們能從 Response Header 得到以下資訊：</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> 代表伺服器支援 Range 範圍請求 如果沒有 Response 這個值或是是 Accept-Ranges: none 都代表不支援<li><strong>Content-Length:</strong> 資源總長度，我們要知道總長度才能去分段要資料。<li><strong>Content-Type:</strong> 檔案類型，AVPlayer 播放時需要知道的資訊。</ul><p>但有時我們也會使用 GET <code class="language-plaintext highlighter-rouge">Range: bytes=0–1</code> ，意思是我要求 0–1 範圍的資料但實際我根本不 Care 0–1是什麼內容，我只是要看 Response Header 的資訊； <strong>原生 AVPlayer 就是使用 GET 去看，所以本篇也照舊使用</strong> 。</p><blockquote><p><em>但比較建議使用 HEAD 去看，一方法比較正確，另一方面萬一伺服器不支援 Range 功能；用 GET 去摸就會變強迫下載完整檔案。</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–1"</span>
</pre></table></code></div></div><p><strong>使用 GET 我們能從 Response Header 得到以下資訊：</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> 代表伺服器支援 Range 範圍請求 如果沒有 Response 這個值或是是 Accept-Ranges: none 都代表不支援<li><strong>Content-Range: bytes 0–1/資源總長度</strong> ，「/」後的數字及資源總長度，我們要知道總長度才能去分段要資料。<li><strong>Content-Type:</strong> 檔案類型，AVPlayer 播放時需要知道的資訊。</ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>知道伺服器支援 Range 範圍請求後，就能分段發起範圍請求：</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–100"</span>
</pre></table></code></div></div><p><strong>伺服器會返回 206 Partial Content：</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/總長度
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>這時我們就得到 Range 0–100 的 Data，可再繼續發新請求拿 Range 100–200. .200–300…到結束。</p><p>如果拿的 Range 超過資源總長度會返回 416 Range Not Satisfiable。</p><p>另外，想拿完整檔案資料除了可以請求 Range 0-總長度，也可以使用 0- 方式即可：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–"</span>
</pre></table></code></div></div><p>其他還可以同個請求要求多個 Range 資料及下條件式子，但我們用不到，詳情可 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">參考這</a> 。</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>http 1.1 預設是開啟狀態， <strong>此特性能實時取得已下載的資料</strong> ，例如檔案 5 mb，能 16 kb、16 kb、16 kb… 的取得，不用等到 5mb 都好才給你。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keey-Alive
</pre></table></code></div></div><h4 id="如果發現伺服器不支援-range-keep-alive-"><span class="me-2"><strong><em>如果發現伺服器不支援 Range、</em></strong> Keep-Alive <strong><em>？</em></strong></span><a href="#如果發現伺服器不支援-range-keep-alive-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>那也不用搞這麼多了，直接自己用 URLSession 下載完 mp3 檔案塞給播放器就好….但這不是我們要的結果，可以請後端幫忙修改伺服器設定。</em></p></blockquote><h3 id="前導知識-2--avplayer-原生是如何處理-avurlasset-資源"><span class="me-2">前導知識 (2) — AVPlayer 原生是如何處理 AVURLAsset 資源？</span><a href="#前導知識-2--avplayer-原生是如何處理-avurlasset-資源" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY1IiBoZWlnaHQ9Ijc5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>當我們使用 AVURLAsset init with URL 資源並賦予給 AVPlayer/AVQueuePlayer 開始播放之後，同上所述，首先會用 GET Range 0–1 去取得是否支援 Range 範圍請求、資源總長度、檔案類型這三個資訊。</p><p>有了檔案資訊後，會再發起第二次請求，請求從 0-總長度 的資料。</p><blockquote><p><em>⚠️ <strong>AVPlayer 會請求從 0-總長度 的資料，並透過實時取得已下載的資料特性 (</strong> 16 kb、16 kb、16 kb…) <strong>取得到他覺得資料足夠後，會發起 Cancel 取消這個網路請求</strong> （所以實際也不會拿完，除非檔案太小）。</em></p></blockquote><blockquote><p><em>繼續播放後才會透過 Range 往後請求資料。</em></p></blockquote><blockquote><p><em>（這部分跟我之前想的不一樣，我以為會是0–100、100–200. .這樣請求）</em></p></blockquote><p><strong>AVPlayer 請求範例：</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: 總長度 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 kb receive
4. 16 kb receive...
5. cancel() // current offset is 700
6. 繼續播放
7. GET 700-150000...
8. 16 kb receive
9. 16 kb receive...
10. cancel() // current offset is 1500
11. 繼續播放
12. GET 1500-150000...
13. 16 kb receive
14. 16 kb receive...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 kb receive
20. 16 kb receive...
...
</pre></table></code></div></div><blockquote><p><em>⚠️ <strong>iOS ≤12 的情況下，會先發幾個較短的請求試著摸摸看（？然後才會發要求到總長度的請求； iOS ≥ 13 則會直接發要求到總長度的請求。</strong></em></p></blockquote><p>還有個題外的坑，就是在觀察怎麼拿資源的時候，我使用了 <a href="https://zhgchg.li/posts/zrealm-dev/app-https%E5%82%B3%E8%BC%B8%E4%BB%8D%E9%81%AD%E7%AB%8A%E5%8F%96-mitmproxy%E4%B8%AD%E9%96%93%E4%BA%BA%E6%94%BB%E6%93%8A%E5%AF%A6%E6%88%B0%E6%95%99%E5%AD%B8%E8%88%87%E9%98%B2%E7%AF%84%E6%8A%80%E5%B7%A7-46410aaada00/">mitmproxy</a> 工具嗅探，結果發現它顯示有錯，會等到 response 全部回來才會顯示，而不是顯示分段、使用持久連接接續下載；害我嚇了一大跳！以為 iOS 很笨居然每次都要整個檔案回來！下次要用工具時要有保持一點懷疑 Orz</p><h4 id="cancel-發起的時機"><span class="me-2">Cancel 發起的時機</span><a href="#cancel-發起的時機" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>前面說到的第二次請求，請求從 0 開始 到總長度的資源，有足夠 Data 後會發起 Cancel 取消請求。<li>Seek 時會先發起 Cancel 取消先前的請求。</ol><blockquote><p><em>⚠️ 在 AVQueuePlayer 中切換到下一個資源、AVPlayer 更換播放資源時並不會發起 Cancel 取消前一首的請求。</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>其實也是同樣呼叫 Resource Loader 處理，只是他要求的資料範圍會比較小。</p><h3 id="實現"><span class="me-2">實現</span><a href="#實現" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>有了以上前導知識後我們來看實現 AVPlayer 本地 Cache 功能的原理方式。</p><p>就是之前有提到的 <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> ，這個接口讓我們能 <strong>自行實踐 Resource Loader</strong> 給 Asset 用。</p><p>Resource Loader 實際就是個打工仔，播放器是要檔案資訊還是檔案資料，範圍哪裡都哪裡都是他告訴我們，我們去做就是。</p><blockquote><p><em>看到有範例是一個 <strong>Resource Loader 服務所有 AVURLAsset</strong> ，我覺得是錯的，應該要一個 Resource Loader 服務一個 AVURLAsset，跟著 AVURLAsset 的生命週期，他本來就屬於 AVURLAsset。</em></p></blockquote><blockquote><p><em>一個 Resource Loader 服務所有 AVURLAsset 在 AVQueuePlayer 上會變得非常複雜且難以管理。</em></p></blockquote><h4 id="進入自訂的-resource-loader-的時機點"><span class="me-2">進入自訂的 Resource Loader 的時機點</span><a href="#進入自訂的-resource-loader-的時機點" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>要注意的是不是實踐了自己的 Resource Loader 他就會理你，只有當系統無法辨識處理這個資源的時候，才會走你的 Resource Loader。</p><p>所以我們在將 URL 資源給予 AVURLAsset 之前要先將 Scheme 換成我們自訂的 Scheme，不能是 http/https… 這些系統能處理的 Scheme。</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>只有兩個方法需要實現：</strong></p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) -&gt; Bool :</ul><p>此方法問我們能不能處理此資源，return true 能，return false 我們也不處理（unsupported url）。</p><p>我們能從 <code class="language-plaintext highlighter-rouge">loadingRequest</code> 取出要請求什麼（第一次請求檔案資訊還是請求資料，請求資料的話 Range 是多少到多少）；知道請求後我們自行發起請求去拿資料， <strong>在這我們就能決定要發起 URLSession 還是從本地返回 Data</strong> 。</p><p>另外也能在此做 Data 加解密操作，保護原始資料。</p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) :</ul><p>前述說到的 <strong>Cancel 發起時機</strong> 發起 Cancel 時…</p><p>我們可以在這去取消正在請求的 URLSession。</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYwIiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="本地-cache-實現方式"><span class="me-2">本地 Cache 實現方式</span><a href="#本地-cache-實現方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Cache 的部分我直接使用 <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a> ，將 Cache 工作交由他處理，免去我們要處理 Cache 讀寫 DeadLock、清除 Cache LRU 策略 實作上的問題。</p><blockquote><p><strong><em>️️⚠️️️️️️️️️️️OOM警告！</em></strong></p></blockquote><blockquote><p><em>因為這邊是針對音樂做 Cache 檔案大小頂多 10 MB 上下，所以才能使用 PINCache 作為本地 Cache 工具；如果是要服務影片就無法使用此方法（可能一次要載入好幾 GB 的資料到記憶體）</em></p></blockquote><p>有這部分需求可參考大大的做法，用 FileHandle seek read/write 的特性進行處理。</p><h3 id="開工"><span class="me-2">開工！</span><a href="#開工" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>不囉唆，先上完整專案：</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" loading="lazy"></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>本地 Cache 資料物件映射實現 NSCoding，因 PINCache 是依賴 archivedData 方法 encode/decode。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>存放：</strong></p><ul><li><code class="language-plaintext highlighter-rouge">contentInformation</code> : AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code> ： 存放 是否支援 Range 範圍請求(isByteRangeAccessSupported)、資源總長度(contentLength)、檔案類型(contentType)<li><code class="language-plaintext highlighter-rouge">mediaData</code> : 原始音訊 Data <strong>（這邊檔案太大會 OOM）</strong></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>封裝 Data 存入、取出 PINCache 邏輯。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>這邊多抽出 Protocol 因為未來可能使用其他儲存方式替代 PINCache，所以其他程式在使用時是依賴 Protocol 而非 Class 實體。</p><blockquote><p><em>⚠️ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>這個方法極其重要。</strong></em></p></blockquote><p>照線性播放只要一直 append 新 Data 到 Cache Data 中即可，但現實情況複雜得多，使用者可能播了 Range 0~100，直接 Seek 到 Range 200–500 播放；如何將已有的 0-100 Data 與新的 200–500 Data 合併就是一個很大的問題。</p><blockquote><p><em>⚠️Data 合併有問題會出現可怕的播放鬼畜問題….</em></p></blockquote><p>這邊的答案是， <strong>我們不處理非連續資料</strong> ；因為敝專案僅為音訊，檔案也就幾 MB (≤ 10MB) 以考量開發成本就沒做了，我只處理合併連續的資料（例如目前已有 0~100，新資料是 75~200，合併之後變0~200；如果新資料是 150~200，我則會忽略不合併處理）</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijc4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>如果要考慮非連續合併，除了在儲存上要使用其他方法（要有辦法辨識空缺部分）；在 Request 時也要能 Query 出哪段需要發網路請求去拿、哪段是從本地拿；要考量到這情況實作會非常複雜。</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" alt="圖片取自： [iOS AVPlayer 视频缓存的设计与实现](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMjQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>圖片取自： <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer 视频缓存的设计与实现</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset 是 weak 持有 ResourceLoader Delegate，所以這邊建議自己建立一個 AVURLAsset Class 繼承自 AVURLAsset，在內部建立、賦予、持有 ResourceLoader ，讓他跟著 AVURLAsset 的生命週期；另外也可以儲存原始 URL、CacheKey 等資訊…。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>使用：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>其中 <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> 是用來判斷 URL 是否支援掛我們的 Resource Loader（排除 file:// ）。</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> 存放原始資源 URL。</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> 存放這個資源的 Cache Key，這邊直接用檔案名稱當 Cache Key。</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> 請依照現實場景做調整，如果檔案名稱未 hash 可能重複就建議先 hash 後當 key 避免碰撞；如果要 hash 整個 URL 當 key 也要注意 URL 是否會變動 (例如有用 CDN)。</p><p>Hash 可使用 md5…sha. .，iOS ≥ 13 可直接使用 Apple 的 <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a> ，其他就上 Github 找吧！</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>針對 Remote Request 的封裝，主要是服務 ResourceLoader 發起的資料請求。</p><p><code class="language-plaintext highlighter-rouge">RequestType</code> ：用來區分此 Request 是 第一次請求檔案資訊(contentInformation)、還是請求資料(dataRequest)</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code> ：請求 Range 範圍，end 可指定到哪(requestTo(Int64) )或全部(requestToEnd)。</p><p>檔案資訊可由：</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>中取得 Response Header，另外要注意如果要改 HEAD 去摸，不會進這個要用其他方法接。</p><ul><li><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code> ：看 Response Header 中的 <strong>Accept-Ranges == bytes</strong><li><code class="language-plaintext highlighter-rouge">contentType</code> ：播放器要的檔案類型資訊，格式是統一類識別符，不是 audio/mpeg ，而是寫作 public.mp3<li><code class="language-plaintext highlighter-rouge">contentLength</code> ：看 Response Header 中的 <strong>Content-Range</strong> ：bytes 0–1/ <strong>資源總長度</strong></ul><blockquote><p><em>⚠️這邊要注意伺服器給的格式大小寫，不一定是寫作 Accept-Ranges/Content-Range；有的伺服器的格式是小寫 accept-ranges、Accept-ranges…</em></p></blockquote><p><strong>補充：如果要考量大小寫可以寫 HTTPURLResponse Extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="o">||</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>使用：</p><ul><li>contentLength = response.parseContentLengthFromContentRange( )<li>isByteRangeAccessSupported = response.parseAcceptRanges( )<li>contentType = response.mimeTypeUTI( )</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>同前導知識所述，會實時取得已下載的資料，所以這個方法會一直進，片段片段的拿到 Data；我們將他 append 進 <code class="language-plaintext highlighter-rouge">downloadedData</code> 存放。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>任務取消或結束時都會進這個方法，在這將已下載的資料保存下來。</p><p>如前導知識中提到的 Cancel 機制，因播放器在拿到足夠資料後就會發起 Cancel，Cancel Request；所以進到這個方法時實際會是 <code class="language-plaintext highlighter-rouge">error = NSURLErrorCancelled</code> ，因此不管 error 我們有拿到資料都會嘗試存下來。</p><blockquote><p><em>⚠️ 因 URLSession 會用並行方式出去請求資料，所以請保持操作都在DispatchQueue裡，避免資料錯亂(資料錯亂一樣會出現可怕的播放鬼畜)。</em></p></blockquote><blockquote><p><em>️️⚠️URLSession 沒有呼叫 <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> 或 <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code> 兩個方法都會強持有物件導致 Memory Leak；所以不管是取消或是完成我們都要呼叫，這樣才能在任務結束釋放 Request。</em></p></blockquote><blockquote><p><em>️️⚠️️️️️️️️️️️如果怕 <code class="language-plaintext highlighter-rouge">downloadedData</code> OOM，可以在 didReceive Data 中就存入本地。</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                       <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil 則代表是第一次請求，播放器要求先給檔案資訊。</p><p>請求檔案資訊時我們需要賦予這三項資訊：</p><ul><li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code> ：是否支援 Range 拿 Data<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code> ：統一類識別符<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code> ：檔案總長度 Int64</ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> 可取得要求 Range 的起始 offset。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> 可取得要求 Range 的長度。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true 則不管要求 Range 的長度，直接拿到底。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> 返回已載入的 Data 給播放器。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> 可取得當前 data offset， <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> 後 <code class="language-plaintext highlighter-rouge">currentOffset</code> 會跟著推移。</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> 資料都載完了，告知播放器。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>播放器請求資料，我們先看本地 Cache 有無資料，有則返回；若只有部分資料則一樣返回部分，例如我本地有 0–100 ，播放器要求 0–200，則先返回 0–100。</p><p>若沒有本地 Cache、返回的資料不夠，則會發起 ResourceLoaderRequest 請求從網路拿資料。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>播放器取消請求，取消 ResourceLoaderRequest。</p><blockquote><p><em>你可能有發現</em> <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> <em>的 offset 是看 <code class="language-plaintext highlighter-rouge">currentOffset</code> ，因為我們會先從本地 <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> 已下載 Data；所以直接看推移後的 offset 即可。</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>⚠️ requests 有的範例是只用 <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> 來存放，這會有個問題，因為可能當前的 request 正在拿取，使用者又 seek 這時會取消舊的發起新的；但因不一定會照順序發生，可能先走發新請求再走取消；所以用 Dictionary 去存取操作還是比較安全！</em></p></blockquote><blockquote><p><em>⚠️讓所有操作都在同個 DispatchQueue 防止出現資料鬼畜。</em></p></blockquote><p><strong>deinit 時取消所有還在請求的 requests</strong> Resource Loader Deinit 即代表 AVURLAsset Deinit，代表播放器已經不需要這個資源了；所以我們可以 Cancel 還在取資料的 Request，已經載的一樣會寫入 Cache。</p><h3 id="補充及鳴謝"><span class="me-2">補充及鳴謝</span><a href="#補充及鳴謝" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>感謝 <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex 汤</a> 大大指點。</p><p>感謝 <a href="https://medium.com/u/aab116fd9d4d" target="_blank">外孫女</a> 提供開發上的意見及支持。</p><h4 id="本篇只針對音樂小檔"><span class="me-2">本篇只針對音樂小檔</span><a href="#本篇只針對音樂小檔" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>影片大檔案可能會在 downloadedData、AssetData/PINCacheAssetDataManager 發生 Out Of Memory 問題。</p><p>同前述，如果要解決這個問題請使用 fileHandler seek read/wirte 去操作本地 Cache 讀取寫入（取代AssetData/PINCacheAssetDataManager）；或找看看 Github 有沒有大 data write/read to file 的專案可用。</p><h4 id="avqueueplayer-切換播放項目時取消正在下載的項目"><span class="me-2">AVQueuePlayer 切換播放項目時取消正在下載的項目</span><a href="#avqueueplayer-切換播放項目時取消正在下載的項目" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>同前導知識中所述，在更換播放目標時是不會發起 Cancel 的；如果是 AVPlayer 會走 AVURLAsset Deinit 所以下載也會中斷；但 AVQueuePlayer 不會，因為都還在 Queue 裡，只是播放目標換到下一首而已。</p><p>這邊唯一做法就只能接收變換播放目標通知，然後在收到通知後取消上一手的 AVURLAsset loading。</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="音訊資料加解密"><span class="me-2">音訊資料加解密</span><a href="#音訊資料加解密" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>音訊加解密可在 ResourceLoaderRequest 中拿到 Data 進行、還有儲存時能在 AssetData 的 encode/decode 對存在本地的 Data進行加解密。</p><p><strong>CryptoKit SHA 使用範本：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-相關操作"><span class="me-2">PINCache 相關操作</span><a href="#pincache-相關操作" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache 包含 PINMemoryCache 和 PINDiskCache，PINCache 會幫我們處理從檔案讀到 Memory 或從 Memory 寫入檔案的事，我們只需要對 PINCache 進行操作。</p><p>在模擬器中查找 Cache 檔案位置：</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzgiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>使用 <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> 取得模擬器檔案路徑</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Finder -&gt; 前往 -&gt; 貼上路徑</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>在 Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader 就是我們建的 Resource Loader Cache 目錄。</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: “ResourceLoader”)</code> 其中的 name 就是目錄名稱。</p><p>也可以指定 rootPath ，目錄就可以改到 Documents 底下（不怕被系統清掉）。</p><p><strong>設定 PINCache 最大上限：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已複製！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" alt="系統預設上限" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMzYiIGhlaWdodD0iODkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>系統預設上限</p><p>設 0 的話就不會主動刪除檔案。</p><h3 id="後記"><span class="me-2">後記</span><a href="#後記" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>原先太小看這個功能的困難度，以為三兩下就能處理好；結果吃盡苦頭，大概又多花了兩週處理資料儲存的問題，不過也就此徹底了解整個 Resource Loader 運作機制、 GCD 、Data。</p><h3 id="參考資料"><span class="me-2">參考資料</span><a href="#參考資料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>最後附上研究如何實作的參考資料</p><ol><li><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer 视频缓存的设计与实现</a> 僅講原理<li><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">基于AVPlayer实现音视频播放和缓存，支持视频画面的同步输出</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] 有附程式（很完整，但很複雜）<li><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> （簡易實現，較好懂但不完整）<li><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">可能是目前最好的 AVPlayer 音视频缓存方案 AVAssetResourceLoaderDelegate</a><li><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">仿抖音 Swift 版</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ]（蠻有意思的專案，復刻抖音 APP；裡面也有用到 Resource Loader）<li><a href="https://zhgchg.li/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/">iOS HLS Cache 實踐方法探究之旅</a></ol><h3 id="延伸"><span class="me-2">延伸</span><a href="#延伸" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C 版)</ul><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zhgchg.li/posts/6ce488898003/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">🔗</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="/contact" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">🍺 Buy me a beer on PayPal</a></p><blockquote class="prompt-tip"><p>👉👉👉 <a href="https://medium.com/@zhgchgli" target="_blank"><strong>Follow Me On Medium!</strong> (1,053+ Followers)</a> 👈👈👈</p></blockquote><blockquote class="prompt-info"><p>本文首次發表於 Medium (<a href="https://medium.com/p/6ce488898003" target="_blank"><strong>點此查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2021-01-31-6ce488898003.md" target="_blank">Improve this page on Github.</a></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者以 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh-hant"> CC BY 4.0 </a> 授權。</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E7%AF%80%E7%9C%81%20iOS%20%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2F6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E7%AF%80%E7%9C%81%20iOS%20%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2F6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2F6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="複製連結" data-title-succeed="連結已成功複製！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E5%B1%B1%E9%99%BD-%E5%B1%B1%E9%99%B0%E6%97%85%E9%81%8A%E5%85%A8%E6%94%BB%E7%95%A5-%E5%BB%A3%E5%B3%B6-%E5%B2%A1%E5%B1%B1%E6%99%AF%E9%BB%9E%E8%88%87%E4%BA%BA%E6%96%87%E6%AD%B7%E5%8F%B2%E4%B8%80%E6%AC%A1%E6%90%9E%E6%87%82-%E5%90%AB%E4%BA%A4%E9%80%9A-%E8%A1%8C%E7%A8%8B%E8%88%87%E6%8E%A5%E5%B1%B1%E9%99%B0%E7%8E%A9%E6%B3%95-sanin/">山陽×山陰旅遊全攻略：廣島、岡山景點與人文歷史一次搞懂（含交通、行程與接山陰玩法）</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/2026-%E7%86%B1%E6%B5%B7%E5%A4%8F%E5%AD%A3%E8%8A%B1%E7%81%AB%E5%A4%A7%E6%9C%83%E5%AE%8C%E5%85%A8%E6%94%BB%E7%95%A5-%E8%A7%80%E8%B3%9E%E5%9C%B0%E9%BB%9E-%E4%BA%A4%E9%80%9A-%E7%BE%8E%E9%A3%9F-%E4%BD%8F%E5%AE%BF-%E9%99%84%E8%BF%91%E6%99%AF%E9%BB%9E-%E4%B8%80%E6%97%A5%E9%81%8A%E8%A1%8C%E7%A8%8B-atami/">2026 熱海夏季花火大會完全攻略：觀賞地點、交通、美食、住宿、附近景點、一日遊行程</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/%E8%87%AA%E7%84%B6%E4%BA%BA%E6%86%91%E8%AD%89%E7%94%B3%E8%BE%A6%E8%88%87%E4%BD%BF%E7%94%A8%E5%85%A8%E6%94%BB%E7%95%A5-%E8%B2%BB%E7%94%A8-pin-%E8%AE%80%E5%8D%A1%E6%A9%9F-%E6%89%8B%E6%A9%9Fnfc-%E8%A1%8C%E5%8B%95%E8%87%AA%E7%84%B6%E4%BA%BA%E6%86%91%E8%AD%89-%E7%94%A8%E9%80%94%E4%B8%80%E6%AC%A1%E6%90%9E%E6%87%82-cdc/">自然人憑證申辦與使用全攻略：費用、PIN、讀卡機、手機NFC、行動自然人憑證、用途一次搞懂</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ios-certificates-identifiers%E8%88%87profiles%E8%A9%B3%E8%A7%A3-fastlane-match%E7%B5%B1%E4%B8%80%E7%AE%A1%E7%90%86%E6%86%91%E8%AD%89%E8%88%87ci-cd%E6%95%B4%E5%90%88%E5%AF%A6%E6%88%B0-823ac523ccc8/">iOS Certificates, Identifiers & Profiles 是什麼及 Fastlane Match 統一管理憑證與 CI/CD 的一些筆記</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/line-bank-%E5%85%A5%E9%87%91-firstrade-%E6%95%99%E5%AD%B8-%E5%BF%AB%E9%80%9F%E5%88%B0%E5%B8%B3-%E4%BD%8E%E6%89%8B%E7%BA%8C%E8%B2%BB150%E5%85%83-%E5%B8%B3%E6%88%B6%E5%8D%87%E7%B4%9A%E8%88%87%E6%89%8B%E7%BA%8C%E8%B2%BB%E8%A3%9C%E5%8A%A9%E7%94%B3%E8%AB%8B%E5%85%A8%E6%94%BB%E7%95%A5-e4d139fe0685/">手把手教學 — LINE Bank 入金 Firstrade 快速到帳、手續費只要 150 元及帳戶升級/約定轉帳/手續費補助申請教學</a></ul></section><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/travel/">travel</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節目錄 🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">延伸閱讀</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="YYYY 年 M 月 D 日" > 2021 年 01 月 05 日 </time><h4 class="pt-0 my-2">AVPlayer 邊播邊 Cache 技術實戰｜iOS 本地緩存優化攻略</h4><div class="text-muted"><p>針對 iOS 開發者面臨 AVPlayer 播放時緩存不足問題，解析 AVAssetResourceLoaderDelegate 實作技巧，有效提升播放流暢度與本地緩存效率，減少重複下載與延遲，打造穩定音樂與影片播放器體驗。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-wkwebview-%E9%A0%90%E8%BC%89%E8%88%87-cache-%E7%B7%A9%E5%AD%98%E6%8A%80%E8%A1%93-%E6%8F%90%E5%8D%87%E9%A0%81%E9%9D%A2%E8%BC%89%E5%85%A5%E9%80%9F%E5%BA%A6%E8%88%87%E8%B3%87%E6%BA%90%E7%AE%A1%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90-5033090c18ba/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1722160385" data-df="YYYY 年 M 月 D 日" > 2024 年 07 月 28 日 </time><h4 class="pt-0 my-2">iOS WKWebView 頁面與檔案資源 Preload 預載 / Cache 緩存研究</h4><div class="text-muted"><p>iOS WKWebView 預先下載與緩存資源提升頁面載入速度研究。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586365937" data-df="YYYY 年 M 月 D 日" > 2020 年 04 月 09 日 </time><h4 class="pt-0 my-2">iOS HLS Cache 實作全攻略｜AVPlayer 串流邊播邊快取技術解析</h4><div class="text-muted"><p>針對 iOS AVPlayer 播放 HLS m3u8 串流時無法攔截快取的痛點，深入分析多種快取方案，從 AVAssetResourceLoaderDelegate 到 Reverse Proxy Server，揭示技術瓶頸與可行解法，助你優化串流體驗並有效節省伺服器與流量成本。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="btn btn-outline-primary" aria-label="上一篇" ><p>AVPlayer 邊播邊 Cache 技術實戰｜iOS 本地緩存優化攻略</p></a> <a href="/posts/zrealm-dev/ios-%E8%B7%A8%E5%B9%B3%E5%8F%B0%E5%B8%B3%E8%99%9F%E5%AF%86%E7%A2%BC%E6%95%B4%E5%90%88-%E6%8F%90%E5%8D%87-app-%E8%88%87%E7%B6%B2%E7%AB%99%E7%99%BB%E5%85%A5%E9%AB%94%E9%A9%97-%E5%BF%AB%E9%80%9F%E8%87%AA%E5%8B%95%E5%A1%AB%E5%85%A5%E5%AF%86%E7%A2%BC-948ed34efa09/" class="btn btn-outline-primary" aria-label="下一篇" ><p>iOS 跨平台帳號密碼整合加強登入體驗</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2026</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有註明，本網站上的所有文章皆由作者依據 創用 CC 姓名標示 4.0 國際授權條款（CC BY 4.0）授權使用。" >版權所有。</span> <br/> 瀏覽次數: <u>813,127+</u>, 最後更新時間: <u>2026-01-19 11:14:12 +08:00</u></p><p>本站使用 <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> 主題建置於 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>。<br/> Medium 文章由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 轉換而成。</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">熱門標籤</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/japan/">japan</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E9%96%8B%E7%AE%B1/">開箱</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/travel/">travel</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">發現有新的內容版本。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'zh-TW';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'General', 'data-category-id': 'DIC_kwDOHdowL84CU-q5', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">找不到符合的結果。</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
