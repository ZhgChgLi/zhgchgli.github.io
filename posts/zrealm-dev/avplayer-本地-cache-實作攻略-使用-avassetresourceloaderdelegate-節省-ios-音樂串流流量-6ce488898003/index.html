<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="é‡å° iOS éŸ³æ¨‚ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå¯¦ç¾ AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡è¤‡ä¸‹è¼‰åŒä¸€æª”æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€éè‡ªè¨‚ Resource Loader èˆ‡ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è«‹æ±‚èˆ‡æ’­æ”¾ä¸ä¸­æ–·ï¼Œæå‡ä½¿ç”¨é«”é©—èˆ‡æ•ˆèƒ½ã€‚" /><meta property="og:description" content="é‡å° iOS éŸ³æ¨‚ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå¯¦ç¾ AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡è¤‡ä¸‹è¼‰åŒä¸€æª”æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€éè‡ªè¨‚ Resource Loader èˆ‡ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è«‹æ±‚èˆ‡æ’­æ”¾ä¸ä¸­æ–·ï¼Œæå‡ä½¿ç”¨é«”é©—èˆ‡æ•ˆèƒ½ã€‚" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="twitter:title" content="AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"é‡å° iOS éŸ³æ¨‚ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå¯¦ç¾ AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡è¤‡ä¸‹è¼‰åŒä¸€æª”æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€éè‡ªè¨‚ Resource Loader èˆ‡ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è«‹æ±‚èˆ‡æ’­æ”¾ä¸ä¸­æ–·ï¼Œæå‡ä½¿ç”¨é«”é©—èˆ‡æ•ˆèƒ½ã€‚","headline":"AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg==","url":"https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"},"url":"https://zhgchg.li/posts/zrealm-dev/avplayer-%E6%9C%AC%E5%9C%B0-cache-%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5-%E4%BD%BF%E7%94%A8-avassetresourceloaderdelegate-%E7%AF%80%E7%9C%81-ios-%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F-6ce488898003/"}</script><title>AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡ | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan ğŸ‡¹ğŸ‡¼ who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡</h1><p class="post-desc fw-light mb-4">é‡å° iOS éŸ³æ¨‚ä¸²æµæ’­æ”¾éœ€æ±‚ï¼Œå¯¦ç¾ AVPlayer æœ¬åœ° Cache åŠŸèƒ½ï¼Œé¿å…é‡è¤‡ä¸‹è¼‰åŒä¸€æª”æ¡ˆï¼Œé™ä½æµé‡æˆæœ¬ï¼›é€éè‡ªè¨‚ Resource Loader èˆ‡ PINCache ç®¡ç†å¿«å–ï¼Œæ”¯æ´åˆ†æ®µ Range è«‹æ±‚èˆ‡æ’­æ”¾ä¸ä¸­æ–·ï¼Œæå‡ä½¿ç”¨é«”é©—èˆ‡æ•ˆèƒ½ã€‚</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1612089702" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 31, 2021 </time> </span> <span> Updated <time data-ts="1712997921" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link preview-img blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="7241 words" > <em>40 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">ç« ç¯€ (Chapters)ğŸ”–</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">AVPlayer æœ¬åœ° Cache å¯¦ä½œæ”»ç•¥ï½œä½¿ç”¨ AVAssetResourceLoaderDelegate ç¯€çœ iOS éŸ³æ¨‚ä¸²æµæµé‡</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-info"><p><a href="/posts/en/6ce488898003/"><strong>Click here</strong></a> to view the English version of this article, translated by OpenAI.</p></blockquote><blockquote class="prompt-tip"><p>åŸºæ–¼ SEO è€ƒé‡ï¼Œæœ¬æ–‡æ¨™é¡Œèˆ‡æè¿°ç¶“ GPT èª¿æ•´ï¼ŒåŸå§‹ç‰ˆæœ¬è«‹åƒè€ƒå…§æ–‡ï¼Œè‹¥æœ‰ä¸æ°ç•¶çš„ç”¨èªï¼Œæ•¬è«‹æŒ‡æ­£ã€‚</p></blockquote><hr /><h3 id="avplayer-å¯¦è¸æœ¬åœ°-cache-åŠŸèƒ½å¤§å…¨"><span class="me-2">AVPlayer å¯¦è¸æœ¬åœ° Cache åŠŸèƒ½å¤§å…¨</span><a href="#avplayer-å¯¦è¸æœ¬åœ°-cache-åŠŸèƒ½å¤§å…¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>AVPlayer/AVQueuePlayer with AVURLAsset å¯¦ä½œ AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>æˆ‘å°‡ä¹‹å‰çš„å¯¦ä½œé–‹æºäº†ï¼Œæœ‰éœ€æ±‚çš„æœ‹å‹å¯ç›´æ¥ä½¿ç”¨ã€‚</p><ul><li>å®¢è£½åŒ– Cache ç­–ç•¥ï¼Œå¯ä»¥ç”¨ PINCache or å…¶ä»–â€¦<li>å¤–éƒ¨åªéœ€å‘¼å« make AVAsset å·¥å» ï¼Œå¸¶å…¥ URLï¼Œå‰‡ AVAsset å°±èƒ½æ”¯æ´ Caching<li>ä½¿ç”¨ Combine å¯¦ç¾ Data Flow ç­–ç•¥<li>å¯«äº†ä¸€äº›æ¸¬è©¦</ul><h3 id="å‰è¨€"><span class="me-2">å‰è¨€</span><a href="#å‰è¨€" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æ—¢ä¸Šä¸€ç¯‡ã€Œ <a href="/posts/zrealm-dev/ios-hls-cache-å¯¦ä½œå…¨æ”»ç•¥-avplayer-ä¸²æµé‚Šæ’­é‚Šå¿«å–æŠ€è¡“è§£æ-d796bf8e661e/">iOS HLS Cache å¯¦è¸æ–¹æ³•æ¢ç©¶ä¹‹æ—…</a> ã€å¾Œå·²éäº†å¤§åŠå¹´ï¼Œåœ˜éšŠé‚„æ˜¯ä¸€ç›´æƒ³è¦å¯¦ç¾é‚Šæ’­é‚Š Cache åŠŸèƒ½å› ç‚ºå°æˆæœ¬çš„å½±éŸ¿æ¥µå¤§ï¼›æˆ‘å€‘æ˜¯éŸ³æ¨‚ä¸²æµå¹³å°ï¼Œå¦‚æœæ¯æ¬¡æ’­æ”¾åŒæ¨£çš„æ­Œæ›²éƒ½è¦é‡æ–°æ‹¿æ•´å€‹æª”æ¡ˆï¼Œå°æˆ‘å€‘æˆ–å°éåƒåˆ°é£½çš„ä½¿ç”¨è€…ä¾†èªªéƒ½å¾ˆå‚·æµé‡ï¼Œé›–ç„¶éŸ³æ¨‚æª”æ¡ˆé ‚å¤šå¹¾ MBï¼Œä½†ç©æ²™æˆå¡”éƒ½æ˜¯éŒ¢ï¼</p><p>å¦å¤–å› ç‚º Android é‚£é‚Šå·²ç¶“æœ‰å¯¦ä½œé‚Šæ’­é‚Š Cache çš„åŠŸèƒ½äº†ï¼Œä¹‹å‰æœ‰æ¯”è¼ƒéèŠ±è²»ï¼ŒAndroid ç«¯ä¸Šç·šå¾Œæ˜é¡¯ç¯€çœäº†è¨±å¤šæµé‡ï¼›ç›¸å°æ›´å¤šä½¿ç”¨è€…çš„ iOS æ‡‰è©²èƒ½æœ‰æ›´å¥½çš„ç¯€æµé«”ç¾ã€‚</p><p>æ ¹æ“š <a href="/posts/zrealm-dev/ios-hls-cache-å¯¦ä½œå…¨æ”»ç•¥-avplayer-ä¸²æµé‚Šæ’­é‚Šå¿«å–æŠ€è¡“è§£æ-d796bf8e661e/">ä¸Šä¸€ç¯‡</a> çš„ç¶“é©—ï¼Œå¦‚æœæˆ‘å€‘è¦ç¹¼çºŒä½¿ç”¨ HLS ( .m3u8/.ts) ä¾†é”æˆç›®çš„ï¼›äº‹æƒ…å°‡æœƒè®Šå¾—éå¸¸è¤‡é›œç”šè‡³ç„¡æ³•é”æˆï¼›æˆ‘å€‘é€€è€Œæ±‚å…¶æ¬¡é€€å›å»ä½¿ç”¨ mp3 æª”ï¼Œé€™æ¨£å°±èƒ½ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> é€²è¡Œå¯¦ä½œã€‚</p><h3 id="ç›®æ¨™"><span class="me-2">ç›®æ¨™</span><a href="#ç›®æ¨™" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>æ’­æ”¾éçš„éŸ³æ¨‚æœƒåœ¨æœ¬åœ°ç”¢ç”Ÿ Cache å‚™ä»½<li>æ’­æ”¾éŸ³æ¨‚æ™‚å…ˆæª¢æŸ¥æœ¬åœ°æœ‰ç„¡ Cache è®€å–ï¼Œæœ‰å‰‡ä¸å†é‡ä¼ºæœå™¨è¦æª”æ¡ˆ<li>å¯è¨­ Cache ç­–ç•¥ï¼›ä¸Šé™ç¸½å®¹é‡ï¼Œè¶…éæ™‚é–‹å§‹åˆªé™¤æœ€èˆŠçš„ Cache æª”æ¡ˆ<li>ä¸å¹²æ¶‰åŸæœ¬ AVPlayer æ’­æ”¾æ©Ÿåˆ¶ ï¼ˆä¸ç„¶æœ€å¿«çš„æ–¹æ³•å°±æ˜¯è‡ªå·±å…ˆç”¨ URLSession æŠŠ mp3 è¼‰ä¸‹ä¾†å¡çµ¦ AVPlayerï¼Œä½†é€™æ¨£å°±å¤±å»åŸæœ¬èƒ½æ’­åˆ°å“ªè¼‰åˆ°å“ªçš„åŠŸèƒ½ï¼Œä½¿ç”¨è€…éœ€è¦ç­‰å¾…æ›´é•·æ™‚é–“ï¼†æ›´æ¶ˆè€—æµé‡ï¼‰</ul><h3 id="å‰å°çŸ¥è­˜-1-http11-range-ç¯„åœè«‹æ±‚connection-keep-alive"><span class="me-2">å‰å°çŸ¥è­˜ (1)â€” HTTP/1.1 Range ç¯„åœè«‹æ±‚ã€Connection Keep-Alive</span><a href="#å‰å°çŸ¥è­˜-1-http11-range-ç¯„åœè«‹æ±‚connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-ç¯„åœè«‹æ±‚"><span class="me-2">HTTP/1.1 Range ç¯„åœè«‹æ±‚</span><a href="#http11-range-ç¯„åœè«‹æ±‚" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>é¦–å…ˆæˆ‘å€‘è¦å…ˆäº†è§£åœ¨æ’­æ”¾å½±ç‰‡ã€éŸ³æ¨‚æ™‚æ˜¯æ€éº¼è·Ÿä¼ºæœå™¨è¦æ±‚è³‡æ–™çš„ï¼›ä¸€èˆ¬ä¾†èªªå½±ç‰‡ã€éŸ³æ¨‚æª”æ¡ˆéƒ½å¾ˆå¤§ï¼Œä¸å¯èƒ½ç­‰åˆ°å…¨éƒ¨æ‹¿å®Œæ‰é–‹å§‹æ’­æ”¾å¸¸è¦‹çš„æ˜¯æ’­åˆ°å“ªæ‹¿åˆ°äº†ï¼Œåªè¦æœ‰æ­£åœ¨æ’­æ”¾å€æ®µçš„è³‡æ–™å°±èƒ½é‹ä½œã€‚</p><p>è¦é”åˆ°é€™å€‹åŠŸèƒ½çš„æ–¹æ³•å°±æ˜¯é€é HTTP/1.1 Range åªè¿”å›æŒ‡å®šè³‡æ–™å­—ç¯€ç¯„åœçš„è³‡æ–™ï¼Œä¾‹å¦‚æŒ‡å®š 0â€“100 å°±åªè¿”å› 0â€“100 é€™ 100 bytes å¤§å°çš„è³‡æ–™ï¼›é€éé€™å€‹æ–¹æ³•ï¼Œå¯ä»¥ä¾åºåˆ†æ®µå–å¾—è³‡æ–™ï¼Œç„¶å¾Œå†å½™æ•´å†ä¸€èµ·æˆå®Œæ•´çš„æª”æ¡ˆï¼›é€™å€‹æ–¹æ³•ä¹Ÿèƒ½é‹ç”¨åœ¨æª”æ¡ˆä¸‹è¼‰çºŒå‚³åŠŸèƒ½ä¸Šã€‚</p><h4 id="å¦‚ä½•æ‡‰ç”¨"><span class="me-2">å¦‚ä½•æ‡‰ç”¨ï¼Ÿ</span><a href="#å¦‚ä½•æ‡‰ç”¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æˆ‘å€‘æœƒå…ˆä½¿ç”¨ HEAD å»çœ‹ Response Header äº†è§£åˆ°ä¼ºæœå™¨æ˜¯å¦æ”¯æ´ Range ç¯„åœè«‹æ±‚ã€è³‡æºç¸½é•·åº¦ã€æª”æ¡ˆé¡å‹ï¼š</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>ä½¿ç”¨ HEAD æˆ‘å€‘èƒ½å¾ Response Header å¾—åˆ°ä»¥ä¸‹è³‡è¨Šï¼š</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> ä»£è¡¨ä¼ºæœå™¨æ”¯æ´ Range ç¯„åœè«‹æ±‚ å¦‚æœæ²’æœ‰ Response é€™å€‹å€¼æˆ–æ˜¯æ˜¯ Accept-Ranges: none éƒ½ä»£è¡¨ä¸æ”¯æ´<li><strong>Content-Length:</strong> è³‡æºç¸½é•·åº¦ï¼Œæˆ‘å€‘è¦çŸ¥é“ç¸½é•·åº¦æ‰èƒ½å»åˆ†æ®µè¦è³‡æ–™ã€‚<li><strong>Content-Type:</strong> æª”æ¡ˆé¡å‹ï¼ŒAVPlayer æ’­æ”¾æ™‚éœ€è¦çŸ¥é“çš„è³‡è¨Šã€‚</ul><p>ä½†æœ‰æ™‚æˆ‘å€‘ä¹Ÿæœƒä½¿ç”¨ GET <code class="language-plaintext highlighter-rouge">Range: bytes=0â€“1</code> ï¼Œæ„æ€æ˜¯æˆ‘è¦æ±‚ 0â€“1 ç¯„åœçš„è³‡æ–™ä½†å¯¦éš›æˆ‘æ ¹æœ¬ä¸ Care 0â€“1æ˜¯ä»€éº¼å…§å®¹ï¼Œæˆ‘åªæ˜¯è¦çœ‹ Response Header çš„è³‡è¨Šï¼› <strong>åŸç”Ÿ AVPlayer å°±æ˜¯ä½¿ç”¨ GET å»çœ‹ï¼Œæ‰€ä»¥æœ¬ç¯‡ä¹Ÿç…§èˆŠä½¿ç”¨</strong> ã€‚</p><blockquote><p><em>ä½†æ¯”è¼ƒå»ºè­°ä½¿ç”¨ HEAD å»çœ‹ï¼Œä¸€æ–¹æ³•æ¯”è¼ƒæ­£ç¢ºï¼Œå¦ä¸€æ–¹é¢è¬ä¸€ä¼ºæœå™¨ä¸æ”¯æ´ Range åŠŸèƒ½ï¼›ç”¨ GET å»æ‘¸å°±æœƒè®Šå¼·è¿«ä¸‹è¼‰å®Œæ•´æª”æ¡ˆã€‚</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“1"</span>
</pre></table></code></div></div><p><strong>ä½¿ç”¨ GET æˆ‘å€‘èƒ½å¾ Response Header å¾—åˆ°ä»¥ä¸‹è³‡è¨Šï¼š</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> ä»£è¡¨ä¼ºæœå™¨æ”¯æ´ Range ç¯„åœè«‹æ±‚ å¦‚æœæ²’æœ‰ Response é€™å€‹å€¼æˆ–æ˜¯æ˜¯ Accept-Ranges: none éƒ½ä»£è¡¨ä¸æ”¯æ´<li><strong>Content-Range: bytes 0â€“1/è³‡æºç¸½é•·åº¦</strong> ï¼Œã€Œ/ã€å¾Œçš„æ•¸å­—åŠè³‡æºç¸½é•·åº¦ï¼Œæˆ‘å€‘è¦çŸ¥é“ç¸½é•·åº¦æ‰èƒ½å»åˆ†æ®µè¦è³‡æ–™ã€‚<li><strong>Content-Type:</strong> æª”æ¡ˆé¡å‹ï¼ŒAVPlayer æ’­æ”¾æ™‚éœ€è¦çŸ¥é“çš„è³‡è¨Šã€‚</ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>çŸ¥é“ä¼ºæœå™¨æ”¯æ´ Range ç¯„åœè«‹æ±‚å¾Œï¼Œå°±èƒ½åˆ†æ®µç™¼èµ·ç¯„åœè«‹æ±‚ï¼š</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“100"</span>
</pre></table></code></div></div><p><strong>ä¼ºæœå™¨æœƒè¿”å› 206 Partial Contentï¼š</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/ç¸½é•·åº¦
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>é€™æ™‚æˆ‘å€‘å°±å¾—åˆ° Range 0â€“100 çš„ Dataï¼Œå¯å†ç¹¼çºŒç™¼æ–°è«‹æ±‚æ‹¿ Range 100â€“200. .200â€“300â€¦åˆ°çµæŸã€‚</p><p>å¦‚æœæ‹¿çš„ Range è¶…éè³‡æºç¸½é•·åº¦æœƒè¿”å› 416 Range Not Satisfiableã€‚</p><p>å¦å¤–ï¼Œæƒ³æ‹¿å®Œæ•´æª”æ¡ˆè³‡æ–™é™¤äº†å¯ä»¥è«‹æ±‚ Range 0-ç¸½é•·åº¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ 0- æ–¹å¼å³å¯ï¼š</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0â€“"</span>
</pre></table></code></div></div><p>å…¶ä»–é‚„å¯ä»¥åŒå€‹è«‹æ±‚è¦æ±‚å¤šå€‹ Range è³‡æ–™åŠä¸‹æ¢ä»¶å¼å­ï¼Œä½†æˆ‘å€‘ç”¨ä¸åˆ°ï¼Œè©³æƒ…å¯ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">åƒè€ƒé€™</a> ã€‚</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>http 1.1 é è¨­æ˜¯é–‹å•Ÿç‹€æ…‹ï¼Œ <strong>æ­¤ç‰¹æ€§èƒ½å¯¦æ™‚å–å¾—å·²ä¸‹è¼‰çš„è³‡æ–™</strong> ï¼Œä¾‹å¦‚æª”æ¡ˆ 5 mbï¼Œèƒ½ 16 kbã€16 kbã€16 kbâ€¦ çš„å–å¾—ï¼Œä¸ç”¨ç­‰åˆ° 5mb éƒ½å¥½æ‰çµ¦ä½ ã€‚</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keey-Alive
</pre></table></code></div></div><h4 id="å¦‚æœç™¼ç¾ä¼ºæœå™¨ä¸æ”¯æ´-range-keep-alive-"><span class="me-2"><strong><em>å¦‚æœç™¼ç¾ä¼ºæœå™¨ä¸æ”¯æ´ Rangeã€</em></strong> Keep-Alive <strong><em>ï¼Ÿ</em></strong></span><a href="#å¦‚æœç™¼ç¾ä¼ºæœå™¨ä¸æ”¯æ´-range-keep-alive-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>é‚£ä¹Ÿä¸ç”¨æé€™éº¼å¤šäº†ï¼Œç›´æ¥è‡ªå·±ç”¨ URLSession ä¸‹è¼‰å®Œ mp3 æª”æ¡ˆå¡çµ¦æ’­æ”¾å™¨å°±å¥½â€¦.ä½†é€™ä¸æ˜¯æˆ‘å€‘è¦çš„çµæœï¼Œå¯ä»¥è«‹å¾Œç«¯å¹«å¿™ä¿®æ”¹ä¼ºæœå™¨è¨­å®šã€‚</em></p></blockquote><h3 id="å‰å°çŸ¥è­˜-2--avplayer-åŸç”Ÿæ˜¯å¦‚ä½•è™•ç†-avurlasset-è³‡æº"><span class="me-2">å‰å°çŸ¥è­˜ (2) â€” AVPlayer åŸç”Ÿæ˜¯å¦‚ä½•è™•ç† AVURLAsset è³‡æºï¼Ÿ</span><a href="#å‰å°çŸ¥è­˜-2--avplayer-åŸç”Ÿæ˜¯å¦‚ä½•è™•ç†-avurlasset-è³‡æº" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY1IiBoZWlnaHQ9Ijc5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>ç•¶æˆ‘å€‘ä½¿ç”¨ AVURLAsset init with URL è³‡æºä¸¦è³¦äºˆçµ¦ AVPlayer/AVQueuePlayer é–‹å§‹æ’­æ”¾ä¹‹å¾Œï¼ŒåŒä¸Šæ‰€è¿°ï¼Œé¦–å…ˆæœƒç”¨ GET Range 0â€“1 å»å–å¾—æ˜¯å¦æ”¯æ´ Range ç¯„åœè«‹æ±‚ã€è³‡æºç¸½é•·åº¦ã€æª”æ¡ˆé¡å‹é€™ä¸‰å€‹è³‡è¨Šã€‚</p><p>æœ‰äº†æª”æ¡ˆè³‡è¨Šå¾Œï¼Œæœƒå†ç™¼èµ·ç¬¬äºŒæ¬¡è«‹æ±‚ï¼Œè«‹æ±‚å¾ 0-ç¸½é•·åº¦ çš„è³‡æ–™ã€‚</p><blockquote><p><em>âš ï¸ <strong>AVPlayer æœƒè«‹æ±‚å¾ 0-ç¸½é•·åº¦ çš„è³‡æ–™ï¼Œä¸¦é€éå¯¦æ™‚å–å¾—å·²ä¸‹è¼‰çš„è³‡æ–™ç‰¹æ€§ (</strong> 16 kbã€16 kbã€16 kbâ€¦) <strong>å–å¾—åˆ°ä»–è¦ºå¾—è³‡æ–™è¶³å¤ å¾Œï¼Œæœƒç™¼èµ· Cancel å–æ¶ˆé€™å€‹ç¶²è·¯è«‹æ±‚</strong> ï¼ˆæ‰€ä»¥å¯¦éš›ä¹Ÿä¸æœƒæ‹¿å®Œï¼Œé™¤éæª”æ¡ˆå¤ªå°ï¼‰ã€‚</em></p></blockquote><blockquote><p><em>ç¹¼çºŒæ’­æ”¾å¾Œæ‰æœƒé€é Range å¾€å¾Œè«‹æ±‚è³‡æ–™ã€‚</em></p></blockquote><blockquote><p><em>ï¼ˆé€™éƒ¨åˆ†è·Ÿæˆ‘ä¹‹å‰æƒ³çš„ä¸ä¸€æ¨£ï¼Œæˆ‘ä»¥ç‚ºæœƒæ˜¯0â€“100ã€100â€“200. .é€™æ¨£è«‹æ±‚ï¼‰</em></p></blockquote><p><strong>AVPlayer è«‹æ±‚ç¯„ä¾‹ï¼š</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: ç¸½é•·åº¦ 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 kb receive
4. 16 kb receive...
5. cancel() // current offset is 700
6. ç¹¼çºŒæ’­æ”¾
7. GET 700-150000...
8. 16 kb receive
9. 16 kb receive...
10. cancel() // current offset is 1500
11. ç¹¼çºŒæ’­æ”¾
12. GET 1500-150000...
13. 16 kb receive
14. 16 kb receive...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 kb receive
20. 16 kb receive...
...
</pre></table></code></div></div><blockquote><p><em>âš ï¸ <strong>iOS â‰¤12 çš„æƒ…æ³ä¸‹ï¼Œæœƒå…ˆç™¼å¹¾å€‹è¼ƒçŸ­çš„è«‹æ±‚è©¦è‘—æ‘¸æ‘¸çœ‹ï¼ˆï¼Ÿç„¶å¾Œæ‰æœƒç™¼è¦æ±‚åˆ°ç¸½é•·åº¦çš„è«‹æ±‚ï¼› iOS â‰¥ 13 å‰‡æœƒç›´æ¥ç™¼è¦æ±‚åˆ°ç¸½é•·åº¦çš„è«‹æ±‚ã€‚</strong></em></p></blockquote><p>é‚„æœ‰å€‹é¡Œå¤–çš„å‘ï¼Œå°±æ˜¯åœ¨è§€å¯Ÿæ€éº¼æ‹¿è³‡æºçš„æ™‚å€™ï¼Œæˆ‘ä½¿ç”¨äº† <a href="/posts/zrealm-dev/app-httpså‚³è¼¸ä»é­ç«Šå–-mitmproxyä¸­é–“äººæ”»æ“Šå¯¦æˆ°æ•™å­¸èˆ‡é˜²ç¯„æŠ€å·§-46410aaada00/">mitmproxy</a> å·¥å…·å—…æ¢ï¼Œçµæœç™¼ç¾å®ƒé¡¯ç¤ºæœ‰éŒ¯ï¼Œæœƒç­‰åˆ° response å…¨éƒ¨å›ä¾†æ‰æœƒé¡¯ç¤ºï¼Œè€Œä¸æ˜¯é¡¯ç¤ºåˆ†æ®µã€ä½¿ç”¨æŒä¹…é€£æ¥æ¥çºŒä¸‹è¼‰ï¼›å®³æˆ‘åš‡äº†ä¸€å¤§è·³ï¼ä»¥ç‚º iOS å¾ˆç¬¨å±…ç„¶æ¯æ¬¡éƒ½è¦æ•´å€‹æª”æ¡ˆå›ä¾†ï¼ä¸‹æ¬¡è¦ç”¨å·¥å…·æ™‚è¦æœ‰ä¿æŒä¸€é»æ‡·ç–‘ Orz</p><h4 id="cancel-ç™¼èµ·çš„æ™‚æ©Ÿ"><span class="me-2">Cancel ç™¼èµ·çš„æ™‚æ©Ÿ</span><a href="#cancel-ç™¼èµ·çš„æ™‚æ©Ÿ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>å‰é¢èªªåˆ°çš„ç¬¬äºŒæ¬¡è«‹æ±‚ï¼Œè«‹æ±‚å¾ 0 é–‹å§‹ åˆ°ç¸½é•·åº¦çš„è³‡æºï¼Œæœ‰è¶³å¤  Data å¾Œæœƒç™¼èµ· Cancel å–æ¶ˆè«‹æ±‚ã€‚<li>Seek æ™‚æœƒå…ˆç™¼èµ· Cancel å–æ¶ˆå…ˆå‰çš„è«‹æ±‚ã€‚</ol><blockquote><p><em>âš ï¸ åœ¨ AVQueuePlayer ä¸­åˆ‡æ›åˆ°ä¸‹ä¸€å€‹è³‡æºã€AVPlayer æ›´æ›æ’­æ”¾è³‡æºæ™‚ä¸¦ä¸æœƒç™¼èµ· Cancel å–æ¶ˆå‰ä¸€é¦–çš„è«‹æ±‚ã€‚</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å…¶å¯¦ä¹Ÿæ˜¯åŒæ¨£å‘¼å« Resource Loader è™•ç†ï¼Œåªæ˜¯ä»–è¦æ±‚çš„è³‡æ–™ç¯„åœæœƒæ¯”è¼ƒå°ã€‚</p><h3 id="å¯¦ç¾"><span class="me-2">å¯¦ç¾</span><a href="#å¯¦ç¾" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ‰äº†ä»¥ä¸Šå‰å°çŸ¥è­˜å¾Œæˆ‘å€‘ä¾†çœ‹å¯¦ç¾ AVPlayer æœ¬åœ° Cache åŠŸèƒ½çš„åŸç†æ–¹å¼ã€‚</p><p>å°±æ˜¯ä¹‹å‰æœ‰æåˆ°çš„ <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code> ï¼Œé€™å€‹æ¥å£è®“æˆ‘å€‘èƒ½ <strong>è‡ªè¡Œå¯¦è¸ Resource Loader</strong> çµ¦ Asset ç”¨ã€‚</p><p>Resource Loader å¯¦éš›å°±æ˜¯å€‹æ‰“å·¥ä»”ï¼Œæ’­æ”¾å™¨æ˜¯è¦æª”æ¡ˆè³‡è¨Šé‚„æ˜¯æª”æ¡ˆè³‡æ–™ï¼Œç¯„åœå“ªè£¡éƒ½å“ªè£¡éƒ½æ˜¯ä»–å‘Šè¨´æˆ‘å€‘ï¼Œæˆ‘å€‘å»åšå°±æ˜¯ã€‚</p><blockquote><p><em>çœ‹åˆ°æœ‰ç¯„ä¾‹æ˜¯ä¸€å€‹ <strong>Resource Loader æœå‹™æ‰€æœ‰ AVURLAsset</strong> ï¼Œæˆ‘è¦ºå¾—æ˜¯éŒ¯çš„ï¼Œæ‡‰è©²è¦ä¸€å€‹ Resource Loader æœå‹™ä¸€å€‹ AVURLAssetï¼Œè·Ÿè‘— AVURLAsset çš„ç”Ÿå‘½é€±æœŸï¼Œä»–æœ¬ä¾†å°±å±¬æ–¼ AVURLAssetã€‚</em></p></blockquote><blockquote><p><em>ä¸€å€‹ Resource Loader æœå‹™æ‰€æœ‰ AVURLAsset åœ¨ AVQueuePlayer ä¸Šæœƒè®Šå¾—éå¸¸è¤‡é›œä¸”é›£ä»¥ç®¡ç†ã€‚</em></p></blockquote><h4 id="é€²å…¥è‡ªè¨‚çš„-resource-loader-çš„æ™‚æ©Ÿé»"><span class="me-2">é€²å…¥è‡ªè¨‚çš„ Resource Loader çš„æ™‚æ©Ÿé»</span><a href="#é€²å…¥è‡ªè¨‚çš„-resource-loader-çš„æ™‚æ©Ÿé»" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>è¦æ³¨æ„çš„æ˜¯ä¸æ˜¯å¯¦è¸äº†è‡ªå·±çš„ Resource Loader ä»–å°±æœƒç†ä½ ï¼Œåªæœ‰ç•¶ç³»çµ±ç„¡æ³•è¾¨è­˜è™•ç†é€™å€‹è³‡æºçš„æ™‚å€™ï¼Œæ‰æœƒèµ°ä½ çš„ Resource Loaderã€‚</p><p>æ‰€ä»¥æˆ‘å€‘åœ¨å°‡ URL è³‡æºçµ¦äºˆ AVURLAsset ä¹‹å‰è¦å…ˆå°‡ Scheme æ›æˆæˆ‘å€‘è‡ªè¨‚çš„ Schemeï¼Œä¸èƒ½æ˜¯ http/httpsâ€¦ é€™äº›ç³»çµ±èƒ½è™•ç†çš„ Schemeã€‚</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>åªæœ‰å…©å€‹æ–¹æ³•éœ€è¦å¯¦ç¾ï¼š</strong></p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) -&gt; Bool :</ul><p>æ­¤æ–¹æ³•å•æˆ‘å€‘èƒ½ä¸èƒ½è™•ç†æ­¤è³‡æºï¼Œreturn true èƒ½ï¼Œreturn false æˆ‘å€‘ä¹Ÿä¸è™•ç†ï¼ˆunsupported urlï¼‰ã€‚</p><p>æˆ‘å€‘èƒ½å¾ <code class="language-plaintext highlighter-rouge">loadingRequest</code> å–å‡ºè¦è«‹æ±‚ä»€éº¼ï¼ˆç¬¬ä¸€æ¬¡è«‹æ±‚æª”æ¡ˆè³‡è¨Šé‚„æ˜¯è«‹æ±‚è³‡æ–™ï¼Œè«‹æ±‚è³‡æ–™çš„è©± Range æ˜¯å¤šå°‘åˆ°å¤šå°‘ï¼‰ï¼›çŸ¥é“è«‹æ±‚å¾Œæˆ‘å€‘è‡ªè¡Œç™¼èµ·è«‹æ±‚å»æ‹¿è³‡æ–™ï¼Œ <strong>åœ¨é€™æˆ‘å€‘å°±èƒ½æ±ºå®šè¦ç™¼èµ· URLSession é‚„æ˜¯å¾æœ¬åœ°è¿”å› Data</strong> ã€‚</p><p>å¦å¤–ä¹Ÿèƒ½åœ¨æ­¤åš Data åŠ è§£å¯†æ“ä½œï¼Œä¿è­·åŸå§‹è³‡æ–™ã€‚</p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) :</ul><p>å‰è¿°èªªåˆ°çš„ <strong>Cancel ç™¼èµ·æ™‚æ©Ÿ</strong> ç™¼èµ· Cancel æ™‚â€¦</p><p>æˆ‘å€‘å¯ä»¥åœ¨é€™å»å–æ¶ˆæ­£åœ¨è«‹æ±‚çš„ URLSessionã€‚</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYwIiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="æœ¬åœ°-cache-å¯¦ç¾æ–¹å¼"><span class="me-2">æœ¬åœ° Cache å¯¦ç¾æ–¹å¼</span><a href="#æœ¬åœ°-cache-å¯¦ç¾æ–¹å¼" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Cache çš„éƒ¨åˆ†æˆ‘ç›´æ¥ä½¿ç”¨ <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a> ï¼Œå°‡ Cache å·¥ä½œäº¤ç”±ä»–è™•ç†ï¼Œå…å»æˆ‘å€‘è¦è™•ç† Cache è®€å¯« DeadLockã€æ¸…é™¤ Cache LRU ç­–ç•¥ å¯¦ä½œä¸Šçš„å•é¡Œã€‚</p><blockquote><p><strong><em>ï¸ï¸âš ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸OOMè­¦å‘Šï¼</em></strong></p></blockquote><blockquote><p><em>å› ç‚ºé€™é‚Šæ˜¯é‡å°éŸ³æ¨‚åš Cache æª”æ¡ˆå¤§å°é ‚å¤š 10 MB ä¸Šä¸‹ï¼Œæ‰€ä»¥æ‰èƒ½ä½¿ç”¨ PINCache ä½œç‚ºæœ¬åœ° Cache å·¥å…·ï¼›å¦‚æœæ˜¯è¦æœå‹™å½±ç‰‡å°±ç„¡æ³•ä½¿ç”¨æ­¤æ–¹æ³•ï¼ˆå¯èƒ½ä¸€æ¬¡è¦è¼‰å…¥å¥½å¹¾ GB çš„è³‡æ–™åˆ°è¨˜æ†¶é«”ï¼‰</em></p></blockquote><p>æœ‰é€™éƒ¨åˆ†éœ€æ±‚å¯åƒè€ƒå¤§å¤§çš„åšæ³•ï¼Œç”¨ FileHandle seek read/write çš„ç‰¹æ€§é€²è¡Œè™•ç†ã€‚</p><h3 id="é–‹å·¥"><span class="me-2">é–‹å·¥ï¼</span><a href="#é–‹å·¥" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>ä¸å›‰å”†ï¼Œå…ˆä¸Šå®Œæ•´å°ˆæ¡ˆï¼š</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" loading="lazy"></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æœ¬åœ° Cache è³‡æ–™ç‰©ä»¶æ˜ å°„å¯¦ç¾ NSCodingï¼Œå›  PINCache æ˜¯ä¾è³´ archivedData æ–¹æ³• encode/decodeã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>å­˜æ”¾ï¼š</strong></p><ul><li><code class="language-plaintext highlighter-rouge">contentInformation</code> : AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code> ï¼š å­˜æ”¾ æ˜¯å¦æ”¯æ´ Range ç¯„åœè«‹æ±‚(isByteRangeAccessSupported)ã€è³‡æºç¸½é•·åº¦(contentLength)ã€æª”æ¡ˆé¡å‹(contentType)<li><code class="language-plaintext highlighter-rouge">mediaData</code> : åŸå§‹éŸ³è¨Š Data <strong>ï¼ˆé€™é‚Šæª”æ¡ˆå¤ªå¤§æœƒ OOMï¼‰</strong></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å°è£ Data å­˜å…¥ã€å–å‡º PINCache é‚è¼¯ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>é€™é‚Šå¤šæŠ½å‡º Protocol å› ç‚ºæœªä¾†å¯èƒ½ä½¿ç”¨å…¶ä»–å„²å­˜æ–¹å¼æ›¿ä»£ PINCacheï¼Œæ‰€ä»¥å…¶ä»–ç¨‹å¼åœ¨ä½¿ç”¨æ™‚æ˜¯ä¾è³´ Protocol è€Œé Class å¯¦é«”ã€‚</p><blockquote><p><em>âš ï¸ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>é€™å€‹æ–¹æ³•æ¥µå…¶é‡è¦ã€‚</strong></em></p></blockquote><p>ç…§ç·šæ€§æ’­æ”¾åªè¦ä¸€ç›´ append æ–° Data åˆ° Cache Data ä¸­å³å¯ï¼Œä½†ç¾å¯¦æƒ…æ³è¤‡é›œå¾—å¤šï¼Œä½¿ç”¨è€…å¯èƒ½æ’­äº† Range 0~100ï¼Œç›´æ¥ Seek åˆ° Range 200â€“500 æ’­æ”¾ï¼›å¦‚ä½•å°‡å·²æœ‰çš„ 0-100 Data èˆ‡æ–°çš„ 200â€“500 Data åˆä½µå°±æ˜¯ä¸€å€‹å¾ˆå¤§çš„å•é¡Œã€‚</p><blockquote><p><em>âš ï¸Data åˆä½µæœ‰å•é¡Œæœƒå‡ºç¾å¯æ€•çš„æ’­æ”¾é¬¼ç•œå•é¡Œâ€¦.</em></p></blockquote><p>é€™é‚Šçš„ç­”æ¡ˆæ˜¯ï¼Œ <strong>æˆ‘å€‘ä¸è™•ç†éé€£çºŒè³‡æ–™</strong> ï¼›å› ç‚ºæ•å°ˆæ¡ˆåƒ…ç‚ºéŸ³è¨Šï¼Œæª”æ¡ˆä¹Ÿå°±å¹¾ MB (â‰¤ 10MB) ä»¥è€ƒé‡é–‹ç™¼æˆæœ¬å°±æ²’åšäº†ï¼Œæˆ‘åªè™•ç†åˆä½µé€£çºŒçš„è³‡æ–™ï¼ˆä¾‹å¦‚ç›®å‰å·²æœ‰ 0~100ï¼Œæ–°è³‡æ–™æ˜¯ 75~200ï¼Œåˆä½µä¹‹å¾Œè®Š0~200ï¼›å¦‚æœæ–°è³‡æ–™æ˜¯ 150~200ï¼Œæˆ‘å‰‡æœƒå¿½ç•¥ä¸åˆä½µè™•ç†ï¼‰</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjM2IiBoZWlnaHQ9IjgwOCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å¦‚æœè¦è€ƒæ…®éé€£çºŒåˆä½µï¼Œé™¤äº†åœ¨å„²å­˜ä¸Šè¦ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼ˆè¦æœ‰è¾¦æ³•è¾¨è­˜ç©ºç¼ºéƒ¨åˆ†ï¼‰ï¼›åœ¨ Request æ™‚ä¹Ÿè¦èƒ½ Query å‡ºå“ªæ®µéœ€è¦ç™¼ç¶²è·¯è«‹æ±‚å»æ‹¿ã€å“ªæ®µæ˜¯å¾æœ¬åœ°æ‹¿ï¼›è¦è€ƒé‡åˆ°é€™æƒ…æ³å¯¦ä½œæœƒéå¸¸è¤‡é›œã€‚</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" alt="åœ–ç‰‡å–è‡ªï¼š [iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMjQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>åœ–ç‰‡å–è‡ªï¼š <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset æ˜¯ weak æŒæœ‰ ResourceLoader Delegateï¼Œæ‰€ä»¥é€™é‚Šå»ºè­°è‡ªå·±å»ºç«‹ä¸€å€‹ AVURLAsset Class ç¹¼æ‰¿è‡ª AVURLAssetï¼Œåœ¨å…§éƒ¨å»ºç«‹ã€è³¦äºˆã€æŒæœ‰ ResourceLoader ï¼Œè®“ä»–è·Ÿè‘— AVURLAsset çš„ç”Ÿå‘½é€±æœŸï¼›å¦å¤–ä¹Ÿå¯ä»¥å„²å­˜åŸå§‹ URLã€CacheKey ç­‰è³‡è¨Šâ€¦ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>ä½¿ç”¨ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> æ˜¯ç”¨ä¾†åˆ¤æ–· URL æ˜¯å¦æ”¯æ´æ›æˆ‘å€‘çš„ Resource Loaderï¼ˆæ’é™¤ file:// ï¼‰ã€‚</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> å­˜æ”¾åŸå§‹è³‡æº URLã€‚</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> å­˜æ”¾é€™å€‹è³‡æºçš„ Cache Keyï¼Œé€™é‚Šç›´æ¥ç”¨æª”æ¡ˆåç¨±ç•¶ Cache Keyã€‚</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> è«‹ä¾ç…§ç¾å¯¦å ´æ™¯åšèª¿æ•´ï¼Œå¦‚æœæª”æ¡ˆåç¨±æœª hash å¯èƒ½é‡è¤‡å°±å»ºè­°å…ˆ hash å¾Œç•¶ key é¿å…ç¢°æ’ï¼›å¦‚æœè¦ hash æ•´å€‹ URL ç•¶ key ä¹Ÿè¦æ³¨æ„ URL æ˜¯å¦æœƒè®Šå‹• (ä¾‹å¦‚æœ‰ç”¨ CDN)ã€‚</p><p>Hash å¯ä½¿ç”¨ md5â€¦sha. .ï¼ŒiOS â‰¥ 13 å¯ç›´æ¥ä½¿ç”¨ Apple çš„ <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a> ï¼Œå…¶ä»–å°±ä¸Š Github æ‰¾å§ï¼</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>é‡å° Remote Request çš„å°è£ï¼Œä¸»è¦æ˜¯æœå‹™ ResourceLoader ç™¼èµ·çš„è³‡æ–™è«‹æ±‚ã€‚</p><p><code class="language-plaintext highlighter-rouge">RequestType</code> ï¼šç”¨ä¾†å€åˆ†æ­¤ Request æ˜¯ ç¬¬ä¸€æ¬¡è«‹æ±‚æª”æ¡ˆè³‡è¨Š(contentInformation)ã€é‚„æ˜¯è«‹æ±‚è³‡æ–™(dataRequest)</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code> ï¼šè«‹æ±‚ Range ç¯„åœï¼Œend å¯æŒ‡å®šåˆ°å“ª(requestTo(Int64) )æˆ–å…¨éƒ¨(requestToEnd)ã€‚</p><p>æª”æ¡ˆè³‡è¨Šå¯ç”±ï¼š</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>ä¸­å–å¾— Response Headerï¼Œå¦å¤–è¦æ³¨æ„å¦‚æœè¦æ”¹ HEAD å»æ‘¸ï¼Œä¸æœƒé€²é€™å€‹è¦ç”¨å…¶ä»–æ–¹æ³•æ¥ã€‚</p><ul><li><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code> ï¼šçœ‹ Response Header ä¸­çš„ <strong>Accept-Ranges == bytes</strong><li><code class="language-plaintext highlighter-rouge">contentType</code> ï¼šæ’­æ”¾å™¨è¦çš„æª”æ¡ˆé¡å‹è³‡è¨Šï¼Œæ ¼å¼æ˜¯çµ±ä¸€é¡è­˜åˆ¥ç¬¦ï¼Œä¸æ˜¯ audio/mpeg ï¼Œè€Œæ˜¯å¯«ä½œ public.mp3<li><code class="language-plaintext highlighter-rouge">contentLength</code> ï¼šçœ‹ Response Header ä¸­çš„ <strong>Content-Range</strong> ï¼šbytes 0â€“1/ <strong>è³‡æºç¸½é•·åº¦</strong></ul><blockquote><p><em>âš ï¸é€™é‚Šè¦æ³¨æ„ä¼ºæœå™¨çµ¦çš„æ ¼å¼å¤§å°å¯«ï¼Œä¸ä¸€å®šæ˜¯å¯«ä½œ Accept-Ranges/Content-Rangeï¼›æœ‰çš„ä¼ºæœå™¨çš„æ ¼å¼æ˜¯å°å¯« accept-rangesã€Accept-rangesâ€¦</em></p></blockquote><p><strong>è£œå……ï¼šå¦‚æœè¦è€ƒé‡å¤§å°å¯«å¯ä»¥å¯« HTTPURLResponse Extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="o">||</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ä½¿ç”¨ï¼š</p><ul><li>contentLength = response.parseContentLengthFromContentRange( )<li>isByteRangeAccessSupported = response.parseAcceptRanges( )<li>contentType = response.mimeTypeUTI( )</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>åŒå‰å°çŸ¥è­˜æ‰€è¿°ï¼Œæœƒå¯¦æ™‚å–å¾—å·²ä¸‹è¼‰çš„è³‡æ–™ï¼Œæ‰€ä»¥é€™å€‹æ–¹æ³•æœƒä¸€ç›´é€²ï¼Œç‰‡æ®µç‰‡æ®µçš„æ‹¿åˆ° Dataï¼›æˆ‘å€‘å°‡ä»– append é€² <code class="language-plaintext highlighter-rouge">downloadedData</code> å­˜æ”¾ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>ä»»å‹™å–æ¶ˆæˆ–çµæŸæ™‚éƒ½æœƒé€²é€™å€‹æ–¹æ³•ï¼Œåœ¨é€™å°‡å·²ä¸‹è¼‰çš„è³‡æ–™ä¿å­˜ä¸‹ä¾†ã€‚</p><p>å¦‚å‰å°çŸ¥è­˜ä¸­æåˆ°çš„ Cancel æ©Ÿåˆ¶ï¼Œå› æ’­æ”¾å™¨åœ¨æ‹¿åˆ°è¶³å¤ è³‡æ–™å¾Œå°±æœƒç™¼èµ· Cancelï¼ŒCancel Requestï¼›æ‰€ä»¥é€²åˆ°é€™å€‹æ–¹æ³•æ™‚å¯¦éš›æœƒæ˜¯ <code class="language-plaintext highlighter-rouge">error = NSURLErrorCancelled</code> ï¼Œå› æ­¤ä¸ç®¡ error æˆ‘å€‘æœ‰æ‹¿åˆ°è³‡æ–™éƒ½æœƒå˜—è©¦å­˜ä¸‹ä¾†ã€‚</p><blockquote><p><em>âš ï¸ å›  URLSession æœƒç”¨ä¸¦è¡Œæ–¹å¼å‡ºå»è«‹æ±‚è³‡æ–™ï¼Œæ‰€ä»¥è«‹ä¿æŒæ“ä½œéƒ½åœ¨DispatchQueueè£¡ï¼Œé¿å…è³‡æ–™éŒ¯äº‚(è³‡æ–™éŒ¯äº‚ä¸€æ¨£æœƒå‡ºç¾å¯æ€•çš„æ’­æ”¾é¬¼ç•œ)ã€‚</em></p></blockquote><blockquote><p><em>ï¸ï¸âš ï¸URLSession æ²’æœ‰å‘¼å« <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> æˆ– <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code> å…©å€‹æ–¹æ³•éƒ½æœƒå¼·æŒæœ‰ç‰©ä»¶å°è‡´ Memory Leakï¼›æ‰€ä»¥ä¸ç®¡æ˜¯å–æ¶ˆæˆ–æ˜¯å®Œæˆæˆ‘å€‘éƒ½è¦å‘¼å«ï¼Œé€™æ¨£æ‰èƒ½åœ¨ä»»å‹™çµæŸé‡‹æ”¾ Requestã€‚</em></p></blockquote><blockquote><p><em>ï¸ï¸âš ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸ï¸å¦‚æœæ€• <code class="language-plaintext highlighter-rouge">downloadedData</code> OOMï¼Œå¯ä»¥åœ¨ didReceive Data ä¸­å°±å­˜å…¥æœ¬åœ°ã€‚</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                       <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil å‰‡ä»£è¡¨æ˜¯ç¬¬ä¸€æ¬¡è«‹æ±‚ï¼Œæ’­æ”¾å™¨è¦æ±‚å…ˆçµ¦æª”æ¡ˆè³‡è¨Šã€‚</p><p>è«‹æ±‚æª”æ¡ˆè³‡è¨Šæ™‚æˆ‘å€‘éœ€è¦è³¦äºˆé€™ä¸‰é …è³‡è¨Šï¼š</p><ul><li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code> ï¼šæ˜¯å¦æ”¯æ´ Range æ‹¿ Data<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code> ï¼šçµ±ä¸€é¡è­˜åˆ¥ç¬¦<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code> ï¼šæª”æ¡ˆç¸½é•·åº¦ Int64</ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> å¯å–å¾—è¦æ±‚ Range çš„èµ·å§‹ offsetã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> å¯å–å¾—è¦æ±‚ Range çš„é•·åº¦ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true å‰‡ä¸ç®¡è¦æ±‚ Range çš„é•·åº¦ï¼Œç›´æ¥æ‹¿åˆ°åº•ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> è¿”å›å·²è¼‰å…¥çš„ Data çµ¦æ’­æ”¾å™¨ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> å¯å–å¾—ç•¶å‰ data offsetï¼Œ <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> å¾Œ <code class="language-plaintext highlighter-rouge">currentOffset</code> æœƒè·Ÿè‘—æ¨ç§»ã€‚</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> è³‡æ–™éƒ½è¼‰å®Œäº†ï¼Œå‘ŠçŸ¥æ’­æ”¾å™¨ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>æ’­æ”¾å™¨è«‹æ±‚è³‡æ–™ï¼Œæˆ‘å€‘å…ˆçœ‹æœ¬åœ° Cache æœ‰ç„¡è³‡æ–™ï¼Œæœ‰å‰‡è¿”å›ï¼›è‹¥åªæœ‰éƒ¨åˆ†è³‡æ–™å‰‡ä¸€æ¨£è¿”å›éƒ¨åˆ†ï¼Œä¾‹å¦‚æˆ‘æœ¬åœ°æœ‰ 0â€“100 ï¼Œæ’­æ”¾å™¨è¦æ±‚ 0â€“200ï¼Œå‰‡å…ˆè¿”å› 0â€“100ã€‚</p><p>è‹¥æ²’æœ‰æœ¬åœ° Cacheã€è¿”å›çš„è³‡æ–™ä¸å¤ ï¼Œå‰‡æœƒç™¼èµ· ResourceLoaderRequest è«‹æ±‚å¾ç¶²è·¯æ‹¿è³‡æ–™ã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>æ’­æ”¾å™¨å–æ¶ˆè«‹æ±‚ï¼Œå–æ¶ˆ ResourceLoaderRequestã€‚</p><blockquote><p><em>ä½ å¯èƒ½æœ‰ç™¼ç¾</em> <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> <em>çš„ offset æ˜¯çœ‹ <code class="language-plaintext highlighter-rouge">currentOffset</code> ï¼Œå› ç‚ºæˆ‘å€‘æœƒå…ˆå¾æœ¬åœ° <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code> å·²ä¸‹è¼‰ Dataï¼›æ‰€ä»¥ç›´æ¥çœ‹æ¨ç§»å¾Œçš„ offset å³å¯ã€‚</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>âš ï¸ requests æœ‰çš„ç¯„ä¾‹æ˜¯åªç”¨ <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> ä¾†å­˜æ”¾ï¼Œé€™æœƒæœ‰å€‹å•é¡Œï¼Œå› ç‚ºå¯èƒ½ç•¶å‰çš„ request æ­£åœ¨æ‹¿å–ï¼Œä½¿ç”¨è€…åˆ seek é€™æ™‚æœƒå–æ¶ˆèˆŠçš„ç™¼èµ·æ–°çš„ï¼›ä½†å› ä¸ä¸€å®šæœƒç…§é †åºç™¼ç”Ÿï¼Œå¯èƒ½å…ˆèµ°ç™¼æ–°è«‹æ±‚å†èµ°å–æ¶ˆï¼›æ‰€ä»¥ç”¨ Dictionary å»å­˜å–æ“ä½œé‚„æ˜¯æ¯”è¼ƒå®‰å…¨ï¼</em></p></blockquote><blockquote><p><em>âš ï¸è®“æ‰€æœ‰æ“ä½œéƒ½åœ¨åŒå€‹ DispatchQueue é˜²æ­¢å‡ºç¾è³‡æ–™é¬¼ç•œã€‚</em></p></blockquote><p><strong>deinit æ™‚å–æ¶ˆæ‰€æœ‰é‚„åœ¨è«‹æ±‚çš„ requests</strong> Resource Loader Deinit å³ä»£è¡¨ AVURLAsset Deinitï¼Œä»£è¡¨æ’­æ”¾å™¨å·²ç¶“ä¸éœ€è¦é€™å€‹è³‡æºäº†ï¼›æ‰€ä»¥æˆ‘å€‘å¯ä»¥ Cancel é‚„åœ¨å–è³‡æ–™çš„ Requestï¼Œå·²ç¶“è¼‰çš„ä¸€æ¨£æœƒå¯«å…¥ Cacheã€‚</p><h3 id="è£œå……åŠé³´è¬"><span class="me-2">è£œå……åŠé³´è¬</span><a href="#è£œå……åŠé³´è¬" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æ„Ÿè¬ <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex æ±¤</a> å¤§å¤§æŒ‡é»ã€‚</p><p>æ„Ÿè¬ <a href="https://medium.com/u/aab116fd9d4d" target="_blank">å¤–å­«å¥³</a> æä¾›é–‹ç™¼ä¸Šçš„æ„è¦‹åŠæ”¯æŒã€‚</p><h4 id="æœ¬ç¯‡åªé‡å°éŸ³æ¨‚å°æª”"><span class="me-2">æœ¬ç¯‡åªé‡å°éŸ³æ¨‚å°æª”</span><a href="#æœ¬ç¯‡åªé‡å°éŸ³æ¨‚å°æª”" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å½±ç‰‡å¤§æª”æ¡ˆå¯èƒ½æœƒåœ¨ downloadedDataã€AssetData/PINCacheAssetDataManager ç™¼ç”Ÿ Out Of Memory å•é¡Œã€‚</p><p>åŒå‰è¿°ï¼Œå¦‚æœè¦è§£æ±ºé€™å€‹å•é¡Œè«‹ä½¿ç”¨ fileHandler seek read/wirte å»æ“ä½œæœ¬åœ° Cache è®€å–å¯«å…¥ï¼ˆå–ä»£AssetData/PINCacheAssetDataManagerï¼‰ï¼›æˆ–æ‰¾çœ‹çœ‹ Github æœ‰æ²’æœ‰å¤§ data write/read to file çš„å°ˆæ¡ˆå¯ç”¨ã€‚</p><h4 id="avqueueplayer-åˆ‡æ›æ’­æ”¾é …ç›®æ™‚å–æ¶ˆæ­£åœ¨ä¸‹è¼‰çš„é …ç›®"><span class="me-2">AVQueuePlayer åˆ‡æ›æ’­æ”¾é …ç›®æ™‚å–æ¶ˆæ­£åœ¨ä¸‹è¼‰çš„é …ç›®</span><a href="#avqueueplayer-åˆ‡æ›æ’­æ”¾é …ç›®æ™‚å–æ¶ˆæ­£åœ¨ä¸‹è¼‰çš„é …ç›®" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>åŒå‰å°çŸ¥è­˜ä¸­æ‰€è¿°ï¼Œåœ¨æ›´æ›æ’­æ”¾ç›®æ¨™æ™‚æ˜¯ä¸æœƒç™¼èµ· Cancel çš„ï¼›å¦‚æœæ˜¯ AVPlayer æœƒèµ° AVURLAsset Deinit æ‰€ä»¥ä¸‹è¼‰ä¹Ÿæœƒä¸­æ–·ï¼›ä½† AVQueuePlayer ä¸æœƒï¼Œå› ç‚ºéƒ½é‚„åœ¨ Queue è£¡ï¼Œåªæ˜¯æ’­æ”¾ç›®æ¨™æ›åˆ°ä¸‹ä¸€é¦–è€Œå·²ã€‚</p><p>é€™é‚Šå”¯ä¸€åšæ³•å°±åªèƒ½æ¥æ”¶è®Šæ›æ’­æ”¾ç›®æ¨™é€šçŸ¥ï¼Œç„¶å¾Œåœ¨æ”¶åˆ°é€šçŸ¥å¾Œå–æ¶ˆä¸Šä¸€æ‰‹çš„ AVURLAsset loadingã€‚</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="éŸ³è¨Šè³‡æ–™åŠ è§£å¯†"><span class="me-2">éŸ³è¨Šè³‡æ–™åŠ è§£å¯†</span><a href="#éŸ³è¨Šè³‡æ–™åŠ è§£å¯†" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>éŸ³è¨ŠåŠ è§£å¯†å¯åœ¨ ResourceLoaderRequest ä¸­æ‹¿åˆ° Data é€²è¡Œã€é‚„æœ‰å„²å­˜æ™‚èƒ½åœ¨ AssetData çš„ encode/decode å°å­˜åœ¨æœ¬åœ°çš„ Dataé€²è¡ŒåŠ è§£å¯†ã€‚</p><p><strong>CryptoKit SHA ä½¿ç”¨ç¯„æœ¬ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-ç›¸é—œæ“ä½œ"><span class="me-2">PINCache ç›¸é—œæ“ä½œ</span><a href="#pincache-ç›¸é—œæ“ä½œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache åŒ…å« PINMemoryCache å’Œ PINDiskCacheï¼ŒPINCache æœƒå¹«æˆ‘å€‘è™•ç†å¾æª”æ¡ˆè®€åˆ° Memory æˆ–å¾ Memory å¯«å…¥æª”æ¡ˆçš„äº‹ï¼Œæˆ‘å€‘åªéœ€è¦å° PINCache é€²è¡Œæ“ä½œã€‚</p><p>åœ¨æ¨¡æ“¬å™¨ä¸­æŸ¥æ‰¾ Cache æª”æ¡ˆä½ç½®ï¼š</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzgiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> å–å¾—æ¨¡æ“¬å™¨æª”æ¡ˆè·¯å¾‘</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Finder -&gt; å‰å¾€ -&gt; è²¼ä¸Šè·¯å¾‘</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>åœ¨ Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader å°±æ˜¯æˆ‘å€‘å»ºçš„ Resource Loader Cache ç›®éŒ„ã€‚</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: â€œResourceLoaderâ€)</code> å…¶ä¸­çš„ name å°±æ˜¯ç›®éŒ„åç¨±ã€‚</p><p>ä¹Ÿå¯ä»¥æŒ‡å®š rootPath ï¼Œç›®éŒ„å°±å¯ä»¥æ”¹åˆ° Documents åº•ä¸‹ï¼ˆä¸æ€•è¢«ç³»çµ±æ¸…æ‰ï¼‰ã€‚</p><p><strong>è¨­å®š PINCache æœ€å¤§ä¸Šé™ï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" alt="ç³»çµ±é è¨­ä¸Šé™" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMzYiIGhlaWdodD0iODkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>ç³»çµ±é è¨­ä¸Šé™</p><p>è¨­ 0 çš„è©±å°±ä¸æœƒä¸»å‹•åˆªé™¤æª”æ¡ˆã€‚</p><h3 id="å¾Œè¨˜"><span class="me-2">å¾Œè¨˜</span><a href="#å¾Œè¨˜" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>åŸå…ˆå¤ªå°çœ‹é€™å€‹åŠŸèƒ½çš„å›°é›£åº¦ï¼Œä»¥ç‚ºä¸‰å…©ä¸‹å°±èƒ½è™•ç†å¥½ï¼›çµæœåƒç›¡è‹¦é ­ï¼Œå¤§æ¦‚åˆå¤šèŠ±äº†å…©é€±è™•ç†è³‡æ–™å„²å­˜çš„å•é¡Œï¼Œä¸éä¹Ÿå°±æ­¤å¾¹åº•äº†è§£æ•´å€‹ Resource Loader é‹ä½œæ©Ÿåˆ¶ã€ GCD ã€Dataã€‚</p><h3 id="åƒè€ƒè³‡æ–™"><span class="me-2">åƒè€ƒè³‡æ–™</span><a href="#åƒè€ƒè³‡æ–™" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>æœ€å¾Œé™„ä¸Šç ”ç©¶å¦‚ä½•å¯¦ä½œçš„åƒè€ƒè³‡æ–™</p><ol><li><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°</a> åƒ…è¬›åŸç†<li><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">åŸºäºAVPlayerå®ç°éŸ³è§†é¢‘æ’­æ”¾å’Œç¼“å­˜ï¼Œæ”¯æŒè§†é¢‘ç”»é¢çš„åŒæ­¥è¾“å‡º</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] æœ‰é™„ç¨‹å¼ï¼ˆå¾ˆå®Œæ•´ï¼Œä½†å¾ˆè¤‡é›œï¼‰<li><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> ï¼ˆç°¡æ˜“å¯¦ç¾ï¼Œè¼ƒå¥½æ‡‚ä½†ä¸å®Œæ•´ï¼‰<li><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">å¯èƒ½æ˜¯ç›®å‰æœ€å¥½çš„ AVPlayer éŸ³è§†é¢‘ç¼“å­˜æ–¹æ¡ˆ AVAssetResourceLoaderDelegate</a><li><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">ä»¿æŠ–éŸ³ Swift ç‰ˆ</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ]ï¼ˆè »æœ‰æ„æ€çš„å°ˆæ¡ˆï¼Œå¾©åˆ»æŠ–éŸ³ APPï¼›è£¡é¢ä¹Ÿæœ‰ç”¨åˆ° Resource Loaderï¼‰<li><a href="/posts/zrealm-dev/ios-hls-cache-å¯¦ä½œå…¨æ”»ç•¥-avplayer-ä¸²æµé‚Šæ’­é‚Šå¿«å–æŠ€è¡“è§£æ-d796bf8e661e/">iOS HLS Cache å¯¦è¸æ–¹æ³•æ¢ç©¶ä¹‹æ—…</a></ol><h3 id="å»¶ä¼¸"><span class="me-2">å»¶ä¼¸</span><a href="#å»¶ä¼¸" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C ç‰ˆ)</ul><p>æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ <a href="https://www.zhgchg.li/contact" target="_blank">èˆ‡æˆ‘è¯çµ¡</a> ã€‚</p><hr /><blockquote class="prompt-info"><p>æœ¬æ–‡é¦–æ¬¡ç™¼è¡¨æ–¼ Medium â¡ï¸ <a href="https://medium.com/p/6ce488898003" target="_blank"><strong>å‰å¾€æŸ¥çœ‹</strong></a>ï¼Œç”± <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> èˆ‡ <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a> æä¾›è‡ªå‹•è½‰æ›èˆ‡åŒæ­¥æŠ€è¡“ã€‚</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2021-01-31-6ce488898003.md" target="_blank">Improve this page on Github.</a></p></blockquote><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=ğŸº&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 4,998 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-20 | 4,903 Views on <a href="https://medium.com/p/6ce488898003" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E7%AF%80%E7%9C%81%20iOS%20%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E7%25AF%2580%25E7%259C%2581-ios-%25E9%259F%25B3%25E6%25A8%2582%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=AVPlayer%20%E6%9C%AC%E5%9C%B0%20Cache%20%E5%AF%A6%E4%BD%9C%E6%94%BB%E7%95%A5%EF%BD%9C%E4%BD%BF%E7%94%A8%20AVAssetResourceLoaderDelegate%20%E7%AF%80%E7%9C%81%20iOS%20%E9%9F%B3%E6%A8%82%E4%B8%B2%E6%B5%81%E6%B5%81%E9%87%8F%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E7%25AF%2580%25E7%259C%2581-ios-%25E9%259F%25B3%25E6%25A8%2582%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Favplayer-%25E6%259C%25AC%25E5%259C%25B0-cache-%25E5%25AF%25A6%25E4%25BD%259C%25E6%2594%25BB%25E7%2595%25A5-%25E4%25BD%25BF%25E7%2594%25A8-avassetresourceloaderdelegate-%25E7%25AF%2580%25E7%259C%2581-ios-%25E9%259F%25B3%25E6%25A8%2582%25E4%25B8%25B2%25E6%25B5%2581%25E6%25B5%2581%25E9%2587%258F-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxingï½œPremium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/apple-watch-%E7%B1%B3%E8%98%AD%E9%8C%B6%E5%B8%B6%E9%96%8B%E7%AE%B1-%E5%8E%9F%E5%BB%A0%E4%B8%8D%E9%8F%BD%E9%8B%BC%E7%9F%B3%E5%A2%A8%E8%89%B2%E5%84%AA%E7%BC%BA%E9%BB%9E%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch åŸå» ä¸é½é‹¼ç±³è˜­éŒ¶å¸¶é–‹ç®±</a><li class="text-truncate lh-lg"> <a href="/posts/travel-journals/en/busan-travel-guide-8-day-itinerary-with-visit-busan-pass-for-seamless-exploration-8ace34a1a3d8/">Busan Travel Guideï½œ8-Day Itinerary with VISIT BUSAN PASS for Seamless Exploration</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%87%9C%E5%B1%B1%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-8%E5%A4%A97%E5%A4%9C%E5%BF%85%E5%8E%BB%E6%99%AF%E9%BB%9E-%E7%BE%8E%E9%A3%9F%E8%88%87%E4%BA%A4%E9%80%9A%E5%85%A8%E8%A7%A3%E6%9E%90-%E9%87%9C%E5%B1%B1%E9%80%9A%E8%A1%8C%E8%AD%89%E7%9C%81%E9%8C%A2%E7%A7%98%E8%A8%A3-8ace34a1a3d8/">éŠè¨˜ 2025 éŸ“åœ‹é‡œå±± 8 å¤© 7 å¤œè‡ªç”±è¡Œ</a><li class="text-truncate lh-lg"> <a href="/posts/travel-journals/en/nagoya-one-day-quick-trip-peach-aviation-flight-experience-and-travel-tips-7b8a0563c157/">Nagoya One-Day Quick Tripï½œPeach Aviation Flight Experience and Travel Tips</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">iOS App Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios app development</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">Swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">ç« ç¯€ (Chapters)ğŸ”–</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer é‚Šæ’­é‚Š Cache æŠ€è¡“å¯¦æˆ°ï½œiOS æœ¬åœ°ç·©å­˜å„ªåŒ–æ”»ç•¥</h4><div class="text-muted"><p>é‡å° iOS é–‹ç™¼è€…é¢è‡¨ AVPlayer æ’­æ”¾æ™‚ç·©å­˜ä¸è¶³å•é¡Œï¼Œè§£æ AVAssetResourceLoaderDelegate å¯¦ä½œæŠ€å·§ï¼Œæœ‰æ•ˆæå‡æ’­æ”¾æµæš¢åº¦èˆ‡æœ¬åœ°ç·©å­˜æ•ˆç‡ï¼Œæ¸›å°‘é‡è¤‡ä¸‹è¼‰èˆ‡å»¶é²ï¼Œæ‰“é€ ç©©å®šéŸ³æ¨‚èˆ‡å½±ç‰‡æ’­æ”¾å™¨é«”é©—ã€‚</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-wkwebview-%E9%A0%90%E8%BC%89%E8%88%87-cache-%E7%B7%A9%E5%AD%98%E6%8A%80%E8%A1%93-%E6%8F%90%E5%8D%87%E9%A0%81%E9%9D%A2%E8%BC%89%E5%85%A5%E9%80%9F%E5%BA%A6%E8%88%87%E8%B3%87%E6%BA%90%E7%AE%A1%E7%90%86%E5%85%A8%E8%A7%A3%E6%9E%90-5033090c18ba/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1722160385" data-df="ll" > Jul 28, 2024 </time><h4 class="pt-0 my-2">iOS WKWebView é é¢èˆ‡æª”æ¡ˆè³‡æº Preload é è¼‰ / Cache ç·©å­˜ç ”ç©¶</h4><div class="text-muted"><p>iOS WKWebView é å…ˆä¸‹è¼‰èˆ‡ç·©å­˜è³‡æºæå‡é é¢è¼‰å…¥é€Ÿåº¦ç ”ç©¶ã€‚</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-hls-cache-%E5%AF%A6%E4%BD%9C%E5%85%A8%E6%94%BB%E7%95%A5-avplayer-%E4%B8%B2%E6%B5%81%E9%82%8A%E6%92%AD%E9%82%8A%E5%BF%AB%E5%8F%96%E6%8A%80%E8%A1%93%E8%A7%A3%E6%9E%90-d796bf8e661e/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586365937" data-df="ll" > Apr 9, 2020 </time><h4 class="pt-0 my-2">iOS HLS Cache å¯¦ä½œå…¨æ”»ç•¥ï½œAVPlayer ä¸²æµé‚Šæ’­é‚Šå¿«å–æŠ€è¡“è§£æ</h4><div class="text-muted"><p>é‡å° iOS AVPlayer æ’­æ”¾ HLS m3u8 ä¸²æµæ™‚ç„¡æ³•æ””æˆªå¿«å–çš„ç—›é»ï¼Œæ·±å…¥åˆ†æå¤šç¨®å¿«å–æ–¹æ¡ˆï¼Œå¾ AVAssetResourceLoaderDelegate åˆ° Reverse Proxy Serverï¼Œæ­ç¤ºæŠ€è¡“ç“¶é ¸èˆ‡å¯è¡Œè§£æ³•ï¼ŒåŠ©ä½ å„ªåŒ–ä¸²æµé«”é©—ä¸¦æœ‰æ•ˆç¯€çœä¼ºæœå™¨èˆ‡æµé‡æˆæœ¬ã€‚</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-development/en/avplayer-local-cache-implementation-master-avassetresourceloaderdelegate-for-smooth-playback-6ce488898003/" class="btn btn-outline-primary" aria-label="Older" ><p>AVPlayer Local Cache Implementationï½œMaster AVAssetResourceLoaderDelegate for Smooth Playback</p></a> <a href="/posts/zrealm-development/en/ios-cross-platform-account-integration-enhance-login-experience-beyond-sign-in-with-apple-948ed34efa09/" class="btn btn-outline-primary" aria-label="Newer" ><p>iOS Cross-Platform Account Integrationï½œEnhance Login Experience Beyond Sign in with Apple</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-21 00:25:10 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">iOS App Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios app development</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">Swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
