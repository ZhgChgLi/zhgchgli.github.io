<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作" /><meta name="author" content="ZhgChgLi<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align: middle;"><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/> </svg>" /><meta property="og:locale" content="en" /><meta name="description" content="針對開發者面臨後端推播統計不準確與 Server 壓力問題，解析如何運用 Firebase Firestore 與 Functions 快速搭建可測試的 API 服務，並示範完整 RESTful API 範例及分散式計數器設計，提升推播點擊率統計精準度與系統穩定性。" /><meta property="og:description" content="針對開發者面臨後端推播統計不準確與 Server 壓力問題，解析如何運用 Firebase Firestore 與 Functions 快速搭建可測試的 API 服務，並示範完整 RESTful API 範例及分散式計數器設計，提升推播點擊率統計精準度與系統穩定性。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-24T01:09:34+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" /><meta property="twitter:title" content="Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 640 640\" width=\"16\" height=\"16\" style=\"vertical-align: middle;\"><path fill=\"#007bff\" d=\"M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z\"/><path d=\"M250 330 l60 60 100 -140\" stroke=\"#ffffff\" stroke-width=\"40\" fill=\"none\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/> </svg>","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-14T00:34:17+08:00","datePublished":"2021-03-24T01:09:34+08:00","description":"針對開發者面臨後端推播統計不準確與 Server 壓力問題，解析如何運用 Firebase Firestore 與 Functions 快速搭建可測試的 API 服務，並示範完整 RESTful API 範例及分散式計數器設計，提升推播點擊率統計精準度與系統穩定性。","headline":"Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg1NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg==","url":"https://zhgchg.li/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/"},"url":"https://zhgchg.li/posts/zrealm-dev/firebase-firestore-functions-%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8-api-%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C-9659db1357e4/"}</script><title>Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作</h1><p class="post-desc fw-light mb-4">針對開發者面臨後端推播統計不準確與 Server 壓力問題，解析如何運用 Firebase Firestore 與 Functions 快速搭建可測試的 API 服務，並示範完整 RESTful API 範例及分散式計數器設計，提升推播點擊率統計精準度與系統穩定性。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1616519374" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 24, 2021 </time> </span> <span> Updated <time data-ts="1713026057" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" class="popup img-link preview-img blur"><img data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg1NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="vertical-align: middle;"><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/> </svg></a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4422 words" > <em>24 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Firebase Firestore｜Functions 快速打造測試用 API 服務教學與推播統計實作</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-info"><p><a href="/posts/en/9659db1357e4/"><strong>Click here</strong></a> to view the English version of this article, translated by OpenAI.</p></blockquote><blockquote class="prompt-tip"><p>基於 SEO 考量，本文標題與描述經 GPT 調整，原始版本請參考內文，若有不恰當的用語，敬請指正。</p></blockquote><hr /><h3 id="使用-firebase-firestore--functions-快速搭建可供測試的-api-服務"><span class="me-2">使用 Firebase Firestore + Functions 快速搭建可供測試的 API 服務</span><a href="#使用-firebase-firestore--functions-快速搭建可供測試的-api-服務" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>當推播統計遇上 Firebase Firestore + Functions</p><p><a href="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*RVPRxqz2VUuY7NGXSXzmtw.webp" alt="Photo by [Carlos Muza](https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg1NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@kmuza?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Carlos Muza</a></p><h3 id="前言"><span class="me-2">前言</span><a href="#前言" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="推播精確統計功能"><span class="me-2">推播精確統計功能</span><a href="#推播精確統計功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>最近想為 APP 導入的功能，未實作前我們只能從後端 Post 資料給 APNS/FCM 的成功與否當作推播基數並記錄推播點擊，計算出「點擊率」；但此方法其實非常不準確，基數包含許多無效裝置，APP 已刪除的（不一定會馬上失效）、關閉推播權限的在後端 Post 時都還是會得到成功的回傳。</p><p>在 iOS 10 之後可以透過實踐 Notification Service Extension 在推播橫幅出現時的時機點偷偷 Call API 回傳做統計；好處是非常精準，只有在使用者推播橫幅有出現才會 Call；如果 APP 刪除、關閉通知、通知沒開橫幅，都不會有動作，橫幅等於有出現推播訊息，用此當推播基數然後再算上點擊數就能得到「精確的點擊率」。</p><blockquote><p><em>詳細原理及實作方式可參考之前的文章：「 <a href="/posts/zrealm-dev/ios-notification-service-extension-swift-實作圖片推播與顯示統計技巧-cb6eba52a342/">i <strong>OS ≥ 10 Notification Service Extension 應用 (Swift)</strong></a> 」</em></p></blockquote><blockquote><p><em>目前測試下來 APP 的 Loss 率應該是 0%，實際常見應用像是 Line 的訊息點對點加解密（推播的訊息是加密過的，在手機收到才解密然後顯示出來）。</em></p></blockquote><h4 id="問題"><span class="me-2">問題</span><a href="#問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>APP 端的功其實不大，iOS/Android 都只要實作類似的功能（但 Android 如果要考慮中國市場就比較麻煩，要為更平台實作推播框架內容）；比較大的功是後端還有 Server 的壓力處理，因為推播一次出去會同時 Call API 回傳紀錄，可能會塞爆 Server 的 max connection 如果又是使用 RDBMS 儲存記錄可能會更嚴重，如果發現統計數有 Loss 多半發生在此環節。</p><blockquote><p><em>這邊可以以 log 寫檔案方式做紀錄，要查詢時在自行做統計顯示。</em></p></blockquote><blockquote><p><em>另外，後來想想一次出去同時回來的情境，數量可能沒有想像中的大；因為發推播也不會一口氣發個十萬百萬筆，也是幾筆幾筆批次發送；只要能扛住批次發出去同時回來的數量即可！</em></p></blockquote><h3 id="prototype"><span class="me-2">Prototype</span><a href="#prototype" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>因原先有問題中的考量，後端需要花功力研究修改且市場也不一定在意做出來的成效；所以想說先用能使用的資源弄個 Prototype 出來試試水溫。</p><p>這邊選擇的是 APP 幾乎都會使用的 Firebase 服務，其中的 Functions 和 Firestore 功能。</p><h4 id="firebase-functions"><span class="me-2">Firebase Functions</span><a href="#firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://developers.google.com/learn/topics/functions" target="_blank">Functions</a> 是 Google 提供的 serverless 服務，只需撰寫好程式邏輯，Google 自動幫你弄好伺服器、執行環境，也不用去管伺服器擴充及流量的問題。</p><p><a href="https://firebase.google.com/docs/functions" target="_blank">Firebase Functions</a> 其實就是 Google Cloud Functions 但只能使用 JavaScript (node.js) 撰寫，沒試過但如果用 Google Cloud Functions 選擇用其他語言撰寫然後同樣 import Firebase 服務我想應該也能用。</p><p>用在 API 就是我可以寫一個 node.js 檔案，得到一個實體 URL (ex: my-project.cloudfunctions.net/getUser)，自行撰寫取得 Request 資訊和給予相應的 Response 邏輯。</p><blockquote><p><em>之前寫過一篇關於 Google Functions 的文章「 <a href="/posts/zrealm-dev/python-搭配-google-cloud-platform-與-line-bot-打造每日自動簽到腳本與排程-70a1409b149a/">使用 Python+Google Cloud Platform+Line Bot 自動執行例行瑣事</a> 」</em></p></blockquote><blockquote><p><em>Firebase Functions 必須啟用 Blaze 專案（用多少、付多少）才能使用。</em></p></blockquote><p><a href="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*YqIJ1tr2Ay-oLVjSSU0zUg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MDkiIGhlaWdodD0iNTA3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="firebase-firestore"><span class="me-2">Firebase Firestore</span><a href="#firebase-firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://firebase.google.com/docs/firestore" target="_blank">Firebase Firestore</a> ，NoSql 資料庫，用來存放、管理數據。</p><p>結合 Firebase Functions 可在 Request 時 import Firestore 進來操作資料庫，然後Response 給使用者，就能搭建簡單的 Restful API 服務！</p><blockquote><p>動手實作開始！</p></blockquote><h3 id="安裝-nodejs-環境"><span class="me-2">安裝 node.js 環境</span><a href="#安裝-nodejs-環境" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>這邊建議使用 NVM，node.js 版本管理工具進行安裝管理（像 python 用 pyenv）。</p><p>到 NVM Github 專案複製安裝 shell script：</p><p><a href="https://github.com/nvm-sh/nvm#installing-and-updating" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612230/53a0c44a-1f6e-4f8d-918f-89762fafe369" alt="" loading="lazy"></a></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
</pre></table></code></div></div><p>如果安裝過程出現錯誤，請確認有 <code class="language-plaintext highlighter-rouge">~/.bashrc</code> 或 <code class="language-plaintext highlighter-rouge">~/.zshrc</code> 檔案，沒有可用 <code class="language-plaintext highlighter-rouge">touch ~/.bashrc</code> 或 <code class="language-plaintext highlighter-rouge">touch ~/.zshrc</code> 建立檔案然後再跑一下 install script。</p><p>再來就可以使用 <code class="language-plaintext highlighter-rouge">nvm install node</code> 安裝最新版的 node.js。</p><p><a href="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*5fxz4HD9q4feAqO0zXbojg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NzUiIGhlaWdodD0iMTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可下 <code class="language-plaintext highlighter-rouge">npm --version</code> 確認 npm 安裝成功、安裝版本：</p><p><a href="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*VHZMRFIDzFA9AxmsDNqNlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNDgiIGhlaWdodD0iMzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h3 id="部署-firebase-functions"><span class="me-2">部署 Firebase Functions</span><a href="#部署-firebase-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="安裝-firebase-tools"><span class="me-2">安裝 Firebase-tools：</span><a href="#安裝-firebase-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>npm <span class="nb">install</span> <span class="nt">-g</span> firebase-tools
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*POfMR0p1600iYqy8rzQkTQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MTIiIGhlaWdodD0iMjI1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>安裝成功後，第一次使用請先輸入：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase login
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*kqeECyXVPOq1cpKvcdOBeA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDQ5IiBoZWlnaHQ9IjIxMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>完成 Firebase 登入驗證。</p><p>啟動專案：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase init
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*Xx2grpX2PZb3wEFt9mQbNw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODIiIGhlaWdodD0iNTI1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>記下 Firebase init 所在路徑：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>You're about to initialize a Firebase project in this directory:
</pre></table></code></div></div><p>這邊可以選擇要安裝的 Firebase CLI 工具，按 「↑」「↓」進行選擇，「空白鍵」進行選擇；這邊可以只選擇「Functions」或連「Firestore」一起選擇安裝。</p><p><strong>=== Functions Setup</strong></p><p><a href="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*2gd9pAIdLAkJRhROpJtPKA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDYiIGhlaWdodD0iMTU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>語言選擇「 <strong>JavaScript</strong> 」<li>關於「use ESLint to catch probable bugs and enforce style」語法 style 檢查 ， <strong>YES / NO 都可</strong> 。<li>install dependencies with npm? <strong>YES</strong></ul><p><strong>===Emulators Setup</strong></p><p><a href="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*xHWp195BZIZdXyUd-ub78g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1ODAiIGhlaWdodD0iMjU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可在本地環境測試 Functions、Firestore 功能及設定，不會算在使用度且不需等到部署上線才能測試。</p><blockquote><p><em>依個人需求安裝，我有裝但沒有用．．．因為只是小功能而已。</em></p></blockquote><h3 id="coding"><span class="me-2">Coding!</span><a href="#coding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>前往上述記下的路徑，找到 <code class="language-plaintext highlighter-rouge">functions 資料夾</code> ，用編輯器打開裡面的 <code class="language-plaintext highlighter-rouge">index.js</code> 檔案。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">hello</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">targetID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">targetID</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">action</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">targetID</span><span class="dl">"</span><span class="p">:</span> <span class="nx">targetID</span><span class="p">,</span> <span class="dl">"</span><span class="s2">action</span><span class="dl">"</span><span class="p">:</span> <span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="nx">name</span><span class="p">});</span>
    <span class="k">return</span>
<span class="p">})</span>
</pre></table></code></div></div><p>貼上以上內容，我們定義了一個路徑接口 <code class="language-plaintext highlighter-rouge">/hello</code> 然後會回傳 URL <strong>Query</strong> <code class="language-plaintext highlighter-rouge">?targetID=</code> 、 <strong>POST</strong> <code class="language-plaintext highlighter-rouge">action</code> 、 <code class="language-plaintext highlighter-rouge">name</code> 參數資訊。</p><p>修改＆儲存完成後回到 console 下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>firebase deploy
</pre></table></code></div></div><blockquote><p><strong><em>以後的每次修改都記得要回來下 <code class="language-plaintext highlighter-rouge">firebase deploy</code> 指令，才會生效。</em></strong></p></blockquote><p>開始驗證＆部署到 Firebase…</p><p><a href="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*hUdvD4ANKD3s73mLWNZZOQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjciIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可能需要稍等一下， <code class="language-plaintext highlighter-rouge">Deploy complete!</code> 後你的第一個 Request &amp; Response 網頁就完成了！</p><p>這時候可以回到 Firebase -&gt; Functions 頁面：</p><p><a href="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*SY4iJZL6gDEZ5AEcepIpMA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjI0NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>就會看到剛剛撰寫的接口和網址位置。</p><p>複製下方網址貼到 PostMan 測試：</p><p><a href="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*OMfLkdg12QHsp-yc9RkKvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDUiIGhlaWdodD0iNTExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><em>POST Body 記得選擇 <code class="language-plaintext highlighter-rouge">x-www-form-urlencoded</code> 。</em></p></blockquote><p><strong>成功！</strong></p><h3 id="log"><span class="me-2">Log</span><a href="#log" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>我們可以在程式碼中使用：</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">functions</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">log:</span><span class="dl">"</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</pre></table></code></div></div><p>進行 Log 紀錄。</p><p>並可在 Firebase -&gt; Functions -&gt; 紀錄中查看 log 結果：</p><p><a href="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*Wi-4MbPh2tVJ_utdhzN4_A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijc2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h3 id="example-goal"><span class="me-2">Example Goal</span><a href="#example-goal" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>建立一個可新增、修改、刪除、查詢文章和按讚的 API</p></blockquote><p>我們希望能達成 Restful API 的功能設計，所以不能再使用上面範例的純 Path 方式，要改藉用 <code class="language-plaintext highlighter-rouge">Express</code> 框架達成。</p><h4 id="post-新增文章"><span class="me-2">POST 新增文章</span><a href="#post-新增文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// 這邊的 POST 指的是 HTTP Method POST</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span> <span class="c1">// 這邊的 POST 指的是 /post 路徑</span>
</pre></table></code></div></div><p>現在我們改用 Express 來處理網路請求，這邊先新增一個 路徑 <code class="language-plaintext highlighter-rouge">/ 的 POST</code> 方法，最後一行表示路徑都在 <code class="language-plaintext highlighter-rouge">/post</code> 之下，再來我們會加上修改、刪除的 API。</p><p>下 <code class="language-plaintext highlighter-rouge">firebase deploy</code> 部署成功後，回到 Post Man 測試：</p><p><a href="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*yVAjhlr6wLdONeG7nY0VEw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NTIiIGhlaWdodD0iNDI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Post Man 打成功後可以再到 Firebase -&gt; Firestore 檢查一下資料是否有正確寫入：</p><p><a href="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*xYVrRdFro3bQVHx05JUaTw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjYxMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="put-修改文章"><span class="me-2">PUT 修改文章</span><a href="#put-修改文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">修改成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>部署＆測試方式如新增，Post Man Http Method 記得改成 <code class="language-plaintext highlighter-rouge">PUT</code> 。</p><h4 id="delete-刪除文章"><span class="me-2">DELETE 刪除文章</span><a href="#delete-刪除文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">文章成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">})</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>部署＆測試方式如新增，Post Man Http Method 記得改成 <code class="language-plaintext highlighter-rouge">DELETE</code> 。</p><p>新增、修改、刪除做完了，來做查詢！</p><h4 id="select-查詢文章"><span class="me-2">SELECT 查詢文章</span><a href="#select-查詢文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*n_mI4l1EmhpWK8M_FbrzbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDQiIGhlaWdodD0iNjAzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>部署＆測試方式如新增，Post Man Http Method 記得改成 <code class="language-plaintext highlighter-rouge">GET</code> 還有將 <code class="language-plaintext highlighter-rouge">Body</code> 切回 <code class="language-plaintext highlighter-rouge">none</code> 。</p><h4 id="insertorupdate"><span class="me-2">InsertOrUpdate?</span><a href="#insertorupdate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>有時候我們需要當值存在時做更新，當值不存在時新增，這時候可以用 <code class="language-plaintext highlighter-rouge">set</code> 搭配 <code class="language-plaintext highlighter-rouge">merge: true</code> ：</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>這邊以新增 tag 為例，部署＆測試方式如新增，可以看到 Firestore 不會一直重複新增新資料。</p><p><a href="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*qkTMGjC0EkrMO85-6pQFwg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU3OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="文章按讚計數器"><span class="me-2">文章按讚計數器</span><a href="#文章按讚計數器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>假設我們的文章資料現在多一個 <code class="language-plaintext highlighter-rouge">likeCount</code> 欄位紀錄按讚數量，那我們該怎麼做呢？</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按讚成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p>運用 <code class="language-plaintext highlighter-rouge">increment</code> 這個變數就能直接做到取出值 +1 的動作。</p><h4 id="大流量文章按讚計數器"><span class="me-2">大流量文章按讚計數器</span><a href="#大流量文章按讚計數器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因為 Firestore 有 <a href="https://cloud.google.com/firestore/quotas?hl=zh-tw#soft_limits" target="_blank">寫入速度限制</a> 的：</p><p><a href="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*U9ubGe3M8XEdx9XGAV8nfA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4ODgiIGhlaWdodD0iNzAzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>一個文檔一秒只能寫入一次</strong> ，所以當按讚的人一多；同時請求下可能會變得很慢。</p><p>官方給的解決方法「 <a href="https://cloud.google.com/firestore/docs/solutions/counters#node.js_2" target="_blank">Distributed counters</a> 」其實也沒什麼高深的技術，就是多用幾個分散的 likeCount 欄位來統計，然後讀取的時候再加總起來。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按讚成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*GhNEcWUjgvYRYCMBk1DayA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU3NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>以上就是分散出欄位來紀錄 Count 避免寫入太慢；但如果分散的欄位太多會增加讀取成本($$)，但應該還是比每次按讚都 add 一筆新紀錄還便宜。</p><h4 id="使用-siege-工具進行壓力測試"><span class="me-2">使用 Siege 工具進行壓力測試</span><a href="#使用-siege-工具進行壓力測試" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>使用 <code class="language-plaintext highlighter-rouge">brew</code> 安裝 <code class="language-plaintext highlighter-rouge">siege</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>brew <span class="nb">install </span>siege
</pre></table></code></div></div><p><em>p.s 如果你出現 brew: command not found 請先安裝 <a href="https://brew.sh/index_zh-tw" target="_blank">brew</a> 套件管理工具</em> ：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/usr/bin/ruby <span class="nt">-e</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/master/install<span class="si">)</span><span class="s2">"</span>
</pre></table></code></div></div><p>安裝完成後可下：</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>siege <span class="nt">-c</span> 100 <span class="nt">-r</span> 1 <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="s1">'https://us-central1-project.cloudfunctions.net/post/like/id POST {}'</span>
</pre></table></code></div></div><p>進行壓力測試：</p><ul><li><code class="language-plaintext highlighter-rouge">-c 100</code> ：100 個任務同步執行<li><code class="language-plaintext highlighter-rouge">-r 1</code> ：每個任務執行 1 次請求<li><code class="language-plaintext highlighter-rouge">-H ‘Content-Type: application/json’</code> ：如果是 POST 時需加上<li><code class="language-plaintext highlighter-rouge">‘https://us-central1-project.cloudfunctions.net/post/like/id POST {}’</code> ：POST 網址、Post Body (ex: <code class="language-plaintext highlighter-rouge">{“name”:”1234”}</code> )</ul><p>執行完成後可看到執行結果：</p><p><a href="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*BUcMfJJ4x_mgK0HHLc6C4g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzODYiIGhlaWdodD0iMTk4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><code class="language-plaintext highlighter-rouge">successful_transactions: 100</code> 表示 100 次都執行成功。</p><p><strong>可以回 Firebase -&gt; Firestore 查看結果是否有 Loss Data：</strong></p><p><a href="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*wd5z743Zp9xtjKhhcMaVOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY5IiBoZWlnaHQ9IjYwOSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>成功！</p></blockquote><h4 id="完整-example-code"><span class="me-2">完整 Example Code</span><a href="#完整-example-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="c1">// Insert</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">,</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">add</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Update</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">author</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">author</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span> 
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">title</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">content</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">author</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">post</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">:</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">:</span><span class="nx">content</span><span class="p">,</span> <span class="dl">"</span><span class="s2">author</span><span class="dl">"</span><span class="p">:</span> <span class="nx">author</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">update</span><span class="p">(</span><span class="nx">post</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">修改成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Delete</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">posts</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="k">delete</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">文章成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select List</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">();</span>
      <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">data</span><span class="p">})</span>
    <span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:</span><span class="nx">result</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Select One</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">result</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="nx">doc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">...</span><span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">()}});</span>
<span class="p">});</span>

<span class="c1">// InsertOrUpdate</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tag</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">name</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="nx">name</span><span class="p">};</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">tags</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">新增成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">set</span><span class="p">({</span><span class="na">likeCount</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按讚成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Distributed counters Like Post</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/like2/:id</span><span class="dl">"</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">doc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">找不到文章！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">//1~10</span>
    <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCounter</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">likeCount_</span><span class="dl">"</span><span class="o">+</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
    <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">按讚成功！</span><span class="dl">"</span><span class="p">});</span>
<span class="p">});</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">post</span><span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="回歸主題推播統計"><span class="me-2">回歸主題，推播統計</span><a href="#回歸主題推播統計" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>回到一開始我們想做的，推播統計功能。</p><p>index.js:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">functions</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-functions</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">firebase-admin</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cors</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="nx">admin</span><span class="p">.</span><span class="nf">initializeApp</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">({</span> <span class="na">origin</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="kd">const</span> <span class="nx">vaildPlatformTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">iOS</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Android</span><span class="dl">"</span><span class="p">]</span>
<span class="kd">const</span> <span class="nx">vaildActionTypes</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">]</span>

<span class="c1">// Insert Log</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">increment</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nf">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">platformType</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">platformType</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">pushID</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">pushID</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">actionType</span> <span class="o">=</span>  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">actionType</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">vaildPlatformTypes</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">platformType</span><span class="p">)</span> <span class="o">||</span> <span class="nx">pushID</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="o">!</span><span class="nx">vaildActionTypes</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">actionType</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">參數錯誤！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">platformType</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="nx">actionType</span><span class="o">+</span><span class="dl">"</span><span class="s2">_</span><span class="dl">"</span><span class="o">+</span><span class="nx">pushID</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">doc</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">())</span>
        <span class="p">.</span><span class="nf">set</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="nx">increment</span><span class="p">},</span> <span class="p">{</span><span class="na">merge</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">紀錄成功！</span><span class="dl">"</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// View Log</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:type/:id</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// received</span>
    <span class="kd">const</span> <span class="nx">receivedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">received_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">receivedDocs</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">received</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="c1">// clicked</span>
    <span class="kd">const</span> <span class="nx">clickedDocs</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nf">firestore</span><span class="p">().</span><span class="nf">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span><span class="p">).</span><span class="nf">doc</span><span class="p">(</span><span class="dl">"</span><span class="s2">clicked_</span><span class="dl">"</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">shards</span><span class="dl">"</span><span class="p">).</span><span class="nf">get</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">clicked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">clickedDocs</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">doc</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">clicked</span> <span class="o">+=</span> <span class="nx">doc</span><span class="p">.</span><span class="nf">data</span><span class="p">().</span><span class="nx">count</span><span class="p">;</span>
    <span class="p">});</span>
    
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nf">send</span><span class="p">({</span><span class="dl">"</span><span class="s2">received</span><span class="dl">"</span><span class="p">:</span><span class="nx">received</span><span class="p">,</span><span class="dl">"</span><span class="s2">clicked</span><span class="dl">"</span><span class="p">:</span><span class="nx">clicked</span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">notification</span> <span class="o">=</span> <span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nf">onRequest</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</pre></table></code></div></div><h4 id="新增推播紀錄"><span class="me-2">新增推播紀錄</span><a href="#新增推播紀錄" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*3koe6QBxF9oOhBDqjF5mhA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NDciIGhlaWdodD0iNDIyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="檢視推播統計數字"><span class="me-2">檢視推播統計數字</span><a href="#檢視推播統計數字" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://us-centra1-xxx.cloudfunctions.net/notification/iOS/1
</pre></table></code></div></div><p><a href="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*SStEkNoDjiL7pffC2pHDkQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDE3IiBoZWlnaHQ9IjQ4NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>另外也做了個介面統計推播數字。</p><h4 id="踩坑"><span class="me-2">踩坑</span><a href="#踩坑" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>因為對 node.js 用法不太熟悉，一開始摸索的時候在 add 資料時沒加上 <code class="language-plaintext highlighter-rouge">await</code> 再加上寫入速度限制，導致在大流量情況下會 Data Loss…</em></p></blockquote><p><a href="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*dVsBhKJQ3qqxlSvv-mCENA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NDUiIGhlaWdodD0iMTg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="pricing"><span class="me-2">Pricing</span><a href="#pricing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>別忘了參考 Firebase Functions &amp; Firestore 的定價策略。</p><h4 id="functions"><span class="me-2">Functions</span><a href="#functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/functions/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*76yRqeDyrp0kFmGHN4ZNXg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDIwIiBoZWlnaHQ9IjI2OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*G_At8v80BQl81EUqPuUIbQ.webp" alt="運算時間" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTM4IiBoZWlnaHQ9IjU2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>運算時間</p><p><a href="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*iXk7oKFidHfzRVwrDvKX0A.webp" alt="網路" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjM1MSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>網路</p><blockquote><p><em>Cloud Functions 針對運算時間資源提供永久免費方案，當中包含 GB/秒和 GHz/秒的運算時間。除了 200 萬次叫用以外，免費方案也提供 400,000 GB/秒和 200,000 GHz/秒的運算時間，以及每月 5 GB 的網際網路輸出流量。</em></p></blockquote><h4 id="firestore"><span class="me-2">Firestore</span><a href="#firestore" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="https://cloud.google.com/firestore/pricing?hl=zh-tw" target="_blank">https://cloud.google.com/firestore/pricing?hl=zh-tw</a></ul><p><a href="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.webp" class="popup img-link blur"><img data-src="/assets/9659db1357e4/1*ylduiqevk4WH-eNc8EOpvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjUwMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><a href="https://cloud.google.com/firestore/docs/billing-example?hl=zh-tw" target="_blank">計算範例</a></ul><blockquote><p><strong><em>價格可能隨時更改，請以官網最新資訊為準。</em></strong></p></blockquote><h3 id="結論"><span class="me-2">結論</span><a href="#結論" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如同標題所寫「可供測試」、「可供測試」、「可供測試」不太建議將以上服務用於正式環境，甚至當作產品的核心上線。</p><h4 id="收費貴難遷移"><span class="me-2">收費貴、難遷移</span><a href="#收費貴難遷移" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>之前曾聽說某個蠻大的服務就是使用 Firebase 服務搭建起家，結果後期資料、流量大，收費爆貴；要轉移也很困難，程式還好但資料非常難搬；只能說是初期省了小錢卻造成後期巨大的虧損，不值得。</p><h4 id="僅供測試"><span class="me-2">僅供測試</span><a href="#僅供測試" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>因為以上原因，使用 Firebase Functions + Firestore 搭建的 API 服務個人建議僅供測試或是 Prototype 產品展示。</p><h4 id="更多功能"><span class="me-2">更多功能</span><a href="#更多功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Functions 還可以串 Authentication(身份驗證)、Storage(檔案上傳)，但這部分我就沒研究了。</p><h3 id="參考資料"><span class="me-2">參考資料</span><a href="#參考資料" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://firebase.google.com/docs/firestore/query-data/queries" target="_blank">https://firebase.google.com/docs/firestore/query-data/queries</a><li><a href="https://coder.tw/?p=7198" target="_blank">https://coder.tw/?p=7198</a><li><a href="https://firebase.google.com/docs/firestore/solutions/counters#node.js_1" target="_blank">https://firebase.google.com/docs/firestore/solutions/counters#node.js_1</a><li><a href="https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80" target="_blank">https://javascript.plainenglish.io/firebase-cloud-functions-tutorial-creating-a-rest-api-8cbc51479f80</a></ul><h3 id="延伸閱讀"><span class="me-2">延伸閱讀</span><a href="#延伸閱讀" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="/posts/zrealm-dev/python-搭配-google-cloud-platform-與-line-bot-打造每日自動簽到腳本與排程-70a1409b149a/">使用 Python+Google Cloud Platform+Line Bot 自動執行例行瑣事</a><li><a href="/posts/zrealm-dev/ios-notification-service-extension-swift-實作圖片推播與顯示統計技巧-cb6eba52a342/">i <strong>OS ≥ 10 Notification Service Extension 應用 (Swift)</strong></a><li><a href="/posts/zrealm-dev/google-apps-script-教學-自動轉發-gmail-郵件到-slack-channel-客製化通知-d414bdbdb8c9/">運用 Google Apps Script 轉發 Gmail 信件到 Slack</a></ul><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><hr /><blockquote class="prompt-info"><p>本文首次發表於 Medium ➡️ <a href="https://medium.com/p/9659db1357e4" target="_blank"><strong>前往查看</strong></a>，由 <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> 與 <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2021-03-23-9659db1357e4.md" target="_blank">Improve this page on Github.</a></p></blockquote><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 3,301 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-20 | 3,225 Views on <a href="https://medium.com/p/9659db1357e4" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/firebase/" class="post-tag no-text-decoration" >firebase</a> <a href="/tags/google-cloud-platform/" class="post-tag no-text-decoration" >google-cloud-platform</a> <a href="/tags/notifications/" class="post-tag no-text-decoration" >notifications</a> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Firebase%20Firestore%EF%BD%9CFunctions%20%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8%20API%20%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B8%25AC%25E8%25A9%25A6%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258B%2599%25E6%2595%2599%25E5%25AD%25B8%25E8%2588%2587%25E6%258E%25A8%25E6%2592%25AD%25E7%25B5%25B1%25E8%25A8%2588%25E5%25AF%25A6%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Firebase%20Firestore%EF%BD%9CFunctions%20%E5%BF%AB%E9%80%9F%E6%89%93%E9%80%A0%E6%B8%AC%E8%A9%A6%E7%94%A8%20API%20%E6%9C%8D%E5%8B%99%E6%95%99%E5%AD%B8%E8%88%87%E6%8E%A8%E6%92%AD%E7%B5%B1%E8%A8%88%E5%AF%A6%E4%BD%9C%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B8%25AC%25E8%25A9%25A6%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258B%2599%25E6%2595%2599%25E5%25AD%25B8%25E8%2588%2587%25E6%258E%25A8%25E6%2592%25AD%25E7%25B5%25B1%25E8%25A8%2588%25E5%25AF%25A6%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Ffirebase-firestore-functions-%25E5%25BF%25AB%25E9%2580%259F%25E6%2589%2593%25E9%2580%25A0%25E6%25B8%25AC%25E8%25A9%25A6%25E7%2594%25A8-api-%25E6%259C%258D%25E5%258B%2599%25E6%2595%2599%25E5%25AD%25B8%25E8%2588%2587%25E6%258E%25A8%25E6%2592%25AD%25E7%25B5%25B1%25E8%25A8%2588%25E5%25AF%25A6%25E4%25BD%259C-9659db1357e4%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/apple-watch-stainless-steel-milanese-loop-unboxing-premium-44mm-graphite-band-review-c0f99f987d9c/">Apple Watch Stainless Steel Milanese Loop Unboxing｜Premium 44mm Graphite Band Review</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/apple-watch-%E7%B1%B3%E8%98%AD%E9%8C%B6%E5%B8%B6%E9%96%8B%E7%AE%B1-%E5%8E%9F%E5%BB%A0%E4%B8%8D%E9%8F%BD%E9%8B%BC%E7%9F%B3%E5%A2%A8%E8%89%B2%E5%84%AA%E7%BC%BA%E9%BB%9E%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原廠不鏽鋼米蘭錶帶開箱</a><li class="text-truncate lh-lg"> <a href="/posts/travel-journals/en/busan-travel-guide-8-day-itinerary-with-visit-busan-pass-for-seamless-exploration-8ace34a1a3d8/">Busan Travel Guide｜8-Day Itinerary with VISIT BUSAN PASS for Seamless Exploration</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%87%9C%E5%B1%B1%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-8%E5%A4%A97%E5%A4%9C%E5%BF%85%E5%8E%BB%E6%99%AF%E9%BB%9E-%E7%BE%8E%E9%A3%9F%E8%88%87%E4%BA%A4%E9%80%9A%E5%85%A8%E8%A7%A3%E6%9E%90-%E9%87%9C%E5%B1%B1%E9%80%9A%E8%A1%8C%E8%AD%89%E7%9C%81%E9%8C%A2%E7%A7%98%E8%A8%A3-8ace34a1a3d8/">遊記 2025 韓國釜山 8 天 7 夜自由行</a><li class="text-truncate lh-lg"> <a href="/posts/travel-journals/en/nagoya-one-day-quick-trip-peach-aviation-flight-experience-and-travel-tips-7b8a0563c157/">Nagoya One-Day Quick Trip｜Peach Aviation Flight Experience and Travel Tips</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">iOS App Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios app development</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">Swift</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E6%8A%80%E8%A1%93%E5%AF%A6%E6%88%B0-ios-%E6%9C%AC%E5%9C%B0%E7%B7%A9%E5%AD%98%E5%84%AA%E5%8C%96%E6%94%BB%E7%95%A5-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer 邊播邊 Cache 技術實戰｜iOS 本地緩存優化攻略</h4><div class="text-muted"><p>針對 iOS 開發者面臨 AVPlayer 播放時緩存不足問題，解析 AVAssetResourceLoaderDelegate 實作技巧，有效提升播放流暢度與本地緩存效率，減少重複下載與延遲，打造穩定音樂與影片播放器體驗。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-robotic-process-automation/google-apps-script-%E5%BF%AB%E9%80%9F%E4%B8%B2%E6%8E%A5-firebase-app-distribution-api-%E6%95%99%E5%AD%B8%E8%88%87%E9%80%B2%E9%9A%8E%E8%A8%AD%E5%AE%9A-71400d408dc8/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1742479968" data-df="ll" > Mar 20, 2025 </time><h4 class="pt-0 my-2">Google Apps Script x Google APIs 快速串接整合方式</h4><div class="text-muted"><p>以 Google Apps Script x Firebase App Distribution API 串接為例</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/crashlytics-big-query-%E4%B8%B2%E6%8E%A5%E6%95%99%E5%AD%B8-%E8%87%AA%E5%8B%95%E6%9F%A5%E8%A9%A2%E4%B8%A6%E8%BD%89%E7%99%BC-ios-app-%E9%96%83%E9%80%80%E5%A0%B1%E5%91%8A%E5%88%B0-slack-e77b80cc6f89/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1634654010" data-df="ll" > Oct 19, 2021 </time><h4 class="pt-0 my-2">Crashlytics + Big Query 打造更即時便利的 Crash 追蹤工具</h4><div class="text-muted"><p>串接 Crashlytics 和 Big Query 自動轉發閃退記錄到 Slack Channel</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/firebase-firestore-functions-build-testable-api-services-fast-for-push-notification-analytics-9659db1357e4/" class="btn btn-outline-primary" aria-label="Older" ><p>Firebase Firestore + Functions｜Build Testable API Services Fast for Push Notification Analytics</p></a> <a href="/posts/zrealm-dev/en/appstore-reviews-bot-automate-app-review-tracking-with-slack-notifications-cb0c68c33994/" class="btn btn-outline-primary" aria-label="Newer" ><p>AppStore Reviews Bot｜Automate APP Review Tracking with Slack Notifications</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved. <a href="/">中文</a>|<a href="/tags/english/">English</a></span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-21 09:26:25 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">iOS App Development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios app development</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">Swift</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
