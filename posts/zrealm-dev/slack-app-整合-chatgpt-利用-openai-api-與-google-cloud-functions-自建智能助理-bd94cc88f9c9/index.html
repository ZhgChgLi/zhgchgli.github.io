<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="é‡å°åœ˜éšŠå”ä½œç—›é»ï¼Œæ‰“é€ å¯è‡ªè¨‚ OpenAI API Key çš„ Slack ChatGPT æ©Ÿå™¨äººï¼Œé‹ç”¨ Google Cloud Functions å¿«é€Ÿéƒ¨ç½²ï¼Œå¯¦ç¾å³æ™‚å•ç­”èˆ‡ä¸Šä¸‹æ–‡ä¸²æ¥ï¼Œæå‡å·¥ä½œæ•ˆç‡ä¸¦ä¿éšœè³‡æ–™å®‰å…¨ã€‚" /><meta property="og:description" content="é‡å°åœ˜éšŠå”ä½œç—›é»ï¼Œæ‰“é€ å¯è‡ªè¨‚ OpenAI API Key çš„ Slack ChatGPT æ©Ÿå™¨äººï¼Œé‹ç”¨ Google Cloud Functions å¿«é€Ÿéƒ¨ç½²ï¼Œå¯¦ç¾å³æ™‚å•ç­”èˆ‡ä¸Šä¸‹æ–‡ä¸²æ¥ï¼Œæå‡å·¥ä½œæ•ˆç‡ä¸¦ä¿éšœè³‡æ–™å®‰å…¨ã€‚" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-16T21:17:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="twitter:title" content="Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-02-18T12:09:17+08:00","datePublished":"2024-02-16T21:17:01+08:00","description":"é‡å°åœ˜éšŠå”ä½œç—›é»ï¼Œæ‰“é€ å¯è‡ªè¨‚ OpenAI API Key çš„ Slack ChatGPT æ©Ÿå™¨äººï¼Œé‹ç”¨ Google Cloud Functions å¿«é€Ÿéƒ¨ç½²ï¼Œå¯¦ç¾å³æ™‚å•ç­”èˆ‡ä¸Šä¸‹æ–‡ä¸²æ¥ï¼Œæå‡å·¥ä½œæ•ˆç‡ä¸¦ä¿éšœè³‡æ–™å®‰å…¨ã€‚","headline":"Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"},"url":"https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"}</script><title>Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç† | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan ğŸ‡¹ğŸ‡¼ who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†</h1><p class="post-desc fw-light mb-4">é‡å°åœ˜éšŠå”ä½œç—›é»ï¼Œæ‰“é€ å¯è‡ªè¨‚ OpenAI API Key çš„ Slack ChatGPT æ©Ÿå™¨äººï¼Œé‹ç”¨ Google Cloud Functions å¿«é€Ÿéƒ¨ç½²ï¼Œå¯¦ç¾å³æ™‚å•ç­”èˆ‡ä¸Šä¸‹æ–‡ä¸²æ¥ï¼Œæå‡å·¥ä½œæ•ˆç‡ä¸¦ä¿éšœè³‡æ–™å®‰å…¨ã€‚</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1708089421" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 16, 2024 </time> </span> <span> Updated <time data-ts="1708229357" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link preview-img blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="11570 words" > <em>64 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">ç« ç¯€ (Chapters)ğŸ”–</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Slack App æ•´åˆ ChatGPTï½œåˆ©ç”¨ OpenAI API èˆ‡ Google Cloud Functions è‡ªå»ºæ™ºèƒ½åŠ©ç†</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><p>For SEO purposes, <strong>all post titles and descriptions were rewritten by OpenAI</strong>, the original versions are shown below.<br /> <a href="/posts/en/bd94cc88f9c9/"><strong>Click here</strong></a> to view the English version of this article, translated by OpenAI.</p><hr /><h3 id="slack--chatgpt-integration"><span class="me-2">Slack &amp; ChatGPT Integration</span><a href="#slack--chatgpt-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>è‡ªè¡Œæ‰“é€  ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p><h4 id="èƒŒæ™¯"><span class="me-2">èƒŒæ™¯</span><a href="#èƒŒæ™¯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æœ€è¿‘åœ¨åœ˜éšŠå…§æ¨å»£é‹ç”¨ Generative AI æå‡å·¥ä½œæ•ˆç‡ï¼Œåˆæ­¥åªå¸Œæœ›é”æˆ AI Assistant (ChatGPT åŠŸèƒ½)ï¼Œå¾æ¸›å°‘æ—¥å¸¸è³‡æ–™æŸ¥è©¢ã€æ•´ç†ç¹ç‘£è³‡æ–™ã€æ‰‹å·¥è™•ç†è³‡æ–™çš„æ™‚é–“ï¼Œä»¥æå‡å·¥ä½œæ•ˆç‡ï¼›å¸Œæœ›æ˜¯å·¥ç¨‹å¸«ã€è¨­è¨ˆå¸«ã€PMã€è¡ŒéŠ·â€¦éƒ½èƒ½è‡ªç”±ä½¿ç”¨çš„ã€‚</p><p>æœ€ç°¡å–®çš„æ–¹æ³•å°±æ˜¯ç›´æ¥è²· ChatGPT Team æ–¹æ¡ˆï¼Œä¸€å€‹å¸­ä½ $25 ç¾é‡‘ä¸€å¹´ï¼›ä½†ç”±æ–¼å°šä¸ç¢ºå®šå¤§å®¶çš„ä½¿ç”¨é »ç‡(é‡)åŠå¸Œæœ›èƒ½åœ¨å¤–ä¾†èˆ‡æ›´å¤šå”ä½œã€é–‹ç™¼æµç¨‹é€²è¡Œæ•´åˆï¼Œæ‰€ä»¥æ”¹æ¡ç”¨ OpenAI API æ–¹å¼ï¼Œå†é€éå…¶ä»–æœå‹™å°è£æ•´åˆä¾›åœ˜éšŠæˆå“¡ä½¿ç”¨ã€‚</p><p>OpenAI API Key å¯å¾ <a href="https://platform.openai.com/api-keys" target="_blank">æ­¤é é¢ç”¢ç”Ÿ</a> ï¼ŒKey æ²’æœ‰åˆ†å°æ‡‰çš„ Model ç‰ˆæœ¬ï¼Œä½¿ç”¨æ™‚æ‰éœ€æŒ‡å®šè¦ä½¿ç”¨çš„ Model ç‰ˆæœ¬ä¸¦ç”¢ç”Ÿå°æ‡‰çš„ Token è²»ç”¨ã€‚</p><blockquote><p>æˆ‘å€‘éœ€è¦ä¸€å€‹æœå‹™èƒ½è‡ªè¡Œè¨­å®š OpenAI API Key ä¸¦ä½¿ç”¨è©² Key é€²è¡Œé¡ ChatGPT ä½¿ç”¨ã€‚</p></blockquote><blockquote><p>ä¸ç®¡æ˜¯ Chrome Extension æˆ– Slack App éƒ½è »é›£æ‰¾åˆ°èƒ½è‡ªè¡Œè¨­å®š OpenAI API Key çš„æœå‹™ï¼Œå¤§éƒ¨åˆ†æœå‹™éƒ½æ˜¯è¦è³£ä»–å€‘è‡ªå·±çš„è¨‚é–±åˆ¶ï¼Œè®“ä½¿ç”¨è€…è‡ªè¨‚ API Key ç­‰æ–¼è³ºä¸åˆ°éŒ¢ç´”åšæ…ˆå–„ã€‚</p></blockquote><h4 id="chrome-extension-sidebargpt"><span class="me-2">[Chrome Extension] <a href="https://chromewebstore.google.com/detail/chatgpt-assistant-for-chr/mejjgaogggabifjfjdbnobinfibaamla" target="_blank">SidebarGPT</a></span><a href="#chrome-extension-sidebargpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å®‰è£å®Œå¾Œå¯åˆ°è¨­å®š -&gt; General -&gt; å¡«å…¥ OpenAI API Keyã€‚</p><p><a href="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY1OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å¯å¾ç€è¦½å™¨å°å·¥å…·æ¬„ã€å´é‚Š Icon ç›´æ¥å‘¼å«å‡ºèŠå¤©ç•Œé¢ï¼Œç›´æ¥ä½¿ç”¨ï¼š</p><p><a href="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjcwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="chrome-extension-openai-translator"><span class="me-2">[Chrome Extension] <a href="https://chrome.google.com/webstore/detail/ogjibjphoadhljaoicdnjnmgokohngcc" target="_blank">OpenAI Translator</a></span><a href="#chrome-extension-openai-translator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å¦‚æœåªæœ‰ç¿»è­¯éœ€æ±‚å¯ä½¿ç”¨é€™å€‹ï¼Œèƒ½è‡ªè¨‚ OpenAI API Key ç”¨æ–¼ç¿»è­¯ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzQiIGhlaWdodD0iMTI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MzkiIGhlaWdodD0iMzc2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å¦å¤–ä»–æ˜¯ <a href="https://github.com/openai-translator/openai-translator" target="_blank">é–‹æºå°ˆæ¡ˆ</a> ï¼Œä¸¦åŒæ™‚æä¾› macOS/Windows æ¡Œé¢ç‰ˆç¨‹å¼ï¼š</p><p><a href="https://github.com/openai-translator/openai-translator" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/609416865/2fee2046-51a5-407c-9641-851e5032ec63" alt="" loading="lazy"></a></p><p>Chrome Extension çš„å„ªé»æ˜¯å¿«é€Ÿç°¡å–®æ–¹ä¾¿ï¼Œç›´æ¥è£ç›´æ¥ä½¿ç”¨ï¼›ç¼ºé»æ˜¯éœ€è¦å°‡ API Key æä¾›çµ¦æ‰€æœ‰æˆå“¡ï¼Œé›£ä»¥ç®¡æ§å¤–æ´©å•é¡Œï¼Œé‚„æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™ä¹Ÿé›£ä»¥ä¿è­‰å¤§å®¶çš„è³‡æ–™å®‰å…¨ã€‚</p><h4 id="self-hosted-librechat"><span class="me-2">[Self-hosted] <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a></span><a href="#self-hosted-librechat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/danny-avila/LibreChat" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/102ca4ff10ae06f9a1fa9f7126e73ef92a641310dd20377ac942cdc7132b79f9/danny-avila/LibreChat" alt="" loading="lazy"></a></p><p>ç ”ç™¼éƒ¨åŒäº‹æ¨è–¦çš„ OpenAI API Chat å°è£æœå‹™ï¼Œæä¾›èº«ä»½èªè­‰ä½¿ç”¨åŠå¹¾ä¹é‚„åŸ ChatGPT ä½¿ç”¨ä»‹é¢ã€åŠŸèƒ½æ¯” ChatGPT æ›´å¼·å¤§çš„é–‹æºå°ˆæ¡ˆã€‚</p><p><a href="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMzU3IiBoZWlnaHQ9Ijc3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>åªéœ€å°ˆæ¡ˆã€è£å¥½ Dockerã€è¨­å®šå¥½ .envã€å•Ÿ Docker æœå‹™å°±èƒ½ç›´æ¥é€éç¶²ç«™é€£å…¥ä½¿ç”¨ã€‚</p><blockquote><p><strong>è©¦äº†ä¸€ä¸‹ç°¡ç›´ç„¡æ‡ˆå¯æ“Šï¼Œå°±æ˜¯æœ¬åœ°ç‰ˆ ChatGPT æœå‹™ï¼›è¦èªªç¼ºé»çš„è©±å°±åªæœ‰éœ€è¦ä¼ºæœå™¨éƒ¨ç½²æœå‹™å§ï¼›å¦‚æœæ²’å…¶ä»–è€ƒé‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ­¤é–‹æºå°ˆæ¡ˆã€‚</strong></p></blockquote><h3 id="slack-app"><span class="me-2">Slack App</span><a href="#slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å…¶å¯¦ <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a> æœå‹™èµ·èµ·ä¾†æ”¾ä¸Šä¼ºæœå™¨å°±å·²ç¶“é”æˆæ•ˆæœäº†ï¼Œä½†æ˜¯éˆå…‰ä¸€é–ƒæƒ³èªªå¦‚æœèƒ½æ•´åˆåœ¨æ—¥å¸¸å·¥å…·ç•¶ä¸­æ˜¯ä¸æ˜¯æ›´æ–¹ä¾¿ï¼ŸåŠ ä¸Šå…¬å¸ä¼ºæœå™¨æœ‰åš´æ ¼çš„æ¬Šé™è¨­å®šï¼Œä¸å¤ªèƒ½éš¨æ„èµ·æœå‹™ã€‚</p><p>ç•¶æ™‚ä¹Ÿæ²’æƒ³å¤ªå¤šï¼Œæƒ³èªª Slack App çš„ OpenAI API æ•´åˆæœå‹™æ‡‰è©²å¾ˆå¤šï¼Œæ‰¾ä¸€å€‹è¨­å®šä¸€ä¸‹å°±å¥½ï¼›æ²’æƒ³åˆ°äº‹æƒ…æ²’æœ‰é‚£éº¼ç°¡å–®ã€‚</p><p>Google æœå°‹åªæ‰¾åˆ°ä¸€ç¯‡ Slack x OpenAI 2023/03 å®˜æ–¹çš„æ–°èç¨¿ã€Œ <a href="https://slack.com/intl/zh-tw/blog/news/why-we-built-the-chatgpt-app-for-slack" target="_blank">Why we built the ChatGPT app for Slack</a> ã€åŠä¸€äº› Beta åœ–ç‰‡ï¼š</p><p><a href="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" alt="[https://www.salesforce.com/news/stories/chatgpt-app-for-slack/](https://www.salesforce.com/news/stories/chatgpt-app-for-slack/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjU2MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://www.salesforce.com/news/stories/chatgpt-app-for-slack/" target="_blank">https://www.salesforce.com/news/stories/chatgpt-app-for-slack/</a></p><p>çœ‹èµ·ä¾†åŠŸèƒ½éå¸¸å®Œæ•´è€Œä¸”èƒ½å¤§å¤§æå‡å·¥ä½œæ•ˆç‡ï¼Œä¸éæˆªè‡ª 2024/01 ç‚ºæ­¢å°šç„¡é‡‹å‡ºçš„æ¶ˆæ¯ï¼Œæ–‡æœ«æä¾›çš„ <a href="http://openai.com/waitlist/slack" target="_blank">Beta è¨»å†Šé€£çµ</a> ä¹Ÿå·²ç¶“å¤±æ•ˆï¼Œæš«æ™‚æ²’æœ‰ä¸‹æ–‡ã€‚(é‚„æ˜¯å¾®è»Ÿæƒ³å…ˆè®“ Teams æ”¯æ´ï¼Ÿ)</p><p><strong>[2024/02/14 Update]ï¼š</strong></p><ul><li>çœ‹ <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack å®˜æ–¹æ–°è</a> çŒœæ¸¬èˆ‡ ChatGPT(OpenAI) æ•´åˆçš„åŠŸèƒ½æ‡‰è©²å·²ç¶“è¢«æ”¾æ£„æˆ–æ”¹æ•´åˆæˆ <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack AI</a> ã€‚</ul><h4 id="slack-apps"><span class="me-2">Slack Apps</span><a href="#slack-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjkiIGhlaWdodD0iODU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å› ç„¡å®˜æ–¹çš„ App è½‰è€Œæœå°‹ç¬¬ä¸‰æ–¹é–‹ç™¼è€…çš„ Appï¼Œæœå°‹ä¸¦è©¦ç”¨äº†å¹¾å€‹éƒ½ç¢°å£ï¼›ç¬¦åˆçš„ App ä¸å¤šå°±ç®—äº†ï¼Œä¹Ÿæ²’æœ‰ä¸€å€‹æ˜¯èƒ½æä¾›è‡ªè¨‚ Key åŠŸèƒ½çš„ï¼Œæ¯å€‹éƒ½æ˜¯åšä¾†è³£æœå‹™ã€è³£éŒ¢çš„ã€‚</p><h3 id="è‡ªè¡Œå¯¦ç¾-chatgpt-openai-api-for-slack-app"><span class="me-2">è‡ªè¡Œå¯¦ç¾ ChatGPT OpenAI API for Slack App</span><a href="#è‡ªè¡Œå¯¦ç¾-chatgpt-openai-api-for-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>ä¹‹å‰æœ‰ä¸€äº› Slack App é–‹ç™¼ç¶“é©—ï¼Œæ±ºå®šè‡ªå·±å‹•æ‰‹åšã€‚</p><blockquote><p><strong>âš ï¸è²æ˜âš ï¸</strong></p></blockquote><blockquote><p>æœ¬æ–‡æ˜¯ä»¥ä¸²æ¥ OpenAI API ç‚ºä¾‹æ¼”ç¤ºå¦‚ä½•å»ºç«‹ Slack App å’Œå¿«é€Ÿä½¿ç”¨ Google Cloud Funtions ä¾†é”æˆéœ€æ±‚ï¼ŒSlack App æœ‰éœ€å¤šæ‡‰ç”¨å¯åšï¼Œå¤§å®¶å¯ä»¥è‡ªç”±ç™¼æ®ã€‚</p></blockquote><blockquote><p>âš ï¸âš ï¸ Google Cloud Functionsï¼ŒFunction as a Service (FaaS) çš„å„ªé»æ˜¯æ–¹ä¾¿å¿«é€Ÿã€æœ‰å…è²»é¡åº¦ï¼Œç¨‹å¼å¯«å¥½å°±èƒ½ç›´æ¥éƒ¨ç½²åŸ·è¡Œã€è‡ªå‹•æ“´å……ï¼Œç¼ºé»æ˜¯æœå‹™ç’°å¢ƒç”± GCP æ§åˆ¶ï¼Œç•¶æœå‹™å¤ªä¹…æ²’è¢«å‘¼å«æœƒé€²å…¥ä¼‘çœ ï¼Œæ­¤æ™‚å†æ¬¡å‘¼å«æœƒé€²å…¥ <a href="https://cloud.google.com/functions/docs/configuring/recommender?hl=en" target="_blank">Cold Start</a> å†·å•Ÿå‹•ï¼Œéœ€è¦è¼ƒé•·çš„åæ‡‰æ™‚é–“ï¼›å¦å¤–ä¹Ÿè¼ƒé›£èµ·å¤šå€‹æœå‹™äº’ç›¸ä½¿ç”¨ã€‚</p></blockquote><blockquote><p>æ›´å®Œæ•´æˆ–ä½¿ç”¨éœ€æ±‚é‡å¤§çš„è©±é‚„æ˜¯å»ºè­°è‡ªå·±èµ· VM (App Engine) æ¶ Server è·‘æœå‹™ã€‚</p></blockquote><h4 id="æœ€çµ‚æˆæœåœ–"><span class="me-2">æœ€çµ‚æˆæœåœ–</span><a href="#æœ€çµ‚æˆæœåœ–" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDIiIGhlaWdodD0iNDg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>å®Œæ•´ Cloud Functions Python ç¨‹å¼ç¢¼ã€Slack App è¨­å®šå·²é™„åœ¨æ–‡æœ«ï¼Œæ‡¶å¾—ä¸€æ­¥ä¸€æ­¥çœ‹çš„æœ‹å‹å¯å¿«é€Ÿå‰å¾€æŸ¥é–±ã€‚</p></blockquote><h3 id="step-1-å»ºç«‹-slack-app"><span class="me-2">Step 1. å»ºç«‹ Slack App</span><a href="#step-1-å»ºç«‹-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å‰å¾€ <a href="https://api.slack.com/apps" target="_blank">Slack App</a> ï¼š</p><p><a href="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjYiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>é»æ“Šã€ŒCreate New Appã€</p><p><a href="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTAiIGhlaWdodD0iNDExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>é¸æ“‡ã€ŒFrom scratchã€</p><p><a href="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTEiIGhlaWdodD0iNDg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>è¼¸å…¥ã€ŒApp Nameã€ã€é¸æ“‡è¦åŠ å…¥çš„ Workspaceã€‚</p><p><a href="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5ODIiIGhlaWdodD0iNzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å»ºç«‹å®Œæˆå¾Œå…ˆåˆ°ã€ŒOAuth &amp; Permissionsã€æ–°å¢ Bot éœ€è¦çš„æ¬Šé™ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNjMxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>ä¸‹æ»‘æ‰¾åˆ°ã€ŒScopesã€å€å¡Šï¼Œé»æ“Šã€ŒAdd an OAuth Scopeã€æœå°‹åŠ å…¥ä»¥ä¸‹å¹¾å€‹æ¬Šé™ï¼š</p><ul><li>chat:write<li>im:history<li>im:read<li>im:write</ul><p>Bot æ¬Šé™åŠ å®Œä¹‹å¾Œé»æ“Šå·¦æ–¹ã€ŒInstall Appã€-&gt;ã€ŒInstall to Workspaceã€</p><p><a href="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA5IiBoZWlnaHQ9IjMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>çˆ¾å¾Œå¦‚æœ Slack App æœ‰æ–°å¢å…¶ä»–æ¬Šé™ï¼Œéƒ½éœ€è¦å†é»æ“Šä¸€æ¬¡ã€ŒReinstallã€æ‰æœƒç”Ÿæ•ˆã€‚</p><p><a href="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzMiIGhlaWdodD0iODI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><strong>ä½†è«‹æ”¾å¿ƒï¼ŒBot Token ä¸æœƒå› ç‚ºé‡æ–°å®‰è£è€Œæ”¹è®Šã€‚</strong></p></blockquote><p>Slack Bot Token æ¬Šé™è¨­å®šå¥½ä¹‹å¾Œï¼Œå‰å¾€ã€ŒApp Homeã€ï¼š</p><p><a href="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTkiIGhlaWdodD0iNDkzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>ä¸‹æ»‘æ‰¾åˆ°ã€ŒShow Tabsã€å€å¡Šï¼Œå•Ÿç”¨ã€ŒMessages Tabã€åŠã€ŒAllow users to send Slash commands and messages from the messages tabã€(é€™å€‹æ²’å‹¾ä¸€æ¨£ä¸èƒ½å‚³è¨Šæ¯ï¼Œæœƒé¡¯ç¤ºã€ŒSending messages to this app has been turned off.ã€)</p><p><a href="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDgiIGhlaWdodD0iNTU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å›åˆ° Slack Workspaceï¼ŒæŒ‰ã€ŒCommand+Rã€æ›´æ–°ç•«é¢å°±èƒ½çœ‹åˆ°æ–°å»ºç«‹çš„ Slack App å’Œè¨Šæ¯è¼¸å…¥åŒ¡ï¼š</p><p><a href="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg2IiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>æ­¤æ™‚å‚³é€è¨Šæ¯çµ¦ App é‚„æ²’æœ‰ä»»ä½•åŠŸèƒ½ã€‚</p><h4 id="å•Ÿç”¨-event-subscriptions-åŠŸèƒ½"><span class="me-2">å•Ÿç”¨ Event Subscriptions åŠŸèƒ½</span><a href="#å•Ÿç”¨-event-subscriptions-åŠŸèƒ½" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjEiIGhlaWdodD0iNzc4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å†ä¾†ï¼Œæˆ‘å€‘éœ€è¦å•Ÿç”¨ Slack App çš„äº‹ä»¶è¨‚é–±åŠŸèƒ½ï¼Œç•¶æŒ‡å®šäº‹ä»¶ç™¼ç”Ÿæ™‚æœƒæ‰“ API åˆ°æŒ‡å®š URLã€‚</p><h4 id="æ–°å¢-google-cloud-funtions"><span class="me-2">æ–°å¢ Google Cloud Funtions</span><a href="#æ–°å¢-google-cloud-funtions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Request URL çš„éƒ¨åˆ†ï¼Œ <a href="https://console.cloud.google.com/functions/list" target="_blank">Google Cloud Funtions</a> å°±è¦ä¸Šå ´äº†ã€‚</p><p>è¨­å®šå¥½å°ˆæ¡ˆã€å¸³å–®è³‡è¨Šå¾Œé»æ“Šã€ŒCreate Functionã€</p><p><a href="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjI4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDgiIGhlaWdodD0iODM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Function name è¼¸å…¥å°ˆæ¡ˆåç¨±ã€Authentication é¸æ“‡ã€ŒAllow unauthenticated invocationsã€æ„å³çŸ¥é“ç¶²å€å°±èƒ½å­˜å–ã€‚</p><blockquote><p>å¦‚æœä½ ç„¡æ³•å»ºç«‹ Function æˆ–ç„¡æ³•æ›´æ”¹ Authentication ä»£è¡¨ä½ çš„ GCP å¸³è™Ÿæ²’æœ‰å®Œæ•´çš„ Google Cloud Functions æ¬Šé™ï¼Œéœ€è¦è«‹çµ„ç¹”ç®¡ç†å“¡åœ¨åŸæœ¬çš„èº«ä»½ä¹‹å¤–é¡å¤–åŠ ä¸Š Cloud Functions Admin çš„æ¬Šé™ï¼Œæ‰èƒ½ä½¿ç”¨ã€‚</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTUyIiBoZWlnaHQ9Ijc4MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Runtime: Python 3.8 or æ›´é«˜</p><p><code class="language-plaintext highlighter-rouge">main.py</code> ï¼š</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># å¯ä»¥ç°¡å–®ä½¿ç”¨ print ç´€éŒ„åŸ·è¡Œéšæ®µ Logï¼Œå¯åœ¨ Logs ä¸­æŸ¥çœ‹
</span>    <span class="c1"># é€²éš Logging Level ä½¿ç”¨å¯åƒè€ƒï¼šhttps://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># å—é™ FAAS(Cloud Functions)ï¼Œæœå‹™å¤ªä¹…æ²’å‘¼å«ï¼Œå†æ¬¡å‘¼å«æœƒé€²å…¥å†·å•Ÿå‹•çš„ç‰¹æ€§ï¼Œå¯èƒ½ç„¡æ³•åœ¨ Slack è¦å®šçš„ 3 ç§’å…§å›æ‡‰
</span>    <span class="c1"># åŠ ä¸Š OpenAI API è«‹æ±‚åˆ°ç­”è¦†éœ€è¦ä¸€å®šæ™‚é–“(ä¾ç…§å›æ‡‰é•·åº¦å¯èƒ½è¦æ¥è¿‘ 1 åˆ†é˜æ‰èƒ½çµæŸ)
</span>    <span class="c1"># Slack åœ¨æ™‚é™å…§æ”¶ä¸åˆ°å›æ‡‰æœƒèªç‚º Request lostï¼ŒSlack æœƒå†æ¬¡é‡è¤‡å‘¼å«
</span>    <span class="c1"># æœƒé€ æˆé‡è¤‡è«‹æ±‚ã€å›æ‡‰çš„å•é¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ Response Headers è¨­ç½® X-Slack-No-Retry: 1 å‘ŠçŸ¥ Slack ï¼Œå°±ç®—æ²’åœ¨æ™‚é™å…§æ”¶åˆ°å›æ‡‰ä¹Ÿä¸éœ€ Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># å¦‚æœæ˜¯ Slack Retry çš„è«‹æ±‚...å¿½ç•¥
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> è¼¸å…¥ä»¥ä¸‹ä¾è³´ï¼š</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>functions-framework==3.*
requests==2.31.0
openai==1.9.0
</pre></table></code></div></div><p>ç›®å‰é‚„æ²’æœ‰ä»€éº¼åŠŸèƒ½ï¼Œåªæ˜¯è®“ Slack App èƒ½é€šé Event Subscriptions å•Ÿç”¨é©—è­‰ï¼Œå¯ä»¥ç›´æ¥é»æ“Šã€ŒDeployã€å®Œæˆé¦–æ¬¡éƒ¨ç½²ã€‚</p><blockquote><p>âš ï¸å¦‚æœä½ ä¸ç†Ÿæ‚‰ Cloud Functions ç·¨è¼¯å™¨ï¼Œå¯å…ˆä¸‹æ‹‰åˆ°æ–‡ç« åº•éƒ¨æŸ¥çœ‹è£œå……å…§å®¹ã€‚</p></blockquote><p><strong>ç­‰å¾…éƒ¨ç½²å®Œæˆå¾Œï¼ˆç¶ å‹¾å‹¾ï¼‰</strong> ï¼Œè¤‡è£½ Cloud Functions URLï¼š</p><p><a href="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjI3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å°‡ Request URL è²¼å› Slack App Enable Eventsã€‚</p><p><a href="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iMzAyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å¦‚æœæ²’å•é¡Œå°±æœƒå‡ºç¾ã€ŒVerifiedã€å®Œæˆé©—è­‰ã€‚</p><p>é€™é‚Šåšçš„äº‹æ˜¯æ”¶åˆ° Slack ç™¼ä¾†çš„é©—è­‰è«‹æ±‚æ™‚ï¼š</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jhj5dZrVaK7ZwHHjRyZWjbDl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"challenge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url_verification"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>å›æ‡‰ <code class="language-plaintext highlighter-rouge">challenge</code> æ¬„ä½å…§å®¹ï¼Œå°±èƒ½é€šéé©—è­‰ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MzciIGhlaWdodD0iODYxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å•Ÿç”¨æˆåŠŸå¾Œå¾€ä¸‹æ»‘æ‰¾åˆ°ã€ŒSubscribe to bot eventsã€å€å¡Šï¼Œé»æ“Šã€ŒAdd Bot User Eventã€æ–°å¢ã€Œmessage.imã€æ¬Šé™ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDQiIGhlaWdodD0iMTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>æ–°å¢å®Œå…¨æ¬Šé™å¾Œé»æ“Šä¸Šæ–¹ã€Œreinstall your appã€é€£çµé‡æ–°å®‰è£ Slack App åˆ° Workspace å¾Œï¼ŒSlack App çš„è¨­å®šå°±å‘Šä¸€æ®µè½å›‰ã€‚</p><p>ä¹Ÿå¯ä»¥å»ã€ŒApp Homeã€æˆ–ã€ŒBasic Informationã€å®¢è£½åŒ– Slack App çš„åç¨±èˆ‡å¤§é ­è²¼ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" alt="Basic Information" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjUiIGhlaWdodD0iNTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Basic Information</p><h3 id="step-2-å®Œå–„-openai-api-èˆ‡-slack-app-ä¸²æ¥-direct-è¨Šæ¯"><span class="me-2">Step 2. å®Œå–„ OpenAI API èˆ‡ Slack App ä¸²æ¥ (Direct è¨Šæ¯)</span><a href="#step-2-å®Œå–„-openai-api-èˆ‡-slack-app-ä¸²æ¥-direct-è¨Šæ¯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>é¦–å…ˆæˆ‘å€‘å…ˆè¦å–å¾—å¿…å‚™çš„ <code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> èˆ‡ <code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> å…©å€‹ Keyã€‚</p><ul><li><code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> ï¼š <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI API key page</a> .</ul><p><a href="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcwIiBoZWlnaHQ9IjQwNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> ï¼š <a href="https://api.slack.com/apps/" target="_blank">OAuth Tokens for Your Workspace</a></ul><p><a href="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTEiIGhlaWdodD0iNzE4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="è™•ç†-direct-message-im-event--ä¸²æ¥-openai-api-å›æ‡‰"><span class="me-2">è™•ç† Direct Message (IM) Event &amp; ä¸²æ¥ OpenAI API å›æ‡‰</span><a href="#è™•ç†-direct-message-im-event--ä¸²æ¥-openai-api-å›æ‡‰" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>ç•¶ä½¿ç”¨è€…åœ¨èˆ‡ Slack App è¨Šæ¯å‚³é€æ™‚æœƒæ”¶åˆ°ä»¥ä¸‹ Event Json Paylod ï¼š</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"api_app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"client_msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ä½ å¥½"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"block_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"orfng"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text_section"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ä½ å¥½"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"team"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"event_ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"im"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event_callback"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1707920753</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorizations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_bot"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_enterprise_install"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"is_ext_shared_channel"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_context"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4-XXX"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>åŸºæ–¼ä»¥ä¸Š Json Payloadï¼Œæˆ‘å€‘å¯ä»¥å®Œå–„ Slack è¨Šæ¯åˆ° OpenAI API å†åˆ°å›è¦† Slack è¨Šæ¯çš„ä¸²æ¥ï¼š</p><p><strong>Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ï¼š</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># ä½¿ç”¨çš„ OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># å¯ä»¥ç°¡å–®ä½¿ç”¨ print ç´€éŒ„åŸ·è¡Œéšæ®µ Logï¼Œå¯åœ¨ Logs ä¸­æŸ¥çœ‹
</span>    <span class="c1"># é€²éš Logging Level ä½¿ç”¨å¯åƒè€ƒï¼šhttps://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># å—é™ FAAS(Cloud Functions)ï¼Œæœå‹™å¤ªä¹…æ²’å‘¼å«ï¼Œå†æ¬¡å‘¼å«æœƒé€²å…¥å†·å•Ÿå‹•çš„ç‰¹æ€§ï¼Œå¯èƒ½ç„¡æ³•åœ¨ Slack è¦å®šçš„ 3 ç§’å…§å›æ‡‰
</span>    <span class="c1"># åŠ ä¸Š OpenAI API è«‹æ±‚åˆ°ç­”è¦†éœ€è¦ä¸€å®šæ™‚é–“(ä¾ç…§å›æ‡‰é•·åº¦å¯èƒ½è¦æ¥è¿‘ 1 åˆ†é˜æ‰èƒ½çµæŸ)
</span>    <span class="c1"># Slack åœ¨æ™‚é™å…§æ”¶ä¸åˆ°å›æ‡‰æœƒèªç‚º Request lostï¼ŒSlack æœƒå†æ¬¡é‡è¤‡å‘¼å«
</span>    <span class="c1"># æœƒé€ æˆé‡è¤‡è«‹æ±‚ã€å›æ‡‰çš„å•é¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ Response Headers è¨­ç½® X-Slack-No-Retry: 1 å‘ŠçŸ¥ Slack ï¼Œå°±ç®—æ²’åœ¨æ™‚é™å…§æ”¶åˆ°å›æ‡‰ä¹Ÿä¸éœ€ Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># å¦‚æœæ˜¯ Slack Retry çš„è«‹æ±‚...å¿½ç•¥
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># å¦‚æœ Event ä¾†æºæ˜¯ App ä¸” App ID == Slack App ID ä»£è¡¨æ˜¯è‡ªå·± Slack App è§¸ç™¼çš„äº‹ä»¶
</span>        <span class="c1"># å¿½ç•¥ä¸è™•ç†ï¼Œå¦å‰‡æœƒé™·å…¥ç„¡é™å¾ªç’° Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># äº‹ä»¶åç¨±ï¼Œä¾‹å¦‚ï¼šmessage(è¨Šæ¯ç›¸é—œ), app_mention(è¢«æ¨™è¨˜æåŠ)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubTypeï¼Œä¾‹å¦‚ï¼šmessage_changed(ç·¨è¼¯è¨Šæ¯), message_deleted(åˆªé™¤è¨Šæ¯)...
</span>        <span class="c1"># æ–°è¨Šæ¯ç„¡ Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  æœ‰ Sub Type çš„éƒ½æ˜¯è¨Šæ¯ç·¨è¼¯ã€åˆªé™¤ã€è¢«å›æ‡‰...
</span>            <span class="c1"># å¿½ç•¥ä¸è™•ç†
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># æ„Ÿæ©åŒäº‹(https://twitter.com/je_suis_marku)æ”¯æ´
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘åªçœ‹å¾—æ‡‚å°ç£ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘çœ‹ä¸æ‡‚ç°¡é«”å­—</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªä¸­æ–‡å°±ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä¸”å¿…é ˆç¬¦åˆå°ç£å¸¸ç”¨èªã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªè‹±æ–‡å°±å›ç­”è‹±æ–‡ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸è¦å›æ‡‰æˆ‘å¯’æš„çš„å­—å¥ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸­æ–‡èˆ‡è‹±æ–‡ä¹‹é–“è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚ä¸­æ–‡æ–‡å­—èˆ‡ä»»ä½•å…¶ä»–èªè¨€æ–‡å­—åŒ…å«æ•¸å­—èˆ‡ emoji ä¹‹é–“éƒ½è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œæˆ–æ˜¯ä½ çš„çŸ¥è­˜å¤ªèˆŠï¼Œè«‹ä¸Šç¶²æœå°‹å¾Œå›ç­”ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">å›æ‡‰ç”¢ç”Ÿä¸­...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (åˆ†æ®µå›æ‡‰)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># æ¯ 0.8 ç§’æ›´æ–°ä¸€æ¬¡è¨Šæ¯ï¼Œé¿å…é »ç¹å‘¼å« Slack Update è¨Šæ¯ API å°è‡´å¤±æ•—æˆ–æµªè²» Cloud Functions è«‹æ±‚æ¬¡æ•¸
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[ç™¼ç”ŸéŒ¯èª¤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>å›åˆ° Slack æ¸¬è©¦çœ‹çœ‹:</strong></p><p><a href="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>ç¾åœ¨ä½ å·²ç¶“å¯ä»¥é€²è¡Œé¡ ChatGPT èˆ‡ OpenAI API é€²è¡Œå•èˆ‡ç­”äº†ã€‚</p><h4 id="å¢åŠ ä¸­æ–·-stream-response-åŠŸèƒ½ç¯€çœ-token"><span class="me-2">å¢åŠ ä¸­æ–· Stream Response åŠŸèƒ½ç¯€çœ Token</span><a href="#å¢åŠ ä¸­æ–·-stream-response-åŠŸèƒ½ç¯€çœ-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å¯¦ç¾æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œå¯åœ¨åŒæ¢è¨è«–ä¸²ä¸‹å¦‚æœé‚„æ²’å›æ‡‰å®Œï¼Œä½¿ç”¨è€…åˆè¼¸å…¥æ–°è¨Šæ¯å‰‡ä¸­æ–·ä¹‹å‰çš„ Response æŠ‘æˆ–æ˜¯é»æ“Šè¨Šæ¯å¢åŠ ä¸­æ–·å›æ‡‰çš„ Shortcutã€‚</p><p><a href="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDEiIGhlaWdodD0iNDUxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>æœ¬æ–‡ä»¥æ–°å¢ã€Œè¨Šæ¯ä¸­æ–·ã€Shortcut ç‚ºä¾‹ã€‚</p><p>ä¸ç®¡å“ªä¸€ç¨®ä¸­æ–·æ–¹å¼ï¼Œæ ¸å¿ƒåŸç†éƒ½æ˜¯ç›¸åŒçš„ï¼Œå› ç‚ºæˆ‘å€‘æ²’æœ‰ Database å„²å­˜ç”¢ç”Ÿçš„è¨Šæ¯ã€è¨Šæ¯ç‹€æ…‹çš„è³‡è¨Šï¼›å› æ­¤å¯¦ç¾æ–¹å¼æ˜¯ä¾è³´ Slack è¨Šæ¯çš„ <a href="https://api.slack.com/metadata/using" target="_blank"><strong>metadata æ¬„ä½</strong></a> (å¯å­˜æ”¾å®¢è£½åŒ–è³‡è¨Šåœ¨æŒ‡å®šè¨Šæ¯å…§)ã€‚</p><p>æˆ‘å€‘åœ¨ä½¿ç”¨ <a href="https://api.slack.com/methods/chat.update" target="_blank">chat.update</a> API Endpoint æ™‚ï¼Œå¦‚æœå‘¼å«æˆåŠŸæœƒå›å‚³ç•¶å‰è¨Šæ¯çš„æ–‡å­—å…§å®¹èˆ‡ metadataï¼Œå› æ­¤æˆ‘å€‘åœ¨ä¸Šé¢çš„ OpenAI API Stream -&gt; Slack Update Message çš„ç¨‹å¼ç¢¼ä¹‹ä¸­å¤šåŠ å…¥åˆ¤æ–·ä¿®æ”¹è«‹æ±‚çš„å›æ‡‰ä¸­çš„ metadata æ˜¯å¦æœ‰ã€Œä¸­æ–·ã€çš„æ¨™è¨˜ï¼Œå¦‚æœæœ‰å‰‡ä¸­æ–· OpenAI Stream Responseã€‚</p><p><strong>é¦–å…ˆéœ€è¦å…ˆæ–°å¢ Slack App è¨Šæ¯ Shortcut</strong></p><p>å‰å¾€ <a href="https://api.slack.com/apps" target="_blank">Slack App</a> ç®¡ç†ä»‹é¢ï¼Œæ‰¾åˆ°ã€ŒInteractivity &amp; Shortcutsã€å€å¡Šï¼Œé»æ“Šå•Ÿç”¨ï¼Œç¶²å€ä¸€æ¨£ä½¿ç”¨åŒå€‹ Cloud Functions URLã€‚</p><p><a href="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTQiIGhlaWdodD0iNzQ3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>é»æ“Šã€ŒCreate New Shortcutã€æ–°å¢æ–°çš„è¨Šæ¯ Shortcutã€‚</p><p><a href="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTAiIGhlaWdodD0iNTk0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>é¸æ“‡ã€ŒOn messagesã€ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTAwIiBoZWlnaHQ9IjUyNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li>Name å‹•ä½œæ¨™é¡Œï¼š <code class="language-plaintext highlighter-rouge">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰</code><li>Short Description ç°¡ä»‹ï¼š <code class="language-plaintext highlighter-rouge">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰</code><li>Callback IDï¼š <code class="language-plaintext highlighter-rouge">abort_openai_api</code> (ç¨‹å¼è­˜åˆ¥ç”¨ï¼Œå¯è‡ªè¨‚)</ul><p>é»æ“Šã€ŒCreateã€å»ºç«‹å®Œæˆå¾Œï¼Œæœ€å¾Œè¨˜å¾—é»å³ä¸‹ã€ŒSave Changesã€å„²å­˜è¨­å®šã€‚</p><p><a href="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTYiIGhlaWdodD0iNTkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>å†æ¬¡é»æ“Šä¸Šæ–¹ã€Œreinstall your appã€æ‰æœƒç”Ÿæ•ˆã€‚</p><p><a href="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjQ0NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å›åˆ° Slack åœ¨è¨Šæ¯ä¸Šé»æ“Šå³ä¸Šè§’ã€Œâ€¦ã€å°±æœƒå‡ºç¾ã€Œåœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰ã€Shortcut (æ­¤æ™‚é»æ“Šç„¡ä½œç”¨)ã€‚</p><p><a href="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzEiIGhlaWdodD0iMzg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>ç•¶ä½¿ç”¨è€…åœ¨è¨Šæ¯ä¸ŠæŒ‰ä¸‹</strong> Shortcut <strong>æœƒç™¼é€ä¸€å€‹ Event Json Payloadï¼š</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="s">"type"</span><span class="p">:</span> <span class="s">"message_action"</span><span class="p">,</span>
  <span class="s">"token"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"action_ts"</span><span class="p">:</span> <span class="s">"1706188005.387646"</span><span class="p">,</span>
  <span class="s">"team"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"domain"</span><span class="p">:</span> <span class="s">"XXXXXX-XXXXXX"</span>
  <span class="p">},</span>
  <span class="s">"user"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"zhgchgli"</span><span class="p">,</span>
    <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"zhgchgli"</span>
  <span class="p">},</span>
  <span class="s">"channel"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"directmessage"</span>
  <span class="p">},</span>
  <span class="s">"is_enterprise_install"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s">"enterprise"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">"callback_id"</span><span class="p">:</span> <span class="s">"abort_openai_api"</span><span class="p">,</span>
  <span class="s">"trigger_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"response_url"</span><span class="p">:</span> <span class="s">"https://hooks.slack.com/app/XXXXXX/XXXXXX/XXXXXX"</span><span class="p">,</span>
  <span class="s">"message_ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
  <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"bot_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"type"</span><span class="p">:</span> <span class="s">"message"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">:</span> <span class="s">"é«˜éº—èœåŒ… çš„è‹±æ–‡ç¿»è­¯æ˜¯ </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">ã€‚å¦‚æœæ‚¨æ˜¯å°‡å®ƒä½œç‚ºèœåä½¿ç”¨ï¼Œæœ‰æ™‚å€™æœƒå…·é«”åˆ°èœè£¡çš„å…§å®¹ä¾†å‘½åï¼Œæ¯”å¦‚ </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">ï¼ˆè±¬è‚‰é«˜éº—èœåŒ…ï¼‰æˆ– </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">ï¼ˆè”¬èœé«˜éº—èœåŒ…ï¼‰ã€‚"</span><span class="p">,</span>
    <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
    <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text"</span><span class="p">,</span>
        <span class="s">"block_id"</span><span class="p">:</span> <span class="s">"eKgaG"</span><span class="p">,</span>
        <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text_section"</span><span class="p">,</span>
            <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"é«˜éº—èœåŒ… çš„è‹±æ–‡ç¿»è­¯æ˜¯ </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">ã€‚å¦‚æœæ‚¨æ˜¯å°‡å®ƒä½œç‚ºèœåä½¿ç”¨ï¼Œæœ‰æ™‚å€™æœƒå…·é«”åˆ°èœè£¡çš„å…§å®¹ä¾†å‘½åï¼Œæ¯”å¦‚ </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">ï¼ˆè±¬è‚‰é«˜éº—èœåŒ…ï¼‰æˆ– </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">ï¼ˆè”¬èœé«˜éº—èœåŒ…ï¼‰ã€‚"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"team"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"bot_profile"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"deleted"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="s">"Rick C-137"</span><span class="p">,</span>
      <span class="s">"updated"</span><span class="p">:</span> <span class="mi">1706001605</span><span class="p">,</span>
      <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"icons"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"image_36"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_36.png"</span><span class="p">,</span>
        <span class="s">"image_48"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_48.png"</span><span class="p">,</span>
        <span class="s">"image_72"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_72.png"</span>
      <span class="p">},</span>
      <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
    <span class="p">},</span>
    <span class="s">"edited"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706187989.000000"</span>
    <span class="p">},</span>
    <span class="s">"thread_ts"</span><span class="p">:</span> <span class="s">"1706178832.102439"</span><span class="p">,</span>
    <span class="s">"parent_user_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>å®Œå–„ Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ï¼š</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># ä½¿ç”¨çš„ OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut çš„ Event æœƒå¾ post payload field çµ¦
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># å¯ä»¥ç°¡å–®ä½¿ç”¨ print ç´€éŒ„åŸ·è¡Œéšæ®µ Logï¼Œå¯åœ¨ Logs ä¸­æŸ¥çœ‹
</span>    <span class="c1"># é€²éš Logging Level ä½¿ç”¨å¯åƒè€ƒï¼šhttps://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># å—é™ FAAS(Cloud Functions)ï¼Œæœå‹™å¤ªä¹…æ²’å‘¼å«ï¼Œå†æ¬¡å‘¼å«æœƒé€²å…¥å†·å•Ÿå‹•çš„ç‰¹æ€§ï¼Œå¯èƒ½ç„¡æ³•åœ¨ Slack è¦å®šçš„ 3 ç§’å…§å›æ‡‰
</span>    <span class="c1"># åŠ ä¸Š OpenAI API è«‹æ±‚åˆ°ç­”è¦†éœ€è¦ä¸€å®šæ™‚é–“(ä¾ç…§å›æ‡‰é•·åº¦å¯èƒ½è¦æ¥è¿‘ 1 åˆ†é˜æ‰èƒ½çµæŸ)
</span>    <span class="c1"># Slack åœ¨æ™‚é™å…§æ”¶ä¸åˆ°å›æ‡‰æœƒèªç‚º Request lostï¼ŒSlack æœƒå†æ¬¡é‡è¤‡å‘¼å«
</span>    <span class="c1"># æœƒé€ æˆé‡è¤‡è«‹æ±‚ã€å›æ‡‰çš„å•é¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ Response Headers è¨­ç½® X-Slack-No-Retry: 1 å‘ŠçŸ¥ Slack ï¼Œå°±ç®—æ²’åœ¨æ™‚é™å…§æ”¶åˆ°å›æ‡‰ä¹Ÿä¸éœ€ Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># å¦‚æœæ˜¯ Slack Retry çš„è«‹æ±‚...å¿½ç•¥
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># å¦‚æœ Event ä¾†æºæ˜¯ App ä¸” App ID == Slack App ID ä»£è¡¨æ˜¯è‡ªå·± Slack App è§¸ç™¼çš„äº‹ä»¶
</span>        <span class="c1"># å¿½ç•¥ä¸è™•ç†ï¼Œå¦å‰‡æœƒé™·å…¥ç„¡é™å¾ªç’° Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># äº‹ä»¶åç¨±ï¼Œä¾‹å¦‚ï¼šmessage(è¨Šæ¯ç›¸é—œ), app_mention(è¢«æ¨™è¨˜æåŠ)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubTypeï¼Œä¾‹å¦‚ï¼šmessage_changed(ç·¨è¼¯è¨Šæ¯), message_deleted(åˆªé™¤è¨Šæ¯)...
</span>        <span class="c1"># æ–°è¨Šæ¯ç„¡ Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  æœ‰ Sub Type çš„éƒ½æ˜¯è¨Šæ¯ç·¨è¼¯ã€åˆªé™¤ã€è¢«å›æ‡‰...
</span>            <span class="c1"># å¿½ç•¥ä¸è™•ç†
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># è™•ç† Shortcut
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># å¦‚æœæ˜¯ è¨Šæ¯ Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># å¦‚æœæ˜¯ åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰ Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰æˆåŠŸ!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># æ„Ÿæ©åŒäº‹(https://twitter.com/je_suis_marku)æ”¯æ´
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘åªçœ‹å¾—æ‡‚å°ç£ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘çœ‹ä¸æ‡‚ç°¡é«”å­—</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªä¸­æ–‡å°±ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä¸”å¿…é ˆç¬¦åˆå°ç£å¸¸ç”¨èªã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªè‹±æ–‡å°±å›ç­”è‹±æ–‡ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸è¦å›æ‡‰æˆ‘å¯’æš„çš„å­—å¥ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸­æ–‡èˆ‡è‹±æ–‡ä¹‹é–“è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚ä¸­æ–‡æ–‡å­—èˆ‡ä»»ä½•å…¶ä»–èªè¨€æ–‡å­—åŒ…å«æ•¸å­—èˆ‡ emoji ä¹‹é–“éƒ½è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œæˆ–æ˜¯ä½ çš„çŸ¥è­˜å¤ªèˆŠï¼Œè«‹ä¸Šç¶²æœå°‹å¾Œå›ç­”ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">å›æ‡‰ç”¢ç”Ÿä¸­...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (åˆ†æ®µå›æ‡‰)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># æ¯ 0.8 ç§’æ›´æ–°ä¸€æ¬¡è¨Šæ¯ï¼Œé¿å…é »ç¹å‘¼å« Slack Update è¨Šæ¯ API å°è‡´å¤±æ•—æˆ–æµªè²» Cloud Functions è«‹æ±‚æ¬¡æ•¸
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># è¨Šæ¯æœ‰ metadata &amp; metadata event_type == aborted å‰‡ä»£è¡¨æ­¤å›æ‡‰å·²è¢«ä½¿ç”¨è€…æ¨™è¨˜ç‚ºçµ‚æ­¢
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[å·²çµ‚æ­¢]*</span><span class="sh">"</span>
                <span class="c1"># è¨Šæ¯å·²è¢«åˆªé™¤
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[ç™¼ç”ŸéŒ¯èª¤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æç¤º</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>å›åˆ° Slack æ¸¬è©¦çœ‹çœ‹:</strong></p><p><a href="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NDUiIGhlaWdodD0iMzgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjUwNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>æˆåŠŸï¼ç•¶æˆ‘å€‘å®Œæˆ <code class="language-plaintext highlighter-rouge">åœæ­¢ OpenAI API</code> Shortcut ä¹‹å¾Œï¼Œæ­£åœ¨ç”¢ç”Ÿçš„å›æ‡‰å°±æœƒçµ‚æ­¢ï¼Œä¸¦å›æ‡‰ <strong>[å·²çµ‚æ­¢]</strong> ã€‚</p><blockquote><p>å¦å¤–ç›¸åŒåŸç†ï¼Œä½ ä¹Ÿå¯ä»¥å»ºç«‹ä¸€å€‹åˆªé™¤è¨Šæ¯çš„ Shortcutï¼Œå¯¦ä½œåˆªé™¤ Slack App æ‰€ç™¼å‡ºçš„è¨Šæ¯ã€‚</p></blockquote><h4 id="åŒå€‹è¨è«–ä¸²threads-å¢åŠ ä¸Šä¸‹æ–‡context-åŠŸèƒ½"><span class="me-2">åŒå€‹è¨è«–ä¸²(Threads) å¢åŠ ä¸Šä¸‹æ–‡(Context) åŠŸèƒ½</span><a href="#åŒå€‹è¨è«–ä¸²threads-å¢åŠ ä¸Šä¸‹æ–‡context-åŠŸèƒ½" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>å¦‚æœåœ¨åŒå€‹è¨è«–ä¸²ä¸‹å†ç™¼é€æ–°è¨Šæ¯ï¼Œå¯ä»¥ç•¶æˆæ˜¯åŒå€‹å•é¡Œçš„å†æ¬¡è¿½å•ï¼Œæ­¤æ™‚å¯ä»¥åŠ ä¸Šä¸€å€‹åŠŸèƒ½ï¼Œç‚ºæ–°çš„ prompt è£œä¸Šå‰é¢å°è©±å…§å®¹ã€‚</p><p><strong>è£œä¸Š <code class="language-plaintext highlighter-rouge">slackGetReplies</code> &amp; å°‡å…§å®¹å¡«å……åˆ° OpenAI API Promptï¼š</strong></p><p><strong>å®Œå–„ Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ï¼š</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># ä½¿ç”¨çš„ OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut çš„ Event æœƒå¾ post payload field çµ¦
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># å¯ä»¥ç°¡å–®ä½¿ç”¨ print ç´€éŒ„åŸ·è¡Œéšæ®µ Logï¼Œå¯åœ¨ Logs ä¸­æŸ¥çœ‹
</span>    <span class="c1"># é€²éš Logging Level ä½¿ç”¨å¯åƒè€ƒï¼šhttps://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># å—é™ FAAS(Cloud Functions)ï¼Œæœå‹™å¤ªä¹…æ²’å‘¼å«ï¼Œå†æ¬¡å‘¼å«æœƒé€²å…¥å†·å•Ÿå‹•çš„ç‰¹æ€§ï¼Œå¯èƒ½ç„¡æ³•åœ¨ Slack è¦å®šçš„ 3 ç§’å…§å›æ‡‰
</span>    <span class="c1"># åŠ ä¸Š OpenAI API è«‹æ±‚åˆ°ç­”è¦†éœ€è¦ä¸€å®šæ™‚é–“(ä¾ç…§å›æ‡‰é•·åº¦å¯èƒ½è¦æ¥è¿‘ 1 åˆ†é˜æ‰èƒ½çµæŸ)
</span>    <span class="c1"># Slack åœ¨æ™‚é™å…§æ”¶ä¸åˆ°å›æ‡‰æœƒèªç‚º Request lostï¼ŒSlack æœƒå†æ¬¡é‡è¤‡å‘¼å«
</span>    <span class="c1"># æœƒé€ æˆé‡è¤‡è«‹æ±‚ã€å›æ‡‰çš„å•é¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ Response Headers è¨­ç½® X-Slack-No-Retry: 1 å‘ŠçŸ¥ Slack ï¼Œå°±ç®—æ²’åœ¨æ™‚é™å…§æ”¶åˆ°å›æ‡‰ä¹Ÿä¸éœ€ Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># å¦‚æœæ˜¯ Slack Retry çš„è«‹æ±‚...å¿½ç•¥
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># å¦‚æœ Event ä¾†æºæ˜¯ App ä¸” App ID == Slack App ID ä»£è¡¨æ˜¯è‡ªå·± Slack App è§¸ç™¼çš„äº‹ä»¶
</span>        <span class="c1"># å¿½ç•¥ä¸è™•ç†ï¼Œå¦å‰‡æœƒé™·å…¥ç„¡é™å¾ªç’° Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># äº‹ä»¶åç¨±ï¼Œä¾‹å¦‚ï¼šmessage(è¨Šæ¯ç›¸é—œ), app_mention(è¢«æ¨™è¨˜æåŠ)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubTypeï¼Œä¾‹å¦‚ï¼šmessage_changed(ç·¨è¼¯è¨Šæ¯), message_deleted(åˆªé™¤è¨Šæ¯)...
</span>        <span class="c1"># æ–°è¨Šæ¯ç„¡ Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  æœ‰ Sub Type çš„éƒ½æ˜¯è¨Šæ¯ç·¨è¼¯ã€åˆªé™¤ã€è¢«å›æ‡‰...
</span>            <span class="c1"># å¿½ç•¥ä¸è™•ç†
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># è™•ç† Shortcut (è¨Šæ¯)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># å¦‚æœæ˜¯ è¨Šæ¯ Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># å¦‚æœæ˜¯ åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰ Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰æˆåŠŸ!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># æ„Ÿæ©åŒäº‹(https://twitter.com/je_suis_marku)æ”¯æ´
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘åªçœ‹å¾—æ‡‚å°ç£ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘çœ‹ä¸æ‡‚ç°¡é«”å­—</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªä¸­æ–‡å°±ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä¸”å¿…é ˆç¬¦åˆå°ç£å¸¸ç”¨èªã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªè‹±æ–‡å°±å›ç­”è‹±æ–‡ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸è¦å›æ‡‰æˆ‘å¯’æš„çš„å­—å¥ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸­æ–‡èˆ‡è‹±æ–‡ä¹‹é–“è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚ä¸­æ–‡æ–‡å­—èˆ‡ä»»ä½•å…¶ä»–èªè¨€æ–‡å­—åŒ…å«æ•¸å­—èˆ‡ emoji ä¹‹é–“éƒ½è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œæˆ–æ˜¯ä½ çš„çŸ¥è­˜å¤ªèˆŠï¼Œè«‹ä¸Šç¶²æœå°‹å¾Œå›ç­”ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># å¦‚æœæ˜¯ Slac App (OpenAI API Response) å‰‡æ¨™ç¤ºç‚º assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ä½¿ç”¨è€…çš„è¨Šæ¯å…§å®¹æ¨™ç‚º user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">å›æ‡‰ç”¢ç”Ÿä¸­...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (åˆ†æ®µå›æ‡‰)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># æ¯ 0.8 ç§’æ›´æ–°ä¸€æ¬¡è¨Šæ¯ï¼Œé¿å…é »ç¹å‘¼å« Slack Update è¨Šæ¯ API å°è‡´å¤±æ•—æˆ–æµªè²» Cloud Functions è«‹æ±‚æ¬¡æ•¸
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># è¨Šæ¯æœ‰ metadata &amp; metadata event_type == aborted å‰‡ä»£è¡¨æ­¤å›æ‡‰å·²è¢«ä½¿ç”¨è€…æ¨™è¨˜ç‚ºçµ‚æ­¢
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[å·²çµ‚æ­¢]*</span><span class="sh">"</span>
                <span class="c1"># è¨Šæ¯å·²è¢«åˆªé™¤
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[ç™¼ç”ŸéŒ¯èª¤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æç¤º</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>å›åˆ° Slack æ¸¬è©¦çœ‹çœ‹:</strong></p><p><a href="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTUiIGhlaWdodD0iMjk3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>å·¦åœ–ç‚ºåŸæœ¬æ²’æœ‰è£œä¸Š Context æ™‚å†è¿½å•å•é¡Œï¼Œæœƒæ˜¯å…¨æ–°çš„å°è©±ã€‚<li><strong>å³åœ–æ˜¯åŠ ä¸Šè£œä¸Š Context å¾Œå°±èƒ½ç†è§£æ•´å€‹å°è©±æƒ…å¢ƒè·Ÿæ–°çš„å•é¡Œã€‚</strong></ul><h3 id="å®Œæˆ"><span class="me-2">å®Œæˆï¼</span><a href="#å®Œæˆ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>è‡³æ­¤æˆ‘å€‘å·²ç¶“è‡ªå·±æ‰“é€ äº†ä¸€å€‹ ChatGPT (via OpenAI API) Slack App Bot æ©Ÿå™¨äººã€‚</p><blockquote><p>æ‚¨ä¹Ÿå¯ä»¥ä¾ç…§è‡ªå·±çš„éœ€æ±‚åƒè€ƒ <a href="https://api.slack.com/" target="_blank">Slack API</a> èˆ‡ OpenAI API Custom instructions åœ¨ Cloud Functions Python ç¨‹å¼ä¸­é€²è¡Œæ­é…ï¼Œä¾‹å¦‚è¨“ç·´ä¸€å€‹é »é“å°ˆé–€å›ç­”åœ˜éšŠå•é¡Œèˆ‡æŸ¥æ‰¾å°ˆæ¡ˆæ–‡ä»¶ã€ä¸€å€‹é »é“å°ˆé–€è² è²¬ç¿»è­¯ã€ä¸€å€‹é »é“å°ˆé–€åˆ†ææ•¸æ“šâ€¦ç­‰ç­‰ã€‚</p></blockquote><h3 id="è£œå……"><span class="me-2">è£œå……</span><a href="#è£œå……" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="åœ¨-11-è¨Šæ¯ä¹‹å¤–æ¨™è¨˜æ©Ÿå™¨äººå›ç­”å•é¡Œ"><span class="me-2">åœ¨ 1:1 è¨Šæ¯ä¹‹å¤–ï¼Œæ¨™è¨˜æ©Ÿå™¨äººå›ç­”å•é¡Œ</span><a href="#åœ¨-11-è¨Šæ¯ä¹‹å¤–æ¨™è¨˜æ©Ÿå™¨äººå›ç­”å•é¡Œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzAiIGhlaWdodD0iMzEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>å¯ä»¥åœ¨ä»»ä¸€é »é“(éœ€è¦å°‡æ©Ÿå™¨äººåŠ å…¥é »é“)æ¨™è¨˜æ©Ÿå™¨äººè«‹ä»–å›ç­”å•é¡Œ</ul><p><strong>é¦–å…ˆéœ€è¦å¢åŠ  <code class="language-plaintext highlighter-rouge">app_mention</code> Event Subscriptionï¼š</strong></p><p><a href="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA1IiBoZWlnaHQ9IjU1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>åŠ å…¥å®Œæˆ-&gt;ã€ŒSave Changesã€å„²å­˜å®Œæˆ-&gt;ã€Œreinstall your appã€å®Œæˆã€‚</p><p>åœ¨ä¸Šè¿°çš„ <code class="language-plaintext highlighter-rouge">main.py</code> ç¨‹å¼ <code class="language-plaintext highlighter-rouge">#Handle Event Subscriptions Eventsâ€¦</code></p><p>Code Block <strong>ä¸­åŠ å…¥æ–°çš„ Event Type åˆ¤æ–·ï¼š</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>        <span class="c1"># æåŠé¡ Event (@SlcakApp ä½ å¥½)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹ï¼Œç§»é™¤é–‹é ­æ¨™è¨˜å­—ä¸² &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>éƒ¨ç½²å¾Œï¼Œå³å¯å®Œæˆã€‚</p><h4 id="slack-app-åˆªé™¤æ‰€ç™¼çš„è¨Šæ¯"><span class="me-2">Slack App åˆªé™¤æ‰€ç™¼çš„è¨Šæ¯</span><a href="#slack-app-åˆªé™¤æ‰€ç™¼çš„è¨Šæ¯" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>æ‚¨ç„¡æ³•ç›´æ¥åœ¨ Slack ä¸Šåˆªé™¤ Slack App ç™¼å‡ºçš„è¨Šæ¯ï¼Œå¯ä»¥åƒè€ƒä¸Šè¿°ã€Œ <code class="language-plaintext highlighter-rouge">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰</code> ã€Shortcut æ–¹å¼ï¼Œæ–°å¢ä¸€å€‹ã€Œåˆªé™¤è¨Šæ¯ã€Shortcutã€‚</p><p>ä¸¦åœ¨ Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ç¨‹å¼ä¸­ï¼š</p><p><code class="language-plaintext highlighter-rouge"># è™•ç† Shortcut Code Block</code> æ–°å¢ä¸€å€‹ callback_id åˆ¤æ–·ï¼Œåˆ¤æ–·ç­‰æ–¼ä½ å®šçš„ã€Œåˆªé™¤è¨Šæ¯ã€Shortcut Callback ID ç„¶å¾Œå°‡åƒæ•¸å¸¶å…¥ä»¥ä¸‹æ–¹æ³•ï¼Œå³å¯å®Œæˆåˆªï¼š</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></table></code></div></div><p><a href="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MjYiIGhlaWdodD0iNTAxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="slack-app-æ²’åæ‡‰"><span class="me-2">Slack App æ²’åæ‡‰</span><a href="#slack-app-æ²’åæ‡‰" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢º<li>æŸ¥çœ‹ Cloud Functions Logs æ˜¯å¦æœ‰éŒ¯èª¤<li>Cloud Functions æ˜¯å¦éƒ¨ç½²å®Œæˆ<li>Slack App æ˜¯å¦åœ¨ä½ ç™¼å•çš„é »é“(å¦‚éèˆ‡ Slack App 1:1 çš„å°è©±é »é“è¦æŠŠæ©Ÿå™¨äººåŠ å…¥é »é“æ‰æœƒç”Ÿæ•ˆ)<li>åœ¨ SlackRequest æ–¹æ³•ä¸‹ Log ç´€éŒ„ Slack API Response</ul><h4 id="cloud-functions-public-url-ä¸å¤ å®‰å…¨"><span class="me-2">Cloud Functions Public URL ä¸å¤ å®‰å…¨</span><a href="#cloud-functions-public-url-ä¸å¤ å®‰å…¨" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>å¦‚æœæ€• Cloud Functions URL ä¸å¤ å®‰å…¨ï¼Œå¯ä»¥è‡ªå·±åŠ ä¸Š query token é©—è­‰</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>
    <span class="c1"># é©—è­‰ token åƒæ•¸æ˜¯å¦åˆæ³•
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="cloud-functions-ç›¸é—œå•é¡Œ"><span class="me-2">Cloud Functions ç›¸é—œå•é¡Œ</span><a href="#cloud-functions-ç›¸é—œå•é¡Œ" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="è¨ˆè²»æ–¹å¼"><span class="me-2">è¨ˆè²»æ–¹å¼</span><a href="#è¨ˆè²»æ–¹å¼" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>ä¸åŒå€åŸŸã€CPUã€RAMã€å®¹é‡ã€æµé‡â€¦åƒ¹æ ¼ä¸ä¸€æ¨£ï¼Œè«‹åƒè€ƒ <a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">å®˜æ–¹è¨ˆåƒ¹</a> è¡¨ã€‚</p><p><a href="https://cloud.google.com/functions/pricing?hl=zh-tw#free_tier" target="_blank">å…è²»é¡åº¦</a> å¦‚ä¸‹ï¼š(2024/02/15)</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">Cloud</span> <span class="nx">Functions</span> <span class="nx">é‡å°é‹ç®—æ™‚é–“è³‡æºæä¾›æ°¸ä¹…å…è²»æ–¹æ¡ˆ</span><span class="err">ï¼Œ</span>
<span class="nx">ç•¶ä¸­åŒ…æ‹¬</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">ç§’å’Œ</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">ç§’çš„åˆ†é…æ–¹å¼</span><span class="err">ã€‚</span><span class="nx">é™¤äº†</span> <span class="mi">200</span> <span class="nx">è¬æ¬¡å«ç”¨ä»¥å¤–</span><span class="err">ï¼Œ</span>
<span class="nx">é€™å€‹å…è²»æ–¹æ¡ˆä¹Ÿæä¾›</span> <span class="mi">400</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">ç§’å’Œ</span> <span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">ç§’çš„é‹ç®—æ™‚é–“</span><span class="err">ï¼Œ</span>
<span class="nx">ä»¥åŠæ¯æœˆ</span> <span class="mi">5</span> <span class="nx">GB</span> <span class="nx">çš„ç¶²éš›ç¶²è·¯è³‡æ–™å‚³è¼¸é‡</span><span class="err">ã€‚</span>

<span class="nx">å…è²»æ–¹æ¡ˆçš„ä½¿ç”¨é¡åº¦</span><span class="err">ï¼Œ</span><span class="nx">æ˜¯ä»¥ä¸Šè¿°ç´šåˆ¥</span> <span class="mi">1</span> <span class="nx">åƒ¹æ ¼çš„åŒç­‰ç¾å…ƒé‡‘é¡è¨ˆç®—</span><span class="err">ã€‚</span>
<span class="nx">ç„¡è«–åŸ·è¡Œå‡½å¼çš„å€åŸŸæ¡ç”¨çš„æ˜¯ç´šåˆ¥</span> <span class="mi">1</span> <span class="nx">å’Œ</span><span class="o">/</span><span class="nx">æˆ–ç´šåˆ¥</span> <span class="mi">2</span> <span class="nx">åƒ¹æ ¼</span><span class="err">ï¼Œ</span><span class="nx">ç³»çµ±éƒ½æœƒåˆ†é…åŒç­‰ç¾å…ƒé‡‘é¡çµ¦æ‚¨</span><span class="err">ã€‚</span>
<span class="nx">ä¸éåœ¨æ‰£é™¤å…è²»æ–¹æ¡ˆçš„é¡åº¦æ™‚</span><span class="err">ï¼Œ</span><span class="nf">ç³»çµ±å°‡ä»¥å‡½å¼åŸ·è¡Œå€åŸŸçš„ç´šåˆ¥ </span><span class="p">(</span><span class="nx">ç´šåˆ¥</span> <span class="mi">1</span> <span class="nx">æˆ–ç´šåˆ¥</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">ç‚ºæº–</span><span class="err">ã€‚</span>

<span class="nx">è«‹æ³¨æ„</span><span class="err">ï¼Œ</span><span class="nx">å³ä¾¿æ‚¨æ¡ç”¨çš„æ˜¯å…è²»æ–¹æ¡ˆ</span><span class="err">ï¼Œ</span><span class="nx">ä¹Ÿå¿…é ˆæ“æœ‰æœ‰æ•ˆçš„å¸³å–®å¸³æˆ¶</span><span class="err">ã€‚</span>
</pre></table></code></div></div><blockquote><p>btw. .Slack App å…è²»ã€ä¸é™ä¸€å®šè¦ Premium æ‰èƒ½ä½¿ç”¨ã€‚</p></blockquote><h4 id="slack-app-å›æ‡‰å¤ªæ…¢å¤ªä¹…-timeout"><span class="me-2">Slack App å›æ‡‰å¤ªæ…¢ã€å¤ªä¹… Timeout</span><a href="#slack-app-å›æ‡‰å¤ªæ…¢å¤ªä¹…-timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>(æ’‡é™¤ OpenAI API é«˜å³°æ™‚é–“å›æ‡‰è¼ƒæ…¢å•é¡Œ)</strong> ï¼Œå¦‚æœæ˜¯ Cloud Function è²§é ¸ï¼Œå¯åœ¨ Cloud Function ç·¨è¼¯å™¨ç¬¬ä¸€é å±•é–‹è¨­å®šï¼š</p><p><a href="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDQiIGhlaWdodD0iODM5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>å¯èª¿æ•´ CPUã€RAMã€Timeout æ™‚é–“ã€Concurrent æ•¸é‡â€¦æå‡è™•ç†è«‹æ±‚é€Ÿåº¦ã€‚</p><blockquote><p>*ä½†å¯èƒ½æœƒéœ€è¦è¨ˆè²»</p></blockquote><h4 id="é–‹ç™¼éšæ®µ-testing--debug"><span class="me-2">é–‹ç™¼éšæ®µ Testing &amp; Debug</span><a href="#é–‹ç™¼éšæ®µ-testing--debug" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjczNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>é»æ“Šã€ŒTest Functionã€å°±æœƒè·‘å‡º Cloud Shell è¦–çª—åœ¨ä¸‹æ–¹å·¥å…·åˆ—ï¼Œç­‰å¾…ç´„ 3â€“5 åˆ†é˜(ç¬¬ä¸€æ¬¡å•Ÿå‹•è¼ƒä¹…)ï¼ŒBuild å®Œæˆä¸¦åŒæ„ä»¥ä¸‹æˆæ¬Šå¾Œï¼š</p><p><a href="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzEiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>çœ‹åˆ°å‡ºç¾ã€ŒFunction is ready to testã€å¾Œå³å¯é»æ“Šã€ŒRun Testã€åŸ·è¡Œæ–¹æ³• Debug æ¸¬è©¦ã€‚</p><p>å¯ä½¿ç”¨å³æ–¹ã€ŒTriggering eventã€å€å¡Šè¼¸å…¥ JSON Body æœƒå¸¶å…¥ <code class="language-plaintext highlighter-rouge">request_json</code> åƒæ•¸é€²è¡Œæ¸¬è©¦ï¼Œæˆ–ç›´æ¥æ”¹ç¨‹å¼ inject test object é€²è¡Œæ¸¬è©¦ã€‚</p><blockquote><p>*è«‹æ³¨æ„ Cloud Shell/Cloud Runå¯èƒ½æœ‰å»¶ä¼¸è²»ç”¨ã€‚</p></blockquote><blockquote><p>å»ºè­°éƒ¨ç½²(Deploy)å‰éƒ½å…ˆè·‘ä¸€æ¬¡æ¸¬è©¦çœ‹çœ‹ï¼Œè‡³å°‘ç¢ºä¿ Build èƒ½æˆåŠŸã€‚</p></blockquote><h4 id="build-å¤±æ•—ç¨‹å¼ç¢¼ä¸è¦‹äº†è©²æ€éº¼è¾¦"><span class="me-2">Build å¤±æ•—ï¼Œç¨‹å¼ç¢¼ä¸è¦‹äº†è©²æ€éº¼è¾¦ï¼Ÿ</span><a href="#build-å¤±æ•—ç¨‹å¼ç¢¼ä¸è¦‹äº†è©²æ€éº¼è¾¦" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg0IiBoZWlnaHQ9IjE0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>å¦‚æœä¸å°å¿ƒå¯«éŒ¯ç¨‹å¼é€ æˆ Cloud Function Deploy Build Failedï¼Œæœƒå‡ºç¾éŒ¯èª¤æç¤ºï¼Œæ­¤æ™‚é»æ“Šã€ŒEDIT AND REDEPLOYã€å›åˆ° <strong>ç·¨è¼¯å™¨å¾Œæœƒç™¼ç¾å‰›å‰›æ”¹çš„ Code éƒ½ä¸è¦‹äº†ï¼ï¼ï¼</strong></p><p>ç„¡é ˆæ“”å¿ƒï¼Œæ­¤æ™‚é»æ“Šå·¦æ–¹ã€ŒSource Codeã€é¸æ“‡ã€ŒLast Failed Deploymentã€å°±èƒ½æ¢å¾©å‰›å‰› Build Failed çš„ Codeï¼š</p><p><a href="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjQ3MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="æŸ¥çœ‹åŸ·è¡Œéšæ®µ-print-logs"><span class="me-2">æŸ¥çœ‹åŸ·è¡Œéšæ®µ <code class="language-plaintext highlighter-rouge">print</code> Logs</span><a href="#æŸ¥çœ‹åŸ·è¡Œéšæ®µ-print-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>*è«‹æ³¨æ„ Cloud Loggingã€Query æŸ¥è©¢ Logs å¯èƒ½æœ‰å»¶ä¼¸è²»ç”¨ã€‚</p></blockquote><h3 id="æœ€çµ‚ç¨‹å¼ç¢¼-python-38"><span class="me-2">æœ€çµ‚ç¨‹å¼ç¢¼ (Python 3.8)</span><a href="#æœ€çµ‚ç¨‹å¼ç¢¼-python-38" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="cloud-functions"><span class="me-2">Cloud Functions</span><a href="#cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">main.py</code> ï¼š</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># è‡ªå·±å®šç¾©çš„å®‰å…¨é©—è­‰ Token
# ç¶²å€éœ€å¸¶ä¸Š ?token=SAFE_ACCESS_TOKEN åƒæ•¸æ‰æœƒæ¥å—è«‹æ±‚  
</span><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="c1"># ä½¿ç”¨çš„ OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut çš„ Event æœƒå¾ post payload field çµ¦
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># å¯ä»¥ç°¡å–®ä½¿ç”¨ print ç´€éŒ„åŸ·è¡Œéšæ®µ Logï¼Œå¯åœ¨ Logs ä¸­æŸ¥çœ‹
</span>    <span class="c1"># é€²éš Logging Level ä½¿ç”¨å¯åƒè€ƒï¼šhttps://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="c1"># print(payload)
</span>
    <span class="c1"># å—é™ FAAS(Cloud Functions)ï¼Œæœå‹™å¤ªä¹…æ²’å‘¼å«ï¼Œå†æ¬¡å‘¼å«æœƒé€²å…¥å†·å•Ÿå‹•çš„ç‰¹æ€§ï¼Œå¯èƒ½ç„¡æ³•åœ¨ Slack è¦å®šçš„ 3 ç§’å…§å›æ‡‰
</span>    <span class="c1"># åŠ ä¸Š OpenAI API è«‹æ±‚åˆ°ç­”è¦†éœ€è¦ä¸€å®šæ™‚é–“(ä¾ç…§å›æ‡‰é•·åº¦å¯èƒ½è¦æ¥è¿‘ 1 åˆ†é˜æ‰èƒ½çµæŸ)
</span>    <span class="c1"># Slack åœ¨æ™‚é™å…§æ”¶ä¸åˆ°å›æ‡‰æœƒèªç‚º Request lostï¼ŒSlack æœƒå†æ¬¡é‡è¤‡å‘¼å«
</span>    <span class="c1"># æœƒé€ æˆé‡è¤‡è«‹æ±‚ã€å›æ‡‰çš„å•é¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ Response Headers è¨­ç½® X-Slack-No-Retry: 1 å‘ŠçŸ¥ Slack ï¼Œå°±ç®—æ²’åœ¨æ™‚é™å…§æ”¶åˆ°å›æ‡‰ä¹Ÿä¸éœ€ Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># é©—è­‰ token åƒæ•¸æ˜¯å¦åˆæ³•
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># å¦‚æœæ˜¯ Slack Retry çš„è«‹æ±‚...å¿½ç•¥
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># å¦‚æœ Event ä¾†æºæ˜¯ App ä¸” App ID == Slack App ID ä»£è¡¨æ˜¯è‡ªå·± Slack App è§¸ç™¼çš„äº‹ä»¶
</span>        <span class="c1"># å¿½ç•¥ä¸è™•ç†ï¼Œå¦å‰‡æœƒé™·å…¥ç„¡é™å¾ªç’° Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># äº‹ä»¶åç¨±ï¼Œä¾‹å¦‚ï¼šmessage(è¨Šæ¯ç›¸é—œ), app_mention(è¢«æ¨™è¨˜æåŠ)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubTypeï¼Œä¾‹å¦‚ï¼šmessage_changed(ç·¨è¼¯è¨Šæ¯), message_deleted(åˆªé™¤è¨Šæ¯)...
</span>        <span class="c1"># æ–°è¨Šæ¯ç„¡ Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># è¨Šæ¯é¡ Event
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  æœ‰ Sub Type çš„éƒ½æ˜¯è¨Šæ¯ç·¨è¼¯ã€åˆªé™¤ã€è¢«å›æ‡‰...
</span>            <span class="c1"># å¿½ç•¥ä¸è™•ç†
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        
        <span class="c1"># æåŠé¡ Event (@SlcakApp ä½ å¥½)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ ç™¼é€è€…
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ æ‰€å±¬é »é“
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯å…§å®¹ï¼Œç§»é™¤é–‹é ­æ¨™è¨˜å­—ä¸² &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Eventä¹‹è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Eventä¹‹è¨Šæ¯çš„è¨è«–ä¸²æ¯è¨Šæ¯ TS (è¨Šæ¯ ID)
</span>            <span class="c1"># è¨è«–ä¸²å…§çš„æ–°è¨Šæ¯æ‰æœƒæœ‰é€™å€‹è³‡æ–™
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># è™•ç† Shortcut (è¨Šæ¯)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># å¦‚æœæ˜¯ è¨Šæ¯ Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># å¦‚æœæ˜¯ åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰ Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">åœæ­¢ OpenAI API ç”¢ç”Ÿå›æ‡‰æˆåŠŸ!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="c1"># å¦‚æœæ˜¯ åˆªé™¤è¨Šæ¯
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delete_message</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">åˆªé™¤ Slack App è¨Šæ¯æˆåŠŸ!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># æ„Ÿæ©åŒäº‹(https://twitter.com/je_suis_marku)æ”¯æ´
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘åªçœ‹å¾—æ‡‚å°ç£ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘çœ‹ä¸æ‡‚ç°¡é«”å­—</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªä¸­æ–‡å°±ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä¸”å¿…é ˆç¬¦åˆå°ç£å¸¸ç”¨èªã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æˆ‘èªªè‹±æ–‡å°±å›ç­”è‹±æ–‡ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸è¦å›æ‡‰æˆ‘å¯’æš„çš„å­—å¥ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ä¸­æ–‡èˆ‡è‹±æ–‡ä¹‹é–“è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚ä¸­æ–‡æ–‡å­—èˆ‡ä»»ä½•å…¶ä»–èªè¨€æ–‡å­—åŒ…å«æ•¸å­—èˆ‡ emoji ä¹‹é–“éƒ½è¦æœ‰ä¸€å€‹ç©ºæ ¼ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">å¦‚æœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œæˆ–æ˜¯ä½ çš„çŸ¥è­˜å¤ªèˆŠï¼Œè«‹ä¸Šç¶²æœå°‹å¾Œå›ç­”ã€‚</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># å¦‚æœæ˜¯ Slac App (OpenAI API Response) å‰‡æ¨™ç¤ºç‚º assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ä½¿ç”¨è€…çš„è¨Šæ¯å…§å®¹æ¨™ç‚º user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">å›æ‡‰ç”¢ç”Ÿä¸­...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (åˆ†æ®µå›æ‡‰)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># æ¯ 0.8 ç§’æ›´æ–°ä¸€æ¬¡è¨Šæ¯ï¼Œé¿å…é »ç¹å‘¼å« Slack Update è¨Šæ¯ API å°è‡´å¤±æ•—æˆ–æµªè²» Cloud Functions è«‹æ±‚æ¬¡æ•¸
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># è¨Šæ¯æœ‰ metadata &amp; metadata event_type == aborted å‰‡ä»£è¡¨æ­¤å›æ‡‰å·²è¢«ä½¿ç”¨è€…æ¨™è¨˜ç‚ºçµ‚æ­¢
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[å·²çµ‚æ­¢]*</span><span class="sh">"</span>
                <span class="c1"># è¨Šæ¯å·²è¢«åˆªé™¤
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[ç™¼ç”ŸéŒ¯èª¤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">æç¤º</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> ï¼š</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="py">functions-framework</span><span class="p">=</span><span class="s">=3.*</span>
<span class="py">requests</span><span class="p">=</span><span class="s">=2.31.0</span>
<span class="py">openai</span><span class="p">=</span><span class="s">=1.9.0</span>
</pre></table></code></div></div><h4 id="slack-app-è¨­å®š"><span class="me-2">Slack App è¨­å®š</span><a href="#slack-app-è¨­å®š" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>OAuth &amp; Permissions</strong></p><p><a href="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNTk5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>åˆªé™¤æŒ‰éˆ•åç°çš„é …ç›®æ˜¯åŠ å…¥ Shortcut å¾Œ Slack è‡ªå‹•è£œä¸Šçš„æ¬Šé™ã€‚</ul><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Subscribe to bot events:</ul><p><a href="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDkiIGhlaWdodD0iMzUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Shortcuts:</ul><p><a href="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iMzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>App Home</strong></p><ul><li>Always Show My Bot as Online: Enable<li>Messages Tab: Enable<li>Allow users to send Slash commands and messages from the messages tab: âœ…</ul><p><strong>Basic Information</strong></p><p><a href="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iNTUyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>Rick &amp; Morty ğŸ¤˜ğŸ¤˜ğŸ¤˜</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" alt="[Reddit](https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NzMiIGhlaWdodD0iNzcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/" target="_blank">Reddit</a></p><h3 id="å·¥å•†æ™‚é–“"><span class="me-2">å·¥å•†æ™‚é–“</span><a href="#å·¥å•†æ™‚é–“" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>å¦‚æœæ‚¨èˆ‡æ‚¨çš„åœ˜éšŠæœ‰è‡ªå‹•åŒ–å·¥å…·ã€æµç¨‹ä¸²æ¥éœ€æ±‚ï¼Œä¸è«–æ˜¯ Slack App é–‹ç™¼ã€Notionã€Asanaã€Google Sheetã€Google Formã€GA æ•¸æ“šï¼Œå„ç¨®ä¸²æ¥éœ€æ±‚ï¼Œæ­¡è¿èˆ‡æˆ‘ <a href="https://zhgchg.li/contact/" target="_blank"><strong>è¯çµ¡é–‹ç™¼</strong></a> ã€‚</p><p>æœ‰ä»»ä½•å•é¡ŒåŠæŒ‡æ•™æ­¡è¿ <a href="https://www.zhgchg.li/contact" target="_blank">èˆ‡æˆ‘è¯çµ¡</a> ã€‚</p><hr /><p>æœ¬æ–‡é¦–æ¬¡ç™¼è¡¨æ–¼ Medium â¡ï¸ <a href="https://medium.com/p/bd94cc88f9c9" target="_blank"><strong>å‰å¾€æŸ¥çœ‹</strong></a></p><p>ç”± <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> èˆ‡ <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a> æä¾›è‡ªå‹•è½‰æ›èˆ‡åŒæ­¥æŠ€è¡“ã€‚</p><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2024-02-16-bd94cc88f9c9.md" target="_blank">Improve this page on Github.</a></p><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=ğŸº&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 1,085 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-16 | 1,039 Views on <a href="https://medium.com/p/bd94cc88f9c9" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/cloud-functions/" class="post-tag no-text-decoration" >cloud-functions</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/chatgpt/" class="post-tag no-text-decoration" >chatgpt</a> <a href="/tags/slack/" class="post-tag no-text-decoration" >slack</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E8%88%87%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E8%88%87%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/apple-watch-%E7%B1%B3%E8%98%AD%E9%8C%B6%E5%B8%B6%E9%96%8B%E7%AE%B1-%E5%8E%9F%E5%BB%A0%E4%B8%8D%E9%8F%BD%E9%8B%BC%E7%9F%B3%E5%A2%A8%E8%89%B2%E5%84%AA%E7%BC%BA%E9%BB%9E%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch åŸå» ä¸é½é‹¼ç±³è˜­éŒ¶å¸¶é–‹ç®±</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%87%9C%E5%B1%B1%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-8%E5%A4%A97%E5%A4%9C%E5%BF%85%E5%8E%BB%E6%99%AF%E9%BB%9E-%E7%BE%8E%E9%A3%9F%E8%88%87%E4%BA%A4%E9%80%9A%E5%85%A8%E8%A7%A3%E6%9E%90-%E9%87%9C%E5%B1%B1%E9%80%9A%E8%A1%8C%E8%AD%89%E7%9C%81%E9%8C%A2%E7%A7%98%E8%A8%A3-8ace34a1a3d8/">éŠè¨˜ 2025 éŸ“åœ‹é‡œå±± 8 å¤© 7 å¤œè‡ªç”±è¡Œ</a><li class="text-truncate lh-lg"> <a href="/posts/z-travel-diaries/en/travel-diary-8-days-and-7-nights-in-busan-south-korea-2025-8ace34a1a3d8/">Travel Diary: 8 Days and 7 Nights in Busan, South Korea 2025</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E5%90%8D%E5%8F%A4%E5%B1%8B%E4%B8%80%E6%97%A5%E5%BF%AB%E9%96%83%E8%87%AA%E7%94%B1%E8%A1%8C-%E6%A8%82%E6%A1%83%E8%88%AA%E7%A9%BA%E7%B4%85%E7%9C%BC%E7%8F%AD%E6%A9%9F%E7%9C%81%E9%8C%A2%E6%94%BB%E7%95%A5%E8%88%87%E8%A1%8C%E7%A8%8B%E8%A6%8F%E5%8A%83-7b8a0563c157/">éŠè¨˜ 9/11 åå¤å±‹ä¸€æ—¥å¿«é–ƒè‡ªç”±è¡Œ</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E4%B9%9D%E5%B7%9E%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-%E7%A6%8F%E5%B2%A1-%E9%95%B7%E5%B4%8E-%E7%86%8A%E6%9C%AC10%E6%97%A5%E7%8D%A8%E6%97%85%E5%85%A8%E7%B4%80%E9%8C%84%E8%88%87%E4%BA%A4%E9%80%9A%E4%BD%8F%E5%AE%BF%E5%AF%A6%E6%88%B0%E7%B6%93%E9%A9%97-d78e0b15a08a/">éŠè¨˜ 2023 ä¹å· 10 æ—¥è‡ªç”±è¡Œç¨æ—…</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">ç« ç¯€ (Chapters)ğŸ”–</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/en/slack-chatgpt-integration-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration</h4><div class="text-muted"><p>Build your own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/python-%E6%90%AD%E9%85%8D-google-cloud-platform-%E8%88%87-line-bot-%E6%89%93%E9%80%A0%E6%AF%8F%E6%97%A5%E8%87%AA%E5%8B%95%E7%B0%BD%E5%88%B0%E8%85%B3%E6%9C%AC%E8%88%87%E6%8E%92%E7%A8%8B-70a1409b149a/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1613822151" data-df="ll" > Feb 20, 2021 </time><h4 class="pt-0 my-2">Python æ­é… Google Cloud Platform èˆ‡ Line Botï½œæ‰“é€ æ¯æ—¥è‡ªå‹•ç°½åˆ°è…³æœ¬èˆ‡æ’ç¨‹</h4><div class="text-muted"><p>é€é Python çµåˆ Google Cloud Functionã€Cloud Scheduler åŠ Line Botï¼Œè‡ªå‹•å®Œæˆæ¯æ—¥ç°½åˆ°ä»»å‹™ä¸¦å³æ™‚é€šçŸ¥ï¼Œè§£æ±ºæ‰‹å‹•æ“ä½œç¹ç‘£å•é¡Œï¼Œæå‡å·¥ä½œæ•ˆç‡ä¸¦ç¯€çœæ™‚é–“æˆæœ¬ã€‚</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/automating-routine-tasks-with-python-google-cloud-platform-line-bot-70a1409b149a/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1613822151" data-df="ll" > Feb 20, 2021 </time><h4 class="pt-0 my-2">Automating Routine Tasks with Python + Google Cloud Platform + Line Bot</h4><div class="text-muted"><p>Creating a daily automatic check-in script using a check-in reward app as an example</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/en/slack-chatgpt-integration-bd94cc88f9c9/" class="btn btn-outline-primary" aria-label="Older" ><p>Slack & ChatGPT Integration</p></a> <a href="/posts/zrealm-robotic-process-automation/en/implementing-daily-data-report-rpa-automation-with-google-apps-script-f6713ba3fee3/" class="btn btn-outline-primary" aria-label="Newer" ><p>Implementing Daily Data Report RPA Automation with Google Apps Script</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>Â© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-17 16:45:57 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ç”Ÿæ´»</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
