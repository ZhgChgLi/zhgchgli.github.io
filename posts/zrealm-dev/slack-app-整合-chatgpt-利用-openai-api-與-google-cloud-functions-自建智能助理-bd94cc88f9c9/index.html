<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="針對團隊協作痛點，打造可自訂 OpenAI API Key 的 Slack ChatGPT 機器人，運用 Google Cloud Functions 快速部署，實現即時問答與上下文串接，提升工作效率並保障資料安全。" /><meta property="og:description" content="針對團隊協作痛點，打造可自訂 OpenAI API Key 的 Slack ChatGPT 機器人，運用 Google Cloud Functions 快速部署，實現即時問答與上下文串接，提升工作效率並保障資料安全。" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-16T21:17:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="twitter:title" content="Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-02-18T12:09:17+08:00","datePublished":"2024-02-16T21:17:01+08:00","description":"針對團隊協作痛點，打造可自訂 OpenAI API Key 的 Slack ChatGPT 機器人，運用 Google Cloud Functions 快速部署，實現即時問答與上下文串接，提升工作效率並保障資料安全。","headline":"Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"},"url":"https://zhgchg.li/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"}</script><title>Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理 | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"如何用 Google Cloud Functions 快速部署自訂 OpenAI API Slack App，解決市面 App 無法自訂 API Key 的困境？","acceptedAnswer":{"@type":"Answer","text":"透過 Google Cloud Functions 部署 Python 程式碼，搭配 Slack App 事件訂閱與 OAuth 權限設定，自行串接 OpenAI API，讓團隊成員能自由使用自訂 API Key，避免市面訂閱制 App 不開放自訂 Key 的限制，提升整合彈性與安全性。"}},{"@type":"Question","name":"如何解決 Cloud Functions 冷啟動及 Slack 回應超時問題，確保 Slack App 穩定回應？","acceptedAnswer":{"@type":"Answer","text":"利用 HTTP 回應標頭設置 X-Slack-No-Retry: 1 防止 Slack 重複請求，並在 Cloud Functions 調整 CPU、RAM 與 Timeout 時間，搭配非同步串流更新訊息，減少冷啟動與回應延遲導致的重複呼叫與超時問題，確保 Slack App 穩定運作。"}},{"@type":"Question","name":"如何在 Slack App 中實現 OpenAI API 回應中斷功能，避免浪費 Token 並提升使用體驗？","acceptedAnswer":{"@type":"Answer","text":"透過 Slack App 新增訊息 Shortcut，使用者點擊後在 Cloud Functions 中更新訊息 metadata 標記為中斷，OpenAI API 分段回應時檢查該標記即停止串流，達到即時中斷回應，節省 Token 並提升互動效率。"}},{"@type":"Question","name":"如何讓 Slack App 支援同討論串上下文記憶，提升 ChatGPT 回應的連貫性？","acceptedAnswer":{"@type":"Answer","text":"利用 Slack API conversations.replies 取得同討論串歷史訊息，並根據是否為機器人回覆標記角色（user 或 assistant），將上下文訊息加入 OpenAI API prompt，讓 ChatGPT 理解對話背景，提升回應的連貫性與準確度。"}},{"@type":"Question","name":"如何確保 Cloud Functions 公開 URL 的安全性，避免未授權存取 Slack App 服務？","acceptedAnswer":{"@type":"Answer","text":"在 Cloud Functions 程式中加入自訂安全驗證機制，要求所有請求帶入預設的 token 參數並驗證其正確性，未通過驗證即拒絕存取，避免惡意或未授權的外部請求，提升服務安全性。"}}]} </script><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理</h1><p class="post-desc fw-light mb-4">針對團隊協作痛點，打造可自訂 OpenAI API Key 的 Slack ChatGPT 機器人，運用 Google Cloud Functions 快速部署，實現即時問答與上下文串接，提升工作效率並保障資料安全。</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1708089421" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 16, 2024 </time> </span> <span> Updated <time data-ts="1708229357" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link preview-img blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="11578 words" > <em>64 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Slack App 整合 ChatGPT｜利用 OpenAI API 與 Google Cloud Functions 自建智能助理</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><strong>Click here</strong></a> to view the English version of this article.</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><strong>点击这里</strong></a>查看本文章简体中文版本。</p></blockquote><blockquote class="prompt-info"><p>基於 SEO 考量，本文標題與描述經 AI 調整，原始版本請參考內文。</p></blockquote><h4 id="zhgchgli-table-of-contents">文章目錄</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>Slack & ChatGPT Integration <a href="#slack--chatgpt-integration">#</a></summary><ul><li><a href="#背景">背景</a></li><li><a href="#chrome-extension-sidebargpt">[Chrome Extension] SidebarGPT</a></li><li><a href="#chrome-extension-openai-translator">[Chrome Extension] OpenAI Translator</a></li><li><a href="#self-hosted-librechat">[Self-hosted] LibreChat</a></li></ul></details></li><li class="has-children"><details><summary>Slack App <a href="#slack-app">#</a></summary><ul><li><a href="#slack-apps">Slack Apps</a></li></ul></details></li><li class="has-children"><details><summary>自行實現 ChatGPT OpenAI API for Slack App <a href="#自行實現-chatgpt-openai-api-for-slack-app">#</a></summary><ul><li><a href="#最終成果圖">最終成果圖</a></li></ul></details></li><li class="has-children"><details><summary>Step 1. 建立 Slack App <a href="#step-1-建立-slack-app">#</a></summary><ul><li><a href="#啟用-event-subscriptions-功能">啟用 Event Subscriptions 功能</a></li><li><a href="#新增-google-cloud-funtions">新增 Google Cloud Funtions</a></li></ul></details></li><li class="has-children"><details><summary>Step 2. 完善 OpenAI API 與 Slack App 串接 (Direct 訊息) <a href="#step-2-完善-openai-api-與-slack-app-串接-direct-訊息">#</a></summary><ul><li><a href="#處理-direct-message-im-event--串接-openai-api-回應">處理 Direct Message (IM) Event & 串接 OpenAI API 回應</a></li><li><a href="#增加中斷-stream-response-功能節省-token">增加中斷 Stream Response 功能節省 Token</a></li><li><a href="#同個討論串threads-增加上下文context-功能">同個討論串(Threads) 增加上下文(Context) 功能</a></li></ul></details></li><li><a href="#完成">完成！</a></li><li class="has-children"><details><summary>補充 <a href="#補充">#</a></summary><ul><li><a href="#在-11-訊息之外標記機器人回答問題">在 1:1 訊息之外，標記機器人回答問題</a></li><li><a href="#slack-app-刪除所發的訊息">Slack App 刪除所發的訊息</a></li><li><a href="#slack-app-沒反應">Slack App 沒反應</a></li><li><a href="#cloud-functions-public-url-不夠安全">Cloud Functions Public URL 不夠安全</a></li></ul></details></li><li class="has-children"><details><summary>Cloud Functions 相關問題 <a href="#cloud-functions-相關問題">#</a></summary><ul><li><a href="#計費方式">計費方式</a></li><li><a href="#slack-app-回應太慢太久-timeout">Slack App 回應太慢、太久 Timeout</a></li><li><a href="#開發階段-testing--debug">開發階段 Testing & Debug</a></li><li><a href="#build-失敗程式碼不見了該怎麼辦">Build 失敗，程式碼不見了該怎麼辦？</a></li><li><a href="#查看執行階段-print-logs">查看執行階段 print Logs</a></li></ul></details></li><li class="has-children"><details><summary>最終程式碼 (Python 3.8) <a href="#最終程式碼-python-38">#</a></summary><ul><li><a href="#cloud-functions">Cloud Functions</a></li><li><a href="#slack-app-設定">Slack App 設定</a></li></ul></details></li><li><a href="#工商時間">工商時間</a></li></ul></nav><hr /><h3 id="slack--chatgpt-integration"><span class="me-2">Slack &amp; ChatGPT Integration</span><a href="#slack--chatgpt-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>自行打造 ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p><h4 id="背景"><span class="me-2">背景</span><a href="#背景" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>最近在團隊內推廣運用 Generative AI 提升工作效率，初步只希望達成 AI Assistant (ChatGPT 功能)，從減少日常資料查詢、整理繁瑣資料、手工處理資料的時間，以提升工作效率；希望是工程師、設計師、PM、行銷…都能自由使用的。</p><p>最簡單的方法就是直接買 ChatGPT Team 方案，一個席位 $25 美金一年；但由於尚不確定大家的使用頻率(量)及希望能在外來與更多協作、開發流程進行整合，所以改採用 OpenAI API 方式，再透過其他服務封裝整合供團隊成員使用。</p><p>OpenAI API Key 可從 <a href="https://platform.openai.com/api-keys" target="_blank">此頁面產生</a> ，Key 沒有分對應的 Model 版本，使用時才需指定要使用的 Model 版本並產生對應的 Token 費用。</p><blockquote><p>我們需要一個服務能自行設定 OpenAI API Key 並使用該 Key 進行類 ChatGPT 使用。</p></blockquote><blockquote><p>不管是 Chrome Extension 或 Slack App 都蠻難找到能自行設定 OpenAI API Key 的服務，大部分服務都是要賣他們自己的訂閱制，讓使用者自訂 API Key 等於賺不到錢純做慈善。</p></blockquote><h4 id="chrome-extension-sidebargpt"><span class="me-2">[Chrome Extension] <a href="https://chromewebstore.google.com/detail/chatgpt-assistant-for-chr/mejjgaogggabifjfjdbnobinfibaamla" target="_blank">SidebarGPT</a></span><a href="#chrome-extension-sidebargpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>安裝完後可到設定 -&gt; General -&gt; 填入 OpenAI API Key。</p><p><a href="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijc2OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>可從瀏覽器小工具欄、側邊 Icon 直接呼叫出聊天界面，直接使用：</p><p><a href="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjcwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="chrome-extension-openai-translator"><span class="me-2">[Chrome Extension] <a href="https://chrome.google.com/webstore/detail/ogjibjphoadhljaoicdnjnmgokohngcc" target="_blank">OpenAI Translator</a></span><a href="#chrome-extension-openai-translator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>如果只有翻譯需求可使用這個，能自訂 OpenAI API Key 用於翻譯。</p><p><a href="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzQiIGhlaWdodD0iMTI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MzkiIGhlaWdodD0iMzc2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>另外他是 <a href="https://github.com/openai-translator/openai-translator" target="_blank">開源專案</a> ，並同時提供 macOS/Windows 桌面版程式：</p><p><a href="https://github.com/openai-translator/openai-translator" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/609416865/2fee2046-51a5-407c-9641-851e5032ec63" alt="" loading="lazy"></a></p><p>Chrome Extension 的優點是快速簡單方便，直接裝直接使用；缺點是需要將 API Key 提供給所有成員，難以管控外洩問題，還有使用第三方服務也難以保證大家的資料安全。</p><h4 id="self-hosted-librechat"><span class="me-2">[Self-hosted] <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a></span><a href="#self-hosted-librechat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/danny-avila/LibreChat" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/102ca4ff10ae06f9a1fa9f7126e73ef92a641310dd20377ac942cdc7132b79f9/danny-avila/LibreChat" alt="" loading="lazy"></a></p><p>研發部同事推薦的 OpenAI API Chat 封裝服務，提供身份認證使用及幾乎還原 ChatGPT 使用介面、功能比 ChatGPT 更強大的開源專案。</p><p><a href="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>只需專案、裝好 Docker、設定好 .env、啟 Docker 服務就能直接透過網站連入使用。</p><blockquote><p><strong>試了一下簡直無懈可擊，就是本地版 ChatGPT 服務；要說缺點的話就只有需要伺服器部署服務吧；如果沒其他考量，可以直接使用此開源專案。</strong></p></blockquote><h3 id="slack-app"><span class="me-2">Slack App</span><a href="#slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>其實 <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a> 服務起起來放上伺服器就已經達成效果了，但是靈光一閃想說如果能整合在日常工具當中是不是更方便？加上公司伺服器有嚴格的權限設定，不太能隨意起服務。</p><p>當時也沒想太多，想說 Slack App 的 OpenAI API 整合服務應該很多，找一個設定一下就好；沒想到事情沒有那麼簡單。</p><p>Google 搜尋只找到一篇 Slack x OpenAI 2023/03 官方的新聞稿「 <a href="https://slack.com/intl/zh-tw/blog/news/why-we-built-the-chatgpt-app-for-slack" target="_blank">Why we built the ChatGPT app for Slack</a> 」及一些 Beta 圖片：</p><p><a href="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" alt="[https://www.salesforce.com/news/stories/chatgpt-app-for-slack/](https://www.salesforce.com/news/stories/chatgpt-app-for-slack/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjU2MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://www.salesforce.com/news/stories/chatgpt-app-for-slack/" target="_blank">https://www.salesforce.com/news/stories/chatgpt-app-for-slack/</a></p><p>看起來功能非常完整而且能大大提升工作效率，不過截自 2024/01 為止尚無釋出的消息，文末提供的 <a href="http://openai.com/waitlist/slack" target="_blank">Beta 註冊連結</a> 也已經失效，暫時沒有下文。(還是微軟想先讓 Teams 支援？)</p><p><strong>[2024/02/14 Update]：</strong></p><ul><li>看 <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack 官方新聞</a> 猜測與 ChatGPT(OpenAI) 整合的功能應該已經被放棄或改整合成 <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack AI</a> 。</ul><h4 id="slack-apps"><span class="me-2">Slack Apps</span><a href="#slack-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjkiIGhlaWdodD0iODU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>因無官方的 App 轉而搜尋第三方開發者的 App，搜尋並試用了幾個都碰壁；符合的 App 不多就算了，也沒有一個是能提供自訂 Key 功能的，每個都是做來賣服務、賣錢的。</p><h3 id="自行實現-chatgpt-openai-api-for-slack-app"><span class="me-2">自行實現 ChatGPT OpenAI API for Slack App</span><a href="#自行實現-chatgpt-openai-api-for-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>之前有一些 Slack App 開發經驗，決定自己動手做。</p><blockquote><p><strong>⚠️聲明⚠️</strong></p></blockquote><blockquote><p>本文是以串接 OpenAI API 為例演示如何建立 Slack App 和快速使用 Google Cloud Funtions 來達成需求，Slack App 有需多應用可做，大家可以自由發揮。</p></blockquote><blockquote><p>⚠️⚠️ Google Cloud Functions，Function as a Service (FaaS) 的優點是方便快速、有免費額度，程式寫好就能直接部署執行、自動擴充，缺點是服務環境由 GCP 控制，當服務太久沒被呼叫會進入休眠，此時再次呼叫會進入 <a href="https://cloud.google.com/functions/docs/configuring/recommender?hl=en" target="_blank">Cold Start</a> 冷啟動，需要較長的反應時間；另外也較難起多個服務互相使用。</p></blockquote><blockquote><p>更完整或使用需求量大的話還是建議自己起 VM (App Engine) 架 Server 跑服務。</p></blockquote><h4 id="最終成果圖"><span class="me-2">最終成果圖</span><a href="#最終成果圖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDIiIGhlaWdodD0iNDg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>完整 Cloud Functions Python 程式碼、Slack App 設定已附在文末，懶得一步一步看的朋友可快速前往查閱。</p></blockquote><h3 id="step-1-建立-slack-app"><span class="me-2">Step 1. 建立 Slack App</span><a href="#step-1-建立-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>前往 <a href="https://api.slack.com/apps" target="_blank">Slack App</a> ：</p><p><a href="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjYiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>點擊「Create New App」</p><p><a href="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTAiIGhlaWdodD0iNDExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>選擇「From scratch」</p><p><a href="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTEiIGhlaWdodD0iNDg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>輸入「App Name」、選擇要加入的 Workspace。</p><p><a href="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5ODIiIGhlaWdodD0iNzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>建立完成後先到「OAuth &amp; Permissions」新增 Bot 需要的權限。</p><p><a href="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNjMxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>下滑找到「Scopes」區塊，點擊「Add an OAuth Scope」搜尋加入以下幾個權限：</p><ul><li>chat:write<li>im:history<li>im:read<li>im:write</ul><p>Bot 權限加完之後點擊左方「Install App」-&gt;「Install to Workspace」</p><p><a href="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA5IiBoZWlnaHQ9IjMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>爾後如果 Slack App 有新增其他權限，都需要再點擊一次「Reinstall」才會生效。</p><p><a href="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzMiIGhlaWdodD0iODI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><strong>但請放心，Bot Token 不會因為重新安裝而改變。</strong></p></blockquote><p>Slack Bot Token 權限設定好之後，前往「App Home」：</p><p><a href="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTkiIGhlaWdodD0iNDkzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>下滑找到「Show Tabs」區塊，啟用「Messages Tab」及「Allow users to send Slash commands and messages from the messages tab」(這個沒勾一樣不能傳訊息，會顯示「Sending messages to this app has been turned off.」)</p><p><a href="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDgiIGhlaWdodD0iNTU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>回到 Slack Workspace，按「Command+R」更新畫面就能看到新建立的 Slack App 和訊息輸入匡：</p><p><a href="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg2IiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>此時傳送訊息給 App 還沒有任何功能。</p><h4 id="啟用-event-subscriptions-功能"><span class="me-2">啟用 Event Subscriptions 功能</span><a href="#啟用-event-subscriptions-功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjEiIGhlaWdodD0iNzc4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>再來，我們需要啟用 Slack App 的事件訂閱功能，當指定事件發生時會打 API 到指定 URL。</p><h4 id="新增-google-cloud-funtions"><span class="me-2">新增 Google Cloud Funtions</span><a href="#新增-google-cloud-funtions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Request URL 的部分， <a href="https://console.cloud.google.com/functions/list" target="_blank">Google Cloud Funtions</a> 就要上場了。</p><p>設定好專案、帳單資訊後點擊「Create Function」</p><p><a href="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjI4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDgiIGhlaWdodD0iODM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Function name 輸入專案名稱、Authentication 選擇「Allow unauthenticated invocations」意即知道網址就能存取。</p><blockquote><p>如果你無法建立 Function 或無法更改 Authentication 代表你的 GCP 帳號沒有完整的 Google Cloud Functions 權限，需要請組織管理員在原本的身份之外額外加上 Cloud Functions Admin 的權限，才能使用。</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTUyIiBoZWlnaHQ9Ijc4MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Runtime: Python 3.8 or 更高</p><p><code class="language-plaintext highlighter-rouge">main.py</code> ：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># 可以簡單使用 print 紀錄執行階段 Log，可在 Logs 中查看
</span>    <span class="c1"># 進階 Logging Level 使用可參考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服務太久沒呼叫，再次呼叫會進入冷啟動的特性，可能無法在 Slack 規定的 3 秒內回應
</span>    <span class="c1"># 加上 OpenAI API 請求到答覆需要一定時間(依照回應長度可能要接近 1 分鐘才能結束)
</span>    <span class="c1"># Slack 在時限內收不到回應會認為 Request lost，Slack 會再次重複呼叫
</span>    <span class="c1"># 會造成重複請求、回應的問題，因此我們可以在 Response Headers 設置 X-Slack-No-Retry: 1 告知 Slack ，就算沒在時限內收到回應也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的請求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> 輸入以下依賴：</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>functions-framework==3.*
requests==2.31.0
openai==1.9.0
</pre></table></code></div></div><p>目前還沒有什麼功能，只是讓 Slack App 能通過 Event Subscriptions 啟用驗證，可以直接點擊「Deploy」完成首次部署。</p><blockquote><p>⚠️如果你不熟悉 Cloud Functions 編輯器，可先下拉到文章底部查看補充內容。</p></blockquote><p><strong>等待部署完成後（綠勾勾）</strong> ，複製 Cloud Functions URL：</p><p><a href="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjI3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>將 Request URL 貼回 Slack App Enable Events。</p><p><a href="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iMzAyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>如果沒問題就會出現「Verified」完成驗證。</p><p>這邊做的事是收到 Slack 發來的驗證請求時：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jhj5dZrVaK7ZwHHjRyZWjbDl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"challenge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url_verification"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>回應 <code class="language-plaintext highlighter-rouge">challenge</code> 欄位內容，就能通過驗證。</p><p><a href="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MzciIGhlaWdodD0iODYxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>啟用成功後往下滑找到「Subscribe to bot events」區塊，點擊「Add Bot User Event」新增「message.im」權限。</p><p><a href="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDQiIGhlaWdodD0iMTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>新增完全權限後點擊上方「reinstall your app」連結重新安裝 Slack App 到 Workspace 後，Slack App 的設定就告一段落囉。</p><p>也可以去「App Home」或「Basic Information」客製化 Slack App 的名稱與大頭貼。</p><p><a href="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" alt="Basic Information" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjUiIGhlaWdodD0iNTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Basic Information</p><h3 id="step-2-完善-openai-api-與-slack-app-串接-direct-訊息"><span class="me-2">Step 2. 完善 OpenAI API 與 Slack App 串接 (Direct 訊息)</span><a href="#step-2-完善-openai-api-與-slack-app-串接-direct-訊息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>首先我們先要取得必備的 <code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> 與 <code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> 兩個 Key。</p><ul><li><code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> ： <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI API key page</a> .</ul><p><a href="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcwIiBoZWlnaHQ9IjQwNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> ： <a href="https://api.slack.com/apps/" target="_blank">OAuth Tokens for Your Workspace</a></ul><p><a href="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTEiIGhlaWdodD0iNzE4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="處理-direct-message-im-event--串接-openai-api-回應"><span class="me-2">處理 Direct Message (IM) Event &amp; 串接 OpenAI API 回應</span><a href="#處理-direct-message-im-event--串接-openai-api-回應" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>當使用者在與 Slack App 訊息傳送時會收到以下 Event Json Paylod ：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"api_app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"client_msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"block_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"orfng"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text_section"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"你好"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"team"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"event_ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"im"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event_callback"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1707920753</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorizations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_bot"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_enterprise_install"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"is_ext_shared_channel"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_context"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4-XXX"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>基於以上 Json Payload，我們可以完善 Slack 訊息到 OpenAI API 再到回覆 Slack 訊息的串接：</p><p><strong>Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># 可以簡單使用 print 紀錄執行階段 Log，可在 Logs 中查看
</span>    <span class="c1"># 進階 Logging Level 使用可參考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服務太久沒呼叫，再次呼叫會進入冷啟動的特性，可能無法在 Slack 規定的 3 秒內回應
</span>    <span class="c1"># 加上 OpenAI API 請求到答覆需要一定時間(依照回應長度可能要接近 1 分鐘才能結束)
</span>    <span class="c1"># Slack 在時限內收不到回應會認為 Request lost，Slack 會再次重複呼叫
</span>    <span class="c1"># 會造成重複請求、回應的問題，因此我們可以在 Response Headers 設置 X-Slack-No-Retry: 1 告知 Slack ，就算沒在時限內收到回應也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的請求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># 如果 Event 來源是 App 且 App ID == Slack App ID 代表是自己 Slack App 觸發的事件
</span>        <span class="c1"># 忽略不處理，否則會陷入無限循環 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名稱，例如：message(訊息相關), app_mention(被標記提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(編輯訊息), message_deleted(刪除訊息)...
</span>        <span class="c1"># 新訊息無 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是訊息編輯、刪除、被回應...
</span>            <span class="c1"># 忽略不處理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台灣繁體中文與英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂簡體字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說中文就使用台灣繁體中文回答，並且必須符合台灣常用語。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回應我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文與英文之間要有一個空格。中文文字與任何其他語言文字包含數字與 emoji 之間都要有一個空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知識太舊，請上網搜尋後回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回應產生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回應)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次訊息，避免頻繁呼叫 Slack Update 訊息 API 導致失敗或浪費 Cloud Functions 請求次數
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[發生錯誤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 測試看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU2OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>現在你已經可以進行類 ChatGPT 與 OpenAI API 進行問與答了。</p><h4 id="增加中斷-stream-response-功能節省-token"><span class="me-2">增加中斷 Stream Response 功能節省 Token</span><a href="#增加中斷-stream-response-功能節省-token" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>實現方式有很多種，可在同條討論串下如果還沒回應完，使用者又輸入新訊息則中斷之前的 Response 抑或是點擊訊息增加中斷回應的 Shortcut。</p><p><a href="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDEiIGhlaWdodD0iNDUxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>本文以新增「訊息中斷」Shortcut 為例。</p><p>不管哪一種中斷方式，核心原理都是相同的，因為我們沒有 Database 儲存產生的訊息、訊息狀態的資訊；因此實現方式是依賴 Slack 訊息的 <a href="https://api.slack.com/metadata/using" target="_blank"><strong>metadata 欄位</strong></a> (可存放客製化資訊在指定訊息內)。</p><p>我們在使用 <a href="https://api.slack.com/methods/chat.update" target="_blank">chat.update</a> API Endpoint 時，如果呼叫成功會回傳當前訊息的文字內容與 metadata，因此我們在上面的 OpenAI API Stream -&gt; Slack Update Message 的程式碼之中多加入判斷修改請求的回應中的 metadata 是否有「中斷」的標記，如果有則中斷 OpenAI Stream Response。</p><p><strong>首先需要先新增 Slack App 訊息 Shortcut</strong></p><p>前往 <a href="https://api.slack.com/apps" target="_blank">Slack App</a> 管理介面，找到「Interactivity &amp; Shortcuts」區塊，點擊啟用，網址一樣使用同個 Cloud Functions URL。</p><p><a href="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTQiIGhlaWdodD0iNzQ3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>點擊「Create New Shortcut」新增新的訊息 Shortcut。</p><p><a href="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTAiIGhlaWdodD0iNTk0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>選擇「On messages」。</p><p><a href="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTAwIiBoZWlnaHQ9IjUyNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li>Name 動作標題： <code class="language-plaintext highlighter-rouge">停止 OpenAI API 產生回應</code><li>Short Description 簡介： <code class="language-plaintext highlighter-rouge">停止 OpenAI API 產生回應</code><li>Callback ID： <code class="language-plaintext highlighter-rouge">abort_openai_api</code> (程式識別用，可自訂)</ul><p>點擊「Create」建立完成後，最後記得點右下「Save Changes」儲存設定。</p><p><a href="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTYiIGhlaWdodD0iNTkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>再次點擊上方「reinstall your app」才會生效。</p><p><a href="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjQ0NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>回到 Slack 在訊息上點擊右上角「…」就會出現「停止 OpenAI API 產生回應」Shortcut (此時點擊無作用)。</p><p><a href="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzEiIGhlaWdodD0iMzg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>當使用者在訊息上按下</strong> Shortcut <strong>會發送一個 Event Json Payload：</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="s">"type"</span><span class="p">:</span> <span class="s">"message_action"</span><span class="p">,</span>
  <span class="s">"token"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"action_ts"</span><span class="p">:</span> <span class="s">"1706188005.387646"</span><span class="p">,</span>
  <span class="s">"team"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"domain"</span><span class="p">:</span> <span class="s">"XXXXXX-XXXXXX"</span>
  <span class="p">},</span>
  <span class="s">"user"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"zhgchgli"</span><span class="p">,</span>
    <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"zhgchgli"</span>
  <span class="p">},</span>
  <span class="s">"channel"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"directmessage"</span>
  <span class="p">},</span>
  <span class="s">"is_enterprise_install"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s">"enterprise"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">"callback_id"</span><span class="p">:</span> <span class="s">"abort_openai_api"</span><span class="p">,</span>
  <span class="s">"trigger_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"response_url"</span><span class="p">:</span> <span class="s">"https://hooks.slack.com/app/XXXXXX/XXXXXX/XXXXXX"</span><span class="p">,</span>
  <span class="s">"message_ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
  <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"bot_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"type"</span><span class="p">:</span> <span class="s">"message"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">:</span> <span class="s">"高麗菜包 的英文翻譯是 </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">。如果您是將它作為菜名使用，有時候會具體到菜裡的內容來命名，比如 </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">（豬肉高麗菜包）或 </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">（蔬菜高麗菜包）。"</span><span class="p">,</span>
    <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
    <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text"</span><span class="p">,</span>
        <span class="s">"block_id"</span><span class="p">:</span> <span class="s">"eKgaG"</span><span class="p">,</span>
        <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text_section"</span><span class="p">,</span>
            <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"高麗菜包 的英文翻譯是 </span><span class="se">\"</span><span class="s">cabbage wrap</span><span class="se">\"</span><span class="s">。如果您是將它作為菜名使用，有時候會具體到菜裡的內容來命名，比如 </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s">（豬肉高麗菜包）或 </span><span class="se">\"</span><span class="s">vegetable cabbage wrap</span><span class="se">\"</span><span class="s">（蔬菜高麗菜包）。"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"team"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"bot_profile"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"deleted"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="s">"Rick C-137"</span><span class="p">,</span>
      <span class="s">"updated"</span><span class="p">:</span> <span class="mi">1706001605</span><span class="p">,</span>
      <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"icons"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"image_36"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_36.png"</span><span class="p">,</span>
        <span class="s">"image_48"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_48.png"</span><span class="p">,</span>
        <span class="s">"image_72"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_72.png"</span>
      <span class="p">},</span>
      <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
    <span class="p">},</span>
    <span class="s">"edited"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706187989.000000"</span>
    <span class="p">},</span>
    <span class="s">"thread_ts"</span><span class="p">:</span> <span class="s">"1706178832.102439"</span><span class="p">,</span>
    <span class="s">"parent_user_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>完善 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 會從 post payload field 給
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以簡單使用 print 紀錄執行階段 Log，可在 Logs 中查看
</span>    <span class="c1"># 進階 Logging Level 使用可參考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服務太久沒呼叫，再次呼叫會進入冷啟動的特性，可能無法在 Slack 規定的 3 秒內回應
</span>    <span class="c1"># 加上 OpenAI API 請求到答覆需要一定時間(依照回應長度可能要接近 1 分鐘才能結束)
</span>    <span class="c1"># Slack 在時限內收不到回應會認為 Request lost，Slack 會再次重複呼叫
</span>    <span class="c1"># 會造成重複請求、回應的問題，因此我們可以在 Response Headers 設置 X-Slack-No-Retry: 1 告知 Slack ，就算沒在時限內收到回應也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的請求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># 如果 Event 來源是 App 且 App ID == Slack App ID 代表是自己 Slack App 觸發的事件
</span>        <span class="c1"># 忽略不處理，否則會陷入無限循環 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名稱，例如：message(訊息相關), app_mention(被標記提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(編輯訊息), message_deleted(刪除訊息)...
</span>        <span class="c1"># 新訊息無 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是訊息編輯、刪除、被回應...
</span>            <span class="c1"># 忽略不處理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 處理 Shortcut
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 訊息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 產生回應 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 產生回應成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台灣繁體中文與英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂簡體字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說中文就使用台灣繁體中文回答，並且必須符合台灣常用語。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回應我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文與英文之間要有一個空格。中文文字與任何其他語言文字包含數字與 emoji 之間都要有一個空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知識太舊，請上網搜尋後回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回應產生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回應)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次訊息，避免頻繁呼叫 Slack Update 訊息 API 導致失敗或浪費 Cloud Functions 請求次數
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 訊息有 metadata &amp; metadata event_type == aborted 則代表此回應已被使用者標記為終止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已終止]*</span><span class="sh">"</span>
                <span class="c1"># 訊息已被刪除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[發生錯誤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 測試看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NDUiIGhlaWdodD0iMzgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjUwNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>成功！當我們完成 <code class="language-plaintext highlighter-rouge">停止 OpenAI API</code> Shortcut 之後，正在產生的回應就會終止，並回應 <strong>[已終止]</strong> 。</p><blockquote><p>另外相同原理，你也可以建立一個刪除訊息的 Shortcut，實作刪除 Slack App 所發出的訊息。</p></blockquote><h4 id="同個討論串threads-增加上下文context-功能"><span class="me-2">同個討論串(Threads) 增加上下文(Context) 功能</span><a href="#同個討論串threads-增加上下文context-功能" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>如果在同個討論串下再發送新訊息，可以當成是同個問題的再次追問，此時可以加上一個功能，為新的 prompt 補上前面對話內容。</p><p><strong>補上 <code class="language-plaintext highlighter-rouge">slackGetReplies</code> &amp; 將內容填充到 OpenAI API Prompt：</strong></p><p><strong>完善 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> ：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 會從 post payload field 給
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以簡單使用 print 紀錄執行階段 Log，可在 Logs 中查看
</span>    <span class="c1"># 進階 Logging Level 使用可參考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 受限 FAAS(Cloud Functions)，服務太久沒呼叫，再次呼叫會進入冷啟動的特性，可能無法在 Slack 規定的 3 秒內回應
</span>    <span class="c1"># 加上 OpenAI API 請求到答覆需要一定時間(依照回應長度可能要接近 1 分鐘才能結束)
</span>    <span class="c1"># Slack 在時限內收不到回應會認為 Request lost，Slack 會再次重複呼叫
</span>    <span class="c1"># 會造成重複請求、回應的問題，因此我們可以在 Response Headers 設置 X-Slack-No-Retry: 1 告知 Slack ，就算沒在時限內收到回應也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 如果是 Slack Retry 的請求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># 如果 Event 來源是 App 且 App ID == Slack App ID 代表是自己 Slack App 觸發的事件
</span>        <span class="c1"># 忽略不處理，否則會陷入無限循環 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名稱，例如：message(訊息相關), app_mention(被標記提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(編輯訊息), message_deleted(刪除訊息)...
</span>        <span class="c1"># 新訊息無 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是訊息編輯、刪除、被回應...
</span>            <span class="c1"># 忽略不處理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 處理 Shortcut (訊息)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 訊息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 產生回應 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 產生回應成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台灣繁體中文與英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂簡體字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說中文就使用台灣繁體中文回答，並且必須符合台灣常用語。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回應我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文與英文之間要有一個空格。中文文字與任何其他語言文字包含數字與 emoji 之間都要有一個空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知識太舊，請上網搜尋後回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># 如果是 Slac App (OpenAI API Response) 則標示為 assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 使用者的訊息內容標為 user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回應產生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回應)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次訊息，避免頻繁呼叫 Slack Update 訊息 API 導致失敗或浪費 Cloud Functions 請求次數
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 訊息有 metadata &amp; metadata event_type == aborted 則代表此回應已被使用者標記為終止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已終止]*</span><span class="sh">"</span>
                <span class="c1"># 訊息已被刪除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[發生錯誤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>回到 Slack 測試看看:</strong></p><p><a href="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTUiIGhlaWdodD0iMjk3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>左圖為原本沒有補上 Context 時再追問問題，會是全新的對話。<li><strong>右圖是加上補上 Context 後就能理解整個對話情境跟新的問題。</strong></ul><h3 id="完成"><span class="me-2">完成！</span><a href="#完成" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>至此我們已經自己打造了一個 ChatGPT (via OpenAI API) Slack App Bot 機器人。</p><blockquote><p>您也可以依照自己的需求參考 <a href="https://api.slack.com/" target="_blank">Slack API</a> 與 OpenAI API Custom instructions 在 Cloud Functions Python 程式中進行搭配，例如訓練一個頻道專門回答團隊問題與查找專案文件、一個頻道專門負責翻譯、一個頻道專門分析數據…等等。</p></blockquote><h3 id="補充"><span class="me-2">補充</span><a href="#補充" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="在-11-訊息之外標記機器人回答問題"><span class="me-2">在 1:1 訊息之外，標記機器人回答問題</span><a href="#在-11-訊息之外標記機器人回答問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzAiIGhlaWdodD0iMzEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>可以在任一頻道(需要將機器人加入頻道)標記機器人請他回答問題</ul><p><strong>首先需要增加 <code class="language-plaintext highlighter-rouge">app_mention</code> Event Subscription：</strong></p><p><a href="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA1IiBoZWlnaHQ9IjU1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>加入完成-&gt;「Save Changes」儲存完成-&gt;「reinstall your app」完成。</p><p>在上述的 <code class="language-plaintext highlighter-rouge">main.py</code> 程式 <code class="language-plaintext highlighter-rouge">#Handle Event Subscriptions Events…</code></p><p>Code Block <strong>中加入新的 Event Type 判斷：</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>        <span class="c1"># 提及類 Event (@SlcakApp 你好)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容，移除開頭標記字串 &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>部署後，即可完成。</p><h4 id="slack-app-刪除所發的訊息"><span class="me-2">Slack App 刪除所發的訊息</span><a href="#slack-app-刪除所發的訊息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>您無法直接在 Slack 上刪除 Slack App 發出的訊息，可以參考上述「 <code class="language-plaintext highlighter-rouge">停止 OpenAI API 產生回應</code> 」Shortcut 方式，新增一個「刪除訊息」Shortcut。</p><p>並在 Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> 程式中：</p><p><code class="language-plaintext highlighter-rouge"># 處理 Shortcut Code Block</code> 新增一個 callback_id 判斷，判斷等於你定的「刪除訊息」Shortcut Callback ID 然後將參數帶入以下方法，即可完成刪：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></table></code></div></div><p><a href="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MjYiIGhlaWdodD0iNTAxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="slack-app-沒反應"><span class="me-2">Slack App 沒反應</span><a href="#slack-app-沒反應" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>檢查 Token 是否正確<li>查看 Cloud Functions Logs 是否有錯誤<li>Cloud Functions 是否部署完成<li>Slack App 是否在你發問的頻道(如非與 Slack App 1:1 的對話頻道要把機器人加入頻道才會生效)<li>在 SlackRequest 方法下 Log 紀錄 Slack API Response</ul><h4 id="cloud-functions-public-url-不夠安全"><span class="me-2">Cloud Functions Public URL 不夠安全</span><a href="#cloud-functions-public-url-不夠安全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>如果怕 Cloud Functions URL 不夠安全，可以自己加上 query token 驗證</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>
    <span class="c1"># 驗證 token 參數是否合法
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="cloud-functions-相關問題"><span class="me-2">Cloud Functions 相關問題</span><a href="#cloud-functions-相關問題" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="計費方式"><span class="me-2">計費方式</span><a href="#計費方式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>不同區域、CPU、RAM、容量、流量…價格不一樣，請參考 <a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">官方計價</a> 表。</p><p><a href="https://cloud.google.com/functions/pricing?hl=zh-tw#free_tier" target="_blank">免費額度</a> 如下：(2024/02/15)</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">Cloud</span> <span class="nx">Functions</span> <span class="nx">針對運算時間資源提供永久免費方案</span><span class="err">，</span>
<span class="nx">當中包括</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">秒和</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">秒的分配方式</span><span class="err">。</span><span class="nx">除了</span> <span class="mi">200</span> <span class="nx">萬次叫用以外</span><span class="err">，</span>
<span class="nx">這個免費方案也提供</span> <span class="mi">400</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GB</span><span class="o">/</span><span class="nx">秒和</span> <span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GHz</span><span class="o">/</span><span class="nx">秒的運算時間</span><span class="err">，</span>
<span class="nx">以及每月</span> <span class="mi">5</span> <span class="nx">GB</span> <span class="nx">的網際網路資料傳輸量</span><span class="err">。</span>

<span class="nx">免費方案的使用額度</span><span class="err">，</span><span class="nx">是以上述級別</span> <span class="mi">1</span> <span class="nx">價格的同等美元金額計算</span><span class="err">。</span>
<span class="nx">無論執行函式的區域採用的是級別</span> <span class="mi">1</span> <span class="nx">和</span><span class="o">/</span><span class="nx">或級別</span> <span class="mi">2</span> <span class="nx">價格</span><span class="err">，</span><span class="nx">系統都會分配同等美元金額給您</span><span class="err">。</span>
<span class="nx">不過在扣除免費方案的額度時</span><span class="err">，</span><span class="nf">系統將以函式執行區域的級別 </span><span class="p">(</span><span class="nx">級別</span> <span class="mi">1</span> <span class="nx">或級別</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">為準</span><span class="err">。</span>

<span class="nx">請注意</span><span class="err">，</span><span class="nx">即便您採用的是免費方案</span><span class="err">，</span><span class="nx">也必須擁有有效的帳單帳戶</span><span class="err">。</span>
</pre></table></code></div></div><blockquote><p>btw. .Slack App 免費、不限一定要 Premium 才能使用。</p></blockquote><h4 id="slack-app-回應太慢太久-timeout"><span class="me-2">Slack App 回應太慢、太久 Timeout</span><a href="#slack-app-回應太慢太久-timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>(撇除 OpenAI API 高峰時間回應較慢問題)</strong> ，如果是 Cloud Function 貧頸，可在 Cloud Function 編輯器第一頁展開設定：</p><p><a href="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDQiIGhlaWdodD0iODM5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>可調整 CPU、RAM、Timeout 時間、Concurrent 數量…提升處理請求速度。</p><blockquote><p>*但可能會需要計費</p></blockquote><h4 id="開發階段-testing--debug"><span class="me-2">開發階段 Testing &amp; Debug</span><a href="#開發階段-testing--debug" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjYyOSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>點擊「Test Function」就會跑出 Cloud Shell 視窗在下方工具列，等待約 3–5 分鐘(第一次啟動較久)，Build 完成並同意以下授權後：</p><p><a href="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzEiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>看到出現「Function is ready to test」後即可點擊「Run Test」執行方法 Debug 測試。</p><p>可使用右方「Triggering event」區塊輸入 JSON Body 會帶入 <code class="language-plaintext highlighter-rouge">request_json</code> 參數進行測試，或直接改程式 inject test object 進行測試。</p><blockquote><p>*請注意 Cloud Shell/Cloud Run可能有延伸費用。</p></blockquote><blockquote><p>建議部署(Deploy)前都先跑一次測試看看，至少確保 Build 能成功。</p></blockquote><h4 id="build-失敗程式碼不見了該怎麼辦"><span class="me-2">Build 失敗，程式碼不見了該怎麼辦？</span><a href="#build-失敗程式碼不見了該怎麼辦" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg0IiBoZWlnaHQ9IjE0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>如果不小心寫錯程式造成 Cloud Function Deploy Build Failed，會出現錯誤提示，此時點擊「EDIT AND REDEPLOY」回到 <strong>編輯器後會發現剛剛改的 Code 都不見了！！！</strong></p><p>無須擔心，此時點擊左方「Source Code」選擇「Last Failed Deployment」就能恢復剛剛 Build Failed 的 Code：</p><p><a href="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjQ3MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="查看執行階段-print-logs"><span class="me-2">查看執行階段 <code class="language-plaintext highlighter-rouge">print</code> Logs</span><a href="#查看執行階段-print-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>*請注意 Cloud Logging、Query 查詢 Logs 可能有延伸費用。</p></blockquote><h3 id="最終程式碼-python-38"><span class="me-2">最終程式碼 (Python 3.8)</span><a href="#最終程式碼-python-38" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="cloud-functions"><span class="me-2">Cloud Functions</span><a href="#cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">main.py</code> ：</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># 自己定義的安全驗證 Token
# 網址需帶上 ?token=SAFE_ACCESS_TOKEN 參數才會接受請求  
</span><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="c1"># 使用的 OPENAI API Model
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut 的 Event 會從 post payload field 給
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># 可以簡單使用 print 紀錄執行階段 Log，可在 Logs 中查看
</span>    <span class="c1"># 進階 Logging Level 使用可參考：https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="c1"># print(payload)
</span>
    <span class="c1"># 受限 FAAS(Cloud Functions)，服務太久沒呼叫，再次呼叫會進入冷啟動的特性，可能無法在 Slack 規定的 3 秒內回應
</span>    <span class="c1"># 加上 OpenAI API 請求到答覆需要一定時間(依照回應長度可能要接近 1 分鐘才能結束)
</span>    <span class="c1"># Slack 在時限內收不到回應會認為 Request lost，Slack 會再次重複呼叫
</span>    <span class="c1"># 會造成重複請求、回應的問題，因此我們可以在 Response Headers 設置 X-Slack-No-Retry: 1 告知 Slack ，就算沒在時限內收到回應也不需 Retry    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># 驗證 token 參數是否合法
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># 如果是 Slack Retry 的請求...忽略
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># 如果 Event 來源是 App 且 App ID == Slack App ID 代表是自己 Slack App 觸發的事件
</span>        <span class="c1"># 忽略不處理，否則會陷入無限循環 Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># 事件名稱，例如：message(訊息相關), app_mention(被標記提及)....
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType，例如：message_changed(編輯訊息), message_deleted(刪除訊息)...
</span>        <span class="c1"># 新訊息無 Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># 訊息類 Event
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1">#  有 Sub Type 的都是訊息編輯、刪除、被回應...
</span>            <span class="c1"># 忽略不處理
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        
        <span class="c1"># 提及類 Event (@SlcakApp 你好)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Event之訊息 發送者
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息 所屬頻道
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event之訊息內容，移除開頭標記字串 &lt;@SLACKAPPID&gt; 
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Event之訊息 TS (訊息 ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event之訊息的討論串母訊息 TS (訊息 ID)
</span>            <span class="c1"># 討論串內的新訊息才會有這個資料
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># 處理 Shortcut (訊息)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># 如果是 訊息 Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># 如果是 停止 OpenAI API 產生回應 Shortcut
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">停止 OpenAI API 產生回應成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="c1"># 如果是 刪除訊息
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delete_message</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">刪除 Slack App 訊息成功!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># 感恩同事(https://twitter.com/je_suis_marku)支援
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我只看得懂台灣繁體中文與英文</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我看不懂簡體字</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說中文就使用台灣繁體中文回答，並且必須符合台灣常用語。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">我說英文就回答英文。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">不要回應我寒暄的字句。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">中文與英文之間要有一個空格。中文文字與任何其他語言文字包含數字與 emoji 之間都要有一個空格。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">如果你不知道答案，或是你的知識太舊，請上網搜尋後回答。</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># 如果是 Slac App (OpenAI API Response) 則標示為 assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 使用者的訊息內容標為 user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">回應產生中...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (分段回應)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># 每 0.8 秒更新一次訊息，避免頻繁呼叫 Slack Update 訊息 API 導致失敗或浪費 Cloud Functions 請求次數
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># 訊息有 metadata &amp; metadata event_type == aborted 則代表此回應已被使用者標記為終止
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[已終止]*</span><span class="sh">"</span>
                <span class="c1"># 訊息已被刪除
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[發生錯誤]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">提示</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> ：</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="py">functions-framework</span><span class="p">=</span><span class="s">=3.*</span>
<span class="py">requests</span><span class="p">=</span><span class="s">=2.31.0</span>
<span class="py">openai</span><span class="p">=</span><span class="s">=1.9.0</span>
</pre></table></code></div></div><h4 id="slack-app-設定"><span class="me-2">Slack App 設定</span><a href="#slack-app-設定" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>OAuth &amp; Permissions</strong></p><p><a href="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNTk5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>刪除按鈕反灰的項目是加入 Shortcut 後 Slack 自動補上的權限。</ul><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Subscribe to bot events:</ul><p><a href="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDkiIGhlaWdodD0iMzUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li>Interactivity: Enable<li>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code><li>Shortcuts:</ul><p><a href="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iMzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>App Home</strong></p><ul><li>Always Show My Bot as Online: Enable<li>Messages Tab: Enable<li>Allow users to send Slash commands and messages from the messages tab: ✅</ul><p><strong>Basic Information</strong></p><p><a href="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iNTUyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>Rick &amp; Morty 🤘🤘🤘</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" alt="[Reddit](https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NzMiIGhlaWdodD0iNzcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/" target="_blank">Reddit</a></p><h3 id="工商時間"><span class="me-2">工商時間</span><a href="#工商時間" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>如果您與您的團隊有自動化工具、流程串接需求，不論是 Slack App 開發、Notion、Asana、Google Sheet、Google Form、GA 數據，各種串接需求，歡迎與我 <a href="https://zhgchg.li/contact/" target="_blank"><strong>聯絡開發</strong></a> 。</p><p>有任何問題及指教歡迎 <a href="https://www.zhgchg.li/contact" target="_blank">與我聯絡</a> 。</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>本文首次發表於 Medium (<a href="https://medium.com/p/bd94cc88f9c9" target="_blank"><strong>點此查看原始版本</strong></a>)，由 <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a> 提供自動轉換與同步技術。</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/zh-tw/zmediumtomarkdown/2024-02-16-bd94cc88f9c9.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/cloud-functions/" class="post-tag no-text-decoration" >cloud-functions</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/chatgpt/" class="post-tag no-text-decoration" >chatgpt</a> <a href="/tags/slack/" class="post-tag no-text-decoration" >slack</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E8%88%87%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Slack%20App%20%E6%95%B4%E5%90%88%20ChatGPT%EF%BD%9C%E5%88%A9%E7%94%A8%20OpenAI%20API%20%E8%88%87%20Google%20Cloud%20Functions%20%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fslack-app-%25E6%2595%25B4%25E5%2590%2588-chatgpt-%25E5%2588%25A9%25E7%2594%25A8-openai-api-%25E8%2588%2587-google-cloud-functions-%25E8%2587%25AA%25E5%25BB%25BA%25E6%2599%25BA%25E8%2583%25BD%25E5%258A%25A9%25E7%2590%2586-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/japan-overseas-shopping-rakuten-consolidated-shipping-for-taiwan-buy-from-rakuten-amazon-bea62c251f1b/">Japan Overseas Shopping｜Rakuten Consolidated Shipping for Taiwan｜Buy from Rakuten & Amazon</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/%E6%97%A5%E6%9C%AC%E4%B9%90%E5%A4%A9%E9%9B%86%E8%BF%90%E6%95%99%E5%AD%A6-%E5%BF%AB%E9%80%9F%E8%B4%AD%E4%B9%B0horie%E9%92%9B%E6%9D%AF%E4%B8%8Eamazon%E5%95%86%E5%93%81%E5%AF%84%E9%80%81%E5%8F%B0%E6%B9%BE%E5%85%A8%E6%94%BB%E7%95%A5-bea62c251f1b/">日本海外购物寄送台湾教学 — 使用乐天集运购买乐天拍卖与 Amazon 商品 (Horie 钛杯)</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/%E6%97%A5%E6%9C%AC%E6%A8%82%E5%A4%A9%E9%9B%86%E9%81%8B%E6%95%99%E5%AD%B8-%E5%BF%AB%E9%80%9F%E8%B3%BC%E8%B2%B7horie%E9%88%A6%E6%9D%AF%E8%88%87amazon%E5%95%86%E5%93%81%E5%AF%84%E9%80%81%E5%8F%B0%E7%81%A3%E5%85%A8%E6%94%BB%E7%95%A5-bea62c251f1b/">日本海外購物寄送台灣教學 — 使用樂天集運購買樂天拍賣與 Amazon 商品 (Horie 鈦杯)</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/en/line-bank-to-firstrade-transfer-fast-deposit-150-nt-fee-guide-with-account-upgrade-fee-subsidy-e4d139fe0685/">LINE Bank to Firstrade Transfer｜Fast Deposit & 150 NT Fee Guide with Account Upgrade & Fee Subsidy</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/zh-cn/line-bank-%E5%85%A5%E9%87%91-firstrade-%E6%95%99%E5%AD%A6-%E5%BF%AB%E9%80%9F%E5%88%B0%E5%B8%90-%E4%BD%8E%E6%89%8B%E7%BB%AD%E8%B4%B9150%E5%85%83-%E5%B8%90%E6%88%B7%E5%8D%87%E7%BA%A7%E4%B8%8E%E6%89%8B%E7%BB%AD%E8%B4%B9%E8%A1%A5%E5%8A%A9%E7%94%B3%E8%AF%B7%E5%85%A8%E6%94%BB%E7%95%A5-e4d139fe0685/">手把手教学 — LINE Bank 入金 Firstrade 快速到帐、手续费只要 150 元及帐户升级/约定转帐/手续费补助申请教学</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</h4><div class="text-muted"><p>针对团队协作痛点，打造可自订 OpenAI API Key 的 Slack ChatGPT 机器人，运用 Google Cloud Functions 快速部署，实现即时问答与上下文串接，提升工作效率并保障资料安全。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration｜Build Custom OpenAI API Slack App with Google Cloud Functions & Python</h4><div class="text-muted"><p>Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently.</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/python-%E6%90%AD%E9%85%8D-google-cloud-platform-%E8%88%87-line-bot-%E6%89%93%E9%80%A0%E6%AF%8F%E6%97%A5%E8%87%AA%E5%8B%95%E7%B0%BD%E5%88%B0%E8%85%B3%E6%9C%AC%E8%88%87%E6%8E%92%E7%A8%8B-70a1409b149a/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1613822151" data-df="ll" > Feb 20, 2021 </time><h4 class="pt-0 my-2">Python 搭配 Google Cloud Platform 與 Line Bot｜打造每日自動簽到腳本與排程</h4><div class="text-muted"><p>透過 Python 結合 Google Cloud Function、Cloud Scheduler 及 Line Bot，自動完成每日簽到任務並即時通知，解決手動操作繁瑣問題，提升工作效率並節省時間成本。</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="btn btn-outline-primary" aria-label="Older" ><p>Slack App 整合 ChatGPT｜利用 OpenAI API 与 Google Cloud Functions 自建智能助理</p></a> <a href="/posts/zrealm-robotic-process-automation/en/google-apps-script-automate-daily-data-reports-with-rpa-for-google-workspace-f6713ba3fee3/" class="btn btn-outline-primary" aria-label="Newer" ><p>Google Apps Script｜Automate Daily Data Reports with RPA for Google Workspace</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">中文</a>|<a href="/tags/simplified-chinese">简中</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
