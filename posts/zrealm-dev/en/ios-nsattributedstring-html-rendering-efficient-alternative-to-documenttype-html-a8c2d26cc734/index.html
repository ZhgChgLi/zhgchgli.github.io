<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Discover a streamlined method to render HTML in iOS using NSAttributedString without relying on DocumentType.html, solving common rendering issues and boosting app performance." /><meta property="og:description" content="Discover a streamlined method to render HTML in iOS using NSAttributedString without relying on DocumentType.html, solving common rendering issues and boosting app performance." /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-10T00:11:59+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" /><meta property="twitter:title" content="iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-04-14T10:07:40+08:00","datePublished":"2022-06-10T00:11:59+08:00","description":"Discover a streamlined method to render HTML in iOS using NSAttributedString without relying on DocumentType.html, solving common rendering issues and boosting app performance.","headline":"iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/"}</script><title>iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AE%9E%E7%8E%B0-%E8%A7%A3%E5%86%B3%E9%97%AA%E9%80%80%E4%B8%8E%E6%95%88%E8%83%BD%E7%93%B6%E9%A2%88-a8c2d26cc734/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-%E8%A7%A3%E6%B1%BA%E9%96%83%E9%80%80%E8%88%87%E6%95%88%E8%83%BD%E7%93%B6%E9%A0%B8-a8c2d26cc734/"><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan üáπüáº who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,049+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html</h1><p class="post-desc fw-light mb-4">Discover a streamlined method to render HTML in iOS using NSAttributedString without relying on DocumentType.html, solving common rendering issues and boosting app performance.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1654791119" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 10, 2022 </time> </span> <span> Updated <time data-ts="1713060460" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 14, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" class="popup img-link preview-img blur"><img data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="4778 words" > <em>26 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters üîñ</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AE%9E%E7%8E%B0-%E8%A7%A3%E5%86%B3%E9%97%AA%E9%80%80%E4%B8%8E%E6%95%88%E8%83%BD%E7%93%B6%E9%A2%88-a8c2d26cc734/"><strong>ÁÇπÂáªËøôÈáå</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†ÁÆÄ‰Ωì‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-%E8%A7%A3%E6%B1%BA%E9%96%83%E9%80%80%E8%88%87%E6%95%88%E8%83%BD%E7%93%B6%E9%A0%B8-a8c2d26cc734/"><strong>ÈªûÊìäÈÄôË£°</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†Ê≠£È´î‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-info"><p>This post was translated with AI assistance ‚Äî let me know if anything sounds off!</p></blockquote><h4 id="zhgchgli-table-of-contents">Table of Contents</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li><a href="#implementing-ios-nsattributedstring-html-render-by-yourself">Implementing iOS NSAttributedString HTML Render by Yourself</a></li><li><a href="#tldr-20230312">[TL;DR] 2023/03/12</a></li><li class="has-children"><details><summary>Origin <a href="#origin">#</a></summary><ul><li><a href="#crash-reasons">Crash Reasons</a></li><li><a href="#reproduction-steps">Reproduction Steps</a></li></ul></details></li><li class="has-children"><details><summary>Answer <a href="#answer">#</a></summary><ul><li><a href="#supplement-rendering-complex-html--creating-text-with-rich-visual-effects">Supplement. Rendering Complex HTML ‚Äî Creating Text with Rich Visual Effects</a></li></ul></details></li><li class="has-children"><details><summary>Why? <a href="#why">#</a></summary><ul><li><a href="#very-poor-performance">Very Poor Performance</a></li><li><a href="#better">Better</a></li></ul></details></li><li><a href="#20230227-updated-tldr">[2023/02/27 Updated] [TL;DR]</a></li><li class="has-children"><details><summary>How? <a href="#how">#</a></summary><ul><li><a href="#inspired-by">Inspired by</a></li></ul></details></li><li class="has-children"><details><summary>Strip HTML Remove HTML <a href="#strip-html-remove-html">#</a></summary><ul><li><a href="#option-1-nsattributedstring">Option 1. NSAttributedString</a></li><li><a href="#option-2-regex">Option 2. Regex</a></li><li><a href="#option-3-xmlparser">Option 3. XMLParser</a></li></ul></details></li><li><a href="#html-render-wxmlparser">HTML Render w/XMLParser</a></li><li class="has-children"><details><summary>‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Attention ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è <a href="#Ô∏èÔ∏èÔ∏è-attention-Ô∏èÔ∏èÔ∏è">#</a></summary><ul><li><a href="#htmltagparser">HTMLTagParser</a></li><li><a href="#attributedstringstyle">AttributedStringStyle</a></li><li><a href="#htmlstyleattributedparser">HTMLStyleAttributedParser</a></li><li><a href="#some-implementation-examples-of-tag-parser--attributedstringstyle">Some Implementation Examples of Tag Parser & AttributedStringStyle</a></li><li><a href="#htmltoattributedstringparser-core-implementation-of-xmlparserdelegate">HTMLToAttributedStringParser: Core Implementation of XMLParserDelegate</a></li><li><a href="#test-result">Test Result</a></li></ul></details></li><li><a href="#done">Done!</a></li><li><a href="#complete-github-repo-as-follows">Complete Github Repo as follows</a></li></ul></nav><hr /><h3 id="implementing-ios-nsattributedstring-html-render-by-yourself"><span class="me-2">Implementing iOS NSAttributedString HTML Render by Yourself</span><a href="#implementing-ios-nsattributedstring-html-render-by-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>iOS NSAttributedString DocumentType.html Alternative</p><p><a href="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.webp" alt="Photo by [Florian Olivo](https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjgwMCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@florianolv?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Florian Olivo</a></p><h3 id="tldr-20230312"><span class="me-2">[TL;DR] 2023/03/12</span><a href="#tldr-20230312" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Re-developed using a different approach: <em>‚Äù<a href="/posts/zrealm-dev/en/zmarkupparser-convert-html-string-to-nsattributedstring-with-custom-style-keys-a5643de271e4/"><strong>ZMarkupParser HTML String to NSAttributedString Tool</strong></a>‚Äú</em>. For technical details and the development story, please visit ‚Äú<a href="/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/">The Story of Manually Building an HTML Parser</a>‚Äù.</p><h3 id="origin"><span class="me-2">Origin</span><a href="#origin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since the release of iOS 15 last year, an app has consistently been plagued by a crash issue. According to data from the past 90 days (2022/03/11~2022/06/08), it caused over 2.4K crashes, affecting more than 1.4K users.</p><p><a href="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjM1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>According to the data, the official team appears to have fixed (or reduced the frequency of) this common crash issue in iOS versions ‚â• 15.2, as the data shows a downward trend.</p></blockquote><p><strong>Most affected versions:</strong> iOS 15.0.X ~ iOS 15.X.X</p><p>It was also found that iOS 12 and iOS 13 had occasional crash reports, so this issue has likely existed for a long time. However, the crash rate was nearly 100% in the early versions of iOS 15.</p><h4 id="crash-reasons"><span class="me-2">Crash Reasons:</span><a href="#crash-reasons" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MDkiIGhlaWdodD0iMjIyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;compiler-generated&gt; line 2147483647 specialized @nonobjc NSAttributedString.init(data:options:documentAttributes:)
</pre></table></code></div></div><p>NSAttributedString crashes during init with <code class="language-plaintext highlighter-rouge">Crashed: com.apple.main-thread EXC_BREAKPOINT 0x00000001de9d4e44</code>.</p><blockquote><p>It is also possible that the operation is not on the Main Thread.</p></blockquote><h4 id="reproduction-steps"><span class="me-2">Reproduction Steps:</span><a href="#reproduction-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>When this issue suddenly appeared in large numbers, the development team was baffled; re-testing the points in the Crash Log showed no problems, and it was unclear under what conditions users encountered it. Until one time, by coincidence, I switched to ‚ÄúLow Power Mode‚Äù and the problem was triggered!! <strong>WTF!!!</strong></p><p><a href="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTIiIGhlaWdodD0iNjg2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="answer"><span class="me-2">Answer</span><a href="#answer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After some searching, I found many similar cases online and located the earliest identical <a href="https://developer.apple.com/forums/thread/115405" target="_blank">crash issue question</a> on the App Developer Forums, along with an official response:</p><p><a href="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTIzIiBoZWlnaHQ9IjU1NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p>This is a known iOS Foundation bug: it has existed since iOS 12.</p><li><p>To render complex HTML without usage restrictions: please use WKWebView</p><li><p><strong>Rendering Constraints: You may write your own HTML Parser &amp; Renderer</strong></p><li><p>Directly use Markdown as rendering constraints: iOS ‚â• 15 NSAttributedString can <a href="https://developer.apple.com/documentation/foundation/nsattributedstring/3796598-init" target="_blank">directly render text using Markdown format</a></p></ul><blockquote><p><strong>Rendering constraints</strong> mean limiting the rendering formats supported by the app, such as only supporting <strong>bold</strong>, italics, or <a href="https://zhgchg.li" target="_blank">hyperlinks</a>.</p></blockquote><h4 id="supplement-rendering-complex-html--creating-text-with-rich-visual-effects"><span class="me-2">Supplement. Rendering Complex HTML ‚Äî Creating Text with Rich Visual Effects</span><a href="#supplement-rendering-complex-html--creating-text-with-rich-visual-effects" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Can coordinate an interface together with the backend:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"content"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 1 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 2 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 3 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 4 plain text"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"image"</span><span class="p">,</span><span class="nl">"src"</span><span class="p">:</span><span class="s2">"https://zhgchg.li/logo.png"</span><span class="p">,</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"ZhgChgLi"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"text"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"Paragraph 5 plain text"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Can be combined with Markdown to support text rendering, or refer to Medium‚Äôs approach:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nl">"Paragraph"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code in text, and link in text, and ZhgChgLi, and bold, and I, only i"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"markups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CODE"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w">
        </span><span class="nl">"href"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://zhgchg.li"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LINK"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"STRONG"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">63</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EM"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w">
        </span><span class="nl">"end"</span><span class="p">:</span><span class="w"> </span><span class="mi">69</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>The meaning of <code class="language-plaintext highlighter-rouge">code in text, and link in text, and ZhgChgLi, and bold, and I, only i</code> is:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>- Characters 5 to 7 should be marked as code (wrapped with `Text`)
- Characters 18 to 22 should be marked as a link (using [Text](URL) format)
- Characters 50 to 63 should be marked as bold (*Text*)
- Characters 55 to 69 should be marked as italic (_Text_)
</pre></table></code></div></div><p>With a standardized and describable structure, the app can render natively on its own, achieving optimal performance and user experience.</p><blockquote><p>Pitfalls of UITextView for Text Wrapping with Images, refer to my previous article: <a href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/">iOS UITextView Text Wrapping Editor (Swift)</a></p></blockquote><h3 id="why"><span class="me-2">Why?</span><a href="#why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before providing a practical solution, let‚Äôs first return to the root of the problem. I personally believe the main cause of this issue does not come from Apple; the official bug is merely the trigger for the problem.</p><p>The main issue comes from <strong>treating the App side as a Web for rendering</strong>. The advantage is fast web development, using the same API endpoint to deliver HTML regardless of client, and flexible rendering of any desired content. The drawbacks are that HTML is not a common interface for apps, app engineers are not expected to understand HTML, <strong>performance is very poor</strong>, rendering can only occur on the main thread, results are unpredictable during development, and supported specifications cannot be confirmed.</p><p>Looking further up, the problem mostly lies in unclear original requirements, uncertainty about which specifications the app needs to support, and rushing that leads to using HTML directly as the interface between the app and the web.</p><h4 id="very-poor-performance"><span class="me-2"><strong>Very Poor Performance</strong></span><a href="#very-poor-performance" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Regarding performance, actual tests show a 5 to 20 times speed difference between using <code class="language-plaintext highlighter-rouge">NSAttributedString DocumentType.html</code> directly and implementing rendering manually.</p><h4 id="better"><span class="me-2">Better</span><a href="#better" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since it is an app to be used, a better approach is to start with app development. For apps, the cost of adjusting requirements is much higher than for the web. Effective app development should be based on iterative adjustments with defined specifications. At the moment, it is necessary to confirm the supported specifications. If changes are needed later, we can schedule time to expand the specifications. Quick, on-the-fly changes are not feasible. This approach reduces communication costs and increases work efficiency.</p><ul><li><p>Confirming the scope of requirements</p><li><p>Confirm supported specifications</p><li><p>Confirm interface specifications (Markdown/BBCode/‚Ä¶ continuing with HTML is also fine, but if there are restrictions, such as only using <code class="language-plaintext highlighter-rouge">&lt;b&gt;/&lt;i&gt;/&lt;a&gt;/&lt;u&gt;</code>, it must be <strong>clearly communicated</strong> to developers in the code)</p><li><p>Implementing a rendering engine yourself</p><li><p>Maintenance and iteration support specifications</p></ul><h3 id="20230227-updated-tldr"><span class="me-2">[2023/02/27 Updated] [TL;DR]:</span><a href="#20230227-updated-tldr" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Updated approach, no longer using XMLParser due to zero fault tolerance:</p><p><code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code><br /> These three cases can cause XMLParser to fail and throw an error, resulting in a blank display.<br /> When using XMLParser, the HTML string must fully comply with XML rules and cannot tolerate errors like browsers or NSAttributedString.DocumentType.html, which can display content normally despite errors.</p><p><a href="https://medium.com/zrealm-ios-dev/zmarkupparser-html-string-%E8%BD%89%E6%8F%9B-nsattributedstring-%E5%B7%A5%E5%85%B7-a5643de271e4" target="_blank" class="img-link shimmer" ><img src="https://miro.medium.com/v2/resize:fit:1200/1*A0yXupXW9-F9ZWe4gp2ObA.jpeg" alt="" loading="lazy"></a></p><p>Rewrite using pure Swift, parsing HTML tags with Regex and tokenizing them. Analyze and correct tag accuracy (fix missing end tags &amp; misplaced tags), then convert into an abstract syntax tree. Finally, use the Visitor Pattern to map HTML tags to abstract styles, producing the final NSAttributedString result; no parser libraries are used.</p><p>‚Äî ‚Äî</p><h3 id="how"><span class="me-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The die is cast. Back to the main topic, now that we are rendering <code class="language-plaintext highlighter-rouge">NSAttributedString</code> using HTML, how can we resolve the aforementioned crashes and performance issues?</p><h4 id="inspired-by"><span class="me-2">Inspired by</span><a href="#inspired-by" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/malcommac/SwiftRichString" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/7e71c0eb7d2a88f00a77cb8e0181081b88683ab2d359221336aa9776a4cd097d/malcommac/SwiftRichString" alt="" loading="lazy"></a></p><h3 id="strip-html-remove-html"><span class="me-2">Strip HTML Remove HTML</span><a href="#strip-html-remove-html" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before discussing HTML Render, let‚Äôs first talk about Strip HTML. As mentioned earlier in the <code class="language-plaintext highlighter-rouge">Why?</code> section, where the app obtains HTML and what kind of HTML it receives should be clearly defined in the specifications; it should not be that the app <strong>might</strong> receive HTML and therefore needs to strip it.</p><blockquote><p>To quote a former supervisor: This is just too crazy, right?</p></blockquote><h4 id="option-1-nsattributedstring"><span class="me-2">Option 1. NSAttributedString</span><a href="#option-1-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Text&lt;/div&gt;"</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">unicode</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributed</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nv">documentType</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span> <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span><span class="p">],</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="n">attributed</span><span class="o">.</span><span class="n">string</span>
</pre></table></code></div></div><ul><li><p>Using NSAttributedString to render HTML and then extracting the string will result in a clean String.</p><li><p>The issues are the same as in this chapter: iOS 15 often crashes, has poor performance, and operations can only be done on the Main Thread.</p></ul><h4 id="option-2-regex"><span class="me-2">Option 2. Regex</span><a href="#option-2-regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">htmlString</span> <span class="o">=</span> <span class="s">"&lt;div&gt;Test&lt;/div&gt;"</span>
<span class="n">htmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;[^&gt;]+&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">regularExpression</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><ul><li><p>The simplest and most effective way</p><li><p>Regex cannot guarantee complete accuracy. For example, <code class="language-plaintext highlighter-rouge">&lt;p foo="&gt;now what?"&gt;Paragraph&lt;/p&gt;</code> is valid HTML but will be stripped incorrectly.</p></ul><h4 id="option-3-xmlparser"><span class="me-2">Option 3. XMLParser</span><a href="#option-3-xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Referencing the approach of <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a>, use <strong><a href="https://developer.apple.com/documentation/foundation/xmlparser" target="_blank">XMLParser</a></strong> from Foundation to parse HTML as XML and implement your own HTML Parser &amp; Strip functionality.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLStripper</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">storedString</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">storedString</span> <span class="o">=</span> <span class="s">""</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">()</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLStripper</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">storedString</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: XMLParserDelegate</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: Support Private Methods</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="n">storedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">currentString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which are not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example, if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}</span><span class="err">\</span><span class="s">|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"Êàë&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;ÂêåÊÑè&lt;/a&gt;Êèê‰æõ&lt;b&gt;&lt;i&gt;ÂÄã&lt;/i&gt;‰∫∫&lt;/b&gt;Ë∫´ÂàÜË≠âÂ≠óËôüÔºèË≠∑ÁÖßÔºèÂ±ÖÁïô&lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;Ë≠âËôüÁ¢º&lt;/span&gt;Ôºå‰ª•‰æõ&lt;i&gt;Ë∑®Â¢ÉÁâ©ÊµÅ&lt;/i&gt;ÊñπÈÄöÈóú&lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;‰ΩøÁî®&lt;/span&gt;Ôºå‰∏¶Â∑≤&lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;‰∫ÜËß£Ë∑®Â¢É&lt;br/&gt;ÂïÜÂìÅ‰πãÁâ©&lt;p&gt;ÊµÅÈúÄ&lt;/p&gt;Ê±Ç"</span>

<span class="k">let</span> <span class="nv">stripper</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">HTMLStripper</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">stripper</span><span class="o">.</span><span class="nf">parse</span><span class="p">())</span>

<span class="c1">// I agree to provide personal ID number / passport / residence permit number for cross-border logistics clearance use, and have understood the logistics requirements of cross-border goods.</span>
</pre></table></code></div></div><p>Using Foundation XML Parser to process a String, implement <code class="language-plaintext highlighter-rouge">XMLParserDelegate</code> with <code class="language-plaintext highlighter-rouge">currentString</code> to store the String. Since the String can be split into multiple parts, <code class="language-plaintext highlighter-rouge">foundCharacters</code> may be called repeatedly. Use <code class="language-plaintext highlighter-rouge">didStartElement</code> and <code class="language-plaintext highlighter-rouge">didEndElement</code> to detect the start and end of the string, save the current result, and then clear <code class="language-plaintext highlighter-rouge">currentString</code>.</p><ul><li><p>The advantage is that it also converts HTML Entities to actual characters, e.g. <code class="language-plaintext highlighter-rouge">&amp;#103; -&gt; g</code></p><li><p>The advantage is handling complexity, but XMLParser will fail if the HTML is non-compliant, e.g., <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> instead of <code class="language-plaintext highlighter-rouge">&lt;br/&gt;</code>.</p></ul><blockquote><p>I personally believe that simply stripping HTML <strong>Option 2. is the better method</strong>. I introduce this method because rendering HTML uses the same principle, so this serves as a simple example :)</p></blockquote><h3 id="html-render-wxmlparser"><span class="me-2">HTML Render w/XMLParser</span><a href="#html-render-wxmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Using XMLParser to implement it ourselves, similar to the Strip principle, we can add specific rendering methods depending on which Tag is being parsed.</p><p>Requirement Specifications:</p><ul><li><p>Support for additional tags to analyze</p><li><p>Support setting Tag Default Style, e.g., applying link style to the &lt;a&gt; tag</p><li><p>Support parsing the <code class="language-plaintext highlighter-rouge">style</code> attribute, as HTML explicitly specifies display style in <code class="language-plaintext highlighter-rouge">style="color:red"</code></p><li><p>Style supports changing text weight, size, underline, line spacing, letter spacing, background color, and text color</p><li><p>Does not support complex tags such as Image Tag, Table Tag, etc.</p></ul><blockquote><p>Everyone can reduce features according to their own specifications. For example, if background color adjustment is not needed, then the option to set the background color does not need to be included.</p></blockquote><blockquote><p>This article is just a conceptual implementation, <strong>not a Best Practice in architecture</strong>; if there are clear specifications and usage methods, consider applying some Design Patterns to achieve better maintainability and scalability.</p></blockquote><h3 id="Ô∏èÔ∏èÔ∏è-attention-Ô∏èÔ∏èÔ∏è"><span class="me-2">‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Attention ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è</span><a href="#Ô∏èÔ∏èÔ∏è-attention-Ô∏èÔ∏èÔ∏è" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A reminder, <strong>if your app is brand new or can be fully converted to Markdown format, it is recommended to use the above method. Writing your own render in this article is too complex and won‚Äôt perform better than Markdown</strong>.</p><blockquote><p>Even if your iOS version is below 15 and does not support native Markdown, you can still find <a href="https://github.com/chockenberry/MarkdownAttributedString" target="_blank">an excellent Markdown Parser solution</a> on GitHub.</p></blockquote><h4 id="htmltagparser"><span class="me-2">HTMLTagParser</span><a href="#htmltagparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// Declare the Tag Name to parse, e.g. a</span>
    <span class="k">var</span> <span class="nv">storedHTMLAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// Parsed attributes will be stored here, e.g. href, style</span>
    <span class="k">var</span> <span class="nv">style</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span> <span class="c1">// Style to apply for this Tag</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="c1">// Implement the logic to render HTML to attributedString</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Declare parsable HTML tag entities for easy extension and management.</p><h4 id="attributedstringstyle"><span class="me-2">AttributedStringStyle</span><a href="#attributedstringstyle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">UIFont</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">color</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">wordSpacing</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">customs</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span> <span class="c1">// Universal setting port, it is recommended to abstract this after confirming supported specifications and close this port</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// abstract implement</span>
<span class="kd">extension</span> <span class="kt">AttributedStringStyle</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">font</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="n">color</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">backgroundColor</span> <span class="o">=</span> <span class="n">backgroundColor</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">wordSpacing</span> <span class="o">=</span> <span class="n">wordSpacing</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">wordSpacing</span> <span class="k">as</span> <span class="kt">Any</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="n">paragraphStyle</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">customAttributes</span> <span class="o">=</span> <span class="n">customs</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">customAttributes</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Declare styles available for setting tags.</p><h4 id="htmlstyleattributedparser"><span class="me-2">HTMLStyleAttributedParser</span><a href="#htmlstyleattributedparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="c1">// only support tag attributed down below</span>
<span class="c1">// can set color, font size, line height, word spacing, background color</span>

<span class="kd">enum</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">color</span> <span class="o">=</span> <span class="s">"color"</span>
    <span class="k">case</span> <span class="n">fontSize</span> <span class="o">=</span> <span class="s">"font-size"</span>
    <span class="k">case</span> <span class="n">lineHeight</span> <span class="o">=</span> <span class="s">"line-height"</span>
    <span class="k">case</span> <span class="n">wordSpacing</span> <span class="o">=</span> <span class="s">"word-spacing"</span>
    <span class="k">case</span> <span class="n">backgroundColor</span> <span class="o">=</span> <span class="s">"background-color"</span>
    
    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">color</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">foregroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">backgroundColor</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">backgroundColor</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">fontSize</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">font</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">UIFont</span><span class="o">.</span><span class="nf">systemFont</span><span class="p">(</span><span class="nv">ofSize</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)),</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">lineHeight</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">paragraphStyle</span> <span class="o">=</span> <span class="kt">NSMutableParagraphStyle</span><span class="p">()</span>
                <span class="n">paragraphStyle</span><span class="o">.</span><span class="n">lineSpacing</span> <span class="o">=</span> <span class="n">size</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">paragraphStyle</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">wordSpacing</span><span class="p">:</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="nf">addAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">kern</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    
    <span class="c1">// convert 36px -&gt; 36</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSSize</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">regex</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"^([0-9]+)"</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">firstMatch</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="nf">firstMatch</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">)),</span>
              <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">Range</span><span class="p">(</span><span class="n">firstMatch</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span>
              <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="kt">Float</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">range</span><span class="p">]))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// convert html hex color #ffffff to UIKit Color</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">convertToiOSColor</span><span class="p">(</span><span class="n">_</span> <span class="nv">hexString</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UIColor</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">cString</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">hexString</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">uppercased</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cString</span><span class="o">.</span><span class="nf">hasPrefix</span><span class="p">(</span><span class="s">"#"</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cString</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">cString</span><span class="o">.</span><span class="n">startIndex</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cString</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="k">var</span> <span class="nv">rgbValue</span><span class="p">:</span> <span class="kt">UInt64</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="kt">Scanner</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">cString</span><span class="p">)</span><span class="o">.</span><span class="nf">scanHexInt64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rgbValue</span><span class="p">)</span>

        <span class="k">return</span> <span class="kt">UIColor</span><span class="p">(</span>
            <span class="nv">red</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0xFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">green</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">((</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x00FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">blue</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">rgbValue</span> <span class="o">&amp;</span> <span class="mh">0x0000FF</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
            <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Implement a Style Attributed Parser to parse <code class="language-plaintext highlighter-rouge">style="color:red;font-size:16px"</code>. Since CSS styles have many possible settings, you need to list the supported range.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">HTMLTagParser</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">defaultStyleRender</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">NSMutableAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// setup default style to NSMutableAttributedString</span>
        <span class="n">style</span><span class="p">?</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">)</span>
        
        <span class="c1">// setup &amp; override HTML style (style="color:red;background-color:black") to NSMutableAttributedString if it exists</span>
        <span class="c1">// any html tag can have style attribute</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">style</span> <span class="o">=</span> <span class="n">storedHTMLAttributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">]</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttributed</span> <span class="o">=</span> <span class="kt">HTMLStyleAttributedParser</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">key</span><span class="p">),</span> <span class="n">styleAttributed</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Unsupported style attribute or value[</span><span class="se">\(</span><span class="n">key</span><span class="se">)</span><span class="s">:</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">]"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Applying HTMLStyleAttributedParser &amp; Abstract Implementation of HTMLStyleAttributedParser.</p><h4 id="some-implementation-examples-of-tag-parser--attributedstringstyle"><span class="me-2">Some Implementation Examples of Tag Parser &amp; AttributedStringStyle</span><a href="#some-implementation-examples-of-tag-parser--attributedstringstyle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>struct LinkStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14)
   var color: UIColor? = UIColor.blue
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct ATagParser: HTMLTagParser {
    // &lt;a&gt;&lt;/a&gt;
    static let tag: String = "a"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = LinkStyle()
    
    func render(attributedString: inout NSMutableAttributedString) {
        defaultStyleRender(attributedString: &amp;attributedString)
        if let href = storedHTMLAttributes?["href"], let url = URL(string: href) {
            let range = NSMakeRange(0, attributedString.length)
            attributedString.addAttribute(NSAttributedString.Key.link, value: url, range: range)
        }
    }
}
struct BoldStyle: AttributedStringStyle {
   var font: UIFont? = UIFont.systemFont(ofSize: 14, weight: .bold)
   var color: UIColor? = UIColor.black
   var backgroundColor: UIColor? = nil
   var wordSpacing: CGFloat? = nil
   var paragraphStyle: NSParagraphStyle?
   var customs: [NSAttributedString.Key: Any]? = [.underlineStyle: NSUnderlineStyle.single.rawValue]
}

struct BoldTagParser: HTMLTagParser {
    // &lt;b&gt;&lt;/b&gt;
    static let tag: String = "b"
    var storedHTMLAttributes: [String: String]? = nil
    let style: AttributedStringStyle? = BoldStyle()
}
</pre></table></code></div></div><h4 id="htmltoattributedstringparser-core-implementation-of-xmlparserdelegate"><span class="me-2">HTMLToAttributedStringParser: Core Implementation of XMLParserDelegate</span><a href="#htmltoattributedstringparser-core-implementation-of-xmlparserdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
</pre><td class="rouge-code"><pre><span class="c1">// Ref: https://github.com/malcommac/SwiftRichString</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">topTag</span> <span class="o">=</span> <span class="s">"source"</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">xmlParser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSMutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">supportedTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span>
    
    <span class="c1">/// Styles applied at each fragment.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">renderingTagRenders</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagParser</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">// The XML parser sometimes splits strings, which can break localization-sensitive</span>
    <span class="c1">// string transforms. Work around this by using the currentString variable to</span>
    <span class="c1">// accumulate partial strings, and then reading them back out as a single string</span>
    <span class="c1">// when the current element ends, or when a new one is started.</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">currentString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    
    <span class="c1">// MARK: - Initialization</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">AttributedStringStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">register</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagRender</span><span class="p">:</span> <span class="kt">HTMLTagParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">tagRender</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="p">})</span> <span class="p">{</span>
            <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">/// Parse and generate attributed string.</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">xmlString</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        
        <span class="c1">// make sure &lt;br/&gt; format is correct XML</span>
        <span class="c1">// because Web may use &lt;br&gt; to present &lt;br/&gt;, but &lt;br&gt; is not a valid XML</span>
        <span class="n">xmlString</span> <span class="o">=</span> <span class="n">xmlString</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"&lt;br&gt;"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"&lt;br/&gt;"</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">xml</span> <span class="o">=</span> <span class="s">"&lt;</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;</span><span class="se">\(</span><span class="n">xmlString</span><span class="se">)</span><span class="s">&lt;/</span><span class="se">\(</span><span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="se">)</span><span class="s">&gt;"</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="kt">XMLParserInitError</span><span class="p">(</span><span class="s">"Unable to convert to UTF8"</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">xmlParser</span> <span class="o">=</span> <span class="kt">XMLParser</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldProcessNamespaces</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldReportNamespacePrefixes</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">shouldResolveExternalEntities</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="n">xmlParser</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">xmlParser</span> <span class="o">=</span> <span class="n">xmlParser</span>
        
        <span class="n">attributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
        
        <span class="k">guard</span> <span class="n">xmlParser</span><span class="o">.</span><span class="nf">parse</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">line</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">lineNumber</span>
            <span class="k">let</span> <span class="nv">shiftColumn</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">shiftSize</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span><span class="o">.</span><span class="nf">lengthOfBytes</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">let</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">columnNumber</span> <span class="o">-</span> <span class="p">(</span><span class="n">shiftColumn</span> <span class="p">?</span> <span class="nv">shiftSize</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">throw</span> <span class="kt">XMLParserError</span><span class="p">(</span><span class="nv">parserError</span><span class="p">:</span> <span class="n">xmlParser</span><span class="o">.</span><span class="n">parserError</span><span class="p">,</span> <span class="nv">line</span><span class="p">:</span> <span class="n">line</span><span class="p">,</span> <span class="nv">column</span><span class="p">:</span> <span class="n">column</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Private Method</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">enter</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">// elementName = tagName, EX: a,span,div...</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">elementName</span> <span class="p">})</span> <span class="p">{</span>
            <span class="k">var</span> <span class="nv">tagRender</span> <span class="o">=</span> <span class="n">supportedTagRenders</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">tagRender</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="n">attributes</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">tagRender</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">exit</span><span class="p">(</span><span class="n">element</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
            <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">foundNewString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">currentString</span> <span class="o">=</span> <span class="n">currentString</span> <span class="p">{</span>
            <span class="c1">// currentString != nil ,ex: &lt;i&gt;currentString&lt;/i&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">currentString</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">renderingTagRenders</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// Render Style</span>
                    <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                    <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">currentString</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// currentString == nil ,ex: &lt;br/&gt;</span>
            <span class="k">var</span> <span class="nv">newAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">()</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tagRender</span><span class="p">)</span> <span class="k">in</span> <span class="n">renderingTagRenders</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
                <span class="c1">// Render Style</span>
                <span class="n">tagRender</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">newAttributedString</span><span class="p">)</span>
                <span class="n">renderingTagRenders</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">storedHTMLAttributes</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="p">}</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newAttributedString</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: Helper</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span> <span class="p">{</span>
    <span class="c1">// handle html entity / html hex</span>
    <span class="c1">// Perform string escaping to replace all characters which are not supported by NSXMLParser</span>
    <span class="c1">// into the specified encoding with decimal entity.</span>
    <span class="c1">// For example if your string contains '&amp;' character parser will break the style.</span>
    <span class="c1">// This option is active by default.</span>
    <span class="c1">// ref: https://github.com/malcommac/SwiftRichString/blob/e0b72d5c96968d7802856d2be096202c9798e8d1/Sources/SwiftRichString/Support/XMLStringBuilder.swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">escapeWithUnicodeEntities</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">escapeAmpRegExp</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="s">"&amp;(?!(#[0-9]{2,4}</span><span class="err">\</span><span class="s">|[A-z]{2,6});)"</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">Options</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">NSRange</span><span class="p">(</span><span class="nv">location</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">length</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escapeAmpRegExp</span><span class="o">.</span><span class="nf">stringByReplacingMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span>
                                                        <span class="nv">options</span><span class="p">:</span> <span class="kt">NSRegularExpression</span><span class="o">.</span><span class="kt">MatchingOptions</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
                                                        <span class="nv">range</span><span class="p">:</span> <span class="n">range</span><span class="p">,</span>
                                                        <span class="nv">withTemplate</span><span class="p">:</span> <span class="s">"&amp;amp;"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// MARK: XMLParserDelegate</span>

<span class="kd">extension</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">:</span> <span class="kt">XMLParserDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didStartElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">attributes</span> <span class="nv">attributeDict</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">])</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="nf">enter</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">attributeDict</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">didEndElement</span> <span class="nv">elementName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">namespaceURI</span><span class="p">:</span> <span class="kt">String</span><span class="p">?,</span> <span class="n">qualifiedName</span> <span class="nv">qName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="nf">foundNewString</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">elementName</span> <span class="o">!=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="o">.</span><span class="n">topTag</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="nf">exit</span><span class="p">(</span><span class="nv">element</span><span class="p">:</span> <span class="n">elementName</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parser</span><span class="p">(</span><span class="n">_</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">XMLParser</span><span class="p">,</span> <span class="n">foundCharacters</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">currentString</span> <span class="o">=</span> <span class="p">(</span><span class="n">currentString</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Applying the logic of Strip, we can combine the parsed structure by using <code class="language-plaintext highlighter-rouge">elementName</code> to identify the current Tag, then apply the corresponding Tag Parser and the predefined Style.</p><h4 id="test-result"><span class="me-2">Test Result</span><a href="#test-result" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">test</span> <span class="o">=</span> <span class="s">"I&lt;br/&gt;&lt;a href=</span><span class="se">\"</span><span class="s">http://google.com</span><span class="se">\"</span><span class="s">&gt;agree&lt;/a&gt; to provide &lt;b&gt;&lt;i&gt;personal&lt;/i&gt;&lt;/b&gt; ID card number/passport/residence &lt;span style=</span><span class="se">\"</span><span class="s">color:#FF0000;font-size:20px;word-spacing:10px;line-height:10px</span><span class="se">\"</span><span class="s">&gt;certificate number&lt;/span&gt; for &lt;i&gt;cross-border logistics&lt;/i&gt; clearance &lt;span style=</span><span class="se">\"</span><span class="s">background-color:#00FF00;</span><span class="se">\"</span><span class="s">&gt;use&lt;/span&gt;, and have &lt;img src=</span><span class="se">\"</span><span class="s">g.png</span><span class="se">\"</span><span class="s">/&gt;understood the cross-border&lt;br/&gt;product &lt;p&gt;logistics requirements&lt;/p&gt;"</span>
<span class="k">let</span> <span class="nv">render</span> <span class="o">=</span> <span class="kt">HTMLToAttributedStringParser</span><span class="p">(</span><span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">DefaultTextStyle</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">ATagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">BoldTagParser</span><span class="p">())</span>
<span class="n">render</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">SpanTagParser</span><span class="p">())</span>
<span class="c1">//...</span>
<span class="nf">print</span><span class="p">(</span><span class="k">try!</span> <span class="n">render</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">test</span><span class="p">))</span>

<span class="c1">// Result:</span>
<span class="c1">// I{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }agree{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 0 0 1 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSLink = "http://google.com";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }to provide{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }personal{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Bold 14.00 pt. P [] (0x13a013870) fobj=0x13a013870, spc=3.46\"";</span>
<span class="c1">//     NSUnderline = 1;</span>
<span class="c1">// }ID card number/passport/residence{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }certificate number{</span>
<span class="c1">//     NSColor = "UIExtendedSRGBColorSpace 1 0 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 20.00 pt. P [] (0x13a015fa0) fobj=0x13a015fa0, spc=4.82\"";</span>
<span class="c1">//     NSKern = 10;</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 10, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }, for cross-border logistics clearance{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }use{</span>
<span class="c1">//     NSBackgroundColor = "UIExtendedSRGBColorSpace 0 1 0 1";</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }, and have understood the cross-border product logistics requirements{</span>
<span class="c1">//     NSColor = "UIExtendedGrayColorSpace 0 1";</span>
<span class="c1">//     NSFont = "\".SFNS-Regular 14.00 pt. P [] (0x13a012970) fobj=0x13a012970, spc=3.79\"";</span>
<span class="c1">//     NSParagraphStyle = "Alignment 4, LineSpacing 3, ParagraphSpacing 0, ParagraphSpacingBefore 0, HeadIndent 0, TailIndent 0, FirstLineHeadIndent 0, LineHeight 0/0, LineHeightMultiple 0, LineBreakMode 0, Tabs (\n    28L,\n    56L,\n    84L,\n    112L,\n    140L,\n    168L,\n    196L,\n    224L,\n    252L,\n    280L,\n    308L,\n    336L\n), DefaultTabInterval 0, Blocks (\n), Lists (\n), BaseWritingDirection -1, HyphenationFactor 0, TighteningForTruncation NO, HeaderLevel 0 LineBreakStrategy 0 PresentationIntents (\n) ListIntentOrdinal 0 CodeBlockIntentLanguageHint ''";</span>
<span class="c1">// }</span>
</pre></table></code></div></div><p><strong>Display Result:</strong></p><p><a href="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.webp" class="popup img-link blur"><img data-src="/assets/a8c2d26cc734/1*LaKhRLhHm2jfptG4h_jB5Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NzEiIGhlaWdodD0iNDkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h3 id="done"><span class="me-2">Done!</span><a href="#done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This completes our implementation of HTML rendering using XMLParser, maintaining extensibility and specifications. We can manage and understand the supported string rendering types in the app through the code.</p><h3 id="complete-github-repo-as-follows"><span class="me-2">Complete Github Repo as follows</span><a href="#complete-github-repo-as-follows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/zhgchgli0718/HTMLToAttributedStringRednerExample" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/c021159c3da82c37ff65d210c7a64aa4e56e398964b824baf4f248bb25bdb805/zhgchgli0718/HTMLToAttributedStringRednerExample" alt="" loading="lazy"></a></p><blockquote><p><em>This article is simultaneously published on my personal blog: <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/"><strong>[Click here]</strong></a>.</em></p></blockquote><blockquote><p><em>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</em></p></blockquote><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=üç∫&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>This post was originally published on Medium (<a href="https://medium.com/p/a8c2d26cc734" target="_blank"><strong>View original post</strong></a>), and automatically converted and synced by <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a>.</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2022-06-09-a8c2d26cc734.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,049+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/english/" class="post-tag no-text-decoration" >english</a> <a href="/tags/ai-translation/" class="post-tag no-text-decoration" >ai-translation</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/markdown/" class="post-tag no-text-decoration" >markdown</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20NSAttributedString%20HTML%20Rendering%EF%BD%9CEfficient%20Alternative%20to%20DocumentType.html%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20NSAttributedString%20HTML%20Rendering%EF%BD%9CEfficient%20Alternative%20to%20DocumentType.html%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and EfficiencyÔΩúTool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD ÂÆûÊàòÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄ‰πàÔºüÂ¶Ç‰ΩïÈÄèËøá CI/CD ÊâìÈÄ†Á®≥ÂÆöÈ´òÊïàÁöÑÂºÄÂèëÂõ¢ÈòüÔºüÂ∑•ÂÖ∑ÈÄâÊã©Ôºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD ÂØ¶Êà∞ÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄÈ∫ºÔºüÂ¶Ç‰ΩïÈÄèÈÅé CI/CD ÊâìÈÄ†Á©©ÂÆöÈ´òÊïàÁöÑÈñãÁôºÂúòÈöäÔºüÂ∑•ÂÖ∑ÈÅ∏ÊìáÔºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web AppÔΩúIntegrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">‰ΩøÁî® Google Apps Script Web App Ë°®Âçï‰∏≤Êé• Github Action CI/CD Â∑•‰Ωú</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters üîñ</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering</h4><div class="text-muted"><p>Discover how to transform HTML into NSAttributedString with a custom-built ZMarkupParser engine, solving rendering challenges and enhancing text display precision for iOS developers.</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/zmarkupparser-convert-html-string-to-nsattributedstring-with-custom-style-keys-a5643de271e4/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1677402187" data-df="ll" > Feb 26, 2023 </time><h4 class="pt-0 my-2">ZMarkupParserÔΩúConvert HTML String to NSAttributedString with Custom Style Keys</h4><div class="text-muted"><p>Developers facing challenges in converting HTML strings to NSAttributedString can utilize ZMarkupParser to apply precise style key mappings, ensuring accurate and customizable text rendering in iOS...</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-%E8%A7%A3%E6%B1%BA%E9%96%83%E9%80%80%E8%88%87%E6%95%88%E8%83%BD%E7%93%B6%E9%A0%B8-a8c2d26cc734/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654791119" data-df="ll" > Jun 10, 2022 </time><h4 class="pt-0 my-2">Ëá™Ë°åÂØ¶Áèæ iOS NSAttributedString HTML Render</h4><div class="text-muted"><p>iOS NSAttributedString DocumentType.html ÁöÑÊõø‰ª£ÊñπÊ°à</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/medium-%E6%96%87%E7%AB%A0%E8%BD%89-markdown-%E5%B7%A5%E5%85%B7-%E5%85%8D%E7%99%BB%E5%85%A5%E8%87%AA%E5%8B%95%E5%82%99%E4%BB%BD%E5%9C%96%E7%89%87%E8%88%87%E5%B5%8C%E5%85%A5%E5%85%A7%E5%AE%B9-ddd88a84e177/" class="btn btn-outline-primary" aria-label="Older" ><p>Medium ÊñáÁ´†ËΩâ Markdown Â∑•ÂÖ∑ÔΩúÂÖçÁôªÂÖ•Ëá™ÂãïÂÇô‰ªΩÂúñÁâáËàáÂµåÂÖ•ÂÖßÂÆπ</p></a> <a href="/posts/zrealm-dev/zh-cn/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AE%9E%E7%8E%B0-%E8%A7%A3%E5%86%B3%E9%97%AA%E9%80%80%E4%B8%8E%E6%95%88%E8%83%BD%E7%93%B6%E9%A2%88-a8c2d26cc734/" class="btn btn-outline-primary" aria-label="Newer" ><p>Ëá™Ë°åÂÆûÁé∞ iOS NSAttributedString HTML Render</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">Ê≠£È´î‰∏≠Êñá</a> | <a href="/tags/simplified-chinese">ÁÆÄ‰Ωì‰∏≠Êñá</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-20 16:09:53 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
