<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Complete Guide to Implementing Local Cache Functionality with AVPlayer" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate" /><meta property="og:description" content="Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/complete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/complete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-31T18:41:42+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" /><meta property="twitter:title" content="Complete Guide to Implementing Local Cache Functionality with AVPlayer" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2024-04-13T16:45:21+08:00","datePublished":"2021-01-31T18:41:42+08:00","description":"Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate","headline":"Complete Guide to Implementing Local Cache Functionality with AVPlayer","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg==","url":"https://zhgchg.li/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/complete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/complete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003/"}</script><title>Complete Guide to Implementing Local Cache Functionality with AVPlayer | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Complete Guide to Implementing Local Cache Functionality with AVPlayer</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Complete Guide to Implementing Local Cache Functionality with AVPlayer</h1><p class="post-desc fw-light mb-4">Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1612089702" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 31, 2021 </time> </span> <span> Updated <time data-ts="1712997921" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 13, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link preview-img blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="5845 words" > <em>32 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Complete Guide to Implementing Local Cache Functionality with AVPlayer</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Complete Guide to Implementing Local Cache Functionality with AVPlayer</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><hr /><h3 id="ℹ️ℹ️ℹ️-the-following-content-is-translated-by-openai"><span class="me-2">ℹ️ℹ️ℹ️ The following content is translated by OpenAI.</span><a href="#ℹ️ℹ️ℹ️-the-following-content-is-translated-by-openai" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="click-here-to-view-the-original-chinese-version--點此查看本文中文版"><span class="me-2"><a href="/posts/6ce488898003/">Click here</a> to view the original Chinese version. | <a href="/posts/6ce488898003/">點此查看本文中文版</a></span><a href="#click-here-to-view-the-original-chinese-version--點此查看本文中文版" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><hr /><h3 id="complete-guide-to-implementing-local-cache-functionality-with-avplayer"><span class="me-2">Complete Guide to Implementing Local Cache Functionality with AVPlayer</span><a href="#complete-guide-to-implementing-local-cache-functionality-with-avplayer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate</p><p><a href="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*lAGpCiT80GFIQ2adYworVw.webp" alt="Photo by [Tyler Lastovich](https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjQ4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@lastly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Tyler Lastovich</a></p><h4 id="20230312-update"><span class="me-2">[2023/03/12] Update</span><a href="#20230312-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/ZhgChgLi/ZPlayerCacher" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/612890185/346ae563-7278-4518-a19b-f5d367e60adc" alt="" loading="lazy"></a></p><p>I have open-sourced my previous implementation, so friends in need can use it directly.</p><ul><li>Customizable cache strategies, can use PINCache or others…<li>Externally, just call the make AVAsset factory with the URL, and the AVAsset will support caching.<li>Implemented data flow strategy using Combine.<li>Wrote some tests.</ul><h3 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>It has been over half a year since the last article, “<a href="/posts/zrealm-dev/en/exploring-ios-hls-cache-implementation-methods-d796bf8e661e/">Exploring iOS HLS Cache Implementation Methods</a>,” and our team has been eager to implement the functionality of streaming while caching due to its significant impact on costs. We are a music streaming platform, and if we have to retrieve the entire file every time the same song is played, it is detrimental to both us and users who are not on unlimited plans. Although music files are usually just a few MB, every little bit adds up!</p><p>Additionally, since Android has already implemented streaming while caching, we have compared costs, and after the Android version went live, we clearly saved a lot of bandwidth; therefore, we expect even better bandwidth management for the larger iOS user base.</p><p>Based on the experience from the <a href="/posts/zrealm-dev/en/exploring-ios-hls-cache-implementation-methods-d796bf8e661e/">previous article</a>, if we continue to use HLS (*.m3u8/*.ts) to achieve our goal, things will become very complicated, if not impossible. We decided to revert to using mp3 files, which allows us to directly implement <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code>.</p><h3 id="goals"><span class="me-2">Goals</span><a href="#goals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Music that has been played will generate a local cache backup.<li>When playing music, first check if there is a cache locally; if so, do not request the file from the server again.<li>Cache strategies can be set; total capacity limits, and when exceeded, the oldest cache files will be deleted.<li>Do not interfere with the original AVPlayer playback mechanism. (Otherwise, the fastest method would be to use URLSession to download the mp3 file and feed it to AVPlayer, but that would lose the functionality of streaming as needed, requiring users to wait longer and consuming more bandwidth.)</ul><h3 id="prerequisite-knowledge-1-http11-range-requests-connection-keep-alive"><span class="me-2">Prerequisite Knowledge (1)— HTTP/1.1 Range Requests, Connection Keep-Alive</span><a href="#prerequisite-knowledge-1-http11-range-requests-connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="http11-range-requests"><span class="me-2">HTTP/1.1 Range Requests</span><a href="#http11-range-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First, we need to understand how data is requested from the server when playing videos or music. Generally, video and music files are large, and it is not feasible to wait until the entire file is downloaded before starting playback. The common approach is to play as data is received; as long as there is data for the currently playing segment, it can function.</p><p>The way to achieve this functionality is through HTTP/1.1 Range requests, which only return the specified byte range of data. For example, specifying 0–100 will only return 100 bytes of data from 0 to 100. This method allows for sequentially obtaining data in segments, which can then be assembled into a complete file. This method can also be applied to file download resumption functionality.</p><h4 id="how-to-apply"><span class="me-2">How to Apply?</span><a href="#how-to-apply" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We will first use HEAD to check the response header to understand whether the server supports range requests, the total length of the resource, and the file type:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> HEAD http://zhgchg.li/music.mp3
</pre></table></code></div></div><p><strong>Using HEAD, we can obtain the following information from the response header:</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> indicates that the server supports range requests. If this value is absent or if it is Accept-Ranges: none, it means it does not support range requests.<li><strong>Content-Length:</strong> the total length of the resource; we need to know the total length to segment the data requests.<li><strong>Content-Type:</strong> the file type, which is information that AVPlayer needs during playback.</ul><p>However, sometimes we also use GET with <code class="language-plaintext highlighter-rouge">Range: bytes=0–1</code>, meaning we request data in the range of 0–1, but we do not actually care about the content of 0–1; we just want to see the information in the response header. <strong>The native AVPlayer uses GET to check, so this article will also follow suit.</strong></p><blockquote><p><em>However, it is recommended to use HEAD for checking, as it is a more accurate method. On the other hand, if the server does not support range functionality, using GET will force a complete file download.</em></p></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–1"</span>
</pre></table></code></div></div><p><strong>Using GET, we can obtain the following information from the response header:</strong></p><ul><li><strong>Accept-Ranges: bytes</strong> indicates that the server supports range requests. If this value is absent or if it is Accept-Ranges: none, it means it does not support range requests.<li><strong>Content-Range: bytes 0–1/total length</strong> indicates the total length of the resource after the “/”; we need to know the total length to segment the data requests.<li><strong>Content-Type:</strong> the file type, which is information that AVPlayer needs during playback.</ul><p><a href="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IP55kaFB3NES3QWZ7Mf-aw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijg4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><strong>Once we know that the server supports range requests, we can start making segmented range requests:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–100"</span>
</pre></table></code></div></div><p><strong>The server will return 206 Partial Content:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Content-Range: bytes 0-100/total length
Content-Length: 100
...
(binary content)
</pre></table></code></div></div><p>At this point, we have obtained the data for range 0–100 and can continue to make new requests for ranges 100–200, 200–300, and so on until completion.</p><p>If the requested range exceeds the total length of the resource, it will return 416 Range Not Satisfiable.</p><p>Additionally, to obtain the complete file data, we can request Range 0–total length or simply use 0–:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-i</span> <span class="nt">-X</span> GET http://zhgchg.li/music.mp3 <span class="nt">-H</span> <span class="s2">"Range: bytes=0–"</span>
</pre></table></code></div></div><p>Other requests can also specify multiple range data and conditions, but we will not use those; for details, please <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Range_requests" target="_blank">refer to this</a>.</p><h4 id="connection-keep-alive"><span class="me-2">Connection Keep-Alive</span><a href="#connection-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>HTTP/1.1 is enabled by default, and <strong>this feature allows for real-time retrieval of downloaded data</strong>. For example, a 5 MB file can be retrieved in chunks of 16 KB, 16 KB, 16 KB, etc., without having to wait for the entire 5 MB to be ready.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Connection: Keep-Alive
</pre></table></code></div></div><h4 id="what-if-the-server-does-not-support-range-or-keep-alive"><span class="me-2"><strong><em>What if the server does not support Range or Keep-Alive?</em></strong></span><a href="#what-if-the-server-does-not-support-range-or-keep-alive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><em>In that case, there is no need to complicate things; just use URLSession to download the mp3 file and feed it to the player… But that is not the result we want, so we can ask the backend to modify the server settings.</em></p></blockquote><h3 id="prerequisite-knowledge-2--how-does-avplayer-natively-handle-avurlasset-resources"><span class="me-2">Prerequisite Knowledge (2) — How does AVPlayer natively handle AVURLAsset resources?</span><a href="#prerequisite-knowledge-2--how-does-avplayer-natively-handle-avurlasset-resources" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*iLE51pGNDl_5Jwp8cTM6HQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjY1IiBoZWlnaHQ9Ijc5MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>When we use AVURLAsset initialized with a URL resource and assign it to AVPlayer/AVQueuePlayer to start playback, as mentioned above, it will first use GET Range 0–1 to obtain whether range requests are supported, the total length of the resource, and the file type.</p><p>After obtaining the file information, a second request will be made to request data from 0 to total length.</p><blockquote><p><em>⚠️ <strong>AVPlayer will request data from 0 to total length and will use the real-time retrieval of downloaded data feature (16 KB, 16 KB, 16 KB…) to obtain enough data before it will issue a cancel to terminate this network request</strong> (so it will not actually retrieve everything unless the file is very small).</em></p></blockquote><blockquote><p><em>Subsequent playback will then request data further along using range requests.</em></p></blockquote><blockquote><p><em>(This part is different from what I previously thought; I assumed it would request 0–100, 100–200, etc.)</em></p></blockquote><p><strong>AVPlayer Request Example:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>1. GET Range 0-1 =&gt; Response: total length 150000 / public.mp3 / true
2. GET 0-150000...
3. 16 KB received
4. 16 KB received...
5. cancel() // current offset is 700
6. Continue playback
7. GET 700-150000...
8. 16 KB received
9. 16 KB received...
10. cancel() // current offset is 1500
11. Continue playback
12. GET 1500-150000...
13. 16 KB received
14. 16 KB received...
16. If seek to...5000
17. cancel(12.) // current offset is 2000
18. GET 5000-150000...
19. 16 KB received
20. 16 KB received...
...
</pre></table></code></div></div><blockquote><p><em>⚠️ <strong>In iOS ≤12, it will first issue a few shorter requests to probe (?), and then it will issue a request for the total length; in iOS ≥ 13, it will directly issue a request for the total length.</strong></em></p></blockquote><p>There is also an unrelated pitfall; while observing how resources are fetched, I used the <a href="/posts/zrealm-dev/en/the-app-uses-https-for-transmission-but-data-still-gets-stolen-46410aaada00/">mitmproxy</a> tool to sniff the traffic, and I found that it displayed an error, waiting until the entire response came back before showing it, rather than displaying it in segments and continuing the download using persistent connections; it startled me! I thought iOS was so inefficient that it had to download the entire file each time! Next time I use a tool, I need to maintain a bit of skepticism.</p><h4 id="timing-of-cancel-requests"><span class="me-2">Timing of Cancel Requests</span><a href="#timing-of-cancel-requests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ol><li>The second request mentioned earlier, which requests resources from 0 to total length, will issue a cancel request once sufficient data has been received.<li>During seeking, a cancel request will be issued for the previous request.</ol><blockquote><p><em>⚠️ In AVQueuePlayer, switching to the next resource or changing the playback resource in AVPlayer will not issue a cancel request for the previous one.</em></p></blockquote><h4 id="avqueue-pre-buffering"><span class="me-2">AVQueue Pre-buffering</span><a href="#avqueue-pre-buffering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This also calls the Resource Loader, but it requests a smaller range of data.</p><h3 id="implementation"><span class="me-2">Implementation</span><a href="#implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>With the above prerequisite knowledge, let’s look at how to implement the local cache functionality for AVPlayer.</p><p>This involves the previously mentioned <code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code>, which allows us to <strong>implement our own Resource Loader</strong> for the asset.</p><p>The Resource Loader is essentially a worker; whether the player needs file information or file data, and what ranges are needed, it informs us, and we take action accordingly.</p><blockquote><p><em>I have seen examples where a <strong>Resource Loader serves all AVURLAssets</strong>, but I believe this is incorrect; there should be one Resource Loader serving one AVURLAsset, following the lifecycle of the AVURLAsset, as it inherently belongs to the AVURLAsset.</em></p></blockquote><blockquote><p><em>Having one Resource Loader serve all AVURLAssets in AVQueuePlayer would become very complex and difficult to manage.</em></p></blockquote><h4 id="timing-for-entering-custom-resource-loader"><span class="me-2">Timing for Entering Custom Resource Loader</span><a href="#timing-for-entering-custom-resource-loader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>It is important to note that simply implementing your own Resource Loader does not mean it will be used; it will only be invoked when the system cannot recognize or handle the resource.</p><p>Therefore, before providing the URL resource to AVURLAsset, we need to change the scheme to our custom scheme, which cannot be http/https or any other scheme that the system can handle.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://zhgchg.li/music.mp3 =&gt; cacheable://zhgchg.li/music.mp3
</pre></table></code></div></div><h4 id="avassetresourceloaderdelegate"><span class="me-2"><code class="language-plaintext highlighter-rouge">AVAssetResourceLoaderDelegate</code></span><a href="#avassetresourceloaderdelegate" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Only two methods need to be implemented:</strong></p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, shouldWaitForLoadingOfRequestedResource <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) -&gt; Bool :</ul><p>This method asks us whether we can handle this resource; returning true means we can, and returning false means we do not handle it (unsupported URL).</p><p>From <code class="language-plaintext highlighter-rouge">loadingRequest</code>, we can extract what is being requested (whether it is the first request for file information or a request for data, and if it is a data request, what the range is); knowing the request, we can initiate our own request to fetch the data. <strong>At this point, we can decide whether to initiate a URLSession request or return data from local storage.</strong></p><p>We can also perform data encryption and decryption operations here to protect the original data.</p><ul><li>func resourceLoader( _ resourceLoader: AVAssetResourceLoader, didCancel <strong>loadingRequest</strong> : AVAssetResourceLoadingRequest) :</ul><p>As mentioned earlier, when a cancel request is issued…</p><p>We can cancel any ongoing URLSession requests here.</p><p><a href="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*widvJqzE-HtG32B-6ZiFhw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDYwIiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="local-cache-implementation"><span class="me-2">Local Cache Implementation</span><a href="#local-cache-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For caching, I directly use <a href="https://github.com/pinterest/PINCache" target="_blank">PINCache</a> to handle cache operations, eliminating the need for us to manage cache read/write deadlocks and implement LRU cache clearing strategies.</p><blockquote><p><strong><em>️️⚠️️️️️️️️️️️OOM Warning!</em></strong></p></blockquote><blockquote><p><em>Since this is aimed at caching music files, which are typically around 10 MB, we can use PINCache as a local caching tool; however, this method cannot be used for video services (which may require loading several GB of data into memory at once).</em></p></blockquote><p>For those with similar needs, you can refer to the approach of using FileHandle seek read/write features for handling this.</p><h3 id="lets-get-started"><span class="me-2">Let’s Get Started!</span><a href="#lets-get-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Without further ado, here is the complete project:</p><p><a href="https://github.com/zhgchgli0718/resourceLoaderDemo" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b43d0ddf4687cf5a04d6bbc68e4bfd24a9d5067fe04e2e198a676aff746de403/zhgchgli0718/resourceLoaderDemo" alt="" loading="lazy"></a></p><h4 id="assetdata"><span class="me-2">AssetData</span><a href="#assetdata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The local cache data object implements NSCoding, as PINCache relies on the archivedData method for encoding/decoding.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CryptoKit</span>

<span class="kd">class</span> <span class="kt">AssetDataContentInformation</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentLength</span><span class="p">:</span> <span class="kt">Int64</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentType</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">isByteRangeAccessSupported</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentLength</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentType</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeInt64</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentLength</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">contentType</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">??</span> <span class="s">""</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetDataContentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">??</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
    <span class="kd">@objc</span> <span class="k">var</span> <span class="nv">mediaData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">AssetDataContentInformation</span> <span class="p">??</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">??</span> <span class="kt">Data</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">AssetData</code> <strong>stores:</strong></p><ul><li><code class="language-plaintext highlighter-rouge">contentInformation</code>: AssetDataContentInformation <code class="language-plaintext highlighter-rouge">AssetDataContentInformation</code>: stores whether range requests are supported (isByteRangeAccessSupported), the total length of the resource (contentLength), and the file type (contentType).<li><code class="language-plaintext highlighter-rouge">mediaData</code>: Original audio Data <strong>(this may cause OOM if the file is too large)</strong></ul><h4 id="pincacheassetdatamanager"><span class="me-2">PINCacheAssetDataManager</span><a href="#pincacheassetdatamanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-markdown highlighter-rouge"><div class="code-header"> <span data-label-text="Markdown"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre><td class="rouge-code"><pre>Encapsulating the logic for storing and retrieving data in PINCache.
<span class="p">```</span><span class="nl">swift
</span><span class="kd">import</span> <span class="kt">PINCache</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">protocol</span> <span class="kt">AssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span>
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="n">from</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">from</span>
            <span class="n">data</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">with</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">start</span><span class="o">..&lt;</span><span class="n">with</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//</span>

<span class="kd">class</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">AssetDataManager</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">Cache</span><span class="p">:</span> <span class="kt">PINCache</span> <span class="o">=</span> <span class="kt">PINCache</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"ResourceLoader"</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">cacheKey</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">_</span> <span class="nv">contentInformation</span><span class="p">:</span> <span class="kt">AssetDataContentInformation</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">AssetData</span><span class="p">()</span>
        <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span> <span class="o">=</span> <span class="n">contentInformation</span>
        <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">saveDownloadedData</span><span class="p">(</span><span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">mergeDownloadedDataIfIsContinuted</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">mediaData</span>
            
            <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">setObjectAsync</span><span class="p">(</span><span class="n">assetData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AssetData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="nf">object</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">cacheKey</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">AssetData</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">assetData</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here, the protocol is extracted because in the future, we may use other storage methods instead of PINCache, allowing other programs to rely on the protocol rather than the class instance.</p><blockquote><p><em>⚠️ <code class="language-plaintext highlighter-rouge">mergeDownloadedDataIfIsContinuted</code> <strong>This method is extremely important.</strong></em></p></blockquote><p>For linear playback, you can simply append new data to the cached data. However, the reality is much more complex; users might play from range 0-100 and then directly seek to range 200-500. How to merge the existing 0-100 data with the new 200-500 data is a significant challenge.</p><blockquote><p><em>⚠️ Issues with data merging can lead to terrifying playback glitches…</em></p></blockquote><p>The answer here is that <strong>we do not handle non-continuous data</strong>; since our project only deals with audio and the files are only a few MB (≤ 10MB), we decided not to implement it due to development costs. I only handle merging continuous data (for example, if we already have 0-100 and the new data is 75-200, the merge results in 0-200; if the new data is 150-200, I will ignore it and not merge).</p><p><a href="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*Cyfusv16pk1AtpGAjJlMMQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjM2IiBoZWlnaHQ9IjgwOCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>If we want to consider non-continuous merging, we would need to use other methods for storage (to identify the missing parts); during requests, we would also need to query which segments require network requests and which segments can be retrieved locally. Implementing this would be very complex.</p><p><a href="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*XgMZGKMb-YNCFnS9MbiZhw.webp" alt="Image source: [Design and Implementation of iOS AVPlayer Video Caching](http://chuquan.me/2019/12/03/ios-avplayer-support-cache/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iMjQ1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Image source: <a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">Design and Implementation of iOS AVPlayer Video Caching</a></p><h4 id="cachingavurlasset"><span class="me-2">CachingAVURLAsset</span><a href="#cachingavurlasset" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>AVURLAsset weakly holds the ResourceLoader delegate, so it is recommended to create your own AVURLAsset class that inherits from AVURLAsset, internally creating, assigning, and holding the ResourceLoader, allowing it to follow the lifecycle of AVURLAsset. Additionally, you can store the original URL, cache key, and other information.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">CachingAVURLAsset</span><span class="p">:</span> <span class="kt">AVURLAsset</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">customScheme</span> <span class="o">=</span> <span class="s">"cacheable"</span>
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_resourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoader</span><span class="p">?</span>
    
    <span class="k">var</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lastPathComponent</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">_</span> <span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">[</span><span class="s">"http"</span><span class="p">,</span> <span class="s">"https"</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="nf">init</span><span class="p">(</span><span class="n">url</span> <span class="kt">URL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="kt">URL</span>
        
        <span class="k">guard</span> <span class="k">var</span> <span class="nv">components</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">resolvingAgainstBaseURL</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="n">customScheme</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">resourceLoader</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">resourceLoader</span><span class="o">.</span><span class="nf">setDelegate</span><span class="p">(</span><span class="n">resourceLoader</span><span class="p">,</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">resourceLoader</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_resourceLoader</span> <span class="o">=</span> <span class="n">resourceLoader</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Usage:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="kt">CachingAVURLAsset</span><span class="o">.</span><span class="nf">isSchemeSupport</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">asset</span> <span class="o">=</span> <span class="kt">CachingAVURLAsset</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
  <span class="k">let</span> <span class="nv">avplayer</span> <span class="o">=</span> <span class="kt">AVPlayer</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
  <span class="n">avplayer</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">isSchemeSupport()</code> function is used to determine if the URL supports our Resource Loader (excluding file://).</p><p><code class="language-plaintext highlighter-rouge">originalURL</code> stores the original resource URL.</p><p><code class="language-plaintext highlighter-rouge">cacheKey</code> stores the cache key for this resource, which is directly set to the file name.</p><p>Please adjust the <code class="language-plaintext highlighter-rouge">cacheKey</code> according to real-world scenarios. If the file name is not hashed and may be duplicated, it is recommended to hash it first to avoid collisions; if you want to hash the entire URL as the key, be cautious about whether the URL may change (e.g., if using a CDN).</p><p>You can use md5…sha… For iOS ≥ 13, you can directly use Apple’s <a href="https://developer.apple.com/documentation/cryptokit/" target="_blank">CryptoKit</a>, otherwise, you can find alternatives on GitHub!</p><h4 id="resourceloaderrequest"><span class="me-2">ResourceLoaderRequest</span><a href="#resourceloaderrequest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">protocol</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ResourceLoaderRequest</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">URLSessionDataDelegate</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">start</span><span class="p">:</span> <span class="kt">Int64</span>
        <span class="k">var</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">RequestRangeEnd</span>
        
        <span class="kd">enum</span> <span class="kt">RequestRangeEnd</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nf">requestTo</span><span class="p">(</span><span class="kt">Int64</span><span class="p">)</span>
            <span class="k">case</span> <span class="n">requestToEnd</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">contentInformation</span>
        <span class="k">case</span> <span class="n">dataRequest</span>
    <span class="p">}</span>
    
    <span class="kd">struct</span> <span class="kt">ResponseUnExpectedError</span><span class="p">:</span> <span class="kt">Error</span> <span class="p">{</span> <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span>
    
    <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    <span class="k">let</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isCancelled</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidateAndCancel</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">isFinished</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">isFinished</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">session</span><span class="p">?</span><span class="o">.</span><span class="nf">finishTasksAndInvalidate</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">RequestType</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="kt">AssetDataManager</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">originalURL</span>
        <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span> <span class="o">=</span> <span class="n">loaderQueue</span>
        <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span> <span class="o">=</span> <span class="n">assetDataManager</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="kt">RequestRange</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">isCancelled</span> <span class="o">==</span> <span class="kc">false</span><span class="p">,</span> <span class="n">isFinished</span> <span class="o">==</span> <span class="kc">false</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span> <span class="o">=</span> <span class="n">requestRange</span>
            <span class="k">let</span> <span class="nv">start</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">requestRange</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">String</span>
            <span class="k">switch</span> <span class="n">requestRange</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="n">rangeEnd</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="s">""</span>
            <span class="p">}</span>
            
            <span class="k">let</span> <span class="nv">rangeHeader</span> <span class="o">=</span> <span class="s">"bytes=</span><span class="se">\(</span><span class="n">start</span><span class="se">)</span><span class="s">-</span><span class="se">\(</span><span class="n">end</span><span class="se">)</span><span class="s">"</span>
            <span class="n">request</span><span class="o">.</span><span class="nf">setValue</span><span class="p">(</span><span class="n">rangeHeader</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Range"</span><span class="p">)</span>
            
            <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">delegateQueue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="k">let</span> <span class="nv">dataTask</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">dataTask</span> <span class="o">=</span> <span class="n">dataTask</span>
            <span class="n">dataTask</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">dataRequest</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">,</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">URLSession</span><span class="o">.</span><span class="kt">ResponseDisposition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="nf">completionHandler</span><span class="p">(</span><span class="o">.</span><span class="n">allow</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isFinished</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="o">.</span><span class="k">async</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span>
                      <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">response</span> <span class="k">as?</span> <span class="kt">HTTPURLResponse</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">responseError</span> <span class="o">=</span> <span class="n">error</span> <span class="p">??</span> <span class="kt">ResponseUnExpectedError</span><span class="p">()</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">responseError</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                
                <span class="k">let</span> <span class="nv">contentInformation</span> <span class="o">=</span> <span class="kt">AssetDataContentInformation</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Content-Range"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytesString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">bytes</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">bytesString</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">bytes</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
                   <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="s">"Accept-Ranges"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
                   <span class="n">value</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="p">}</span>
                
                <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveContentInformation</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">)</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">contentInformation</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">offset</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requestRange</span><span class="p">?</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">self</span><span class="o">.</span><span class="n">assetDataManager</span><span class="p">?</span><span class="o">.</span><span class="nf">saveDownloadedData</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">,</span> <span class="nv">offset</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
                <span class="p">}</span>
                <span class="k">self</span><span class="o">.</span><span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">downloadedData</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This encapsulates the remote request, primarily serving the data requests initiated by the ResourceLoader.</p><p><code class="language-plaintext highlighter-rouge">RequestType</code>: Used to distinguish whether this request is for the first file information request (contentInformation) or for data request (dataRequest).</p><p><code class="language-plaintext highlighter-rouge">RequestRange</code>: The range of the request, where the end can specify where to request (requestTo(Int64)) or all (requestToEnd).</p><p>File information can be obtained from:</p><pre><code class="language-less">func urlSession(_ session: URLSession, dataTask: URLSessionDataTask, didReceive response: URLResponse, completionHandler: @escaping (URLSession.ResponseDisposition) -&gt; Void)
</code></pre><p>Additionally, note that if you want to change to HEAD requests, you won’t enter this method and will need to handle it differently.</p><ul><li><code class="language-plaintext highlighter-rouge">isByteRangeAccessSupported</code>: Checks if the response header has <strong>Accept-Ranges == bytes</strong><li><code class="language-plaintext highlighter-rouge">contentType</code>: The file type information required by the player, in the format of a uniform type identifier, not audio/mpeg, but written as public.mp3<li><code class="language-plaintext highlighter-rouge">contentLength</code>: Looks at the response header’s <strong>Content-Range</strong>: bytes 0–1/ <strong>total length of the resource</strong></ul><blockquote><p><em>⚠️ Be cautious of the case sensitivity of the format provided by the server; it may not always be written as Accept-Ranges/Content-Range; some servers may use lowercase accept-ranges, Accept-ranges…</em></p></blockquote><p><strong>Supplement: If you want to consider case sensitivity, you can write an HTTPURLResponse extension</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">CoreServices</span>

<span class="kd">extension</span> <span class="kt">HTTPURLResponse</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">parseContentLengthFromContentRange</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Int64</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Content-Range"</span><span class="p">,</span>
            <span class="s">"content-range"</span><span class="p">,</span>
            <span class="s">"Content-range"</span><span class="p">,</span>
            <span class="s">"content-Range"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLengthString</span> <span class="o">=</span> <span class="n">rangeString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span><span class="kt">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)})</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">contentLength</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">contentLengthString</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentLength</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">parseAcceptRanges</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">contentRangeKeys</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">"Accept-Ranges"</span><span class="p">,</span>
            <span class="s">"accept-ranges"</span><span class="p">,</span>
            <span class="s">"Accept-ranges"</span><span class="p">,</span>
            <span class="s">"accept-Ranges"</span>
        <span class="p">]</span>
        
        <span class="k">var</span> <span class="nv">rangeString</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="n">contentRangeKeys</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">allHeaderFields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="p">{</span>
                <span class="n">rangeString</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">rangeString</span> <span class="o">=</span> <span class="n">rangeString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"bytes"</span> <span class="o">||</span> <span class="n">rangeString</span> <span class="o">==</span> <span class="s">"Bytes"</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">mimeTypeUTI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">mimeType</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">mimeType</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">contentType</span> <span class="o">=</span> <span class="kt">UTTypeCreatePreferredIdentifierForTag</span><span class="p">(</span><span class="n">kUTTagClassMIMEType</span><span class="p">,</span> <span class="n">mimeType</span> <span class="k">as</span> <span class="kt">CFString</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)?</span><span class="o">.</span><span class="nf">takeRetainedValue</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">contentType</span> <span class="k">as</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Usage:</p><ul><li>contentLength = response.parseContentLengthFromContentRange()<li>isByteRangeAccessSupported = response.parseAcceptRanges()<li>contentType = response.mimeTypeUTI()</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">dataTask</span><span class="p">:</span> <span class="kt">URLSessionDataTask</span><span class="p">,</span> <span class="n">didReceive</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span>
</pre></table></code></div></div><p>As mentioned in the introductory knowledge, this method will continuously receive the downloaded data, so it will keep entering this method, obtaining data in segments; we will append it into <code class="language-plaintext highlighter-rouge">downloadedData</code> for storage.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">urlSession</span><span class="p">(</span><span class="n">_</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span><span class="p">,</span> <span class="nv">task</span><span class="p">:</span> <span class="kt">URLSessionTask</span><span class="p">,</span> <span class="n">didCompleteWithError</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?)</span>
</pre></table></code></div></div><p>This method will be called when the task is canceled or completed, where we will save the downloaded data.</p><p>As mentioned in the introductory knowledge, the cancel mechanism is that the player will initiate a cancel request once it has enough data; therefore, when entering this method, the actual <code class="language-plaintext highlighter-rouge">error</code> will be <code class="language-plaintext highlighter-rouge">NSURLErrorCancelled</code>, so regardless of the error, we will attempt to save the data we have obtained.</p><blockquote><p><em>⚠️ Since URLSession requests data in parallel, please keep operations within DispatchQueue to avoid data corruption (data corruption can also lead to terrifying playback glitches).</em></p></blockquote><blockquote><p><em>️️⚠️ If neither <code class="language-plaintext highlighter-rouge">finishTasksAndInvalidate</code> nor <code class="language-plaintext highlighter-rouge">invalidateAndCancel</code> is called, URLSession will strongly hold the object, causing a memory leak; therefore, regardless of whether it is canceled or completed, we must call these methods to release the request at the end of the task.</em></p></blockquote><blockquote><p><em>️️⚠️️️️️️️️️️️ If you are concerned about <code class="language-plaintext highlighter-rouge">downloadedData</code> causing an OOM, you can save it locally in didReceive Data.</em></p></blockquote><h4 id="resourceloader"><span class="me-2">ResourceLoader</span><a href="#resourceloader" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">AVFoundation</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">class</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">loaderQueue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.resourceLoader.queue"</span><span class="p">)</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">cacheKey</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">originalURL</span><span class="p">:</span> <span class="kt">URL</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">asset</span><span class="p">:</span> <span class="kt">CachingAVURLAsset</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">cacheKey</span>
        <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">originalURL</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">in</span>
            <span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre><td class="rouge-code"><pre><span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoaderDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nv">type</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">assetDataManager</span> <span class="o">=</span> <span class="kt">PINCacheAssetDataManager</span><span class="p">(</span><span class="nv">cacheKey</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">cacheKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">assetData</span> <span class="o">=</span> <span class="n">assetDataManager</span><span class="o">.</span><span class="nf">retrieveAssetData</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
                <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">end</span><span class="p">:</span> <span class="kt">Int64</span>
                    <span class="k">switch</span> <span class="n">range</span><span class="o">.</span><span class="n">end</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="k">let</span> <span class="nv">rangeEnd</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">rangeEnd</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">requestToEnd</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
                    <span class="p">}</span>
                    
                    <span class="k">if</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">end</span> <span class="p">{</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="kt">Int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">true</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">range</span><span class="o">.</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
                        <span class="c1">// has cache data...but not enough</span>
                        <span class="k">let</span> <span class="nv">subEnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">?</span> <span class="kt">Int</span><span class="p">((</span><span class="n">end</span><span class="p">))</span> <span class="p">:</span> <span class="p">(</span><span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="k">let</span> <span class="nv">subData</span> <span class="o">=</span> <span class="n">assetData</span><span class="o">.</span><span class="n">mediaData</span><span class="o">.</span><span class="nf">subdata</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="kt">Int</span><span class="p">(</span><span class="n">range</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">..&lt;</span><span class="n">subEnd</span><span class="p">)</span>
                        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">subData</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">range</span> <span class="o">=</span> <span class="kt">ResourceLoader</span><span class="o">.</span><span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">loadingRequest</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="kt">ResourceLoaderRequest</span><span class="p">(</span><span class="nv">originalURL</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">originalURL</span><span class="p">,</span> <span class="nv">type</span><span class="p">:</span> <span class="n">type</span><span class="p">,</span> <span class="nv">loaderQueue</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">loaderQueue</span><span class="p">,</span> <span class="nv">assetDataManager</span><span class="p">:</span> <span class="n">assetDataManager</span><span class="p">)</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">resourceLoaderRequest</span>
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">requestRange</span><span class="p">:</span> <span class="n">range</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">resourceLoaderRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="n">loadingRequest</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">resourceLoaderRequest</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span><span class="p">:</span> <span class="kt">ResourceLoaderRequestDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">contentInformationDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">AssetDataContentInformation</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">result</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="k">let</span> <span class="nv">contentInformation</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentType</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentType</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">contentLength</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">contentLength</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span><span class="p">?</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span> <span class="o">=</span> <span class="n">contentInformation</span><span class="o">.</span><span class="n">isByteRangeAccessSupported</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">()</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidReceive</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="nf">respond</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dataRequestDidComplete</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoaderRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">,</span> <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Error</span><span class="p">?,</span> <span class="n">_</span> <span class="nv">downloadedData</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">loadingRequest</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">resourceLoaderRequest</span> <span class="p">})?</span><span class="o">.</span><span class="n">key</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">loadingRequest</span><span class="o">.</span><span class="nf">finishLoading</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">requests</span><span class="o">.</span><span class="nf">removeValue</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="n">loadingRequest</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ResourceLoader</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestType</span><span class="p">(</span><span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">contentInformationRequest</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">contentInformation</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">dataRequest</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">resourceLoaderRequestRange</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestType</span><span class="p">,</span> <span class="n">_</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">contentInformation</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestsAllDataToEndOfResource</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="n">requestToEnd</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lowerBound</span> <span class="o">=</span> <span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">currentOffset</span> <span class="p">??</span> <span class="mi">0</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">loadingRequest</span><span class="o">.</span><span class="n">dataRequest</span><span class="p">?</span><span class="o">.</span><span class="n">requestedLength</span> <span class="p">??</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">let</span> <span class="nv">upperBound</span> <span class="o">=</span> <span class="n">lowerBound</span> <span class="o">+</span> <span class="n">length</span>
                <span class="k">return</span> <span class="kt">ResourceLoaderRequest</span><span class="o">.</span><span class="kt">RequestRange</span><span class="p">(</span><span class="nv">start</span><span class="p">:</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="nv">end</span><span class="p">:</span> <span class="o">.</span><span class="nf">requestTo</span><span class="p">(</span><span class="n">upperBound</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If <code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest</code> != nil, it indicates that this is the first request, and the player is asking for file information.</p><p>When requesting file information, we need to provide these three pieces of information:</p><ul><li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.isByteRangeAccessSupported</code>: Indicates whether range access for data is supported.<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentType</code>: The uniform type identifier.<li><code class="language-plaintext highlighter-rouge">loadingRequest.contentInformationRequest?.contentLength</code>: The total length of the file as Int64.</ul><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedOffset</code> can be used to obtain the starting offset of the requested range.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestedLength</code> can be used to obtain the length of the requested range.</p><p>If <code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.requestsAllDataToEndOfResource</code> == true, it means that regardless of the requested range length, the entire resource will be fetched.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.respond(with: Data)</code> returns the loaded data to the player.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.dataRequest?.currentOffset</code> can be used to obtain the current data offset, and after calling <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code>, the <code class="language-plaintext highlighter-rouge">currentOffset</code> will be updated accordingly.</p><p><code class="language-plaintext highlighter-rouge">loadingRequest.finishLoading()</code> indicates that all data has been loaded and informs the player.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">shouldWaitForLoadingOfRequestedResource</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</pre></table></code></div></div><p>When the player requests data, we first check if there is any data in the local cache. If there is, we return it; if only partial data is available, we return that portion. For example, if we have data from 0–100 and the player requests 0–200, we will return 0–100 first.</p><p>If there is no local cache and the returned data is insufficient, a <code class="language-plaintext highlighter-rouge">ResourceLoaderRequest</code> will be initiated to fetch data from the network.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">resourceLoader</span><span class="p">(</span><span class="n">_</span> <span class="nv">resourceLoader</span><span class="p">:</span> <span class="kt">AVAssetResourceLoader</span><span class="p">,</span> <span class="n">didCancel</span> <span class="nv">loadingRequest</span><span class="p">:</span> <span class="kt">AVAssetResourceLoadingRequest</span><span class="p">)</span>
</pre></table></code></div></div><p>When the player cancels a request, we cancel the <code class="language-plaintext highlighter-rouge">ResourceLoaderRequest</code>.</p><blockquote><p><em>You may have noticed that the offset in <code class="language-plaintext highlighter-rouge">resourceLoaderRequestRange</code> is based on <code class="language-plaintext highlighter-rouge">currentOffset</code>, because we will first respond with the already downloaded data from the local cache using <code class="language-plaintext highlighter-rouge">dataRequest?.respond(with: Data)</code>; thus, we can directly look at the updated offset.</em></p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">requests</span><span class="p">:</span> <span class="p">[</span><span class="kt">AVAssetResourceLoadingRequest</span><span class="p">:</span> <span class="kt">ResourceLoaderRequest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
</pre></table></code></div></div><blockquote><p><em>⚠️ In some examples, <code class="language-plaintext highlighter-rouge">currentRequest: ResourceLoaderRequest</code> is used to store requests, which can lead to issues. If the current request is still being processed and the user seeks, the old request may be canceled while a new one is initiated. Since these actions may not occur in order, using a Dictionary for storage is safer!</em></p></blockquote><blockquote><p><em>⚠️ Ensure all operations are performed on the same DispatchQueue to prevent data corruption.</em></p></blockquote><p><strong>Cancel all ongoing requests when deinitializing</strong><br /> The Resource Loader deinitialization indicates that the AVURLAsset is being deinitialized, meaning the player no longer needs this resource. Therefore, we can cancel any ongoing requests for data, while the already loaded data will still be written to the cache.</p><h3 id="supplement-and-acknowledgments"><span class="me-2">Supplement and Acknowledgments</span><a href="#supplement-and-acknowledgments" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Thanks to <a href="https://medium.com/u/2d01a2439753" target="_blank">Lex Tang</a> for the guidance.</p><p>Thanks to <a href="https://medium.com/u/aab116fd9d4d" target="_blank">my granddaughter</a> for providing development advice and support.</p><h4 id="this-article-only-addresses-small-music-files"><span class="me-2">This article only addresses small music files</span><a href="#this-article-only-addresses-small-music-files" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Large video files may encounter Out Of Memory issues in <code class="language-plaintext highlighter-rouge">downloadedData</code> or <code class="language-plaintext highlighter-rouge">AssetData/PINCacheAssetDataManager</code>.</p><p>As mentioned earlier, to resolve this issue, please use fileHandler seek read/write to operate local cache reading and writing (instead of <code class="language-plaintext highlighter-rouge">AssetData/PINCacheAssetDataManager</code>); or check if there are any GitHub projects available for large data write/read to file.</p><h4 id="avqueueplayer-cancels-ongoing-downloads-when-switching-playback-items"><span class="me-2">AVQueuePlayer cancels ongoing downloads when switching playback items</span><a href="#avqueueplayer-cancels-ongoing-downloads-when-switching-playback-items" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>As stated in the previous knowledge, when changing the playback target, a cancel will not be initiated. If it were AVPlayer, it would trigger AVURLAsset deinitialization, thus interrupting the download. However, AVQueuePlayer does not do this, as it remains in the queue; it simply changes the playback target to the next song.</p><p>The only approach here is to listen for notifications of playback target changes and cancel the previous AVURLAsset loading upon receiving the notification.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">asset</span><span class="o">.</span><span class="nf">cancelLoading</span><span class="p">()</span>
</pre></table></code></div></div><h4 id="audio-data-encryption-and-decryption"><span class="me-2">Audio data encryption and decryption</span><a href="#audio-data-encryption-and-decryption" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Audio encryption and decryption can be performed in <code class="language-plaintext highlighter-rouge">ResourceLoaderRequest</code> when obtaining data, and during storage, it can be done in <code class="language-plaintext highlighter-rouge">AssetData</code>’s encode/decode methods for the locally stored data.</p><p><strong>CryptoKit SHA usage example:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="kt">AssetData</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">NSCoding</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">encryptionKeyString</span> <span class="o">=</span> <span class="s">"encryptionKeyExzhgchgli"</span>
    <span class="o">...</span>
    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">with</span> <span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">contentInformation</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
           <span class="k">let</span> <span class="nv">encryptionData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">seal</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">mediaData</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span><span class="o">.</span><span class="n">combined</span> <span class="p">{</span>
            <span class="n">coder</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">encryptionData</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">required</span> <span class="nf">init</span><span class="p">?(</span><span class="nv">coder</span><span class="p">:</span> <span class="kt">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">mediaData</span> <span class="o">=</span> <span class="n">coder</span><span class="o">.</span><span class="nf">decodeObject</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="k">#keyPath</span><span class="p">(</span><span class="kt">AssetData</span><span class="o">.</span><span class="n">mediaData</span><span class="p">))</span> <span class="k">as?</span> <span class="kt">Data</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">#available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="o">*</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">sealedBox</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="kt">SealedBox</span><span class="p">(</span><span class="nv">combined</span><span class="p">:</span> <span class="n">mediaData</span><span class="p">),</span>
               <span class="k">let</span> <span class="nv">decryptedData</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">ChaChaPoly</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="n">sealedBox</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="kt">AssetData</span><span class="o">.</span><span class="n">encryptionKey</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">mediaData</span> <span class="o">=</span> <span class="n">decryptedData</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pincache-related-operations"><span class="me-2">PINCache related operations</span><a href="#pincache-related-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>PINCache includes <code class="language-plaintext highlighter-rouge">PINMemoryCache</code> and <code class="language-plaintext highlighter-rouge">PINDiskCache</code>, which handle reading from files to memory or writing from memory to files. We only need to operate on <code class="language-plaintext highlighter-rouge">PINCache</code>.</p><p>To find the cache file location in the simulator:</p><p><a href="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*dUWZRwGTRhOAuxnqWJBvog.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NzgiIGhlaWdodD0iOTIiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>Use <code class="language-plaintext highlighter-rouge">NSHomeDirectory()</code> to obtain the simulator file path.</p><p><a href="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*qXzny7KAwK20E6ma8zJUnw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>In Finder, go to -&gt; Paste the path.</p><p><a href="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*IcyAHKsTgaG-xqu1QzQq6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjU0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>In <code class="language-plaintext highlighter-rouge">Library -&gt; Caches -&gt; com.pinterest.PINDiskCache.ResourceLoader</code>, you will find the directory we created for the Resource Loader Cache.</p><p><code class="language-plaintext highlighter-rouge">PINCache(name: “ResourceLoader”)</code> specifies the directory name.</p><p>You can also specify <code class="language-plaintext highlighter-rouge">rootPath</code>, allowing the directory to be moved under Documents (to avoid being cleared by the system).</p><p><strong>Setting the maximum limit for PINCache:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteCount</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// max: 300mb</span>
 <span class="kt">PINCacheAssetDataManager</span><span class="o">.</span><span class="kt">Cache</span><span class="o">.</span><span class="n">diskCache</span><span class="o">.</span><span class="n">byteLimit</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="c1">// 90 days</span>
</pre></table></code></div></div><p><a href="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" class="popup img-link blur"><img data-src="/assets/6ce488898003/1*kjZWSBU__E-2jTYyyjWZEA.webp" alt="System default limit" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMzYiIGhlaWdodD0iODkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>The system default limit.</p><p>Setting it to 0 means files will not be deleted proactively.</p><h3 id="postscript"><span class="me-2">Postscript</span><a href="#postscript" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Initially, I underestimated the difficulty of this feature, thinking it could be handled quickly; however, I faced many challenges and spent an additional two weeks addressing data storage issues. Nevertheless, I now have a thorough understanding of the entire Resource Loader operation mechanism, GCD, and Data.</p><h3 id="references"><span class="me-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Finally, here are some reference materials for researching how to implement this:</p><ol><li><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/" target="_blank">Design and Implementation of iOS AVPlayer Video Caching</a> - Discusses the principles only.<li><a href="https://caisanze.com/post/swift-avplayer/" target="_blank">Implementing Audio and Video Playback and Caching Based on AVPlayer, Supporting Synchronized Video Output</a> [ <a href="https://github.com/eroscai/SZAVPlayer" target="_blank">SZAVPlayer</a> ] - Includes code (very complete but complex).<li><a href="https://github.com/neekeetab/CachingPlayerItem/blob/7d998b8561693cf51077f0891ed240e92bec415e/CachingPlayerItem.swift" target="_blank">CachingPlayerItem</a> - (Simple implementation, easier to understand but incomplete).<li><a href="https://www.jianshu.com/p/28157247d6a7" target="_blank">Possibly the best AVPlayer audio and video caching solution AVAssetResourceLoaderDelegate</a>.<li><a href="https://sshiqiao.github.io/document/douyin-swift.html#1" target="_blank">Swift version of Douyin</a> [ <a href="https://github.com/sshiqiao/douyin-ios-swift" target="_blank">Github</a> ] - (An interesting project that replicates the Douyin app; it also uses Resource Loader).<li><a href="/posts/zrealm-dev/en/exploring-ios-hls-cache-implementation-methods-d796bf8e661e/">Exploring iOS HLS Cache Implementation Methods</a>.</ol><h3 id="extensions"><span class="me-2">Extensions</span><a href="#extensions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="https://github.com/dminoror/DLCachePlayer" target="_blank">DLCachePlayer</a> (Objective-C version).</ul><p>If you have any questions or suggestions, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><p>```</p><hr /><p>This article was first published on Medium ➡️ <a href="https://medium.com/p/6ce488898003" target="_blank"><strong>Click Here</strong></a></p><p>Automatically converted and synchronized using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> and <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a>.</p><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2021-01-31-6ce488898003.md" target="_blank">Improve this page on Github.</a></p><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 5,099 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-15 | 4,896 Views on <a href="https://medium.com/p/6ce488898003" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios/" class="post-tag no-text-decoration" >ios</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/avplayer/" class="post-tag no-text-decoration" >avplayer</a> <a href="/tags/music-player-app/" class="post-tag no-text-decoration" >music-player-app</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Complete%20Guide%20to%20Implementing%20Local%20Cache%20Functionality%20with%20AVPlayer%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fcomplete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Complete%20Guide%20to%20Implementing%20Local%20Cache%20Functionality%20with%20AVPlayer%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fcomplete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fcomplete-guide-to-implementing-local-cache-functionality-with-avplayer-6ce488898003%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/z-travel-diaries/en/travel-diary-8-days-and-7-nights-in-busan-south-korea-2025-8ace34a1a3d8/">Travel Diary: 8 Days and 7 Nights in Busan, South Korea 2025</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2025-%E9%9F%93%E5%9C%8B%E9%87%9C%E5%B1%B1-8-%E5%A4%A9-7-%E5%A4%9C%E8%87%AA%E7%94%B1%E8%A1%8C-8ace34a1a3d8/">遊記 2025 韓國釜山 8 天 7 夜自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-9-11-%E5%90%8D%E5%8F%A4%E5%B1%8B%E4%B8%80%E6%97%A5%E5%BF%AB%E9%96%83%E8%87%AA%E7%94%B1%E8%A1%8C-7b8a0563c157/">遊記 9/11 名古屋一日快閃自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2023-%E4%B9%9D%E5%B7%9E-10-%E6%97%A5%E8%87%AA%E7%94%B1%E8%A1%8C%E7%8D%A8%E6%97%85-d78e0b15a08a/">遊記 2023 九州 10 日自由行獨旅</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%81%8A%E8%A8%98-2023-%E4%BA%AC%E9%98%AA%E7%A5%9E-8-%E6%97%A5%E8%87%AA%E7%94%B1%E8%A1%8C-76d66c2e34af/">遊記 2023 京阪神 8 日自由行</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/avplayer-%E5%AF%A6%E8%B8%90%E6%9C%AC%E5%9C%B0-cache-%E5%8A%9F%E8%83%BD%E5%A4%A7%E5%85%A8-6ce488898003/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1612089702" data-df="ll" > Jan 31, 2021 </time><h4 class="pt-0 my-2">AVPlayer 實踐本地 Cache 功能大全</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset 實作 AVAssetResourceLoaderDelegate</p></div></div></a></article><article class="col"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E5%AF%A6%E6%88%B0-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer 邊播邊 Cache 實戰</h4><div class="text-muted"><p>AVPlayer/AVQueuePlayer with AVURLAsset 實作 AVAssetResourceLoaderDelegate 達成邊播放音樂/影片邊緩存</p></div></div></a></article><article class="col"> <a href="/posts/en/avplayer-streaming-and-caching-practical-guide-ee47f8f1e2d2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1609856872" data-df="ll" > Jan 5, 2021 </time><h4 class="pt-0 my-2">AVPlayer Streaming and Caching Practical Guide</h4><div class="text-muted"><p>Implementing AVPlayer/AVQueuePlayer with AVURLAsset and AVAssetResourceLoaderDelegate to achieve music/video streaming while caching.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/avplayer-%E9%82%8A%E6%92%AD%E9%82%8A-cache-%E5%AF%A6%E6%88%B0-ee47f8f1e2d2/" class="btn btn-outline-primary" aria-label="Older" ><p>AVPlayer 邊播邊 Cache 實戰</p></a> <a href="/posts/zrealm-dev/avplayer-%E5%AF%A6%E8%B8%90%E6%9C%AC%E5%9C%B0-cache-%E5%8A%9F%E8%83%BD%E5%A4%A7%E5%85%A8-6ce488898003/" class="btn btn-outline-primary" aria-label="Newer" ><p>AVPlayer 實踐本地 Cache 功能大全</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> All Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-16 11:02:43 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
