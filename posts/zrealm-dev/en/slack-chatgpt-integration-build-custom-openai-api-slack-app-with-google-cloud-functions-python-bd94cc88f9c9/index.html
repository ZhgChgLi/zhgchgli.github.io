<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Slack &amp; ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions &amp; Python" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently." /><meta property="og:description" content="Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently." /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-02-16T21:17:01+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" /><meta property="twitter:title" content="Slack &amp; ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions &amp; Python" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2024-02-18T12:09:17+08:00","datePublished":"2024-02-16T21:17:01+08:00","description":"Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently.","headline":"Slack &amp; ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions &amp; Python","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"}</script><title>Slack & ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions & Python | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/en/slack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan üáπüáº who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,049+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Slack & ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions & Python</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Slack & ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions & Python</h1><p class="post-desc fw-light mb-4">Develop a tailored Slack app using ChatGPT OpenAI API, Google Cloud Functions, and Python to automate workflows and enhance team communication efficiently.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1708089421" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 16, 2024 </time> </span> <span> Updated <time data-ts="1708229357" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 18, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link preview-img blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="9050 words" > <em>50 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Slack & ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions & Python</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters üîñ</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Slack & ChatGPT IntegrationÔΩúBuild Custom OpenAI API Slack App with Google Cloud Functions & Python</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><strong>ÁÇπÂáªËøôÈáå</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†ÁÆÄ‰Ωì‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/"><strong>ÈªûÊìäÈÄôË£°</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†Ê≠£È´î‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-info"><p>This post was translated with AI assistance ‚Äî let me know if anything sounds off!</p></blockquote><h4 id="zhgchgli-table-of-contents">Table of Contents</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>Slack & ChatGPT Integration <a href="#slack--chatgpt-integration">#</a></summary><ul><li><a href="#background">Background</a></li><li><a href="#chrome-extension-sidebargpt">[Chrome Extension] SidebarGPT</a></li><li><a href="#chrome-extension-openai-translator">[Chrome Extension] OpenAI Translator</a></li><li><a href="#self-hosted-librechat">[Self-hosted] LibreChat</a></li></ul></details></li><li class="has-children"><details><summary>Slack App <a href="#slack-app">#</a></summary><ul><li><a href="#slack-apps">Slack Apps</a></li></ul></details></li><li class="has-children"><details><summary>Implementing ChatGPT OpenAI API for Slack App by Yourself <a href="#implementing-chatgpt-openai-api-for-slack-app-by-yourself">#</a></summary><ul><li><a href="#final-result-image">Final Result Image</a></li></ul></details></li><li class="has-children"><details><summary>Step 1. Create a Slack App <a href="#step-1-create-a-slack-app">#</a></summary><ul><li><a href="#enable-event-subscriptions-feature">Enable Event Subscriptions feature</a></li><li><a href="#add-google-cloud-functions">Add Google Cloud Functions</a></li></ul></details></li><li class="has-children"><details><summary>Step 2. Improve OpenAI API and Slack App Integration (Direct Messages) <a href="#step-2-improve-openai-api-and-slack-app-integration-direct-messages">#</a></summary><ul><li><a href="#handling-direct-message-im-event--integrating-openai-api-response">Handling Direct Message (IM) Event & Integrating OpenAI API Response</a></li><li><a href="#add-interrupt-stream-response-feature-to-save-tokens">Add Interrupt Stream Response Feature to Save Tokens</a></li><li><a href="#add-context-feature-within-the-same-discussion-thread-threads">Add Context Feature Within the Same Discussion Thread (Threads)</a></li></ul></details></li><li><a href="#done">Done!</a></li><li class="has-children"><details><summary>Supplement <a href="#supplement">#</a></summary><ul><li><a href="#marking-bot-answers-outside-of-11-messages">Marking bot answers outside of 1:1 messages</a></li><li><a href="#deleting-messages-sent-in-slack-app">Deleting Messages Sent in Slack App</a></li><li><a href="#slack-app-not-responding">Slack App Not Responding</a></li><li><a href="#cloud-functions-public-url-is-not-secure-enough">Cloud Functions Public URL Is Not Secure Enough</a></li></ul></details></li><li class="has-children"><details><summary>Cloud Functions Related Issues <a href="#cloud-functions-related-issues">#</a></summary><ul><li><a href="#billing-method">Billing Method</a></li><li><a href="#slack-app-responds-too-slowly-or-times-out-too-long">Slack App Responds Too Slowly or Times Out Too Long</a></li><li><a href="#development-phase-testing--debug">Development Phase Testing & Debug</a></li><li><a href="#build-failed-what-to-do-if-the-code-is-missing">Build failed, what to do if the code is missing?</a></li><li><a href="#view-runtime-print-logs">View runtime print Logs</a></li></ul></details></li><li class="has-children"><details><summary>Final Code (Python 3.8) <a href="#final-code-python-38">#</a></summary><ul><li><a href="#cloud-functions">Cloud Functions</a></li><li><a href="#slack-app-setup">Slack App Setup</a></li></ul></details></li><li><a href="#commercial-time">Commercial Time</a></li></ul></nav><hr /><h3 id="slack--chatgpt-integration"><span class="me-2">Slack &amp; ChatGPT Integration</span><a href="#slack--chatgpt-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Build Your Own ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p><h4 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Recently, our team has been promoting the use of Generative AI to improve work efficiency. Initially, we aim to implement an AI Assistant (ChatGPT functionality) to reduce the time spent on daily data queries, organizing tedious data, and manual data processing, thereby enhancing productivity. We hope that engineers, designers, PMs, and marketers can all use it freely.</p><p>The simplest way is to directly purchase the ChatGPT Team plan, which costs $25 per seat per year. However, since the usage frequency and volume are uncertain, and there is a desire to integrate with more external collaboration and development workflows, we chose to use the OpenAI API instead, then package and integrate it through other services for team members.</p><p>OpenAI API Key can be generated from <a href="https://platform.openai.com/api-keys" target="_blank">this page</a>. The Key is not tied to a specific Model version; you need to specify the Model version when using it, which determines the corresponding token cost.</p><blockquote><p>We need a service that can set the OpenAI API Key by itself and use that Key for ChatGPT-like interactions.</p></blockquote><blockquote><p>Whether it‚Äôs a Chrome Extension or a Slack App, it‚Äôs quite hard to find services that allow users to set their own OpenAI API Key. Most services sell their own subscription plans, so letting users customize the API Key means they can‚Äôt make money and are essentially doing charity.</p></blockquote><h4 id="chrome-extension-sidebargpt"><span class="me-2">[Chrome Extension] <a href="https://chromewebstore.google.com/detail/chatgpt-assistant-for-chr/mejjgaogggabifjfjdbnobinfibaamla" target="_blank">SidebarGPT</a></span><a href="#chrome-extension-sidebargpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After installation, go to Settings -&gt; General -&gt; enter your OpenAI API Key.</p><p><a href="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*E9SO72c7ZEBfhBMBNT-Erw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijc2OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>You can directly open the chat interface from the browser toolbar or side icon and use it directly:</p><p><a href="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Et1rGixc8pihUiSn8kqSqA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjcwMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="chrome-extension-openai-translator"><span class="me-2">[Chrome Extension] <a href="https://chrome.google.com/webstore/detail/ogjibjphoadhljaoicdnjnmgokohngcc" target="_blank">OpenAI Translator</a></span><a href="#chrome-extension-openai-translator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If you only need translation, you can use this. It allows you to customize the OpenAI API Key for translation.</p><p><a href="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cMB9uuyBRPKtdE_7g6Yqiw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzQiIGhlaWdodD0iMTI2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*wKfD9BQYJuNXrUl1mr_GvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MzkiIGhlaWdodD0iMzc2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Additionally, it is an <a href="https://github.com/openai-translator/openai-translator" target="_blank">open-source project</a> and also offers desktop applications for macOS and Windows:</p><p><a href="https://github.com/openai-translator/openai-translator" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/609416865/2fee2046-51a5-407c-9641-851e5032ec63" alt="" loading="lazy"></a></p><p>The advantage of Chrome Extensions is that they are fast, simple, and convenient‚Äîjust install and use. The downside is that the API Key must be shared with all members, making it hard to control leaks. Additionally, using third-party services makes it difficult to ensure everyone‚Äôs data security.</p><h4 id="self-hosted-librechat"><span class="me-2">[Self-hosted] <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a></span><a href="#self-hosted-librechat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/danny-avila/LibreChat" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/102ca4ff10ae06f9a1fa9f7126e73ef92a641310dd20377ac942cdc7132b79f9/danny-avila/LibreChat" alt="" loading="lazy"></a></p><p>The OpenAI API Chat wrapper service recommended by colleagues in the R&amp;D department offers authentication and an open-source project that nearly replicates the ChatGPT interface, with features more powerful than ChatGPT.</p><p><a href="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*8Y_GtNjjuz_FS-CDEwIQzA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Just the project, Docker installed, .env configured, and Docker service started are needed to access and use it directly through the website.</p><blockquote><p><strong>Tried it out and it‚Äôs flawless, basically a local version of ChatGPT; the only downside is that it requires server deployment; if there are no other concerns, you can directly use this open-source project.</strong></p></blockquote><h3 id="slack-app"><span class="me-2">Slack App</span><a href="#slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Actually, the <a href="https://github.com/danny-avila/LibreChat" target="_blank">LibreChat</a> service works once it‚Äôs deployed on a server, but I thought it would be more convenient if it could be integrated into everyday tools. Plus, the company server has strict permission settings, so running the service freely is difficult.</p><p>At that time, I didn‚Äôt think much and assumed there would be many Slack apps integrating OpenAI API services, so I just needed to find one and set it up; I didn‚Äôt expect it to be that complicated.</p><p>Google search only found one official Slack x OpenAI press release from March 2023: ‚Äú<a href="https://slack.com/intl/zh-tw/blog/news/why-we-built-the-chatgpt-app-for-slack" target="_blank">Why we built the ChatGPT app for Slack</a>‚Äù and some beta images:</p><p><a href="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*M4fXzn1PIEBamjLMDckcSA.gif" alt="&lt;https://www.salesforce.com/news/stories/chatgpt-app-for-slack/&gt;{:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAwIiBoZWlnaHQ9IjU2MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://www.salesforce.com/news/stories/chatgpt-app-for-slack/" target="_blank">https://www.salesforce.com/news/stories/chatgpt-app-for-slack/</a></p><p>It seems very feature-rich and can greatly improve work efficiency. However, as of January 2024, there is no news of a release. The <a href="http://openai.com/waitlist/slack" target="_blank">Beta registration link</a> provided at the end of the article is also no longer valid, with no further updates for now. (Or is Microsoft planning to support Teams first?)</p><p><strong>[2024/02/14 Update]:</strong></p><ul><li>See <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack official news</a>; it seems the integration with ChatGPT (OpenAI) has been abandoned or merged into <a href="https://slack.com/intl/zh-tw/blog/news/slack-ai-has-arrived" target="_blank">Slack AI</a>.</ul><h4 id="slack-apps"><span class="me-2">Slack Apps</span><a href="#slack-apps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*gjkHBFeFVkCQ77lhTHM_Qg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjkiIGhlaWdodD0iODU2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Since there is no official app, I turned to search for third-party developer apps. I tried several but ran into dead ends; not only were there few suitable apps, but none offered a custom key feature. Each one was designed to sell services and make money.</p><h3 id="implementing-chatgpt-openai-api-for-slack-app-by-yourself"><span class="me-2">Implementing ChatGPT OpenAI API for Slack App by Yourself</span><a href="#implementing-chatgpt-openai-api-for-slack-app-by-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I had some experience developing Slack apps before, so I decided to give it a try myself.</p><blockquote><p><strong>‚ö†Ô∏èDisclaimer‚ö†Ô∏è</strong></p></blockquote><blockquote><p>This article uses connecting to the OpenAI API as an example to demonstrate how to create a Slack App and quickly use Google Cloud Functions to meet the requirements. Slack Apps have many possible uses, so feel free to explore and customize.</p></blockquote><blockquote><p>‚ö†Ô∏è‚ö†Ô∏è Google Cloud Functions, a Function as a Service (FaaS), offers advantages such as convenience, speed, free usage tiers, easy deployment after coding, and automatic scaling. However, the service environment is controlled by GCP. If the function is not called for a long time, it goes into a sleep state. When called again, it undergoes a <a href="https://cloud.google.com/functions/docs/configuring/recommender?hl=en" target="_blank">Cold Start</a>, which requires longer response time. It is also more difficult to have multiple services interact with each other.</p></blockquote><blockquote><p>For more comprehensive or high-demand usage, it is still recommended to set up your own VM (App Engine) to host the server and run the service.</p></blockquote><h4 id="final-result-image"><span class="me-2">Final Result Image</span><a href="#final-result-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*af90HtXO_f9qLReKZ85iDg.gif" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDIiIGhlaWdodD0iNDg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>Complete Cloud Functions Python code and Slack App settings are provided at the end of the article. For those who don‚Äôt want to go through it step by step, feel free to check them out quickly.</p></blockquote><h3 id="step-1-create-a-slack-app"><span class="me-2">Step 1. Create a Slack App</span><a href="#step-1-create-a-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Go to <a href="https://api.slack.com/apps" target="_blank">Slack App</a>:</p><p><a href="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*m4gmfX6XuNczSRAVwzvo_g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjYiIGhlaWdodD0iNTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Click ‚ÄúCreate New App‚Äù</p><p><a href="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*bORUew6Y7DEN9QMFqqqOQw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTAiIGhlaWdodD0iNDExIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Choose ‚ÄúFrom scratch‚Äù</p><p><a href="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*U_kB4YxWf0X0RnSyD9ZIYw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTEiIGhlaWdodD0iNDg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Enter the ‚ÄúApp Name‚Äù and select the Workspace to add.</p><p><a href="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*RNjigMtA1XJHxq4NAv3pKg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5ODIiIGhlaWdodD0iNzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>After creation, go to ‚ÄúOAuth &amp; Permissions‚Äù to add the required permissions for the Bot.</p><p><a href="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*rLHaXjMXifaCvHSKGeWaOg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNjMxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Scroll down to the ‚ÄúScopes‚Äù section, click ‚ÄúAdd an OAuth Scope,‚Äù and search to add the following permissions:</p><ul><li><p>chat:write</p><li><p>im:history</p><li><p>im:read</p><li><p>im:write</p></ul><p>After adding Bot permissions, click ‚ÄúInstall App‚Äù on the left -&gt; ‚ÄúInstall to Workspace‚Äù</p><p><a href="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*PlvdPG-pcNPtP48pGSP1Tg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA5IiBoZWlnaHQ9IjMzNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>If the Slack App adds new permissions in the future, you will need to click ‚ÄúReinstall‚Äù again for them to take effect.</p><p><a href="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*EZTaUMwyTsWA7WmUab8rbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MzMiIGhlaWdodD0iODI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p><strong>But rest assured, the Bot Token will not change due to reinstallation.</strong></p></blockquote><p>After setting the Slack Bot Token permissions, go to ‚ÄúApp Home‚Äù:</p><p><a href="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7mBKY188fkfTpGNOLtfByQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTkiIGhlaWdodD0iNDkzIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Scroll down to the ‚ÄúShow Tabs‚Äù section, enable the ‚ÄúMessages Tab‚Äù and ‚ÄúAllow users to send Slash commands and messages from the messages tab‚Äù (if this is not checked, you still can‚Äôt send messages, and it will show ‚ÄúSending messages to this app has been turned off.‚Äù).</p><p><a href="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dEOSGTBN4v5AuWncYNqBEA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDgiIGhlaWdodD0iNTU0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Back in the Slack Workspace, press ‚ÄúCommand+R‚Äù to refresh the screen and see the newly created Slack App and message input box:</p><p><a href="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tjv1snWJ1IOsEvSTt4KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg2IiBoZWlnaHQ9Ijk0MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>At this point, sending messages to the app has no functionality.</p><h4 id="enable-event-subscriptions-feature"><span class="me-2">Enable Event Subscriptions feature</span><a href="#enable-event-subscriptions-feature" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*-DpIEDSaTT2yP4LXw3ZBbQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjEiIGhlaWdodD0iNzc4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Next, we need to enable the event subscription feature of the Slack App, which will send an API call to the specified URL when a designated event occurs.</p><h4 id="add-google-cloud-functions"><span class="me-2">Add Google Cloud Functions</span><a href="#add-google-cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the Request URL part, <a href="https://console.cloud.google.com/functions/list" target="_blank">Google Cloud Functions</a> comes into play.</p><p>After setting up the project and billing information, click ‚ÄúCreate Function‚Äù</p><p><a href="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dBYo5ylUh9dhJF_1YG9RBg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjI4NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*p4AmWUsLvovFVjEd7JlxuA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDgiIGhlaWdodD0iODM2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Function name: Enter the project name. Authentication: Select ‚ÄúAllow unauthenticated invocations,‚Äù which means anyone with the URL can access it.</p><blockquote><p>If you cannot create a Function or change Authentication, it means your GCP account lacks full Google Cloud Functions permissions. You need to ask your organization administrator to add the Cloud Functions Admin role to your existing identity to use these features.</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*LOrzMQqDFhLE3s64sS2gKQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTUyIiBoZWlnaHQ9Ijc4MyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Runtime: Python 3.8 or higher</p><p><code class="language-plaintext highlighter-rouge">main.py</code> :</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># You can simply use print to log runtime information, which can be viewed in Logs
</span>    <span class="c1"># For advanced logging levels, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># Due to FAAS (Cloud Functions) limitations, if the service is not called for a long time, the next call triggers a cold start,
</span>    <span class="c1"># which might not respond within Slack's 3-second requirement
</span>    <span class="c1"># Plus, OpenAI API requests and responses take some time (depending on response length, it may take nearly 1 minute)
</span>    <span class="c1"># If Slack does not receive a response within the time limit, it considers the request lost and retries
</span>    <span class="c1"># This causes duplicate requests and responses, so we can set X-Slack-No-Retry: 1 in Response Headers to tell Slack not to retry even if no timely response is received
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Ignore Slack Retry requests...
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> Enter the following dependencies:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>functions-framework==3.*
requests==2.31.0
openai==1.9.0
</pre></table></code></div></div><p>Currently, there are no features yet. It only allows the Slack App to enable verification through Event Subscriptions. You can directly click ‚ÄúDeploy‚Äù to complete the initial deployment.</p><blockquote><p>‚ö†Ô∏èIf you are not familiar with the Cloud Functions editor, you can scroll down to the bottom of the article to see additional information.</p></blockquote><p><strong>After the deployment is complete (green checkmark)</strong>, copy the Cloud Functions URL:</p><p><a href="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qZCQYGuzzL0Skz6K7RV1Ow.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDMyIiBoZWlnaHQ9IjI3NSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Paste the Request URL back into the Slack App Enable Events.</p><p><a href="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*NyL0Ja9yxzisMZg0QyHfoA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iMzAyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>If there are no issues, ‚ÄúVerified‚Äù will appear to complete the verification.</p><p>This part handles receiving verification requests sent from Slack:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jhj5dZrVaK7ZwHHjRyZWjbDl"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"challenge"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"url_verification"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Respond to the content in the <code class="language-plaintext highlighter-rouge">challenge</code> field to pass the verification.</p><p><a href="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*qgUQe3wIjCxDw8JAYR1dkg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MzciIGhlaWdodD0iODYxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>After successful activation, scroll down to the ‚ÄúSubscribe to bot events‚Äù section and click ‚ÄúAdd Bot User Event‚Äù to add the ‚Äúmessage.im‚Äù permission.</p><p><a href="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*T-9-xrfQvWTEJArALV3QlA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDQiIGhlaWdodD0iMTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>After granting full permissions, click the ‚Äúreinstall your app‚Äù link above to reinstall the Slack App to your Workspace. This completes the Slack App setup.</p><p>You can also go to ‚ÄúApp Home‚Äù or ‚ÄúBasic Information‚Äù to customize the Slack App‚Äôs name and avatar.</p><p><a href="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*9qsVF__3nSjxLJww6PN44g.webp" alt="Basic Information" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjUiIGhlaWdodD0iNTQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Basic Information</p><h3 id="step-2-improve-openai-api-and-slack-app-integration-direct-messages"><span class="me-2">Step 2. Improve OpenAI API and Slack App Integration (Direct Messages)</span><a href="#step-2-improve-openai-api-and-slack-app-integration-direct-messages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, we need to obtain the required <code class="language-plaintext highlighter-rouge">OPENAI API KEY</code> and <code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">OPENAI API KEY</code>: <a href="https://platform.openai.com/account/api-keys" target="_blank">OpenAI API key page</a> .</ul><p><a href="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DKOm3yZVA1K_EJ3AUeCDsA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTcwIiBoZWlnaHQ9IjQwNiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><code class="language-plaintext highlighter-rouge">Bot User OAuth Token</code> Ôºö <a href="https://api.slack.com/apps/" target="_blank">OAuth Tokens for Your Workspace</a></ul><p><a href="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*mLoxaBPpa_IUP_qOaFZhQg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTEiIGhlaWdodD0iNzE4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="handling-direct-message-im-event--integrating-openai-api-response"><span class="me-2">Handling Direct Message (IM) Event &amp; Integrating OpenAI API Response</span><a href="#handling-direct-message-im-event--integrating-openai-api-response" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>When a user sends a message with the Slack App, the following Event JSON Payload is received:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"context_enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="nl">"api_app_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"client_msg_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"blocks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"block_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"orfng"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rich_text_section"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"elements"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="p">{</span><span class="w">
                </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Hello"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"team"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"event_ts"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1707920753.115429"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"channel_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"im"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event_callback"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1707920753</span><span class="p">,</span><span class="w">
  </span><span class="nl">"authorizations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"enterprise_id"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nl">"team_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"XXX"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_bot"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"is_enterprise_install"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"is_ext_shared_channel"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"event_context"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4-XXX"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Based on the above Json Payload, we can complete the integration from Slack message to OpenAI API and then back to replying to the Slack message:</p><p><strong>Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> Ôºö</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># You can simply use print to record runtime logs, viewable in Logs
</span>    <span class="c1"># For advanced logging levels, see: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">request_json</span><span class="p">)</span>

    <span class="c1"># Due to FAAS (Cloud Functions) constraints, if the service is idle for too long, it enters cold start,
</span>    <span class="c1"># which may prevent responding within Slack's 3-second limit.
</span>    <span class="c1"># Also, OpenAI API requests take time to complete (up to nearly 1 minute depending on response length).
</span>    <span class="c1"># Slack considers the request lost if no response is received within the limit and retries.
</span>    <span class="c1"># This causes duplicate requests and responses, so we set X-Slack-No-Retry: 1 in the response headers
</span>    <span class="c1"># to tell Slack not to retry even if no timely response is received.
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Ignore Slack retry requests...
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># If the event source is the app itself and app ID matches Slack App ID,
</span>        <span class="c1"># ignore to avoid infinite loops Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, e.g., message (related to messages), app_mention (being mentioned)...
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType, e.g., message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages have no SubType
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># SubTypes are message edits, deletions, replies...
</span>            <span class="c1"># Ignore these
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Sender of the event message
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Channel of the event message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Content of the event message
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Timestamp (ID) of the event message
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Parent message timestamp (ID) of the event message's thread
</span>            <span class="c1"># Only present for messages inside threads
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I only understand Traditional Chinese (Taiwan) and English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I do not understand Simplified Chinese.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak Chinese, I reply in Traditional Chinese (Taiwan) and use common Taiwanese phrases.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak English, I reply in English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not respond with greetings or small talk.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">There should be a space between Chinese and English. There should also be a space between Chinese characters and any other language characters including numbers and emoji.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If you don</span><span class="sh">'</span><span class="s">t know the answer or your knowledge is outdated, please search online before replying.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD, if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">Generating response...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (partial response)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># Update message every 0.8 seconds to avoid frequent Slack Update API calls that may fail or waste Cloud Functions calls
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Error occurred]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack for testing:</strong></p><p><a href="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xENCHCINYpPIQKvJeycdaA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjU2OSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>You can now perform ChatGPT-like Q&amp;A using the OpenAI API.</p><h4 id="add-interrupt-stream-response-feature-to-save-tokens"><span class="me-2">Add Interrupt Stream Response Feature to Save Tokens</span><a href="#add-interrupt-stream-response-feature-to-save-tokens" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>There are many ways to implement this. For example, if the user sends a new message in the same thread before the previous response is finished, the previous response can be interrupted. Alternatively, clicking the message can trigger a shortcut to interrupt the response.</p><p><a href="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*IT671oCwfUP3yqVbNtedSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MDEiIGhlaWdodD0iNDUxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>This article uses the addition of the ‚ÄúMessage Interrupt‚Äù Shortcut as an example.</p><p>No matter which interruption method is used, the core principle is the same because we do not have a database to store generated messages or message status information. Therefore, the implementation relies on Slack message <a href="https://api.slack.com/metadata/using" target="_blank"><strong>metadata fields</strong></a> (which can store custom information within specific messages).</p><p>When using the <a href="https://api.slack.com/methods/chat.update" target="_blank">chat.update</a> API Endpoint, a successful call returns the current message text and metadata. Therefore, in the above OpenAI API Stream -&gt; Slack Update Message code, we added a check to see if the metadata in the update response contains a ‚Äústop‚Äù marker. If it does, the OpenAI Stream Response is interrupted.</p><p><strong>First, you need to add a Slack App message Shortcut</strong></p><p>Go to the <a href="https://api.slack.com/apps" target="_blank">Slack App</a> management interface, find the ‚ÄúInteractivity &amp; Shortcuts‚Äù section, click to enable it, and use the same Cloud Functions URL.</p><p><a href="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*DCUyec3HYlrcIrZoSDCoMw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5OTQiIGhlaWdodD0iNzQ3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Click ‚ÄúCreate New Shortcut‚Äù to add a new message Shortcut.</p><p><a href="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*ybhq_ceaXLFEUsLFyW7sJg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NTAiIGhlaWdodD0iNTk0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Select ‚ÄúOn messages‚Äù.</p><p><a href="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HDkOjV2GcJw_ETTVqV0ErQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTAwIiBoZWlnaHQ9IjUyNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><ul><li><p>Name Action Title: <code class="language-plaintext highlighter-rouge">Stop OpenAI API from Generating Response</code></p><li><p>Short Description: <code class="language-plaintext highlighter-rouge">Stop OpenAI API from generating responses</code></p><li><p>Callback ID: <code class="language-plaintext highlighter-rouge">abort_openai_api</code> (Program identifier, customizable)</p></ul><p>After clicking ‚ÄúCreate‚Äù to complete, remember to click ‚ÄúSave Changes‚Äù at the bottom right to save the settings.</p><p><a href="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7ti_5hZOoyY6uVp5kWDl3A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMTYiIGhlaWdodD0iNTkiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>Click ‚Äúreinstall your app‚Äù above again to take effect.</p><p><a href="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*dUE54HgASm30xq2ILW3ioQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjQ0NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Back in Slack, clicking the ‚Äú‚Ä¶‚Äù at the top right of a message will show the ‚ÄúStop OpenAI API Response‚Äù shortcut (clicking it at this time has no effect).</p><p><a href="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HjqrkPP1op1Kz-BQuO920Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzEiIGhlaWdodD0iMzg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>When the user taps the</strong> Shortcut <strong>on the message, an Event Json Payload will be sent:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="s">"type"</span><span class="p">:</span> <span class="s">"message_action"</span><span class="p">,</span>
  <span class="s">"token"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"action_ts"</span><span class="p">:</span> <span class="s">"1706188005.387646"</span><span class="p">,</span>
  <span class="s">"team"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"domain"</span><span class="p">:</span> <span class="s">"XXXXXX-XXXXXX"</span>
  <span class="p">},</span>
  <span class="s">"user"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"username"</span><span class="p">:</span> <span class="s">"zhgchgli"</span><span class="p">,</span>
    <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"zhgchgli"</span>
  <span class="p">},</span>
  <span class="s">"channel"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"name"</span><span class="p">:</span> <span class="s">"directmessage"</span>
  <span class="p">},</span>
  <span class="s">"is_enterprise_install"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s">"enterprise"</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
  <span class="s">"callback_id"</span><span class="p">:</span> <span class="s">"abort_openai_api"</span><span class="p">,</span>
  <span class="s">"trigger_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
  <span class="s">"response_url"</span><span class="p">:</span> <span class="s">"https://hooks.slack.com/app/XXXXXX/XXXXXX/XXXXXX"</span><span class="p">,</span>
  <span class="s">"message_ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
  <span class="s">"message"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">"bot_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"type"</span><span class="p">:</span> <span class="s">"message"</span><span class="p">,</span>
    <span class="s">"text"</span><span class="p">:</span> <span class="s">"The English translation of È´òÈ∫óËèúÂåÖ is </span><span class="se">\"</span><span class="s">cabbage wrap.</span><span class="se">\"</span><span class="s"> If you use it as a dish name, sometimes the name specifies the contents, such as </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s"> or </span><span class="se">\"</span><span class="s">vegetable cabbage wrap.</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span>
    <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706178957.161109"</span><span class="p">,</span>
    <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"blocks"</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text"</span><span class="p">,</span>
        <span class="s">"block_id"</span><span class="p">:</span> <span class="s">"eKgaG"</span><span class="p">,</span>
        <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"rich_text_section"</span><span class="p">,</span>
            <span class="s">"elements"</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"text"</span><span class="p">,</span>
                <span class="s">"text"</span><span class="p">:</span> <span class="s">"The English translation of È´òÈ∫óËèúÂåÖ is </span><span class="se">\"</span><span class="s">cabbage wrap.</span><span class="se">\"</span><span class="s"> If you use it as a dish name, sometimes the name specifies the contents, such as </span><span class="se">\"</span><span class="s">pork cabbage wrap</span><span class="se">\"</span><span class="s"> or </span><span class="se">\"</span><span class="s">vegetable cabbage wrap.</span><span class="se">\"</span><span class="s">"</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"team"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
    <span class="s">"bot_profile"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"deleted"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="s">"name"</span><span class="p">:</span> <span class="s">"Rick C-137"</span><span class="p">,</span>
      <span class="s">"updated"</span><span class="p">:</span> <span class="mi">1706001605</span><span class="p">,</span>
      <span class="s">"app_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"icons"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"image_36"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_36.png"</span><span class="p">,</span>
        <span class="s">"image_48"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_48.png"</span><span class="p">,</span>
        <span class="s">"image_72"</span><span class="p">:</span> <span class="s">"https://avatars.slack-edge.com/2024-01-23/6517244582244_0c708dfa3f893c72d4c2_72.png"</span>
      <span class="p">},</span>
      <span class="s">"team_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
    <span class="p">},</span>
    <span class="s">"edited"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">"user"</span><span class="p">:</span> <span class="s">"XXXXXX"</span><span class="p">,</span>
      <span class="s">"ts"</span><span class="p">:</span> <span class="s">"1706187989.000000"</span>
    <span class="p">},</span>
    <span class="s">"thread_ts"</span><span class="p">:</span> <span class="s">"1706178832.102439"</span><span class="p">,</span>
    <span class="s">"parent_user_id"</span><span class="p">:</span> <span class="s">"XXXXXX"</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Improve Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code>:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># The OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut events come from the post payload field
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># You can simply use print to log runtime logs, viewable in Logs
</span>    <span class="c1"># For advanced logging levels, refer to: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Due to FAAS (Cloud Functions) limitations, if the service is idle for too long, the next call triggers a cold start,
</span>    <span class="c1"># which may fail to respond within Slack's 3-second limit.
</span>    <span class="c1"># Also, OpenAI API requests take time to complete (up to nearly 1 minute depending on response length).
</span>    <span class="c1"># Slack considers requests lost if no response within the limit and retries the request.
</span>    <span class="c1"># This causes duplicate requests and responses, so we set 'X-Slack-No-Retry: 1' in response headers to tell Slack not to retry even if no timely response.
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Ignore Slack retry requests...
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="c1"># If the event source is the app itself and app ID matches Slack App ID, ignore to avoid infinite loops Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, e.g., message (related to messages), app_mention (mentioned)...
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType, e.g., message_changed (edited message), message_deleted (deleted message)...
</span>        <span class="c1"># New messages have no SubType
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># SubTypes are message edits, deletions, replies...
</span>            <span class="c1"># Ignore and do not process
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Event message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event message content
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Event message TS (message ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Event thread parent message TS (message ID)
</span>            <span class="c1"># Only new messages in threads have this data
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># If it's a message shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">payloadType</span><span class="p">)</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If it's the shortcut to stop OpenAI API response generation
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">Successfully stopped OpenAI API response generation!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I only understand Traditional Chinese (Taiwan) and English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I do not understand Simplified Chinese.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak Chinese, I will respond in Traditional Chinese used in Taiwan.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak English, I will respond in English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not respond with greetings.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">There should be a space between Chinese and English. There should be a space between Chinese text and any other language characters including numbers and emoji.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If you don</span><span class="sh">'</span><span class="s">t know the answer or your knowledge is outdated, please search online before answering.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD, if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">Generating response...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (chunked response)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># Update message every 0.8 seconds to avoid frequent Slack Update API calls causing failures or wasting Cloud Functions requests
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># If message has metadata &amp; metadata event_type == aborted, it means user marked this response as terminated
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Terminated]*</span><span class="sh">"</span>
                <span class="c1"># Message was deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Error occurred]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Notice</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack to test:</strong></p><p><a href="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*pL343-5zxlJY44gG1qlUDA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NDUiIGhlaWdodD0iMzgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*VbWl3IDpgcuT8wKIC_IzsQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjUwNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Success! When we complete the <code class="language-plaintext highlighter-rouge">Stop OpenAI API</code> Shortcut, the ongoing response will be terminated and respond with <strong>[Terminated]</strong>.</p><blockquote><p>Similarly, using the same principle, you can create a Shortcut to delete messages, implementing the deletion of messages sent by the Slack App.</p></blockquote><h4 id="add-context-feature-within-the-same-discussion-thread-threads"><span class="me-2">Add Context Feature Within the Same Discussion Thread (Threads)</span><a href="#add-context-feature-within-the-same-discussion-thread-threads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If you send a new message in the same thread, it can be treated as a follow-up question to the original issue. At this point, a feature can be added to append the previous conversation to the new prompt.</p><p><strong>Add <code class="language-plaintext highlighter-rouge">slackGetReplies</code> &amp; Fill Content into OpenAI API Prompt:</strong></p><p><strong>Improve Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code>:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut Event payload field from post
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Simple print to log runtime, viewable in Logs
</span>    <span class="c1"># For advanced Logging Level reference: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="nf">print</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Due to FAAS (Cloud Functions) cold start, long idle time may cause delay exceeding Slack's 3-second response limit
</span>    <span class="c1"># OpenAI API request and reply may take up to nearly 1 minute depending on response length
</span>    <span class="c1"># Slack considers no response within limit as lost request and retries
</span>    <span class="c1"># This causes duplicate requests and responses, so we set X-Slack-No-Retry: 1 in Response Headers to tell Slack no retry even if no timely response    
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Ignore Slack Retry requests...
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># If event source is App and App ID == Slack App ID, it means event triggered by own Slack App
</span>        <span class="c1"># Ignore to avoid infinite loop Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event type, e.g., message, app_mention...
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType, e.g., message_changed, message_deleted...
</span>        <span class="c1"># New messages have no SubType
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Messages with SubType are edits, deletions, replies...
</span>            <span class="c1"># Ignore these
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Channel of the message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message content
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message timestamp (ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Thread parent message timestamp (ID)
</span>            <span class="c1"># Only present for thread replies
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut (message)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># If message Shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If Shortcut to abort OpenAI API response generation
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">Successfully stopped OpenAI API response generation!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>


    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I only understand Traditional Chinese (Taiwan) and English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I do not understand Simplified Chinese.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak Chinese, I respond in Traditional Chinese used in Taiwan.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak English, I respond in English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not respond with greetings.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">There should be a space between Chinese and English. There should be a space between Chinese characters and any other language characters including numbers and emojis.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If you don</span><span class="sh">'</span><span class="s">t know the answer or your knowledge is outdated, please search online before answering.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD, if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># If Slack App (OpenAI API Response), mark as assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># User message marked as user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">Generating response...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (chunked)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># Update message every 0.8 seconds to avoid frequent Slack Update API calls causing failure or wasting Cloud Functions invocations
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># If message has metadata &amp; metadata event_type == aborted, user marked response as aborted
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Aborted]*</span><span class="sh">"</span>
                <span class="c1"># Message deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Error occurred]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Notice</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><strong>Back to Slack for testing:</strong></p><p><a href="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HCE9oGBELh7ya98ZdMUESg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTUiIGhlaWdodD0iMjk3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*HHE0Nbgr95O6BwhiRe8lHg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NjQiIGhlaWdodD0iMzM3Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li><p>The left image shows that when you ask a follow-up question without adding the Context, it will be treated as a new conversation.</p><li><p><strong>The image on the right shows that adding context helps understand the entire conversation and the new question.</strong></p></ul><h3 id="done"><span class="me-2">Done!</span><a href="#done" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>So far, we have built our own ChatGPT (via OpenAI API) Slack App Bot.</p><blockquote><p>You can also refer to <a href="https://api.slack.com/" target="_blank">Slack API</a> and OpenAI API Custom instructions to integrate them in Cloud Functions Python programs according to your needs. For example, you can train one channel to answer team questions and find project documents, another channel for translations, and another for data analysis, and so on.</p></blockquote><h3 id="supplement"><span class="me-2">Supplement</span><a href="#supplement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="marking-bot-answers-outside-of-11-messages"><span class="me-2">Marking bot answers outside of 1:1 messages</span><a href="#marking-bot-answers-outside-of-11-messages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*_xg6yh7ZMCru0C1NU0-8bQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MzAiIGhlaWdodD0iMzEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>You can mention the bot in any channel (the bot must be added to the channel) to ask questions.</ul><p><strong>First, you need to add the <code class="language-plaintext highlighter-rouge">app_mention</code> Event Subscription:</strong></p><p><a href="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*lbJxUFn3uXz4a_x6Pw_KeQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDA1IiBoZWlnaHQ9IjU1OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Add completion -&gt; ‚ÄúSave Changes‚Äù saved -&gt; ‚Äúreinstall your app‚Äù completed.</p><p>In the above <code class="language-plaintext highlighter-rouge">main.py</code> script <code class="language-plaintext highlighter-rouge">#Handle Event Subscriptions Events‚Ä¶</code></p><p>Add new Event Type judgment <strong>inside the Code Block:</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>        <span class="c1"># Mention type Event (@SlackApp hello)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Sender of the event message
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Channel of the event message
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Content of the event message, remove leading tag string &lt;@SLACKAPPID&gt;
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Timestamp (message ID) of the event message
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Timestamp (message ID) of the parent message in the thread of the event message
</span>            <span class="c1"># Only present for new messages in a thread
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><p>After deployment, it is complete.</p><h4 id="deleting-messages-sent-in-slack-app"><span class="me-2">Deleting Messages Sent in Slack App</span><a href="#deleting-messages-sent-in-slack-app" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You cannot directly delete messages sent by the Slack App on Slack. You can refer to the above ‚Äú <code class="language-plaintext highlighter-rouge">Stop OpenAI API Response</code> ‚Äú Shortcut method to add a ‚ÄúDelete Message‚Äù Shortcut.</p><p>In the Cloud Functions <code class="language-plaintext highlighter-rouge">main.py</code> program:</p><p><code class="language-plaintext highlighter-rouge"># Handling Shortcut Code Block</code><br /> Add a callback_id check to see if it equals your defined ‚ÄúDelete Message‚Äù Shortcut Callback ID, then pass the parameters into the following method to complete the deletion:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></table></code></div></div><p><a href="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*0IPliUmdxXA2fNDmI0vqLw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MjYiIGhlaWdodD0iNTAxIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="slack-app-not-responding"><span class="me-2">Slack App Not Responding</span><a href="#slack-app-not-responding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>Check if the Token is correct</p><li><p>Check Cloud Functions Logs for Errors</p><li><p>Has the Cloud Functions deployment been completed?</p><li><p>Is the Slack App in the channel where you asked the question? (If it‚Äôs not a 1:1 conversation with the Slack App, you need to add the bot to the channel for it to work.)</p><li><p>Log Slack API Response under the SlackRequest method</p></ul><h4 id="cloud-functions-public-url-is-not-secure-enough"><span class="me-2">Cloud Functions Public URL Is Not Secure Enough</span><a href="#cloud-functions-public-url-is-not-secure-enough" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>If you worry that the Cloud Functions URL is not secure enough, you can add a query token for verification.</ul><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>
    <span class="c1"># Verify if the token parameter is valid
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="cloud-functions-related-issues"><span class="me-2">Cloud Functions Related Issues</span><a href="#cloud-functions-related-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="billing-method"><span class="me-2">Billing Method</span><a href="#billing-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Different regions, CPU, RAM, storage, and traffic have different prices. Please refer to the <a href="https://cloud.google.com/functions/pricing?hl=zh-tw" target="_blank">official pricing</a> table.</p><p><a href="https://cloud.google.com/functions/pricing?hl=zh-tw#free_tier" target="_blank">Free tier</a> as follows: (2024/02/15)</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nx">Cloud</span> <span class="nx">Functions</span> <span class="nx">offers</span> <span class="nx">a</span> <span class="nx">permanent</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="k">for</span> <span class="nx">compute</span> <span class="nx">time</span> <span class="nx">resources</span><span class="p">,</span>
<span class="nx">including</span> <span class="nx">allocation</span> <span class="nx">based</span> <span class="nx">on</span> <span class="nx">GB</span><span class="o">-</span><span class="nx">seconds</span> <span class="nx">and</span> <span class="nx">GHz</span><span class="o">-</span><span class="nx">seconds</span><span class="p">.</span> <span class="nx">Besides</span> <span class="mi">2</span> <span class="nx">million</span> <span class="nx">invocations</span><span class="p">,</span>
<span class="k">this</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="nx">also</span> <span class="nx">provides</span> <span class="mi">400</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GB</span><span class="o">-</span><span class="nx">seconds</span> <span class="nx">and</span> <span class="mi">200</span><span class="p">,</span><span class="mi">000</span> <span class="nx">GHz</span><span class="o">-</span><span class="nx">seconds</span> <span class="k">of</span> <span class="nx">compute</span> <span class="nx">time</span><span class="p">,</span>
<span class="kd">as </span><span class="nx">well</span> <span class="kd">as </span><span class="mi">5</span> <span class="nx">GB</span> <span class="k">of</span> <span class="nx">internet</span> <span class="nx">data</span> <span class="nx">transfer</span> <span class="nx">per</span> <span class="nx">month</span><span class="p">.</span>

<span class="nx">The</span> <span class="nx">usage</span> <span class="nx">limits</span> <span class="k">of</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="nx">are</span> <span class="nx">calculated</span> <span class="nx">at</span> <span class="nx">the</span> <span class="nx">equivalent</span> <span class="nx">USD</span> <span class="nx">amount</span> <span class="k">of</span> <span class="nx">Tier</span> <span class="mi">1</span> <span class="nx">prices</span> <span class="nx">mentioned</span> <span class="nx">above</span><span class="p">.</span>
<span class="nx">Regardless</span> <span class="k">of</span> <span class="nx">whether</span> <span class="nx">the</span> <span class="kd">function</span> <span class="nf">runs</span> <span class="k">in</span> <span class="nx">regions</span> <span class="nx">priced</span> <span class="nx">at</span> <span class="nx">Tier</span> <span class="mi">1</span> <span class="nx">and</span><span class="o">/</span><span class="nx">or</span> <span class="nx">Tier</span> <span class="mi">2</span><span class="p">,</span>
<span class="nx">the</span> <span class="nx">system</span> <span class="nx">allocates</span> <span class="nx">the</span> <span class="nx">equivalent</span> <span class="nx">USD</span> <span class="nx">amount</span> <span class="nx">to</span> <span class="nx">you</span><span class="p">.</span>
<span class="nx">However</span><span class="p">,</span> <span class="nx">when</span> <span class="nx">deducting</span> <span class="k">from</span> <span class="nx">the</span> <span class="nx">free</span> <span class="nx">tier</span> <span class="nx">quota</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">system</span> <span class="nx">uses</span> <span class="nx">the</span> <span class="kd">function</span><span class="dl">'</span><span class="s1">s execution region tier (Tier 1 or Tier 2) as the basis.

Please note that even if you use the free tier, a valid billing account is required.
</span></pre></table></code></div></div><blockquote><p>btw. The Slack App is free and does not require a Premium subscription to use.</p></blockquote><h4 id="slack-app-responds-too-slowly-or-times-out-too-long"><span class="me-2">Slack App Responds Too Slowly or Times Out Too Long</span><a href="#slack-app-responds-too-slowly-or-times-out-too-long" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>(Excluding the slower response issue during OpenAI API peak times)</strong>, if the bottleneck is Cloud Function, you can expand the settings on the first page of the Cloud Function editor:</p><p><a href="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*l0HbCpKmA-viT1oE5ThhSg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NDQiIGhlaWdodD0iODM5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Adjust CPU, RAM, Timeout duration, and Concurrent count to improve request processing speed.</p><blockquote><p>*But may require a fee</p></blockquote><h4 id="development-phase-testing--debug"><span class="me-2">Development Phase Testing &amp; Debug</span><a href="#development-phase-testing--debug" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*cZB3VcV5Dx_aB66aKW5Rsw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjYyOSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Click ‚ÄúTest Function‚Äù to open the Cloud Shell window in the bottom toolbar. Wait about 3‚Äì5 minutes (longer for the first launch). After the build completes and you accept the following permissions:</p><p><a href="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*c2siMn6ELt-APUHB3s3cXA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzEiIGhlaWdodD0iMjAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Once you see ‚ÄúFunction is ready to test,‚Äù you can click ‚ÄúRun Test‚Äù to execute the method debug test.</p><p>You can enter the JSON Body in the ‚ÄúTriggering event‚Äù box on the right to pass the <code class="language-plaintext highlighter-rouge">request_json</code> parameter for testing, or directly modify the code to inject a test object for testing.</p><blockquote><p>*Please note that Cloud Shell/Cloud Run may incur additional charges.</p></blockquote><blockquote><p>It is recommended to run a test before deployment to ensure the build succeeds.</p></blockquote><h4 id="build-failed-what-to-do-if-the-code-is-missing"><span class="me-2">Build failed, what to do if the code is missing?</span><a href="#build-failed-what-to-do-if-the-code-is-missing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*JaKgL845mDbBdHeklTXg2g.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTg0IiBoZWlnaHQ9IjE0OCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>If you accidentally write incorrect code causing the Cloud Function Deploy Build to fail, an error message will appear. Clicking ‚ÄúEDIT AND REDEPLOY‚Äù to return to the <strong>editor will show that the code you just changed is gone!!!</strong></p><p>No need to worry. At this point, click ‚ÄúSource Code‚Äù on the left and select ‚ÄúLast Failed Deployment‚Äù to restore the code from the recent Build Failed:</p><p><a href="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*Slq_kBiCKZ_YsP98-CJnlw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgwIiBoZWlnaHQ9IjQ3MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><h4 id="view-runtime-print-logs"><span class="me-2">View runtime <code class="language-plaintext highlighter-rouge">print</code> Logs</span><a href="#view-runtime-print-logs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*FmAHk6jgea0HxEDi5nbU6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjY2MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><blockquote><p>*Please note that Cloud Logging and Querying Logs may incur additional charges.</p></blockquote><h3 id="final-code-python-38"><span class="me-2">Final Code (Python 3.8)</span><a href="#final-code-python-38" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="cloud-functions"><span class="me-2">Cloud Functions</span><a href="#cloud-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><code class="language-plaintext highlighter-rouge">main.py</code> :</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">functions_framework</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="n">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="sh">"</span><span class="s">OPENAI API KEY</span><span class="sh">"</span>
<span class="n">SLACK_BOT_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Bot User OAuth Token</span><span class="sh">"</span>

<span class="c1"># Custom security verification token
# The URL must include ?token=SAFE_ACCESS_TOKEN parameter to accept requests
</span><span class="n">SAFE_ACCESS_TOKEN</span> <span class="o">=</span> <span class="sh">"</span><span class="s">nF4JwxfG9abqPZCJnBerwwhtodC28BuC</span><span class="sh">"</span>

<span class="c1"># OPENAI API Model used
# https://platform.openai.com/docs/models
</span><span class="n">OPENAI_MODEL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">gpt-4-1106-preview</span><span class="sh">"</span>

<span class="nd">@functions_framework.http</span>
<span class="k">def</span> <span class="nf">hello_http</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request_json</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">request_args</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span>
    <span class="n">request_headers</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span>

    <span class="c1"># Shortcut events come from the post payload field
</span>    <span class="c1"># https://api.slack.com/reference/interaction-payloads/shortcuts
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">payload</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="c1"># You can simply use print to log runtime info, viewable in Logs
</span>    <span class="c1"># For advanced logging levels, see: https://cloud.google.com/logging/docs/reference/libraries
</span>    <span class="c1"># print(payload)
</span>
    <span class="c1"># Due to FAAS (Cloud Functions) cold start, if the service is idle for too long,
</span>    <span class="c1"># the next call may trigger cold start and fail to respond within Slack's 3-second limit.
</span>    <span class="c1"># OpenAI API requests also take time (up to about 1 minute depending on response length).
</span>    <span class="c1"># Slack treats no response within the timeout as a lost request and retries,
</span>    <span class="c1"># causing duplicate requests and responses.
</span>    <span class="c1"># We set X-Slack-No-Retry: 1 in response headers to tell Slack not to retry even if timeout occurs.
</span>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">X-Slack-No-Retry</span><span class="sh">'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

    <span class="c1"># Validate token parameter
</span>    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">request_args</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">token</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_args</span> <span class="ow">and</span> <span class="n">request_args</span><span class="p">[</span><span class="sh">'</span><span class="s">token</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">SAFE_ACCESS_TOKEN</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Ignore Slack retry requests
</span>    <span class="k">if</span> <span class="n">request_headers</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">X-Slack-Retry-Num</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_headers</span><span class="p">:</span>
        <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Slack App Event Subscriptions Verify
</span>    <span class="c1"># https://api.slack.com/events/url_verification
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">url_verification</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">challenge</span> <span class="o">=</span> <span class="sh">""</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">challenge</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">challenge</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="c1"># Handle Event Subscriptions Events...
</span>    <span class="k">if</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">apiAppID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">:</span>
            <span class="n">apiAppID</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">api_app_id</span><span class="sh">'</span><span class="p">]</span>
        <span class="c1"># If event source is App and App ID == Slack App ID, it means event triggered by own Slack App
</span>        <span class="c1"># Ignore to avoid infinite loop Slack App -&gt; Cloud Functions -&gt; Slack App -&gt; Cloud Functions...
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">apiAppID</span> <span class="o">==</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]:</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">'</span><span class="s">OK!</span><span class="sh">'</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Event name, e.g., message, app_mention...
</span>        <span class="n">eventType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># SubType, e.g., message_changed, message_deleted...
</span>        <span class="c1"># New messages have no Sub Type
</span>        <span class="n">eventSubType</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">eventSubType</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">subtype</span><span class="sh">'</span><span class="p">]</span>
        
        <span class="c1"># Message type events
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Messages with Sub Type are edits, deletions, replies...
</span>            <span class="c1"># Ignore these
</span>            <span class="k">if</span> <span class="n">eventSubType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
               
            <span class="c1"># Message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message content
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message timestamp (ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Thread parent message timestamp (ID)
</span>            <span class="c1"># Only new messages in a thread have this
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        
        <span class="c1"># Mention events (@SlackApp hello)
</span>        <span class="k">if</span> <span class="n">eventType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">app_mention</span><span class="sh">'</span><span class="p">:</span>
            <span class="c1"># Message sender
</span>            <span class="n">eventUser</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">user</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message channel
</span>            <span class="n">eventChannel</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">]</span>
            <span class="c1"># Message content, remove leading mention string &lt;@SLACKAPPID&gt;
</span>            <span class="n">eventText</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;@\w+&gt;\W*</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">])</span>
            <span class="c1"># Message timestamp (ID)
</span>            <span class="n">eventTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="c1"># Thread parent message timestamp (ID)
</span>            <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">]:</span>
                <span class="n">eventThreadTS</span> <span class="o">=</span> <span class="n">request_json</span><span class="p">[</span><span class="sh">'</span><span class="s">event</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span>
                
            <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">)</span>
            <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    
    <span class="c1"># Handle Shortcut (message)
</span>    <span class="k">if</span> <span class="n">payload</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">payloadType</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">type</span><span class="sh">'</span><span class="p">]</span>

        <span class="c1"># If it's a message shortcut
</span>        <span class="k">if</span> <span class="n">payloadType</span> <span class="o">==</span> <span class="sh">'</span><span class="s">message_action</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">callbackID</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">triggerID</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">callbackID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">callback_id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">channel</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">channel</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
                <span class="n">triggerID</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">trigger_id</span><span class="sh">'</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># If it's the shortcut to stop OpenAI API response generation
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">abort_openai_api</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="p">{</span><span class="sh">"</span><span class="s">event_type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">event_payload</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span> <span class="p">}},</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">Successfully stopped OpenAI API response generation!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="c1"># If it's delete message
</span>                <span class="k">if</span> <span class="n">callbackID</span> <span class="o">==</span> <span class="sh">"</span><span class="s">delete_message</span><span class="sh">"</span><span class="p">:</span>
                    <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">triggerID</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">triggerID</span><span class="p">,</span> <span class="n">callbackID</span><span class="p">,</span> <span class="sh">"</span><span class="s">Successfully deleted Slack App message!</span><span class="sh">"</span><span class="p">)</span>
                        <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">OK!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

    <span class="nf">return </span><span class="p">(</span><span class="sh">"</span><span class="s">Access Denied!</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">openAIRequest</span><span class="p">(</span><span class="n">apiAppID</span><span class="p">,</span> <span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">,</span> <span class="n">eventText</span><span class="p">):</span>
    
    <span class="c1"># Set Custom instructions
</span>    <span class="c1"># Thanks to colleague (https://twitter.com/je_suis_marku) for support
</span>    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I only understand Taiwanese Traditional Chinese and English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I do not understand Simplified Chinese.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak Chinese, I reply in Taiwanese Traditional Chinese using common Taiwanese expressions.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If I speak English, I reply in English.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Do not respond with greetings or small talk.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">There must be a space between Chinese and English. There must be a space between Chinese characters and any other language characters including numbers and emojis.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">If you don</span><span class="sh">'</span><span class="s">t know the answer or your knowledge is outdated, please search online before answering.</span><span class="sh">"</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">system</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I will tip you 200 USD , if you answer well.</span><span class="sh">"</span><span class="p">}</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">eventThreadTS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">threadMessages</span> <span class="o">=</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventThreadTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threadMessages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">threadMessage</span> <span class="ow">in</span> <span class="n">threadMessages</span><span class="p">:</span>
                <span class="n">appID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">threadMessage</span><span class="p">:</span>
                    <span class="n">appID</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">app_id</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageText</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">threadMessageTs</span> <span class="o">=</span> <span class="n">threadMessage</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
                <span class="c1"># If from Slack App (OpenAI API Response), mark as assistant
</span>                <span class="k">if</span> <span class="n">appID</span> <span class="ow">and</span> <span class="n">appID</span> <span class="o">==</span> <span class="n">apiAppID</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">assistant</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                <span class="c1"># User message content marked as user
</span>                    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">threadMessageText</span>
                    <span class="p">})</span>

    <span class="n">messages</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">role</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">user</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">content</span><span class="sh">"</span><span class="p">:</span> <span class="n">eventText</span>
    <span class="p">})</span>

    <span class="n">replyMessageTS</span> <span class="o">=</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="sh">"</span><span class="s">Generating response...</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">replyMessageTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">))</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">openAIRequestAsync</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="n">messages</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="nc">AsyncOpenAI</span><span class="p">(</span>
      <span class="n">api_key</span><span class="o">=</span><span class="n">OPENAI_API_KEY</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Stream Response (partial responses)
</span>    <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">chat</span><span class="p">.</span><span class="n">completions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="n">model</span><span class="o">=</span><span class="n">OPENAI_MODEL</span><span class="p">,</span>
      <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
      <span class="n">stream</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="sh">""</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">delta</span><span class="p">.</span><span class="n">content</span> <span class="ow">or</span> <span class="sh">""</span>
            
            <span class="c1"># Update message every 0.8 seconds to avoid frequent Slack update API calls causing failures or wasting Cloud Functions calls
</span>            <span class="k">if</span> <span class="n">debounceSlackUpdateTime</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">debounceSlackUpdateTime</span> <span class="o">&gt;=</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="o">+</span><span class="sh">"</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">debounceSlackUpdateTime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

                <span class="c1"># If message has metadata &amp; metadata event_type == aborted, it means user marked this response as aborted
</span>                <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">message</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">event_type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">aborted</span><span class="sh">"</span><span class="p">:</span>
                    <span class="k">break</span>
                    <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Aborted]*</span><span class="sh">"</span>
                <span class="c1"># Message was deleted
</span>                <span class="k">elif</span> <span class="n">response</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ok</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ok</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">error</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">message_not_found</span><span class="sh">"</span> <span class="p">:</span>
                    <span class="k">break</span>
                
        <span class="k">await</span> <span class="n">stream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
                
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">...*[Error occurred]*</span><span class="sh">"</span>

    <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">eventChannel</span><span class="p">,</span> <span class="n">eventTS</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>


<span class="c1">### Slack ###
</span><span class="k">def</span> <span class="nf">slackGetReplies</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/conversations.replies?channel=</span><span class="sh">"</span><span class="o">+</span><span class="n">channel</span><span class="o">+</span><span class="sh">"</span><span class="s">&amp;ts=</span><span class="sh">"</span><span class="o">+</span><span class="n">ts</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">messages</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">messages</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackOpenModal</span><span class="p">(</span><span class="n">trigger_id</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="nf">slackRequest</span><span class="p">(</span><span class="sh">"</span><span class="s">/views.open</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">trigger_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">trigger_id</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">view</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">modal</span><span class="sh">"</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">callback_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">callback_id</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">title</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">plain_text</span><span class="sh">"</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Notice</span><span class="sh">"</span>
            <span class="p">},</span>
            <span class="sh">"</span><span class="s">blocks</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">section</span><span class="sh">"</span><span class="p">,</span>
                    <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="sh">"</span><span class="s">type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">mrkdwn</span><span class="sh">"</span><span class="p">,</span>
                        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">})</span>

<span class="k">def</span> <span class="nf">slackDeleteMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.delete</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackUpdateMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.update</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">ts</span><span class="sh">"</span><span class="p">:</span> <span class="n">ts</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">metadata</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    
    <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    
    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">slackRequestPostMessage</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">target_ts</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/chat.postMessage</span><span class="sh">"</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">channel</span><span class="sh">"</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">text</span><span class="sh">"</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">target_ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="sh">'</span><span class="s">thread_ts</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_ts</span>

    <span class="n">response</span> <span class="o">=</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">slackRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://slack.com/api</span><span class="sh">"</span><span class="o">+</span><span class="n">endpoint</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Authorization</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Bearer </span><span class="si">{</span><span class="n">SLACK_BOT_TOKEN</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Content-Type</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">application/json</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">requirements.txt</code> Ôºö</p><div class="language-ini highlighter-rouge"><div class="code-header"> <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="py">functions-framework</span><span class="p">=</span><span class="s">=3.*</span>
<span class="py">requests</span><span class="p">=</span><span class="s">=2.31.0</span>
<span class="py">openai</span><span class="p">=</span><span class="s">=1.9.0</span>
</pre></table></code></div></div><h4 id="slack-app-setup"><span class="me-2">Slack App Setup</span><a href="#slack-app-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>OAuth &amp; Permissions</strong></p><p><a href="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*kHTMERqNSC4p1dV8omuyFg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iNTk5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><ul><li>Items with disabled delete buttons are permissions automatically added by Slack after adding the Shortcut.</ul><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li><p>Interactivity: Enable</p><li><p>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code></p><li><p>Subscribe to bot events:</p></ul><p><a href="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*7tQYZKyn2GW2tPKd2GJE6Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NDkiIGhlaWdodD0iMzUwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>Interactivity &amp; Shortcuts</strong></p><ul><li><p>Interactivity: Enable</p><li><p>Request URL: <code class="language-plaintext highlighter-rouge">https://us-central1-xxx-xxx.cloudfunctions.net/SlackBot-Rick-C-137?token=nF4JwxfG9abqPZCJnBerwwhtodC28BuC</code></p><li><p>Shortcuts:</p></ul><p><a href="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*6rHz_4lpdPDwbLZhWMSULg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NTUiIGhlaWdodD0iMzQyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>App Home</strong></p><ul><li><p>Always Show My Bot as Online: Enable</p><li><p>Messages Tab: Enable</p><li><p>Allow users to send Slash commands and messages from the messages tab: ‚úÖ</p></ul><p><strong>Basic Information</strong></p><p><a href="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*1OQMhVmkl-omm_2wvQJTvQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NjkiIGhlaWdodD0iNTUyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><blockquote><p>Rick &amp; Morty ü§òü§òü§ò</p></blockquote><p><a href="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" class="popup img-link blur"><img data-src="/assets/bd94cc88f9c9/1*xkH5Li8KgLzwRsVEbo1hBQ.webp" alt="[Reddit](https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4NzMiIGhlaWdodD0iNzcwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.reddit.com/r/ChatGPT/comments/154l9z1/are_you_polite_with_chatgpt/" target="_blank">Reddit</a></p><h3 id="commercial-time"><span class="me-2">Commercial Time</span><a href="#commercial-time" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you and your team need automation tools or process integrations, whether it‚Äôs Slack App development, Notion, Asana, Google Sheets, Google Forms, GA data, or any other integration needs, feel free to <a href="https://zhgchg.li/contact/" target="_blank"><strong>contact me for development</strong></a>.</p><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=üç∫&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>This post was originally published on Medium (<a href="https://medium.com/p/bd94cc88f9c9" target="_blank"><strong>View original post</strong></a>), and automatically converted and synced by <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a>.</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2024-02-16-bd94cc88f9c9.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,049+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/english/" class="post-tag no-text-decoration" >english</a> <a href="/tags/ai-translation/" class="post-tag no-text-decoration" >ai-translation</a> <a href="/tags/cloud-functions/" class="post-tag no-text-decoration" >cloud-functions</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/chatgpt/" class="post-tag no-text-decoration" >chatgpt</a> <a href="/tags/slack/" class="post-tag no-text-decoration" >slack</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Slack%20&%20ChatGPT%20Integration%EF%BD%9CBuild%20Custom%20OpenAI%20API%20Slack%20App%20with%20Google%20Cloud%20Functions%20&%20Python%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fslack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Slack%20&%20ChatGPT%20Integration%EF%BD%9CBuild%20Custom%20OpenAI%20API%20Slack%20App%20with%20Google%20Cloud%20Functions%20&%20Python%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fslack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fslack-chatgpt-integration-build-custom-openai-api-slack-app-with-google-cloud-functions-python-bd94cc88f9c9%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and EfficiencyÔΩúTool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD ÂÆûÊàòÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄ‰πàÔºüÂ¶Ç‰ΩïÈÄèËøá CI/CD ÊâìÈÄ†Á®≥ÂÆöÈ´òÊïàÁöÑÂºÄÂèëÂõ¢ÈòüÔºüÂ∑•ÂÖ∑ÈÄâÊã©Ôºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD ÂØ¶Êà∞ÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄÈ∫ºÔºüÂ¶Ç‰ΩïÈÄèÈÅé CI/CD ÊâìÈÄ†Á©©ÂÆöÈ´òÊïàÁöÑÈñãÁôºÂúòÈöäÔºüÂ∑•ÂÖ∑ÈÅ∏ÊìáÔºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web AppÔΩúIntegrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">‰ΩøÁî® Google Apps Script Web App Ë°®Âçï‰∏≤Êé• Github Action CI/CD Â∑•‰Ωú</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters üîñ</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E8%88%87-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration</h4><div class="text-muted"><p>Ëá™Ë°åÊâìÈÄ† ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708089421" data-df="ll" > Feb 16, 2024 </time><h4 class="pt-0 my-2">Slack & ChatGPT Integration</h4><div class="text-muted"><p>Ëá™Ë°åÊâìÈÄ† ChatGPT OpenAI API for Slack App (Google Cloud Functions &amp; Python)</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/automate-routine-tasks-with-python-google-cloud-platform-line-bot-daily-check-in-script-example-70a1409b149a/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1613822151" data-df="ll" > Feb 20, 2021 </time><h4 class="pt-0 my-2">Automate Routine Tasks with Python, Google Cloud Platform & Line BotÔΩúDaily Check-In Script Example</h4><div class="text-muted"><p>Discover how to automate daily check-ins using Python, Google Cloud Platform, and Line Bot to save time and boost efficiency. Learn to create a reliable script that runs automatically, ensuring con...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E5%B1%B1%E9%99%BD%E5%9C%B0%E5%8D%80%E5%BB%A3%E5%B3%B6%E5%B2%A1%E5%B1%B1%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-6%E6%97%A5%E8%A1%8C%E7%A8%8B-%E4%BA%A4%E9%80%9A-%E4%BD%8F%E5%AE%BF%E5%85%A8%E8%A7%A3%E6%9E%90-31b9b3a63abc/" class="btn btn-outline-primary" aria-label="Older" ><p>Â±±ÈôΩÂú∞ÂçÄÂª£Â≥∂Â≤°Â±±Ëá™Áî±Ë°åÊîªÁï•ÔΩú6Êó•Ë°åÁ®ã„ÄÅ‰∫§ÈÄö„ÄÅ‰ΩèÂÆøÂÖ®Ëß£Êûê</p></a> <a href="/posts/zrealm-dev/zh-cn/slack-app-%E6%95%B4%E5%90%88-chatgpt-%E5%88%A9%E7%94%A8-openai-api-%E4%B8%8E-google-cloud-functions-%E8%87%AA%E5%BB%BA%E6%99%BA%E8%83%BD%E5%8A%A9%E7%90%86-bd94cc88f9c9/" class="btn btn-outline-primary" aria-label="Newer" ><p>Slack & ChatGPT Integration</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">Ê≠£È´î‰∏≠Êñá</a> | <a href="/tags/simplified-chinese">ÁÆÄ‰Ωì‰∏≠Êñá</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-20 15:53:40 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
