<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Discover how to transform HTML into NSAttributedString with a custom-built ZMarkupParser engine, solving rendering challenges and enhancing text display precision for iOS developers." /><meta property="og:description" content="Discover how to transform HTML into NSAttributedString with a custom-built ZMarkupParser engine, solving rendering challenges and enhancing text display precision for iOS developers." /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-12T01:09:22+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" /><meta property="twitter:title" content="HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://www.linkedin.com/in/zhgchgli"},"dateModified":"2023-08-06T00:15:39+08:00","datePublished":"2023-03-12T01:09:22+08:00","description":"Discover how to transform HTML into NSAttributedString with a custom-built ZMarkupParser engine, solving rendering challenges and enhancing text display precision for iOS developers.","headline":"HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/"}</script><title>HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=false" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%AC%E6%8D%A2-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3-2724f02f6e7/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%89%E6%8F%9B-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-2724f02f6e7/"><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan üáπüáº who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="https://medium.com/@zhgchgli" class="nav-link" target="_blank" style="background: #EDF4FF; color: #0A84FF;"> <i class="fa-brands fa-medium"></i> <span>Follow Me!<br/><strong>1,050+</strong> Followers</span> </a><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering</h1><p class="post-desc fw-light mb-4">Discover how to transform HTML into NSAttributedString with a custom-built ZMarkupParser engine, solving rendering challenges and enhancing text display precision for iOS developers.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1678554562" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 12, 2023 </time> </span> <span> Updated <time data-ts="1691252139" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 5, 2023 </time> </span><div class="mt-3 mb-3"> <a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" class="popup img-link preview-img blur"><img data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://www.linkedin.com/in/zhgchgli">ZhgChgLi</a> </em> | <em><a href="https://www.linkedin.com/in/zhgchgli" target="_blank">Senior Software Engineer</a></em><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="9739 words" > <em>54 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Chapters üîñ</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">HTML Parsing TechniquesÔΩúBuild Custom Parsers for NSAttributedString Rendering</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%AC%E6%8D%A2-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3-2724f02f6e7/"><strong>ÁÇπÂáªËøôÈáå</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†ÁÆÄ‰Ωì‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%89%E6%8F%9B-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-2724f02f6e7/"><strong>ÈªûÊìäÈÄôË£°</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†Ê≠£È´î‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-info"><p>This post was translated with AI assistance ‚Äî let me know if anything sounds off!</p></blockquote><h4 id="zhgchgli-table-of-contents">Table of Contents</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>The Story of Building a Handmade HTML Parser <a href="#the-story-of-building-a-handmade-html-parser">#</a></summary><ul><li><a href="#continuation">Continuation</a></li></ul></details></li><li class="has-children"><details><summary>Convert HTML String to NSAttributedString <a href="#convert-html-string-to-nsattributedstring">#</a></summary><ul><li><a href="#nsattributedstringdocumenttypehtml">NSAttributedString.DocumentType.html</a></li><li><a href="#xmlparser">XMLParser</a></li><li><a href="#standing-on-the-shoulders-of-giants">Standing on the Shoulders of Giants</a></li></ul></details></li><li class="has-children"><details><summary>ZhgChgLi/ZMarkupParser <a href="#zhgchglizmarkupparser">#</a></summary><ul><li><a href="#features">Features</a></li></ul></details></li><li><a href="#technical-details">Technical Details</a></li><li><a href="#tokenization">Tokenization</a></li><li><a href="#normalization">Normalization</a></li><li class="has-children"><details><summary>Abstract Syntax Tree <a href="#abstract-syntax-tree">#</a></summary><ul><li><a href="#markupcomponent">MarkupComponent</a></li><li><a href="#htmltag--htmltagname--htmltagnamevisitor">HTMLTag & HTMLTagName & HTMLTagNameVisitor</a></li><li><a href="#htmltagnametohtmlmarkupvisitor">HTMLTagNameToHTMLMarkupVisitor</a></li><li><a href="#convert-to-abstract-syntax-tree-with-html-data">Convert to Abstract Syntax Tree with HTML Data</a></li><li><a href="#at-this-point-we-have-actually-completed-the-selector-functionality-">At this point, we have actually completed the Selector functionality üéâ</a></li></ul></details></li><li class="has-children"><details><summary>Parser ‚Äî HTML to MarkupStyle (Abstract of NSAttributedString.Key) <a href="#parser--html-to-markupstyle-abstract-of-nsattributedstringkey">#</a></summary><ul><li><a href="#markupstyle-struct">MarkupStyle Struct</a></li><li><a href="#htmltagstyleattribute--htmltagstyleattributevisitor">HTMLTagStyleAttribute & HTMLTagStyleAttributeVisitor</a></li><li><a href="#htmltagstyleattributetomarkupstylevisitor">HTMLTagStyleAttributeToMarkupStyleVisitor</a></li><li><a href="#htmlelementmarkupcomponentmarkupstylevisitor">HTMLElementMarkupComponentMarkupStyleVisitor</a></li><li><a href="#htmlelementwithmarkuptomarkupstyleprocessor">HTMLElementWithMarkupToMarkupStyleProcessor</a></li></ul></details></li><li class="has-children"><details><summary>Render ‚Äî Convert To NSAttributedString <a href="#render--convert-to-nsattributedstring">#</a></summary><ul><li><a href="#markupnsattributedstringvisitor">MarkupNSAttributedStringVisitor</a></li><li><a href="#stripper--remove-html-tags">Stripper ‚Äî Remove HTML Tags</a></li><li><a href="#extend--dynamic-expansion">Extend ‚Äî Dynamic Expansion</a></li><li><a href="#zhtmlparserbuilder">ZHTMLParserBuilder</a></li><li><a href="#uikit-issues">UIKit Issues</a></li><li><a href="#complex-rendering-items--item-list">Complex Rendering Items ‚Äî Item List</a></li><li><a href="#complex-rendering-items--table">Complex Rendering Items ‚Äî Table</a></li><li><a href="#complex-rendering-item--image">Complex Rendering Item ‚Äî Image</a></li></ul></details></li><li class="has-children"><details><summary>Testing & Continuous Integration <a href="#testing--continuous-integration">#</a></summary><ul><li><a href="#snapshot-test">Snapshot Test</a></li><li><a href="#codecov-test-coverage">Codecov Test Coverage</a></li><li><a href="#continuous-integration">Continuous Integration</a></li><li><a href="#regex">Regex</a></li><li><a href="#swift-package-manager--cocoapods">Swift Package Manager & Cocoapods</a></li><li><a href="#chatgpt">ChatGPT</a></li></ul></details></li><li><a href="#disclaimer">Disclaimer</a></li><li><a href="#contributing">Contributing</a></li><li class="has-children"><details><summary>Summary <a href="#summary">#</a></summary><ul><li><a href="#further-reading">Further Reading</a></li></ul></details></li></ul></nav><hr /><h3 id="the-story-of-building-a-handmade-html-parser"><span class="me-2">The Story of Building a Handmade HTML Parser</span><a href="#the-story-of-building-a-handmade-html-parser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>ZMarkupParser HTML to NSAttributedString Rendering Engine Development Diary</p><p>Tokenization conversion of HTML strings, normalization processing, generation of abstract syntax trees, application of visitor and builder patterns, and some miscellaneous discussions‚Ä¶</p><h4 id="continuation"><span class="me-2">Continuation</span><a href="#continuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Last year, I published an article titled ‚Äú[<strong>TL;DR]</strong> <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/">Implementing iOS NSAttributedString HTML Render by Yourself</a>,‚Äù which briefly introduced using XMLParser to parse HTML and convert it into NSAttributedString.Key. The code structure and ideas in the article were quite messy, as it was just a quick record of issues I encountered earlier and I didn‚Äôt spend much time researching this topic back then.</p><h3 id="convert-html-string-to-nsattributedstring"><span class="me-2">Convert HTML String to NSAttributedString</span><a href="#convert-html-string-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Revisiting this topic, we need to convert the HTML string provided by the API into an NSAttributedString and apply the corresponding styles to display it in a UITextView/UILabel.</p><p>e.g. <code class="language-plaintext highlighter-rouge">&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;</code> should display as <strong>Test <a href="https://blog.zhgchg.li" target="_blank">Link</a></strong></p><ul><li><p>Note 1<br /> It is not recommended to use HTML as the communication and rendering medium between the app and data because the HTML specification is too flexible. Apps cannot support all HTML styles and there is no official HTML conversion rendering engine.</p><li><p>Note 2<br /> Starting from iOS 14, you can use the official native AttributedString to parse Markdown or include the apple/swift-markdown Swift Package to parse Markdown.</p><li><p>Note 3<br /> Due to the large scale of our project and the long-term use of HTML as the medium, we are currently unable to fully switch to Markdown or other markup languages.</p><li><p><strong>Note 4</strong><br /> <strong>The HTML here is not meant to display a full HTML webpage, but only to use HTML as a style for rendering Markdown string styles.</strong><br /> <strong>(To render a full page with complex content including images and tables, you still need to use WebView loadHTML)</strong></p></ul><blockquote><p>It is highly recommended to use Markdown as the string rendering markup language. If your project faces the same issue as mine and you have no choice but to use HTML without an elegant tool to convert to NSAttributedString, then please use it.</p></blockquote><blockquote><p>Friends who read the previous article can directly skip to the ZhgChgLi / ZMarkupParser section.</p></blockquote><h4 id="nsattributedstringdocumenttypehtml"><span class="me-2">NSAttributedString.DocumentType.html</span><a href="#nsattributedstringdocumenttypehtml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The methods for HTML to NSAttributedString found online usually require us to directly use NSAttributedString‚Äôs built-in options to render HTML. An example is shown below:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">htmlString</span> <span class="o">=</span> <span class="s">"&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;"</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">htmlString</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributedOptions</span><span class="p">:[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentReadingOptionKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="o">.</span><span class="nv">documentType</span> <span class="p">:</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span>
  <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span>
<span class="p">]</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">attributedOptions</span><span class="p">,</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Problems with this approach:</strong></p><ul><li><p>Poor performance: This method renders styles through the WebView Core, then switches back to the Main Thread for UI display; rendering over 300 characters takes 0.03 seconds.</p><li><p>Word swallowing: For example, marketing copy might use <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code>, which will be treated as an HTML tag and removed.</p><li><p>Cannot customize: For example, you cannot specify the exact boldness level of HTML bold text in NSAttributedString.</p><li><p><a href="https://developer.apple.com/forums/thread/115405" target="_blank">iOS ‚â• 12 intermittent crashes issue with no official fix</a></p><li><p>In iOS 15, a <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/">frequent crash issue</a> occurred. Testing showed a 100% crash rate under low battery conditions (fixed in iOS ‚â• 15.2).</p><li><p>Strings that are too long will cause a crash. Testing shows that inputting strings longer than 54,600 characters will 100% cause a crash (EXC_BAD_ACCESS).</p></ul><p>The most painful issue for us remains the crash problem. From the release of iOS 15 to 15.2 before the fix, the app was consistently dominated by this issue. According to data, from 2022/03/11 to 2022/06/08, it caused over 2.4K crashes and affected more than 1.4K users.</p><p>This crash issue has existed since iOS 12. iOS 15 just hit a bigger snag, but I guess the fix in iOS 15.2 is only a patch; Apple cannot completely eliminate it.</p><p>Secondly, the issue is performance. As a string style Markup Language, it is heavily used in App UILabel/UITextView. As mentioned earlier, one Label requires 0.03 seconds, and multiplying this by multiple UILabel/UITextView instances can cause noticeable lag in user interaction.</p><h4 id="xmlparser"><span class="me-2">XMLParser</span><a href="#xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The second method is introduced in the <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/">previous article</a>, using XMLParser to parse into corresponding NSAttributedString keys and apply styles.</p><p>You can refer to the implementation of <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> and the <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/">previous article</a>.</p><blockquote><p>The previous article only explored using XMLParser to parse HTML and perform corresponding conversions, completing an experimental implementation. However, it did not design it as a well-structured and extensible ‚Äútool.‚Äù</p></blockquote><p><strong>Problems with this approach:</strong></p><ul><li><p>Error tolerance 0: <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code><br /> The above three HTML cases may appear, and XMLParser will throw an error and show a blank screen when parsing them.</p><li><p>When using XMLParser, the HTML string must fully comply with XML rules and cannot be displayed correctly with tolerance like a browser or NSAttributedString.DocumentType.html.</p></ul><h4 id="standing-on-the-shoulders-of-giants"><span class="me-2">Standing on the Shoulders of Giants</span><a href="#standing-on-the-shoulders-of-giants" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Neither of the above two solutions can perfectly and elegantly solve the HTML problem, so I started searching for existing solutions.</p><ul><li><p><a href="https://github.com/johnxnguyen" target="_blank">johnxnguyen</a> / <a href="https://github.com/johnxnguyen/Down" target="_blank">Down</a><br /> Only supports converting input Markdown to Any (XML/NSAttributedString‚Ä¶), but does not support converting input HTML.</p><li><p><a href="https://github.com/malcommac" target="_blank">malcommac</a> / <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a><br /> The underlying implementation uses XMLParser, and testing the above cases also shows the same issue with a fault tolerance rate of 0.</p><li><p><a href="https://github.com/scinfu" target="_blank">scinfu</a> / <a href="https://github.com/scinfu/SwiftSoup" target="_blank">SwiftSoup</a><br /> Only supports HTML Parser (Selector) <a href="https://github.com/scinfu/SwiftSoup/issues/127" target="_blank">does not support conversion to NSAttributedString</a>.</p></ul><blockquote><p>Searched everywhere but all results are similar to the above project Orz, no giant shoulders to stand on.</p></blockquote><h3 id="zhgchglizmarkupparser"><span class="me-2">ZhgChgLi/ZMarkupParser</span><a href="#zhgchglizmarkupparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/602927147/57ce75c1-8548-449c-b44a-f4b0451ed5ea" alt="" loading="lazy"></a></p><p>Without the shoulders of giants, I had to become the giant myself, so I developed an HTML String to NSAttributedString tool.</p><p>Developed purely in Swift, it uses Regex to parse HTML tags and performs tokenization. It analyzes and corrects tag accuracy (fixing unclosed tags &amp; misaligned tags), then converts them into an abstract syntax tree. Finally, it uses the Visitor Pattern to map HTML tags to abstract styles, resulting in the final NSAttributedString output; no parser libraries are used.</p><h4 id="features"><span class="me-2">Features</span><a href="#features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p>Support HTML Render (to NSAttributedString) / Stripper (remove HTML tags) / Selector functions</p><li><p>Higher Performance than <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code></p><li><p>Automatically analyze and correct tag accuracy (fix tags without end tags &amp; misplaced tags)</p><li><p>Support dynamic styling from <code class="language-plaintext highlighter-rouge">style="color:red..."</code></p><li><p>Supports custom style specification, for example, making bold text <strong>bolder</strong></p><li><p>Supports flexible expandable tags or custom tags and attributes</p></ul><blockquote><p>For detailed introduction, installation, and usage, please refer to this article: „Äå <a href="/posts/zrealm-dev/en/zmarkupparser-convert-html-string-to-nsattributedstring-with-custom-style-keys-a5643de271e4/"><strong>ZMarkupParser HTML String to NSAttributedString Tool</strong></a> „Äç</p></blockquote><p>You can directly <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">git clone the project</a>, then open <code class="language-plaintext highlighter-rouge">ZMarkupParser.xcworkspace</code>. Select the <code class="language-plaintext highlighter-rouge">ZMarkupParser-Demo</code> target and build &amp; run it to try it out.</p><p><a href="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyOTUiIGhlaWdodD0iNjQwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><h3 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next is the main focus of this article, sharing the technical details about developing this tool.</p><p><a href="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.webp" alt="Operation Flow Overview" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjY4MiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Overview of Operation Process</p><p>The above image shows the general workflow. The following article will explain each step in detail and include the code.</p><blockquote><p>‚ö†Ô∏è This article simplifies the demo code by reducing abstraction and performance considerations, focusing mainly on explaining the operating principles. For the final results, please refer to the project <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">Source Code</a>.</p></blockquote><h3 id="tokenization"><span class="me-2">Tokenization</span><a href="#tokenization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a parser, parsing</p></blockquote><p>When it comes to HTML rendering, the most important part is parsing. Previously, HTML was parsed as XML using XMLParser; however, this cannot handle the fact that everyday HTML is not 100% XML, causing parser errors and lacking dynamic correction.</p><p>After ruling out the use of XMLParser, the only option left for us in Swift is to use Regex for matching and parsing.</p><p>At first, I didn‚Äôt think much and planned to use regex to extract ‚Äúpaired‚Äù HTML tags directly, then recursively search layer by layer inside until the end. However, this approach couldn‚Äôt handle nested HTML tags or support error tolerance for misaligned tags. Therefore, we changed the strategy to extract ‚Äúsingle‚Äù HTML tags, record whether they are Start Tags, Close Tags, or Self-Closing Tags, and combine other strings into a parsed result array.</p><p><strong>Tokenization structure is as follows:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">start</span><span class="p">(</span><span class="kt">StartItem</span><span class="p">)</span> <span class="c1">// &lt;a&gt;</span>
    <span class="k">case</span> <span class="nf">close</span><span class="p">(</span><span class="kt">CloseItem</span><span class="p">)</span> <span class="c1">// &lt;/a&gt;</span>
    <span class="k">case</span> <span class="nf">selfClosing</span><span class="p">(</span><span class="kt">SelfClosingItem</span><span class="p">)</span> <span class="c1">// &lt;br/&gt;</span>
    <span class="k">case</span> <span class="nf">rawString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">StartItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>

        <span class="c1">// Start Tag might be an abnormal HTML tag or normal text e.g. &lt;Congratulation!&gt;. After normalization, if found to be an isolated Start Tag, mark as True.</span>
        <span class="k">var</span> <span class="nv">isIsolated</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
        
        <span class="c1">// Used for automatic filling correction during normalization</span>
        <span class="kd">func</span> <span class="nf">convertToCloseParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CloseItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">CloseItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1">// Used for automatic filling correction during normalization</span>
        <span class="kd">func</span> <span class="nf">convertToSelfClosingParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">SelfClosingItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">CloseItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>The regex used is as follows:</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="p">(</span><span class="sc">?:</span><span class="p">(?</span><span class="o">&lt;</span><span class="n">closeTag</span><span class="o">&gt;</span><span class="p">\</span><span class="sr">/)?(?&lt;tagName&gt;[A-Za-z0-9]+)(?&lt;tagAttributes&gt;(?:\s*(\w+)\s*=\s*(["\|']).*?\5)*)\s*(?&lt;selfClosingTag&gt;\/)?&gt;)
</span></pre></table></code></div></div><p>-&gt; <a href="https://regex101.com/r/aBrID8/1" target="_blank">Online Regex101 Playground</a></p><ul><li><p>closeTag: matches &lt; <code class="language-plaintext highlighter-rouge">/</code> a&gt;</p><li><p>tagName: matches &lt; <code class="language-plaintext highlighter-rouge">a</code> &gt; or , &lt;/ <code class="language-plaintext highlighter-rouge">a</code> &gt;</p><li><p>tagAttributes: Match &lt;a <code class="language-plaintext highlighter-rouge">href="https://zhgchg.li" style="color:red"</code> &gt;</p><li><p>selfClosingTag: Match &lt;br <code class="language-plaintext highlighter-rouge">/</code> &gt;</p></ul><blockquote><p>*This regex can still be optimized, will do it later</p></blockquote><blockquote><p>The latter part of the article offers more details on regular expressions for those interested.</p></blockquote><p><strong>Putting it all together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">tokenizationResult</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">let</span> <span class="nv">expression</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">expressionOptions</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">totalLength</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="c1">// utf-16 supports emoji</span>
<span class="k">var</span> <span class="nv">lastMatch</span><span class="p">:</span> <span class="kt">NSTextCheckingResult</span><span class="p">?</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="c1">// Check if the HTML string needs further normalization to fix misalignment or add Self-Closing Tags</span>
<span class="k">var</span> <span class="nv">stackStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">needFormatter</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">expression</span><span class="o">.</span><span class="nf">enumerateMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totalLength</span><span class="p">))</span> <span class="p">{</span> <span class="n">match</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">match</span> <span class="o">=</span> <span class="n">match</span> <span class="p">{</span>
    <span class="c1">// Check the string between tags or before the first tag</span>
    <span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;zzz&lt;b&gt;bold&lt;/b&gt;Test2 -&gt; Test, zzz</span>
    <span class="k">let</span> <span class="nv">lastMatchEnd</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="p">?</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span> <span class="p">??</span> <span class="mi">0</span>
    <span class="k">let</span> <span class="nv">currentMatchStart</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">lowerBound</span>
    <span class="k">if</span> <span class="n">currentMatchStart</span> <span class="o">&gt;</span> <span class="n">lastMatchEnd</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">rawStringBetweenTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">lastMatchEnd</span><span class="p">,</span> <span class="p">(</span><span class="n">currentMatchStart</span> <span class="o">-</span> <span class="n">lastMatchEnd</span><span class="p">)))</span>
      <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">rawStringBetweenTag</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// &lt;a href="https://zhgchg.li"&gt;, &lt;/a&gt;</span>
    <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
    <span class="c1">// a, a</span>
    <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagName"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="c1">// false, true</span>
    <span class="k">let</span> <span class="nv">matchIsEndTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"closeTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>
    <span class="c1">// href="https://zhgchg.li", nil</span>
    <span class="c1">// Use regex to parse HTML Attributes to [String: String], see Source Code</span>
    <span class="k">let</span> <span class="nv">matchTagAttributes</span> <span class="o">=</span> <span class="nf">parseAttributes</span><span class="p">(</span><span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagAttributes"</span><span class="p">)))</span>
    <span class="c1">// false, false</span>
    <span class="k">let</span> <span class="nv">matchIsSelfClosingTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"selfClosingTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">matchAttributedString</span><span class="p">,</span>
       <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">matchTag</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">matchIsSelfClosingTag</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;br/&gt;</span>
          <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;a&gt; or &lt;/a&gt;</span>
          <span class="k">if</span> <span class="n">matchIsEndTag</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;/a&gt;</span>
            <span class="c1">// Find the last occurrence of the same TagName in the stack</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">lastIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">matchTag</span> <span class="p">})</span> <span class="p">{</span>
              <span class="c1">// If not the last one, it means misalignment or missing closing tag</span>
              <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                  <span class="n">needFormatter</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
              <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">)))</span>
              <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Extra close tag e.g &lt;/a&gt;</span>
              <span class="c1">// Ignore as it won't affect further processing</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;a&gt;</span>
            <span class="k">let</span> <span class="nv">startItem</span><span class="p">:</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span> <span class="o">=</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)</span>
            <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="n">startItem</span><span class="p">))</span>
            <span class="c1">// Push to stack</span>
            <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">startItem</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">}</span>

    <span class="n">lastMatch</span> <span class="o">=</span> <span class="n">match</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Check trailing RawString</span>
<span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;Test2 -&gt; Test2</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">lastMatch</span> <span class="o">=</span> <span class="n">lastMatch</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">currentIndex</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span>
  <span class="k">if</span> <span class="n">totalLength</span> <span class="o">&gt;</span> <span class="n">currentIndex</span> <span class="p">{</span>
    <span class="c1">// Remaining string exists</span>
    <span class="k">let</span> <span class="nv">restString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">currentIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">totalLength</span> <span class="o">-</span> <span class="n">currentIndex</span><span class="p">)))</span>
    <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">restString</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// lastMatch = nil means no tags found, all plain text</span>
  <span class="k">let</span> <span class="nv">restString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totalLength</span><span class="p">))</span>
  <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">restString</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Check if stack is empty; if not, mark unmatched Start Tags as isolated</span>
<span class="k">for</span> <span class="n">stackStartItem</span> <span class="k">in</span> <span class="n">stackStartItems</span> <span class="p">{</span>
  <span class="n">stackStartItem</span><span class="o">.</span><span class="n">isIsolated</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">needFormatter</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">tokenizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.webp" alt="Operation process as shown above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjcyNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation process is shown in the above diagram.</p><p>The final result will be an array of tokenization results.</p><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLStringToParsedResultProcessor.swift" target="_blank">HTMLStringToParsedResultProcessor.swift</a></p></blockquote><h3 id="normalization"><span class="me-2">Normalization</span><a href="#normalization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a Formatter, normalization</p></blockquote><p>After obtaining the preliminary parsing results in the previous step, if normalization is still needed during parsing, this step is required to automatically fix HTML tag issues.</p><p><strong>There are three types of HTML tag issues:</strong></p><ul><li><p>HTML Tag but Missing Close Tag: for example <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code></p><li><p>Plain text treated as HTML Tag: for example <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code></p><li><p>HTML Tag misalignment issue: For example, <code class="language-plaintext highlighter-rouge">&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;</code></p></ul><p>The fix is simple. We need to iterate through the elements of the Tokenization result and try to fill in the missing parts.</p><p><a href="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.webp" alt="Operation process as shown above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjMzMiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The workflow is shown in the above diagram.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">normalizationResult</span> <span class="o">=</span> <span class="n">tokenizationResult</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">itemIndex</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">newItems</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">newItems</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isIsolated</span> <span class="p">{</span>
            <span class="c1">// If it is an isolated Start Tag</span>
            <span class="k">if</span> <span class="kt">WC3HTMLTagName</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">?</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">??</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// If not a WC3 defined HTML Tag &amp; has no HTML Attributes</span>
                <span class="c1">// See Source Code for WC3HTMLTagName Enum</span>
                <span class="c1">// Considered as normal text mistaken as HTML Tag</span>
                <span class="c1">// Change to raw string type</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Otherwise, convert to self-closing tag, e.g. &lt;br&gt; -&gt; &lt;br/&gt;</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="nf">convertToSelfClosingParsedItem</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Normal Start Tag, push to Stack</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Encounter Close Tag</span>
        <span class="c1">// Get Tags between Start Stack Tag and this Close Tag</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; gap 0</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; gap b,u</span>

        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItems</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurredIndex</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">upTo</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">))</span>
        
        <span class="c1">// gap 0 means tags are correctly nested</span>
        <span class="k">guard</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// is pair, pop</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="c1">// There are intermediate tags, auto-insert missing tags before and after</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt;</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/b&gt;&lt;/u&gt;&lt;/a&gt;&lt;b&gt;&lt;/u&gt;&lt;/u&gt;&lt;/b&gt;</span>
        <span class="k">let</span> <span class="nv">stackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">let</span> <span class="nv">afterItems</span> <span class="o">=</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="k">let</span> <span class="nv">beforeItems</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="nf">convertToCloseParsedItem</span><span class="p">())</span> <span class="p">})</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">afterItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">))</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">beforeItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span>
        
        <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span> <span class="o">+</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span>
        
        <span class="c1">// Update Start Stack Tags</span>
        <span class="c1">// e.g. -&gt; b,u</span>
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">startItem</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">through</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">startItem</span> <span class="p">})</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="n">selfClosing</span><span class="p">,</span> <span class="o">.</span><span class="nv">rawString</span><span class="p">:</span>
        <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">normalizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultFormatterProcessor.swift" target="_blank">HTMLParsedResultFormatterProcessor.swift</a></p></blockquote><h3 id="abstract-syntax-tree"><span class="me-2">Abstract Syntax Tree</span><a href="#abstract-syntax-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a AST, Abstract Syntax Tree</p></blockquote><p>After completing data preprocessing with Tokenization &amp; Normalization, the next step is to convert the results into an abstract tree üå≤.</p><p><a href="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.webp" alt="As shown above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDI4IiBoZWlnaHQ9IjU4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>As shown in the image above</p><p>Converting to an abstract syntax tree makes future operations and expansions easier, such as implementing Selector functionality or other conversions like HTML to Markdown. Similarly, if we want to add Markdown to NSAttributedString later, we only need to implement Markdown tokenization and normalization to achieve it.</p><p><strong>First, we define a Markup Protocol with Child &amp; Parent properties to record leaf and branch information:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">Markup</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="p">:</span> <span class="kt">MarkupVisitor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Additionally, use the <a href="/posts/zrealm-dev/en/visitor-pattern-in-ios-swift-design-pattern-practical-applications-ba5773a7bfea/">Visitor Pattern</a> to define each style attribute as an Element object, then apply different Visit strategies to obtain individual application results.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">Result</span>
        
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Basic Markup Elements:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">// Root node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RootMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Leaf node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RawStringMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedString</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Define Markup Style Nodes:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// Branch nodes:</span>

<span class="c1">// Link style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">LinkMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Bold style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BoldMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/Markup" target="_blank">Markup</a></p></blockquote><p>Before converting to an abstract tree, we also need to‚Ä¶</p><h4 id="markupcomponent"><span class="me-2">MarkupComponent</span><a href="#markupcomponent" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Because our tree structure does not depend on any data structure (for example, a node/LinkMarkup should have URL information to proceed with rendering).</strong><br /> <strong>Therefore, we define a separate container to store tree nodes and their related data:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">T</span>
    <span class="k">var</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Sequence</span> <span class="k">where</span> <span class="kt">Iterator</span><span class="o">.</span><span class="kt">Element</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">markup</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})?</span><span class="o">.</span><span class="n">value</span> <span class="k">as?</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupComponent" target="_blank">MarkupComponent</a> in the source code</p></blockquote><p>You can also declare Markup as <code class="language-plaintext highlighter-rouge">Hashable</code> and directly use a Dictionary to store values <code class="language-plaintext highlighter-rouge">[Markup: Any]</code>. However, Markup cannot be used as a regular type and must be written as <code class="language-plaintext highlighter-rouge">any Markup</code>.</p><h4 id="htmltag--htmltagname--htmltagnamevisitor"><span class="me-2">HTMLTag &amp; HTMLTagName &amp; HTMLTagNameVisitor</span><a href="#htmltag--htmltagname--htmltagnamevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For the HTML Tag Name section, we added a layer of abstraction, allowing users to decide which tags need to be processed. This also makes future expansion easier. For example, the <code class="language-plaintext highlighter-rouge">&lt;strong&gt;</code> tag name can also correspond to <code class="language-plaintext highlighter-rouge">BoldMarkup</code>.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>public protocol HTMLTagName {
    var string: String { get }
    func accept&lt;V: HTMLTagNameVisitor&gt;(_ visitor: V) -&gt; V.Result
}

public struct A_HTMLTagName: HTMLTagName {
    public let string: String = WC3HTMLTagName.a.rawValue
    
    public init() {
        
    }
    
    public func accept&lt;V&gt;(_ visitor: V) -&gt; V.Result where V : HTMLTagNameVisitor {
        return visitor.visit(self)
    }
}

public struct B_HTMLTagName: HTMLTagName {
    public let string: String = WC3HTMLTagName.b.rawValue
    
    public init() {
        
    }
    
    public func accept&lt;V&gt;(_ visitor: V) -&gt; V.Result where V : HTMLTagNameVisitor {
        return visitor.visit(self)
    }
}
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code of <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagNameVisitor.swift" target="_blank">HTMLTagNameVisitor</a></p></blockquote><blockquote><p>Also refer to the W3C wiki listing HTML tag name enums: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/WC3HTMLTagName.swift" target="_blank">WC3HTMLTagName.swift</a></p></blockquote><p><strong>HTMLTag is simply a container object because we want to allow external specification of the styles corresponding to the HTML tag, so we declare a container to group them together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTag</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span>
    <span class="k">let</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="c1">// Explained later in Render section</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">customStyle</span> <span class="o">=</span> <span class="n">customStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTag.swift3" target="_blank">HTMLTag</a></p></blockquote><h4 id="htmltagnametohtmlmarkupvisitor"><span class="me-2">HTMLTagNameToHTMLMarkupVisitor</span><a href="#htmltagnametohtmlmarkupvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">Markup</span>
    
    <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">A_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">LinkMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">B_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">BoldMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagNameToHTMLMarkupVisitor.swift" target="_blank">HTMLTagNameToHTMLMarkupVisitor</a> in the source code</p></blockquote><h4 id="convert-to-abstract-syntax-tree-with-html-data"><span class="me-2">Convert to Abstract Syntax Tree with HTML Data</span><a href="#convert-to-abstract-syntax-tree-with-html-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We need to convert the normalized HTML data into an abstract tree. First, declare a MarkupComponent data structure to store the HTML data:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">HTMLElement</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">HTMLTag</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    <span class="p">}</span>
    
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">HTMLElement</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Convert to Markup Abstract Tree:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">htmlElementComponents</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">let</span> <span class="nv">rootMarkup</span> <span class="o">=</span> <span class="kt">RootMarkup</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="o">=</span> <span class="n">rootMarkup</span>

<span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">HTMLTag</span><span class="p">]</span>
<span class="nf">init</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span> <span class="o">=</span> <span class="kt">Dictionary</span><span class="p">(</span><span class="nv">uniqueKeysWithValues</span><span class="p">:</span> <span class="n">htmlTags</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// Start Tags Stack, ensure correct pop of tags</span>
<span class="c1">// Normalization has been done before, so errors are unlikely, just to be safe</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">thisItem</span> <span class="k">in</span> <span class="n">from</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">thisItem</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="c1">// Use Visitor to get the corresponding Markup</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        
        <span class="c1">// Add self as a leaf node of the current branch</span>
        <span class="c1">// Become the current branch node</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">markup</span>
        
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Directly add as a leaf node of the current branch</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">lastTagName</span> <span class="o">=</span> <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">popLast</span><span class="p">()?</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span>
           <span class="n">lastTagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">{</span>
            <span class="c1">// When encountering a Close Tag, return to the previous level</span>
            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="p">??</span> <span class="n">currentMarkup</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="k">let</span> <span class="nv">attributedString</span><span class="p">):</span>
        <span class="c1">// Directly add as a leaf node of the current branch</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(htmlElementComponents)</span>
<span class="c1">// [(markup: LinkMarkup, (tag: a, attributes: ["href":"zhgchg.li"]...)]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.webp" alt="The operation result is shown in the above image" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE0IiBoZWlnaHQ9Ijc0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation result is shown in the above image.</p><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift" target="_blank">HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift</a></p></blockquote><h4 id="at-this-point-we-have-actually-completed-the-selector-functionality-"><span class="me-2">At this point, we have actually completed the Selector functionality üéâ</span><a href="#at-this-point-we-have-actually-completed-the-selector-functionality-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="kt">HTMLSelector</span><span class="p">:</span> <span class="kt">CustomStringConvertible</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">componets</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">componets</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">componets</span> <span class="o">=</span> <span class="n">componets</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">filter</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">HTMLSelector</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="n">componets</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span> <span class="p">??</span> <span class="kc">false</span> <span class="p">})</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">componets</span><span class="p">:</span> <span class="n">componets</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can filter leaf node objects layer by layer.</p><blockquote><p>Corresponding implementation in the source code for <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLSelector.swift" target="_blank">HTMLSelector</a></p></blockquote><h3 id="parser--html-to-markupstyle-abstract-of-nsattributedstringkey"><span class="me-2">Parser ‚Äî HTML to MarkupStyle (Abstract of NSAttributedString.Key)</span><a href="#parser--html-to-markupstyle-abstract-of-nsattributedstringkey" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, we need to complete the conversion from HTML to MarkupStyle (NSAttributedString.Key).</p><p>NSAttributedString sets text styles through NSAttributedString.Key attributes. We abstract all fields of NSAttributedString.Key to correspond to MarkupStyle, MarkupStyleColor, MarkupStyleFont, and MarkupStyleParagraphStyle.</p><p><strong>Purpose:</strong></p><ul><li><p>The original data structure for Attributes is <code class="language-plaintext highlighter-rouge">[NSAttributedString.Key: Any?]</code>. If exposed directly, it‚Äôs hard to control the values users provide, and incorrect values can cause crashes, such as <code class="language-plaintext highlighter-rouge">.font: 123</code>.</p><li><p>Styles need to be inheritable. For example, in <code class="language-plaintext highlighter-rouge">&lt;a&gt;&lt;b&gt;test&lt;/b&gt;&lt;/a&gt;</code>, the style of the text ‚Äútest‚Äù should inherit both the link and bold styles (bold + link). Exposing the Dictionary directly makes it difficult to control inheritance properly.</p><li><p>Encapsulating iOS/macOS (UIKit/AppKit) Objects</p></ul><h4 id="markupstyle-struct"><span class="me-2">MarkupStyle Struct</span><a href="#markupstyle-struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyle</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">font</span><span class="p">:</span><span class="kt">MarkupStyleFont</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span><span class="kt">MarkupStyleParagraphStyle</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">foregroundColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">ligature</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">kern</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tracking</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughStyle</span><span class="p">:</span><span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineStyle</span><span class="p">:</span><span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeWidth</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">shadow</span><span class="p">:</span><span class="kt">NSShadow</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textEffect</span><span class="p">:</span><span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">attachment</span><span class="p">:</span><span class="kt">NSTextAttachment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">link</span><span class="p">:</span><span class="kt">URL</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baselineOffset</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughColor</span><span class="p">:</span><span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">obliqueness</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">expansion</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">writingDirection</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">verticalGlyphForm</span><span class="p">:</span><span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>

    <span class="c1">// Inherited from...</span>
    <span class="c1">// Default: If field is nil, fill from the current data object 'from'</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">from</span> <span class="o">=</span> <span class="n">from</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="k">var</span> <span class="nv">currentFont</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">font</span>
        <span class="n">currentFont</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">currentFont</span>
        
        <span class="k">var</span> <span class="nv">currentParagraphStyle</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span>
        <span class="n">currentParagraphStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span> <span class="o">=</span> <span class="n">currentParagraphStyle</span>
        <span class="c1">//..</span>
    <span class="p">}</span>

    <span class="c1">// MarkupStyle to NSAttributedString.Key: Any</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="nf">getFont</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">font</span><span class="p">]</span> <span class="o">=</span> <span class="n">font</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">ligature</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">ligature</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">ligature</span><span class="p">]</span> <span class="o">=</span> <span class="n">ligature</span>
        <span class="p">}</span>
        <span class="c1">//...</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleFont</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeight</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">style</span><span class="p">(</span><span class="kt">FontWeightStyle</span><span class="p">)</span>
        <span class="k">case</span> <span class="nf">rawValue</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeightStyle</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ultraLight</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">regular</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">semibold</span><span class="p">,</span> <span class="n">bold</span><span class="p">,</span> <span class="n">heavy</span><span class="p">,</span> <span class="n">black</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">weight</span><span class="p">:</span> <span class="kt">FontWeight</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">italic</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleParagraphStyle</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineSpacing</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacing</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">alignment</span><span class="p">:</span><span class="kt">NSTextAlignment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">headIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tailIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">firstLineHeadIndent</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">minimumLineHeight</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">maximumLineHeight</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakMode</span><span class="p">:</span><span class="kt">NSLineBreakMode</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baseWritingDirection</span><span class="p">:</span><span class="kt">NSWritingDirection</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineHeightMultiple</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacingBefore</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">hyphenationFactor</span><span class="p">:</span><span class="kt">Float</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">usesDefaultHyphenation</span><span class="p">:</span><span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tabStops</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextTab</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">defaultTabInterval</span><span class="p">:</span><span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textLists</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextList</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">allowsDefaultTighteningForTruncation</span><span class="p">:</span><span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakStrategy</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="o">.</span><span class="kt">LineBreakStrategy</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleColor</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">red</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupStyle" target="_blank">MarkupStyle</a> in the source code</p></blockquote><blockquote><p>Also refer to the W3c wiki, browser predefined color name listing corresponding color name text &amp; color R,G,B enum: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleColorName.swift" target="_blank">MarkupStyleColorName.swift</a></p></blockquote><h4 id="htmltagstyleattribute--htmltagstyleattributevisitor"><span class="me-2">HTMLTagStyleAttribute &amp; HTMLTagStyleAttributeVisitor</span><a href="#htmltagstyleattribute--htmltagstyleattributevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Here, let‚Äôs mention these two objects again, because HTML tags allow styling through CSS; similarly, we apply the same abstraction used for HTMLTagName to the HTML style attribute.</p><p>For example, HTML might give: <code class="language-plaintext highlighter-rouge">&lt;a style=‚Äùcolor:red;font-size:14px‚Äù&gt;RedLink&lt;/a&gt;</code>, which means the link should be set to red color and size 14px.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>public protocol HTMLTagStyleAttribute {
    var styleName: String { get }
    
    func accept&lt;V: HTMLTagStyleAttributeVisitor&gt;(_ visitor: V) -&gt; V.Result
}

public protocol HTMLTagStyleAttributeVisitor {
    associatedtype Result
    
    func visit(styleAttribute: HTMLTagStyleAttribute) -&gt; Result
    func visit(_ styleAttribute: ColorHTMLTagStyleAttribute) -&gt; Result
    func visit(_ styleAttribute: FontSizeHTMLTagStyleAttribute) -&gt; Result
    //...
}

public extension HTMLTagStyleAttributeVisitor {
    func visit(styleAttribute: HTMLTagStyleAttribute) -&gt; Result {
        return styleAttribute.accept(self)
    }
}
</pre></table></code></div></div><blockquote><p>Implementation corresponding to <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagStyleAttribute" target="_blank">HTMLTagStyleAttribute</a> in the source code</p></blockquote><h4 id="htmltagstyleattributetomarkupstylevisitor"><span class="me-2">HTMLTagStyleAttributeToMarkupStyleVisitor</span><a href="#htmltagstyleattributetomarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Regex extract Color Hex or Mapping from HTML Pre-defined Color Name, see Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="kt">MarkupStyleColor</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">foregroundColor</span><span class="p">:</span> <span class="n">color</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Regex extract 10px -&gt; 10, see Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="nv">fromPX</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">font</span><span class="p">:</span> <span class="kt">MarkupStyleFont</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagAttributeToMarkupStyleVisitor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a></p></blockquote><p>The value of init is set to the attribute‚Äôs value, converted to the corresponding MarkupStyle field based on the visit type.</p><h4 id="htmlelementmarkupcomponentmarkupstylevisitor"><span class="me-2">HTMLElementMarkupComponentMarkupStyleVisitor</span><a href="#htmlelementmarkupcomponentmarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After introducing the MarkupStyle object, we will convert the Normalization‚Äôs HTMLElementComponents result into MarkupStyle.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="c1">// MarkupStyle Policy</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">MarkupStylePolicy</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromCode</span> <span class="c1">// Prioritize code-based styles, fill in with HTML Style Attribute</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromHTMLStyleAttribute</span> <span class="c1">// Prioritize HTML Style Attribute, fill in with code-based styles</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>

    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>

    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .bold is just the default style defined in MarkupStyle, please refer to Source Code</span>
        <span class="k">return</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">bold</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .link is just the default style defined in MarkupStyle, please refer to Source Code</span>
        <span class="k">var</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">link</span><span class="p">)</span> <span class="p">??</span> <span class="o">.</span><span class="n">link</span>
        
        <span class="c1">// Get the HtmlElement corresponding to LinkMarkup from HtmlElementComponents</span>
        <span class="c1">// Find href parameter in HtmlElement's attributes (HTML URL string)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">href</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"href"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">markupStyle</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">url</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span> <span class="p">{</span>
    <span class="c1">// Get the customized MarkupStyle specified in the HTMLTag container</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">customStyle</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">customStyle</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">customStyle</span>
    <span class="p">}</span>
    
    <span class="c1">// Default action</span>
    <span class="kd">func</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?,</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">htmlElement</span><span class="p">)</span> <span class="p">??</span> <span class="n">defaultStyle</span>
        <span class="c1">// Get the HtmlElement corresponding to LinkMarkup from HtmlElementComponents</span>
        <span class="c1">// Check if HtmlElement's attributes contain a `style` attribute</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">styleString</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">],</span>
              <span class="n">styleAttributes</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// None found</span>
            <span class="k">return</span> <span class="n">markupStyle</span>
        <span class="p">}</span>

        <span class="c1">// Has Style Attributes</span>
        <span class="c1">// Split Style Value string into array</span>
        <span class="c1">// font-size:14px;color:red -&gt; ["font-size":"14px","color":"red"]</span>
        <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">styleString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="n">style</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="c1">// e.g. font-size</span>
            <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            <span class="c1">// e.g. 14px</span>
            <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttribute</span> <span class="o">=</span> <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
                <span class="c1">// Use the HTMLTagStyleAttributeToMarkupStyleVisitor above to convert back to MarkupStyle</span>
                <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">var</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">styleAttribute</span><span class="p">:</span> <span class="n">styleAttribute</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// When Style Attribute has a converted value...</span>
                    <span class="c1">// Merge with previous MarkupStyle result</span>
                    <span class="n">thisMarkupStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                    <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// If there is a default Style</span>
        <span class="k">if</span> <span class="k">var</span> <span class="nv">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">policy</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromHTMLStyleAttribute</span><span class="p">:</span>
                  <span class="c1">// Style Attribute MarkupStyle takes priority,</span>
                  <span class="c1">// then merge defaultStyle result</span>
                    <span class="n">markupStyle</span><span class="p">?</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">defaultStyle</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromCode</span><span class="p">:</span>
                  <span class="c1">// defaultStyle takes priority,</span>
                  <span class="c1">// then merge Style Attribute MarkupStyle result</span>
                  <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                  <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagAttributeToMarkupStyleVisitor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a></p></blockquote><p>We define some default styles in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyle%2BExtension.swift" target="_blank">MarkupStyle</a>. If a Markup does not have a style specified from outside the Code for its Tag, the default style will be used.</p><p><strong>There are two style inheritance strategies:</strong></p><ul><li><p>respectMarkupStyleFromCode:<br /> Use the default style as the base; then check the Style Attributes to see what styles can be added. If a value already exists, ignore it.</p><li><p>respectMarkupStyleFromHTMLStyleAttribute:<br /> Prioritize Style Attributes; then check the default styles to see what can be added. Ignore if the value already exists.</p></ul><h4 id="htmlelementwithmarkuptomarkupstyleprocessor"><span class="me-2">HTMLElementWithMarkupToMarkupStyleProcessor</span><a href="#htmlelementwithmarkuptomarkupstyleprocessor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Convert the normalization results into AST &amp; MarkupStyleComponent.</p><p><strong>Declare a new MarkupComponent to store the corresponding MarkupStyle this time:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupStyleComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">MarkupStyle</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Simple traversal of a Markup Tree &amp; HTMLElementMarkupComponent structure:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    
<span class="kd">func</span> <span class="nf">process</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="p">(</span><span class="kt">Markup</span><span class="p">,</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">)</span>
  <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">components</span>
<span class="p">}</span>
    
<span class="kd">func</span> <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">])</span> <span class="p">{</span>
        
  <span class="k">if</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">components</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
  <span class="p">}</span>
        
  <span class="k">for</span> <span class="n">markup</span> <span class="k">in</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span> <span class="p">{</span>
    <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(components)</span>
<span class="c1">// [(markup: LinkMarkup, MarkupStyle(link: https://zhgchg.li, color: .blue)]</span>
<span class="c1">// [(markup: BoldMarkup, MarkupStyle(font: .init(weight: .bold))]</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLElementWithMarkupToMarkupStyleProcessor.swift" target="_blank">HTMLElementWithMarkupToMarkupStyleProcessor.swift</a></p></blockquote><p><a href="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.webp" alt="The process result is shown in the above image" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE0IiBoZWlnaHQ9IjExMTAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>The process result is shown in the above image.</p><h3 id="render--convert-to-nsattributedstring"><span class="me-2">Render ‚Äî Convert To NSAttributedString</span><a href="#render--convert-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we have the HTML Tag abstract tree structure and the corresponding MarkupStyle for each HTML Tag, the final step is to generate the final NSAttributedString rendering result.</p><h4 id="markupnsattributedstringvisitor"><span class="me-2">MarkupNSAttributedStringVisitor</span><a href="#markupnsattributedstringvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To convert HTML markup to NSAttributedString in iOS, you can use the following Swift code snippet:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">UIKit</span>

<span class="k">let</span> <span class="nv">htmlString</span> <span class="o">=</span> <span class="s">"&lt;p&gt;This is &lt;strong&gt;bold&lt;/strong&gt; and &lt;em&gt;italic&lt;/em&gt; text.&lt;/p&gt;"</span>

<span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">htmlString</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">NSAttributedString</span><span class="p">(</span>
            <span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nv">documentType</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span>
                      <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span><span class="p">],</span>
            <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="c1">// Use attributedString as needed</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Error creating attributed string: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupNSAttributedStringVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">NSAttributedString</span>
    
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span>
    <span class="c1">// root / base MarkupStyle, specified externally, e.g., can set the font size for the entire string</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to RawString objects</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Return Raw String</span>
        <span class="c1">// Collect all MarkupStyles in the chain</span>
        <span class="c1">// Apply Style to NSAttributedString</span>
        <span class="k">return</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to RawString objects</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to RawString objects</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">MarkupNSAttributedStringVisitor</span> <span class="p">{</span>
    <span class="c1">// Apply Style to NSAttributedString</span>
    <span class="kd">func</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">markupStyle</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">attributedString</span> <span class="p">}</span>
        <span class="k">let</span> <span class="nv">mutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">)</span>
        <span class="n">mutableAttributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">markupStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(),</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mutableAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mutableAttributedString</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSMutableAttributedString</span> <span class="p">{</span>
        <span class="c1">// collect from downstream</span>
        <span class="c1">// Root -&gt; Bold -&gt; String("Bold")</span>
        <span class="c1">//      \</span>
        <span class="c1">//       &gt; String("Test")</span>
        <span class="c1">// Result: Bold Test</span>
        <span class="c1">// Recursively look down layer by layer for raw strings, visit and combine into final NSAttributedString</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
            <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">partialResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="c1">// collect from upstream</span>
        <span class="c1">// String("Test") -&gt; Bold -&gt; Italic -&gt; Root</span>
        <span class="c1">// Result: style: Bold+Italic</span>
        <span class="c1">// Look up layer by layer for parent tag's markup style</span>
        <span class="c1">// Then inherit styles layer by layer</span>
        <span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="k">while</span> <span class="k">let</span> <span class="nv">thisMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">thisMarkup</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
                <span class="k">continue</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="k">var</span> <span class="nv">thisCurrentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
                <span class="n">thisCurrentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">thisMarkupStyle</span><span class="p">)</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisCurrentStyle</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
            <span class="p">}</span>

            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
            <span class="n">currentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">currentStyle</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">rootStyle</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupNSAttributedStringVisitor.swift" target="_blank">MarkupNSAttributedStringVisitor.swift</a></p></blockquote><p><a href="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.webp" alt="Operation process and results as shown above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjk4IiBoZWlnaHQ9IjExMTQiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>The operation process and results are shown in the above image.</p><p><strong>In the end, we can get:</strong></p><p><a href="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTIiIGhlaWdodD0iMjU4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">Li</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d17600&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Regular</span><span class="se">\"</span><span class="s">; font-weight: normal; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="n">nk</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="kt">Bold</span><span class="p">{</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>üéâüéâüéâüéâCompletedüéâüéâüéâüéâ</p></blockquote><p>At this point, we have completed the entire process of converting an HTML String to NSAttributedString.</p><h4 id="stripper--remove-html-tags"><span class="me-2">Stripper ‚Äî Remove HTML Tags</span><a href="#stripper--remove-html-tags" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Removing HTML tags is relatively simple and only requires:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">attributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">rawStringMarkup</span> <span class="o">=</span> <span class="n">markup</span> <span class="k">as?</span> <span class="kt">RawStringMarkup</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rawStringMarkup</span><span class="o">.</span><span class="n">attributedString</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">attributedString</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
      <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">partialResult</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupStripperProcessor.swift" target="_blank">MarkupStripperProcessor.swift</a></p></blockquote><p>Similar to Render, but simply finds RawStringMarkup and returns the content.</p><h4 id="extend--dynamic-expansion"><span class="me-2">Extend ‚Äî Dynamic Expansion</span><a href="#extend--dynamic-expansion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To cover all HTML Tags and Style Attributes, a dynamic extension point was created to allow direct dynamic extension of objects from the code.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">w3cHTMLTagName</span><span class="p">:</span> <span class="kt">WC3HTMLTagName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">w3cHTMLTagName</span><span class="o">.</span><span class="n">rawValue</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// to</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ExtendMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//----</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendHTMLTagStyleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">render</span><span class="p">:</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?))</span> <span class="c1">// Dynamically change MarkupStyle using closure</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">render</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?)))</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">styleName</span> <span class="o">=</span> <span class="n">styleName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="zhtmlparserbuilder"><span class="me-2">ZHTMLParserBuilder</span><a href="#zhtmlparserbuilder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, we use the Builder Pattern to allow external modules to quickly construct the objects required by ZMarkupParser, while implementing proper access level control.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span> <span class="o">=</span> <span class="o">.</span><span class="n">respectMarkupStyleFromCode</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">func</span> <span class="nf">initWithDefault</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">builder</span> <span class="o">=</span> <span class="k">Self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">htmlTagName</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">htmlTagNames</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">styleAttribute</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">styleAttributes</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">builder</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">withCustomStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="c1">// Only one tagName can exist</span>
        <span class="n">htmlTags</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">htmlTag</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="n">htmlTagName</span><span class="o">.</span><span class="n">string</span>
        <span class="p">}</span>
        
        <span class="n">htmlTags</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">styleAttributes</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">thisStyleAttribute</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">thisStyleAttribute</span><span class="o">.</span><span class="n">styleName</span> <span class="o">==</span> <span class="n">styleAttribute</span><span class="o">.</span><span class="n">styleName</span>
        <span class="p">}</span>
        
        <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">rootStyle</span> <span class="o">=</span> <span class="n">rootStyle</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ZHTMLParser</span> <span class="p">{</span>
        <span class="c1">// ZHTMLParser init is internal only, cannot be directly initialized externally</span>
        <span class="c1">// Can only be initialized via ZHTMLParserBuilder</span>
        <span class="k">return</span> <span class="kt">ZHTMLParser</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="n">htmlTags</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">,</span> <span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the source code <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParserBuilder.swift" target="_blank">ZHTMLParserBuilder.swift</a></p></blockquote><p><strong>initWithDefault will include all implemented HTMLTagName/Style Attributes by default</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">htmlTagNames</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagName</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">A_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">B_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">BR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DIV_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">HR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">I_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">LI_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">OL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">P_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">SPAN_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">STRONG_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">U_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">UL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DEL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TD_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TH_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TABLE_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">IMG_HTMLTagName</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">BackgroundColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontWeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">LineHeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">WordSpacingHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>ZHTMLParser init is only internal, so it cannot be directly initialized externally. It can only be initialized through ZHTMLParserBuilder.</p><p><strong>ZHTMLParser encapsulates Render/Selector/Stripper operations:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParser</span><span class="p">:</span> <span class="kt">ZMarkupParser</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>

    <span class="kd">internal</span> <span class="nf">init</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="c1">// Get link style attributes</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">linkTextAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="c1">// Allow rendering NSAttributedString inside nodes using HTMLSelector results</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">selector</span><span class="p">:</span> <span class="kt">HTMLSelector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Implementation corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParser.swift" target="_blank">ZHTMLParser.swift</a></p></blockquote><h4 id="uikit-issues"><span class="me-2">UIKit Issues</span><a href="#uikit-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The most common use of NSAttributedString is to display it in a UITextView, but be aware:</p><ul><li><p>The link style in UITextView is uniformly determined by the <code class="language-plaintext highlighter-rouge">linkTextAttributes</code> setting and does not consider the NSAttributedString.Key settings. Individual link styles cannot be set; this is why <code class="language-plaintext highlighter-rouge">ZMarkupParser.linkTextAttributes</code> exists as an interface.</p><li><p>UILabel currently does not support changing link styles, and since UILabel lacks TextStorage, loading NSTextAttachment images requires additional handling of UILabel.</p></ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UITextView</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">linkTextAttributes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">linkTextAttributes</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UILabel</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">enumerateAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">attachment</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">),</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">effectiveRange</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="n">value</span> <span class="k">as?</span> <span class="kt">ZNSTextAttachment</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="n">attachment</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Therefore, by extending UIKit, external code only needs to simply call <code class="language-plaintext highlighter-rouge">setHTMLString()</code> to complete the binding.</p><h4 id="complex-rendering-items--item-list"><span class="me-2">Complex Rendering Items ‚Äî Item List</span><a href="#complex-rendering-items--item-list" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Record of the implementation of the project list.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;ol&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;ul&gt;</code> to wrap <code class="language-plaintext highlighter-rouge">&lt;li&gt;</code> in HTML indicates a list of items:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemA<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemB<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemC<span class="nt">&lt;/li&gt;</span>
    //...
<span class="nt">&lt;/ul&gt;</span>
</pre></table></code></div></div><p>Using the same parsing method as before, we can obtain other list items and know the current list index in <code class="language-plaintext highlighter-rouge">visit(_ markup: ListItemMarkup)</code> (thanks to the conversion to AST).</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">ListItemMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">siblingListItems</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">ListItemMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingListItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>NSParagraphStyle has an NSTextList object that can be used to display list items, but it does not allow customization of the space width (I personally find the space too wide). If there is a space between the bullet and the string, line breaks will occur there, causing the display to look a bit odd, as shown below:</p><p><a href="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODYiIGhlaWdodD0iMzkyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>The Beter part might be achievable through <a href="https://www.objc.io/issues/9-strings/string-rendering/" target="_blank">setting headIndent, firstLineHeadIndent, NSTextTab</a>, but tests showed that with long strings or size changes, the result still cannot be perfectly displayed.</p><p>Currently only achieves Acceptable by inserting the combined item list string at the beginning of the string.</p><p>We only use NSTextList.MarkerFormat for list item symbols, not NSTextList directly.</p><p><strong>The supported list symbols can be found here:</strong> <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleList.swift" target="_blank">MarkupStyleList.swift</a></p><p><strong>Final display result: (</strong> <code class="language-plaintext highlighter-rouge">&lt;ol&gt;&lt;li&gt;</code> <strong>)</strong></p><p><a href="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNzgiIGhlaWdodD0iMTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="complex-rendering-items--table"><span class="me-2">Complex Rendering Items ‚Äî Table</span><a href="#complex-rendering-items--table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Similar to implementing list items, but in a table.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code> in HTML to create tables -&gt; wrapping <code class="language-plaintext highlighter-rouge">&lt;tr&gt;</code> for table rows -&gt; wrapping <code class="language-plaintext highlighter-rouge">&lt;td&gt;/&lt;th&gt;</code> to represent table cells:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Company<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Contact<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Country<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Alfreds Futterkiste<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Maria Anders<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Germany<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Centro comercial Moctezuma<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Francisco Chang<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Mexico<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></table></code></div></div><p>Testing shows that the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code> uses the private macOS API <code class="language-plaintext highlighter-rouge">NSTextBlock</code> for rendering, allowing full display of HTML table styles and content.</p><blockquote><p>A bit of cheating! We can‚Äôt use Private API ü•≤</p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre>    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableColumnMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">siblingColumns</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
        <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingColumns</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1">// Whether a desired width is specified externally, can set .max to avoid truncated string</span>
        <span class="k">var</span> <span class="nv">maxLength</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">fixedMaxLength</span>
        <span class="k">if</span> <span class="n">maxLength</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// If not specified, find the string length of the first row in the same column as max length</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">tableRowMarkup</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span><span class="p">,</span>
               <span class="k">let</span> <span class="nv">firstTableRow</span> <span class="o">=</span> <span class="n">tableRowMarkup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableRowMarkup</span> <span class="p">})</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">firstTableRowColumns</span> <span class="o">=</span> <span class="n">firstTableRow</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span>
                <span class="k">if</span> <span class="n">firstTableRowColumns</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">firstTableRowColumnAttributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">firstTableRowColumns</span><span class="p">[</span><span class="n">position</span><span class="p">])</span>
                    <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="n">firstTableRowColumnAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span>
                    <span class="n">maxLength</span> <span class="o">=</span> <span class="n">length</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">maxLength</span> <span class="o">=</span> <span class="n">maxLength</span> <span class="p">{</span>
            <span class="c1">// If the field exceeds maxLength, truncate the string</span>
            <span class="k">if</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxLength</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="n">maxLength</span><span class="p">))</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">padding</span><span class="p">(</span><span class="nv">toLength</span><span class="p">:</span> <span class="n">maxLength</span><span class="p">,</span> <span class="nv">withPad</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">startingAt</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">siblingColumns</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
            <span class="c1">// Add spaces as spacing; external can specify how many spaces for spacing width</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeString</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="n">markup</span><span class="o">.</span><span class="n">spacing</span><span class="p">)))</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableRowMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add newline, see Source Code for details</span>
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add newline, see Source Code for details</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// Add newline, see Source Code for details</span>
        <span class="k">return</span> <span class="n">attributedString</span>
    <span class="p">}</span>
</pre></table></code></div></div><p><strong>The final display effect is as shown in the picture below:</strong></p><p><a href="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNDMiIGhlaWdodD0iOTAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>not perfect, but acceptable.</p><h4 id="complex-rendering-item--image"><span class="me-2">Complex Rendering Item ‚Äî Image</span><a href="#complex-rendering-item--image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, let‚Äôs discuss the biggest challenge: loading remote images into NSAttributedString.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> to represent images in HTML:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span> <span class="na">width=</span><span class="s">"300"</span> <span class="na">height=</span><span class="s">"125"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>You can specify the desired display size using the <code class="language-plaintext highlighter-rouge">width</code> / <code class="language-plaintext highlighter-rouge">height</code> HTML attributes.</p><p>Displaying images in NSAttributedString is much more complicated than expected; there is no good implementation. I encountered some issues before when working on <a href="/posts/zrealm-dev/en/ios-uitextview-text-wrap-editor-swift-implementation-for-seamless-layout-e37d66ea1146/">UITextView Text Wrapping</a>, but after researching again, I found there is still no perfect solution.</p><p>Currently, ignore the native issue that NSTextAttachment cannot reuse and release memory. First, implement downloading images from a remote source to NSTextAttachment, then insert it into NSAttributedString, and achieve automatic content updating.</p><p><strong>This series of operations is further divided into a smaller project for implementation, aiming for easier optimization and reuse in other projects in the future:</strong></p><p><a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/5c63c82d77259bfe295dc17bf3eedc073f2e23dbd9598642813af0bcecb5b701/ZhgChgLi/ZNSTextAttachment" alt="" loading="lazy"></a></p><p>Mainly based on <a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a> series, but replaced the final update part (UI refresh needed after download to display) and added Delegate/DataSource for external extension.</p><p><a href="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.webp" alt="Operation flow and relationships as shown above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjYxMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation process and relationships are shown in the above diagram.</p><ul><li><p>Declare a ZNSTextAttachmentable object that encapsulates an NSTextStorage object (built-in UITextView) and the UILabel itself (UILabel has no NSTextStorage).<br /> The operation method is only to implement replacing attributedString from NSRange. (<code class="language-plaintext highlighter-rouge">func replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code>)</p><li><p>The implementation principle is to first use <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> to wrap the imageURL, PlaceholderImage, and prominent display size information, then directly display the image using the placeholder.</p><li><p>When the system needs this image on the screen, it calls the <code class="language-plaintext highlighter-rouge">image(forBounds‚Ä¶)</code> method, and at this point, we start downloading the Image Data.</p><li><p>DataSource allows external control over how to download or implement Image Cache Policy. By default, it uses URLSession to request image data directly.</p><li><p>After downloading, create a new <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code> and implement the custom image size logic in <code class="language-plaintext highlighter-rouge">attachmentBounds(for‚Ä¶)</code></p><li><p>Call the <code class="language-plaintext highlighter-rouge">replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code> method to replace the position of <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> with <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code></p><li><p>Send didLoad Delegate notification for external integration when needed</p><li><p>Completed</p></ul><blockquote><p><strong>For detailed code, please refer to <a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">Source Code</a></strong> .</p></blockquote><p>The reason for not using <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateLayout(forCharacterRange: range, actualCharacterRange: nil)</code> or <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateDisplay(forCharacterRange: range)</code> to refresh the UI is that the UI does not update correctly. Since the range is already known, directly triggering a replacement of the NSAttributedString ensures the UI updates properly.</p><p>The final display result is as follows:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"color:red"</span><span class="nt">&gt;</span>Hello<span class="nt">&lt;/span&gt;</span>Hello hello <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTciIGhlaWdodD0iMjQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="testing--continuous-integration"><span class="me-2">Testing &amp; Continuous Integration</span><a href="#testing--continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this project, besides writing Unit Tests, Snapshot Tests were also created for integration testing to facilitate comprehensive testing and comparison of the final NSAttributedString.</p><p>The main functional logic has UnitTests and integration tests, with the final <a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">Test Coverage</a> around <strong>85%</strong>.</p><p><a href="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.webp" alt="[ZMarkupParser ‚Äî codecov](https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTQiIGhlaWdodD0iMjAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser ‚Äî codecov</a></p><h4 id="snapshot-test"><span class="me-2">Snapshot Test</span><a href="#snapshot-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b3cc52a5b949767e4cb0af82145ed6474334d3235bd785ee1f7891c6b65fd69a/pointfreeco/swift-snapshot-testing" alt="" loading="lazy"></a></p><p><strong>Directly Importing the Framework:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">SnapshotTesting</span>
<span class="c1">// ...</span>
<span class="kd">func</span> <span class="nf">testShouldKeepNSAttributedString</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="nf">initWithDefault</span><span class="p">()</span><span class="o">.</span><span class="nf">build</span><span class="p">()</span>
  <span class="k">let</span> <span class="nv">textView</span> <span class="o">=</span> <span class="kt">UITextView</span><span class="p">()</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">390</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">isScrollEnabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="o">.</span><span class="n">white</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="s">"html string..."</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">layoutIfNeeded</span><span class="p">()</span>
  <span class="nf">assertSnapshot</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="n">textView</span><span class="p">,</span> <span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="nv">record</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNzUiIGhlaWdodD0iMzE5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>Directly compare the final results to ensure the adjustments and integration have no issues.</p><h4 id="codecov-test-coverage"><span class="me-2">Codecov Test Coverage</span><a href="#codecov-test-coverage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Integrate with <a href="https://about.codecov.io" target="_blank">Codecov.io</a> (free for Public Repos) to assess Test Coverage by simply installing the Codecov GitHub App and configuring it.</p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img src="https://storage.googleapis.com/codecov-cdn/static/Codecov-icon-600x600.png" alt="" loading="lazy"></a></p><p>After setting up Codecov &lt;-&gt; Github Repo, you can also add a <code class="language-plaintext highlighter-rouge">codecov.yml</code> file in the project‚Äôs root directory.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">comment</span><span class="pi">:</span>                  <span class="c1"># this is a top-level key</span>
  <span class="na">layout</span><span class="pi">:</span> <span class="s2">"</span><span class="s">reach,</span><span class="nv"> </span><span class="s">diff,</span><span class="nv"> </span><span class="s">flags,</span><span class="nv"> </span><span class="s">files"</span>
  <span class="na">behavior</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">require_changes</span><span class="pi">:</span> <span class="kc">false</span>  <span class="c1"># if true: only post the comment if coverage changes</span>
  <span class="na">require_base</span><span class="pi">:</span> <span class="s">no</span>        <span class="c1"># [yes :: must have a base report to post]</span>
  <span class="na">require_head</span><span class="pi">:</span> <span class="s">yes</span>       <span class="c1"># [yes :: must have a head report to post]</span>
</pre></table></code></div></div><p>Configuration file, this enables automatic commenting of the CI results on each PR after it is issued.</p><p><a href="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MjAiIGhlaWdodD0iNTg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="continuous-integration"><span class="me-2">Continuous Integration</span><a href="#continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Github Action, CI Integration: <code class="language-plaintext highlighter-rouge">ci.yml</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">opened</span><span class="pi">,</span> <span class="nv">reopened</span><span class="pi">]</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">self-hosted</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spm build and test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">\|</span>
          <span class="s">set -o pipefail</span>
          <span class="s">xcodebuild test -workspace ZMarkupParser.xcworkspace -testPlan ZMarkupParser -scheme ZMarkupParser -enableCodeCoverage YES -resultBundlePath './scripts/TestResult.xcresult' -destination 'platform=iOS Simulator,name=iPhone 14,OS=16.1' build test \| xcpretty</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Codecov</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">codecov/codecov-action@v3.1.1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">xcode</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">xcode_archive_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./scripts/TestResult.xcresult'</span>
</pre></table></code></div></div><p>This setting runs build and test when a PR is opened/reopened or code is pushed to the main branch, and finally uploads the test coverage report to codecov.</p><h4 id="regex"><span class="me-2">Regex</span><a href="#regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Regarding regular expressions, each time I use them, I improve further; this time I didn‚Äôt use them much, but since I initially wanted to use a regex to extract paired HTML tags, I studied how to write them more carefully.</p><p>Some cheat sheet notes I learned this time‚Ä¶</p><ul><li><p><code class="language-plaintext highlighter-rouge">?:</code> allows the ( ) to group the match but does not capture the result<br /> e.g. <code class="language-plaintext highlighter-rouge">(?:https?:\/\/)?(?:www\.)?example\.com</code> will return the entire URL in <code class="language-plaintext highlighter-rouge">https://www.example.com</code> instead of <code class="language-plaintext highlighter-rouge">https://</code> and <code class="language-plaintext highlighter-rouge">www</code></p><li><p><code class="language-plaintext highlighter-rouge">.+?</code> Non-greedy match (returns the nearest match)<br /> e.g. <code class="language-plaintext highlighter-rouge">&lt;.+?&gt;</code> in <code class="language-plaintext highlighter-rouge">&lt;a&gt;test&lt;/a&gt;</code> returns <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;/a&gt;</code> instead of the entire string</p><li><p><code class="language-plaintext highlighter-rouge">(?=XYZ)</code> any string until the substring <code class="language-plaintext highlighter-rouge">XYZ</code> appears; note that a similar pattern <code class="language-plaintext highlighter-rouge">[^XYZ]</code> means any character until <code class="language-plaintext highlighter-rouge">X or Y or Z</code> appears.<br /> e.g. <code class="language-plaintext highlighter-rouge">(?:__)(.+?(?=__))(?:__)</code> (any string until <code class="language-plaintext highlighter-rouge">__</code>) will match <code class="language-plaintext highlighter-rouge">test</code></p><li><p><code class="language-plaintext highlighter-rouge">?R</code> recursively searches inward for the same pattern<br /> e.g. <code class="language-plaintext highlighter-rouge">\((?:[^()]\|((?R)))+\)</code> applied to <code class="language-plaintext highlighter-rouge">(simple) (and(nested))</code> will match <code class="language-plaintext highlighter-rouge">(simple)</code>, <code class="language-plaintext highlighter-rouge">(and(nested))</code>, and <code class="language-plaintext highlighter-rouge">(nested)</code></p><li><p><code class="language-plaintext highlighter-rouge">?&lt;GroupName&gt;</code> ‚Ä¶ <code class="language-plaintext highlighter-rouge">\k&lt;GroupName&gt;</code> matches the previous Group Name<br /> e.g. <code class="language-plaintext highlighter-rouge">(?&lt;tagName&gt;&lt;a&gt;).*(\k&lt;GroupName&gt;)</code></p><li><p><code class="language-plaintext highlighter-rouge">(?(X)yes\|no)</code> matches <code class="language-plaintext highlighter-rouge">yes</code> if the <code class="language-plaintext highlighter-rouge">X</code>th capture group (or Group Name) has a value, otherwise matches <code class="language-plaintext highlighter-rouge">no</code><br /> <strong>Not supported in Swift for now</strong></p></ul><p><strong>Other Great Regex Articles:</strong></p><ul><li><p><a href="https://onevcat.com/2022/11/swift-regex/" target="_blank">Swift Regex Quick Reference</a></p><li><p><a href="https://mp.weixin.qq.com/s/i_C4ATnajxRDGlTA8dJDHg" target="_blank">How Do Regular Expressions Work?</a> -&gt; <strong>Can be referenced for optimizing regex performance in this project later</strong></p><li><p><a href="https://juejin.cn/post/6850418120390082574" target="_blank">Regex error causing infinite search, ultimately leading to server failure case</a></p><li><p><a href="https://regex101.com" target="_blank">Regex101 can be used to look up all regex rules in the bottom right corner</a></p></ul><h4 id="swift-package-manager--cocoapods"><span class="me-2">Swift Package Manager &amp; Cocoapods</span><a href="#swift-package-manager--cocoapods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This is also my first time developing with SPM &amp; Cocoapods‚Ä¶ quite interesting. SPM is really convenient; however, if two projects depend on the same package, opening both projects simultaneously may cause one of them to fail to find the package and not build properly.</p><p>Cocoapods has uploaded ZMarkupParser but hasn‚Äôt tested if it works properly, since I use SPM üòù.</p><h4 id="chatgpt"><span class="me-2">ChatGPT</span><a href="#chatgpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Based on actual development experience, I find it most useful only when helping to polish the Readme; during development, I haven‚Äôt felt any significant benefit. Asking mid-senior level questions often results in unclear or even incorrect answers (for example, I asked about some regex rules and the answers were not quite accurate), so in the end, I still rely on Google to manually find the correct solutions.</p><p>Not to mention asking it to write code, unless it‚Äôs a simple Code Gen Object; otherwise, don‚Äôt expect it to complete the entire tool architecture directly. <em>(At least for now, it seems Copilot might be more helpful for coding tasks)</em></p><p>But it can provide general guidance on knowledge gaps, allowing us to quickly get a rough idea of how certain things should be done. Sometimes, when our grasp is too weak, it‚Äôs hard to quickly find the right direction on Google. In such cases, ChatGPT is quite helpful.</p><h3 id="disclaimer"><span class="me-2">Disclaimer</span><a href="#disclaimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After more than three months of research and development, I am exhausted, but I want to clarify that this approach is only a feasible result from my study. It may not be the best solution and could still be optimized. This project is more like a starting point, hoping to find a perfect solution for Markup Language to NSAttributedString. <strong>Contributions are highly welcome; many aspects still require collective effort to improve.</strong></p><h3 id="contributing"><span class="me-2">Contributing</span><a href="#contributing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.webp" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;} [‚≠ê](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iNDI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a> <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">‚≠ê</a></p><p>Here are some improvements that come to mind at this moment (2023/03/12). They will be recorded in the Repo later:</p><ol><li><p>Performance/algorithm optimization, although faster and more stable than the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code>, still has much room for improvement. I believe its performance is definitely not as good as XMLParser. Hopefully, one day it can achieve the same performance while maintaining customization and automatic error correction.</p><li><p>Support for more HTML Tags and Style Attribute conversion and parsing</p><li><p><a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">ZNSTextAttachment</a> further optimized to enable reuse and release memory; may need to study CoreText</p><li><p>Supports Markdown parsing. Since the underlying abstraction is not limited to HTML, as long as the Markdown-to-Markup object is properly built, Markdown parsing can be completed. Therefore, I named it ZMarkupParser instead of ZHTMLParser, hoping that one day it can also support Markdown to NSAttributedString.</p><li><p>Supports Any to Any, e.g. HTML To Markdown, Markdown To HTML. Since we have the original AST tree (Markup object), it is possible to implement conversion between any Markup formats.</p><li><p>Implementing CSS <code class="language-plaintext highlighter-rouge">!important</code> Functionality to Enhance the Inheritance Strategy of Abstract MarkupStyle</p><li><p>Enhance the HTML Selector feature, which currently only has the most basic filter functionality.</p><li><p>So many, feel free to open an <a href="https://github.com/ZhgChgLi/ZMarkupParser/issues" target="_blank">issue</a></p></ol><blockquote><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">If you want to support but lack the time, you can give me a ‚≠ê so this Repo can be seen by more people, increasing the chance for Github experts to contribute!</a></p></blockquote><h3 id="summary"><span class="me-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjY0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><p>That sums up all the technical details and my journey developing ZMarkupParser. It took me almost three months of after-work and weekend time, countless research and practice sessions, writing tests, improving test coverage, and setting up CI. Only then did I have a somewhat presentable result. I hope this tool helps those facing similar challenges, and I also hope everyone can work together to make this tool even better.</p><p><a href="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.webp" alt="[pinkoi.com](https://www.pinkoi.com){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTAiIGhlaWdodD0iMTg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a></p><p>Currently applied in our company‚Äôs iOS app <a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a>, no issues found. üòÑ</p><h4 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><a href="/posts/zrealm-dev/en/zmarkupparser-convert-html-string-to-nsattributedstring-with-custom-style-keys-a5643de271e4/">ZMarkupParser HTML String to NSAttributedString Tool</a></p><li><p><a href="https://www.objc.io/issues/9-strings/string-rendering/" target="_blank">String Rendering</a></p><li><p><a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a></p></ul><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><script src="/assets/clipboard.min.js"></script><div style=" display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; background:#f9fafb; padding:12px 16px; border-radius:12px; margin:18px 0; box-shadow:0 3px 8px rgba(0,0,0,0.05); width: auto;"> <input id="share-url" value="https://zhgchg.li/posts/zrealm-dev/en/html-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7/" readonly="" style=" flex:1; border:1px solid #d1d5db; border-radius:8px; padding:10px 12px; font-size:0.9rem; background:#ffffff; color:#111827; outline:none; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; " /> <button class="btn" data-clipboard-target="#share-url" id="copy-btn" style=" border:none; background:#3b82f6; color:white; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:6px; transition:all .15s ease; box-shadow:0 2px 5px rgba(59,130,246,0.35); " onmouseover="this.style.opacity='0.92';" onmouseout="this.style.opacity='1';"> <span style="font-size:1rem;">üîó</span> <span id="copy-btn-text">Copy link to share!</span> </button></div><script> new ClipboardJS('.btn'); var btn = document.getElementById("copy-btn"); var text = document.getElementById("copy-btn-text"); btn.addEventListener("click", function () { text.textContent = "Copied!"; btn.style.background = "#16a34a"; btn.style.boxShadow = "0 2px 6px rgba(22,163,74,0.35)"; setTimeout(() => { text.textContent = "Copy link to share!"; btn.style.background = "#3b82f6"; btn.style.boxShadow = "0 2px 5px rgba(59,130,246,0.35)"; }, 1500); });</script><hr /><p><a href="https://www.paypal.com/ncp/payment/CMALMPT8UUTY2" target="_blank" rel="noopener" style="display:block;margin:12px 0;text-align:center;align-items:center;justify-content:center;padding:10px 22px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,#ffd54f,#ffb300);color:#000;font-size:16px;font-weight:700;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;box-shadow:0 4px 10px rgba(0,0,0,.15);cursor:pointer;transition:all .15s ease;width:350px" onmouseover="this.style.background=&quot;linear-gradient(135deg,#FFE082,#FFC107)&quot;,this.style.transform=&quot;translateY(-1px)&quot;,this.style.boxShadow=&quot;0 6px 14px rgba(0,0,0,0.2)&quot;" onmouseout="this.style.background=&quot;linear-gradient(135deg,#FFD54F,#FFB300)&quot;,this.style.transform=&quot;translateY(0)&quot;,this.style.boxShadow=&quot;0 4px 10px rgba(0,0,0,0.15)&quot;">üç∫ Buy me a beer on PayPal</a></p><blockquote class="prompt-info"><p>This post was originally published on Medium (<a href="https://medium.com/p/2724f02f6e7" target="_blank"><strong>View original post</strong></a>), and automatically converted and synced by <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a>.</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2023-03-11-2724f02f6e7.md" target="_blank">Improve this page on Github.</a></p></blockquote><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1,050+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/english/" class="post-tag no-text-decoration" >english</a> <a href="/tags/ai-translation/" class="post-tag no-text-decoration" >ai-translation</a> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/rendering/" class="post-tag no-text-decoration" >rendering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HTML%20Parsing%20Techniques%EF%BD%9CBuild%20Custom%20Parsers%20for%20NSAttributedString%20Rendering%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fhtml-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HTML%20Parsing%20Techniques%EF%BD%9CBuild%20Custom%20Parsers%20for%20NSAttributedString%20Rendering%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fhtml-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fhtml-parsing-techniques-build-custom-parsers-for-nsattributedstring-rendering-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ci-cd-explained-boost-ios-app-development-stability-and-efficiency-tool-selection-guide-c008a9e8ceca/">CI/CD Explained: Boost iOS App Development Stability and EfficiencyÔΩúTool Selection Guide</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ci-cd-%E6%98%AF%E4%BB%80%E4%B9%88-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A8%B3%E5%AE%9A%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E7%9A%84%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9-c008a9e8ceca/">CI/CD ÂÆûÊàòÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄ‰πàÔºüÂ¶Ç‰ΩïÈÄèËøá CI/CD ÊâìÈÄ†Á®≥ÂÆöÈ´òÊïàÁöÑÂºÄÂèëÂõ¢ÈòüÔºüÂ∑•ÂÖ∑ÈÄâÊã©Ôºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ci-cd-%E6%98%AF%E4%BB%80%E9%BA%BC-%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88%E7%A9%A9%E5%AE%9A%E9%96%8B%E7%99%BC%E5%9C%98%E9%9A%8A%E7%9A%84%E9%97%9C%E9%8D%B5%E6%B5%81%E7%A8%8B%E8%88%87%E5%B7%A5%E5%85%B7%E9%81%B8%E6%93%87-c008a9e8ceca/">CI/CD ÂØ¶Êà∞ÊåáÂçóÔºà‰∏ÄÔºâÔºöCI/CD ÊòØ‰ªÄÈ∫ºÔºüÂ¶Ç‰ΩïÈÄèÈÅé CI/CD ÊâìÈÄ†Á©©ÂÆöÈ´òÊïàÁöÑÈñãÁôºÂúòÈöäÔºüÂ∑•ÂÖ∑ÈÅ∏ÊìáÔºü</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/google-apps-script-web-app-integrate-forms-with-github-actions-ci-cd-for-streamlined-workflows-4cb4437818f2/">Google Apps Script Web AppÔΩúIntegrate Forms with GitHub Actions CI/CD for Streamlined Workflows</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/google-apps-script-web-app-%E6%89%93%E9%80%A0-github-action-ci-cd-%E8%87%AA%E8%AE%A2%E8%A1%A8%E5%8D%95%E6%8F%90%E5%8D%87%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87-4cb4437818f2/">‰ΩøÁî® Google Apps Script Web App Ë°®Âçï‰∏≤Êé• Github Action CI/CD Â∑•‰Ωú</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Chapters üîñ</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/en/ios-nsattributedstring-html-rendering-efficient-alternative-to-documenttype-html-a8c2d26cc734/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654791119" data-df="ll" > Jun 10, 2022 </time><h4 class="pt-0 my-2">iOS NSAttributedString HTML RenderingÔΩúEfficient Alternative to DocumentType.html</h4><div class="text-muted"><p>Discover a streamlined method to render HTML in iOS using NSAttributedString without relying on DocumentType.html, solving common rendering issues and boosting app performance.</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%89%E6%8F%9B-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">ÊâãÂ∑•ÊâìÈÄ† HTML Ëß£ÊûêÂô®ÁöÑÈÇ£‰∫õ‰∫ã</h4><div class="text-muted"><p>ZMarkupParser HTML to NSAttributedString Ê∏≤ÊüìÂºïÊìéÁöÑÈñãÁôºÂØ¶ÈåÑ</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%AC%E6%8D%A2-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">ÊâãÂ∑•ÊâìÈÄ† HTML Ëß£ÊûêÂô®ÁöÑÈÇ£‰∫õ‰∫ã</h4><div class="text-muted"><p>ZMarkupParser HTML to NSAttributedString Ê∏≤ÊüìÂºïÊìéÁöÑÂºÄÂèëÂÆûÂΩï</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/zmarkupparser-swift-html-string-%E8%BD%89-nsattributedstring-%E5%B7%A5%E5%85%B7-%E6%94%AF%E6%8F%B4%E5%AE%A2%E8%A3%BD%E6%A8%A3%E5%BC%8F%E8%88%87%E9%AB%98%E6%95%88%E8%83%BD%E6%B8%B2%E6%9F%93-a5643de271e4/" class="btn btn-outline-primary" aria-label="Older" ><p>ZMarkupParserÔΩúSwift HTML String ËΩâ NSAttributedString Â∑•ÂÖ∑ÔºåÊîØÊè¥ÂÆ¢Ë£ΩÊ®£ÂºèËàáÈ´òÊïàËÉΩÊ∏≤Êüì</p></a> <a href="/posts/zrealm-dev/zh-cn/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%AC%E6%8D%A2-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3-2724f02f6e7/" class="btn btn-outline-primary" aria-label="Newer" ><p>ÊâãÂ∑•ÊâìÈÄ† HTML Ëß£ÊûêÂô®ÁöÑÈÇ£‰∫õ‰∫ã</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">Ê≠£È´î‰∏≠Êñá</a> | <a href="/tags/simplified-chinese">ÁÆÄ‰Ωì‰∏≠Êñá</a> | <a href="/tags/english/">English</a> <br/> Last updated: 2025-12-27 10:56:51 +08:00</p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
