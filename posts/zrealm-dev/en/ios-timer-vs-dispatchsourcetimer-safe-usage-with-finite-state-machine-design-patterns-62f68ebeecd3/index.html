<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine &amp; Design Patterns" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="Discover how to enhance iOS timer safety by encapsulating DispatchSourceTimer using finite state machines and design patterns, solving common concurrency issues for reliable app performance." /><meta property="og:description" content="Discover how to enhance iOS timer safety by encapsulating DispatchSourceTimer using finite state machines and design patterns, solving common concurrency issues for reliable app performance." /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-12-14T16:17:06+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" /><meta property="twitter:title" content="iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine &amp; Design Patterns" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2025-12-15T00:24:36+08:00","datePublished":"2025-12-14T16:17:06+08:00","description":"Discover how to enhance iOS timer safety by encapsulating DispatchSourceTimer using finite state machines and design patterns, solving common concurrency issues for reliable app performance.","headline":"iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine &amp; Design Patterns","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+","url":"https://zhgchg.li/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"}</script><title>iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script><link rel="alternate" hreflang="zh-Hans" href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"><link rel="alternate" hreflang="zh-Hant" href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/"><link rel="alternate" hreflang="en" href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"><link rel="alternate" hreflang="x-default" href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/"><link rel="stylesheet" href="/assets/css/post-toc.css"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0">An iOS, web, and automation developer from Taiwan üáπüáº who also loves sharing, traveling, and writing.</p><a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a><li class="nav-item"> <a href="/english/" class="nav-link"> <i class="fa-fw fa fa-solid fa-language"></i> <span>ENGLISH POSTS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns</h1><p class="post-desc fw-light mb-4">Discover how to enhance iOS timer safety by encapsulating DispatchSourceTimer using finite state machines and design patterns, solving common concurrency issues for reliable app performance.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1765700226" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 14, 2025 </time> </span> <span> Updated <time data-ts="1765729476" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 14, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" class="popup img-link preview-img blur"><img data-src="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNjAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></div><div class="d-flex justify-content-between"> <span style="display: inline-flex; align-items: center; gap: 4px;"> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" style="display: block; "><path fill="#007bff" d="M271.2 56C265.1 49.8 256.2 47.3 247.8 49.6C239.4 51.9 232.9 58.4 230.8 66.8L215.5 127C214.4 131.4 209.9 134 205.6 132.7L145.8 115.9C137.4 113.5 128.4 115.9 122.3 122C116.2 128.1 113.8 137.1 116.2 145.5L133.1 205.3C134.3 209.6 131.7 214.1 127.4 215.2L67.1 230.5C58.7 232.6 52.1 239.2 49.8 247.6C47.5 256 50 264.9 56.2 271L100.7 314.3C103.9 317.4 103.9 322.6 100.7 325.8L56.3 369.1C50.1 375.2 47.6 384.1 49.9 392.5C52.2 400.9 58.8 407.4 67.2 409.6L127.4 424.9C131.8 426 134.4 430.5 133.1 434.8L116.2 494.5C113.8 502.9 116.2 511.9 122.3 518C128.4 524.1 137.4 526.5 145.8 524.1L205.6 507.2C209.9 506 214.4 508.6 215.5 512.9L230.8 573.1C232.9 581.5 239.5 588.1 247.9 590.4C256.3 592.7 265.2 590.2 271.3 584L314.6 539.5C317.7 536.3 322.9 536.3 326.1 539.5L369.3 584C375.4 590.2 384.3 592.7 392.7 590.4C401.1 588.1 407.6 581.5 409.8 573.1L425.1 513C426.2 508.6 430.7 506 435 507.3L494.8 524.2C503.2 526.6 512.2 524.2 518.3 518.1C524.4 512 526.8 503 524.4 494.6L507.5 434.8C506.3 430.5 508.9 426 513.2 424.9L573.4 409.6C581.8 407.5 588.4 400.9 590.7 392.5C593 384.1 590.5 375.1 584.3 369.1L539.8 325.8C536.6 322.7 536.6 317.5 539.8 314.3L584.3 271C590.5 264.9 593 256 590.7 247.6C588.4 239.2 581.8 232.7 573.4 230.5L513.2 215.2C508.8 214.1 506.2 209.6 507.5 205.3L524.4 145.5C526.8 137.1 524.4 128.1 518.3 122C512.2 115.9 503.2 113.5 494.8 115.9L435 132.8C430.7 134 426.2 131.4 425.1 127.1L409.8 66.8C407.7 58.4 401.1 51.8 392.7 49.5C384.3 47.2 375.4 49.7 369.3 55.9L326 100.5C322.9 103.7 317.7 103.7 314.5 100.5L271.2 56z"/><path d="M250 330 l60 60 100 -140" stroke="#ffffff" stroke-width="40" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3075 words" > <em>17 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Á´†ÁØÄ (Chapters)üîñ</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/"><strong>ÁÇπÂáªËøôÈáå</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†ÁÆÄ‰Ωì‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-tip"><p><a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/"><strong>ÈªûÊìäÈÄôË£°</strong></a>Êü•ÁúãÊú¨ÊñáÁ´†Ê≠£È´î‰∏≠ÊñáÁâàÊú¨„ÄÇ</p></blockquote><blockquote class="prompt-info"><p>This post was translated with AI assistance ‚Äî let me know if anything sounds off!</p></blockquote><h4 id="zhgchgli-table-of-contents">Table of Contents</h4><nav class="zhgchgli-toc"><ul class="zhgchgli-toc-list"><li class="has-children"><details><summary>[iOS] How to Choose and Safely Use Timer and DispatchSourceTimer? <a href="#ios-how-to-choose-and-safely-use-timer-and-dispatchsourcetimer">#</a></summary><ul><li><a href="#about-timer">About Timer</a></li></ul></details></li><li class="has-children"><details><summary>Foundation ‚Äî Timer (NSTimer) <a href="#foundation--timer-nstimer">#</a></summary><ul><li><a href="#advantages-and-disadvantages">Advantages and Disadvantages</a></li><li><a href="#suitable-scenarios">Suitable Scenarios</a></li><li><a href="#lifecycle">Lifecycle</a></li><li><a href="#usage">Usage</a></li><li><a href="#how-to-use-timer">How to Use Timer</a></li><li><a href="#the-impact-of-runloop-mode">The Impact of RunLoop Mode</a></li></ul></details></li><li class="has-children"><details><summary>Grand Central Dispatch ‚Äî DispatchSourceTimer <a href="#grand-central-dispatch--dispatchsourcetimer">#</a></summary><ul><li><a href="#advantages-and-disadvantages-1">Advantages and Disadvantages</a></li><li><a href="#suitable-scenarios-1">Suitable Scenarios</a></li><li><a href="#life-cycle">Life Cycle</a></li><li><a href="#crash-issues">Crash Issues</a></li><li><a href="#using-finite-state-machine-to-encapsulate-operations">Using Finite-State Machine to Encapsulate Operations</a></li><li><a href="#using-serial-queue-to-manage-finite-state-machine-transitions">Using Serial Queue to Manage Finite State Machine Transitions</a></li><li><a href="#extension--using-adapter-pattern--factory-pattern-to-create-dispatchsourcetimer-facilitates-abstract-testing">Extension ‚Äî Using Adapter Pattern + Factory Pattern to Create DispatchSourceTimer (Facilitates Abstract Testing)</a></li><li><a href="#extension--using-the-strategy-pattern-to-encapsulate-dispatchsourcehandler-tasks">Extension ‚Äî Using the Strategy Pattern to Encapsulate DispatchSourceHandler Tasks</a></li><li><a href="#acknowledgments">Acknowledgments</a></li></ul></details></li><li><a href="#further-reading">Further Reading</a></li></ul></nav><hr /><h3 id="ios-how-to-choose-and-safely-use-timer-and-dispatchsourcetimer"><span class="me-2">[iOS] How to Choose and Safely Use Timer and DispatchSourceTimer?</span><a href="#ios-how-to-choose-and-safely-use-timer-and-dispatchsourcetimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Encapsulating DispatchSourceTimer with Finite State Machine and Design Patterns for Safer and Easier Use.</p><p><a href="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*2CWJW1fPOAZdU3nqeJ2JeQ.webp" alt="Photo by [Ralph Hutter](https://unsplash.com/@pixelfreund?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjkzMyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>Photo by <a href="https://unsplash.com/@pixelfreund?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" target="_blank">Ralph Hutter</a></p><h4 id="about-timer"><span class="me-2">About Timer</span><a href="#about-timer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In iOS development, the ‚ÄúTimer trigger‚Äù is a common requirement; from UI aspects like showing countdowns and banner carousels to data logic tasks like scheduled event sending and periodic data cleanup, we rely on timers to help achieve these goals.</p><h3 id="foundation--timer-nstimer"><span class="me-2"><a href="https://developer.apple.com/documentation/foundation/timer" target="_blank">Foundation ‚Äî Timer (NSTimer)</a></span><a href="#foundation--timer-nstimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Timer is probably the most intuitive API that comes to mind first, but there are several points to consider when choosing and using Timer.</p><h4 id="advantages-and-disadvantages"><span class="me-2">Advantages and Disadvantages</span><a href="#advantages-and-disadvantages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Advantages of Timer:</strong></p><ul><li><p>By default, it integrates with UI work and does not require explicitly switching to the Main Thread.</p><li><p>Automatically adjusts trigger timing to optimize power usage</p><li><p>Lower complexity, at most causing retain cycles or forgetting to stop the Timer, but will not directly cause a crash</p></ul><p><strong>Disadvantages of Timer:</strong></p><ul><li><p>Accuracy is affected by the RunLoop state and may be delayed during high UI interaction or mode switching.</p><li><p>Does not support advanced operations like <code class="language-plaintext highlighter-rouge">suspend</code>, <code class="language-plaintext highlighter-rouge">resume</code>, <code class="language-plaintext highlighter-rouge">activate</code>, etc.</p></ul><h4 id="suitable-scenarios"><span class="me-2">Suitable Scenarios</span><a href="#suitable-scenarios" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>UI-level needs, such as carousel banners (auto-scrolling ScrollView) or coupon countdown timers; these scenarios only require the user to respond to content in the current foreground screen. I choose to use Timer directly for a convenient, fast, and safe solution.</p><h4 id="lifecycle"><span class="me-2">Lifecycle</span><a href="#lifecycle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*rQrIoCxCdwoFCgqZc1zE8A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTUxIiBoZWlnaHQ9IjEyMDAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>Creating a Timer on the UI Main Thread means the Timer is strongly held by the Main Thread‚Äôs RunLoop and is periodically triggered by the RunLoop‚Äôs polling mechanism. It will only be released when Timer.invalidate() is called. Therefore, we need to strongly hold the Timer in the ViewController and call Timer.invalidate() in deinit to properly stop and release the Timer after the view is dismissed.</p><ul><li><p>‚≠êÔ∏èÔ∏èÔ∏èView Controller strongly retains Timer, <strong>the Timer‚Äôs Execution Block (handler/closure) must use Weak Self; otherwise, it will cause a Retain Cycle.</strong></p><li><p>‚≠êÔ∏èÔ∏èÔ∏è Be sure to call Timer invalidate() at the end of the View Controller lifecycle; otherwise, the RunLoop will still hold the Timer and keep it running.</p></ul><blockquote><p><em>RunLoop is an event processing loop within a Thread that polls and handles events; <strong>the system automatically creates a RunLoop for the Main Thread (RunLoop.main)</strong>, but other Threads may not have a RunLoop.</em></p></blockquote><h4 id="usage"><span class="me-2">Usage</span><a href="#usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We can directly use <code class="language-plaintext highlighter-rouge">Timer.scheduledTimer</code> to declare a Timer (it automatically adds to RunLoop.main &amp; <strong>Mode: .default</strong>):</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">HomeViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">Timer</span><span class="p">?</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">invalidate</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="nf">startCarousel</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">startCarousel</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="o">.</span><span class="nf">scheduledTimer</span><span class="p">(</span><span class="nv">withTimeInterval</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">repeats</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">block</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">doSomething</span><span class="p">()</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">doSomething</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You can also declare a Timer object yourself and add it to the RunLoop:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">Timer</span><span class="p">(</span><span class="nv">timeInterval</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nv">repeats</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">_</span> <span class="k">in</span>
  <span class="c1">// do something..</span>
<span class="p">}</span>
<span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
<span class="c1">// Adding to RunLoop starts the timer</span>
<span class="kt">RunLoop</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="nv">forMode</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span>
</pre></table></code></div></div><h4 id="how-to-use-timer"><span class="me-2">How to Use Timer</span><a href="#how-to-use-timer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><code class="language-plaintext highlighter-rouge">invalidate()</code> stops the Timer</p><li><p><code class="language-plaintext highlighter-rouge">fire()</code> triggers immediately once</p></ul><h4 id="the-impact-of-runloop-mode"><span class="me-2">The Impact of RunLoop <strong>Mode</strong></span><a href="#the-impact-of-runloop-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><p><code class="language-plaintext highlighter-rouge">.default</code>: The default added mode, mainly handles UI display.<br /> <strong>Will pause first when switching to <code class="language-plaintext highlighter-rouge">.tracking</code> mode</strong></p><li><p><code class="language-plaintext highlighter-rouge">.tracking</code>: Handles ScrollView scrolling and Gesture recognition.</p><li><p><code class="language-plaintext highlighter-rouge">.common</code>: Handles both <code class="language-plaintext highlighter-rouge">.default</code> and <code class="language-plaintext highlighter-rouge">.tracking</code>.</p></ul><blockquote><p><em>‚≠êÔ∏èÔ∏èÔ∏è‚≠êÔ∏èÔ∏èÔ∏è‚≠êÔ∏èÔ∏èÔ∏èTherefore, by default, our Timer is added to the <code class="language-plaintext highlighter-rouge">.default</code> mode, <strong>which will automatically pause when the user scrolls a ScrollView or performs gestures</strong>, and will only resume after the interaction ends. This may cause the Timer to trigger late or fire fewer times than expected.</em></p></blockquote><p><strong>For this, we can add Timer to the .common Mode to solve the above issue:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">RunLoop</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="nv">forMode</span><span class="p">:</span> <span class="o">.</span><span class="n">common</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="grand-central-dispatch--dispatchsourcetimer"><span class="me-2"><a href="https://developer.apple.com/documentation/dispatch/dispatchsourcetimer" target="_blank">Grand Central Dispatch ‚Äî DispatchSourceTimer</a></span><a href="#grand-central-dispatch--dispatchsourcetimer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Besides Timer, GCD also provides another option called DispatchSourceTimer.</p><h4 id="advantages-and-disadvantages-1"><span class="me-2">Advantages and Disadvantages</span><a href="#advantages-and-disadvantages-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Advantages of DispatchSourceTimer:</strong></p><ul><li><p>Better operational flexibility (supports <code class="language-plaintext highlighter-rouge">suspend</code> and <code class="language-plaintext highlighter-rouge">resume</code>)</p><li><p>Higher accuracy and reliability: depends on GCD queue</p><li><p>Leeway can be set manually to control power consumption</p><li><p>Stable resident task (GCD queue)</p></ul><p><strong>Disadvantages of DispatchSourceTimer:</strong></p><ul><li><p>UI operations require manually switching back to the Main Thread</p><li><p>The API is complex and order-dependent; <strong>using it incorrectly will cause a crash</strong></p><li><p>Encapsulation Is Needed for Safe Usage</p></ul><h4 id="suitable-scenarios-1"><span class="me-2">Suitable Scenarios</span><a href="#suitable-scenarios-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Compared to Timer, which is suitable for UI-related scenarios, DispatchSourceTimer is better suited for tasks unrelated to the UI or the current user screen. The most common use cases are sending tracking events, where user-generated events are periodically sent to the server, or regularly cleaning up unused CoreData data. These tasks are ideal for using DispatchSourceTimer.</p><h4 id="life-cycle"><span class="me-2">Life Cycle</span><a href="#life-cycle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*2hIwImzm6ubpc5zK_roI3Q.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjg5IiBoZWlnaHQ9IjkxNCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The lifecycle of DispatchSourceTimer depends on whether it is still retained by an external object; the GCD queue itself does not strongly retain the timer‚Äôs owner and only handles scheduling and executing events.</p><h4 id="crash-issues"><span class="me-2">Crash Issues</span><a href="#crash-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Although DispatchSourceTimer offers more control methods: <code class="language-plaintext highlighter-rouge">activate</code>, <code class="language-plaintext highlighter-rouge">suspend</code>, <code class="language-plaintext highlighter-rouge">resume</code>, <code class="language-plaintext highlighter-rouge">cancel</code>; it is extremely sensitive, and calling them in the wrong order will cause immediate crashes (EXC_BREAKPOINT/DispatchSourceTimer), which is very dangerous.</p><p><a href="/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*04cApJDt29a-98zgb9Wd2A.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODMiIGhlaWdodD0iMTg1Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><strong>The following situations will cause an immediate crash:</strong></p><ul><li><p>‚ùå suspend() and resume() are not used in pairs<br /> Calling suspend() again after suspend()<br /> Calling resume() again after resume()</p><li><p>‚ùå Calling cancel() after suspend()<br /> You need to call resume() before cancel()</p><li><p>‚ùå Timer is released (nil) while in suspend() state</p><li><p>‚ùå Calling other operations after cancel()</p></ul><h4 id="using-finite-state-machine-to-encapsulate-operations"><span class="me-2">Using Finite-State Machine to Encapsulate Operations</span><a href="#using-finite-state-machine-to-encapsulate-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Moving on to another key point of this article: How to safely use DispatchSourceTimer?</p><p><a href="/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.webp" class="popup img-link blur"><img data-src="/assets/62f68ebeecd3/1*S33K4OWFUPMocZvM4dLWvw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9Ijk4NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>As shown in the above image, we use a finite state machine to encapsulate DispatchSourceTimer operations, making it safer and easier to use:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// States of the finite state machine</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">TimerState</span> <span class="p">{</span>
        <span class="c1">// Initial state</span>
        <span class="k">case</span> <span class="n">idle</span>
        <span class="c1">// Running</span>
        <span class="k">case</span> <span class="n">running</span>
        <span class="c1">// Suspended</span>
        <span class="k">case</span> <span class="n">suspended</span>
        <span class="c1">// Cancelled</span>
        <span class="k">case</span> <span class="n">cancelled</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">timerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_state</span><span class="p">:</span> <span class="kt">TimerState</span> <span class="o">=</span> <span class="o">.</span><span class="n">idle</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="c1">// When the owner object is deallocated, cancel the timer synchronously</span>
        <span class="c1">// Not mandatory (handler is weak), but ensures the flow is as expected</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">running</span> <span class="p">{</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Start the Timer</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="c1">// Timer can only be activated in idle or cancelled state</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// Create Timer and activate()</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
        
        <span class="c1">// Switch to running state</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
    <span class="p">}</span>

    <span class="c1">// Suspend the Timer</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Timer can only be suspended when running</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// Suspend Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
        
        <span class="c1">// Switch to suspended state</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">suspended</span>
    <span class="p">}</span>

    <span class="c1">// Resume the Timer</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Timer can only be resumed when suspended</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// Resume Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        
        <span class="c1">// Switch to running state</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
    <span class="p">}</span>

    <span class="c1">// Cancel the Timer</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Timer can only be cancelled when suspended or running</span>
        <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="c1">// If currently suspended, resume first before cancelling</span>
        <span class="c1">// This is a DispatchSourceTimer limitation; can only cancel when running</span>
        <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1">// Cancel Timer</span>
        <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
        
        <span class="c1">// Switch to cancelled state</span>
        <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">DispatchSourceTimer</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">timerQueue</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We simply use a finite state machine to encapsulate the logic of ‚Äúwhich states can transition to which‚Äù and ‚Äúwhat actions each state requires.‚Äù Calls made in the wrong state are ignored (no crashes). We also added some optimizations, such as allowing cancel in the suspended state and reactivating from the cancelled state.</p><blockquote><p><strong><em>Further Reading:</em></strong></p></blockquote><blockquote><p><em>Previously, I wrote another article ‚Äú<a href="https://zhgchg.li/posts/pinkoi-engineering/design-patterns-%E5%AF%A6%E6%88%B0%E6%87%89%E7%94%A8-%E5%B0%81%E8%A3%9D-socket-io-%E5%8D%B3%E6%99%82%E9%80%9A%E8%A8%8A%E6%9E%B6%E6%A7%8B%E8%88%87%E4%B8%83%E5%A4%A7%E8%A8%AD%E8%A8%88%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/#%E9%9C%80%E6%B1%82%E5%A0%B4%E6%99%AF-3" target="_blank">Design Patterns Practical ApplicationÔΩúEncapsulating Socket.IO Real-time Communication Architecture</a>‚Äù, where I also used a finite state machine and additionally applied the State Pattern.</em></p></blockquote><blockquote><p><em>Finite-State Machine: Focuses on controlling state transitions and the actions to perform.</em></p></blockquote><blockquote><p><em>State Pattern: Focuses on the behavior logic within each state.</em></p></blockquote><h4 id="using-serial-queue-to-manage-finite-state-machine-transitions"><span class="me-2">Using Serial Queue to Manage Finite State Machine Transitions</span><a href="#using-serial-queue-to-manage-finite-state-machine-transitions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Even after ensuring safe use of DispatchSourceTimer with a state machine, the issue is not fully resolved. We cannot guarantee that calls to DispatchSourceTimerMachine from outside occur on the same thread. If multiple threads operate on this object, race conditions may still cause crashes.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// States of the finite state machine</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">TimerState</span> <span class="p">{</span>
        <span class="c1">// Initial state</span>
        <span class="k">case</span> <span class="n">idle</span>
        <span class="c1">// Running</span>
        <span class="k">case</span> <span class="n">running</span>
        <span class="c1">// Suspended</span>
        <span class="k">case</span> <span class="n">suspended</span>
        <span class="c1">// Cancelled</span>
        <span class="k">case</span> <span class="n">cancelled</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">timerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
    <span class="p">}()</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_state</span><span class="p">:</span> <span class="kt">TimerState</span> <span class="o">=</span> <span class="o">.</span><span class="n">idle</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="k">let</span> <span class="nv">operationQueueSpecificKey</span> <span class="o">=</span> <span class="kt">DispatchSpecificKey</span><span class="o">&lt;</span><span class="kt">ObjectIdentifier</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">operationQueueSpecificValue</span><span class="p">:</span> <span class="kt">ObjectIdentifier</span> <span class="o">=</span> <span class="kt">ObjectIdentifier</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">operationQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"li.zhgchg.DispatchSourceTimerMachine.operationQueue"</span><span class="p">)</span>
        <span class="n">queue</span><span class="o">.</span><span class="nf">setSpecific</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">operationQueueSpecificKey</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">operationQueueSpecificValue</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queue</span>
    <span class="p">}()</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">operation</span><span class="p">(</span><span class="nv">async</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">_</span> <span class="nv">work</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">getSpecific</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">operationQueueSpecificKey</span><span class="p">)</span> <span class="o">==</span> <span class="n">operationQueueSpecificValue</span> <span class="p">{</span>
            <span class="nf">work</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">async</span> <span class="p">{</span>
                <span class="n">operationQueue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="n">work</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">operationQueue</span><span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="nv">execute</span><span class="p">:</span> <span class="n">work</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="c1">// When the owner object disappears, synchronously cancel the timer</span>
        <span class="c1">// Not required (handler is weak), but ensures the flow is as expected</span>
        <span class="c1">// Ensure sync execution completes</span>
        <span class="nf">operation</span><span class="p">(</span><span class="nv">async</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
                <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
                <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">running</span> <span class="p">{</span>
                <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
                <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
                <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Start the Timer</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// Only idle or cancelled states can activate the Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// Create Timer and activate()</span>
            <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
            <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
            
            <span class="c1">// Switch to running state</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Suspend the Timer</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// Only running state can suspend the Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// Suspend the Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
            
            <span class="c1">// Switch to suspended state</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">suspended</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Resume the Timer</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// Only suspended state can resume the Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// Resume the Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            
            <span class="c1">// Switch to running state</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Cancel the Timer</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">operation</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// Only suspended or running states can cancel the Timer</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">suspended</span><span class="p">,</span> <span class="o">.</span><span class="n">running</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            
            <span class="c1">// If currently suspended, resume first then cancel</span>
            <span class="c1">// This is a DispatchSourceTimer limitation: can only cancel when running</span>
            <span class="k">if</span> <span class="n">_state</span> <span class="o">==</span> <span class="o">.</span><span class="n">suspended</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
            <span class="p">}</span>
            
            <span class="c1">// Cancel the Timer</span>
            <span class="n">timer</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">timer</span> <span class="o">=</span> <span class="kc">nil</span>
            
            <span class="c1">// Switch to cancelled state</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">cancelled</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">DispatchSourceTimer</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">timerQueue</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now, we can safely use the <code class="language-plaintext highlighter-rouge">DispatchSourceTimerMachine</code> object as a Timer without worries:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nx">final</span> <span class="kd">class</span> <span class="nc">TrackingEventSender</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">let</span> <span class="nx">timerMachine</span> <span class="o">=</span> <span class="nc">DispatchSourceTimerMachine</span><span class="p">()</span>
    <span class="k">public</span> <span class="kd">var</span> <span class="nx">events</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="nb">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">// Start periodic tracking</span>
    <span class="nx">func</span> <span class="nf">startTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">activate</span><span class="p">(</span><span class="nx">repeatTimeInterval</span><span class="p">:</span> <span class="p">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span> <span class="p">[</span><span class="nx">weak</span> <span class="nb">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="nb">self</span><span class="p">?.</span><span class="nf">sendTrackingEvent</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Pause tracking (e.g., when App goes to background)</span>
    <span class="nx">func</span> <span class="nf">pauseTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Resume tracking (e.g., when App returns to foreground)</span>
    <span class="nx">func</span> <span class="nf">resumeTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Stop tracking (e.g., when leaving the page)</span>
    <span class="nx">func</span> <span class="nf">stopTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">timerMachine</span><span class="p">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="nx">func</span> <span class="nf">sendTrackingEvent</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// send events to server...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The section on how to safely use DispatchSourceTimer has ended. Next, we will extend to several Design Patterns to help us abstract objects for testing and to abstract the execution logic of DispatchSourceHandler.</p><h4 id="extension--using-adapter-pattern--factory-pattern-to-create-dispatchsourcetimer-facilitates-abstract-testing"><span class="me-2">Extension ‚Äî Using Adapter Pattern + Factory Pattern to Create DispatchSourceTimer (Facilitates Abstract Testing)</span><a href="#extension--using-adapter-pattern--factory-pattern-to-create-dispatchsourcetimer-facilitates-abstract-testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>DispatchSourceTimer is a GCD Objective-C object, making it difficult to mock in tests (no Protocol available); therefore, we need to define our own Protocol + Factory Pattern to generate it, allowing TimerStateMachine to be testable.</p><p><strong>Adapter Pattern‚Äî Encapsulating DispatchSourceTimer Operations:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span>
    <span class="kd">func</span> <span class="nf">activate</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Adapter implementation for DispatchSourceTimer</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerAdapter</span><span class="p">:</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
    <span class="c1">// Original DispatchSourceTimer</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">DispatchSourceTimer</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"li.zhgchg.DispatchSourceTimerAdapter"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="nf">makeTimerSource</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">(),</span> <span class="nv">repeating</span><span class="p">:</span> <span class="n">repeating</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">activate</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Factory Pattern ‚Äî Abstract method to create TimerAdapter:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimerAdapter</span>
<span class="p">}</span>

<span class="c1">// Encapsulates the creation steps of DispatchSourceTimerAdapter</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerAdapterFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSourceProtocol</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">TimerAdapter</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerAdapter</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="nf">setEventHandler</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timer</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Combined Usage:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">stateMachine</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerMachine</span><span class="p">(</span><span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactory</span><span class="p">())</span>

<span class="c1">//</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DispatchSourceTimerMachine</span> <span class="p">{</span>
    <span class="c1">// Omitted..</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">timer</span><span class="p">:</span> <span class="kt">TimerAdapter</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">timerFactory</span><span class="p">:</span> <span class="kt">DispatchSourceTimerAdapterFactorySpec</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">timerFactory</span> <span class="o">=</span> <span class="n">timerFactory</span>
    <span class="p">}</span>
    <span class="c1">// Omitted..</span>

    <span class="kd">func</span> <span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="kt">DispatchTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kt">DispatchSource</span><span class="o">.</span><span class="kt">DispatchSourceHandler</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">onQueue</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="k">guard</span> <span class="p">[</span><span class="o">.</span><span class="n">idle</span><span class="p">,</span> <span class="o">.</span><span class="n">cancelled</span><span class="p">]</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
            <span class="c1">// Use Factory to make Timer</span>
            <span class="k">let</span> <span class="nv">timer</span> <span class="o">=</span> <span class="n">timerFactory</span><span class="o">.</span><span class="nf">makeTimer</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="n">repeatTimeInterval</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span>

            <span class="n">timer</span><span class="o">.</span><span class="nf">activate</span><span class="p">()</span>
            <span class="n">_state</span> <span class="o">=</span> <span class="o">.</span><span class="n">running</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Omitted..</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This allows us to write Mock Objects for <code class="language-plaintext highlighter-rouge">TimerAdapter</code> / <code class="language-plaintext highlighter-rouge">DispatchSourceTimerAdapterFactorySpec</code> during testing to run unit tests.</p><h4 id="extension--using-the-strategy-pattern-to-encapsulate-dispatchsourcehandler-tasks"><span class="me-2">Extension ‚Äî Using the <strong><em>Strategy</em></strong> Pattern to Encapsulate DispatchSourceHandler Tasks</span><a href="#extension--using-the-strategy-pattern-to-encapsulate-dispatchsourcehandler-tasks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Assuming we want the DispatchSourceHandler to execute tasks that can change dynamically, we can use the Strategy Pattern to encapsulate the work content.</p><p><strong>TrackingHandlerStrategy:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Home Event</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">HomeTrackingHandlerStrategy</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"home"</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// fetch home event logs..and send</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Product Event</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ProductTrackingHandlerStrategy</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">target</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"product"</span>
    <span class="kd">func</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
       <span class="c1">// fetch product event logs..and send</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Combined Usage:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">sender</span> <span class="o">=</span> <span class="kt">TrackingEventSender</span><span class="p">()</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">HomeTrackingHandlerStrategy</span><span class="p">())</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">ProductTrackingHandlerStrategy</span><span class="p">())</span>
<span class="n">sender</span><span class="o">.</span><span class="nf">startTracking</span><span class="p">()</span>

<span class="c1">// ...</span>

<span class="c1">//</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">TrackingEventSender</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">timerMachine</span> <span class="o">=</span> <span class="kt">DispatchSourceTimerMachine</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">events</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

    <span class="c1">// Register required event strategies</span>
    <span class="kd">func</span> <span class="nf">register</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">events</span><span class="p">[</span><span class="nf">type</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="n">retrive</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">TrackingHandlerStrategy</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">event</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="k">Type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">events</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">T</span>
    <span class="p">}</span>

    <span class="c1">// Start periodic tracking</span>
    <span class="kd">func</span> <span class="nf">startTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">activate</span><span class="p">(</span><span class="nv">repeatTimeInterval</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">event</span> <span class="k">in</span>
                <span class="n">event</span><span class="o">.</span><span class="nf">execute</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Pause tracking (e.g., app enters background)</span>
    <span class="kd">func</span> <span class="nf">pauseTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">suspend</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Resume tracking (e.g., app enters foreground)</span>
    <span class="kd">func</span> <span class="nf">resumeTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Stop tracking (e.g., page leaves)</span>
    <span class="kd">func</span> <span class="nf">stopTracking</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timerMachine</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="acknowledgments"><span class="me-2">Acknowledgments</span><a href="#acknowledgments" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Thanks to <a href="https://medium.com/u/e13f6afcf9b9" target="_blank">Ethan Huang</a> for donating <strong>5 Beers</strong>:</p><p><a href="https://www.patreon.com/cw/ethanhuang13/home?vanity=ethanhuang13" target="_blank" class="img-link shimmer" ><img src="https://c7.patreon.com/https%3A%2F%2Fwww.patreon.com%2F%2Fcard-teaser-image%2Fcreator%2F6512681%3Fc=4366071272298850039/selector/%23creator-teaser%2C.png" alt="" loading="lazy"></a></p><blockquote><p><em>Indeed, I haven‚Äôt written much for almost half a year. Just started a new job and am continuously seeking inspiration! üí™</em></p></blockquote><blockquote><p>The next article might share the process of managing certificates with Fastlane Match and setting up a Self-hosted Runner, or it could cover Bitbucket Pipeline, or the AppStoreConnect API‚Ä¶</p></blockquote><h3 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><p><a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/"><strong>Practical Application of Design Patterns (Encapsulating Socket.io)</strong></a></p><li><p><a href="/posts/kkday-tech-blog/en/design-patterns-in-wkwebview-builder-strategy-chain-of-responsibility-explained-f4b02ee342a4/">Practical Application of Design Patterns (Encapsulating WKWebView)</a></p><li><p><a href="/posts/zrealm-dev/en/visitor-pattern-in-ios-swift-design-pattern-practical-applications-ba5773a7bfea/">Visitor Pattern in Swift</a></p><li><p><a href="/posts/zrealm-dev/en/visitor-pattern-enhance-tableview-readability-and-extensibility-60473cb47550/">Visitor Pattern in TableView</a></p></ul><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><hr /><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=üç∫&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a><br /></p><blockquote class="prompt-info"><p>This post was originally published on Medium (<a href="https://medium.com/p/62f68ebeecd3" target="_blank"><strong>View original post</strong></a>), and automatically converted and synced by <a href="/posts/tools/medium-to-jekyll/" target="_blank">ZMediumToMarkdown</a>.</p></blockquote><blockquote class="prompt-info"><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2025-12-14-62f68ebeecd3.md" target="_blank">Improve this page on Github.</a></p></blockquote><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic><script async src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/design-patterns/" class="post-tag no-text-decoration" >design-patterns</a> <a href="/tags/timer/" class="post-tag no-text-decoration" >timer</a> <a href="/tags/swift/" class="post-tag no-text-decoration" >swift</a> <a href="/tags/finite-state-machine/" class="post-tag no-text-decoration" >finite-state-machine</a> <a href="/tags/english/" class="post-tag no-text-decoration" >english</a> <a href="/tags/ai-translation/" class="post-tag no-text-decoration" >ai-translation</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=iOS%20Timer%20vs%20DispatchSourceTimer%EF%BD%9CSafe%20Usage%20with%20Finite%20State%20Machine%20&%20Design%20Patterns%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=iOS%20Timer%20vs%20DispatchSourceTimer%EF%BD%9CSafe%20Usage%20with%20Finite%20State%20Machine%20&%20Design%20Patterns%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/en/ios-timer-vs-dispatchsourcetimer-safe-usage-with-finite-state-machine-design-patterns-62f68ebeecd3/">iOS Timer vs DispatchSourceTimerÔΩúSafe Usage with Finite State Machine & Design Patterns</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/">iOS Timer ‰∏é DispatchSourceTimer Â¶Ç‰ΩïÈÄâÊã©‰∏éÂÆâÂÖ®ÁöÑ‰ΩøÁî®?</a><li class="text-truncate lh-lg"> <a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/">iOS Timer Ëàá DispatchSourceTimer Â¶Ç‰ΩïÈÅ∏ÊìáËàáÂÆâÂÖ®ÁöÑ‰ΩøÁî®?</a><li class="text-truncate lh-lg"> <a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/">Design PatternsÔΩúPractical Solutions for Socket.IO Client Library Challenges</a><li class="text-truncate lh-lg"> <a href="/posts/pinkoi-engineering/zh-cn/design-patterns-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8-%E5%B0%81%E8%A3%85-socket-io-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%83%E5%A4%A7%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90-78507a8de6a5/">Design Patterns ÁöÑÂÆûÊàòÂ∫îÁî®Á∫™ÂΩï</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Á´†ÁØÄ (Chapters)üîñ</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/pinkoi-engineering/en/design-patterns-practical-solutions-for-socket-io-client-library-challenges-78507a8de6a5/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1649342957" data-df="ll" > Apr 7, 2022 </time><h4 class="pt-0 my-2">Design PatternsÔΩúPractical Solutions for Socket.IO Client Library Challenges</h4><div class="text-muted"><p>Discover how to resolve common challenges in encapsulating Socket.IO Client Library using proven Design Patterns, enhancing code maintainability and scalability for developers facing similar integr...</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-timer-%E8%88%87-dispatchsourcetimer-%E9%81%B8%E6%93%87%E8%88%87%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%9D%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8B%80%E6%85%8B%E6%A9%9F%E9%98%B2%E6%AD%A2%E9%96%83%E9%80%80-62f68ebeecd3/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765700226" data-df="ll" > Dec 14, 2025 </time><h4 class="pt-0 my-2">iOS Timer Ëàá DispatchSourceTimer Â¶Ç‰ΩïÈÅ∏ÊìáËàáÂÆâÂÖ®ÁöÑ‰ΩøÁî®?</h4><div class="text-muted"><p>‰ΩøÁî®ÊúâÈôêÁãÄÊÖãÊ©üËàá Design Patterns Â∞ÅË£ù DispatchSourceTimerÔºå‰ΩøÂÖ∂Êõ¥ÂÆâÂÖ®ÊòìÁî®„ÄÇ</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1765700226" data-df="ll" > Dec 14, 2025 </time><h4 class="pt-0 my-2">iOS Timer ‰∏é DispatchSourceTimer Â¶Ç‰ΩïÈÄâÊã©‰∏éÂÆâÂÖ®ÁöÑ‰ΩøÁî®?</h4><div class="text-muted"><p>‰ΩøÁî®ÊúâÈôêÁä∂ÊÄÅÊú∫‰∏é Design Patterns Â∞ÅË£Ö DispatchSourceTimerÔºå‰ΩøÂÖ∂Êõ¥ÂÆâÂÖ®ÊòìÁî®„ÄÇ</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-life/%E6%97%A5%E6%9C%AC%E6%A8%82%E5%A4%A9%E9%9B%86%E9%81%8B%E6%95%99%E5%AD%B8-%E5%BF%AB%E9%80%9F%E8%B3%BC%E8%B2%B7horie%E9%88%A6%E6%9D%AF%E8%88%87amazon%E5%95%86%E5%93%81%E5%AF%84%E9%80%81%E5%8F%B0%E7%81%A3%E5%85%A8%E6%94%BB%E7%95%A5-bea62c251f1b/" class="btn btn-outline-primary" aria-label="Older" ><p>Êó•Êú¨Ê®ÇÂ§©ÈõÜÈÅãÊïôÂ≠∏ÔΩúÂø´ÈÄüË≥ºË≤∑HorieÈà¶ÊùØËàáAmazonÂïÜÂìÅÂØÑÈÄÅÂè∞ÁÅ£ÂÖ®ÊîªÁï•</p></a> <a href="/posts/zrealm-dev/zh-cn/ios-timer-%E4%B8%8E-dispatchsourcetimer-%E9%80%89%E6%8B%A9%E4%B8%8E%E5%AE%89%E5%85%A8%E5%B0%81%E8%A3%85%E6%8A%80%E5%B7%A7-%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA%E9%98%B2%E6%AD%A2%E9%97%AA%E9%80%80-62f68ebeecd3/" class="btn btn-outline-primary" aria-label="Newer" ><p>iOS Timer ‰∏é DispatchSourceTimer Â¶Ç‰ΩïÈÄâÊã©‰∏éÂÆâÂÖ®ÁöÑ‰ΩøÁî®?</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span> <a href="/">‰∏≠Êñá</a>|<a href="/tags/simplified-chinese">ÁÆÄ‰∏≠</a>|<a href="/tags/english/">English</a></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a> <br/></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/english/">english</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai-translation/">ai-translation</a> <a class="post-tag btn btn-outline-primary" href="/tags/simplified-chinese/">simplified-chinese</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">ÁîüÊ¥ª</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
