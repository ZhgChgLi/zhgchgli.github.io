<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="The Journey of Building a Custom HTML Parser" /><meta name="author" content="ZhgChgLi" /><meta property="og:locale" content="en" /><meta name="description" content="A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine" /><meta property="og:description" content="A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine" /><link rel="canonical" href="https://zhgchg.li/posts/zrealm-dev/en/the-journey-of-building-a-custom-html-parser-2724f02f6e7/" /><meta property="og:url" content="https://zhgchg.li/posts/zrealm-dev/en/the-journey-of-building-a-custom-html-parser-2724f02f6e7/" /><meta property="og:site_name" content="ZhgChgLi (Harry Li)" /><meta property="og:image" content="https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-12T01:09:22+08:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" /><meta property="twitter:title" content="The Journey of Building a Custom HTML Parser" /><meta name="twitter:site" content="@zhgchgli" /><meta name="twitter:creator" content="@zhgchgli" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ZhgChgLi","url":"https://medium.com/@zhgchgli/"},"dateModified":"2023-08-06T00:15:39+08:00","datePublished":"2023-03-12T01:09:22+08:00","description":"A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine","headline":"The Journey of Building a Custom HTML Parser","image":{"lqip":"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjY0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg==","url":"https://zhgchg.li/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhgchg.li/posts/zrealm-dev/en/the-journey-of-building-a-custom-html-parser-2724f02f6e7/"},"url":"https://zhgchg.li/posts/zrealm-dev/en/the-journey-of-building-a-custom-html-parser-2724f02f6e7/"}</script><title>The Journey of Building a Custom HTML Parser | ZhgChgLi (Harry Li)</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ZhgChgLi (Harry Li)"><meta name="application-name" content="ZhgChgLi (Harry Li)"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6WZJENT8WR"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-6WZJENT8WR'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3184248473087645" crossorigin="anonymous"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/zhgchgli.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ZhgChgLi (Harry Li)</a><p class="site-subtitle fst-italic mb-0"> <a href="https://medium.com/@zhgchgli" target="_blank" style="display: block;text-align: center;font-style: normal;/* text-decoration: underline; */font-size: 1.2em;color: var(--heading-color);">1K+ Followers on Medium</a> An iOS, web, and automation developer from Taiwan 🇹🇼 who also loves sharing, traveling, and writing.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fa fa-envelope-open"></i> <span>CONTACT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://link.zhgchg.li" aria-label="link" target="_blank" rel="noopener noreferrer" > <i class="fas fa-link"></i> </a> <a href="https://www.linkedin.com/in/zhgchgli" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="javascript:location.href = 'mailto:' + ['zhgchgli','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>The Journey of Building a Custom HTML Parser</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>The Journey of Building a Custom HTML Parser</h1><p class="post-desc fw-light mb-4">A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1678554562" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 12, 2023 </time> </span> <span> Updated <time data-ts="1691252139" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 5, 2023 </time> </span><div class="mt-3 mb-3"> <a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" class="popup img-link preview-img blur"><img data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" alt="Preview Image" width="1200" height="630" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjY0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://medium.com/@zhgchgli/">ZhgChgLi</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="9893 words" > <em>54 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">The Journey of Building a Custom HTML Parser</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">章節 (Chapters)🔖</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">The Journey of Building a Custom HTML Parser</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"> <widgetic id="64ce7263ecb2a197598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><p>For SEO purposes, <strong>all post titles and descriptions were rewritten by OpenAI</strong>, the original versions are shown below.<br /> The following content is translated by OpenAI, <a href="/posts/2724f02f6e7/"><strong>Click here</strong></a> to view the original Chinese version. | <a href="/posts/2724f02f6e7/"><strong>點此查看本文中文版</strong></a></p><hr /><h3 id="the-journey-of-building-a-custom-html-parser"><span class="me-2">The Journey of Building a Custom HTML Parser</span><a href="#the-journey-of-building-a-custom-html-parser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A detailed account of developing the ZMarkupParser HTML to NSAttributedString rendering engine.</p><p>This article covers the tokenization of HTML strings, normalization processes, the generation of an Abstract Syntax Tree, the application of the Visitor and Builder patterns, and some additional thoughts.</p><h4 id="continuation"><span class="me-2">Continuation</span><a href="#continuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Last year, I published an article titled “<a href="/posts/zrealm-dev/en/implementing-ios-nsattributedstring-html-rendering-on-your-own-a8c2d26cc734/"><strong>TL;DR</strong></a> on Implementing iOS NSAttributedString HTML Rendering,” which briefly introduced how to use XMLParser to parse HTML and convert it into NSAttributedString.Key. The structure and ideas presented in that article were quite scattered, as it was more of a record of the issues I encountered at the time, and I didn’t spend much time researching the topic.</p><h3 id="convert-html-string-to-nsattributedstring"><span class="me-2">Convert HTML String to NSAttributedString</span><a href="#convert-html-string-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Revisiting this topic, we need a way to convert HTML strings provided by the API into NSAttributedString and apply the corresponding styles for display in UITextView/UILabel.</p><p>For example, <code class="language-plaintext highlighter-rouge">&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;</code> should be displayed as <strong>Test <a href="https://blog.zhgchg.li" target="_blank">Link</a></strong>.</p><ul><li><strong>Note 1:</strong> It is not recommended to use HTML as a rendering medium for communication between the app and data, as the HTML specification is too flexible. The app cannot support all HTML styles, and there is no official HTML conversion rendering engine.<li><strong>Note 2:</strong> Starting from iOS 14, you can use the official native AttributedString to parse Markdown or import the apple/swift-markdown Swift Package to parse Markdown.<li><strong>Note 3:</strong> Due to the large scale of our company’s project and the long-standing use of HTML as a medium, we cannot fully switch to Markdown or other markup languages at this time.<li><strong>Note 4:</strong> The HTML here is not intended to display an entire HTML webpage; it is merely used as a styled Markdown rendering string. <strong>(To render a full page of complex HTML, including images and tables, you still need to use WebView to load HTML.)</strong></ul><blockquote><p>I strongly recommend using Markdown as the string rendering medium. If your project faces similar challenges and you have to use HTML without an elegant tool for converting to NSAttributedString, then please proceed with caution.</p></blockquote><blockquote><p>Friends who remember the previous article can jump directly to the ZhgChgLi / ZMarkupParser section.</p></blockquote><h4 id="nsattributedstringdocumenttypehtml"><span class="me-2">NSAttributedString.DocumentType.html</span><a href="#nsattributedstringdocumenttypehtml" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Most methods found online for converting HTML to NSAttributedString involve directly using the options provided by NSAttributedString to render HTML. Here’s an example:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">htmlString</span> <span class="o">=</span> <span class="s">"&lt;b&gt;Test&lt;a&gt;Link&lt;/a&gt;&lt;/b&gt;"</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">htmlString</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">attributedOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentReadingOptionKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
  <span class="o">.</span><span class="nv">documentType</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">DocumentType</span><span class="o">.</span><span class="n">html</span><span class="p">,</span>
  <span class="o">.</span><span class="nv">characterEncoding</span><span class="p">:</span> <span class="kt">String</span><span class="o">.</span><span class="kt">Encoding</span><span class="o">.</span><span class="n">utf8</span><span class="o">.</span><span class="n">rawValue</span>
<span class="p">]</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">attributedOptions</span><span class="p">,</span> <span class="nv">documentAttributes</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Problems with this approach:</strong></p><ul><li><strong>Poor performance:</strong> This method renders styles through the WebView Core and then switches back to the Main Thread for UI display; rendering over 300 characters takes about 0.03 seconds.<li><strong>Text loss:</strong> For example, marketing copy might use <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code>, which would be treated as an HTML tag and removed.<li><strong>Lack of customization:</strong> For instance, you cannot specify the degree of boldness for bold HTML in NSAttributedString.<li><a href="https://developer.apple.com/forums/thread/115405" target="_blank">Random crashes starting from iOS 12 with no official solution</a>.<li>A significant number of crashes appeared in iOS 15, with tests showing that under low battery conditions, it crashes 100% of the time (fixed in iOS ≥ 15.2).<li>Long strings cause crashes; testing shows that inputting strings longer than 54,600 characters results in a 100% crash (EXC_BAD_ACCESS).</ul><p>The most painful issue for us remains the crashing problem. From the release of iOS 15 until the fix in 15.2, our app was consistently plagued by this issue. Data shows that from March 11, 2022, to June 8, 2022, it caused over 2.4K crashes, affecting more than 1.4K users.</p><p>This crashing issue has existed since iOS 12, and iOS 15 merely encountered a larger pitfall. However, I suspect that the fix in iOS 15.2 is just a patch; the official team cannot eradicate the root cause.</p><p>The next issue is performance. As a markup language for string styles, it is heavily used in UILabel/UITextView throughout the app. As mentioned earlier, rendering a single label takes 0.03 seconds, and multiplying that across a list of UILabels/UITextViews can lead to noticeable lag in user interactions.</p><h4 id="xmlparser"><span class="me-2">XMLParser</span><a href="#xmlparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The second solution is to use XMLParser to parse the HTML into corresponding NSAttributedString keys and apply styles, as introduced in the previous article.</p><p>You can refer to the implementation of <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> and the content of the previous article for more details.</p><blockquote><p>The previous article only explored the possibility of using XMLParser to parse HTML and perform corresponding conversions, completing an experimental implementation without designing it as a well-structured and extensible “tool.”</p></blockquote><p><strong>Problems with this approach:</strong></p><ul><li><strong>Zero fault tolerance:</strong> HTML like <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code>, and <code class="language-plaintext highlighter-rouge">&lt;b&gt;Bold&lt;i&gt;Bold+Italic&lt;/b&gt;Italic&lt;/i&gt;</code> can lead to errors in XMLParser, throwing an error and displaying a blank result.<li>When using XMLParser, the HTML string must strictly adhere to XML rules, unlike browsers or NSAttributedString.DocumentType.html, which can display with some fault tolerance.</ul><h4 id="standing-on-the-shoulders-of-giants"><span class="me-2">Standing on the Shoulders of Giants</span><a href="#standing-on-the-shoulders-of-giants" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Neither of the above solutions perfectly and elegantly solves the HTML problem, so I began searching for existing solutions.</p><ul><li><a href="https://github.com/johnxnguyen" target="_blank">johnxnguyen</a> / <a href="https://github.com/johnxnguyen/Down" target="_blank">Down</a> only supports converting Markdown to Any (XML/NSAttributedString…) but does not support converting HTML.<li><a href="https://github.com/malcommac" target="_blank">malcommac</a> / <a href="https://github.com/malcommac/SwiftRichString" target="_blank">SwiftRichString</a> uses XMLParser under the hood, and tests show that it has the same zero fault tolerance issues as mentioned earlier.<li><a href="https://github.com/scinfu" target="_blank">scinfu</a> / <a href="https://github.com/scinfu/SwiftSoup" target="_blank">SwiftSoup</a> only supports HTML parsing (Selector) and does not support conversion to NSAttributedString <a href="https://github.com/scinfu/SwiftSoup/issues/127" target="_blank">as noted in this issue</a>.</ul><blockquote><p>After searching extensively, I found that the results were similar to the projects mentioned above. There were no giants’ shoulders to stand on.</p></blockquote><h3 id="zhgchglizmarkupparser"><span class="me-2">ZhgChgLi/ZMarkupParser</span><a href="#zhgchglizmarkupparser" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img src="https://repository-images.githubusercontent.com/602927147/57ce75c1-8548-449c-b44a-f4b0451ed5ea" alt="" loading="lazy"></a></p><p>With no giants’ shoulders to rely on, I had to become the giant myself and developed a tool to convert HTML strings to NSAttributedString.</p><p>Developed entirely in Swift, it uses Regex to parse HTML tags and undergoes tokenization, analyzing and correcting tag validity (fixing missing end tags and misaligned tags), converting to an abstract syntax tree, and finally using the Visitor Pattern to map HTML tags to abstract styles, resulting in the final NSAttributedString. This tool does not rely on any parser libraries.</p><h4 id="features"><span class="me-2">Features</span><a href="#features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>Supports HTML rendering (to NSAttributedString), stripping HTML tags, and selector functionality.<li>Higher performance than <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code>.<li>Automatically analyzes and corrects tag validity (fixing missing end tags and misaligned tags).<li>Supports dynamic style settings from <code class="language-plaintext highlighter-rouge">style="color:red..."</code>.<li>Allows customization of style specifications, such as how bold a bold tag should be.<li>Supports flexible extensibility for tags or custom tags and attributes.</ul><blockquote><p>For detailed introduction and installation instructions, please refer to this article: “<a href="/posts/zrealm-dev/en/zmarkupparser-html-string-to-nsattributedstring-converter-tool-a5643de271e4/"><strong>ZMarkupParser HTML String to NSAttributedString Tool</strong></a>”.</p></blockquote><p>You can directly <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">git clone the project</a> and open the <code class="language-plaintext highlighter-rouge">ZMarkupParser.xcworkspace</code> project, selecting the <code class="language-plaintext highlighter-rouge">ZMarkupParser-Demo</code> target to build and run it for experimentation.</p><p><a href="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*PzYcnSkW7qKeJBkaiNTKjQ.gif" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyOTUiIGhlaWdodD0iNjQwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><h3 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, I want to share the technical details regarding the development of this tool.</p><p><a href="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*YF5L7gefMCMwU1wmnGgy6A.webp" alt="Overview of Operation Process" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9Ijc5NiI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The above image illustrates the general operation process. Subsequent articles will introduce each step and include code snippets.</p><blockquote><p>⚠️️️️️️ This article will simplify demo code, reduce abstraction, and focus on explaining the operational principles. For the final results, please refer to the project <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">source code</a>.</p></blockquote><h3 id="code-implementation--tokenization"><span class="me-2">Code Implementation — Tokenization</span><a href="#code-implementation--tokenization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>a.k.a. parser, parsing</p></blockquote><p>When it comes to HTML rendering, the most crucial aspect is the parsing stage. Previously, I used XMLParser to treat HTML as XML for parsing; however, it couldn’t overcome the fact that everyday HTML usage is not 100% XML-compliant, leading to parser errors and an inability to dynamically correct them.</p><p>After ruling out the use of XMLParser, the only option left in Swift was to use Regex for matching and parsing.</p><p>Initially, I thought I could directly use regex to extract “paired” HTML tags and recursively search for HTML tags layer by layer until completion. However, this approach does not address the nesting of HTML tags or the need for fault tolerance for misaligned tags. Therefore, we changed our strategy to extract “single” HTML tags, recording whether they are start tags, close tags, or self-closing tags, along with other string combinations to form the parsing result array.</p><p><strong>The Tokenization Structure is as follows:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="kd">enum</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">start</span><span class="p">(</span><span class="kt">StartItem</span><span class="p">)</span> <span class="c1">// &lt;a&gt;</span>
    <span class="k">case</span> <span class="nf">close</span><span class="p">(</span><span class="kt">CloseItem</span><span class="p">)</span> <span class="c1">// &lt;/a&gt;</span>
    <span class="k">case</span> <span class="nf">selfClosing</span><span class="p">(</span><span class="kt">SelfClosingItem</span><span class="p">)</span> <span class="c1">// &lt;br/&gt;</span>
    <span class="k">case</span> <span class="nf">rawString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLParsedResult</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">StartItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>

        <span class="c1">// Start Tag may be an abnormal HTML Tag or normal text e.g. &lt;Congratulation!&gt;. After normalization, if it is found to be an isolated Start Tag, it will be marked as True.</span>
        <span class="k">var</span> <span class="nv">isIsolated</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
        
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span> <span class="p">:</span> <span class="kt">String</span><span class="p">]?)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span> <span class="o">=</span> <span class="n">tagAttributedString</span>
            <span class="k">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="p">}</span>
        
        <span class="c1">// For subsequent normalization automatic correction</span>
        <span class="kd">func</span> <span class="nf">convertToCloseParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CloseItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">CloseItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1">// For subsequent normalization automatic correction</span>
        <span class="kd">func</span> <span class="nf">convertToSelfClosingParsedItem</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SelfClosingItem</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">SelfClosingItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="kt">CloseItem</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span>
        <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>The regex used is as follows:</strong></p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">&lt;</span><span class="p">(</span><span class="sc">?:</span><span class="p">(?</span><span class="o">&lt;</span><span class="n">closeTag</span><span class="o">&gt;</span><span class="p">\</span><span class="sr">/)?(?&lt;tagName&gt;[A-Za-z0-9]+)(?&lt;tagAttributes&gt;(?:\s*(\w+)\s*=\s*(["|']).*?\5)*)\s*(?&lt;selfClosingTag&gt;\/)?&gt;)
</span></pre></table></code></div></div><p>-&gt; <a href="https://regex101.com/r/aBrID8/1" target="_blank">Online Regex101 Playground</a></p><ul><li>closeTag: Matches &lt; <code class="language-plaintext highlighter-rouge">/</code> a&gt;<li>tagName: Matches &lt; <code class="language-plaintext highlighter-rouge">a</code> &gt; or , &lt;/ <code class="language-plaintext highlighter-rouge">a</code> &gt;<li>tagAttributes: Matches &lt;a <code class="language-plaintext highlighter-rouge">href=”https://zhgchg.li” style=”color:red”</code> &gt;<li>selfClosingTag: Matches &lt;br <code class="language-plaintext highlighter-rouge">/</code> &gt;</ul><blockquote><p>*This regex can still be optimized further; I will address that later.</p></blockquote><blockquote><p>The latter part of the article provides additional information about regex for those interested.</p></blockquote><p><strong>Putting it all together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">tokenizationResult</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">let</span> <span class="nv">expression</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">NSRegularExpression</span><span class="p">(</span><span class="nv">pattern</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="n">expressionOptions</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">totalLength</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="c1">// utf-16 support emoji</span>
<span class="k">var</span> <span class="nv">lastMatch</span><span class="p">:</span> <span class="kt">NSTextCheckingResult</span><span class="p">?</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="c1">// Check if the HTML string requires subsequent normalization to correct misalignment or add Self-Closing Tags</span>
<span class="k">var</span> <span class="nv">stackStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">needForamatter</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>

<span class="n">expression</span><span class="o">.</span><span class="nf">enumerateMatches</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totalLength</span><span class="p">))</span> <span class="p">{</span> <span class="n">match</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">match</span> <span class="o">=</span> <span class="n">match</span> <span class="p">{</span>
    <span class="c1">// Check the string between tags or the string before the first tag</span>
    <span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;zzz&lt;b&gt;bold&lt;/b&gt;Test2 - &gt; Test,zzz</span>
    <span class="k">let</span> <span class="nv">lastMatchEnd</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="p">?</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span> <span class="p">??</span> <span class="mi">0</span>
    <span class="k">let</span> <span class="nv">currentMatchStart</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">lowerBound</span>
    <span class="k">if</span> <span class="n">currentMatchStart</span> <span class="o">&gt;</span> <span class="n">lastMatchEnd</span> <span class="p">{</span>
      <span class="k">let</span> <span class="nv">rawStringBetweenTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">lastMatchEnd</span><span class="p">,</span> <span class="p">(</span><span class="n">currentMatchStart</span> <span class="o">-</span> <span class="n">lastMatchEnd</span><span class="p">)))</span>
      <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">rawStringBetweenTag</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// &lt;a href="https://zhgchg.li"&gt;, &lt;/a&gt;</span>
    <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
    <span class="c1">// a, a</span>
    <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagName"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="c1">// false, true</span>
    <span class="k">let</span> <span class="nv">matchIsEndTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"closeTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>
    <span class="c1">// href="https://zhgchg.li", nil</span>
    <span class="c1">// Use regex to further extract HTML attributes, to [String: String], please refer to Source Code</span>
    <span class="k">let</span> <span class="nv">matchTagAttributes</span> <span class="o">=</span> <span class="nf">parseAttributes</span><span class="p">(</span><span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"tagAttributes"</span><span class="p">)))</span>
    <span class="c1">// false, false</span>
    <span class="k">let</span> <span class="nv">matchIsSelfClosingTag</span> <span class="o">=</span> <span class="n">matchResult</span><span class="o">.</span><span class="nf">attributedString</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="nv">withName</span><span class="p">:</span> <span class="s">"selfClosingTag"</span><span class="p">))?</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">==</span> <span class="s">"/"</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">matchAttributedString</span> <span class="o">=</span> <span class="n">matchAttributedString</span><span class="p">,</span>
       <span class="k">let</span> <span class="nv">matchTag</span> <span class="o">=</span> <span class="n">matchTag</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">matchIsSelfClosingTag</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;br/&gt;</span>
          <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// e.g. &lt;a&gt; or &lt;/a&gt;</span>
          <span class="k">if</span> <span class="n">matchIsEndTag</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;/a&gt;</span>
            <span class="c1">// Retrieve the position of the same TagName from the Stack, starting from the last</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">lastIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">matchTag</span> <span class="p">})</span> <span class="p">{</span>
              <span class="c1">// If it's not the last one, it indicates there is a misalignment or a missing closing tag</span>
              <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">stackStartItems</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
                  <span class="n">needForamatter</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="p">}</span>
              <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">)))</span>
              <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">// Extra close tag e.g &lt;/a&gt;</span>
              <span class="c1">// Does not affect subsequent processing, simply ignore</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// e.g. &lt;a&gt;</span>
            <span class="k">let</span> <span class="nv">startItem</span><span class="p">:</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span> <span class="o">=</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">matchTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">matchAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">matchTagAttributes</span><span class="p">)</span>
            <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="n">startItem</span><span class="p">))</span>
            <span class="c1">// Push to Stack</span>
            <span class="n">stackStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">startItem</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">}</span>

    <span class="n">lastMatch</span> <span class="o">=</span> <span class="n">match</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Check the RawString at the end</span>
<span class="c1">// e.g. Test&lt;a&gt;Link&lt;/a&gt;Test2 - &gt; Test2</span>
<span class="k">if</span> <span class="k">let</span> <span class="nv">lastMatch</span> <span class="o">=</span> <span class="n">lastMatch</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">currentIndex</span> <span class="o">=</span> <span class="n">lastMatch</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">upperBound</span>
  <span class="k">if</span> <span class="n">totalLength</span> <span class="o">&gt;</span> <span class="n">currentIndex</span> <span class="p">{</span>
    <span class="c1">// There are remaining strings</span>
    <span class="k">let</span> <span class="nv">resetString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="n">currentIndex</span><span class="p">,</span> <span class="p">(</span><span class="n">totalLength</span> <span class="o">-</span> <span class="n">currentIndex</span><span class="p">)))</span>
    <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">resetString</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// lastMatch = nil, indicating no tags were found, all are plain text</span>
  <span class="k">let</span> <span class="nv">resetString</span> <span class="o">=</span> <span class="n">attributedString</span><span class="o">.</span><span class="nf">attributedSubstring</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">totalLength</span><span class="p">))</span>
  <span class="n">tokenizationResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">resetString</span><span class="p">))</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here’s the translated text in naturalistic English while preserving the original markdown image sources:</p><hr /><p>Check if the Stack is empty. If it isn’t, it means there are Start Tags without corresponding End Tags, which should be marked as isolated Start Tags.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">stackStartItem</span> <span class="k">in</span> <span class="n">stackStartItems</span> <span class="p">{</span>
  <span class="n">stackStartItem</span><span class="o">.</span><span class="n">isIsolated</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="n">needForamatter</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">tokenizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*U50CX56M_xy1EXZKb69YeA.webp" alt="The operation flow is shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjcyNSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation flow is shown in the image above.</p><p>In the end, we will obtain a Tokenization result array.</p><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLStringToParsedResultProcessor.swift" target="_blank">HTMLStringToParsedResultProcessor.swift</a> implementation.</p></blockquote><h3 id="normalization"><span class="me-2">Normalization</span><a href="#normalization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>Also known as Formatter, normalization.</p></blockquote><p>After obtaining the preliminary parsing results in the previous step, if we find that normalization is still needed during the parsing, this step is required to automatically correct HTML Tag issues.</p><p><strong>There are three types of HTML Tag issues:</strong></p><ul><li>HTML Tag missing a Close Tag: for example, <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code><li>Regular text being treated as an HTML Tag: for example, <code class="language-plaintext highlighter-rouge">&lt;Congratulation!&gt;</code><li>HTML Tag misalignment issues: for example, <code class="language-plaintext highlighter-rouge">&lt;a&gt;Li&lt;b&gt;nk&lt;/a&gt;Bold&lt;/b&gt;</code></ul><p>The correction method is quite simple; we need to traverse the elements of the Tokenization result and attempt to fill in the gaps.</p><p><a href="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*Wk-U_sQuvLo1OJhcE1BQPQ.webp" alt="The operation flow is shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjM4NyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation flow is shown in the image above.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">normalizationResult</span> <span class="o">=</span> <span class="n">tokenizationResult</span>

<span class="c1">// Start Tags Stack, First In Last Out (FILO)</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">var</span> <span class="nv">itemIndex</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">itemIndex</span> <span class="o">&lt;</span> <span class="n">newItems</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">newItems</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isIsolated</span> <span class="p">{</span>
            <span class="c1">// If it is an isolated Start Tag</span>
            <span class="k">if</span> <span class="kt">WC3HTMLTagName</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">?</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">??</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// If it is not a W3C defined HTML Tag &amp; has no HTML Attributes</span>
                <span class="c1">// Refer to the WC3HTMLTagName Enum in the Source Code</span>
                <span class="c1">// Considered as regular text treated as an HTML Tag</span>
                <span class="c1">// Change to raw string type</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Otherwise, change to self-closing tag, e.g. &lt;br&gt; -&gt; &lt;br/&gt;</span>
                <span class="n">normalizationResult</span><span class="p">[</span><span class="n">itemIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="nf">convertToSelfClosingParsedItem</span><span class="p">())</span>
            <span class="p">}</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Normal Start Tag, add to Stack</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Encounter Close Tag</span>
        <span class="c1">// Get the Tags between the Start Stack Tag and this Close Tag</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; gap 0</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt; gap b,u</span>

        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItems</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurredIndex</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="k">let</span> <span class="nv">reversedStackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">upTo</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">))</span>
        
        <span class="c1">// Gap 0 means the tag is not misaligned</span>
        <span class="k">guard</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// It's a pair, pop</span>
            <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">removeLast</span><span class="p">()</span>
            <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        
        <span class="c1">// If there are other gaps, automatically insert the missing Tags</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/a&gt;&lt;/u&gt;&lt;/b&gt; -&gt;</span>
        <span class="c1">// e.g &lt;a&gt;&lt;u&gt;&lt;b&gt;[CurrentIndex]&lt;/b&gt;&lt;/u&gt;&lt;/a&gt;&lt;b&gt;&lt;/u&gt;&lt;/u&gt;&lt;/b&gt;</span>
        <span class="k">let</span> <span class="nv">stackExpectedStartItemsOccurred</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">reversed</span><span class="p">())</span>
        <span class="k">let</span> <span class="nv">afterItems</span> <span class="o">=</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="k">let</span> <span class="nv">beforeItems</span> <span class="o">=</span> <span class="n">reversedStackExpectedStartItemsOccurred</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="nf">convertToCloseParsedItem</span><span class="p">())</span> <span class="p">})</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">afterItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">))</span>
        <span class="n">normalizationResult</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">beforeItems</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span>
        
        <span class="n">itemIndex</span> <span class="o">=</span> <span class="n">newItems</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="n">itemIndex</span><span class="p">)</span> <span class="o">+</span> <span class="n">stackExpectedStartItemsOccurred</span><span class="o">.</span><span class="n">count</span>
        
        <span class="c1">// Update Start Stack Tags</span>
        <span class="c1">// e.g. -&gt; b,u</span>
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">startItem</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">reversedStackExpectedStartItems</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="nv">through</span><span class="p">:</span> <span class="n">reversedStackExpectedStartItemsOccurredIndex</span><span class="p">)</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">startItem</span> <span class="p">})</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="n">selfClosing</span><span class="p">,</span> <span class="o">.</span><span class="nv">rawString</span><span class="p">:</span>
        <span class="n">itemIndex</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="n">normalizationResult</span><span class="p">)</span>
<span class="c1">// [</span>
<span class="c1">//    .start("a",["href":"https://zhgchg.li"])</span>
<span class="c1">//    .rawString("Li")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("nk")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">//    .close("a")</span>
<span class="c1">//    .start("b",nil)</span>
<span class="c1">//    .rawString("Bold")</span>
<span class="c1">//    .close("b")</span>
<span class="c1">// ]</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultFormatterProcessor.swift" target="_blank">HTMLParsedResultFormatterProcessor.swift</a> implementation.</p></blockquote><h3 id="abstract-syntax-tree"><span class="me-2">Abstract Syntax Tree</span><a href="#abstract-syntax-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>Also known as AST, Abstract Tree.</p></blockquote><p>After completing the data preprocessing with Tokenization &amp; Normalization, we will now convert the results into an abstract tree 🌲.</p><p><a href="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*40z0o7R0OROURWCQVDmKrw.webp" alt="As shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDI4IiBoZWlnaHQ9IjU4NCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>As shown in the image above.</p><p>Converting to an abstract tree allows us to facilitate future operations and expansions, such as implementing Selector functionality or performing other transformations, like HTML to Markdown; or if we want to add Markdown to NSAttributedString in the future, we just need to implement Markdown’s Tokenization &amp; Normalization to achieve it.</p><p><strong>First, we define a Markup Protocol with Child &amp; Parent properties to record information about leaves and branches:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">Markup</span><span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="k">set</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span>
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="p">:</span> <span class="kt">MarkupVisitor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">prependChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="o">=</span> <span class="k">self</span>
        <span class="n">childMarkups</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">markup</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Additionally, we use the <a href="/posts/zrealm-dev/en/visitor-pattern-in-ios-swift-ba5773a7bfea/">Visitor Pattern</a> to define each style property as an object Element, and through different Visit strategies, we can obtain individual application results.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">Result</span>
        
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Basic Markup Nodes:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">// Root Node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RootMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Leaf Node</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">RawStringMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedString</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
    
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Defining Markup Style Nodes:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">// Branch Node:</span>

<span class="c1">// Link Style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">LinkMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Bold Style</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">BoldMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/Markup" target="_blank">Markup</a> implementation.</p></blockquote><p>Before converting to an abstract tree, we still need to…</p><h4 id="markupcomponent"><span class="me-2">MarkupComponent</span><a href="#markupcomponent" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><strong>Because our tree structure does not depend on any data structure (for example, a node/LinkMarkup should have URL information to proceed with rendering).</strong> <strong>To address this, we define a container to store tree nodes and their related data information:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">protocol</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">T</span>
    <span class="k">var</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Sequence</span> <span class="k">where</span> <span class="kt">Iterator</span><span class="o">.</span><span class="kt">Element</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">markup</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})?</span><span class="o">.</span><span class="n">value</span> <span class="k">as?</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">T</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupComponent" target="_blank">MarkupComponent</a> implementation.</p></blockquote><p>We could also declare Markup as <code class="language-plaintext highlighter-rouge">Hashable</code> and directly use a Dictionary to store values <code class="language-plaintext highlighter-rouge">[Markup: Any]</code>, but this would prevent Markup from being used as a regular type, requiring the addition of <code class="language-plaintext highlighter-rouge">any Markup</code>.</p><h4 id="htmltag--htmltagname--htmltagnamevisitor"><span class="me-2">HTMLTag &amp; HTMLTagName &amp; HTMLTagNameVisitor</span><a href="#htmltag--htmltagname--htmltagnamevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We also abstract the HTML Tag Name part, allowing users to decide which Tags need to be processed, making future expansions easier. For example, the <code class="language-plaintext highlighter-rouge">&lt;strong&gt;</code> Tag Name can also correspond to <code class="language-plaintext highlighter-rouge">BoldMarkup</code>.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">A_HTMLTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kt">WC3HTMLTagName</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">rawValue</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">B_HTMLTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kt">WC3HTMLTagName</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">rawValue</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagNameVisitor.swift" target="_blank">HTMLTagNameVisitor</a> implementation.</p></blockquote><blockquote><p>Additionally, refer to the W3C wiki which lists the HTML tag name enum: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/WC3HTMLTagName.swift" target="_blank">WC3HTMLTagName.swift</a>.</p></blockquote><p><strong>HTMLTag is simply a container object, as we want to allow external specification of the styles corresponding to HTML Tags, so we declare a container to hold them together:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTag</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span>
    <span class="k">let</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="c1">// To be explained in the Render section later</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tagName</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">customStyle</span> <span class="o">=</span> <span class="n">customStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTag.swift3" target="_blank">HTMLTag</a> implementation.</p></blockquote><h4 id="htmltagnametohtmlmarkupvisitor"><span class="me-2">HTMLTagNameToHTMLMarkupVisitor</span><a href="#htmltagnametohtmlmarkupvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">Markup</span>
    
    <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">A_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">LinkMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagName</span><span class="p">:</span> <span class="kt">B_HTMLTagName</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">BoldMarkup</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagNameToHTMLMarkupVisitor.swift" target="_blank">HTMLTagNameToHTMLMarkupVisitor</a> implementation.</p></blockquote><h4 id="converting-to-an-abstract-tree-with-html-data"><span class="me-2">Converting to an Abstract Tree with HTML Data</span><a href="#converting-to-an-abstract-tree-with-html-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We need to convert the normalized HTML data results into an abstract tree. First, we declare a data structure for MarkupComponent that can hold HTML data:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">HTMLElement</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">HTMLTag</span>
        <span class="k">let</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span>
        <span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">String</span><span class="p">]?</span>
    <span class="p">}</span>
    
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">HTMLElement</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Converting to a Markup Abstract Tree:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="nv">htmlElementComponents</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">let</span> <span class="nv">rootMarkup</span> <span class="o">=</span> <span class="kt">RootMarkup</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="o">=</span> <span class="n">rootMarkup</span>

<span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">HTMLTag</span><span class="p">]</span>
<span class="nf">init</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span> <span class="o">=</span> <span class="kt">Dictionary</span><span class="p">(</span><span class="nv">uniqueKeysWithValues</span><span class="p">:</span> <span class="n">htmlTags</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// Start Tags Stack, ensuring correct pop tag</span>
<span class="c1">// Normalization has already been done, so there shouldn't be any errors, just ensuring</span>
<span class="k">var</span> <span class="nv">stackExpectedStartItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLParsedResult</span><span class="o">.</span><span class="kt">StartItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">thisItem</span> <span class="k">in</span> <span class="n">from</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">thisItem</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="c1">// Use Visitor to ask for the corresponding Markup</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        
        <span class="c1">// Add itself as the current branch's leaf node</span>
        <span class="c1">// It becomes the current branch node</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">markup</span>
        
        <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">selfClosing</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="c1">// Directly add as the current branch's leaf node</span>
        <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagNameToMarkupVisitor</span><span class="p">(</span><span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">htmlTag</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">htmlTags</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">]</span> <span class="p">??</span> <span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="kt">ExtendTagName</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tagName</span><span class="p">))</span>
        <span class="k">let</span> <span class="nv">markup</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="p">)</span>
        <span class="n">htmlElementComponents</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="n">htmlTag</span><span class="p">,</span> <span class="nv">tagAttributedString</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">tagAttributedString</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">attributes</span><span class="p">)))</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="k">let</span> <span class="nv">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">lastTagName</span> <span class="o">=</span> <span class="n">stackExpectedStartItems</span><span class="o">.</span><span class="nf">popLast</span><span class="p">()?</span><span class="o">.</span><span class="n">tagName</span><span class="p">,</span>
           <span class="n">lastTagName</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">tagName</span> <span class="p">{</span>
            <span class="c1">// Encounter Close Tag, go back to the previous level</span>
            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="p">??</span> <span class="n">currentMarkup</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">rawString</span><span class="p">(</span><span class="k">let</span> <span class="nv">attributedString</span><span class="p">):</span>
        <span class="c1">// Directly add as the current branch's leaf node</span>
        <span class="n">currentMarkup</span><span class="o">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(htmlElementComponents)</span>
<span class="c1">// [(markup: LinkMarkup, (tag: a, attributes: ["href":"zhgchg.li"]...)]</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*D-oMszCDzsBpUYnCEWGKHQ.webp" alt="The operation result is shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE0IiBoZWlnaHQ9Ijc0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operation result is shown in the image above.</p><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift" target="_blank">HTMLParsedResultToHTMLElementWithRootMarkupProcessor.swift</a> implementation.</p></blockquote><h4 id="at-this-point-we-have-actually-completed-the-selector-functionality-"><span class="me-2">At this point, we have actually completed the Selector functionality 🎉</span><a href="#at-this-point-we-have-actually-completed-the-selector-functionality-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="kt">HTMLSelector</span><span class="p">:</span> <span class="kt">CustomStringConvertible</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="n">components</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">filter</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">HTMLSelector</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span> <span class="p">??</span> <span class="kc">false</span> <span class="p">})</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="n">components</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can filter leaf node objects layer by layer.</p><blockquote><p>Corresponding to the source code in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLSelector.swift" target="_blank">HTMLSelector</a> implementation.</p></blockquote><h3 id="parser--html-to-markupstyle-abstract-of-nsattributedstringkey"><span class="me-2">Parser — HTML to MarkupStyle (Abstract of NSAttributedString.Key)</span><a href="#parser--html-to-markupstyle-abstract-of-nsattributedstringkey" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Next, we need to complete the conversion of HTML to MarkupStyle (NSAttributedString.Key).</p><p>NSAttributedString uses NSAttributedString.Key Attributes to set text styles. We abstract all fields of NSAttributedString.Key to MarkupStyle, MarkupStyleColor, MarkupStyleFont, and MarkupStyleParagraphStyle.</p><p><strong>Purpose:</strong></p><ul><li>The original Attributes data structure is <code class="language-plaintext highlighter-rouge">[NSAttributedString.Key: Any?]</code>. If we expose it directly, it becomes difficult to control the values users input. If they input incorrectly, it could lead to crashes, such as <code class="language-plaintext highlighter-rouge">.font: 123</code>.<li>Styles need to be inheritable, for example, <code class="language-plaintext highlighter-rouge">&lt;a&gt;&lt;b&gt;test&lt;/b&gt;&lt;/a&gt;</code>, the style of the string “test” inherits from the link’s bold (bold + link); if we expose the Dictionary directly, it becomes difficult to manage inheritance rules.<li>Encapsulate iOS/macOS (UIKit/AppKit) related objects.</ul><hr /><p>This translation maintains the original structure and meaning while ensuring the text flows naturally in English.</p><h4 id="markupstyle-struct"><span class="me-2">MarkupStyle Struct</span><a href="#markupstyle-struct" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyle</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">font</span><span class="p">:</span> <span class="kt">MarkupStyleFont</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphStyle</span><span class="p">:</span> <span class="kt">MarkupStyleParagraphStyle</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">foregroundColor</span><span class="p">:</span> <span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">backgroundColor</span><span class="p">:</span> <span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">ligature</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">kern</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tracking</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughStyle</span><span class="p">:</span> <span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineStyle</span><span class="p">:</span> <span class="kt">NSUnderlineStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeColor</span><span class="p">:</span> <span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strokeWidth</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">shadow</span><span class="p">:</span> <span class="kt">NSShadow</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textEffect</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">attachment</span><span class="p">:</span> <span class="kt">NSTextAttachment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">link</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baselineOffset</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">underlineColor</span><span class="p">:</span> <span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">strikethroughColor</span><span class="p">:</span> <span class="kt">MarkupStyleColor</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">obliqueness</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">expansion</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">writingDirection</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">verticalGlyphForm</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>

    <span class="c1">// Inherits from...</span>
    <span class="c1">// Default: If fields are nil, fill in from the provided object</span>
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">from</span> <span class="o">=</span> <span class="n">from</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        
        <span class="k">var</span> <span class="nv">currentFont</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">font</span>
        <span class="n">currentFont</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">font</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="n">currentFont</span>
        
        <span class="k">var</span> <span class="nv">currentParagraphStyle</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span>
        <span class="n">currentParagraphStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="n">paragraphStyle</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">paragraphStyle</span> <span class="o">=</span> <span class="n">currentParagraphStyle</span>
        <span class="c1">//..</span>
    <span class="p">}</span>

    <span class="c1">// Convert MarkupStyle to NSAttributedString.Key: Any</span>
    <span class="kd">func</span> <span class="nf">render</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">font</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="nf">getFont</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">font</span><span class="p">]</span> <span class="o">=</span> <span class="n">font</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">ligature</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">ligature</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">[</span><span class="o">.</span><span class="n">ligature</span><span class="p">]</span> <span class="o">=</span> <span class="n">ligature</span>
        <span class="p">}</span>
        <span class="c1">//...</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleFont</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeight</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">style</span><span class="p">(</span><span class="kt">FontWeightStyle</span><span class="p">)</span>
        <span class="k">case</span> <span class="nf">rawValue</span><span class="p">(</span><span class="kt">CGFloat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">FontWeightStyle</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ultraLight</span><span class="p">,</span> <span class="n">light</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">regular</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">semibold</span><span class="p">,</span> <span class="n">bold</span><span class="p">,</span> <span class="n">heavy</span><span class="p">,</span> <span class="n">black</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">weight</span><span class="p">:</span> <span class="kt">FontWeight</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">italic</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleParagraphStyle</span><span class="p">:</span> <span class="kt">MarkupStyleItem</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineSpacing</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacing</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">alignment</span><span class="p">:</span> <span class="kt">NSTextAlignment</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">headIndent</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tailIndent</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">firstLineHeadIndent</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">minimumLineHeight</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">maximumLineHeight</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakMode</span><span class="p">:</span> <span class="kt">NSLineBreakMode</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">baseWritingDirection</span><span class="p">:</span> <span class="kt">NSWritingDirection</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineHeightMultiple</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">paragraphSpacingBefore</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">hyphenationFactor</span><span class="p">:</span> <span class="kt">Float</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">usesDefaultHyphenation</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">tabStops</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextTab</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">defaultTabInterval</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">textLists</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSTextList</span><span class="p">]?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">allowsDefaultTighteningForTruncation</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">lineBreakStrategy</span><span class="p">:</span> <span class="kt">NSParagraphStyle</span><span class="o">.</span><span class="kt">LineBreakStrategy</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">MarkupStyleColor</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">red</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">green</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">blue</span><span class="p">:</span> <span class="kt">Int</span>
    <span class="k">let</span> <span class="nv">alpha</span><span class="p">:</span> <span class="kt">CGFloat</span>
    <span class="c1">//...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/Core/MarkupStyle" target="_blank">MarkupStyle</a> implementation</p></blockquote><blockquote><p>Additionally, refer to the W3C wiki, which lists corresponding color names and their RGB values: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleColorName.swift" target="_blank">MarkupStyleColorName.swift</a></p></blockquote><h4 id="htmltagstyleattribute--htmltagstyleattributevisitor"><span class="me-2">HTMLTagStyleAttribute &amp; HTMLTagStyleAttributeVisitor</span><a href="#htmltagstyleattribute--htmltagstyleattributevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>I would like to mention these two objects because HTML Tags can be styled using CSS. We apply the same abstraction from HTMLTagName to HTML Style Attributes.</p><p>For example, HTML might provide: <code class="language-plaintext highlighter-rouge">&lt;a style="color:red;font-size:14px"&gt;RedLink&lt;/a&gt;</code>, indicating that this link should be styled in red with a font size of 14px.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">HTMLTagStyleAttribute</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
    <span class="kd">associatedtype</span> <span class="kt">Result</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">styleAttribute</span><span class="o">.</span><span class="nf">accept</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/tree/main/Sources/ZMarkupParser/HTML/HTMLTag/HTMLTagStyleAttribute" target="_blank">HTMLTagStyleAttribute</a> implementation</p></blockquote><h4 id="htmltagstyleattributetomarkupstylevisitor"><span class="me-2">HTMLTagStyleAttributeToMarkupStyleVisitor</span><a href="#htmltagstyleattributetomarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Use regex to extract Color Hex or map from HTML Pre-defined Color Name; see Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">color</span> <span class="o">=</span> <span class="kt">MarkupStyleColor</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">foregroundColor</span><span class="p">:</span> <span class="n">color</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Use regex to extract 10px -&gt; 10; see Source Code</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="nf">convert</span><span class="p">(</span><span class="nv">fromPX</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="kt">MarkupStyle</span><span class="p">(</span><span class="nv">font</span><span class="p">:</span> <span class="kt">MarkupStyleFont</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLTagAttributeToMarkupStyleVisitor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a> implementation</p></blockquote><p>The <code class="language-plaintext highlighter-rouge">init</code> value corresponds to the attribute’s value, which is converted to the corresponding MarkupStyle field based on the visit type.</p><h4 id="htmlelementmarkupcomponentmarkupstylevisitor"><span class="me-2">HTMLElementMarkupComponentMarkupStyleVisitor</span><a href="#htmlelementmarkupcomponentmarkupstylevisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>After introducing the MarkupStyle object, we will convert the results from Normalization’s HTMLElementComponents into MarkupStyle.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="c1">// MarkupStyle Strategy</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">MarkupStylePolicy</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromCode</span> <span class="c1">// Prioritize styles from Code, filling in from HTML Style Attributes</span>
    <span class="k">case</span> <span class="n">respectMarkupStyleFromHTMLStyleAttribute</span> <span class="c1">// Prioritize styles from HTML Style Attributes, filling in from Code</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>

    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>

    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .bold is just a default style defined in MarkupStyle; see Source Code</span>
        <span class="k">return</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">bold</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// .link is just a default style defined in MarkupStyle; see Source Code</span>
        <span class="k">var</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="o">.</span><span class="n">link</span><span class="p">)</span> <span class="p">??</span> <span class="o">.</span><span class="n">link</span>
        
        <span class="c1">// Retrieve the corresponding HtmlElement from HtmlElementComponents for LinkMarkup</span>
        <span class="c1">// Look for the href parameter in the HtmlElement's attributes (the way HTML carries URL Strings)</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">href</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"href"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">href</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">markupStyle</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">url</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span> <span class="p">{</span>
    <span class="c1">// Retrieve the specified custom MarkupStyle from the HTMLTag container</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">customStyle</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">customStyle</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">customStyle</span>
    <span class="p">}</span>
    
    <span class="c1">// Default action</span>
    <span class="kd">func</span> <span class="nf">defaultVisit</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlElement</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponent</span><span class="o">.</span><span class="kt">HTMLElement</span><span class="p">?,</span> <span class="n">defaultStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="nf">customStyle</span><span class="p">(</span><span class="n">htmlElement</span><span class="p">)</span> <span class="p">??</span> <span class="n">defaultStyle</span>
        <span class="c1">// Retrieve the corresponding HtmlElement for LinkMarkup from HtmlElementComponents</span>
        <span class="c1">// Check if the HtmlElement's attributes contain a `Style` Attribute</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">styleString</span> <span class="o">=</span> <span class="n">htmlElement</span><span class="p">?</span><span class="o">.</span><span class="n">attributes</span><span class="p">?[</span><span class="s">"style"</span><span class="p">],</span>
              <span class="n">styleAttributes</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// None</span>
            <span class="k">return</span> <span class="n">markupStyle</span>
        <span class="p">}</span>

        <span class="c1">// There are Style Attributes</span>
        <span class="c1">// Split the Style Value string into an array</span>
        <span class="c1">// font-size:14px;color:red -&gt; ["font-size":"14px","color":"red"]</span>
        <span class="k">let</span> <span class="nv">styles</span> <span class="o">=</span> <span class="n">styleString</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">";"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">}</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">split</span><span class="p">(</span><span class="nv">separator</span><span class="p">:</span> <span class="s">":"</span><span class="p">)</span> <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">style</span> <span class="k">in</span> <span class="n">styles</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="n">style</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">continue</span>
            <span class="p">}</span>
            <span class="c1">// e.g. font-size</span>
            <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            <span class="c1">// e.g. 14px</span>
            <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="k">let</span> <span class="nv">styleAttribute</span> <span class="o">=</span> <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">isEqualTo</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
                <span class="c1">// Use the previously mentioned HTMLTagStyleAttributeToMarkupStyleVisitor to convert back to MarkupStyle</span>
                <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLTagStyleAttributeToMarkupStyleVisitor</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">var</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">styleAttribute</span><span class="p">:</span> <span class="n">styleAttribute</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// If the Style Attribute has a value...</span>
                    <span class="c1">// Merge the previous MarkupStyle result</span>
                    <span class="n">thisMarkupStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                    <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="c1">// If there is a default Style</span>
        <span class="k">if</span> <span class="k">var</span> <span class="nv">defaultStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">policy</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromHTMLStyleAttribute</span><span class="p">:</span>
                  <span class="c1">// Style Attribute MarkupStyle takes precedence, then</span>
                  <span class="c1">// Merge the defaultStyle result</span>
                    <span class="n">markupStyle</span><span class="p">?</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">defaultStyle</span><span class="p">)</span>
                <span class="k">case</span> <span class="o">.</span><span class="nv">respectMarkupStyleFromCode</span><span class="p">:</span>
                  <span class="c1">// defaultStyle takes precedence, then</span>
                  <span class="c1">// Merge the Style Attribute MarkupStyle result</span>
                  <span class="n">defaultStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
                  <span class="n">markupStyle</span> <span class="o">=</span> <span class="n">defaultStyle</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">markupStyle</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLElementWithMarkupToMarkupStyleProcessor.swift" target="_blank">HTMLTagAttributeToMarkupStyleVisitor.swift</a> implementation</p></blockquote><p>We will define some default styles in <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyle%2BExtension.swift" target="_blank">MarkupStyle</a>, which will be used when certain Markup does not have externally specified styles.</p><p><strong>There are two style inheritance strategies:</strong></p><ul><li>respectMarkupStyleFromCode: Use the default style as the primary; then see what styles can be supplemented from Style Attributes, ignoring existing values.<li>respectMarkupStyleFromHTMLStyleAttribute: Use the Style Attributes as the primary; then see what styles can be supplemented from the default style, ignoring existing values.</ul><h4 id="htmlelementwithmarkuptomarkupstyleprocessor"><span class="me-2">HTMLElementWithMarkupToMarkupStyleProcessor</span><a href="#htmlelementwithmarkuptomarkupstyleprocessor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This converts the normalization results into an AST &amp; MarkupStyleComponent.</p><p><strong>We declare a new MarkupComponent to store the corresponding MarkupStyle:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupStyleComponent</span><span class="p">:</span> <span class="kt">MarkupComponent</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">T</span> <span class="o">=</span> <span class="kt">MarkupStyle</span>
    
    <span class="k">let</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">markup</span> <span class="o">=</span> <span class="n">markup</span>
        <span class="k">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>A simple traversal of the Markup Tree &amp; HTMLElementMarkupComponent structure:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span>
    
<span class="kd">func</span> <span class="nf">process</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="p">(</span><span class="kt">Markup</span><span class="p">,</span> <span class="p">[</span><span class="kt">HTMLElementMarkupComponent</span><span class="p">]))</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">visitor</span> <span class="o">=</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">)</span>
  <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">from</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">components</span>
<span class="p">}</span>
    
<span class="kd">func</span> <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">HTMLElementMarkupComponentMarkupStyleVisitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">])</span> <span class="p">{</span>
        
  <span class="k">if</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">components</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
  <span class="p">}</span>
        
  <span class="k">for</span> <span class="n">markup</span> <span class="k">in</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span> <span class="p">{</span>
    <span class="nf">walk</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">visitor</span><span class="p">:</span> <span class="n">visitor</span><span class="p">,</span> <span class="nv">components</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">components</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// print(components)</span>
<span class="c1">// [(markup: LinkMarkup, MarkupStyle(link: https://zhgchg.li, color: .blue)]</span>
<span class="c1">// [(markup: BoldMarkup, MarkupStyle(font: .init(weight: .bold))]</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/Processor/HTMLElementWithMarkupToMarkupStyleProcessor.swift" target="_blank">HTMLElementWithMarkupToMarkupStyleProcessor.swift</a> implementation</p></blockquote><p><a href="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*JEMBNdbQcBgDQ49jFw4ePQ.webp" alt="The process result is shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTE0IiBoZWlnaHQ9IjExMTAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><h3 id="render--convert-to-nsattributedstring"><span class="me-2">Render — Convert To NSAttributedString</span><a href="#render--convert-to-nsattributedstring" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we have the abstract tree structure of HTML Tags and the corresponding MarkupStyle, the final step is to produce the final NSAttributedString rendering result.</p><h4 id="markupnsattributedstringvisitor"><span class="me-2">MarkupNSAttributedStringVisitor</span><a href="#markupnsattributedstringvisitor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Visit markup to NSAttributedString</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre><td class="rouge-code"><pre><span class="kd">struct</span> <span class="kt">MarkupNSAttributedStringVisitor</span><span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Result</span> <span class="o">=</span> <span class="kt">NSAttributedString</span>
    
    <span class="k">let</span> <span class="nv">components</span><span class="p">:</span> <span class="p">[</span><span class="kt">MarkupStyleComponent</span><span class="p">]</span>
    <span class="c1">// Root/base MarkupStyle, specified externally, e.g., can specify the size of the entire text</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RootMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">RawStringMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Return Raw String</span>
        <span class="c1">// Collect all MarkupStyles along the chain</span>
        <span class="c1">// Apply Style to NSAttributedString</span>
        <span class="k">return</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="o">.</span><span class="n">attributedString</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">markup</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">BoldMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">LinkMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
        <span class="c1">// Look down to the RawString object</span>
        <span class="k">return</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">extension</span> <span class="kt">MarkupNSAttributedStringVisitor</span> <span class="p">{</span>
    <span class="c1">// Apply Style to NSAttributedString</span>
    <span class="kd">func</span> <span class="nf">applyMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">markupStyle</span> <span class="o">=</span> <span class="n">markupStyle</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="n">attributedString</span> <span class="p">}</span>
        <span class="k">let</span> <span class="nv">mutableAttributedString</span> <span class="o">=</span> <span class="kt">NSMutableAttributedString</span><span class="p">(</span><span class="nv">attributedString</span><span class="p">:</span> <span class="n">attributedString</span><span class="p">)</span>
        <span class="n">mutableAttributedString</span><span class="o">.</span><span class="nf">addAttributes</span><span class="p">(</span><span class="n">markupStyle</span><span class="o">.</span><span class="nf">render</span><span class="p">(),</span> <span class="nv">range</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mutableAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mutableAttributedString</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSMutableAttributedString</span> <span class="p">{</span>
        <span class="c1">// Collect from downstream</span>
        <span class="c1">// Root -&gt; Bold -&gt; String("Bold")</span>
        <span class="c1">//      \</span>
        <span class="c1">//       &gt; String("Test")</span>
        <span class="c1">// Result: Bold Test</span>
        <span class="c1">// Recursively visit and combine the final NSAttributedString layer by layer</span>
        <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
            <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">partialResult</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">collectMarkupStyle</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="p">{</span>
        <span class="c1">// Collect from upstream</span>
        <span class="c1">// String("Test") -&gt; Bold -&gt; Italic -&gt; Root</span>
        <span class="c1">// Result: style: Bold+Italic</span>
        <span class="c1">// Recursively find the parent tag's markup style</span>
        <span class="c1">// Then inherit styles layer by layer</span>
        <span class="k">var</span> <span class="nv">currentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">markup</span><span class="p">)</span>
        <span class="k">while</span> <span class="k">let</span> <span class="nv">thisMarkup</span> <span class="o">=</span> <span class="n">currentMarkup</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">thisMarkupStyle</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="nv">markup</span><span class="p">:</span> <span class="n">thisMarkup</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
                <span class="k">continue</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="k">var</span> <span class="nv">thisCurrentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
                <span class="n">thisCurrentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">thisMarkupStyle</span><span class="p">)</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisCurrentStyle</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">currentStyle</span> <span class="o">=</span> <span class="n">thisMarkupStyle</span>
            <span class="p">}</span>

            <span class="n">currentMarkup</span> <span class="o">=</span> <span class="n">thisMarkup</span><span class="o">.</span><span class="n">parentMarkup</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="k">var</span> <span class="nv">currentStyle</span> <span class="o">=</span> <span class="n">currentStyle</span> <span class="p">{</span>
            <span class="n">currentStyle</span><span class="o">.</span><span class="nf">fillIfNil</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">currentStyle</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">rootStyle</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupNSAttributedStringVisitor.swift" target="_blank">MarkupNSAttributedStringVisitor.swift</a> implementation</p></blockquote><p><a href="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*gJA_6uM5tQw2kUJsqIssuw.webp" alt="Operation flow and results are shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAwIiBoZWlnaHQ9IjEwMzAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p><strong>Ultimately, we can achieve:</strong></p><p><a href="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*LOXfC8yYg2JCeoCH5m7kGA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzOTIiIGhlaWdodD0iMjU4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">Li</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d17600&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Regular</span><span class="se">\"</span><span class="s">; font-weight: normal; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="n">nk</span><span class="p">{</span>
    <span class="kt">NSColor</span> <span class="o">=</span> <span class="s">"Blue"</span><span class="p">;</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
    <span class="kt">NSLink</span> <span class="o">=</span> <span class="s">"https://zhgchg.li"</span><span class="p">;</span>
<span class="p">}</span><span class="kt">Bold</span><span class="p">{</span>
    <span class="kt">NSFont</span> <span class="o">=</span> <span class="s">"&lt;UICTFont: 0x145d18710&gt; font-family: </span><span class="se">\"</span><span class="s">.SFUI-Semibold</span><span class="se">\"</span><span class="s">; font-weight: bold; font-style: normal; font-size: 13.00pt"</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>🎉🎉🎉🎉 Completed 🎉🎉🎉🎉</p></blockquote><p>We have now completed the entire process of converting an HTML String to NSAttributedString.</p><h4 id="stripper--removing-html-tags"><span class="me-2">Stripper — Removing HTML Tags</span><a href="#stripper--removing-html-tags" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Removing HTML Tags is relatively simple; it only requires:</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">attributedString</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
  <span class="k">if</span> <span class="k">let</span> <span class="nv">rawStringMarkup</span> <span class="o">=</span> <span class="n">markup</span> <span class="k">as?</span> <span class="kt">RawStringMarkup</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">rawStringMarkup</span><span class="o">.</span><span class="n">attributedString</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">markup</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">compactMap</span><span class="p">({</span> <span class="nf">attributedString</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span><span class="o">.</span><span class="nf">reduce</span><span class="p">(</span><span class="kt">NSMutableAttributedString</span><span class="p">())</span> <span class="p">{</span> <span class="n">partialResult</span><span class="p">,</span> <span class="n">attributedString</span> <span class="k">in</span>
      <span class="n">partialResult</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">attributedString</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">partialResult</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding to the original code’s <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/Processor/MarkupStripperProcessor.swift" target="_blank">MarkupStripperProcessor.swift</a> implementation</p></blockquote><p>This is similar to Render, but purely returns the content after finding RawStringMarkup.</p><h4 id="extend--dynamic-expansion"><span class="me-2">Extend — Dynamic Expansion</span><a href="#extend--dynamic-expansion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To expand the coverage of all HTML tags and style attributes, a dynamic extension point was created to facilitate the direct dynamic expansion of objects from code.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">w3cHTMLTagName</span><span class="p">:</span> <span class="kt">WC3HTMLTagName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">w3cHTMLTagName</span><span class="o">.</span><span class="n">rawValue</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="nf">trimmingCharacters</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span><span class="o">.</span><span class="nf">lowercased</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagNameVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// to</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ExtendMarkup</span><span class="p">:</span> <span class="kt">Markup</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">parentMarkup</span><span class="p">:</span> <span class="kt">Markup</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">var</span> <span class="nv">childMarkups</span><span class="p">:</span> <span class="p">[</span><span class="kt">Markup</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">MarkupVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//----</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="kt">ExtendHTMLTagStyleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="kd">public</span> <span class="k">let</span> <span class="nv">render</span><span class="p">:</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?))</span> <span class="c1">// Dynamic closure to change MarkupStyle</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">styleName</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">render</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">((</span><span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">MarkupStyle</span><span class="p">?)))</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">styleName</span> <span class="o">=</span> <span class="n">styleName</span>
        <span class="k">self</span><span class="o">.</span><span class="n">render</span> <span class="o">=</span> <span class="n">render</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">accept</span><span class="o">&lt;</span><span class="kt">V</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">visitor</span><span class="p">:</span> <span class="kt">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">V</span><span class="o">.</span><span class="kt">Result</span> <span class="k">where</span> <span class="kt">V</span> <span class="p">:</span> <span class="kt">HTMLTagStyleAttributeVisitor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="nf">visit</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="zhtmlparserbuilder"><span class="me-2">ZHTMLParserBuilder</span><a href="#zhtmlparserbuilder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, we use the Builder Pattern to allow external modules to quickly construct the objects needed for <code class="language-plaintext highlighter-rouge">ZMarkupParser</code>, while also managing access level control.</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span> <span class="o">=</span> <span class="o">.</span><span class="n">respectMarkupStyleFromCode</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">func</span> <span class="nf">initWithDefault</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">builder</span> <span class="o">=</span> <span class="k">Self</span><span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">htmlTagName</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">htmlTagNames</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">styleAttribute</span> <span class="k">in</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="n">styleAttributes</span> <span class="p">{</span>
            <span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">builder</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">withCustomStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">htmlTagName</span><span class="p">:</span> <span class="kt">HTMLTagName</span><span class="p">,</span> <span class="n">withCustomStyle</span> <span class="nv">markupStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="c1">// Only one instance of the same tagName can exist</span>
        <span class="n">htmlTags</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">htmlTag</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">htmlTag</span><span class="o">.</span><span class="n">tagName</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="n">htmlTagName</span><span class="o">.</span><span class="n">string</span>
        <span class="p">}</span>
        
        <span class="n">htmlTags</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">HTMLTag</span><span class="p">(</span><span class="nv">tagName</span><span class="p">:</span> <span class="n">htmlTagName</span><span class="p">,</span> <span class="nv">customStyle</span><span class="p">:</span> <span class="n">markupStyle</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">styleAttribute</span><span class="p">:</span> <span class="kt">HTMLTagStyleAttribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="n">styleAttributes</span><span class="o">.</span><span class="n">removeAll</span> <span class="p">{</span> <span class="n">thisStyleAttribute</span> <span class="k">in</span>
            <span class="k">return</span> <span class="n">thisStyleAttribute</span><span class="o">.</span><span class="n">styleName</span> <span class="o">==</span> <span class="n">styleAttribute</span><span class="o">.</span><span class="n">styleName</span>
        <span class="p">}</span>
        
        <span class="n">styleAttributes</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">styleAttribute</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">rootStyle</span> <span class="o">=</span> <span class="n">rootStyle</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">policy</span><span class="p">:</span> <span class="kt">MarkupStylePolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="k">return</span> <span class="k">self</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">ZHTMLParser</span> <span class="p">{</span>
        <span class="c1">// ZHTMLParser init is only accessible internally; it cannot be directly initialized from outside</span>
        <span class="c1">// It can only be initialized through ZHTMLParserBuilder</span>
        <span class="k">return</span> <span class="kt">ZHTMLParser</span><span class="p">(</span><span class="nv">htmlTags</span><span class="p">:</span> <span class="n">htmlTags</span><span class="p">,</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="n">styleAttributes</span><span class="p">,</span> <span class="nv">policy</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="n">rootStyle</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the original source code: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParserBuilder.swift" target="_blank">ZHTMLParserBuilder.swift</a></p></blockquote><p><strong>The <code class="language-plaintext highlighter-rouge">initWithDefault</code> method will by default add all implemented HTMLTagName/Style Attributes.</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">htmlTagNames</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagName</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">A_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">B_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">BR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DIV_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">HR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">I_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">LI_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">OL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">P_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">SPAN_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">STRONG_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">U_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">UL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">DEL_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TR_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TD_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TH_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">TABLE_HTMLTagName</span><span class="p">(),</span>
            <span class="kt">IMG_HTMLTagName</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kc">nil</span><span class="p">),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">ZHTMLParserBuilder</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="kt">ColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">BackgroundColorHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontSizeHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">FontWeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">LineHeightHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="kt">WordSpacingHTMLTagStyleAttribute</span><span class="p">(),</span>
            <span class="c1">// ...</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">ZHTMLParser</code> initialization is only accessible internally; it cannot be directly initialized from outside, and can only be initialized through <code class="language-plaintext highlighter-rouge">ZHTMLParserBuilder</code>.</p><p><strong><code class="language-plaintext highlighter-rouge">ZHTMLParser</code> encapsulates Render/Selector/Stripper operations:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ZHTMLParser</span><span class="p">:</span> <span class="kt">ZMarkupParser</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">htmlTags</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTag</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">styleAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">HTMLTagStyleAttribute</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">rootStyle</span><span class="p">:</span> <span class="kt">MarkupStyle</span><span class="p">?</span>

    <span class="kd">internal</span> <span class="nf">init</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    
    <span class="c1">// Retrieve link style attributes</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">linkTextAttributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">selector</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">HTMLSelector</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="c1">// Allows rendering of NSAttributedString within nodes using HTMLSelector results</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">selector</span><span class="p">:</span> <span class="kt">HTMLSelector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">render</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stripper</span><span class="p">(</span><span class="n">_</span> <span class="nv">attributedString</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NSAttributedString</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></table></code></div></div><blockquote><p>Corresponding implementation in the original source code: <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/HTML/ZHTMLParser.swift" target="_blank">ZHTMLParser.swift</a></p></blockquote><h4 id="uikit-issues"><span class="me-2">UIKit Issues</span><a href="#uikit-issues" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The result of <code class="language-plaintext highlighter-rouge">NSAttributedString</code> is most commonly displayed in a <code class="language-plaintext highlighter-rouge">UITextView</code>, but there are some important considerations:</p><ul><li>The link style in <code class="language-plaintext highlighter-rouge">UITextView</code> is uniformly determined by the <code class="language-plaintext highlighter-rouge">linkTextAttributes</code> setting, and it does not consider the settings of <code class="language-plaintext highlighter-rouge">NSAttributedString.Key</code>, nor can individual styles be set; hence the need for the <code class="language-plaintext highlighter-rouge">ZMarkupParser.linkTextAttributes</code> property.<li>Currently, <code class="language-plaintext highlighter-rouge">UILabel</code> does not have a way to change link styles, and since <code class="language-plaintext highlighter-rouge">UILabel</code> does not have <code class="language-plaintext highlighter-rouge">NSTextStorage</code>, if you want to load <code class="language-plaintext highlighter-rouge">NSTextAttachment</code> images, you need to handle <code class="language-plaintext highlighter-rouge">UILabel</code> separately.</ul><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UITextView</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">linkTextAttributes</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">linkTextAttributes</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">public</span> <span class="kd">extension</span> <span class="kt">UILabel</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">string</span><span class="p">),</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">setHtmlString</span><span class="p">(</span><span class="n">_</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">NSAttributedString</span><span class="p">,</span> <span class="n">with</span> <span class="nv">parser</span><span class="p">:</span> <span class="kt">ZHTMLParser</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="nf">render</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">enumerateAttribute</span><span class="p">(</span><span class="kt">NSAttributedString</span><span class="o">.</span><span class="kt">Key</span><span class="o">.</span><span class="n">attachment</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="kt">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span><span class="p">),</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">effectiveRange</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">attachment</span> <span class="o">=</span> <span class="n">value</span> <span class="k">as?</span> <span class="kt">ZNSTextAttachment</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            
            <span class="n">attachment</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">attributedText</span> <span class="o">=</span> <span class="n">attributedString</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Thus, we extended UIKit, allowing external modules to simply call <code class="language-plaintext highlighter-rouge">setHTMLString()</code> to complete the binding.</p><h4 id="complex-rendering-items--item-lists"><span class="me-2">Complex Rendering Items — Item Lists</span><a href="#complex-rendering-items--item-lists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Here’s a record of the implementation regarding item lists.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;ol&gt;</code> / <code class="language-plaintext highlighter-rouge">&lt;ul&gt;</code> to wrap <code class="language-plaintext highlighter-rouge">&lt;li&gt;</code> in HTML represents an item list:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemA<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemB<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>ItemC<span class="nt">&lt;/li&gt;</span>
    //...
<span class="nt">&lt;/ul&gt;</span>
</pre></table></code></div></div><p>Using the parsing method mentioned earlier, we can retrieve other list items in <code class="language-plaintext highlighter-rouge">visit(_ markup: ListItemMarkup)</code> to know the current list index (thanks to the conversion to AST).</p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">ListItemMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">siblingListItems</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">ListItemMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
  <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingListItems</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">NSParagraphStyle</code> has an <code class="language-plaintext highlighter-rouge">NSTextList</code> object that can be used to display list items, but in practice, it cannot be customized for the width of the whitespace (I personally feel the whitespace is too large). If there is whitespace between the bullet and the string, it can trigger a line break, which may look a bit odd, as shown in the image below:</p><p><a href="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*jvIgDjO4DNAKpPZF1balmw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2ODYiIGhlaWdodD0iMzkyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>The better part can potentially be achieved by setting <code class="language-plaintext highlighter-rouge">headIndent</code>, <code class="language-plaintext highlighter-rouge">firstLineHeadIndent</code>, and <code class="language-plaintext highlighter-rouge">NSTextTab</code>, but testing revealed that if the string is too long or the size changes, it still does not present a perfect result.</p><p>Currently, we have only achieved an acceptable solution by manually inserting the item list string before the string.</p><p>We only use <code class="language-plaintext highlighter-rouge">NSTextList.MarkerFormat</code> to generate the list item symbols, rather than using <code class="language-plaintext highlighter-rouge">NSTextList</code> directly.</p><p><strong>For a list of supported list symbols, refer to:</strong> <a href="https://github.com/ZhgChgLi/ZMarkupParser/blob/main/Sources/ZMarkupParser/Core/MarkupStyle/MarkupStyleList.swift" target="_blank">MarkupStyleList.swift</a></p><p><strong>Final display result: (</strong> <code class="language-plaintext highlighter-rouge">&lt;ol&gt;&lt;li&gt;</code> <strong>)</strong></p><p><a href="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*yM3VROfUNgnEBfIYwYwPnQ.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNzgiIGhlaWdodD0iMTEyIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="complex-rendering-items--tables"><span class="me-2">Complex Rendering Items — Tables</span><a href="#complex-rendering-items--tables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Similar to the implementation of item lists, but for tables.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;table&gt;</code> to wrap <code class="language-plaintext highlighter-rouge">&lt;tr&gt;</code> for table rows, and wrapping <code class="language-plaintext highlighter-rouge">&lt;td&gt;/&lt;th&gt;</code> for table columns in HTML:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Company<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Contact<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Country<span class="nt">&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Alfreds Futterkiste<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Maria Anders<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Germany<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>Centro comercial Moctezuma<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Francisco Chang<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>Mexico<span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></table></code></div></div><p>Testing revealed that the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code> uses the private macOS API <code class="language-plaintext highlighter-rouge">NSTextBlock</code> to display, thus being able to fully render HTML table styles and content.</p><blockquote><p>A bit of a cheat! We cannot use private APIs 🥲</p></blockquote><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableColumnMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">siblingColumns</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span> <span class="p">??</span> <span class="p">[]</span>
    <span class="k">let</span> <span class="nv">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">siblingColumns</span><span class="o">.</span><span class="nf">firstIndex</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">===</span> <span class="n">markup</span> <span class="p">})</span> <span class="p">??</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">// Optionally specify the desired width from the outside; can set to .max to avoid truncating the string</span>
    <span class="k">var</span> <span class="nv">maxLength</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">fixedMaxLength</span>
    <span class="k">if</span> <span class="n">maxLength</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// If not specified, find the length of the string in the first row of the same column as the max length</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">tableRowMarkup</span> <span class="o">=</span> <span class="n">markup</span><span class="o">.</span><span class="n">parentMarkup</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span><span class="p">,</span>
           <span class="k">let</span> <span class="nv">firstTableRow</span> <span class="o">=</span> <span class="n">tableRowMarkup</span><span class="o">.</span><span class="n">parentMarkup</span><span class="p">?</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">first</span><span class="p">(</span><span class="nv">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableRowMarkup</span> <span class="p">})</span> <span class="k">as?</span> <span class="kt">TableRowMarkup</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">firstTableRowColumns</span> <span class="o">=</span> <span class="n">firstTableRow</span><span class="o">.</span><span class="n">childMarkups</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span> <span class="k">is</span> <span class="kt">TableColumnMarkup</span> <span class="p">})</span>
            <span class="k">if</span> <span class="n">firstTableRowColumns</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">firstTableRowColumnAttributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">firstTableRowColumns</span><span class="p">[</span><span class="n">position</span><span class="p">])</span>
                <span class="k">let</span> <span class="nv">length</span> <span class="o">=</span> <span class="n">firstTableRowColumnAttributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span>
                <span class="n">maxLength</span> <span class="o">=</span> <span class="n">length</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="k">let</span> <span class="nv">maxLength</span> <span class="o">=</span> <span class="n">maxLength</span> <span class="p">{</span>
        <span class="c1">// If the column exceeds maxLength, truncate the string</span>
        <span class="k">if</span> <span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">utf16</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxLength</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="kt">String</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="n">maxLength</span><span class="p">))</span><span class="o">+</span><span class="s">"..."</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">attributedString</span><span class="o">.</span><span class="n">mutableString</span><span class="o">.</span><span class="nf">setString</span><span class="p">(</span><span class="n">attributedString</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="nf">padding</span><span class="p">(</span><span class="nv">toLength</span><span class="p">:</span> <span class="n">maxLength</span><span class="p">,</span> <span class="nv">withPad</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">startingAt</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">siblingColumns</span><span class="o">.</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="c1">// Add whitespace as spacing; the external can specify how many spaces to use for spacing</span>
        <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeString</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">,</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="s">" "</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="n">markup</span><span class="o">.</span><span class="n">spacing</span><span class="p">)))</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">attributedString</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableRowMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add a line break; see source code for details</span>
    <span class="k">return</span> <span class="n">attributedString</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">visit</span><span class="p">(</span><span class="n">_</span> <span class="nv">markup</span><span class="p">:</span> <span class="kt">TableMarkup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Result</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">attributedString</span> <span class="o">=</span> <span class="nf">collectAttributedString</span><span class="p">(</span><span class="n">markup</span><span class="p">)</span>
    <span class="n">attributedString</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">))</span> <span class="c1">// Add a line break; see source code for details</span>
    <span class="n">attributedString</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="nf">makeBreakLine</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="n">markup</span><span class="p">),</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// Add a line break; see source code for details</span>
    <span class="k">return</span> <span class="n">attributedString</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Final presentation effect as shown below:</strong></p><p><a href="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*Dft7H2BbeyWIO-dH4QpuSw.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNDMiIGhlaWdodD0iOTAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p>Not perfect, but acceptable.</p><h4 id="complex-rendering-items--images"><span class="me-2">Complex Rendering Items — Images</span><a href="#complex-rendering-items--images" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally, the biggest challenge is loading remote images into <code class="language-plaintext highlighter-rouge">NSAttributedString</code>.</p><p><strong>Using <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> in HTML to represent an image:</strong></p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span> <span class="na">width=</span><span class="s">"300"</span> <span class="na">height=</span><span class="s">"125"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p>You can specify the desired display size through the <code class="language-plaintext highlighter-rouge">width</code> / <code class="language-plaintext highlighter-rouge">height</code> HTML attributes.</p><p>Displaying images in <code class="language-plaintext highlighter-rouge">NSAttributedString</code> is more complex than expected, and there isn’t a perfect implementation. Previously, when working on <a href="/posts/zrealm-dev/en/ios-uitextview-image-wrapping-editor-swift-e37d66ea1146/">UITextView text wrapping</a>, I encountered some pitfalls, but after further research, I found that there still isn’t a perfect solution.</p><p>Currently, we ignore the native <code class="language-plaintext highlighter-rouge">NSTextAttachment</code>’s inability to reuse and release memory issues, and instead implement downloading images from remote sources, placing them into <code class="language-plaintext highlighter-rouge">NSTextAttachment</code>, and ensuring content updates automatically.</p><p><strong>This series of operations has been broken down into another small project for easier optimization and reuse in other projects:</strong></p><p><a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/5c63c82d77259bfe295dc17bf3eedc073f2e23dbd9598642813af0bcecb5b701/ZhgChgLi/ZNSTextAttachment" alt="" loading="lazy"></a></p><p>The main reference is the series of articles on <a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a>, but I modified the final content update part (after downloading, the UI needs to refresh to display) and added Delegate/DataSource for external extensibility.</p><p><a href="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*JZ8IVVNj9B2l-UBemGbAig.webp" alt="The operational flow and relationships are shown in the image above" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNDAwIiBoZWlnaHQ9IjYxMSI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p>The operational flow and relationships are as follows:</p><ul><li>Declare a <code class="language-plaintext highlighter-rouge">ZNSTextAttachmentable</code> object that encapsulates the <code class="language-plaintext highlighter-rouge">NSTextStorage</code> object (which <code class="language-plaintext highlighter-rouge">UITextView</code> has) and the <code class="language-plaintext highlighter-rouge">UILabel</code> itself (since <code class="language-plaintext highlighter-rouge">UILabel</code> lacks <code class="language-plaintext highlighter-rouge">NSTextStorage</code>). The operation method is solely to implement <code class="language-plaintext highlighter-rouge">replace attributedString from NSRange</code>. (<code class="language-plaintext highlighter-rouge">func replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code>)<li>The principle is to first use <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> to wrap the <code class="language-plaintext highlighter-rouge">imageURL</code>, <code class="language-plaintext highlighter-rouge">PlaceholderImage</code>, and the size information to be displayed, then directly show the image using the placeholder.<li>When the system requires this image on the screen, it will call the <code class="language-plaintext highlighter-rouge">image(forBounds…)</code> method, at which point we start downloading the image data.<li>The DataSource allows external customization for how to download or implement image cache policies, with the default being a direct URLSession request for image data.<li>After downloading, a new <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code> is created, and the logic for setting the custom image size is implemented in <code class="language-plaintext highlighter-rouge">attachmentBounds(for…)</code>.<li>Call the <code class="language-plaintext highlighter-rouge">replace(attachment: ZNSTextAttachment, to: ZResizableNSTextAttachment)</code> method to replace the position of <code class="language-plaintext highlighter-rouge">ZNSTextAttachment</code> with <code class="language-plaintext highlighter-rouge">ZResizableNSTextAttachment</code>.<li>Emit a didLoad Delegate notification, allowing external connections if needed.<li>Done.</ul><blockquote><p><strong>For detailed code, refer to the <a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">Source Code</a>.</strong></p></blockquote><p>The reason for not using <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateLayout(forCharacterRange: range, actualCharacterRange: nil)</code> or <code class="language-plaintext highlighter-rouge">NSLayoutManager.invalidateDisplay(forCharacterRange: range)</code> to refresh the UI is that it was found that the UI did not correctly display updates; since we already know the range, directly triggering the replacement of <code class="language-plaintext highlighter-rouge">NSAttributedString</code> ensures the UI updates correctly.</p><p>The final display result is as follows:</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">"color:red"</span><span class="nt">&gt;</span>こんにちは<span class="nt">&lt;/span&gt;</span>こんにちはこんにちは <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"https://user-images.githubusercontent.com/33706588/219608966-20e0c017-d05c-433a-9a52-091bc0cfd403.jpg"</span><span class="nt">/&gt;</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*bl65v-SVOK3H9ajR-Ksg6w.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0NTciIGhlaWdodD0iMjQ2Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h3 id="testing--continuous-integration"><span class="me-2">Testing &amp; Continuous Integration</span><a href="#testing--continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This project not only involved writing unit tests but also established snapshot tests for integration testing, making it easier to compare the final <code class="language-plaintext highlighter-rouge">NSAttributedString</code> in a comprehensive manner.</p><p>The main functional logic is covered by unit tests, along with integration tests, resulting in a final <a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">Test Coverage</a> of around <strong>85%</strong>.</p><p><a href="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*wV6BZcEGYuT9B9Xy4QzI0w.webp" alt="[ZMarkupParser — codecov](https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMTQiIGhlaWdodD0iMjAiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9ImdyZXkiLz48L3N2Zz4="></a></p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser — codecov</a></p><h4 id="snapshot-test"><span class="me-2">Snapshot Test</span><a href="#snapshot-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://github.com/pointfreeco/swift-snapshot-testing" target="_blank" class="img-link shimmer" ><img src="https://opengraph.githubassets.com/b3cc52a5b949767e4cb0af82145ed6474334d3235bd785ee1f7891c6b65fd69a/pointfreeco/swift-snapshot-testing" alt="" loading="lazy"></a></p><p><strong>Directly import the framework:</strong></p><div class="language-swift highlighter-rouge"><div class="code-header"> <span data-label-text="Swift"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">import</span> <span class="kt">SnapshotTesting</span>
<span class="c1">// ...</span>
<span class="kd">func</span> <span class="nf">testShouldKeepNSAttributedString</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">parser</span> <span class="o">=</span> <span class="kt">ZHTMLParserBuilder</span><span class="o">.</span><span class="nf">initWithDefault</span><span class="p">()</span><span class="o">.</span><span class="nf">build</span><span class="p">()</span>
  <span class="k">let</span> <span class="nv">textView</span> <span class="o">=</span> <span class="kt">UITextView</span><span class="p">()</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">390</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">isScrollEnabled</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="n">textView</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="o">.</span><span class="n">white</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">setHtmlString</span><span class="p">(</span><span class="s">"html string..."</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">parser</span><span class="p">)</span>
  <span class="n">textView</span><span class="o">.</span><span class="nf">layoutIfNeeded</span><span class="p">()</span>
  <span class="nf">assertSnapshot</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="n">textView</span><span class="p">,</span> <span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="nv">record</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</pre></table></code></div></div><p><a href="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*hLPeaOTOviA0jTPNOPu1hg.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNzUiIGhlaWdodD0iMzE5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p>This directly compares the final result to ensure that adjustments made during integration do not cause any issues.</p><h4 id="codecov-test-coverage"><span class="me-2">Codecov Test Coverage</span><a href="#codecov-test-coverage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Integrating with <a href="https://about.codecov.io" target="_blank">Codecov.io</a> (free for public repositories) allows for evaluating test coverage. You just need to install the Codecov GitHub App and set it up.</p><p><a href="https://app.codecov.io/gh/ZhgChgLi/ZMarkupParser" target="_blank" class="img-link shimmer" ><img src="https://storage.googleapis.com/codecov-cdn/static/Codecov-icon-600x600.png" alt="" loading="lazy"></a></p><p>Once the Codecov and GitHub repository are set up, you can also add a <code class="language-plaintext highlighter-rouge">codecov.yml</code> file in the root directory:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="na">comment</span><span class="pi">:</span>                  <span class="c1"># this is a top-level key</span>
  <span class="na">layout</span><span class="pi">:</span> <span class="s2">"</span><span class="s">reach,</span><span class="nv"> </span><span class="s">diff,</span><span class="nv"> </span><span class="s">flags,</span><span class="nv"> </span><span class="s">files"</span>
  <span class="na">behavior</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">require_changes</span><span class="pi">:</span> <span class="kc">false</span>  <span class="c1"># if true: only post the comment if coverage changes</span>
  <span class="na">require_base</span><span class="pi">:</span> <span class="s">no</span>        <span class="c1"># [yes :: must have a base report to post]</span>
  <span class="na">require_head</span><span class="pi">:</span> <span class="s">yes</span>       <span class="c1"># [yes :: must have a head report to post]</span>
</pre></table></code></div></div><p>This configuration enables automatic comments on the CI results after each PR is submitted.</p><p><a href="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*AcKpF4dijglahV-iVYLvvA.webp" alt="" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MjAiIGhlaWdodD0iNTg0Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><h4 id="continuous-integration"><span class="me-2">Continuous Integration</span><a href="#continuous-integration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>GitHub Action CI integration: <code class="language-plaintext highlighter-rouge">ci.yml</code></p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">types</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">opened</span><span class="pi">,</span> <span class="nv">reopened</span><span class="pi">]</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">main</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">self-hosted</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">spm build and test</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">set -o pipefail</span>
          <span class="s">xcodebuild test -workspace ZMarkupParser.xcworkspace -testPlan ZMarkupParser -scheme ZMarkupParser -enableCodeCoverage YES -resultBundlePath './scripts/TestResult.xcresult' -destination 'platform=iOS Simulator,name=iPhone 14,OS=16.1' build test | xcpretty</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Codecov</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">codecov/codecov-action@v3.1.1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">xcode</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">xcode_archive_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">./scripts/TestResult.xcresult'</span>
</pre></table></code></div></div><p>This configuration runs the build and test when a PR is opened/reopened or when pushing to the main branch, and uploads the test coverage report to Codecov.</p><h4 id="regex"><span class="me-2">Regex</span><a href="#regex" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Regarding regular expressions, each time I use them, I refine my understanding; although I didn’t use them extensively this time, I initially wanted to extract paired HTML tags, which led me to research how to write them.</p><p>Here are some cheat sheet notes from what I learned this time:</p><ul><li><code class="language-plaintext highlighter-rouge">?:</code> allows ( ) to match group results without capturing them. e.g. <code class="language-plaintext highlighter-rouge">(?:https?:\/\/)?(?:www\.)?example\.com</code> will return the entire URL in <code class="language-plaintext highlighter-rouge">https://www.example.com</code> instead of just <code class="language-plaintext highlighter-rouge">https://</code> and <code class="language-plaintext highlighter-rouge">www</code>.<li><code class="language-plaintext highlighter-rouge">.+?</code> performs a non-greedy match (returns the closest match). e.g. <code class="language-plaintext highlighter-rouge">&lt;.+?&gt;</code> will return <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;/a&gt;</code> in <code class="language-plaintext highlighter-rouge">&lt;a&gt;test&lt;/a&gt;</code> instead of the entire string.<li><code class="language-plaintext highlighter-rouge">(?=XYZ)</code> matches any string until the string <code class="language-plaintext highlighter-rouge">XYZ</code> appears; note that <code class="language-plaintext highlighter-rouge">[^XYZ]</code> represents any string until the characters X, Y, or Z appear. e.g. <code class="language-plaintext highlighter-rouge">(?:__)(.+?(?=__))(?:__)</code> (matches any string until <code class="language-plaintext highlighter-rouge">__</code>) will match <code class="language-plaintext highlighter-rouge">test</code>.<li><code class="language-plaintext highlighter-rouge">?R</code> recursively looks for values that match the same rule. e.g. <code class="language-plaintext highlighter-rouge">\((?:[^()]|((?R)))+\)</code> will match <code class="language-plaintext highlighter-rouge">(simple)</code> and <code class="language-plaintext highlighter-rouge">(and(nested))</code> in <code class="language-plaintext highlighter-rouge">(simple) (and(nested))</code>, including <code class="language-plaintext highlighter-rouge">(nested)</code>.<li><code class="language-plaintext highlighter-rouge">?&lt;GroupName&gt;</code> … <code class="language-plaintext highlighter-rouge">\k&lt;GroupName&gt;</code> matches the previous group name. e.g. <code class="language-plaintext highlighter-rouge">(?&lt;tagName&gt;&lt;a&gt;).*(\k&lt;GroupName&gt;)</code><li><code class="language-plaintext highlighter-rouge">(?(X)yes|no)</code> matches the condition <code class="language-plaintext highlighter-rouge">yes</code> if the <code class="language-plaintext highlighter-rouge">X</code>th match has a value (can also use group names), otherwise matches <code class="language-plaintext highlighter-rouge">no</code>. <strong>Swift does not currently support this.</strong></ul><p><strong>Other good Regex resources:</strong></p><ul><li><a href="https://onevcat.com/2022/11/swift-regex/" target="_blank">Swift Regex Quick Reference</a><li><a href="https://mp.weixin.qq.com/s/i_C4ATnajxRDGlTA8dJDHg" target="_blank">How Regular Expressions Work</a> -&gt; <strong>Refer to this when optimizing regex performance in this project.</strong><li><a href="https://juejin.cn/post/6850418120390082574" target="_blank">Regex Errors Leading to Infinite Searches, Causing Server Failures</a><li><a href="https://regex101.com" target="_blank">Regex101 for all regex rules</a></ul><h4 id="swift-package-manager--cocoapods"><span class="me-2">Swift Package Manager &amp; Cocoapods</span><a href="#swift-package-manager--cocoapods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This was also my first time developing with SPM and Cocoapods… it was quite interesting. SPM is really convenient; however, if two projects depend on the same package, opening both projects simultaneously can lead to one of them not finding the package and failing to build.</p><p>Cocoapods has uploaded ZMarkupParser, but I haven’t tested its functionality since I used SPM. 😝</p><h4 id="chatgpt"><span class="me-2">ChatGPT</span><a href="#chatgpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In my actual development experience, I found it most useful for assisting with editing the README. I haven’t felt a significant impact during development; when asking mid-senior level questions, it often doesn’t provide accurate answers and sometimes gives incorrect ones (I encountered this when asking about regex rules, and the answers were not quite right). So, I ultimately returned to Google for accurate solutions.</p><p>Not to mention asking it to write code; unless it’s for simple code generation objects, don’t expect it to complete an entire tool structure. <em>(At least for now, it seems that Copilot might be more helpful for writing code.)</em></p><p>However, it can provide a general direction for knowledge gaps, allowing us to quickly understand how certain things should be done. Sometimes, when our grasp is too weak, it can be difficult to quickly locate the correct direction on Google, and that’s when ChatGPT becomes quite helpful.</p><h3 id="declaration"><span class="me-2">Declaration</span><a href="#declaration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After more than three months of research and development, I am exhausted, but I want to clarify that this approach is merely a feasible result of my research and may not be the best solution or may still have areas for optimization. This project is more like a stepping stone, hoping to achieve a perfect solution for converting a markup language to <code class="language-plaintext highlighter-rouge">NSAttributedString</code>. <strong>Contributions are very welcome; many aspects still need the power of the community to improve.</strong></p><h3 id="contributing"><span class="me-2">Contributing</span><a href="#contributing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*kXjJQnSIJ7x-lSIYtacRrQ.webp" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;} [⭐](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MDAiIGhlaWdodD0iNDI5Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a> <a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">⭐</a></p><p>Here are some areas I think could be improved as of now (2023/03/12), which I will document in the repo:</p><ol><li>Performance/algorithm optimization; although it’s faster and more stable than the native <code class="language-plaintext highlighter-rouge">NSAttributedString.DocumentType.html</code>, there is still room for improvement. I believe its performance is definitely not on par with XMLParser. I hope one day it can achieve the same performance while maintaining customization and automatic error correction.<li>Support for more HTML tags and style attribute conversions.<li>Further optimization of <a href="https://github.com/ZhgChgLi/ZNSTextAttachment" target="_blank">ZNSTextAttachment</a> to implement reuse capabilities and release memory; may need to research CoreText.<li>Support for Markdown parsing, as the underlying abstraction is not limited to HTML; thus, once the Markdown to Markup object is established, Markdown parsing can be completed. That’s why I named it ZMarkupParser instead of ZHTMLParser, hoping that one day it can also support Markdown to <code class="language-plaintext highlighter-rouge">NSAttributedString</code>.<li>Support for Any to Any conversions, e.g., HTML to Markdown, Markdown to HTML, since we have the original AST tree (Markup object), so implementing conversions between any markup is possible.<li>Implement CSS <code class="language-plaintext highlighter-rouge">!important</code> functionality to enhance the inheritance strategy of MarkupStyle.<li>Strengthen HTML Selector functionality; currently, it only has the most basic filtering capabilities.<li>So many more improvements; feel free to open an <a href="https://github.com/ZhgChgLi/ZMarkupParser/issues" target="_blank">issue</a>.</ol><blockquote><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">If you feel you can’t contribute but want to help, you can give me a ⭐ to make the repo more visible, which may lead to contributions from GitHub experts!</a></p></blockquote><h3 id="summary"><span class="me-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/1*A0yXupXW9-F9ZWe4gp2ObA.webp" alt="[ZMarkupParser](https://github.com/ZhgChgLi/ZMarkupParser){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgwIiBoZWlnaHQ9IjY0MCI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iZ3JleSIvPjwvc3ZnPg=="></a></p><p><a href="https://github.com/ZhgChgLi/ZMarkupParser" target="_blank">ZMarkupParser</a></p><p>This concludes all the technical details and my journey in developing ZMarkupParser. It took me nearly three months of after-work and weekend time, countless research and practical processes, writing tests, improving test coverage, and establishing CI; finally, I have a somewhat presentable result. I hope this tool helps those who face similar challenges, and I look forward to everyone working together to make it even better.</p><p><a href="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.webp" class="popup img-link blur"><img data-src="/assets/2724f02f6e7/0*9YdJaNSQXlAfmT21.webp" alt="[pinkoi.com](https://www.pinkoi.com){:target=&quot;_blank&quot;}" data-lqip="true" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNTAiIGhlaWdodD0iMTg4Ij48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJncmV5Ii8+PC9zdmc+"></a></p><p><a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a></p><p>Currently, it is applied in our company’s iOS app on <a href="https://www.pinkoi.com" target="_blank">pinkoi.com</a>, and I haven’t encountered any issues. 😄</p><h4 id="further-reading"><span class="me-2">Further Reading</span><a href="#further-reading" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li><a href="/posts/zrealm-dev/en/zmarkupparser-html-string-to-nsattributedstring-converter-tool-a5643de271e4/">ZMarkupParser HTML String to NSAttributedString Converter Tool</a><li><a href="https://www.objc.io/issues/9-strings/string-rendering/" target="_blank">String Rendering</a><li><a href="https://www.cocoanetics.com/2016/09/asynchronous-nstextattachment-1/" target="_blank">Asynchronous NSTextAttachments</a></ul><p>If you have any questions or feedback, feel free to <a href="https://www.zhgchg.li/contact" target="_blank">contact me</a>.</p><hr /><p>This article was first published on Medium ➡️ <a href="https://medium.com/p/2724f02f6e7" target="_blank"><strong>Click Here</strong></a></p><p>Automatically converted and synchronized using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a> and <a href="https://github.com/ZhgChgLi/medium-to-jekyll-starter.github.io" target="_blank">Medium-to-jekyll-starter</a>.</p><p><a href="https://github.com/ZhgChgLi/zhgchgli.github.io/blob/main/_posts/en/zmediumtomarkdown/2023-03-11-2724f02f6e7.md" target="_blank">Improve this page on Github.</a></p><p><a href="https://www.buymeacoffee.com/zhgchgli" target="_blank" style="display:block !important;" class="img-link shimmer" ><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a beer&amp;emoji=🍺&amp;slug=zhgchgli&amp;button_colour=FFDD00&amp;font_colour=000000&amp;font_family=Bree&amp;outline_colour=000000&amp;coffee_colour=ffffff" alt="Buy me a beer" loading="lazy"></a></p><widgetic id="64ce71d5ecb2a165598b4567" resize="fill-width" height="50" autoscale="on"></widgetic> <script async="" src="https://widgetic.com/sdk/sdk.js"></script><div onclick="this.style.position='';" style="text-align: center; position: -webkit-sticky; position: sticky; bottom: 0; z-index: 1; margin: 0 -1rem; padding: 5px; background: var(--main-bg); border-bottom: 1px solid var(--main-border-color);transition: all .2s ease-in-out;"><a href="https://medium.com/@zhgchgli" target="_blank" style="display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;font-size:16px;font-weight:bold;color:#ffffff;background-color:#00ab6c;border-radius:5px;text-decoration:none;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.backgroundColor='#008f5a';this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 10px rgba(0,0,0,0.15)';" onmouseout="this.style.backgroundColor='#00ab6c';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">Follow Me on Medium <span style="font-size:14px;color:rgba(255,255,255,0.9);font-weight:normal;opacity:0.9;">1K+ Followers</span></a></div><div style="font-size: 0.8em; cursor:default; text-align: right;"> 1,237 <span style="font-size: 0.9em;">Total Views</span><br /> <span style="font-size: 0.8em;">Last Statistics Date: 2025-08-17 | 1,233 Views on <a href="https://medium.com/p/2724f02f6e7" target="_blank">Medium.</a></span></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/zrealm-dev/">ZRealm Dev.</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ios-app-development/" class="post-tag no-text-decoration" >ios-app-development</a> <a href="/tags/html-parsing/" class="post-tag no-text-decoration" >html-parsing</a> <a href="/tags/nsattributedstring/" class="post-tag no-text-decoration" >nsattributedstring</a> <a href="/tags/html/" class="post-tag no-text-decoration" >html</a> <a href="/tags/rendering/" class="post-tag no-text-decoration" >rendering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=The%20Journey%20of%20Building%20a%20Custom%20HTML%20Parser%20-%20ZhgChgLi%20(Harry%20Li)&url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fthe-journey-of-building-a-custom-html-parser-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=The%20Journey%20of%20Building%20a%20Custom%20HTML%20Parser%20-%20ZhgChgLi%20(Harry%20Li)&u=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fthe-journey-of-building-a-custom-html-parser-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fzhgchg.li%2Fposts%2Fzrealm-dev%2Fen%2Fthe-journey-of-building-a-custom-html-parser-2724f02f6e7%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/zrealm-life/apple-watch-%E7%B1%B3%E8%98%AD%E9%8C%B6%E5%B8%B6%E9%96%8B%E7%AE%B1-%E5%8E%9F%E5%BB%A0%E4%B8%8D%E9%8F%BD%E9%8B%BC%E7%9F%B3%E5%A2%A8%E8%89%B2%E5%84%AA%E7%BC%BA%E9%BB%9E%E5%85%A8%E8%A7%A3%E6%9E%90-c0f99f987d9c/">Apple Watch 原廠不鏽鋼米蘭錶帶開箱</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E9%87%9C%E5%B1%B1%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-8%E5%A4%A97%E5%A4%9C%E5%BF%85%E5%8E%BB%E6%99%AF%E9%BB%9E-%E7%BE%8E%E9%A3%9F%E8%88%87%E4%BA%A4%E9%80%9A%E5%85%A8%E8%A7%A3%E6%9E%90-%E9%87%9C%E5%B1%B1%E9%80%9A%E8%A1%8C%E8%AD%89%E7%9C%81%E9%8C%A2%E7%A7%98%E8%A8%A3-8ace34a1a3d8/">遊記 2025 韓國釜山 8 天 7 夜自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-travel-diaries/en/travel-diary-8-days-and-7-nights-in-busan-south-korea-2025-8ace34a1a3d8/">Travel Diary: 8 Days and 7 Nights in Busan, South Korea 2025</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E5%90%8D%E5%8F%A4%E5%B1%8B%E4%B8%80%E6%97%A5%E5%BF%AB%E9%96%83%E8%87%AA%E7%94%B1%E8%A1%8C-%E6%A8%82%E6%A1%83%E8%88%AA%E7%A9%BA%E7%B4%85%E7%9C%BC%E7%8F%AD%E6%A9%9F%E7%9C%81%E9%8C%A2%E6%94%BB%E7%95%A5%E8%88%87%E8%A1%8C%E7%A8%8B%E8%A6%8F%E5%8A%83-7b8a0563c157/">遊記 9/11 名古屋一日快閃自由行</a><li class="text-truncate lh-lg"> <a href="/posts/z-%E5%BA%A6%E6%97%85%E8%A1%8C%E9%81%8A%E8%A8%98/%E4%B9%9D%E5%B7%9E%E8%87%AA%E7%94%B1%E8%A1%8C%E6%94%BB%E7%95%A5-%E7%A6%8F%E5%B2%A1-%E9%95%B7%E5%B4%8E-%E7%86%8A%E6%9C%AC10%E6%97%A5%E7%8D%A8%E6%97%85%E5%85%A8%E7%B4%80%E9%8C%84%E8%88%87%E4%BA%A4%E9%80%9A%E4%BD%8F%E5%AE%BF%E5%AF%A6%E6%88%B0%E7%B6%93%E9%A9%97-d78e0b15a08a/">遊記 2023 九州 10 日自由行獨旅</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">章節 (Chapters)🔖</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%89%E6%8F%9B-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-2724f02f6e7/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1678554562" data-df="ll" > Mar 12, 2023 </time><h4 class="pt-0 my-2">手工打造 HTML 解析器的那些事</h4><div class="text-muted"><p>ZMarkupParser HTML to NSAttributedString 渲染引擎的開發實錄</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/ios-nsattributedstring-html-render-%E8%87%AA%E8%A1%8C%E5%AF%A6%E7%8F%BE-%E8%A7%A3%E6%B1%BA%E9%96%83%E9%80%80%E8%88%87%E6%95%88%E8%83%BD%E7%93%B6%E9%A0%B8-a8c2d26cc734/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654791119" data-df="ll" > Jun 10, 2022 </time><h4 class="pt-0 my-2">iOS NSAttributedString HTML Render 自行實現｜解決閃退與效能瓶頸</h4><div class="text-muted"><p>針對 iOS NSAttributedString HTML 解析閃退與效能差問題，提供純 Swift XMLParser 自行實現 HTML Render 技術，避免主線程阻塞，提升渲染速度達 5~20 倍，並支援自訂標籤樣式與擴充，確保穩定且可維護的文字渲染體驗。</p></div></div></a></article><article class="col"> <a href="/posts/zrealm-dev/en/implementing-ios-nsattributedstring-html-rendering-on-your-own-a8c2d26cc734/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1654791119" data-df="ll" > Jun 10, 2022 </time><h4 class="pt-0 my-2">Implementing iOS NSAttributedString HTML Rendering on Your Own</h4><div class="text-muted"><p>An alternative to iOS NSAttributedString DocumentType.html</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/zrealm-dev/zmarkupparser-swift-html-string-%E8%BD%89-nsattributedstring-%E5%B7%A5%E5%85%B7-%E6%94%AF%E6%8F%B4%E5%AE%A2%E8%A3%BD%E6%A8%A3%E5%BC%8F%E8%88%87%E9%AB%98%E6%95%88%E8%83%BD%E6%B8%B2%E6%9F%93-a5643de271e4/" class="btn btn-outline-primary" aria-label="Older" ><p>ZMarkupParser｜Swift HTML String 轉 NSAttributedString 工具，支援客製樣式與高效能渲染</p></a> <a href="/posts/zrealm-dev/%E6%89%8B%E5%B7%A5%E6%89%93%E9%80%A0%E9%AB%98%E6%95%88-html-%E8%A7%A3%E6%9E%90%E5%99%A8-swift-%E8%BD%89%E6%8F%9B-html-%E5%AD%97%E4%B8%B2%E6%88%90-nsattributedstring-%E6%8A%80%E8%A1%93%E8%A9%B3%E8%A7%A3-2724f02f6e7/" class="btn btn-outline-primary" aria-label="Newer" ><p>手工打造 HTML 解析器的那些事</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://medium.com/@zhgchgli">ZhgChgLi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >All rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. <br/> Medium articles were converted using <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown.</a><br/>Last updated: 2025-08-18 13:50:35 +08:00</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ios-app-development/">ios-app-development</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">ios</a> <a class="post-tag btn btn-outline-primary" href="/tags/swift/">swift</a> <a class="post-tag btn btn-outline-primary" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag btn btn-outline-primary" href="/tags/medium/">medium</a> <a class="post-tag btn btn-outline-primary" href="/tags/automation/">automation</a> <a class="post-tag btn btn-outline-primary" href="/tags/google-apps-script/">google-apps-script</a> <a class="post-tag btn btn-outline-primary" href="/tags/github/">github</a> <a class="post-tag btn btn-outline-primary" href="/tags/jekyll/">jekyll</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'ZhgChgLi/zhgchgli.github.io', 'data-repo-id': 'R_kgDOHdowLw', 'data-category': 'Q&A', 'data-category-id': 'DIC_kwDOHdowL84CU-q6', 'data-mapping': 'url', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
